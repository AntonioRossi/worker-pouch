(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(_dereq_,module,exports){
'use strict';

module.exports = _dereq_(3);
},{"3":3}],2:[function(_dereq_,module,exports){
'use strict';
/* global webkitURL */

module.exports = function createWorker(b64) {
  var createBlob = _dereq_(7).createBlob;
  var URLCompat = typeof URL !== 'undefined' ? URL : webkitURL;

  function makeBlobURI(script) {
    var blob = createBlob([script], {type: 'text/javascript'});
    return URLCompat.createObjectURL(blob);
  }

  var blob = createBlob([atob(b64)], {type: 'text/javascript'});
  return new Worker(makeBlobURI(blob));
};
},{"7":7}],3:[function(_dereq_,module,exports){
'use strict';

var utils = _dereq_(7);
var clientUtils = _dereq_(4);
var uuid = _dereq_(8);
var errors = _dereq_(5);
var log = _dereq_(11)('pouchdb:worker:client');
var preprocessAttachments = clientUtils.preprocessAttachments;
var stringifyArgs = clientUtils.stringifyArgs;
var adapterFun = clientUtils.adapterFun;

var createWorker = _dereq_(2);
var worker = createWorker(_dereq_(9));

// Implements the PouchDB API for dealing with PouchDB instances over WW
function WorkerPouch(opts, callback) {
  var api = this;

  if (typeof opts === 'string') {
    var slashIdx = utils.lastIndexOf(opts, '/');
    opts = {
      url: opts.substring(0, slashIdx),
      name: opts.substring(slashIdx + 1)
    };
  } else {
    opts = utils.clone(opts);
  }

  log('constructor called', opts);

  if (!opts.name) {
    var optsErrMessage = 'Error: you must provide a database name.';
    console.error(optsErrMessage);
    return callback(new Error(optsErrMessage));
  }

  function onReceiveMessage(message) {
    var messageId = message.messageId;
    var messageType = message.type;
    var content = message.content;
    var cb = api._callbacks[messageId];

    if (!cb) {
      log('duplicate message (ignoring)', messageId, messageType, content);
      return;
    }

    log('receive message', api._name, messageId, messageType, content);

    if (messageType === 'error') {
      delete api._callbacks[messageId];
      cb(content);
    } else if (messageType === 'success') {
      delete api._callbacks[messageId];
      cb(null, content);
    } else { // update
      api._changesListeners[messageId](content);
    }
  }

  function workerListener(e) {
    if (e.data.id === api._name) {
      onReceiveMessage(e.data);
    }
  }

  function sendMessage(type, args, callback) {
    var messageId = uuid();
    log('send message', api._socketId, messageId, type, args);
    api._callbacks[messageId] = callback;
    var stringArgs = stringifyArgs(args);
    worker.postMessage({
      id: api._name,
      type: type,
      messageId: messageId,
      args: stringArgs
    });
    log('message sent', api._name, messageId);
  }

  function sendRawMessage(messageId, type, args) {
    log('send message', api._socketId, messageId, type, args);
    var stringArgs = stringifyArgs(args);
    worker.postMessage({
      id: api._name,
      type: type,
      messageId: messageId,
      args: stringArgs
    });
    log('message sent', api._name, messageId);
  }

  api.type = function () {
    return 'socket';
  };

  api._id = adapterFun('id', function (callback) {
    sendMessage('id', [], callback);
  });

  api.compact = adapterFun('compact', function (opts, callback) {
    if (typeof opts === 'function') {
      callback = opts;
      opts = {};
    }
    sendMessage('compact', [opts], callback);
  });

  api._info = function (callback) {
    sendMessage('info', [], callback);
  };

  api.get = adapterFun('get', function (id, opts, callback) {
    if (typeof opts === 'function') {
      callback = opts;
      opts = {};
    }
    sendMessage('get', [id, opts], callback);
  });

  api.remove =
    adapterFun('remove', function (docOrId, optsOrRev, opts, callback) {
      var doc;
      if (typeof optsOrRev === 'string') {
        // id, rev, opts, callback style
        doc = {
          _id: docOrId,
          _rev: optsOrRev
        };
        if (typeof opts === 'function') {
          callback = opts;
          opts = {};
        }
      } else {
        // doc, opts, callback style
        doc = docOrId;
        if (typeof optsOrRev === 'function') {
          callback = optsOrRev;
          opts = {};
        } else {
          callback = opts;
          opts = optsOrRev;
        }
      }
      var rev = (doc._rev || opts.rev);

      sendMessage('remove', [doc._id, rev], callback);
  });

  api.getAttachment =
    adapterFun('getAttachment', function (docId, attachmentId, opts,
                                                callback) {
      if (typeof opts === 'function') {
        callback = opts;
        opts = {};
      }
      sendMessage('getAttachment', [docId, attachmentId, opts], callback);
  });

  api.removeAttachment =
    adapterFun('removeAttachment', function (docId, attachmentId, rev,
                                                   callback) {

      sendMessage('removeAttachment', [docId, attachmentId, rev], callback);
    });

  // Add the attachment given by blob and its contentType property
  // to the document with the given id, the revision given by rev, and
  // add it to the database given by host.
  api.putAttachment =
    adapterFun('putAttachment', function (docId, attachmentId, rev, blob,
                                                type, callback) {
      if (typeof type === 'function') {
        callback = type;
        type = blob;
        blob = rev;
        rev = null;
      }
      if (typeof type === 'undefined') {
        type = blob;
        blob = rev;
        rev = null;
      }

      if (typeof blob === 'string') {
        var binary;
        try {
          binary = atob(blob);
        } catch (err) {
          // it's not base64-encoded, so throw error
          return callback(errors.error(errors.BAD_ARG,
            'Attachments need to be base64 encoded'));
        }
        blob = utils.createBlob([utils.binaryStringToArrayBuffer(binary)], {type: type});
      }

      var args = [docId, attachmentId, rev, blob, type];
      sendMessage('putAttachment', args, callback);
    });

  api.put = adapterFun('put', utils.getArguments(function (args) {
    var temp, temptype, opts;
    var doc = args.shift();
    var id = '_id' in doc;
    var callback = args.pop();
    if (typeof doc !== 'object' || Array.isArray(doc)) {
      return callback(errors.error(errors.NOT_AN_OBJECT));
    }

    doc = utils.clone(doc);

    preprocessAttachments(doc).then(function () {
      while (true) {
        temp = args.shift();
        temptype = typeof temp;
        if (temptype === "string" && !id) {
          doc._id = temp;
          id = true;
        } else if (temptype === "string" && id && !('_rev' in doc)) {
          doc._rev = temp;
        } else if (temptype === "object") {
          opts = utils.clone(temp);
        }
        if (!args.length) {
          break;
        }
      }
      opts = opts || {};

      sendMessage('put', [doc, opts], callback);
    })["catch"](callback);

  }));

  api.post = adapterFun('post', function (doc, opts, callback) {
    if (typeof opts === 'function') {
      callback = opts;
      opts = {};
    }
    opts = utils.clone(opts);

    sendMessage('post', [doc, opts], callback);
  });

  api._bulkDocs = function (req, opts, callback) {
    sendMessage('bulkDocs', [req, opts], callback);
  };

  api._allDocs = function (opts, callback) {
    if (typeof opts === 'function') {
      callback = opts;
      opts = {};
    }
    sendMessage('allDocs', [opts], callback);
  };

  api._changes = function (opts) {
    opts = utils.clone(opts);

    if (opts.continuous) {
      var messageId = uuid();
      api._changesListeners[messageId] = opts.onChange;
      api._callbacks[messageId] = opts.complete;
      sendRawMessage(messageId, 'liveChanges', [opts]);
      return {
        cancel: function () {
          sendRawMessage(messageId, 'cancelChanges', []);
        }
      };
    }

    // just send all the docs anyway because we need to emit change events
    // TODO: be smarter about emitting changes without building up an array
    var returnDocs = 'returnDocs' in opts ? opts.returnDocs : true;
    opts.returnDocs = true;
    sendMessage('changes', [opts], function (err, res) {
      if (err) {
        opts.complete(err);
        return callback(err);
      }
      res.results.forEach(function (change) {
        opts.onChange(change);
      });
      if (!returnDocs) {
        res.results = [];
      }
      opts.complete(null, res);
      callback(null, res);
    });
  };

  // Given a set of document/revision IDs (given by req), tets the subset of
  // those that do NOT correspond to revisions stored in the database.
  // See http://wiki.apache.org/couchdb/HttpPostRevsDiff
  api.revsDiff = adapterFun('revsDiff', function (req, opts, callback) {
    // If no options were given, set the callback to be the second parameter
    if (typeof opts === 'function') {
      callback = opts;
      opts = {};
    }

    sendMessage('revsDiff', [req, opts], callback);
  });

  api._query = adapterFun('query', function (fun, opts, callback) {
    if (typeof opts === 'function') {
      callback = opts;
      opts = {};
    }
    var funEncoded = fun;
    if (typeof fun === 'function') {
      funEncoded = {map: fun};
    }
    sendMessage('query', [funEncoded, opts], callback);
  });

  api._viewCleanup = adapterFun('viewCleanup', function (callback) {
    sendMessage('viewCleanup', [], callback);
  });

  api._close = function (callback) {
    callback();
  };

  api.destroy = adapterFun('destroy', function (opts, callback) {
    if (typeof opts === 'function') {
      callback = opts;
      opts = {};
    }
    sendMessage('destroy', [], function (err, res) {
      if (err) {
        api.emit('error', err);
        return callback(err);
      }
      worker.removeEventListener('message', workerListener);
      api.emit('destroyed');
      api.constructor.emit('destroyed', api._name);
      callback(null, res);
    });
  });

  api._callbacks = {};
  api._changesListeners = {};
  api._name = opts.originalName;

  worker.addEventListener('message', workerListener);

  sendMessage('createDatabase', [{
    name: api._name,
    auto_compaction: !!opts.auto_compaction
  }], function (err) {
    if (err) {
      return callback(err);
    }
    callback(null, api);
  });

}

// WorkerPouch is a valid adapter.
WorkerPouch.valid = function () {
  return true;
};

module.exports = WorkerPouch;

/* istanbul ignore next */
if (typeof window !== 'undefined' && window.PouchDB) {
  window.PouchDB.adapter('worker', module.exports);
}

},{"11":11,"2":2,"4":4,"5":5,"7":7,"8":8,"9":9}],4:[function(_dereq_,module,exports){
(function (process){
'use strict';

var utils = _dereq_(7);
var log = _dereq_(11)('pouchdb:socket:client');
var isBrowser = typeof process === 'undefined' || process.browser;

exports.preprocessAttachments = function preprocessAttachments(doc) {
  if (!doc._attachments || !Object.keys(doc._attachments)) {
    return utils.Promise.resolve();
  }

  return utils.Promise.all(Object.keys(doc._attachments).map(function (key) {
    var attachment = doc._attachments[key];
    if (attachment.data && typeof attachment.data !== 'string') {
      if (isBrowser) {
        return new utils.Promise(function (resolve) {
          utils.readAsBinaryString(attachment.data, function (binary) {
            attachment.data = btoa(binary);
            resolve();
          });
        });
      } else {
        attachment.data = attachment.data.toString('base64');
      }
    }
  }));
};

exports.stringifyArgs = function stringifyArgs(args) {
  var funcArgs = ['filter', 'map', 'reduce'];
  var funcsToRemove = ['onChange', 'processChange', 'complete'];
  var result = [];
  args.forEach(function (arg) {
    if (typeof arg === 'object' && arg !== null && !Array.isArray(arg)) {
      funcArgs.forEach(function (funcArg) {
        if (funcArg in arg && typeof arg[funcArg] === 'function') {
          arg[funcArg] = {
            type: 'func',
            func: arg[funcArg].toString()
          };
        }
      });
      var newArg = {};
      Object.keys(arg).forEach(function (key) {
        if (funcsToRemove.indexOf(key) === -1) {
          newArg[key] = arg[key];
        }
      });
      arg = newArg;
    }
    result.push(arg);
  });
  return result;
};

exports.padInt = function padInt(i, len) {
  var res = i.toString();
  while (res.length < len) {
    res = '0' + res;
  }
  return res;
};


exports.adapterFun = function adapterFun(name, callback) {

  function logApiCall(self, name, args) {
    if (!log.enabled) {
      return;
    }
    var logArgs = [self._db_name, name];
    for (var i = 0; i < args.length - 1; i++) {
      logArgs.push(args[i]);
    }
    log.apply(null, logArgs);

    // override the callback itself to log the response
    var origCallback = args[args.length - 1];
    args[args.length - 1] = function (err, res) {
      var responseArgs = [self._db_name, name];
      responseArgs = responseArgs.concat(
        err ? ['error', err] : ['success', res]
      );
      log.apply(null, responseArgs);
      origCallback(err, res);
    };
  }


  return utils.toPromise(utils.getArguments(function (args) {
    if (this._closed) {
      return utils.Promise.reject(new Error('database is closed'));
    }
    var self = this;
    logApiCall(self, name, args);
    if (!this.taskqueue.isReady) {
      return new utils.Promise(function (fulfill, reject) {
        self.taskqueue.addTask(function (failed) {
          if (failed) {
            reject(failed);
          } else {
            fulfill(self[name].apply(self, args));
          }
        });
      });
    }
    return callback.apply(this, args);
  }));
};
}).call(this,_dereq_(10))
},{"10":10,"11":11,"7":7}],5:[function(_dereq_,module,exports){
"use strict";

var inherits = _dereq_(14);
inherits(PouchError, Error);

function PouchError(opts) {
  Error.call(opts.reason);
  this.status = opts.status;
  this.name = opts.error;
  this.message = opts.reason;
  this.error = true;
}

PouchError.prototype.toString = function () {
  return JSON.stringify({
    status: this.status,
    name: this.name,
    message: this.message
  });
};

exports.UNAUTHORIZED = new PouchError({
  status: 401,
  error: 'unauthorized',
  reason: "Name or password is incorrect."
});

exports.MISSING_BULK_DOCS = new PouchError({
  status: 400,
  error: 'bad_request',
  reason: "Missing JSON list of 'docs'"
});

exports.MISSING_DOC = new PouchError({
  status: 404,
  error: 'not_found',
  reason: 'missing'
});

exports.REV_CONFLICT = new PouchError({
  status: 409,
  error: 'conflict',
  reason: 'Document update conflict'
});

exports.INVALID_ID = new PouchError({
  status: 400,
  error: 'invalid_id',
  reason: '_id field must contain a string'
});

exports.MISSING_ID = new PouchError({
  status: 412,
  error: 'missing_id',
  reason: '_id is required for puts'
});

exports.RESERVED_ID = new PouchError({
  status: 400,
  error: 'bad_request',
  reason: 'Only reserved document ids may start with underscore.'
});

exports.NOT_OPEN = new PouchError({
  status: 412,
  error: 'precondition_failed',
  reason: 'Database not open'
});

exports.UNKNOWN_ERROR = new PouchError({
  status: 500,
  error: 'unknown_error',
  reason: 'Database encountered an unknown error'
});

exports.BAD_ARG = new PouchError({
  status: 500,
  error: 'badarg',
  reason: 'Some query argument is invalid'
});

exports.INVALID_REQUEST = new PouchError({
  status: 400,
  error: 'invalid_request',
  reason: 'Request was invalid'
});

exports.QUERY_PARSE_ERROR = new PouchError({
  status: 400,
  error: 'query_parse_error',
  reason: 'Some query parameter is invalid'
});

exports.DOC_VALIDATION = new PouchError({
  status: 500,
  error: 'doc_validation',
  reason: 'Bad special document member'
});

exports.BAD_REQUEST = new PouchError({
  status: 400,
  error: 'bad_request',
  reason: 'Something wrong with the request'
});

exports.NOT_AN_OBJECT = new PouchError({
  status: 400,
  error: 'bad_request',
  reason: 'Document must be a JSON object'
});

exports.DB_MISSING = new PouchError({
  status: 404,
  error: 'not_found',
  reason: 'Database not found'
});

exports.IDB_ERROR = new PouchError({
  status: 500,
  error: 'indexed_db_went_bad',
  reason: 'unknown'
});

exports.WSQ_ERROR = new PouchError({
  status: 500,
  error: 'web_sql_went_bad',
  reason: 'unknown'
});

exports.LDB_ERROR = new PouchError({
  status: 500,
  error: 'levelDB_went_went_bad',
  reason: 'unknown'
});

exports.FORBIDDEN = new PouchError({
  status: 403,
  error: 'forbidden',
  reason: 'Forbidden by design doc validate_doc_update function'
});

exports.INVALID_REV = new PouchError({
  status: 400,
  error: 'bad_request',
  reason: 'Invalid rev format'
});

exports.FILE_EXISTS = new PouchError({
  status: 412,
  error: 'file_exists',
  reason: 'The database could not be created, the file already exists.'
});

exports.MISSING_STUB = new PouchError({
  status: 412,
  error: 'missing_stub'
});

exports.error = function (error, reason, name) {
  function CustomPouchError(reason) {
    // inherit error properties from our parent error manually
    // so as to allow proper JSON parsing.
    /* jshint ignore:start */
    for (var p in error) {
      if (typeof error[p] !== 'function') {
        this[p] = error[p];
      }
    }
    /* jshint ignore:end */
    if (name !== undefined) {
      this.name = name;
    }
    if (reason !== undefined) {
      this.reason = reason;
    }
  }
  CustomPouchError.prototype = PouchError.prototype;
  return new CustomPouchError(reason);
};

// Find one of the errors defined above based on the value
// of the specified property.
// If reason is provided prefer the error matching that reason.
// This is for differentiating between errors with the same name and status,
// eg, bad_request.
exports.getErrorTypeByProp = function (prop, value, reason) {
  var errors = exports;
  var keys = Object.keys(errors).filter(function (key) {
    var error = errors[key];
    return typeof error !== 'function' && error[prop] === value;
  });
  var key = reason && keys.filter(function (key) {
      var error = errors[key];
      return error.message === reason;
    })[0] || keys[0];
  return (key) ? errors[key] : null;
};

exports.generateErrorFromResponse = function (res) {
  var error, errName, errType, errMsg, errReason;
  var errors = exports;

  errName = (res.error === true && typeof res.name === 'string') ?
    res.name :
    res.error;
  errReason = res.reason;
  errType = errors.getErrorTypeByProp('name', errName, errReason);

  if (res.missing ||
    errReason === 'missing' ||
    errReason === 'deleted' ||
    errName === 'not_found') {
    errType = errors.MISSING_DOC;
  } else if (errName === 'doc_validation') {
    // doc validation needs special treatment since
    // res.reason depends on the validation error.
    // see utils.js
    errType = errors.DOC_VALIDATION;
    errMsg = errReason;
  } else if (errName === 'bad_request' && errType.message !== errReason) {
    // if bad_request error already found based on reason don't override.

    // attachment errors.
    if (errReason.indexOf('unknown stub attachment') === 0) {
      errType = errors.MISSING_STUB;
      errMsg = errReason;
    } else {
      errType = errors.BAD_REQUEST;
    }
  }

  // fallback to error by statys or unknown error.
  if (!errType) {
    errType = errors.getErrorTypeByProp('status', res.status, errReason) ||
    errors.UNKNOWN_ERROR;
  }

  error = errors.error(errType, errReason, errName);

  // Keep custom message.
  if (errMsg) {
    error.message = errMsg;
  }

  // Keep helpful response data in our error messages.
  if (res.id) {
    error.id = res.id;
  }
  if (res.status) {
    error.status = res.status;
  }
  if (res.statusText) {
    error.name = res.statusText;
  }
  if (res.missing) {
    error.missing = res.missing;
  }

  return error;
};

},{"14":14}],6:[function(_dereq_,module,exports){
'use strict';

function isBinaryObject(object) {
  return object instanceof ArrayBuffer ||
    (typeof Blob !== 'undefined' && object instanceof Blob);
}

function cloneArrayBuffer(buff) {
  if (typeof buff.slice === 'function') {
    return buff.slice(0);
  }
  // IE10-11 slice() polyfill
  var target = new ArrayBuffer(buff.byteLength);
  var targetArray = new Uint8Array(target);
  var sourceArray = new Uint8Array(buff);
  targetArray.set(sourceArray);
  return target;
}

function cloneBinaryObject(object) {
  if (object instanceof ArrayBuffer) {
    return cloneArrayBuffer(object);
  }
  // Blob
  return object.slice(0, object.size, object.type);
}

module.exports = function clone(object) {
  var newObject;
  var i;
  var len;

  if (!object || typeof object !== 'object') {
    return object;
  }

  if (Array.isArray(object)) {
    newObject = [];
    for (i = 0, len = object.length; i < len; i++) {
      newObject[i] = clone(object[i]);
    }
    return newObject;
  }

  // special case: to avoid inconsistencies between IndexedDB
  // and other backends, we automatically stringify Dates
  if (object instanceof Date) {
    return object.toISOString();
  }

  if (isBinaryObject(object)) {
    return cloneBinaryObject(object);
  }

  newObject = {};
  for (i in object) {
    if (Object.prototype.hasOwnProperty.call(object, i)) {
      var value = clone(object[i]);
      if (typeof value !== 'undefined') {
        newObject[i] = value;
      }
    }
  }
  return newObject;
};

},{}],7:[function(_dereq_,module,exports){
(function (process){
'use strict';

var Promise = _dereq_(16);

exports.lastIndexOf = function lastIndexOf(str, char) {
  for (var i = str.length - 1; i >= 0; i--) {
    if (str.charAt(i) === char) {
      return i;
    }
  }
  return -1;
};

// TODO: move to pouchdb/extras
exports.clone = _dereq_(6);

/* istanbul ignore next */
exports.once = function once(fun) {
  var called = false;
  return exports.getArguments(function (args) {
    if (called) {
      console.trace();
      throw new Error('once called  more than once');
    } else {
      called = true;
      fun.apply(this, args);
    }
  });
};
/* istanbul ignore next */
exports.getArguments = function getArguments(fun) {
  return function () {
    var len = arguments.length;
    var args = new Array(len);
    var i = -1;
    while (++i < len) {
      args[i] = arguments[i];
    }
    return fun.call(this, args);
  };
};
/* istanbul ignore next */
exports.toPromise = function toPromise(func) {
  //create the function we will be returning
  return exports.getArguments(function (args) {
    var self = this;
    var tempCB = (typeof args[args.length - 1] === 'function') ? args.pop() : false;
    // if the last argument is a function, assume its a callback
    var usedCB;
    if (tempCB) {
      // if it was a callback, create a new callback which calls it,
      // but do so async so we don't trap any errors
      usedCB = function (err, resp) {
        process.nextTick(function () {
          tempCB(err, resp);
        });
      };
    }
    var promise = new Promise(function (fulfill, reject) {
      try {
        var callback = exports.once(function (err, mesg) {
          if (err) {
            reject(err);
          } else {
            fulfill(mesg);
          }
        });
        // create a callback for this invocation
        // apply the function in the orig context
        args.push(callback);
        func.apply(self, args);
      } catch (e) {
        reject(e);
      }
    });
    // if there is a callback, call it back
    if (usedCB) {
      promise.then(function (result) {
        usedCB(null, result);
      }, usedCB);
    }
    promise.cancel = function () {
      return this;
    };
    return promise;
  });
};

exports.inherits = _dereq_(14);
exports.Promise = Promise;

var binUtil = _dereq_(15);

exports.createBlob = binUtil.createBlob;
exports.readAsArrayBuffer = binUtil.readAsArrayBuffer;
exports.readAsBinaryString = binUtil.readAsBinaryString;
exports.binaryStringToArrayBuffer = binUtil.binaryStringToArrayBuffer;
exports.arrayBufferToBinaryString = binUtil.arrayBufferToBinaryString;
}).call(this,_dereq_(10))
},{"10":10,"14":14,"15":15,"16":16,"6":6}],8:[function(_dereq_,module,exports){
"use strict";

// BEGIN Math.uuid.js

/*!
 Math.uuid.js (v1.4)
 http://www.broofa.com
 mailto:robert@broofa.com

 Copyright (c) 2010 Robert Kieffer
 Dual licensed under the MIT and GPL licenses.
 */

/*
 * Generate a random uuid.
 *
 * USAGE: Math.uuid(length, radix)
 *   length - the desired number of characters
 *   radix  - the number of allowable values for each character.
 *
 * EXAMPLES:
 *   // No arguments  - returns RFC4122, version 4 ID
 *   >>> Math.uuid()
 *   "92329D39-6F5C-4520-ABFC-AAB64544E172"
 *
 *   // One argument - returns ID of the specified length
 *   >>> Math.uuid(15)     // 15 character ID (default base=62)
 *   "VcydxgltxrVZSTV"
 *
 *   // Two arguments - returns ID of the specified length, and radix. 
 *   // (Radix must be <= 62)
 *   >>> Math.uuid(8, 2)  // 8 character ID (base=2)
 *   "01001010"
 *   >>> Math.uuid(8, 10) // 8 character ID (base=10)
 *   "47473046"
 *   >>> Math.uuid(8, 16) // 8 character ID (base=16)
 *   "098F4D35"
 */
var chars = (
'0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ' +
'abcdefghijklmnopqrstuvwxyz'
).split('');
function getValue(radix) {
  return 0 | Math.random() * radix;
}
function uuid(len, radix) {
  radix = radix || chars.length;
  var out = '';
  var i = -1;

  if (len) {
    // Compact form
    while (++i < len) {
      out += chars[getValue(radix)];
    }
    return out;
  }
  // rfc4122, version 4 form
  // Fill in random data.  At i==19 set the high bits of clock sequence as
  // per rfc4122, sec. 4.1.5
  while (++i < 36) {
    switch (i) {
      case 8:
      case 13:
      case 18:
      case 23:
        out += '-';
        break;
      case 19:
        out += chars[(getValue(16) & 0x3) | 0x8];
        break;
      default:
        out += chars[getValue(16)];
    }
  }

  return out;
}



module.exports = uuid;


},{}],9:[function(_dereq_,module,exports){
module.exports = 'KGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT0iZnVuY3Rpb24iJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dmFyIGY9bmV3IEVycm9yKCJDYW5ub3QgZmluZCBtb2R1bGUgJyIrbysiJyIpO3Rocm93IGYuY29kZT0iTU9EVUxFX05PVF9GT1VORCIsZn12YXIgbD1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwobC5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxsLGwuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT0iZnVuY3Rpb24iJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSh7MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CmluaGVyaXRzKFBvdWNoRXJyb3IsIEVycm9yKTsKCmZ1bmN0aW9uIFBvdWNoRXJyb3Iob3B0cykgewogIEVycm9yLmNhbGwob3B0cy5yZWFzb24pOwogIHRoaXMuc3RhdHVzID0gb3B0cy5zdGF0dXM7CiAgdGhpcy5uYW1lID0gb3B0cy5lcnJvcjsKICB0aGlzLm1lc3NhZ2UgPSBvcHRzLnJlYXNvbjsKICB0aGlzLmVycm9yID0gdHJ1ZTsKfQoKUG91Y2hFcnJvci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHsKICAgIHN0YXR1czogdGhpcy5zdGF0dXMsCiAgICBuYW1lOiB0aGlzLm5hbWUsCiAgICBtZXNzYWdlOiB0aGlzLm1lc3NhZ2UKICB9KTsKfTsKCmV4cG9ydHMuVU5BVVRIT1JJWkVEID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNDAxLAogIGVycm9yOiAndW5hdXRob3JpemVkJywKICByZWFzb246ICJOYW1lIG9yIHBhc3N3b3JkIGlzIGluY29ycmVjdC4iCn0pOwoKZXhwb3J0cy5NSVNTSU5HX0JVTEtfRE9DUyA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDQwMCwKICBlcnJvcjogJ2JhZF9yZXF1ZXN0JywKICByZWFzb246ICJNaXNzaW5nIEpTT04gbGlzdCBvZiAnZG9jcyciCn0pOwoKZXhwb3J0cy5NSVNTSU5HX0RPQyA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDQwNCwKICBlcnJvcjogJ25vdF9mb3VuZCcsCiAgcmVhc29uOiAnbWlzc2luZycKfSk7CgpleHBvcnRzLlJFVl9DT05GTElDVCA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDQwOSwKICBlcnJvcjogJ2NvbmZsaWN0JywKICByZWFzb246ICdEb2N1bWVudCB1cGRhdGUgY29uZmxpY3QnCn0pOwoKZXhwb3J0cy5JTlZBTElEX0lEID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNDAwLAogIGVycm9yOiAnaW52YWxpZF9pZCcsCiAgcmVhc29uOiAnX2lkIGZpZWxkIG11c3QgY29udGFpbiBhIHN0cmluZycKfSk7CgpleHBvcnRzLk1JU1NJTkdfSUQgPSBuZXcgUG91Y2hFcnJvcih7CiAgc3RhdHVzOiA0MTIsCiAgZXJyb3I6ICdtaXNzaW5nX2lkJywKICByZWFzb246ICdfaWQgaXMgcmVxdWlyZWQgZm9yIHB1dHMnCn0pOwoKZXhwb3J0cy5SRVNFUlZFRF9JRCA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDQwMCwKICBlcnJvcjogJ2JhZF9yZXF1ZXN0JywKICByZWFzb246ICdPbmx5IHJlc2VydmVkIGRvY3VtZW50IGlkcyBtYXkgc3RhcnQgd2l0aCB1bmRlcnNjb3JlLicKfSk7CgpleHBvcnRzLk5PVF9PUEVOID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNDEyLAogIGVycm9yOiAncHJlY29uZGl0aW9uX2ZhaWxlZCcsCiAgcmVhc29uOiAnRGF0YWJhc2Ugbm90IG9wZW4nCn0pOwoKZXhwb3J0cy5VTktOT1dOX0VSUk9SID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNTAwLAogIGVycm9yOiAndW5rbm93bl9lcnJvcicsCiAgcmVhc29uOiAnRGF0YWJhc2UgZW5jb3VudGVyZWQgYW4gdW5rbm93biBlcnJvcicKfSk7CgpleHBvcnRzLkJBRF9BUkcgPSBuZXcgUG91Y2hFcnJvcih7CiAgc3RhdHVzOiA1MDAsCiAgZXJyb3I6ICdiYWRhcmcnLAogIHJlYXNvbjogJ1NvbWUgcXVlcnkgYXJndW1lbnQgaXMgaW52YWxpZCcKfSk7CgpleHBvcnRzLklOVkFMSURfUkVRVUVTVCA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDQwMCwKICBlcnJvcjogJ2ludmFsaWRfcmVxdWVzdCcsCiAgcmVhc29uOiAnUmVxdWVzdCB3YXMgaW52YWxpZCcKfSk7CgpleHBvcnRzLlFVRVJZX1BBUlNFX0VSUk9SID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNDAwLAogIGVycm9yOiAncXVlcnlfcGFyc2VfZXJyb3InLAogIHJlYXNvbjogJ1NvbWUgcXVlcnkgcGFyYW1ldGVyIGlzIGludmFsaWQnCn0pOwoKZXhwb3J0cy5ET0NfVkFMSURBVElPTiA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDUwMCwKICBlcnJvcjogJ2RvY192YWxpZGF0aW9uJywKICByZWFzb246ICdCYWQgc3BlY2lhbCBkb2N1bWVudCBtZW1iZXInCn0pOwoKZXhwb3J0cy5CQURfUkVRVUVTVCA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDQwMCwKICBlcnJvcjogJ2JhZF9yZXF1ZXN0JywKICByZWFzb246ICdTb21ldGhpbmcgd3Jvbmcgd2l0aCB0aGUgcmVxdWVzdCcKfSk7CgpleHBvcnRzLk5PVF9BTl9PQkpFQ1QgPSBuZXcgUG91Y2hFcnJvcih7CiAgc3RhdHVzOiA0MDAsCiAgZXJyb3I6ICdiYWRfcmVxdWVzdCcsCiAgcmVhc29uOiAnRG9jdW1lbnQgbXVzdCBiZSBhIEpTT04gb2JqZWN0Jwp9KTsKCmV4cG9ydHMuREJfTUlTU0lORyA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDQwNCwKICBlcnJvcjogJ25vdF9mb3VuZCcsCiAgcmVhc29uOiAnRGF0YWJhc2Ugbm90IGZvdW5kJwp9KTsKCmV4cG9ydHMuSURCX0VSUk9SID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNTAwLAogIGVycm9yOiAnaW5kZXhlZF9kYl93ZW50X2JhZCcsCiAgcmVhc29uOiAndW5rbm93bicKfSk7CgpleHBvcnRzLldTUV9FUlJPUiA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDUwMCwKICBlcnJvcjogJ3dlYl9zcWxfd2VudF9iYWQnLAogIHJlYXNvbjogJ3Vua25vd24nCn0pOwoKZXhwb3J0cy5MREJfRVJST1IgPSBuZXcgUG91Y2hFcnJvcih7CiAgc3RhdHVzOiA1MDAsCiAgZXJyb3I6ICdsZXZlbERCX3dlbnRfd2VudF9iYWQnLAogIHJlYXNvbjogJ3Vua25vd24nCn0pOwoKZXhwb3J0cy5GT1JCSURERU4gPSBuZXcgUG91Y2hFcnJvcih7CiAgc3RhdHVzOiA0MDMsCiAgZXJyb3I6ICdmb3JiaWRkZW4nLAogIHJlYXNvbjogJ0ZvcmJpZGRlbiBieSBkZXNpZ24gZG9jIHZhbGlkYXRlX2RvY191cGRhdGUgZnVuY3Rpb24nCn0pOwoKZXhwb3J0cy5JTlZBTElEX1JFViA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDQwMCwKICBlcnJvcjogJ2JhZF9yZXF1ZXN0JywKICByZWFzb246ICdJbnZhbGlkIHJldiBmb3JtYXQnCn0pOwoKZXhwb3J0cy5GSUxFX0VYSVNUUyA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDQxMiwKICBlcnJvcjogJ2ZpbGVfZXhpc3RzJywKICByZWFzb246ICdUaGUgZGF0YWJhc2UgY291bGQgbm90IGJlIGNyZWF0ZWQsIHRoZSBmaWxlIGFscmVhZHkgZXhpc3RzLicKfSk7CgpleHBvcnRzLk1JU1NJTkdfU1RVQiA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDQxMiwKICBlcnJvcjogJ21pc3Npbmdfc3R1YicKfSk7CgpleHBvcnRzLmVycm9yID0gZnVuY3Rpb24gKGVycm9yLCByZWFzb24sIG5hbWUpIHsKICBmdW5jdGlvbiBDdXN0b21Qb3VjaEVycm9yKHJlYXNvbikgewogICAgLy8gaW5oZXJpdCBlcnJvciBwcm9wZXJ0aWVzIGZyb20gb3VyIHBhcmVudCBlcnJvciBtYW51YWxseQogICAgLy8gc28gYXMgdG8gYWxsb3cgcHJvcGVyIEpTT04gcGFyc2luZy4KICAgIC8qIGpzaGludCBpZ25vcmU6c3RhcnQgKi8KICAgIGZvciAodmFyIHAgaW4gZXJyb3IpIHsKICAgICAgaWYgKHR5cGVvZiBlcnJvcltwXSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRoaXNbcF0gPSBlcnJvcltwXTsKICAgICAgfQogICAgfQogICAgLyoganNoaW50IGlnbm9yZTplbmQgKi8KICAgIGlmIChuYW1lICE9PSB1bmRlZmluZWQpIHsKICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgIH0KICAgIGlmIChyZWFzb24gIT09IHVuZGVmaW5lZCkgewogICAgICB0aGlzLnJlYXNvbiA9IHJlYXNvbjsKICAgIH0KICB9CiAgQ3VzdG9tUG91Y2hFcnJvci5wcm90b3R5cGUgPSBQb3VjaEVycm9yLnByb3RvdHlwZTsKICByZXR1cm4gbmV3IEN1c3RvbVBvdWNoRXJyb3IocmVhc29uKTsKfTsKCi8vIEZpbmQgb25lIG9mIHRoZSBlcnJvcnMgZGVmaW5lZCBhYm92ZSBiYXNlZCBvbiB0aGUgdmFsdWUKLy8gb2YgdGhlIHNwZWNpZmllZCBwcm9wZXJ0eS4KLy8gSWYgcmVhc29uIGlzIHByb3ZpZGVkIHByZWZlciB0aGUgZXJyb3IgbWF0Y2hpbmcgdGhhdCByZWFzb24uCi8vIFRoaXMgaXMgZm9yIGRpZmZlcmVudGlhdGluZyBiZXR3ZWVuIGVycm9ycyB3aXRoIHRoZSBzYW1lIG5hbWUgYW5kIHN0YXR1cywKLy8gZWcsIGJhZF9yZXF1ZXN0LgpleHBvcnRzLmdldEVycm9yVHlwZUJ5UHJvcCA9IGZ1bmN0aW9uIChwcm9wLCB2YWx1ZSwgcmVhc29uKSB7CiAgdmFyIGVycm9ycyA9IGV4cG9ydHM7CiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihmdW5jdGlvbiAoa2V5KSB7CiAgICB2YXIgZXJyb3IgPSBlcnJvcnNba2V5XTsKICAgIHJldHVybiB0eXBlb2YgZXJyb3IgIT09ICdmdW5jdGlvbicgJiYgZXJyb3JbcHJvcF0gPT09IHZhbHVlOwogIH0pOwogIHZhciBrZXkgPSByZWFzb24gJiYga2V5cy5maWx0ZXIoZnVuY3Rpb24gKGtleSkgewogICAgICB2YXIgZXJyb3IgPSBlcnJvcnNba2V5XTsKICAgICAgcmV0dXJuIGVycm9yLm1lc3NhZ2UgPT09IHJlYXNvbjsKICAgIH0pWzBdIHx8IGtleXNbMF07CiAgcmV0dXJuIChrZXkpID8gZXJyb3JzW2tleV0gOiBudWxsOwp9OwoKZXhwb3J0cy5nZW5lcmF0ZUVycm9yRnJvbVJlc3BvbnNlID0gZnVuY3Rpb24gKHJlcykgewogIHZhciBlcnJvciwgZXJyTmFtZSwgZXJyVHlwZSwgZXJyTXNnLCBlcnJSZWFzb247CiAgdmFyIGVycm9ycyA9IGV4cG9ydHM7CgogIGVyck5hbWUgPSAocmVzLmVycm9yID09PSB0cnVlICYmIHR5cGVvZiByZXMubmFtZSA9PT0gJ3N0cmluZycpID8KICAgIHJlcy5uYW1lIDoKICAgIHJlcy5lcnJvcjsKICBlcnJSZWFzb24gPSByZXMucmVhc29uOwogIGVyclR5cGUgPSBlcnJvcnMuZ2V0RXJyb3JUeXBlQnlQcm9wKCduYW1lJywgZXJyTmFtZSwgZXJyUmVhc29uKTsKCiAgaWYgKHJlcy5taXNzaW5nIHx8CiAgICBlcnJSZWFzb24gPT09ICdtaXNzaW5nJyB8fAogICAgZXJyUmVhc29uID09PSAnZGVsZXRlZCcgfHwKICAgIGVyck5hbWUgPT09ICdub3RfZm91bmQnKSB7CiAgICBlcnJUeXBlID0gZXJyb3JzLk1JU1NJTkdfRE9DOwogIH0gZWxzZSBpZiAoZXJyTmFtZSA9PT0gJ2RvY192YWxpZGF0aW9uJykgewogICAgLy8gZG9jIHZhbGlkYXRpb24gbmVlZHMgc3BlY2lhbCB0cmVhdG1lbnQgc2luY2UKICAgIC8vIHJlcy5yZWFzb24gZGVwZW5kcyBvbiB0aGUgdmFsaWRhdGlvbiBlcnJvci4KICAgIC8vIHNlZSB1dGlscy5qcwogICAgZXJyVHlwZSA9IGVycm9ycy5ET0NfVkFMSURBVElPTjsKICAgIGVyck1zZyA9IGVyclJlYXNvbjsKICB9IGVsc2UgaWYgKGVyck5hbWUgPT09ICdiYWRfcmVxdWVzdCcgJiYgZXJyVHlwZS5tZXNzYWdlICE9PSBlcnJSZWFzb24pIHsKICAgIC8vIGlmIGJhZF9yZXF1ZXN0IGVycm9yIGFscmVhZHkgZm91bmQgYmFzZWQgb24gcmVhc29uIGRvbid0IG92ZXJyaWRlLgoKICAgIC8vIGF0dGFjaG1lbnQgZXJyb3JzLgogICAgaWYgKGVyclJlYXNvbi5pbmRleE9mKCd1bmtub3duIHN0dWIgYXR0YWNobWVudCcpID09PSAwKSB7CiAgICAgIGVyclR5cGUgPSBlcnJvcnMuTUlTU0lOR19TVFVCOwogICAgICBlcnJNc2cgPSBlcnJSZWFzb247CiAgICB9IGVsc2UgewogICAgICBlcnJUeXBlID0gZXJyb3JzLkJBRF9SRVFVRVNUOwogICAgfQogIH0KCiAgLy8gZmFsbGJhY2sgdG8gZXJyb3IgYnkgc3RhdHlzIG9yIHVua25vd24gZXJyb3IuCiAgaWYgKCFlcnJUeXBlKSB7CiAgICBlcnJUeXBlID0gZXJyb3JzLmdldEVycm9yVHlwZUJ5UHJvcCgnc3RhdHVzJywgcmVzLnN0YXR1cywgZXJyUmVhc29uKSB8fAogICAgZXJyb3JzLlVOS05PV05fRVJST1I7CiAgfQoKICBlcnJvciA9IGVycm9ycy5lcnJvcihlcnJUeXBlLCBlcnJSZWFzb24sIGVyck5hbWUpOwoKICAvLyBLZWVwIGN1c3RvbSBtZXNzYWdlLgogIGlmIChlcnJNc2cpIHsKICAgIGVycm9yLm1lc3NhZ2UgPSBlcnJNc2c7CiAgfQoKICAvLyBLZWVwIGhlbHBmdWwgcmVzcG9uc2UgZGF0YSBpbiBvdXIgZXJyb3IgbWVzc2FnZXMuCiAgaWYgKHJlcy5pZCkgewogICAgZXJyb3IuaWQgPSByZXMuaWQ7CiAgfQogIGlmIChyZXMuc3RhdHVzKSB7CiAgICBlcnJvci5zdGF0dXMgPSByZXMuc3RhdHVzOwogIH0KICBpZiAocmVzLnN0YXR1c1RleHQpIHsKICAgIGVycm9yLm5hbWUgPSByZXMuc3RhdHVzVGV4dDsKICB9CiAgaWYgKHJlcy5taXNzaW5nKSB7CiAgICBlcnJvci5taXNzaW5nID0gcmVzLm1pc3Npbmc7CiAgfQoKICByZXR1cm4gZXJyb3I7Cn07Cgp9LHsiaW5oZXJpdHMiOjEyfV0sMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8qIGpzaGludCB3b3JrZXI6dHJ1ZSAqLwoKdmFyIFByb21pc2UgPSByZXF1aXJlKCdwb3VjaGRiL2V4dHJhcy9wcm9taXNlJyk7CnZhciBlcnJvcnMgPSByZXF1aXJlKCcuLi9zaGFyZWQvZXJyb3JzJyk7CnZhciB3b3JrZXJVdGlscyA9IHJlcXVpcmUoJy4vdXRpbHMnKTsKdmFyIG1ha2VQb3VjaENyZWF0b3IgPSByZXF1aXJlKCcuL21ha2UtcG91Y2gtY3JlYXRvcicpOwp2YXIgZGVzdHJpbmdpZnlBcmdzID0gd29ya2VyVXRpbHMuZGVzdHJpbmdpZnlBcmdzOwp2YXIgZGJzID0ge307CnZhciBhbGxDaGFuZ2VzID0ge307Cgp2YXIgbG9nID0gcmVxdWlyZSgnZGVidWcnKSgncG91Y2hkYjp3b3JrZXInKTsKCmZ1bmN0aW9uIHNlbmRFcnJvcihzb2NrZXRJZCwgbWVzc2FnZUlkLCBkYXRhKSB7CiAgbG9nKCcgLT4gc2VuZEVycm9yJywgc29ja2V0SWQsIG1lc3NhZ2VJZCwgZGF0YSk7CiAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICB0eXBlOiAnZXJyb3InLAogICAgaWQ6IHNvY2tldElkLAogICAgbWVzc2FnZUlkOiBtZXNzYWdlSWQsCiAgICBjb250ZW50OiB3b3JrZXJVdGlscy5jcmVhdGVFcnJvcihkYXRhKQogIH0pOwp9CgpmdW5jdGlvbiBzZW5kU3VjY2Vzcyhzb2NrZXRJZCwgbWVzc2FnZUlkLCBkYXRhKSB7CiAgbG9nKCcgLT4gc2VuZFN1Y2Nlc3MnLCBzb2NrZXRJZCwgbWVzc2FnZUlkKTsKICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgIHR5cGU6ICdzdWNjZXNzJywKICAgIGlkOiBzb2NrZXRJZCwKICAgIG1lc3NhZ2VJZDogbWVzc2FnZUlkLAogICAgY29udGVudDogZGF0YQogIH0pOwp9CgpmdW5jdGlvbiBzZW5kQmluYXJ5U3VjY2Vzcyhzb2NrZXRJZCwgbWVzc2FnZUlkLCB0eXBlLCBibG9iKSB7CiAgbG9nKCcgLT4gc2VuZEJpbmFyeVN1Y2Nlc3MnLCBzb2NrZXRJZCwgbWVzc2FnZUlkKTsKICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgIHR5cGU6ICdzdWNjZXNzJywKICAgIGlkOiBzb2NrZXRJZCwKICAgIG1lc3NhZ2VJZDogbWVzc2FnZUlkLAogICAgY29udGVudDogYmxvYgogIH0pOwp9CgpmdW5jdGlvbiBzZW5kVXBkYXRlKHNvY2tldElkLCBtZXNzYWdlSWQsIGRhdGEpIHsKICBsb2coJyAtPiBzZW5kVXBkYXRlJywgc29ja2V0SWQsIG1lc3NhZ2VJZCk7CiAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICB0eXBlOiAndXBkYXRlJywKICAgIGlkOiBzb2NrZXRJZCwKICAgIG1lc3NhZ2VJZDogbWVzc2FnZUlkLAogICAgY29udGVudDogZGF0YQogIH0pOwp9CgpmdW5jdGlvbiBkYk1ldGhvZChzb2NrZXRJZCwgbWV0aG9kTmFtZSwgbWVzc2FnZUlkLCBhcmdzKSB7CiAgdmFyIGRiID0gZGJzWyckJyArIHNvY2tldElkXTsKICBpZiAoIWRiKSB7CiAgICByZXR1cm4gc2VuZEVycm9yKHNvY2tldElkLCBtZXNzYWdlSWQsIHtlcnJvcjogJ2RiIG5vdCBmb3VuZCd9KTsKICB9CiAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gZGI7CiAgfSkudGhlbihmdW5jdGlvbiAocmVzKSB7CiAgICB2YXIgZGIgPSByZXMucG91Y2g7CiAgICByZXR1cm4gZGJbbWV0aG9kTmFtZV0uYXBwbHkoZGIsIGFyZ3MpOwogIH0pLnRoZW4oZnVuY3Rpb24gKHJlcykgewogICAgc2VuZFN1Y2Nlc3Moc29ja2V0SWQsIG1lc3NhZ2VJZCwgcmVzKTsKICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICBzZW5kRXJyb3Ioc29ja2V0SWQsIG1lc3NhZ2VJZCwgZXJyKTsKICB9KTsKfQoKZnVuY3Rpb24gZ2V0QXR0YWNobWVudChzb2NrZXRJZCwgbWVzc2FnZUlkLCBhcmdzKSB7CiAgdmFyIGRiID0gZGJzWyckJyArIHNvY2tldElkXTsKICBpZiAoIWRiKSB7CiAgICByZXR1cm4gc2VuZEVycm9yKHNvY2tldElkLCBtZXNzYWdlSWQsIHtlcnJvcjogJ2RiIG5vdCBmb3VuZCd9KTsKICB9CgogIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGRiOwogIH0pLnRoZW4oZnVuY3Rpb24gKHJlcykgewogICAgdmFyIGRiID0gcmVzLnBvdWNoOwogICAgdmFyIGRvY0lkID0gYXJnc1swXTsKICAgIHZhciBhdHRJZCA9IGFyZ3NbMV07CiAgICB2YXIgb3B0cyA9IGFyZ3NbMl07CiAgICBpZiAodHlwZW9mIG9wdHMgIT09ICdvYmplY3QnKSB7CiAgICAgIG9wdHMgPSB7fTsKICAgIH0KICAgIHJldHVybiBkYi5nZXQoZG9jSWQsIG9wdHMpLnRoZW4oZnVuY3Rpb24gKGRvYykgewogICAgICBpZiAoIWRvYy5fYXR0YWNobWVudHMgfHwgIWRvYy5fYXR0YWNobWVudHNbYXR0SWRdKSB7CiAgICAgICAgdGhyb3cgZXJyb3JzLk1JU1NJTkdfRE9DOwogICAgICB9CiAgICAgIHZhciB0eXBlID0gZG9jLl9hdHRhY2htZW50c1thdHRJZF0uY29udGVudF90eXBlOwogICAgICByZXR1cm4gZGIuZ2V0QXR0YWNobWVudC5hcHBseShkYiwgYXJncykudGhlbihmdW5jdGlvbiAoYnVmZikgewogICAgICAgIHNlbmRCaW5hcnlTdWNjZXNzKHNvY2tldElkLCBtZXNzYWdlSWQsIHR5cGUsIGJ1ZmYpOwogICAgICB9KTsKICAgIH0pOwogIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgIHNlbmRFcnJvcihzb2NrZXRJZCwgbWVzc2FnZUlkLCBlcnIpOwogIH0pOwp9CgpmdW5jdGlvbiBkZXN0cm95KHNvY2tldElkLCBtZXNzYWdlSWQsIGFyZ3MpIHsKICB2YXIga2V5ID0gJyQnICsgc29ja2V0SWQ7CiAgdmFyIGRiID0gZGJzW2tleV07CiAgaWYgKCFkYikgewogICAgcmV0dXJuIHNlbmRFcnJvcihzb2NrZXRJZCwgbWVzc2FnZUlkLCB7ZXJyb3I6ICdkYiBub3QgZm91bmQnfSk7CiAgfQogIGRlbGV0ZSBkYnNba2V5XTsKCiAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gZGI7CiAgfSkudGhlbihmdW5jdGlvbiAocmVzKSB7CiAgICB2YXIgZGIgPSByZXMucG91Y2g7CiAgICByZXR1cm4gZGIuZGVzdHJveS5hcHBseShkYiwgYXJncyk7CiAgfSkudGhlbihmdW5jdGlvbiAocmVzKSB7CiAgICBzZW5kU3VjY2Vzcyhzb2NrZXRJZCwgbWVzc2FnZUlkLCByZXMpOwogIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgIHNlbmRFcnJvcihzb2NrZXRJZCwgbWVzc2FnZUlkLCBlcnIpOwogIH0pOwp9CgpmdW5jdGlvbiBsaXZlQ2hhbmdlcyhzb2NrZXRJZCwgbWVzc2FnZUlkLCBhcmdzKSB7CiAgdmFyIGRiID0gZGJzWyckJyArIHNvY2tldElkXTsKICBpZiAoIWRiKSB7CiAgICByZXR1cm4gc2VuZEVycm9yKHNvY2tldElkLCBtZXNzYWdlSWQsIHtlcnJvcjogJ2RiIG5vdCBmb3VuZCd9KTsKICB9CiAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gZGI7CiAgfSkudGhlbihmdW5jdGlvbiAocmVzKSB7CiAgICB2YXIgZGIgPSByZXMucG91Y2g7CiAgICB2YXIgY2hhbmdlcyA9IGRiLmNoYW5nZXMoYXJnc1swXSk7CiAgICBhbGxDaGFuZ2VzW21lc3NhZ2VJZF0gPSBjaGFuZ2VzOwogICAgY2hhbmdlcy5vbignY2hhbmdlJywgZnVuY3Rpb24gKGNoYW5nZSkgewogICAgICBzZW5kVXBkYXRlKHNvY2tldElkLCBtZXNzYWdlSWQsIGNoYW5nZSk7CiAgICB9KS5vbignY29tcGxldGUnLCBmdW5jdGlvbiAoY2hhbmdlKSB7CiAgICAgIGNoYW5nZXMucmVtb3ZlQWxsTGlzdGVuZXJzKCk7CiAgICAgIGRlbGV0ZSBhbGxDaGFuZ2VzW21lc3NhZ2VJZF07CiAgICAgIHNlbmRTdWNjZXNzKHNvY2tldElkLCBtZXNzYWdlSWQsIGNoYW5nZSk7CiAgICB9KS5vbignZXJyb3InLCBmdW5jdGlvbiAoY2hhbmdlKSB7CiAgICAgIGNoYW5nZXMucmVtb3ZlQWxsTGlzdGVuZXJzKCk7CiAgICAgIGRlbGV0ZSBhbGxDaGFuZ2VzW21lc3NhZ2VJZF07CiAgICAgIHNlbmRFcnJvcihzb2NrZXRJZCwgbWVzc2FnZUlkLCBjaGFuZ2UpOwogICAgfSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGNhbmNlbENoYW5nZXMobWVzc2FnZUlkKSB7CiAgdmFyIGNoYW5nZXMgPSBhbGxDaGFuZ2VzW21lc3NhZ2VJZF07CiAgaWYgKGNoYW5nZXMpIHsKICAgIGNoYW5nZXMuY2FuY2VsKCk7CiAgfQp9CgpmdW5jdGlvbiBjcmVhdGVEYXRhYmFzZShzb2NrZXRJZCwgbWVzc2FnZUlkLCBhcmdzLCBwb3VjaENyZWF0b3IpIHsKICB2YXIga2V5ID0gJyQnICsgc29ja2V0SWQ7CiAgdmFyIGRiID0gZGJzW2tleV07CiAgaWYgKGRiKSB7CiAgICByZXR1cm4gc2VuZFN1Y2Nlc3Moc29ja2V0SWQsIG1lc3NhZ2VJZCwge29rOiB0cnVlLCBleGlzdHM6IHRydWV9KTsKICB9CgogIHZhciBuYW1lID0gdHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnID8gYXJnc1swXSA6IGFyZ3NbMF0ubmFtZTsKCiAgaWYgKCFuYW1lKSB7CiAgICByZXR1cm4gc2VuZEVycm9yKHNvY2tldElkLCBtZXNzYWdlSWQsIHsKICAgICAgZXJyb3I6ICd5b3UgbXVzdCBwcm92aWRlIGEgZGF0YWJhc2UgbmFtZScKICAgIH0pOwogIH0KCiAgZGJzW2tleV0gPSBwb3VjaENyZWF0b3IoYXJncyk7CiAgcG91Y2hDcmVhdG9yKGFyZ3MpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgc2VuZFN1Y2Nlc3Moc29ja2V0SWQsIG1lc3NhZ2VJZCwge29rOiB0cnVlfSk7CiAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgc2VuZEVycm9yKHNvY2tldElkLCBtZXNzYWdlSWQsIGVycik7CiAgfSk7Cn0KCmZ1bmN0aW9uIG9uUmVjZWl2ZU1lc3NhZ2Uoc29ja2V0SWQsIHR5cGUsIG1lc3NhZ2VJZCwgYXJncywgcG91Y2hDcmVhdG9yKSB7CiAgbG9nKCdvblJlY2VpdmVNZXNzYWdlJywgdHlwZSwgc29ja2V0SWQsIG1lc3NhZ2VJZCwgYXJncyk7CiAgc3dpdGNoICh0eXBlKSB7CiAgICBjYXNlICdjcmVhdGVEYXRhYmFzZSc6CiAgICAgIHJldHVybiBjcmVhdGVEYXRhYmFzZShzb2NrZXRJZCwgbWVzc2FnZUlkLCBhcmdzLCBwb3VjaENyZWF0b3IpOwogICAgY2FzZSAnaWQnOgogICAgICBzZW5kU3VjY2Vzcyhzb2NrZXRJZCwgbWVzc2FnZUlkLCBzb2NrZXRJZCk7CiAgICAgIHJldHVybjsKICAgIGNhc2UgJ2luZm8nOgogICAgY2FzZSAncHV0JzoKICAgIGNhc2UgJ2FsbERvY3MnOgogICAgY2FzZSAnYnVsa0RvY3MnOgogICAgY2FzZSAncG9zdCc6CiAgICBjYXNlICdnZXQnOgogICAgY2FzZSAncmVtb3ZlJzoKICAgIGNhc2UgJ3JldnNEaWZmJzoKICAgIGNhc2UgJ2NvbXBhY3QnOgogICAgY2FzZSAndmlld0NsZWFudXAnOgogICAgY2FzZSAncmVtb3ZlQXR0YWNobWVudCc6CiAgICBjYXNlICdwdXRBdHRhY2htZW50JzoKICAgIGNhc2UgJ3F1ZXJ5JzoKICAgIGNhc2UgJ2NoYW5nZXMnOgogICAgICByZXR1cm4gZGJNZXRob2Qoc29ja2V0SWQsIHR5cGUsIG1lc3NhZ2VJZCwgYXJncyk7CiAgICBjYXNlICdnZXRBdHRhY2htZW50JzoKICAgICAgcmV0dXJuIGdldEF0dGFjaG1lbnQoc29ja2V0SWQsIG1lc3NhZ2VJZCwgYXJncyk7CiAgICBjYXNlICdsaXZlQ2hhbmdlcyc6CiAgICAgIHJldHVybiBsaXZlQ2hhbmdlcyhzb2NrZXRJZCwgbWVzc2FnZUlkLCBhcmdzKTsKICAgIGNhc2UgJ2NhbmNlbENoYW5nZXMnOgogICAgICByZXR1cm4gY2FuY2VsQ2hhbmdlcyhtZXNzYWdlSWQpOwogICAgY2FzZSAnZGVzdHJveSc6CiAgICAgIHJldHVybiBkZXN0cm95KHNvY2tldElkLCBtZXNzYWdlSWQsIGFyZ3MpOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIHNlbmRFcnJvcihzb2NrZXRJZCwgbWVzc2FnZUlkLCB7ZXJyb3I6ICd1bmtub3duIEFQSSBtZXRob2Q6ICcgKyB0eXBlfSk7CiAgfQp9CgpmdW5jdGlvbiBwYXJzZU1lc3NhZ2UobWVzc2FnZSwgc29ja2V0SWQsIHBvdWNoQ3JlYXRvcikgewogIHRyeSB7CiAgICB2YXIgdHlwZSA9IG1lc3NhZ2UudHlwZTsKICAgIHZhciBtZXNzYWdlSWQgPSBtZXNzYWdlLm1lc3NhZ2VJZDsKICAgIHZhciBhcmdzID0gZGVzdHJpbmdpZnlBcmdzKG1lc3NhZ2UuYXJncyk7CiAgICBvblJlY2VpdmVNZXNzYWdlKHNvY2tldElkLCB0eXBlLCBtZXNzYWdlSWQsIGFyZ3MsIHBvdWNoQ3JlYXRvcik7CiAgfSBjYXRjaCAoZXJyKSB7CiAgICBsb2coJ2ludmFsaWQgbWVzc2FnZSwgaWdub3JpbmcnLCBlcnIpOwogIH0KfQoKdmFyIG9wdGlvbnMgPSB7fTsKdmFyIHBvdWNoQ3JlYXRvciA9IG1ha2VQb3VjaENyZWF0b3Iob3B0aW9ucyk7CgpzZWxmLm9ubWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkgewogIHZhciBzb2NrZXRJZCA9IGV2ZW50LmRhdGEuaWQ7CiAgaWYgKGV2ZW50LmRhdGEudHlwZSA9PT0gJ2Nsb3NlJykgewogICAgbG9nKCdjbG9zaW5nIHNvY2tldCcsIHNvY2tldElkKTsKICAgIGRlbGV0ZSBkYnNbJyQnICsgc29ja2V0SWRdOwogIH0gZWxzZSB7CiAgICBwYXJzZU1lc3NhZ2UoZXZlbnQuZGF0YSwgc29ja2V0SWQsIHBvdWNoQ3JlYXRvcik7CiAgfQp9Owp9LHsiLi4vc2hhcmVkL2Vycm9ycyI6MSwiLi9tYWtlLXBvdWNoLWNyZWF0b3IiOjMsIi4vdXRpbHMiOjUsImRlYnVnIjo5LCJwb3VjaGRiL2V4dHJhcy9wcm9taXNlIjoxM31dLDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgUG91Y2hEQiA9IHJlcXVpcmUoJ3BvdWNoZGInKTsKdmFyIFByb21pc2UgPSByZXF1aXJlKCdwb3VjaGRiL2V4dHJhcy9wcm9taXNlJyk7CgpmdW5jdGlvbiBjcmVhdGVMb2NhbFBvdWNoKGFyZ3MpIHsKCiAgaWYgKHR5cGVvZiBhcmdzWzBdID09PSAnc3RyaW5nJykgewogICAgYXJncyA9IFt7bmFtZTogYXJnc1swXX1dOwogIH0KCiAgLy8gVE9ETzogdGhlcmUgaXMgcHJvYmFibHkgYSBzbWFydGVyIHdheSB0byBiZSBzYWZlIGFib3V0IGZpbGVwYXRocwogIGFyZ3NbMF0ubmFtZSA9IGFyZ3NbMF0ubmFtZS5yZXBsYWNlKCcuJywgJycpLnJlcGxhY2UoJy8nLCAnJyk7CiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7CiAgICBwb3VjaDogbmV3IFBvdWNoREIoYXJnc1swXSkKICB9KTsKfQoKZnVuY3Rpb24gY3JlYXRlSHR0cFBvdWNoKG9wdGlvbnMpIHsKICB2YXIgcmVtb3RlVXJsID0gb3B0aW9ucy5yZW1vdGVVcmw7CiAgLy8gY2hvcCBvZmYgbGFzdCAnLycKICBpZiAocmVtb3RlVXJsW3JlbW90ZVVybC5sZW5ndGggLSAxXSA9PT0gJy8nKSB7CiAgICByZW1vdGVVcmwgPSByZW1vdGVVcmwuc3Vic3RyaW5nKDAsIHJlbW90ZVVybC5sZW5ndGggLTEpOwogIH0KICByZXR1cm4gZnVuY3Rpb24gKGFyZ3MpIHsKICAgIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gJ3N0cmluZycpIHsKICAgICAgYXJncyA9IFt7bmFtZTogYXJnc1swXX1dOwogICAgfQogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7CiAgICAgIHBvdWNoOiBuZXcgUG91Y2hEQihyZW1vdGVVcmwgKyAnLycgKyBhcmdzWzBdLm5hbWUpCiAgICB9KTsKICB9Owp9CgpmdW5jdGlvbiBtYWtlUG91Y2hDcmVhdG9yKG9wdGlvbnMpIHsKICBpZiAob3B0aW9ucy5yZW1vdGVVcmwpIHsKICAgIHJldHVybiBjcmVhdGVIdHRwUG91Y2gob3B0aW9ucyk7CiAgfQogIGlmICghb3B0aW9ucy5wb3VjaENyZWF0b3IpIHsKICAgIHJldHVybiBjcmVhdGVMb2NhbFBvdWNoOwogIH0KICByZXR1cm4gZnVuY3Rpb24gKGFyZ3MpIHsKICAgIHZhciBuYW1lID0gdHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnID8gYXJnc1swXSA6IGFyZ3NbMF0ubmFtZTsKICAgIHZhciByZXMgPSBvcHRpb25zLnBvdWNoQ3JlYXRvcihuYW1lKTsKICAgIGlmIChyZXMgaW5zdGFuY2VvZiBQb3VjaERCKSB7CiAgICAgIHJldHVybiB7cG91Y2g6IHJlc307CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gcmVzOwogICAgfQogIH07Cn0KCm1vZHVsZS5leHBvcnRzID0gbWFrZVBvdWNoQ3JlYXRvcjsKfSx7InBvdWNoZGIiOjg1LCJwb3VjaGRiL2V4dHJhcy9wcm9taXNlIjoxM31dLDQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgbG9nID0gcmVxdWlyZSgnZGVidWcnKSgncG91Y2hkYjp3b3JrZXInKTsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gc2FmZUV2YWwoc3RyKSB7CiAgbG9nKCdzYWZlRXZhbGluZycsIHN0cik7CiAgdmFyIHRhcmdldCA9IHt9OwogIC8qIGpzaGludCBldmlsOiB0cnVlICovCiAgZXZhbCgndGFyZ2V0LnRhcmdldCA9ICgnICsgc3RyICsgJyk7Jyk7CiAgbG9nKCdyZXR1cm5pbmcnLCB0YXJnZXQudGFyZ2V0KTsKICByZXR1cm4gdGFyZ2V0LnRhcmdldDsKfTsKfSx7ImRlYnVnIjo5fV0sNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBzYWZlRXZhbCA9IHJlcXVpcmUoJy4vc2FmZS1ldmFsJyk7CgovLyBtb3N0bHkgYm9ycm93ZWQgZnJvbSBleHByZXNzLXBvdWNoYidzIHV0aWxzLnNlbmRFcnJvcigpCmV4cG9ydHMuY3JlYXRlRXJyb3IgPSBmdW5jdGlvbiAoZXJyKSB7CiAgdmFyIHN0YXR1cyA9IGVyci5zdGF0dXMgfHwgNTAwOwoKICAvLyBsYXN0IGFyZ3VtZW50IGlzIG9wdGlvbmFsCiAgaWYgKGVyci5uYW1lICYmIGVyci5tZXNzYWdlKSB7CiAgICBpZiAoZXJyLm5hbWUgPT09ICdFcnJvcicgfHwgZXJyLm5hbWUgPT09ICdUeXBlRXJyb3InKSB7CiAgICAgIGlmIChlcnIubWVzc2FnZS5pbmRleE9mKCJCYWQgc3BlY2lhbCBkb2N1bWVudCBtZW1iZXIiKSAhPT0gLTEpIHsKICAgICAgICBlcnIubmFtZSA9ICdkb2NfdmFsaWRhdGlvbic7CiAgICAgICAgLy8gYWRkIG1vcmUgY2xhdXNlcyBoZXJlIGlmIHRoZSBlcnJvciBuYW1lIGlzIHRvbyBnZW5lcmFsCiAgICAgIH0gZWxzZSB7CiAgICAgICAgZXJyLm5hbWUgPSAnYmFkX3JlcXVlc3QnOwogICAgICB9CiAgICB9CiAgICBlcnIgPSB7CiAgICAgIGVycm9yOiBlcnIubmFtZSwKICAgICAgbmFtZTogZXJyLm5hbWUsCiAgICAgIHJlYXNvbjogZXJyLm1lc3NhZ2UsCiAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLAogICAgICBzdGF0dXM6IHN0YXR1cwogICAgfTsKICB9CiAgcmV0dXJuIGVycjsKfTsKCmV4cG9ydHMuZGVzdHJpbmdpZnlBcmdzID0gZnVuY3Rpb24gZGVzdHJpbmdpZnlBcmdzKGFyZ3MpIHsKICB2YXIgZnVuY0FyZ3MgPSBbJ2ZpbHRlcicsICdtYXAnLCAncmVkdWNlJ107CiAgYXJncy5mb3JFYWNoKGZ1bmN0aW9uIChhcmcpIHsKICAgIGlmICh0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkoYXJnKSkgewogICAgICBmdW5jQXJncy5mb3JFYWNoKGZ1bmN0aW9uIChmdW5jQXJnKSB7CiAgICAgICAgaWYgKGZ1bmNBcmcgaW4gYXJnICYmIGFyZ1tmdW5jQXJnXS50eXBlID09PSAnZnVuYycgJiYgYXJnW2Z1bmNBcmddLmZ1bmMpIHsKICAgICAgICAgIGFyZ1tmdW5jQXJnXSA9IHNhZmVFdmFsKGFyZ1tmdW5jQXJnXS5mdW5jKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0pOwogIHJldHVybiBhcmdzOwp9Owp9LHsiLi9zYWZlLWV2YWwiOjR9XSw2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSBhcmdzQXJyYXk7CgpmdW5jdGlvbiBhcmdzQXJyYXkoZnVuKSB7CiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIHZhciBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOwogICAgaWYgKGxlbikgewogICAgICB2YXIgYXJncyA9IFtdOwogICAgICB2YXIgaSA9IC0xOwogICAgICB3aGlsZSAoKytpIDwgbGVuKSB7CiAgICAgICAgYXJnc1tpXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgfQogICAgICByZXR1cm4gZnVuLmNhbGwodGhpcywgYXJncyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZnVuLmNhbGwodGhpcywgW10pOwogICAgfQogIH07Cn0KfSx7fV0sNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCmZ1bmN0aW9uIEV2ZW50RW1pdHRlcigpIHsKICB0aGlzLl9ldmVudHMgPSB0aGlzLl9ldmVudHMgfHwge307CiAgdGhpcy5fbWF4TGlzdGVuZXJzID0gdGhpcy5fbWF4TGlzdGVuZXJzIHx8IHVuZGVmaW5lZDsKfQptb2R1bGUuZXhwb3J0cyA9IEV2ZW50RW1pdHRlcjsKCi8vIEJhY2t3YXJkcy1jb21wYXQgd2l0aCBub2RlIDAuMTAueApFdmVudEVtaXR0ZXIuRXZlbnRFbWl0dGVyID0gRXZlbnRFbWl0dGVyOwoKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fZXZlbnRzID0gdW5kZWZpbmVkOwpFdmVudEVtaXR0ZXIucHJvdG90eXBlLl9tYXhMaXN0ZW5lcnMgPSB1bmRlZmluZWQ7CgovLyBCeSBkZWZhdWx0IEV2ZW50RW1pdHRlcnMgd2lsbCBwcmludCBhIHdhcm5pbmcgaWYgbW9yZSB0aGFuIDEwIGxpc3RlbmVycyBhcmUKLy8gYWRkZWQgdG8gaXQuIFRoaXMgaXMgYSB1c2VmdWwgZGVmYXVsdCB3aGljaCBoZWxwcyBmaW5kaW5nIG1lbW9yeSBsZWFrcy4KRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnMgPSAxMDsKCi8vIE9idmlvdXNseSBub3QgYWxsIEVtaXR0ZXJzIHNob3VsZCBiZSBsaW1pdGVkIHRvIDEwLiBUaGlzIGZ1bmN0aW9uIGFsbG93cwovLyB0aGF0IHRvIGJlIGluY3JlYXNlZC4gU2V0IHRvIHplcm8gZm9yIHVubGltaXRlZC4KRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5zZXRNYXhMaXN0ZW5lcnMgPSBmdW5jdGlvbihuKSB7CiAgaWYgKCFpc051bWJlcihuKSB8fCBuIDwgMCB8fCBpc05hTihuKSkKICAgIHRocm93IFR5cGVFcnJvcignbiBtdXN0IGJlIGEgcG9zaXRpdmUgbnVtYmVyJyk7CiAgdGhpcy5fbWF4TGlzdGVuZXJzID0gbjsKICByZXR1cm4gdGhpczsKfTsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uKHR5cGUpIHsKICB2YXIgZXIsIGhhbmRsZXIsIGxlbiwgYXJncywgaSwgbGlzdGVuZXJzOwoKICBpZiAoIXRoaXMuX2V2ZW50cykKICAgIHRoaXMuX2V2ZW50cyA9IHt9OwoKICAvLyBJZiB0aGVyZSBpcyBubyAnZXJyb3InIGV2ZW50IGxpc3RlbmVyIHRoZW4gdGhyb3cuCiAgaWYgKHR5cGUgPT09ICdlcnJvcicpIHsKICAgIGlmICghdGhpcy5fZXZlbnRzLmVycm9yIHx8CiAgICAgICAgKGlzT2JqZWN0KHRoaXMuX2V2ZW50cy5lcnJvcikgJiYgIXRoaXMuX2V2ZW50cy5lcnJvci5sZW5ndGgpKSB7CiAgICAgIGVyID0gYXJndW1lbnRzWzFdOwogICAgICBpZiAoZXIgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgIHRocm93IGVyOyAvLyBVbmhhbmRsZWQgJ2Vycm9yJyBldmVudAogICAgICB9CiAgICAgIHRocm93IFR5cGVFcnJvcignVW5jYXVnaHQsIHVuc3BlY2lmaWVkICJlcnJvciIgZXZlbnQuJyk7CiAgICB9CiAgfQoKICBoYW5kbGVyID0gdGhpcy5fZXZlbnRzW3R5cGVdOwoKICBpZiAoaXNVbmRlZmluZWQoaGFuZGxlcikpCiAgICByZXR1cm4gZmFsc2U7CgogIGlmIChpc0Z1bmN0aW9uKGhhbmRsZXIpKSB7CiAgICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgLy8gZmFzdCBjYXNlcwogICAgICBjYXNlIDE6CiAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMsIGFyZ3VtZW50c1sxXSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMzoKICAgICAgICBoYW5kbGVyLmNhbGwodGhpcywgYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0pOwogICAgICAgIGJyZWFrOwogICAgICAvLyBzbG93ZXIKICAgICAgZGVmYXVsdDoKICAgICAgICBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOwogICAgICAgIGFyZ3MgPSBuZXcgQXJyYXkobGVuIC0gMSk7CiAgICAgICAgZm9yIChpID0gMTsgaSA8IGxlbjsgaSsrKQogICAgICAgICAgYXJnc1tpIC0gMV0gPSBhcmd1bWVudHNbaV07CiAgICAgICAgaGFuZGxlci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICB9IGVsc2UgaWYgKGlzT2JqZWN0KGhhbmRsZXIpKSB7CiAgICBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOwogICAgYXJncyA9IG5ldyBBcnJheShsZW4gLSAxKTsKICAgIGZvciAoaSA9IDE7IGkgPCBsZW47IGkrKykKICAgICAgYXJnc1tpIC0gMV0gPSBhcmd1bWVudHNbaV07CgogICAgbGlzdGVuZXJzID0gaGFuZGxlci5zbGljZSgpOwogICAgbGVuID0gbGlzdGVuZXJzLmxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykKICAgICAgbGlzdGVuZXJzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpOwogIH0KCiAgcmV0dXJuIHRydWU7Cn07CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLmFkZExpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKICB2YXIgbTsKCiAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkKICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgogIGlmICghdGhpcy5fZXZlbnRzKQogICAgdGhpcy5fZXZlbnRzID0ge307CgogIC8vIFRvIGF2b2lkIHJlY3Vyc2lvbiBpbiB0aGUgY2FzZSB0aGF0IHR5cGUgPT09ICJuZXdMaXN0ZW5lciIhIEJlZm9yZQogIC8vIGFkZGluZyBpdCB0byB0aGUgbGlzdGVuZXJzLCBmaXJzdCBlbWl0ICJuZXdMaXN0ZW5lciIuCiAgaWYgKHRoaXMuX2V2ZW50cy5uZXdMaXN0ZW5lcikKICAgIHRoaXMuZW1pdCgnbmV3TGlzdGVuZXInLCB0eXBlLAogICAgICAgICAgICAgIGlzRnVuY3Rpb24obGlzdGVuZXIubGlzdGVuZXIpID8KICAgICAgICAgICAgICBsaXN0ZW5lci5saXN0ZW5lciA6IGxpc3RlbmVyKTsKCiAgaWYgKCF0aGlzLl9ldmVudHNbdHlwZV0pCiAgICAvLyBPcHRpbWl6ZSB0aGUgY2FzZSBvZiBvbmUgbGlzdGVuZXIuIERvbid0IG5lZWQgdGhlIGV4dHJhIGFycmF5IG9iamVjdC4KICAgIHRoaXMuX2V2ZW50c1t0eXBlXSA9IGxpc3RlbmVyOwogIGVsc2UgaWYgKGlzT2JqZWN0KHRoaXMuX2V2ZW50c1t0eXBlXSkpCiAgICAvLyBJZiB3ZSd2ZSBhbHJlYWR5IGdvdCBhbiBhcnJheSwganVzdCBhcHBlbmQuCiAgICB0aGlzLl9ldmVudHNbdHlwZV0ucHVzaChsaXN0ZW5lcik7CiAgZWxzZQogICAgLy8gQWRkaW5nIHRoZSBzZWNvbmQgZWxlbWVudCwgbmVlZCB0byBjaGFuZ2UgdG8gYXJyYXkuCiAgICB0aGlzLl9ldmVudHNbdHlwZV0gPSBbdGhpcy5fZXZlbnRzW3R5cGVdLCBsaXN0ZW5lcl07CgogIC8vIENoZWNrIGZvciBsaXN0ZW5lciBsZWFrCiAgaWYgKGlzT2JqZWN0KHRoaXMuX2V2ZW50c1t0eXBlXSkgJiYgIXRoaXMuX2V2ZW50c1t0eXBlXS53YXJuZWQpIHsKICAgIHZhciBtOwogICAgaWYgKCFpc1VuZGVmaW5lZCh0aGlzLl9tYXhMaXN0ZW5lcnMpKSB7CiAgICAgIG0gPSB0aGlzLl9tYXhMaXN0ZW5lcnM7CiAgICB9IGVsc2UgewogICAgICBtID0gRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnM7CiAgICB9CgogICAgaWYgKG0gJiYgbSA+IDAgJiYgdGhpcy5fZXZlbnRzW3R5cGVdLmxlbmd0aCA+IG0pIHsKICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLndhcm5lZCA9IHRydWU7CiAgICAgIGNvbnNvbGUuZXJyb3IoJyhub2RlKSB3YXJuaW5nOiBwb3NzaWJsZSBFdmVudEVtaXR0ZXIgbWVtb3J5ICcgKwogICAgICAgICAgICAgICAgICAgICdsZWFrIGRldGVjdGVkLiAlZCBsaXN0ZW5lcnMgYWRkZWQuICcgKwogICAgICAgICAgICAgICAgICAgICdVc2UgZW1pdHRlci5zZXRNYXhMaXN0ZW5lcnMoKSB0byBpbmNyZWFzZSBsaW1pdC4nLAogICAgICAgICAgICAgICAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXS5sZW5ndGgpOwogICAgICBpZiAodHlwZW9mIGNvbnNvbGUudHJhY2UgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAvLyBub3Qgc3VwcG9ydGVkIGluIElFIDEwCiAgICAgICAgY29uc29sZS50cmFjZSgpOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gdGhpczsKfTsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUub24gPSBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmFkZExpc3RlbmVyOwoKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQogICAgdGhyb3cgVHlwZUVycm9yKCdsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKCiAgdmFyIGZpcmVkID0gZmFsc2U7CgogIGZ1bmN0aW9uIGcoKSB7CiAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGcpOwoKICAgIGlmICghZmlyZWQpIHsKICAgICAgZmlyZWQgPSB0cnVlOwogICAgICBsaXN0ZW5lci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0KCiAgZy5saXN0ZW5lciA9IGxpc3RlbmVyOwogIHRoaXMub24odHlwZSwgZyk7CgogIHJldHVybiB0aGlzOwp9OwoKLy8gZW1pdHMgYSAncmVtb3ZlTGlzdGVuZXInIGV2ZW50IGlmZiB0aGUgbGlzdGVuZXIgd2FzIHJlbW92ZWQKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgdmFyIGxpc3QsIHBvc2l0aW9uLCBsZW5ndGgsIGk7CgogIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpCiAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwoKICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgcmV0dXJuIHRoaXM7CgogIGxpc3QgPSB0aGlzLl9ldmVudHNbdHlwZV07CiAgbGVuZ3RoID0gbGlzdC5sZW5ndGg7CiAgcG9zaXRpb24gPSAtMTsKCiAgaWYgKGxpc3QgPT09IGxpc3RlbmVyIHx8CiAgICAgIChpc0Z1bmN0aW9uKGxpc3QubGlzdGVuZXIpICYmIGxpc3QubGlzdGVuZXIgPT09IGxpc3RlbmVyKSkgewogICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgIGlmICh0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpCiAgICAgIHRoaXMuZW1pdCgncmVtb3ZlTGlzdGVuZXInLCB0eXBlLCBsaXN0ZW5lcik7CgogIH0gZWxzZSBpZiAoaXNPYmplY3QobGlzdCkpIHsKICAgIGZvciAoaSA9IGxlbmd0aDsgaS0tID4gMDspIHsKICAgICAgaWYgKGxpc3RbaV0gPT09IGxpc3RlbmVyIHx8CiAgICAgICAgICAobGlzdFtpXS5saXN0ZW5lciAmJiBsaXN0W2ldLmxpc3RlbmVyID09PSBsaXN0ZW5lcikpIHsKICAgICAgICBwb3NpdGlvbiA9IGk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICBpZiAocG9zaXRpb24gPCAwKQogICAgICByZXR1cm4gdGhpczsKCiAgICBpZiAobGlzdC5sZW5ndGggPT09IDEpIHsKICAgICAgbGlzdC5sZW5ndGggPSAwOwogICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgfSBlbHNlIHsKICAgICAgbGlzdC5zcGxpY2UocG9zaXRpb24sIDEpOwogICAgfQoKICAgIGlmICh0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpCiAgICAgIHRoaXMuZW1pdCgncmVtb3ZlTGlzdGVuZXInLCB0eXBlLCBsaXN0ZW5lcik7CiAgfQoKICByZXR1cm4gdGhpczsKfTsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlQWxsTGlzdGVuZXJzID0gZnVuY3Rpb24odHlwZSkgewogIHZhciBrZXksIGxpc3RlbmVyczsKCiAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICByZXR1cm4gdGhpczsKCiAgLy8gbm90IGxpc3RlbmluZyBmb3IgcmVtb3ZlTGlzdGVuZXIsIG5vIG5lZWQgdG8gZW1pdAogIGlmICghdGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICBlbHNlIGlmICh0aGlzLl9ldmVudHNbdHlwZV0pCiAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICByZXR1cm4gdGhpczsKICB9CgogIC8vIGVtaXQgcmVtb3ZlTGlzdGVuZXIgZm9yIGFsbCBsaXN0ZW5lcnMgb24gYWxsIGV2ZW50cwogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7CiAgICBmb3IgKGtleSBpbiB0aGlzLl9ldmVudHMpIHsKICAgICAgaWYgKGtleSA9PT0gJ3JlbW92ZUxpc3RlbmVyJykgY29udGludWU7CiAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKGtleSk7CiAgICB9CiAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygncmVtb3ZlTGlzdGVuZXInKTsKICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbdHlwZV07CgogIGlmIChpc0Z1bmN0aW9uKGxpc3RlbmVycykpIHsKICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXJzKTsKICB9IGVsc2UgewogICAgLy8gTElGTyBvcmRlcgogICAgd2hpbGUgKGxpc3RlbmVycy5sZW5ndGgpCiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXJzW2xpc3RlbmVycy5sZW5ndGggLSAxXSk7CiAgfQogIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CgogIHJldHVybiB0aGlzOwp9OwoKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lcnMgPSBmdW5jdGlvbih0eXBlKSB7CiAgdmFyIHJldDsKICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgcmV0ID0gW107CiAgZWxzZSBpZiAoaXNGdW5jdGlvbih0aGlzLl9ldmVudHNbdHlwZV0pKQogICAgcmV0ID0gW3RoaXMuX2V2ZW50c1t0eXBlXV07CiAgZWxzZQogICAgcmV0ID0gdGhpcy5fZXZlbnRzW3R5cGVdLnNsaWNlKCk7CiAgcmV0dXJuIHJldDsKfTsKCkV2ZW50RW1pdHRlci5saXN0ZW5lckNvdW50ID0gZnVuY3Rpb24oZW1pdHRlciwgdHlwZSkgewogIHZhciByZXQ7CiAgaWYgKCFlbWl0dGVyLl9ldmVudHMgfHwgIWVtaXR0ZXIuX2V2ZW50c1t0eXBlXSkKICAgIHJldCA9IDA7CiAgZWxzZSBpZiAoaXNGdW5jdGlvbihlbWl0dGVyLl9ldmVudHNbdHlwZV0pKQogICAgcmV0ID0gMTsKICBlbHNlCiAgICByZXQgPSBlbWl0dGVyLl9ldmVudHNbdHlwZV0ubGVuZ3RoOwogIHJldHVybiByZXQ7Cn07CgpmdW5jdGlvbiBpc0Z1bmN0aW9uKGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nOwp9CgpmdW5jdGlvbiBpc051bWJlcihhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ251bWJlcic7Cn0KCmZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGw7Cn0KCmZ1bmN0aW9uIGlzVW5kZWZpbmVkKGFyZykgewogIHJldHVybiBhcmcgPT09IHZvaWQgMDsKfQoKfSx7fV0sODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIHNoaW0gZm9yIHVzaW5nIHByb2Nlc3MgaW4gYnJvd3NlcgoKdmFyIHByb2Nlc3MgPSBtb2R1bGUuZXhwb3J0cyA9IHt9Owp2YXIgcXVldWUgPSBbXTsKdmFyIGRyYWluaW5nID0gZmFsc2U7CgpmdW5jdGlvbiBkcmFpblF1ZXVlKCkgewogICAgaWYgKGRyYWluaW5nKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgZHJhaW5pbmcgPSB0cnVlOwogICAgdmFyIGN1cnJlbnRRdWV1ZTsKICAgIHZhciBsZW4gPSBxdWV1ZS5sZW5ndGg7CiAgICB3aGlsZShsZW4pIHsKICAgICAgICBjdXJyZW50UXVldWUgPSBxdWV1ZTsKICAgICAgICBxdWV1ZSA9IFtdOwogICAgICAgIHZhciBpID0gLTE7CiAgICAgICAgd2hpbGUgKCsraSA8IGxlbikgewogICAgICAgICAgICBjdXJyZW50UXVldWVbaV0oKTsKICAgICAgICB9CiAgICAgICAgbGVuID0gcXVldWUubGVuZ3RoOwogICAgfQogICAgZHJhaW5pbmcgPSBmYWxzZTsKfQpwcm9jZXNzLm5leHRUaWNrID0gZnVuY3Rpb24gKGZ1bikgewogICAgcXVldWUucHVzaChmdW4pOwogICAgaWYgKCFkcmFpbmluZykgewogICAgICAgIHNldFRpbWVvdXQoZHJhaW5RdWV1ZSwgMCk7CiAgICB9Cn07Cgpwcm9jZXNzLnRpdGxlID0gJ2Jyb3dzZXInOwpwcm9jZXNzLmJyb3dzZXIgPSB0cnVlOwpwcm9jZXNzLmVudiA9IHt9Owpwcm9jZXNzLmFyZ3YgPSBbXTsKcHJvY2Vzcy52ZXJzaW9uID0gJyc7IC8vIGVtcHR5IHN0cmluZyB0byBhdm9pZCByZWdleHAgaXNzdWVzCnByb2Nlc3MudmVyc2lvbnMgPSB7fTsKCmZ1bmN0aW9uIG5vb3AoKSB7fQoKcHJvY2Vzcy5vbiA9IG5vb3A7CnByb2Nlc3MuYWRkTGlzdGVuZXIgPSBub29wOwpwcm9jZXNzLm9uY2UgPSBub29wOwpwcm9jZXNzLm9mZiA9IG5vb3A7CnByb2Nlc3MucmVtb3ZlTGlzdGVuZXIgPSBub29wOwpwcm9jZXNzLnJlbW92ZUFsbExpc3RlbmVycyA9IG5vb3A7CnByb2Nlc3MuZW1pdCA9IG5vb3A7Cgpwcm9jZXNzLmJpbmRpbmcgPSBmdW5jdGlvbiAobmFtZSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdwcm9jZXNzLmJpbmRpbmcgaXMgbm90IHN1cHBvcnRlZCcpOwp9OwoKLy8gVE9ETyhzaHR5bG1hbikKcHJvY2Vzcy5jd2QgPSBmdW5jdGlvbiAoKSB7IHJldHVybiAnLycgfTsKcHJvY2Vzcy5jaGRpciA9IGZ1bmN0aW9uIChkaXIpIHsKICAgIHRocm93IG5ldyBFcnJvcigncHJvY2Vzcy5jaGRpciBpcyBub3Qgc3VwcG9ydGVkJyk7Cn07CnByb2Nlc3MudW1hc2sgPSBmdW5jdGlvbigpIHsgcmV0dXJuIDA7IH07Cgp9LHt9XSw5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKCi8qKgogKiBUaGlzIGlzIHRoZSB3ZWIgYnJvd3NlciBpbXBsZW1lbnRhdGlvbiBvZiBgZGVidWcoKWAuCiAqCiAqIEV4cG9zZSBgZGVidWcoKWAgYXMgdGhlIG1vZHVsZS4KICovCgpleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCcuL2RlYnVnJyk7CmV4cG9ydHMubG9nID0gbG9nOwpleHBvcnRzLmZvcm1hdEFyZ3MgPSBmb3JtYXRBcmdzOwpleHBvcnRzLnNhdmUgPSBzYXZlOwpleHBvcnRzLmxvYWQgPSBsb2FkOwpleHBvcnRzLnVzZUNvbG9ycyA9IHVzZUNvbG9yczsKZXhwb3J0cy5zdG9yYWdlID0gJ3VuZGVmaW5lZCcgIT0gdHlwZW9mIGNocm9tZQogICAgICAgICAgICAgICAmJiAndW5kZWZpbmVkJyAhPSB0eXBlb2YgY2hyb21lLnN0b3JhZ2UKICAgICAgICAgICAgICAgICAgPyBjaHJvbWUuc3RvcmFnZS5sb2NhbAogICAgICAgICAgICAgICAgICA6IGxvY2Fsc3RvcmFnZSgpOwoKLyoqCiAqIENvbG9ycy4KICovCgpleHBvcnRzLmNvbG9ycyA9IFsKICAnbGlnaHRzZWFncmVlbicsCiAgJ2ZvcmVzdGdyZWVuJywKICAnZ29sZGVucm9kJywKICAnZG9kZ2VyYmx1ZScsCiAgJ2RhcmtvcmNoaWQnLAogICdjcmltc29uJwpdOwoKLyoqCiAqIEN1cnJlbnRseSBvbmx5IFdlYktpdC1iYXNlZCBXZWIgSW5zcGVjdG9ycywgRmlyZWZveCA+PSB2MzEsCiAqIGFuZCB0aGUgRmlyZWJ1ZyBleHRlbnNpb24gKGFueSBGaXJlZm94IHZlcnNpb24pIGFyZSBrbm93bgogKiB0byBzdXBwb3J0ICIlYyIgQ1NTIGN1c3RvbWl6YXRpb25zLgogKgogKiBUT0RPOiBhZGQgYSBgbG9jYWxTdG9yYWdlYCB2YXJpYWJsZSB0byBleHBsaWNpdGx5IGVuYWJsZS9kaXNhYmxlIGNvbG9ycwogKi8KCmZ1bmN0aW9uIHVzZUNvbG9ycygpIHsKICAvLyBpcyB3ZWJraXQ/IGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzE2NDU5NjA2LzM3Njc3MwogIHJldHVybiAoJ1dlYmtpdEFwcGVhcmFuY2UnIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZSkgfHwKICAgIC8vIGlzIGZpcmVidWc/IGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzM5ODEyMC8zNzY3NzMKICAgICh3aW5kb3cuY29uc29sZSAmJiAoY29uc29sZS5maXJlYnVnIHx8IChjb25zb2xlLmV4Y2VwdGlvbiAmJiBjb25zb2xlLnRhYmxlKSkpIHx8CiAgICAvLyBpcyBmaXJlZm94ID49IHYzMT8KICAgIC8vIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvVG9vbHMvV2ViX0NvbnNvbGUjU3R5bGluZ19tZXNzYWdlcwogICAgKG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5tYXRjaCgvZmlyZWZveFwvKFxkKykvKSAmJiBwYXJzZUludChSZWdFeHAuJDEsIDEwKSA+PSAzMSk7Cn0KCi8qKgogKiBNYXAgJWogdG8gYEpTT04uc3RyaW5naWZ5KClgLCBzaW5jZSBubyBXZWIgSW5zcGVjdG9ycyBkbyB0aGF0IGJ5IGRlZmF1bHQuCiAqLwoKZXhwb3J0cy5mb3JtYXR0ZXJzLmogPSBmdW5jdGlvbih2KSB7CiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHYpOwp9OwoKCi8qKgogKiBDb2xvcml6ZSBsb2cgYXJndW1lbnRzIGlmIGVuYWJsZWQuCiAqCiAqIEBhcGkgcHVibGljCiAqLwoKZnVuY3Rpb24gZm9ybWF0QXJncygpIHsKICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICB2YXIgdXNlQ29sb3JzID0gdGhpcy51c2VDb2xvcnM7CgogIGFyZ3NbMF0gPSAodXNlQ29sb3JzID8gJyVjJyA6ICcnKQogICAgKyB0aGlzLm5hbWVzcGFjZQogICAgKyAodXNlQ29sb3JzID8gJyAlYycgOiAnICcpCiAgICArIGFyZ3NbMF0KICAgICsgKHVzZUNvbG9ycyA/ICclYyAnIDogJyAnKQogICAgKyAnKycgKyBleHBvcnRzLmh1bWFuaXplKHRoaXMuZGlmZik7CgogIGlmICghdXNlQ29sb3JzKSByZXR1cm4gYXJnczsKCiAgdmFyIGMgPSAnY29sb3I6ICcgKyB0aGlzLmNvbG9yOwogIGFyZ3MgPSBbYXJnc1swXSwgYywgJ2NvbG9yOiBpbmhlcml0J10uY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3MsIDEpKTsKCiAgLy8gdGhlIGZpbmFsICIlYyIgaXMgc29tZXdoYXQgdHJpY2t5LCBiZWNhdXNlIHRoZXJlIGNvdWxkIGJlIG90aGVyCiAgLy8gYXJndW1lbnRzIHBhc3NlZCBlaXRoZXIgYmVmb3JlIG9yIGFmdGVyIHRoZSAlYywgc28gd2UgbmVlZCB0bwogIC8vIGZpZ3VyZSBvdXQgdGhlIGNvcnJlY3QgaW5kZXggdG8gaW5zZXJ0IHRoZSBDU1MgaW50bwogIHZhciBpbmRleCA9IDA7CiAgdmFyIGxhc3RDID0gMDsKICBhcmdzWzBdLnJlcGxhY2UoLyVbYS16JV0vZywgZnVuY3Rpb24obWF0Y2gpIHsKICAgIGlmICgnJSUnID09PSBtYXRjaCkgcmV0dXJuOwogICAgaW5kZXgrKzsKICAgIGlmICgnJWMnID09PSBtYXRjaCkgewogICAgICAvLyB3ZSBvbmx5IGFyZSBpbnRlcmVzdGVkIGluIHRoZSAqbGFzdCogJWMKICAgICAgLy8gKHRoZSB1c2VyIG1heSBoYXZlIHByb3ZpZGVkIHRoZWlyIG93bikKICAgICAgbGFzdEMgPSBpbmRleDsKICAgIH0KICB9KTsKCiAgYXJncy5zcGxpY2UobGFzdEMsIDAsIGMpOwogIHJldHVybiBhcmdzOwp9CgovKioKICogSW52b2tlcyBgY29uc29sZS5sb2coKWAgd2hlbiBhdmFpbGFibGUuCiAqIE5vLW9wIHdoZW4gYGNvbnNvbGUubG9nYCBpcyBub3QgYSAiZnVuY3Rpb24iLgogKgogKiBAYXBpIHB1YmxpYwogKi8KCmZ1bmN0aW9uIGxvZygpIHsKICAvLyB0aGlzIGhhY2tlcnkgaXMgcmVxdWlyZWQgZm9yIElFOC85LCB3aGVyZQogIC8vIHRoZSBgY29uc29sZS5sb2dgIGZ1bmN0aW9uIGRvZXNuJ3QgaGF2ZSAnYXBwbHknCiAgcmV0dXJuICdvYmplY3QnID09PSB0eXBlb2YgY29uc29sZQogICAgJiYgY29uc29sZS5sb2cKICAgICYmIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGUubG9nLCBjb25zb2xlLCBhcmd1bWVudHMpOwp9CgovKioKICogU2F2ZSBgbmFtZXNwYWNlc2AuCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lc3BhY2VzCiAqIEBhcGkgcHJpdmF0ZQogKi8KCmZ1bmN0aW9uIHNhdmUobmFtZXNwYWNlcykgewogIHRyeSB7CiAgICBpZiAobnVsbCA9PSBuYW1lc3BhY2VzKSB7CiAgICAgIGV4cG9ydHMuc3RvcmFnZS5yZW1vdmVJdGVtKCdkZWJ1ZycpOwogICAgfSBlbHNlIHsKICAgICAgZXhwb3J0cy5zdG9yYWdlLmRlYnVnID0gbmFtZXNwYWNlczsKICAgIH0KICB9IGNhdGNoKGUpIHt9Cn0KCi8qKgogKiBMb2FkIGBuYW1lc3BhY2VzYC4KICoKICogQHJldHVybiB7U3RyaW5nfSByZXR1cm5zIHRoZSBwcmV2aW91c2x5IHBlcnNpc3RlZCBkZWJ1ZyBtb2RlcwogKiBAYXBpIHByaXZhdGUKICovCgpmdW5jdGlvbiBsb2FkKCkgewogIHZhciByOwogIHRyeSB7CiAgICByID0gZXhwb3J0cy5zdG9yYWdlLmRlYnVnOwogIH0gY2F0Y2goZSkge30KICByZXR1cm4gcjsKfQoKLyoqCiAqIEVuYWJsZSBuYW1lc3BhY2VzIGxpc3RlZCBpbiBgbG9jYWxTdG9yYWdlLmRlYnVnYCBpbml0aWFsbHkuCiAqLwoKZXhwb3J0cy5lbmFibGUobG9hZCgpKTsKCi8qKgogKiBMb2NhbHN0b3JhZ2UgYXR0ZW1wdHMgdG8gcmV0dXJuIHRoZSBsb2NhbHN0b3JhZ2UuCiAqCiAqIFRoaXMgaXMgbmVjZXNzYXJ5IGJlY2F1c2Ugc2FmYXJpIHRocm93cwogKiB3aGVuIGEgdXNlciBkaXNhYmxlcyBjb29raWVzL2xvY2Fsc3RvcmFnZQogKiBhbmQgeW91IGF0dGVtcHQgdG8gYWNjZXNzIGl0LgogKgogKiBAcmV0dXJuIHtMb2NhbFN0b3JhZ2V9CiAqIEBhcGkgcHJpdmF0ZQogKi8KCmZ1bmN0aW9uIGxvY2Fsc3RvcmFnZSgpewogIHRyeSB7CiAgICByZXR1cm4gd2luZG93LmxvY2FsU3RvcmFnZTsKICB9IGNhdGNoIChlKSB7fQp9Cgp9LHsiLi9kZWJ1ZyI6MTB9XSwxMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CgovKioKICogVGhpcyBpcyB0aGUgY29tbW9uIGxvZ2ljIGZvciBib3RoIHRoZSBOb2RlLmpzIGFuZCB3ZWIgYnJvd3NlcgogKiBpbXBsZW1lbnRhdGlvbnMgb2YgYGRlYnVnKClgLgogKgogKiBFeHBvc2UgYGRlYnVnKClgIGFzIHRoZSBtb2R1bGUuCiAqLwoKZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gZGVidWc7CmV4cG9ydHMuY29lcmNlID0gY29lcmNlOwpleHBvcnRzLmRpc2FibGUgPSBkaXNhYmxlOwpleHBvcnRzLmVuYWJsZSA9IGVuYWJsZTsKZXhwb3J0cy5lbmFibGVkID0gZW5hYmxlZDsKZXhwb3J0cy5odW1hbml6ZSA9IHJlcXVpcmUoJ21zJyk7CgovKioKICogVGhlIGN1cnJlbnRseSBhY3RpdmUgZGVidWcgbW9kZSBuYW1lcywgYW5kIG5hbWVzIHRvIHNraXAuCiAqLwoKZXhwb3J0cy5uYW1lcyA9IFtdOwpleHBvcnRzLnNraXBzID0gW107CgovKioKICogTWFwIG9mIHNwZWNpYWwgIiVuIiBoYW5kbGluZyBmdW5jdGlvbnMsIGZvciB0aGUgZGVidWcgImZvcm1hdCIgYXJndW1lbnQuCiAqCiAqIFZhbGlkIGtleSBuYW1lcyBhcmUgYSBzaW5nbGUsIGxvd2VyY2FzZWQgbGV0dGVyLCBpLmUuICJuIi4KICovCgpleHBvcnRzLmZvcm1hdHRlcnMgPSB7fTsKCi8qKgogKiBQcmV2aW91c2x5IGFzc2lnbmVkIGNvbG9yLgogKi8KCnZhciBwcmV2Q29sb3IgPSAwOwoKLyoqCiAqIFByZXZpb3VzIGxvZyB0aW1lc3RhbXAuCiAqLwoKdmFyIHByZXZUaW1lOwoKLyoqCiAqIFNlbGVjdCBhIGNvbG9yLgogKgogKiBAcmV0dXJuIHtOdW1iZXJ9CiAqIEBhcGkgcHJpdmF0ZQogKi8KCmZ1bmN0aW9uIHNlbGVjdENvbG9yKCkgewogIHJldHVybiBleHBvcnRzLmNvbG9yc1twcmV2Q29sb3IrKyAlIGV4cG9ydHMuY29sb3JzLmxlbmd0aF07Cn0KCi8qKgogKiBDcmVhdGUgYSBkZWJ1Z2dlciB3aXRoIHRoZSBnaXZlbiBgbmFtZXNwYWNlYC4KICoKICogQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZQogKiBAcmV0dXJuIHtGdW5jdGlvbn0KICogQGFwaSBwdWJsaWMKICovCgpmdW5jdGlvbiBkZWJ1ZyhuYW1lc3BhY2UpIHsKCiAgLy8gZGVmaW5lIHRoZSBgZGlzYWJsZWRgIHZlcnNpb24KICBmdW5jdGlvbiBkaXNhYmxlZCgpIHsKICB9CiAgZGlzYWJsZWQuZW5hYmxlZCA9IGZhbHNlOwoKICAvLyBkZWZpbmUgdGhlIGBlbmFibGVkYCB2ZXJzaW9uCiAgZnVuY3Rpb24gZW5hYmxlZCgpIHsKCiAgICB2YXIgc2VsZiA9IGVuYWJsZWQ7CgogICAgLy8gc2V0IGBkaWZmYCB0aW1lc3RhbXAKICAgIHZhciBjdXJyID0gK25ldyBEYXRlKCk7CiAgICB2YXIgbXMgPSBjdXJyIC0gKHByZXZUaW1lIHx8IGN1cnIpOwogICAgc2VsZi5kaWZmID0gbXM7CiAgICBzZWxmLnByZXYgPSBwcmV2VGltZTsKICAgIHNlbGYuY3VyciA9IGN1cnI7CiAgICBwcmV2VGltZSA9IGN1cnI7CgogICAgLy8gYWRkIHRoZSBgY29sb3JgIGlmIG5vdCBzZXQKICAgIGlmIChudWxsID09IHNlbGYudXNlQ29sb3JzKSBzZWxmLnVzZUNvbG9ycyA9IGV4cG9ydHMudXNlQ29sb3JzKCk7CiAgICBpZiAobnVsbCA9PSBzZWxmLmNvbG9yICYmIHNlbGYudXNlQ29sb3JzKSBzZWxmLmNvbG9yID0gc2VsZWN0Q29sb3IoKTsKCiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CgogICAgYXJnc1swXSA9IGV4cG9ydHMuY29lcmNlKGFyZ3NbMF0pOwoKICAgIGlmICgnc3RyaW5nJyAhPT0gdHlwZW9mIGFyZ3NbMF0pIHsKICAgICAgLy8gYW55dGhpbmcgZWxzZSBsZXQncyBpbnNwZWN0IHdpdGggJW8KICAgICAgYXJncyA9IFsnJW8nXS5jb25jYXQoYXJncyk7CiAgICB9CgogICAgLy8gYXBwbHkgYW55IGBmb3JtYXR0ZXJzYCB0cmFuc2Zvcm1hdGlvbnMKICAgIHZhciBpbmRleCA9IDA7CiAgICBhcmdzWzBdID0gYXJnc1swXS5yZXBsYWNlKC8lKFthLXolXSkvZywgZnVuY3Rpb24obWF0Y2gsIGZvcm1hdCkgewogICAgICAvLyBpZiB3ZSBlbmNvdW50ZXIgYW4gZXNjYXBlZCAlIHRoZW4gZG9uJ3QgaW5jcmVhc2UgdGhlIGFycmF5IGluZGV4CiAgICAgIGlmIChtYXRjaCA9PT0gJyUlJykgcmV0dXJuIG1hdGNoOwogICAgICBpbmRleCsrOwogICAgICB2YXIgZm9ybWF0dGVyID0gZXhwb3J0cy5mb3JtYXR0ZXJzW2Zvcm1hdF07CiAgICAgIGlmICgnZnVuY3Rpb24nID09PSB0eXBlb2YgZm9ybWF0dGVyKSB7CiAgICAgICAgdmFyIHZhbCA9IGFyZ3NbaW5kZXhdOwogICAgICAgIG1hdGNoID0gZm9ybWF0dGVyLmNhbGwoc2VsZiwgdmFsKTsKCiAgICAgICAgLy8gbm93IHdlIG5lZWQgdG8gcmVtb3ZlIGBhcmdzW2luZGV4XWAgc2luY2UgaXQncyBpbmxpbmVkIGluIHRoZSBgZm9ybWF0YAogICAgICAgIGFyZ3Muc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICBpbmRleC0tOwogICAgICB9CiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0pOwoKICAgIGlmICgnZnVuY3Rpb24nID09PSB0eXBlb2YgZXhwb3J0cy5mb3JtYXRBcmdzKSB7CiAgICAgIGFyZ3MgPSBleHBvcnRzLmZvcm1hdEFyZ3MuYXBwbHkoc2VsZiwgYXJncyk7CiAgICB9CiAgICB2YXIgbG9nRm4gPSBlbmFibGVkLmxvZyB8fCBleHBvcnRzLmxvZyB8fCBjb25zb2xlLmxvZy5iaW5kKGNvbnNvbGUpOwogICAgbG9nRm4uYXBwbHkoc2VsZiwgYXJncyk7CiAgfQogIGVuYWJsZWQuZW5hYmxlZCA9IHRydWU7CgogIHZhciBmbiA9IGV4cG9ydHMuZW5hYmxlZChuYW1lc3BhY2UpID8gZW5hYmxlZCA6IGRpc2FibGVkOwoKICBmbi5uYW1lc3BhY2UgPSBuYW1lc3BhY2U7CgogIHJldHVybiBmbjsKfQoKLyoqCiAqIEVuYWJsZXMgYSBkZWJ1ZyBtb2RlIGJ5IG5hbWVzcGFjZXMuIFRoaXMgY2FuIGluY2x1ZGUgbW9kZXMKICogc2VwYXJhdGVkIGJ5IGEgY29sb24gYW5kIHdpbGRjYXJkcy4KICoKICogQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZXMKICogQGFwaSBwdWJsaWMKICovCgpmdW5jdGlvbiBlbmFibGUobmFtZXNwYWNlcykgewogIGV4cG9ydHMuc2F2ZShuYW1lc3BhY2VzKTsKCiAgdmFyIHNwbGl0ID0gKG5hbWVzcGFjZXMgfHwgJycpLnNwbGl0KC9bXHMsXSsvKTsKICB2YXIgbGVuID0gc3BsaXQubGVuZ3RoOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICBpZiAoIXNwbGl0W2ldKSBjb250aW51ZTsgLy8gaWdub3JlIGVtcHR5IHN0cmluZ3MKICAgIG5hbWVzcGFjZXMgPSBzcGxpdFtpXS5yZXBsYWNlKC9cKi9nLCAnLio/Jyk7CiAgICBpZiAobmFtZXNwYWNlc1swXSA9PT0gJy0nKSB7CiAgICAgIGV4cG9ydHMuc2tpcHMucHVzaChuZXcgUmVnRXhwKCdeJyArIG5hbWVzcGFjZXMuc3Vic3RyKDEpICsgJyQnKSk7CiAgICB9IGVsc2UgewogICAgICBleHBvcnRzLm5hbWVzLnB1c2gobmV3IFJlZ0V4cCgnXicgKyBuYW1lc3BhY2VzICsgJyQnKSk7CiAgICB9CiAgfQp9CgovKioKICogRGlzYWJsZSBkZWJ1ZyBvdXRwdXQuCiAqCiAqIEBhcGkgcHVibGljCiAqLwoKZnVuY3Rpb24gZGlzYWJsZSgpIHsKICBleHBvcnRzLmVuYWJsZSgnJyk7Cn0KCi8qKgogKiBSZXR1cm5zIHRydWUgaWYgdGhlIGdpdmVuIG1vZGUgbmFtZSBpcyBlbmFibGVkLCBmYWxzZSBvdGhlcndpc2UuCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lCiAqIEByZXR1cm4ge0Jvb2xlYW59CiAqIEBhcGkgcHVibGljCiAqLwoKZnVuY3Rpb24gZW5hYmxlZChuYW1lKSB7CiAgdmFyIGksIGxlbjsKICBmb3IgKGkgPSAwLCBsZW4gPSBleHBvcnRzLnNraXBzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICBpZiAoZXhwb3J0cy5za2lwc1tpXS50ZXN0KG5hbWUpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgZm9yIChpID0gMCwgbGVuID0gZXhwb3J0cy5uYW1lcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgaWYgKGV4cG9ydHMubmFtZXNbaV0udGVzdChuYW1lKSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9CgovKioKICogQ29lcmNlIGB2YWxgLgogKgogKiBAcGFyYW0ge01peGVkfSB2YWwKICogQHJldHVybiB7TWl4ZWR9CiAqIEBhcGkgcHJpdmF0ZQogKi8KCmZ1bmN0aW9uIGNvZXJjZSh2YWwpIHsKICBpZiAodmFsIGluc3RhbmNlb2YgRXJyb3IpIHJldHVybiB2YWwuc3RhY2sgfHwgdmFsLm1lc3NhZ2U7CiAgcmV0dXJuIHZhbDsKfQoKfSx7Im1zIjoxMX1dLDExOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEhlbHBlcnMuCiAqLwoKdmFyIHMgPSAxMDAwOwp2YXIgbSA9IHMgKiA2MDsKdmFyIGggPSBtICogNjA7CnZhciBkID0gaCAqIDI0Owp2YXIgeSA9IGQgKiAzNjUuMjU7CgovKioKICogUGFyc2Ugb3IgZm9ybWF0IHRoZSBnaXZlbiBgdmFsYC4KICoKICogT3B0aW9uczoKICoKICogIC0gYGxvbmdgIHZlcmJvc2UgZm9ybWF0dGluZyBbZmFsc2VdCiAqCiAqIEBwYXJhbSB7U3RyaW5nfE51bWJlcn0gdmFsCiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAqIEByZXR1cm4ge1N0cmluZ3xOdW1iZXJ9CiAqIEBhcGkgcHVibGljCiAqLwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbih2YWwsIG9wdGlvbnMpewogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIGlmICgnc3RyaW5nJyA9PSB0eXBlb2YgdmFsKSByZXR1cm4gcGFyc2UodmFsKTsKICByZXR1cm4gb3B0aW9ucy5sb25nCiAgICA/IGxvbmcodmFsKQogICAgOiBzaG9ydCh2YWwpOwp9OwoKLyoqCiAqIFBhcnNlIHRoZSBnaXZlbiBgc3RyYCBhbmQgcmV0dXJuIG1pbGxpc2Vjb25kcy4KICoKICogQHBhcmFtIHtTdHJpbmd9IHN0cgogKiBAcmV0dXJuIHtOdW1iZXJ9CiAqIEBhcGkgcHJpdmF0ZQogKi8KCmZ1bmN0aW9uIHBhcnNlKHN0cikgewogIHN0ciA9ICcnICsgc3RyOwogIGlmIChzdHIubGVuZ3RoID4gMTAwMDApIHJldHVybjsKICB2YXIgbWF0Y2ggPSAvXigoPzpcZCspP1wuP1xkKykgKihtaWxsaXNlY29uZHM/fG1zZWNzP3xtc3xzZWNvbmRzP3xzZWNzP3xzfG1pbnV0ZXM/fG1pbnM/fG18aG91cnM/fGhycz98aHxkYXlzP3xkfHllYXJzP3x5cnM/fHkpPyQvaS5leGVjKHN0cik7CiAgaWYgKCFtYXRjaCkgcmV0dXJuOwogIHZhciBuID0gcGFyc2VGbG9hdChtYXRjaFsxXSk7CiAgdmFyIHR5cGUgPSAobWF0Y2hbMl0gfHwgJ21zJykudG9Mb3dlckNhc2UoKTsKICBzd2l0Y2ggKHR5cGUpIHsKICAgIGNhc2UgJ3llYXJzJzoKICAgIGNhc2UgJ3llYXInOgogICAgY2FzZSAneXJzJzoKICAgIGNhc2UgJ3lyJzoKICAgIGNhc2UgJ3knOgogICAgICByZXR1cm4gbiAqIHk7CiAgICBjYXNlICdkYXlzJzoKICAgIGNhc2UgJ2RheSc6CiAgICBjYXNlICdkJzoKICAgICAgcmV0dXJuIG4gKiBkOwogICAgY2FzZSAnaG91cnMnOgogICAgY2FzZSAnaG91cic6CiAgICBjYXNlICdocnMnOgogICAgY2FzZSAnaHInOgogICAgY2FzZSAnaCc6CiAgICAgIHJldHVybiBuICogaDsKICAgIGNhc2UgJ21pbnV0ZXMnOgogICAgY2FzZSAnbWludXRlJzoKICAgIGNhc2UgJ21pbnMnOgogICAgY2FzZSAnbWluJzoKICAgIGNhc2UgJ20nOgogICAgICByZXR1cm4gbiAqIG07CiAgICBjYXNlICdzZWNvbmRzJzoKICAgIGNhc2UgJ3NlY29uZCc6CiAgICBjYXNlICdzZWNzJzoKICAgIGNhc2UgJ3NlYyc6CiAgICBjYXNlICdzJzoKICAgICAgcmV0dXJuIG4gKiBzOwogICAgY2FzZSAnbWlsbGlzZWNvbmRzJzoKICAgIGNhc2UgJ21pbGxpc2Vjb25kJzoKICAgIGNhc2UgJ21zZWNzJzoKICAgIGNhc2UgJ21zZWMnOgogICAgY2FzZSAnbXMnOgogICAgICByZXR1cm4gbjsKICB9Cn0KCi8qKgogKiBTaG9ydCBmb3JtYXQgZm9yIGBtc2AuCiAqCiAqIEBwYXJhbSB7TnVtYmVyfSBtcwogKiBAcmV0dXJuIHtTdHJpbmd9CiAqIEBhcGkgcHJpdmF0ZQogKi8KCmZ1bmN0aW9uIHNob3J0KG1zKSB7CiAgaWYgKG1zID49IGQpIHJldHVybiBNYXRoLnJvdW5kKG1zIC8gZCkgKyAnZCc7CiAgaWYgKG1zID49IGgpIHJldHVybiBNYXRoLnJvdW5kKG1zIC8gaCkgKyAnaCc7CiAgaWYgKG1zID49IG0pIHJldHVybiBNYXRoLnJvdW5kKG1zIC8gbSkgKyAnbSc7CiAgaWYgKG1zID49IHMpIHJldHVybiBNYXRoLnJvdW5kKG1zIC8gcykgKyAncyc7CiAgcmV0dXJuIG1zICsgJ21zJzsKfQoKLyoqCiAqIExvbmcgZm9ybWF0IGZvciBgbXNgLgogKgogKiBAcGFyYW0ge051bWJlcn0gbXMKICogQHJldHVybiB7U3RyaW5nfQogKiBAYXBpIHByaXZhdGUKICovCgpmdW5jdGlvbiBsb25nKG1zKSB7CiAgcmV0dXJuIHBsdXJhbChtcywgZCwgJ2RheScpCiAgICB8fCBwbHVyYWwobXMsIGgsICdob3VyJykKICAgIHx8IHBsdXJhbChtcywgbSwgJ21pbnV0ZScpCiAgICB8fCBwbHVyYWwobXMsIHMsICdzZWNvbmQnKQogICAgfHwgbXMgKyAnIG1zJzsKfQoKLyoqCiAqIFBsdXJhbGl6YXRpb24gaGVscGVyLgogKi8KCmZ1bmN0aW9uIHBsdXJhbChtcywgbiwgbmFtZSkgewogIGlmIChtcyA8IG4pIHJldHVybjsKICBpZiAobXMgPCBuICogMS41KSByZXR1cm4gTWF0aC5mbG9vcihtcyAvIG4pICsgJyAnICsgbmFtZTsKICByZXR1cm4gTWF0aC5jZWlsKG1zIC8gbikgKyAnICcgKyBuYW1lICsgJ3MnOwp9Cgp9LHt9XSwxMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CmlmICh0eXBlb2YgT2JqZWN0LmNyZWF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogIC8vIGltcGxlbWVudGF0aW9uIGZyb20gc3RhbmRhcmQgbm9kZS5qcyAndXRpbCcgbW9kdWxlCiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpbmhlcml0cyhjdG9yLCBzdXBlckN0b3IpIHsKICAgIGN0b3Iuc3VwZXJfID0gc3VwZXJDdG9yCiAgICBjdG9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDdG9yLnByb3RvdHlwZSwgewogICAgICBjb25zdHJ1Y3RvcjogewogICAgICAgIHZhbHVlOiBjdG9yLAogICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICB9CiAgICB9KTsKICB9Owp9IGVsc2UgewogIC8vIG9sZCBzY2hvb2wgc2hpbSBmb3Igb2xkIGJyb3dzZXJzCiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpbmhlcml0cyhjdG9yLCBzdXBlckN0b3IpIHsKICAgIGN0b3Iuc3VwZXJfID0gc3VwZXJDdG9yCiAgICB2YXIgVGVtcEN0b3IgPSBmdW5jdGlvbiAoKSB7fQogICAgVGVtcEN0b3IucHJvdG90eXBlID0gc3VwZXJDdG9yLnByb3RvdHlwZQogICAgY3Rvci5wcm90b3R5cGUgPSBuZXcgVGVtcEN0b3IoKQogICAgY3Rvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjdG9yCiAgfQp9Cgp9LHt9XSwxMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIGFsbG93IGV4dGVybmFsIHBsdWdpbnMgdG8gcmVxdWlyZSgncG91Y2hkYi9leHRyYXMvcHJvbWlzZScpCm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi4vbGliL2RlcHMvcHJvbWlzZScpOwp9LHsiLi4vbGliL2RlcHMvcHJvbWlzZSI6Nzl9XSwxNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7CiJ1c2Ugc3RyaWN0IjsKCnZhciB1dGlscyA9IHJlcXVpcmUoJy4vdXRpbHMnKTsKdmFyIGVycm9ycyA9IHJlcXVpcmUoJy4vZGVwcy9lcnJvcnMnKTsKdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKdmFyIHVwc2VydCA9IHJlcXVpcmUoJy4vZGVwcy91cHNlcnQnKTsKdmFyIENoYW5nZXMgPSByZXF1aXJlKCcuL2NoYW5nZXMnKTsKdmFyIGJ1bGtHZXRTaGltID0gcmVxdWlyZSgnLi9kZXBzL2J1bGtHZXRTaGltJyk7CnZhciBQcm9taXNlID0gdXRpbHMuUHJvbWlzZTsKdmFyIGlzRGVsZXRlZCA9IHJlcXVpcmUoJy4vZGVwcy9kb2NzL2lzRGVsZXRlZCcpOwp2YXIgaXNMb2NhbElkID0gcmVxdWlyZSgnLi9kZXBzL2RvY3MvaXNMb2NhbElkJyk7CnZhciB0cmF2ZXJzZVJldlRyZWUgPSByZXF1aXJlKCcuL2RlcHMvbWVyZ2UvdHJhdmVyc2VSZXZUcmVlJyk7CnZhciBjb2xsZWN0TGVhdmVzID0gcmVxdWlyZSgnLi9kZXBzL21lcmdlL2NvbGxlY3RMZWF2ZXMnKTsKdmFyIHJvb3RUb0xlYWYgPSByZXF1aXJlKCcuL2RlcHMvbWVyZ2Uvcm9vdFRvTGVhZicpOwp2YXIgY29sbGVjdENvbmZsaWN0cyA9IHJlcXVpcmUoJy4vZGVwcy9tZXJnZS9jb2xsZWN0Q29uZmxpY3RzJyk7CgovKgogKiBBIGdlbmVyaWMgcG91Y2ggYWRhcHRlcgogKi8KCi8vIHJldHVybnMgZmlyc3QgZWxlbWVudCBvZiBhcnIgc2F0aXNmeWluZyBjYWxsYmFjayBwcmVkaWNhdGUKZnVuY3Rpb24gYXJyYXlGaXJzdChhcnIsIGNhbGxiYWNrKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgIGlmIChjYWxsYmFjayhhcnJbaV0sIGkpID09PSB0cnVlKSB7CiAgICAgIHJldHVybiBhcnJbaV07CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfQoKLy8gV3JhcHBlciBmb3IgZnVuY3Rpb25zIHRoYXQgY2FsbCB0aGUgYnVsa2RvY3MgYXBpIHdpdGggYSBzaW5nbGUgZG9jLAovLyBpZiB0aGUgZmlyc3QgcmVzdWx0IGlzIGFuIGVycm9yLCByZXR1cm4gYW4gZXJyb3IKZnVuY3Rpb24geWFua0Vycm9yKGNhbGxiYWNrKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIChlcnIsIHJlc3VsdHMpIHsKICAgIGlmIChlcnIgfHwgKHJlc3VsdHNbMF0gJiYgcmVzdWx0c1swXS5lcnJvcikpIHsKICAgICAgY2FsbGJhY2soZXJyIHx8IHJlc3VsdHNbMF0pOwogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sobnVsbCwgcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdICA6IHJlc3VsdHMpOwogICAgfQogIH07Cn0KCi8vIGNsZWFuIGRvY3MgZ2l2ZW4gdG8gdXMgYnkgdGhlIHVzZXIKZnVuY3Rpb24gY2xlYW5Eb2NzKGRvY3MpIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IGRvY3MubGVuZ3RoOyBpKyspIHsKICAgIHZhciBkb2MgPSBkb2NzW2ldOwogICAgaWYgKGRvYy5fZGVsZXRlZCkgewogICAgICBkZWxldGUgZG9jLl9hdHRhY2htZW50czsgLy8gaWdub3JlIGF0dHMgZm9yIGRlbGV0ZWQgZG9jcwogICAgfSBlbHNlIGlmIChkb2MuX2F0dGFjaG1lbnRzKSB7CiAgICAgIC8vIGZpbHRlciBvdXQgZXh0cmFuZW91cyBrZXlzIGZyb20gX2F0dGFjaG1lbnRzCiAgICAgIHZhciBhdHRzID0gT2JqZWN0LmtleXMoZG9jLl9hdHRhY2htZW50cyk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYXR0cy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBhdHQgPSBhdHRzW2pdOwogICAgICAgIGRvYy5fYXR0YWNobWVudHNbYXR0XSA9IHV0aWxzLnBpY2soZG9jLl9hdHRhY2htZW50c1thdHRdLAogICAgICAgICAgWydkYXRhJywgJ2RpZ2VzdCcsICdjb250ZW50X3R5cGUnLCAnbGVuZ3RoJywgJ3JldnBvcycsICdzdHViJ10pOwogICAgICB9CiAgICB9CiAgfQp9CgovLyBjb21wYXJlIHR3byBkb2NzLCBmaXJzdCBieSBfaWQgdGhlbiBieSBfcmV2CmZ1bmN0aW9uIGNvbXBhcmVCeUlkVGhlblJldihhLCBiKSB7CiAgdmFyIGlkQ29tcGFyZSA9IHV0aWxzLmNvbXBhcmUoYS5faWQsIGIuX2lkKTsKICBpZiAoaWRDb21wYXJlICE9PSAwKSB7CiAgICByZXR1cm4gaWRDb21wYXJlOwogIH0KICB2YXIgYVN0YXJ0ID0gYS5fcmV2aXNpb25zID8gYS5fcmV2aXNpb25zLnN0YXJ0IDogMDsKICB2YXIgYlN0YXJ0ID0gYi5fcmV2aXNpb25zID8gYi5fcmV2aXNpb25zLnN0YXJ0IDogMDsKICByZXR1cm4gdXRpbHMuY29tcGFyZShhU3RhcnQsIGJTdGFydCk7Cn0KCi8vIGZvciBldmVyeSBub2RlIGluIGEgcmV2aXNpb24gdHJlZSBjb21wdXRlcyBpdHMgZGlzdGFuY2UgZnJvbSB0aGUgY2xvc2VzdAovLyBsZWFmCmZ1bmN0aW9uIGNvbXB1dGVIZWlnaHQocmV2cykgewogIHZhciBoZWlnaHQgPSB7fTsKICB2YXIgZWRnZXMgPSBbXTsKICB0cmF2ZXJzZVJldlRyZWUocmV2cywgZnVuY3Rpb24gKGlzTGVhZiwgcG9zLCBpZCwgcHJudCkgewogICAgdmFyIHJldiA9IHBvcyArICItIiArIGlkOwogICAgaWYgKGlzTGVhZikgewogICAgICBoZWlnaHRbcmV2XSA9IDA7CiAgICB9CiAgICBpZiAocHJudCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGVkZ2VzLnB1c2goe2Zyb206IHBybnQsIHRvOiByZXZ9KTsKICAgIH0KICAgIHJldHVybiByZXY7CiAgfSk7CgogIGVkZ2VzLnJldmVyc2UoKTsKICBlZGdlcy5mb3JFYWNoKGZ1bmN0aW9uIChlZGdlKSB7CiAgICBpZiAoaGVpZ2h0W2VkZ2UuZnJvbV0gPT09IHVuZGVmaW5lZCkgewogICAgICBoZWlnaHRbZWRnZS5mcm9tXSA9IDEgKyBoZWlnaHRbZWRnZS50b107CiAgICB9IGVsc2UgewogICAgICBoZWlnaHRbZWRnZS5mcm9tXSA9IE1hdGgubWluKGhlaWdodFtlZGdlLmZyb21dLCAxICsgaGVpZ2h0W2VkZ2UudG9dKTsKICAgIH0KICB9KTsKICByZXR1cm4gaGVpZ2h0Owp9CgpmdW5jdGlvbiBhbGxEb2NzS2V5c1F1ZXJ5KGFwaSwgb3B0cywgY2FsbGJhY2spIHsKICB2YXIga2V5cyA9ICAoJ2xpbWl0JyBpbiBvcHRzKSA/CiAgICAgIG9wdHMua2V5cy5zbGljZShvcHRzLnNraXAsIG9wdHMubGltaXQgKyBvcHRzLnNraXApIDoKICAgICAgKG9wdHMuc2tpcCA+IDApID8gb3B0cy5rZXlzLnNsaWNlKG9wdHMuc2tpcCkgOiBvcHRzLmtleXM7CiAgaWYgKG9wdHMuZGVzY2VuZGluZykgewogICAga2V5cy5yZXZlcnNlKCk7CiAgfQogIGlmICgha2V5cy5sZW5ndGgpIHsKICAgIHJldHVybiBhcGkuX2FsbERvY3Moe2xpbWl0OiAwfSwgY2FsbGJhY2spOwogIH0KICB2YXIgZmluYWxSZXN1bHRzID0gewogICAgb2Zmc2V0OiBvcHRzLnNraXAKICB9OwogIHJldHVybiBQcm9taXNlLmFsbChrZXlzLm1hcChmdW5jdGlvbiAoa2V5KSB7CiAgICB2YXIgc3ViT3B0cyA9IHV0aWxzLmV4dGVuZCh7a2V5OiBrZXksIGRlbGV0ZWQ6ICdvayd9LCBvcHRzKTsKICAgIFsnbGltaXQnLCAnc2tpcCcsICdrZXlzJ10uZm9yRWFjaChmdW5jdGlvbiAob3B0S2V5KSB7CiAgICAgIGRlbGV0ZSBzdWJPcHRzW29wdEtleV07CiAgICB9KTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGFwaS5fYWxsRG9jcyhzdWJPcHRzLCBmdW5jdGlvbiAoZXJyLCByZXMpIHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7CiAgICAgICAgfQogICAgICAgIGZpbmFsUmVzdWx0cy50b3RhbF9yb3dzID0gcmVzLnRvdGFsX3Jvd3M7CiAgICAgICAgcmVzb2x2ZShyZXMucm93c1swXSB8fCB7a2V5OiBrZXksIGVycm9yOiAnbm90X2ZvdW5kJ30pOwogICAgICB9KTsKICAgIH0pOwogIH0pKS50aGVuKGZ1bmN0aW9uIChyZXN1bHRzKSB7CiAgICBmaW5hbFJlc3VsdHMucm93cyA9IHJlc3VsdHM7CiAgICByZXR1cm4gZmluYWxSZXN1bHRzOwogIH0pOwp9CgovLyBhbGwgY29tcGFjdGlvbiBpcyBkb25lIGluIGEgcXVldWUsIHRvIGF2b2lkIGF0dGFjaGluZwovLyB0b28gbWFueSBsaXN0ZW5lcnMgYXQgb25jZQpmdW5jdGlvbiBkb05leHRDb21wYWN0aW9uKHNlbGYpIHsKICB2YXIgdGFzayA9IHNlbGYuX2NvbXBhY3Rpb25RdWV1ZVswXTsKICB2YXIgb3B0cyA9IHRhc2sub3B0czsKICB2YXIgY2FsbGJhY2sgPSB0YXNrLmNhbGxiYWNrOwogIHNlbGYuZ2V0KCdfbG9jYWwvY29tcGFjdGlvbicpLmNhdGNoKGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBmYWxzZTsKICB9KS50aGVuKGZ1bmN0aW9uIChkb2MpIHsKICAgIGlmIChkb2MgJiYgZG9jLmxhc3Rfc2VxKSB7CiAgICAgIG9wdHMubGFzdF9zZXEgPSBkb2MubGFzdF9zZXE7CiAgICB9CiAgICBzZWxmLl9jb21wYWN0KG9wdHMsIGZ1bmN0aW9uIChlcnIsIHJlcykgewogICAgICBpZiAoZXJyKSB7CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjayhudWxsLCByZXMpOwogICAgICB9CiAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgIHNlbGYuX2NvbXBhY3Rpb25RdWV1ZS5zaGlmdCgpOwogICAgICAgIGlmIChzZWxmLl9jb21wYWN0aW9uUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICBkb05leHRDb21wYWN0aW9uKHNlbGYpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9KTsKfQoKZnVuY3Rpb24gYXR0YWNobWVudE5hbWVFcnJvcihuYW1lKSB7CiAgaWYgKG5hbWUuY2hhckF0KDApID09PSAnXycpIHsKICAgIHJldHVybiBuYW1lICsgJ2lzIG5vdCBhIHZhbGlkIGF0dGFjaG1lbnQgbmFtZSwgYXR0YWNobWVudCAnICsKICAgICAgJ25hbWVzIGNhbm5vdCBzdGFydCB3aXRoIFwnX1wnJzsKICB9CiAgcmV0dXJuIGZhbHNlOwp9Cgp1dGlscy5pbmhlcml0cyhBYnN0cmFjdFBvdWNoREIsIEV2ZW50RW1pdHRlcik7Cm1vZHVsZS5leHBvcnRzID0gQWJzdHJhY3RQb3VjaERCOwoKZnVuY3Rpb24gQWJzdHJhY3RQb3VjaERCKCkgewogIEV2ZW50RW1pdHRlci5jYWxsKHRoaXMpOwp9CgpBYnN0cmFjdFBvdWNoREIucHJvdG90eXBlLnBvc3QgPQogIHV0aWxzLmFkYXB0ZXJGdW4oJ3Bvc3QnLCBmdW5jdGlvbiAoZG9jLCBvcHRzLCBjYWxsYmFjaykgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2FsbGJhY2sgPSBvcHRzOwogICAgb3B0cyA9IHt9OwogIH0KICBpZiAodHlwZW9mIGRvYyAhPT0gJ29iamVjdCcgfHwgQXJyYXkuaXNBcnJheShkb2MpKSB7CiAgICByZXR1cm4gY2FsbGJhY2soZXJyb3JzLmVycm9yKGVycm9ycy5OT1RfQU5fT0JKRUNUKSk7CiAgfQogIHRoaXMuYnVsa0RvY3Moe2RvY3M6IFtkb2NdfSwgb3B0cywgeWFua0Vycm9yKGNhbGxiYWNrKSk7Cn0pOwoKQWJzdHJhY3RQb3VjaERCLnByb3RvdHlwZS5wdXQgPQogIHV0aWxzLmFkYXB0ZXJGdW4oJ3B1dCcsIHV0aWxzLmdldEFyZ3VtZW50cyhmdW5jdGlvbiAoYXJncykgewogIHZhciB0ZW1wLCB0ZW1wdHlwZSwgb3B0cywgY2FsbGJhY2s7CiAgdmFyIGRvYyA9IGFyZ3Muc2hpZnQoKTsKICB2YXIgaWQgPSAnX2lkJyBpbiBkb2M7CiAgaWYgKHR5cGVvZiBkb2MgIT09ICdvYmplY3QnIHx8IEFycmF5LmlzQXJyYXkoZG9jKSkgewogICAgY2FsbGJhY2sgPSBhcmdzLnBvcCgpOwogICAgcmV0dXJuIGNhbGxiYWNrKGVycm9ycy5lcnJvcihlcnJvcnMuTk9UX0FOX09CSkVDVCkpOwogIH0KICB3aGlsZSAodHJ1ZSkgewogICAgdGVtcCA9IGFyZ3Muc2hpZnQoKTsKICAgIHRlbXB0eXBlID0gdHlwZW9mIHRlbXA7CiAgICBpZiAodGVtcHR5cGUgPT09ICJzdHJpbmciICYmICFpZCkgewogICAgICBkb2MuX2lkID0gdGVtcDsKICAgICAgaWQgPSB0cnVlOwogICAgfSBlbHNlIGlmICh0ZW1wdHlwZSA9PT0gInN0cmluZyIgJiYgaWQgJiYgISgnX3JldicgaW4gZG9jKSkgewogICAgICBkb2MuX3JldiA9IHRlbXA7CiAgICB9IGVsc2UgaWYgKHRlbXB0eXBlID09PSAib2JqZWN0IikgewogICAgICBvcHRzID0gdGVtcDsKICAgIH0gZWxzZSBpZiAodGVtcHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgY2FsbGJhY2sgPSB0ZW1wOwogICAgfQogICAgaWYgKCFhcmdzLmxlbmd0aCkgewogICAgICBicmVhazsKICAgIH0KICB9CiAgb3B0cyA9IG9wdHMgfHwge307CiAgdmFyIGVycm9yID0gdXRpbHMuaW52YWxpZElkRXJyb3IoZG9jLl9pZCk7CiAgaWYgKGVycm9yKSB7CiAgICByZXR1cm4gY2FsbGJhY2soZXJyb3IpOwogIH0KICBpZiAoaXNMb2NhbElkKGRvYy5faWQpICYmIHR5cGVvZiB0aGlzLl9wdXRMb2NhbCA9PT0gJ2Z1bmN0aW9uJykgewogICAgaWYgKGRvYy5fZGVsZXRlZCkgewogICAgICByZXR1cm4gdGhpcy5fcmVtb3ZlTG9jYWwoZG9jLCBjYWxsYmFjayk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5fcHV0TG9jYWwoZG9jLCBjYWxsYmFjayk7CiAgICB9CiAgfQogIHRoaXMuYnVsa0RvY3Moe2RvY3M6IFtkb2NdfSwgb3B0cywgeWFua0Vycm9yKGNhbGxiYWNrKSk7Cn0pKTsKCkFic3RyYWN0UG91Y2hEQi5wcm90b3R5cGUucHV0QXR0YWNobWVudCA9CiAgdXRpbHMuYWRhcHRlckZ1bigncHV0QXR0YWNobWVudCcsIGZ1bmN0aW9uIChkb2NJZCwgYXR0YWNobWVudElkLCByZXYsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9iLCB0eXBlLCBjYWxsYmFjaykgewogIHZhciBhcGkgPSB0aGlzOwogIGlmICh0eXBlb2YgdHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2FsbGJhY2sgPSB0eXBlOwogICAgdHlwZSA9IGJsb2I7CiAgICBibG9iID0gcmV2OwogICAgcmV2ID0gbnVsbDsKICB9CiAgaWYgKHR5cGVvZiB0eXBlID09PSAndW5kZWZpbmVkJykgewogICAgdHlwZSA9IGJsb2I7CiAgICBibG9iID0gcmV2OwogICAgcmV2ID0gbnVsbDsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUF0dGFjaG1lbnQoZG9jKSB7CiAgICBkb2MuX2F0dGFjaG1lbnRzID0gZG9jLl9hdHRhY2htZW50cyB8fCB7fTsKICAgIGRvYy5fYXR0YWNobWVudHNbYXR0YWNobWVudElkXSA9IHsKICAgICAgY29udGVudF90eXBlOiB0eXBlLAogICAgICBkYXRhOiBibG9iCiAgICB9OwogICAgcmV0dXJuIGFwaS5wdXQoZG9jKTsKICB9CgogIHJldHVybiBhcGkuZ2V0KGRvY0lkKS50aGVuKGZ1bmN0aW9uIChkb2MpIHsKICAgIGlmIChkb2MuX3JldiAhPT0gcmV2KSB7CiAgICAgIHRocm93IGVycm9ycy5lcnJvcihlcnJvcnMuUkVWX0NPTkZMSUNUKTsKICAgIH0KCiAgICByZXR1cm4gY3JlYXRlQXR0YWNobWVudChkb2MpOwogIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAvLyBjcmVhdGUgbmV3IGRvYwogICAgaWYgKGVyci5yZWFzb24gPT09IGVycm9ycy5NSVNTSU5HX0RPQy5tZXNzYWdlKSB7CiAgICAgIHJldHVybiBjcmVhdGVBdHRhY2htZW50KHtfaWQ6IGRvY0lkfSk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBlcnI7CiAgICB9CiAgfSk7Cn0pOwoKQWJzdHJhY3RQb3VjaERCLnByb3RvdHlwZS5yZW1vdmVBdHRhY2htZW50ID0KICB1dGlscy5hZGFwdGVyRnVuKCdyZW1vdmVBdHRhY2htZW50JywgZnVuY3Rpb24gKGRvY0lkLCBhdHRhY2htZW50SWQsIHJldiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHNlbGYuZ2V0KGRvY0lkLCBmdW5jdGlvbiAoZXJyLCBvYmopIHsKICAgIGlmIChlcnIpIHsKICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKG9iai5fcmV2ICE9PSByZXYpIHsKICAgICAgY2FsbGJhY2soZXJyb3JzLmVycm9yKGVycm9ycy5SRVZfQ09ORkxJQ1QpKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCFvYmouX2F0dGFjaG1lbnRzKSB7CiAgICAgIHJldHVybiBjYWxsYmFjaygpOwogICAgfQogICAgZGVsZXRlIG9iai5fYXR0YWNobWVudHNbYXR0YWNobWVudElkXTsKICAgIGlmIChPYmplY3Qua2V5cyhvYmouX2F0dGFjaG1lbnRzKS5sZW5ndGggPT09IDApIHsKICAgICAgZGVsZXRlIG9iai5fYXR0YWNobWVudHM7CiAgICB9CiAgICBzZWxmLnB1dChvYmosIGNhbGxiYWNrKTsKICB9KTsKfSk7CgpBYnN0cmFjdFBvdWNoREIucHJvdG90eXBlLnJlbW92ZSA9CiAgdXRpbHMuYWRhcHRlckZ1bigncmVtb3ZlJywgZnVuY3Rpb24gKGRvY09ySWQsIG9wdHNPclJldiwgb3B0cywgY2FsbGJhY2spIHsKICB2YXIgZG9jOwogIGlmICh0eXBlb2Ygb3B0c09yUmV2ID09PSAnc3RyaW5nJykgewogICAgLy8gaWQsIHJldiwgb3B0cywgY2FsbGJhY2sgc3R5bGUKICAgIGRvYyA9IHsKICAgICAgX2lkOiBkb2NPcklkLAogICAgICBfcmV2OiBvcHRzT3JSZXYKICAgIH07CiAgICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2FsbGJhY2sgPSBvcHRzOwogICAgICBvcHRzID0ge307CiAgICB9CiAgfSBlbHNlIHsKICAgIC8vIGRvYywgb3B0cywgY2FsbGJhY2sgc3R5bGUKICAgIGRvYyA9IGRvY09ySWQ7CiAgICBpZiAodHlwZW9mIG9wdHNPclJldiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYWxsYmFjayA9IG9wdHNPclJldjsKICAgICAgb3B0cyA9IHt9OwogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sgPSBvcHRzOwogICAgICBvcHRzID0gb3B0c09yUmV2OwogICAgfQogIH0KICBvcHRzID0gb3B0cyB8fCB7fTsKICBvcHRzLndhc19kZWxldGUgPSB0cnVlOwogIHZhciBuZXdEb2MgPSB7X2lkOiBkb2MuX2lkLCBfcmV2OiAoZG9jLl9yZXYgfHwgb3B0cy5yZXYpfTsKICBuZXdEb2MuX2RlbGV0ZWQgPSB0cnVlOwogIGlmIChpc0xvY2FsSWQobmV3RG9jLl9pZCkgJiYgdHlwZW9mIHRoaXMuX3JlbW92ZUxvY2FsID09PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm4gdGhpcy5fcmVtb3ZlTG9jYWwoZG9jLCBjYWxsYmFjayk7CiAgfQogIHRoaXMuYnVsa0RvY3Moe2RvY3M6IFtuZXdEb2NdfSwgb3B0cywgeWFua0Vycm9yKGNhbGxiYWNrKSk7Cn0pOwoKQWJzdHJhY3RQb3VjaERCLnByb3RvdHlwZS5yZXZzRGlmZiA9CiAgdXRpbHMuYWRhcHRlckZ1bigncmV2c0RpZmYnLCBmdW5jdGlvbiAocmVxLCBvcHRzLCBjYWxsYmFjaykgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2FsbGJhY2sgPSBvcHRzOwogICAgb3B0cyA9IHt9OwogIH0KICB2YXIgaWRzID0gT2JqZWN0LmtleXMocmVxKTsKCiAgaWYgKCFpZHMubGVuZ3RoKSB7CiAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwge30pOwogIH0KCiAgdmFyIGNvdW50ID0gMDsKICB2YXIgbWlzc2luZyA9IG5ldyB1dGlscy5NYXAoKTsKCiAgZnVuY3Rpb24gYWRkVG9NaXNzaW5nKGlkLCByZXZJZCkgewogICAgaWYgKCFtaXNzaW5nLmhhcyhpZCkpIHsKICAgICAgbWlzc2luZy5zZXQoaWQsIHttaXNzaW5nOiBbXX0pOwogICAgfQogICAgbWlzc2luZy5nZXQoaWQpLm1pc3NpbmcucHVzaChyZXZJZCk7CiAgfQoKICBmdW5jdGlvbiBwcm9jZXNzRG9jKGlkLCByZXZfdHJlZSkgewogICAgLy8gSXMgdGhpcyBmYXN0IGVub3VnaD8gTWF5YmUgd2Ugc2hvdWxkIHN3aXRjaCB0byBhIHNldCBzaW11bGF0ZWQgYnkgYSBtYXAKICAgIHZhciBtaXNzaW5nRm9ySWQgPSByZXFbaWRdLnNsaWNlKDApOwogICAgdHJhdmVyc2VSZXZUcmVlKHJldl90cmVlLCBmdW5jdGlvbiAoaXNMZWFmLCBwb3MsIHJldkhhc2gsIGN0eCwKICAgICAgb3B0cykgewogICAgICAgIHZhciByZXYgPSBwb3MgKyAnLScgKyByZXZIYXNoOwogICAgICAgIHZhciBpZHggPSBtaXNzaW5nRm9ySWQuaW5kZXhPZihyZXYpOwogICAgICAgIGlmIChpZHggPT09IC0xKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBtaXNzaW5nRm9ySWQuc3BsaWNlKGlkeCwgMSk7CiAgICAgICAgaWYgKG9wdHMuc3RhdHVzICE9PSAnYXZhaWxhYmxlJykgewogICAgICAgICAgYWRkVG9NaXNzaW5nKGlkLCByZXYpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgLy8gVHJhdmVyc2luZyB0aGUgdHJlZSBpcyBzeW5jaHJvbm91cywgc28gbm93IGBtaXNzaW5nRm9ySWRgIGNvbnRhaW5zCiAgICAvLyByZXZpc2lvbnMgdGhhdCB3ZXJlIG5vdCBmb3VuZCBpbiB0aGUgdHJlZQogICAgbWlzc2luZ0ZvcklkLmZvckVhY2goZnVuY3Rpb24gKHJldikgewogICAgICBhZGRUb01pc3NpbmcoaWQsIHJldik7CiAgICB9KTsKICB9CgogIGlkcy5tYXAoZnVuY3Rpb24gKGlkKSB7CiAgICB0aGlzLl9nZXRSZXZpc2lvblRyZWUoaWQsIGZ1bmN0aW9uIChlcnIsIHJldl90cmVlKSB7CiAgICAgIGlmIChlcnIgJiYgZXJyLnN0YXR1cyA9PT0gNDA0ICYmIGVyci5tZXNzYWdlID09PSAnbWlzc2luZycpIHsKICAgICAgICBtaXNzaW5nLnNldChpZCwge21pc3Npbmc6IHJlcVtpZF19KTsKICAgICAgfSBlbHNlIGlmIChlcnIpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBwcm9jZXNzRG9jKGlkLCByZXZfdHJlZSk7CiAgICAgIH0KCiAgICAgIGlmICgrK2NvdW50ID09PSBpZHMubGVuZ3RoKSB7CiAgICAgICAgLy8gY29udmVydCBMYXp5TWFwIHRvIG9iamVjdAogICAgICAgIHZhciBtaXNzaW5nT2JqID0ge307CiAgICAgICAgbWlzc2luZy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICBtaXNzaW5nT2JqW2tleV0gPSB2YWx1ZTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgbWlzc2luZ09iaik7CiAgICAgIH0KICAgIH0pOwogIH0sIHRoaXMpOwp9KTsKCi8vIF9idWxrX2dldCBBUEkgZm9yIGZhc3RlciByZXBsaWNhdGlvbiwgYXMgZGVzY3JpYmVkIGluCi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hcGFjaGUvY291Y2hkYi1jaHR0cGQvcHVsbC8zMwovLyBBdCB0aGUgImFic3RyYWN0IiBsZXZlbCwgaXQgd2lsbCBqdXN0IHJ1biBtdWx0aXBsZSBnZXQoKXMgaW4KLy8gcGFyYWxsZWwsIGJlY2F1c2UgdGhpcyBpc24ndCBtdWNoIG9mIGEgcGVyZm9ybWFuY2UgY29zdAovLyBmb3IgbG9jYWwgZGF0YWJhc2VzIChleGNlcHQgdGhlIGNvc3Qgb2YgbXVsdGlwbGUgdHJhbnNhY3Rpb25zLCB3aGljaCBpcwovLyBzbWFsbCkuIFRoZSBodHRwIGFkYXB0ZXIgb3ZlcnJpZGVzIHRoaXMgaW4gb3JkZXIKLy8gdG8gZG8gYSBtb3JlIGVmZmljaWVudCBzaW5nbGUgSFRUUCByZXF1ZXN0LgpBYnN0cmFjdFBvdWNoREIucHJvdG90eXBlLmJ1bGtHZXQgPQogIHV0aWxzLmFkYXB0ZXJGdW4oJ2J1bGtHZXQnLCBmdW5jdGlvbiAob3B0cywgY2FsbGJhY2spIHsKICBidWxrR2V0U2hpbSh0aGlzLCBvcHRzLCBjYWxsYmFjayk7Cn0pOwoKLy8gY29tcGFjdCBvbmUgZG9jdW1lbnQgYW5kIGZpcmUgY2FsbGJhY2sKLy8gYnkgY29tcGFjdGluZyB3ZSBtZWFuIHJlbW92aW5nIGFsbCByZXZpc2lvbnMgd2hpY2gKLy8gYXJlIGZ1cnRoZXIgZnJvbSB0aGUgbGVhZiBpbiByZXZpc2lvbiB0cmVlIHRoYW4gbWF4X2hlaWdodApBYnN0cmFjdFBvdWNoREIucHJvdG90eXBlLmNvbXBhY3REb2N1bWVudCA9CiAgdXRpbHMuYWRhcHRlckZ1bignY29tcGFjdERvY3VtZW50JywgZnVuY3Rpb24gKGRvY0lkLCBtYXhIZWlnaHQsIGNhbGxiYWNrKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHRoaXMuX2dldFJldmlzaW9uVHJlZShkb2NJZCwgZnVuY3Rpb24gKGVyciwgcmV2VHJlZSkgewogICAgaWYgKGVycikgewogICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKICAgIH0KICAgIHZhciBoZWlnaHQgPSBjb21wdXRlSGVpZ2h0KHJldlRyZWUpOwogICAgdmFyIGNhbmRpZGF0ZXMgPSBbXTsKICAgIHZhciByZXZzID0gW107CiAgICBPYmplY3Qua2V5cyhoZWlnaHQpLmZvckVhY2goZnVuY3Rpb24gKHJldikgewogICAgICBpZiAoaGVpZ2h0W3Jldl0gPiBtYXhIZWlnaHQpIHsKICAgICAgICBjYW5kaWRhdGVzLnB1c2gocmV2KTsKICAgICAgfQogICAgfSk7CgogICAgdHJhdmVyc2VSZXZUcmVlKHJldlRyZWUsIGZ1bmN0aW9uIChpc0xlYWYsIHBvcywgcmV2SGFzaCwgY3R4LCBvcHRzKSB7CiAgICAgIHZhciByZXYgPSBwb3MgKyAnLScgKyByZXZIYXNoOwogICAgICBpZiAob3B0cy5zdGF0dXMgPT09ICdhdmFpbGFibGUnICYmIGNhbmRpZGF0ZXMuaW5kZXhPZihyZXYpICE9PSAtMSkgewogICAgICAgIHJldnMucHVzaChyZXYpOwogICAgICB9CiAgICB9KTsKICAgIHNlbGYuX2RvQ29tcGFjdGlvbihkb2NJZCwgcmV2cywgY2FsbGJhY2spOwogIH0pOwp9KTsKCi8vIGNvbXBhY3QgdGhlIHdob2xlIGRhdGFiYXNlIHVzaW5nIHNpbmdsZSBkb2N1bWVudAovLyBjb21wYWN0aW9uCkFic3RyYWN0UG91Y2hEQi5wcm90b3R5cGUuY29tcGFjdCA9CiAgdXRpbHMuYWRhcHRlckZ1bignY29tcGFjdCcsIGZ1bmN0aW9uIChvcHRzLCBjYWxsYmFjaykgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2FsbGJhY2sgPSBvcHRzOwogICAgb3B0cyA9IHt9OwogIH0KCiAgdmFyIHNlbGYgPSB0aGlzOwogIG9wdHMgPSBvcHRzIHx8IHt9OwoKICBzZWxmLl9jb21wYWN0aW9uUXVldWUgPSBzZWxmLl9jb21wYWN0aW9uUXVldWUgfHwgW107CiAgc2VsZi5fY29tcGFjdGlvblF1ZXVlLnB1c2goe29wdHM6IG9wdHMsIGNhbGxiYWNrOiBjYWxsYmFja30pOwogIGlmIChzZWxmLl9jb21wYWN0aW9uUXVldWUubGVuZ3RoID09PSAxKSB7CiAgICBkb05leHRDb21wYWN0aW9uKHNlbGYpOwogIH0KfSk7CkFic3RyYWN0UG91Y2hEQi5wcm90b3R5cGUuX2NvbXBhY3QgPSBmdW5jdGlvbiAob3B0cywgY2FsbGJhY2spIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgdmFyIGNoYW5nZXNPcHRzID0gewogICAgcmV0dXJuRG9jczogZmFsc2UsCiAgICBsYXN0X3NlcTogb3B0cy5sYXN0X3NlcSB8fCAwCiAgfTsKICB2YXIgcHJvbWlzZXMgPSBbXTsKCiAgZnVuY3Rpb24gb25DaGFuZ2Uocm93KSB7CiAgICBwcm9taXNlcy5wdXNoKHNlbGYuY29tcGFjdERvY3VtZW50KHJvdy5pZCwgMCkpOwogIH0KICBmdW5jdGlvbiBvbkNvbXBsZXRlKHJlc3ApIHsKICAgIHZhciBsYXN0U2VxID0gcmVzcC5sYXN0X3NlcTsKICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHVwc2VydChzZWxmLCAnX2xvY2FsL2NvbXBhY3Rpb24nLCBmdW5jdGlvbiBkZWx0YUZ1bmMoZG9jKSB7CiAgICAgICAgaWYgKCFkb2MubGFzdF9zZXEgfHwgZG9jLmxhc3Rfc2VxIDwgbGFzdFNlcSkgewogICAgICAgICAgZG9jLmxhc3Rfc2VxID0gbGFzdFNlcTsKICAgICAgICAgIHJldHVybiBkb2M7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsgLy8gc29tZWJvZHkgZWxzZSBnb3QgaGVyZSBmaXJzdCwgZG9uJ3QgdXBkYXRlCiAgICAgIH0pOwogICAgfSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIGNhbGxiYWNrKG51bGwsIHtvazogdHJ1ZX0pOwogICAgfSkuY2F0Y2goY2FsbGJhY2spOwogIH0KICBzZWxmLmNoYW5nZXMoY2hhbmdlc09wdHMpCiAgICAub24oJ2NoYW5nZScsIG9uQ2hhbmdlKQogICAgLm9uKCdjb21wbGV0ZScsIG9uQ29tcGxldGUpCiAgICAub24oJ2Vycm9yJywgY2FsbGJhY2spOwp9OwovKiBCZWdpbiBhcGkgd3JhcHBlcnMuIFNwZWNpZmljIGZ1bmN0aW9uYWxpdHkgdG8gc3RvcmFnZSBiZWxvbmdzIGluIHRoZQogICBfW21ldGhvZF0gKi8KQWJzdHJhY3RQb3VjaERCLnByb3RvdHlwZS5nZXQgPQogIHV0aWxzLmFkYXB0ZXJGdW4oJ2dldCcsIGZ1bmN0aW9uIChpZCwgb3B0cywgY2FsbGJhY2spIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNhbGxiYWNrID0gb3B0czsKICAgIG9wdHMgPSB7fTsKICB9CiAgaWYgKHR5cGVvZiBpZCAhPT0gJ3N0cmluZycpIHsKICAgIHJldHVybiBjYWxsYmFjayhlcnJvcnMuZXJyb3IoZXJyb3JzLklOVkFMSURfSUQpKTsKICB9CiAgaWYgKGlzTG9jYWxJZChpZCkgJiYgdHlwZW9mIHRoaXMuX2dldExvY2FsID09PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0TG9jYWwoaWQsIGNhbGxiYWNrKTsKICB9CiAgdmFyIGxlYXZlcyA9IFtdLCBzZWxmID0gdGhpczsKCiAgZnVuY3Rpb24gZmluaXNoT3BlblJldnMoKSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICB2YXIgY291bnQgPSBsZWF2ZXMubGVuZ3RoOwogICAgaWYgKCFjb3VudCkgewogICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgcmVzdWx0KTsKICAgIH0KICAgIC8vIG9yZGVyIHdpdGggb3Blbl9yZXZzIGlzIHVuc3BlY2lmaWVkCiAgICBsZWF2ZXMuZm9yRWFjaChmdW5jdGlvbiAobGVhZikgewogICAgICBzZWxmLmdldChpZCwgewogICAgICAgIHJldjogbGVhZiwKICAgICAgICByZXZzOiBvcHRzLnJldnMsCiAgICAgICAgYXR0YWNobWVudHM6IG9wdHMuYXR0YWNobWVudHMKICAgICAgfSwgZnVuY3Rpb24gKGVyciwgZG9jKSB7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKHtvazogZG9jfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKHttaXNzaW5nOiBsZWFmfSk7CiAgICAgICAgfQogICAgICAgIGNvdW50LS07CiAgICAgICAgaWYgKCFjb3VudCkgewogICAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzdWx0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICBpZiAob3B0cy5vcGVuX3JldnMpIHsKICAgIGlmIChvcHRzLm9wZW5fcmV2cyA9PT0gImFsbCIpIHsKICAgICAgdGhpcy5fZ2V0UmV2aXNpb25UcmVlKGlkLCBmdW5jdGlvbiAoZXJyLCByZXZfdHJlZSkgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwogICAgICAgIH0KICAgICAgICBsZWF2ZXMgPSBjb2xsZWN0TGVhdmVzKHJldl90cmVlKS5tYXAoZnVuY3Rpb24gKGxlYWYpIHsKICAgICAgICAgIHJldHVybiBsZWFmLnJldjsKICAgICAgICB9KTsKICAgICAgICBmaW5pc2hPcGVuUmV2cygpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KG9wdHMub3Blbl9yZXZzKSkgewogICAgICAgIGxlYXZlcyA9IG9wdHMub3Blbl9yZXZzOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVhdmVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgbCA9IGxlYXZlc1tpXTsKICAgICAgICAgIC8vIGxvb2tzIGxpa2UgaXQncyB0aGUgb25seSB0aGluZyBjb3VjaGRiIGNoZWNrcwogICAgICAgICAgaWYgKCEodHlwZW9mKGwpID09PSAic3RyaW5nIiAmJiAvXlxkKy0vLnRlc3QobCkpKSB7CiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnJvcnMuZXJyb3IoZXJyb3JzLklOVkFMSURfUkVWKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZpbmlzaE9wZW5SZXZzKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycm9ycy5lcnJvcihlcnJvcnMuVU5LTk9XTl9FUlJPUiwKICAgICAgICAgICdmdW5jdGlvbl9jbGF1c2UnKSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybjsgLy8gb3Blbl9yZXZzIGRvZXMgbm90IGxpa2Ugb3RoZXIgb3B0aW9ucwogIH0KCiAgcmV0dXJuIHRoaXMuX2dldChpZCwgb3B0cywgZnVuY3Rpb24gKGVyciwgcmVzdWx0KSB7CiAgICBpZiAoZXJyKSB7CiAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwogICAgfQoKICAgIHZhciBkb2MgPSByZXN1bHQuZG9jOwogICAgdmFyIG1ldGFkYXRhID0gcmVzdWx0Lm1ldGFkYXRhOwogICAgdmFyIGN0eCA9IHJlc3VsdC5jdHg7CgogICAgaWYgKG9wdHMuY29uZmxpY3RzKSB7CiAgICAgIHZhciBjb25mbGljdHMgPSBjb2xsZWN0Q29uZmxpY3RzKG1ldGFkYXRhKTsKICAgICAgaWYgKGNvbmZsaWN0cy5sZW5ndGgpIHsKICAgICAgICBkb2MuX2NvbmZsaWN0cyA9IGNvbmZsaWN0czsKICAgICAgfQogICAgfQoKICAgIGlmIChpc0RlbGV0ZWQobWV0YWRhdGEsIGRvYy5fcmV2KSkgewogICAgICBkb2MuX2RlbGV0ZWQgPSB0cnVlOwogICAgfQoKICAgIGlmIChvcHRzLnJldnMgfHwgb3B0cy5yZXZzX2luZm8pIHsKICAgICAgdmFyIHBhdGhzID0gcm9vdFRvTGVhZihtZXRhZGF0YS5yZXZfdHJlZSk7CiAgICAgIHZhciBwYXRoID0gYXJyYXlGaXJzdChwYXRocywgZnVuY3Rpb24gKGFycikgewogICAgICAgIHJldHVybiBhcnIuaWRzLm1hcChmdW5jdGlvbiAoeCkgeyByZXR1cm4geC5pZDsgfSkKICAgICAgICAgIC5pbmRleE9mKGRvYy5fcmV2LnNwbGl0KCctJylbMV0pICE9PSAtMTsKICAgICAgfSk7CgogICAgICB2YXIgaW5kZXhPZlJldiA9IHBhdGguaWRzLm1hcChmdW5jdGlvbiAoeCkge3JldHVybiB4LmlkOyB9KQogICAgICAgIC5pbmRleE9mKGRvYy5fcmV2LnNwbGl0KCctJylbMV0pICsgMTsKICAgICAgdmFyIGhvd01hbnkgPSBwYXRoLmlkcy5sZW5ndGggLSBpbmRleE9mUmV2OwogICAgICBwYXRoLmlkcy5zcGxpY2UoaW5kZXhPZlJldiwgaG93TWFueSk7CiAgICAgIHBhdGguaWRzLnJldmVyc2UoKTsKCiAgICAgIGlmIChvcHRzLnJldnMpIHsKICAgICAgICBkb2MuX3JldmlzaW9ucyA9IHsKICAgICAgICAgIHN0YXJ0OiAocGF0aC5wb3MgKyBwYXRoLmlkcy5sZW5ndGgpIC0gMSwKICAgICAgICAgIGlkczogcGF0aC5pZHMubWFwKGZ1bmN0aW9uIChyZXYpIHsKICAgICAgICAgICAgcmV0dXJuIHJldi5pZDsKICAgICAgICAgIH0pCiAgICAgICAgfTsKICAgICAgfQogICAgICBpZiAob3B0cy5yZXZzX2luZm8pIHsKICAgICAgICB2YXIgcG9zID0gIHBhdGgucG9zICsgcGF0aC5pZHMubGVuZ3RoOwogICAgICAgIGRvYy5fcmV2c19pbmZvID0gcGF0aC5pZHMubWFwKGZ1bmN0aW9uIChyZXYpIHsKICAgICAgICAgIHBvcy0tOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmV2OiBwb3MgKyAnLScgKyByZXYuaWQsCiAgICAgICAgICAgIHN0YXR1czogcmV2Lm9wdHMuc3RhdHVzCiAgICAgICAgICB9OwogICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgaWYgKG9wdHMuYXR0YWNobWVudHMgJiYgZG9jLl9hdHRhY2htZW50cykgewogICAgICB2YXIgYXR0YWNobWVudHMgPSBkb2MuX2F0dGFjaG1lbnRzOwogICAgICB2YXIgY291bnQgPSBPYmplY3Qua2V5cyhhdHRhY2htZW50cykubGVuZ3RoOwogICAgICBpZiAoY291bnQgPT09IDApIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgZG9jKTsKICAgICAgfQogICAgICBPYmplY3Qua2V5cyhhdHRhY2htZW50cykuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgdGhpcy5fZ2V0QXR0YWNobWVudChhdHRhY2htZW50c1trZXldLCB7CiAgICAgICAgICBiaW5hcnk6IG9wdHMuYmluYXJ5LAogICAgICAgICAgY3R4OiBjdHgKICAgICAgICB9LCBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICB2YXIgYXR0ID0gZG9jLl9hdHRhY2htZW50c1trZXldOwogICAgICAgICAgYXR0LmRhdGEgPSBkYXRhOwogICAgICAgICAgZGVsZXRlIGF0dC5zdHViOwogICAgICAgICAgZGVsZXRlIGF0dC5sZW5ndGg7CiAgICAgICAgICBpZiAoIS0tY291bnQpIHsKICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgZG9jKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwgc2VsZik7CiAgICB9IGVsc2UgewogICAgICBpZiAoZG9jLl9hdHRhY2htZW50cykgewogICAgICAgIGZvciAodmFyIGtleSBpbiBkb2MuX2F0dGFjaG1lbnRzKSB7CiAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgICAgICAgaWYgKGRvYy5fYXR0YWNobWVudHMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICBkb2MuX2F0dGFjaG1lbnRzW2tleV0uc3R1YiA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGNhbGxiYWNrKG51bGwsIGRvYyk7CiAgICB9CiAgfSk7Cn0pOwoKQWJzdHJhY3RQb3VjaERCLnByb3RvdHlwZS5nZXRBdHRhY2htZW50ID0KICB1dGlscy5hZGFwdGVyRnVuKCdnZXRBdHRhY2htZW50JywgZnVuY3Rpb24gKGRvY0lkLCBhdHRhY2htZW50SWQsIG9wdHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaykgewogIHZhciBzZWxmID0gdGhpczsKICBpZiAob3B0cyBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7CiAgICBjYWxsYmFjayA9IG9wdHM7CiAgICBvcHRzID0ge307CiAgfQogIHRoaXMuX2dldChkb2NJZCwgb3B0cywgZnVuY3Rpb24gKGVyciwgcmVzKSB7CiAgICBpZiAoZXJyKSB7CiAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwogICAgfQogICAgaWYgKHJlcy5kb2MuX2F0dGFjaG1lbnRzICYmIHJlcy5kb2MuX2F0dGFjaG1lbnRzW2F0dGFjaG1lbnRJZF0pIHsKICAgICAgb3B0cy5jdHggPSByZXMuY3R4OwogICAgICBvcHRzLmJpbmFyeSA9IHRydWU7CiAgICAgIHNlbGYuX2dldEF0dGFjaG1lbnQocmVzLmRvYy5fYXR0YWNobWVudHNbYXR0YWNobWVudElkXSwgb3B0cywgY2FsbGJhY2spOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycm9ycy5lcnJvcihlcnJvcnMuTUlTU0lOR19ET0MpKTsKICAgIH0KICB9KTsKfSk7CgpBYnN0cmFjdFBvdWNoREIucHJvdG90eXBlLmFsbERvY3MgPQogIHV0aWxzLmFkYXB0ZXJGdW4oJ2FsbERvY3MnLCBmdW5jdGlvbiAob3B0cywgY2FsbGJhY2spIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNhbGxiYWNrID0gb3B0czsKICAgIG9wdHMgPSB7fTsKICB9CiAgb3B0cy5za2lwID0gdHlwZW9mIG9wdHMuc2tpcCAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRzLnNraXAgOiAwOwogIGlmIChvcHRzLnN0YXJ0X2tleSkgewogICAgb3B0cy5zdGFydGtleSA9IG9wdHMuc3RhcnRfa2V5OwogIH0KICBpZiAob3B0cy5lbmRfa2V5KSB7CiAgICBvcHRzLmVuZGtleSA9IG9wdHMuZW5kX2tleTsKICB9CiAgaWYgKCdrZXlzJyBpbiBvcHRzKSB7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkob3B0cy5rZXlzKSkgewogICAgICByZXR1cm4gY2FsbGJhY2sobmV3IFR5cGVFcnJvcignb3B0aW9ucy5rZXlzIG11c3QgYmUgYW4gYXJyYXknKSk7CiAgICB9CiAgICB2YXIgaW5jb21wYXRpYmxlT3B0ID0KICAgICAgWydzdGFydGtleScsICdlbmRrZXknLCAna2V5J10uZmlsdGVyKGZ1bmN0aW9uIChpbmNvbXBhdGlibGVPcHQpIHsKICAgICAgcmV0dXJuIGluY29tcGF0aWJsZU9wdCBpbiBvcHRzOwogICAgfSlbMF07CiAgICBpZiAoaW5jb21wYXRpYmxlT3B0KSB7CiAgICAgIGNhbGxiYWNrKGVycm9ycy5lcnJvcihlcnJvcnMuUVVFUllfUEFSU0VfRVJST1IsCiAgICAgICAgJ1F1ZXJ5IHBhcmFtZXRlciBgJyArIGluY29tcGF0aWJsZU9wdCArCiAgICAgICAgJ2AgaXMgbm90IGNvbXBhdGlibGUgd2l0aCBtdWx0aS1nZXQnCiAgICAgICkpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy50eXBlKCkgIT09ICdodHRwJykgewogICAgICByZXR1cm4gYWxsRG9jc0tleXNRdWVyeSh0aGlzLCBvcHRzLCBjYWxsYmFjayk7CiAgICB9CiAgfQoKICByZXR1cm4gdGhpcy5fYWxsRG9jcyhvcHRzLCBjYWxsYmFjayk7Cn0pOwoKQWJzdHJhY3RQb3VjaERCLnByb3RvdHlwZS5jaGFuZ2VzID0gZnVuY3Rpb24gKG9wdHMsIGNhbGxiYWNrKSB7CiAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYWxsYmFjayA9IG9wdHM7CiAgICBvcHRzID0ge307CiAgfQogIHJldHVybiBuZXcgQ2hhbmdlcyh0aGlzLCBvcHRzLCBjYWxsYmFjayk7Cn07CgpBYnN0cmFjdFBvdWNoREIucHJvdG90eXBlLmNsb3NlID0KICB1dGlscy5hZGFwdGVyRnVuKCdjbG9zZScsIGZ1bmN0aW9uIChjYWxsYmFjaykgewogIHRoaXMuX2Nsb3NlZCA9IHRydWU7CiAgcmV0dXJuIHRoaXMuX2Nsb3NlKGNhbGxiYWNrKTsKfSk7CgpBYnN0cmFjdFBvdWNoREIucHJvdG90eXBlLmluZm8gPSB1dGlscy5hZGFwdGVyRnVuKCdpbmZvJywgZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHRoaXMuX2luZm8oZnVuY3Rpb24gKGVyciwgaW5mbykgewogICAgaWYgKGVycikgewogICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKICAgIH0KICAgIC8vIGFzc3VtZSB3ZSBrbm93IGJldHRlciB0aGFuIHRoZSBhZGFwdGVyLCB1bmxlc3MgaXQgaW5mb3JtcyB1cwogICAgaW5mby5kYl9uYW1lID0gaW5mby5kYl9uYW1lIHx8IHNlbGYuX2RiX25hbWU7CiAgICBpbmZvLmF1dG9fY29tcGFjdGlvbiA9ICEhKHNlbGYuYXV0b19jb21wYWN0aW9uICYmIHNlbGYudHlwZSgpICE9PSAnaHR0cCcpOwogICAgaW5mby5hZGFwdGVyID0gc2VsZi50eXBlKCk7CiAgICBjYWxsYmFjayhudWxsLCBpbmZvKTsKICB9KTsKfSk7CgpBYnN0cmFjdFBvdWNoREIucHJvdG90eXBlLmlkID0gdXRpbHMuYWRhcHRlckZ1bignaWQnLCBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICByZXR1cm4gdGhpcy5faWQoY2FsbGJhY2spOwp9KTsKCkFic3RyYWN0UG91Y2hEQi5wcm90b3R5cGUudHlwZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gKHR5cGVvZiB0aGlzLl90eXBlID09PSAnZnVuY3Rpb24nKSA/IHRoaXMuX3R5cGUoKSA6IHRoaXMuYWRhcHRlcjsKfTsKCkFic3RyYWN0UG91Y2hEQi5wcm90b3R5cGUuYnVsa0RvY3MgPQogIHV0aWxzLmFkYXB0ZXJGdW4oJ2J1bGtEb2NzJywgZnVuY3Rpb24gKHJlcSwgb3B0cywgY2FsbGJhY2spIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNhbGxiYWNrID0gb3B0czsKICAgIG9wdHMgPSB7fTsKICB9CgogIG9wdHMgPSBvcHRzIHx8IHt9OwoKICBpZiAoQXJyYXkuaXNBcnJheShyZXEpKSB7CiAgICByZXEgPSB7CiAgICAgIGRvY3M6IHJlcQogICAgfTsKICB9CgogIGlmICghcmVxIHx8ICFyZXEuZG9jcyB8fCAhQXJyYXkuaXNBcnJheShyZXEuZG9jcykpIHsKICAgIHJldHVybiBjYWxsYmFjayhlcnJvcnMuZXJyb3IoZXJyb3JzLk1JU1NJTkdfQlVMS19ET0NTKSk7CiAgfQoKICBmb3IgKHZhciBpID0gMDsgaSA8IHJlcS5kb2NzLmxlbmd0aDsgKytpKSB7CiAgICBpZiAodHlwZW9mIHJlcS5kb2NzW2ldICE9PSAnb2JqZWN0JyB8fCBBcnJheS5pc0FycmF5KHJlcS5kb2NzW2ldKSkgewogICAgICByZXR1cm4gY2FsbGJhY2soZXJyb3JzLmVycm9yKGVycm9ycy5OT1RfQU5fT0JKRUNUKSk7CiAgICB9CiAgfQoKICB2YXIgYXR0YWNobWVudEVycm9yOwogIHJlcS5kb2NzLmZvckVhY2goZnVuY3Rpb24oZG9jKSB7CiAgICBpZiAoZG9jLl9hdHRhY2htZW50cykgewogICAgICBPYmplY3Qua2V5cyhkb2MuX2F0dGFjaG1lbnRzKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgYXR0YWNobWVudEVycm9yID0gYXR0YWNobWVudEVycm9yIHx8IGF0dGFjaG1lbnROYW1lRXJyb3IobmFtZSk7CiAgICAgIH0pOwogICAgfQogIH0pOwoKICBpZiAoYXR0YWNobWVudEVycm9yKSB7CiAgICByZXR1cm4gY2FsbGJhY2soZXJyb3JzLmVycm9yKGVycm9ycy5CQURfUkVRVUVTVCwgYXR0YWNobWVudEVycm9yKSk7CiAgfQoKICBpZiAoISgnbmV3X2VkaXRzJyBpbiBvcHRzKSkgewogICAgaWYgKCduZXdfZWRpdHMnIGluIHJlcSkgewogICAgICBvcHRzLm5ld19lZGl0cyA9IHJlcS5uZXdfZWRpdHM7CiAgICB9IGVsc2UgewogICAgICBvcHRzLm5ld19lZGl0cyA9IHRydWU7CiAgICB9CiAgfQoKICBpZiAoIW9wdHMubmV3X2VkaXRzICYmIHRoaXMudHlwZSgpICE9PSAnaHR0cCcpIHsKICAgIC8vIGVuc3VyZSByZXZpc2lvbnMgb2YgdGhlIHNhbWUgZG9jIGFyZSBzb3J0ZWQsIHNvIHRoYXQKICAgIC8vIHRoZSBsb2NhbCBhZGFwdGVyIHByb2Nlc3NlcyB0aGVtIGNvcnJlY3RseSAoIzI5MzUpCiAgICByZXEuZG9jcy5zb3J0KGNvbXBhcmVCeUlkVGhlblJldik7CiAgfQoKICBjbGVhbkRvY3MocmVxLmRvY3MpOwoKICByZXR1cm4gdGhpcy5fYnVsa0RvY3MocmVxLCBvcHRzLCBmdW5jdGlvbiAoZXJyLCByZXMpIHsKICAgIGlmIChlcnIpIHsKICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7CiAgICB9CiAgICBpZiAoIW9wdHMubmV3X2VkaXRzKSB7CiAgICAgIC8vIHRoaXMgaXMgd2hhdCBjb3VjaCBkb2VzIHdoZW4gbmV3X2VkaXRzIGlzIGZhbHNlCiAgICAgIHJlcyA9IHJlcy5maWx0ZXIoZnVuY3Rpb24gKHgpIHsKICAgICAgICByZXR1cm4geC5lcnJvcjsKICAgICAgfSk7CiAgICB9CiAgICBjYWxsYmFjayhudWxsLCByZXMpOwogIH0pOwp9KTsKCkFic3RyYWN0UG91Y2hEQi5wcm90b3R5cGUucmVnaXN0ZXJEZXBlbmRlbnREYXRhYmFzZSA9CiAgdXRpbHMuYWRhcHRlckZ1bigncmVnaXN0ZXJEZXBlbmRlbnREYXRhYmFzZScsIGZ1bmN0aW9uIChkZXBlbmRlbnREYiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKSB7CiAgdmFyIGRlcERCID0gbmV3IHRoaXMuY29uc3RydWN0b3IoZGVwZW5kZW50RGIsIHRoaXMuX19vcHRzKTsKCiAgZnVuY3Rpb24gZGlmZkZ1bihkb2MpIHsKICAgIGRvYy5kZXBlbmRlbnREYnMgPSBkb2MuZGVwZW5kZW50RGJzIHx8IHt9OwogICAgaWYgKGRvYy5kZXBlbmRlbnREYnNbZGVwZW5kZW50RGJdKSB7CiAgICAgIHJldHVybiBmYWxzZTsgLy8gbm8gdXBkYXRlIHJlcXVpcmVkCiAgICB9CiAgICBkb2MuZGVwZW5kZW50RGJzW2RlcGVuZGVudERiXSA9IHRydWU7CiAgICByZXR1cm4gZG9jOwogIH0KICB1cHNlcnQodGhpcywgJ19sb2NhbC9fcG91Y2hfZGVwZW5kZW50RGJzJywgZGlmZkZ1bikKICAgIC50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgY2FsbGJhY2sobnVsbCwge2RiOiBkZXBEQn0pOwogICAgfSkuY2F0Y2goY2FsbGJhY2spOwp9KTsKCkFic3RyYWN0UG91Y2hEQi5wcm90b3R5cGUuZGVzdHJveSA9CiAgdXRpbHMuYWRhcHRlckZ1bignZGVzdHJveScsIGZ1bmN0aW9uIChvcHRzLCBjYWxsYmFjaykgewoKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNhbGxiYWNrID0gb3B0czsKICAgIG9wdHMgPSB7fTsKICB9CgogIHZhciBzZWxmID0gdGhpczsKICB2YXIgdXNlUHJlZml4ID0gJ3VzZV9wcmVmaXgnIGluIHNlbGYgPyBzZWxmLnVzZV9wcmVmaXggOiB0cnVlOwoKICBmdW5jdGlvbiBkZXN0cm95RGIoKSB7CiAgICAvLyBjYWxsIGRlc3Ryb3kgbWV0aG9kIG9mIHRoZSBwYXJ0aWN1bGFyIGFkYXB0b3IKICAgIHNlbGYuX2Rlc3Ryb3kob3B0cywgZnVuY3Rpb24gKGVyciwgcmVzcCkgewogICAgICBpZiAoZXJyKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7CiAgICAgIH0KICAgICAgc2VsZi5lbWl0KCdkZXN0cm95ZWQnKTsKICAgICAgY2FsbGJhY2sobnVsbCwgcmVzcCB8fCB7ICdvayc6IHRydWUgfSk7CiAgICB9KTsKICB9CgogIGlmIChzZWxmLnR5cGUoKSA9PT0gJ2h0dHAnKSB7CiAgICAvLyBubyBuZWVkIHRvIGNoZWNrIGZvciBkZXBlbmRlbnQgREJzIGlmIGl0J3MgYSByZW1vdGUgREIKICAgIHJldHVybiBkZXN0cm95RGIoKTsKICB9CgogIHNlbGYuZ2V0KCdfbG9jYWwvX3BvdWNoX2RlcGVuZGVudERicycsIGZ1bmN0aW9uIChlcnIsIGxvY2FsRG9jKSB7CiAgICBpZiAoZXJyKSB7CiAgICAgIGlmIChlcnIuc3RhdHVzICE9PSA0MDQpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKICAgICAgfSBlbHNlIHsgLy8gbm8gZGVwZW5kZW5jaWVzCiAgICAgICAgcmV0dXJuIGRlc3Ryb3lEYigpOwogICAgICB9CiAgICB9CiAgICB2YXIgZGVwZW5kZW50RGJzID0gbG9jYWxEb2MuZGVwZW5kZW50RGJzOwogICAgdmFyIFBvdWNoREIgPSBzZWxmLmNvbnN0cnVjdG9yOwogICAgdmFyIGRlbGV0ZWRNYXAgPSBPYmplY3Qua2V5cyhkZXBlbmRlbnREYnMpLm1hcChmdW5jdGlvbiAobmFtZSkgewogICAgICB2YXIgdHJ1ZU5hbWUgPSB1c2VQcmVmaXggPwogICAgICAgIG5hbWUucmVwbGFjZShuZXcgUmVnRXhwKCdeJyArIFBvdWNoREIucHJlZml4KSwgJycpIDogbmFtZTsKICAgICAgcmV0dXJuIG5ldyBQb3VjaERCKHRydWVOYW1lLCBzZWxmLl9fb3B0cykuZGVzdHJveSgpOwogICAgfSk7CiAgICBQcm9taXNlLmFsbChkZWxldGVkTWFwKS50aGVuKGRlc3Ryb3lEYiwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgIGNhbGxiYWNrKGVycm9yKTsKICAgIH0pOwogIH0pOwp9KTsKCn0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiLi9jaGFuZ2VzIjoyNywiLi9kZXBzL2J1bGtHZXRTaGltIjo1MiwiLi9kZXBzL2RvY3MvaXNEZWxldGVkIjo1NCwiLi9kZXBzL2RvY3MvaXNMb2NhbElkIjo1NSwiLi9kZXBzL2Vycm9ycyI6NjQsIi4vZGVwcy9tZXJnZS9jb2xsZWN0Q29uZmxpY3RzIjo2OCwiLi9kZXBzL21lcmdlL2NvbGxlY3RMZWF2ZXMiOjY5LCIuL2RlcHMvbWVyZ2Uvcm9vdFRvTGVhZiI6NzIsIi4vZGVwcy9tZXJnZS90cmF2ZXJzZVJldlRyZWUiOjczLCIuL2RlcHMvdXBzZXJ0Ijo4MSwiLi91dGlscyI6MTAyLCJfcHJvY2VzcyI6OCwiZXZlbnRzIjo3fV0sMTU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBpZGI6IHJlcXVpcmUoJy4vYWRhcHRlcnMvaWRiJyksCiAgd2Vic3FsOiByZXF1aXJlKCcuL2FkYXB0ZXJzL3dlYnNxbCcpCn07Cn0seyIuL2FkYXB0ZXJzL2lkYiI6MjEsIi4vYWRhcHRlcnMvd2Vic3FsIjoyNX1dLDE2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKdmFyIENIQU5HRVNfQkFUQ0hfU0laRSA9IDI1Owp2YXIgTUFYX1NJTVVMVEFORU9VU19SRVZTID0gNTA7Cgp2YXIgc3VwcG9ydHNCdWxrR2V0TWFwID0ge307CgovLyBhY2NvcmRpbmcgdG8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvNDE3MTg0LzY4MDc0MiwKLy8gdGhlIGRlIGZhY3RvIFVSTCBsZW5ndGggbGltaXQgaXMgMjAwMCBjaGFyYWN0ZXJzLgovLyBidXQgc2luY2UgbW9zdCBvZiBvdXIgbWVhc3VyZW1lbnRzIGRvbid0IHRha2UgdGhlIGZ1bGwKLy8gVVJMIGludG8gYWNjb3VudCwgd2UgZnVkZ2UgaXQgYSBiaXQuCi8vIFRPRE86IHdlIGNvdWxkIG1lYXN1cmUgdGhlIGZ1bGwgVVJMIHRvIGVuZm9yY2UgZXhhY3RseSAyMDAwIGNoYXJzCnZhciBNQVhfVVJMX0xFTkdUSCA9IDE4MDA7Cgp2YXIgYmluU3RyaW5nVG9CbHVmZmVyID0KICByZXF1aXJlKCcuLi8uLi9kZXBzL2JpbmFyeS9iaW5hcnlTdHJpbmdUb0Jsb2JPckJ1ZmZlcicpOwp2YXIgYjY0U3RyaW5nVG9CbHVmZmVyID0KICByZXF1aXJlKCcuLi8uLi9kZXBzL2JpbmFyeS9iYXNlNjRTdHJpbmdUb0Jsb2JPckJ1ZmZlcicpOwp2YXIgdXRpbHMgPSByZXF1aXJlKCcuLi8uLi91dGlscycpOwp2YXIgUHJvbWlzZSA9IHV0aWxzLlByb21pc2U7CnZhciBjbG9uZSA9IHV0aWxzLmNsb25lOwp2YXIgYmFzZTY0ID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9iaW5hcnkvYmFzZTY0Jyk7CnZhciBidG9hID0gYmFzZTY0LmJ0b2E7CnZhciBhdG9iID0gYmFzZTY0LmF0b2I7CnZhciBlcnJvcnMgPSByZXF1aXJlKCcuLi8uLi9kZXBzL2Vycm9ycycpOwp2YXIgbG9nID0gcmVxdWlyZSgnZGVidWcnKSgncG91Y2hkYjpodHRwJyk7CnZhciBjcmVhdGVNdWx0aXBhcnQgPSByZXF1aXJlKCcuLi8uLi9kZXBzL2FqYXgvbXVsdGlwYXJ0Jyk7CnZhciBibHVmZmVyVG9CYXNlNjQgPSByZXF1aXJlKCcuLi8uLi9kZXBzL2JpbmFyeS9ibG9iT3JCdWZmZXJUb0Jhc2U2NCcpOwp2YXIgcGFyc2VEb2MgPSByZXF1aXJlKCcuLi8uLi9kZXBzL2RvY3MvcGFyc2VEb2MnKTsKdmFyIGJ1bGtHZXRTaGltID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9idWxrR2V0U2hpbScpOwp2YXIgZmxhdHRlbiA9IHJlcXVpcmUoJy4uLy4uL2RlcHMvZmxhdHRlbicpOwoKZnVuY3Rpb24gcmVhZEF0dGFjaG1lbnRzQXNCbG9iT3JCdWZmZXIocm93KSB7CiAgdmFyIGF0dHMgPSByb3cuZG9jICYmIHJvdy5kb2MuX2F0dGFjaG1lbnRzOwogIGlmICghYXR0cykgewogICAgcmV0dXJuOwogIH0KICBPYmplY3Qua2V5cyhhdHRzKS5mb3JFYWNoKGZ1bmN0aW9uIChmaWxlbmFtZSkgewogICAgdmFyIGF0dCA9IGF0dHNbZmlsZW5hbWVdOwogICAgYXR0LmRhdGEgPSBiNjRTdHJpbmdUb0JsdWZmZXIoYXR0LmRhdGEsIGF0dC5jb250ZW50X3R5cGUpOwogIH0pOwp9CgpmdW5jdGlvbiBlbmNvZGVEb2NJZChpZCkgewogIGlmICgvXl9kZXNpZ24vLnRlc3QoaWQpKSB7CiAgICByZXR1cm4gJ19kZXNpZ24vJyArIGVuY29kZVVSSUNvbXBvbmVudChpZC5zbGljZSg4KSk7CiAgfQogIGlmICgvXl9sb2NhbC8udGVzdChpZCkpIHsKICAgIHJldHVybiAnX2xvY2FsLycgKyBlbmNvZGVVUklDb21wb25lbnQoaWQuc2xpY2UoNykpOwogIH0KICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KGlkKTsKfQoKZnVuY3Rpb24gcHJlcHJvY2Vzc0F0dGFjaG1lbnRzKGRvYykgewogIGlmICghZG9jLl9hdHRhY2htZW50cyB8fCAhT2JqZWN0LmtleXMoZG9jLl9hdHRhY2htZW50cykpIHsKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTsKICB9CgogIHJldHVybiBQcm9taXNlLmFsbChPYmplY3Qua2V5cyhkb2MuX2F0dGFjaG1lbnRzKS5tYXAoZnVuY3Rpb24gKGtleSkgewogICAgdmFyIGF0dGFjaG1lbnQgPSBkb2MuX2F0dGFjaG1lbnRzW2tleV07CiAgICBpZiAoYXR0YWNobWVudC5kYXRhICYmIHR5cGVvZiBhdHRhY2htZW50LmRhdGEgIT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiBibHVmZmVyVG9CYXNlNjQoYXR0YWNobWVudC5kYXRhKS50aGVuKGZ1bmN0aW9uIChiNjQpIHsKICAgICAgICBhdHRhY2htZW50LmRhdGEgPSBiNjQ7CiAgICAgIH0pOwogICAgfQogIH0pKTsKfQoKLy8gR2V0IGFsbCB0aGUgaW5mb3JtYXRpb24geW91IHBvc3NpYmx5IGNhbiBhYm91dCB0aGUgVVJJIGdpdmVuIGJ5IG5hbWUgYW5kCi8vIHJldHVybiBpdCBhcyBhIHN1aXRhYmxlIG9iamVjdC4KZnVuY3Rpb24gZ2V0SG9zdChuYW1lKSB7CiAgLy8gUHJhc2UgdGhlIFVSSSBpbnRvIGFsbCBpdHMgbGl0dGxlIGJpdHMKICB2YXIgdXJpID0gdXRpbHMucGFyc2VVcmkobmFtZSk7CgogIC8vIFN0b3JlIHRoZSB1c2VyIGFuZCBwYXNzd29yZCBhcyBhIHNlcGFyYXRlIGF1dGggb2JqZWN0CiAgaWYgKHVyaS51c2VyIHx8IHVyaS5wYXNzd29yZCkgewogICAgdXJpLmF1dGggPSB7dXNlcm5hbWU6IHVyaS51c2VyLCBwYXNzd29yZDogdXJpLnBhc3N3b3JkfTsKICB9CgogIC8vIFNwbGl0IHRoZSBwYXRoIHBhcnQgb2YgdGhlIFVSSSBpbnRvIHBhcnRzIHVzaW5nICcvJyBhcyB0aGUgZGVsaW1pdGVyCiAgLy8gYWZ0ZXIgcmVtb3ZpbmcgYW55IGxlYWRpbmcgJy8nIGFuZCBhbnkgdHJhaWxpbmcgJy8nCiAgdmFyIHBhcnRzID0gdXJpLnBhdGgucmVwbGFjZSgvKF5cL3xcLyQpL2csICcnKS5zcGxpdCgnLycpOwoKICAvLyBTdG9yZSB0aGUgZmlyc3QgcGFydCBhcyB0aGUgZGF0YWJhc2UgbmFtZSBhbmQgcmVtb3ZlIGl0IGZyb20gdGhlIHBhcnRzCiAgLy8gYXJyYXkKICB1cmkuZGIgPSBwYXJ0cy5wb3AoKTsKCiAgLy8gUmVzdG9yZSB0aGUgcGF0aCBieSBqb2luaW5nIGFsbCB0aGUgcmVtYWluaW5nIHBhcnRzIChhbGwgdGhlIHBhcnRzCiAgLy8gZXhjZXB0IGZvciB0aGUgZGF0YWJhc2UgbmFtZSkgd2l0aCAnLydzCiAgdXJpLnBhdGggPSBwYXJ0cy5qb2luKCcvJyk7CgogIHJldHVybiB1cmk7Cn0KCi8vIEdlbmVyYXRlIGEgVVJMIHdpdGggdGhlIGhvc3QgZGF0YSBnaXZlbiBieSBvcHRzIGFuZCB0aGUgZ2l2ZW4gcGF0aApmdW5jdGlvbiBnZW5EQlVybChvcHRzLCBwYXRoKSB7CiAgcmV0dXJuIGdlblVybChvcHRzLCBvcHRzLmRiICsgJy8nICsgcGF0aCk7Cn0KCi8vIEdlbmVyYXRlIGEgVVJMIHdpdGggdGhlIGhvc3QgZGF0YSBnaXZlbiBieSBvcHRzIGFuZCB0aGUgZ2l2ZW4gcGF0aApmdW5jdGlvbiBnZW5Vcmwob3B0cywgcGF0aCkgewogIC8vIElmIHRoZSBob3N0IGFscmVhZHkgaGFzIGEgcGF0aCwgdGhlbiB3ZSBuZWVkIHRvIGhhdmUgYSBwYXRoIGRlbGltaXRlcgogIC8vIE90aGVyd2lzZSwgdGhlIHBhdGggZGVsaW1pdGVyIGlzIHRoZSBlbXB0eSBzdHJpbmcKICB2YXIgcGF0aERlbCA9ICFvcHRzLnBhdGggPyAnJyA6ICcvJzsKCiAgLy8gSWYgdGhlIGhvc3QgYWxyZWFkeSBoYXMgYSBwYXRoLCB0aGVuIHdlIG5lZWQgdG8gaGF2ZSBhIHBhdGggZGVsaW1pdGVyCiAgLy8gT3RoZXJ3aXNlLCB0aGUgcGF0aCBkZWxpbWl0ZXIgaXMgdGhlIGVtcHR5IHN0cmluZwogIHJldHVybiBvcHRzLnByb3RvY29sICsgJzovLycgKyBvcHRzLmhvc3QgKyAnOicgKyBvcHRzLnBvcnQgKyAnLycgKwogICAgICAgICBvcHRzLnBhdGggKyBwYXRoRGVsICsgcGF0aDsKfQoKLy8gSW1wbGVtZW50cyB0aGUgUG91Y2hEQiBBUEkgZm9yIGRlYWxpbmcgd2l0aCBDb3VjaERCIGluc3RhbmNlcyBvdmVyIEhUVFAKZnVuY3Rpb24gSHR0cFBvdWNoKG9wdHMsIGNhbGxiYWNrKSB7CiAgLy8gVGhlIGZ1bmN0aW9ucyB0aGF0IHdpbGwgYmUgcHVibGljbHkgYXZhaWxhYmxlIGZvciBIdHRwUG91Y2gKICB2YXIgYXBpID0gdGhpczsKCiAgLy8gUGFyc2UgdGhlIFVSSSBnaXZlbiBieSBvcHRzLm5hbWUgaW50byBhbiBlYXN5LXRvLXVzZSBvYmplY3QKICB2YXIgZ2V0SG9zdEZ1biA9IGdldEhvc3Q7CgogIC8vIFRPRE86IHRoaXMgc2VlbXMgdG8gb25seSBiZSB1c2VkIGJ5IHlhcm9uZyBmb3IgdGhlIFRoYWxpIHByb2plY3QuCiAgLy8gVmVyaWZ5IHdoZXRoZXIgb3Igbm90IGl0J3Mgc3RpbGwgbmVlZGVkLgogIC8qIGlzdGFuYnVsIGlnbm9yZTpuZXh0ICovCiAgaWYgKG9wdHMuZ2V0SG9zdCkgewogICAgZ2V0SG9zdEZ1biA9IG9wdHMuZ2V0SG9zdDsKICB9CgogIHZhciBob3N0ID0gZ2V0SG9zdEZ1bihvcHRzLm5hbWUsIG9wdHMpOwogIHZhciBkYlVybCA9IGdlbkRCVXJsKGhvc3QsICcnKTsKCiAgb3B0cyA9IGNsb25lKG9wdHMpOwogIHZhciBhamF4T3B0cyA9IG9wdHMuYWpheCB8fCB7fTsKCiAgYXBpLmdldFVybCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGRiVXJsOyB9OwogIGFwaS5nZXRIZWFkZXJzID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gYWpheE9wdHMuaGVhZGVycyB8fCB7fTsgfTsKCiAgaWYgKG9wdHMuYXV0aCB8fCBob3N0LmF1dGgpIHsKICAgIHZhciBuQXV0aCA9IG9wdHMuYXV0aCB8fCBob3N0LmF1dGg7CiAgICB2YXIgdG9rZW4gPSBidG9hKG5BdXRoLnVzZXJuYW1lICsgJzonICsgbkF1dGgucGFzc3dvcmQpOwogICAgYWpheE9wdHMuaGVhZGVycyA9IGFqYXhPcHRzLmhlYWRlcnMgfHwge307CiAgICBhamF4T3B0cy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSAnQmFzaWMgJyArIHRva2VuOwogIH0KCiAgZnVuY3Rpb24gYWpheCh1c2VyT3B0cywgb3B0aW9ucywgY2FsbGJhY2spIHsKICAgIHZhciByZXFBamF4ID0gdXNlck9wdHMuYWpheCB8fCB7fTsKICAgIHZhciByZXFPcHRzID0gdXRpbHMuZXh0ZW5kKGNsb25lKGFqYXhPcHRzKSwgcmVxQWpheCwgb3B0aW9ucyk7CiAgICBsb2cocmVxT3B0cy5tZXRob2QgKyAnICcgKyByZXFPcHRzLnVybCk7CiAgICByZXR1cm4gdXRpbHMuYWpheChyZXFPcHRzLCBjYWxsYmFjayk7CiAgfQoKICBmdW5jdGlvbiBhamF4UHJvbWlzZSh1c2VyT3B0cywgb3B0cykgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgYWpheCh1c2VyT3B0cywgb3B0cywgZnVuY3Rpb24gKGVyciwgcmVzKSB7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpOwogICAgICAgIH0KICAgICAgICByZXNvbHZlKHJlcyk7CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBhZGFwdGVyRnVuKG5hbWUsIGZ1bikgewogICAgcmV0dXJuIHV0aWxzLmFkYXB0ZXJGdW4obmFtZSwgdXRpbHMuZ2V0QXJndW1lbnRzKGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgIHNldHVwKCkudGhlbihmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgcmV0dXJuIGZ1bi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZSkgewogICAgICAgIHZhciBjYWxsYmFjayA9IGFyZ3MucG9wKCk7CiAgICAgICAgY2FsbGJhY2soZSk7CiAgICAgIH0pOwogICAgfSkpOwogIH0KCiAgdmFyIHNldHVwUHJvbWlzZTsKCiAgZnVuY3Rpb24gc2V0dXAoKSB7CiAgICAvLyBUT0RPOiBSZW1vdmUgYHNraXBTZXR1cGAgaW4gZmF2b3Igb2YgYHNraXBfc2V0dXBgIGluIGEgZnV0dXJlIHJlbGVhc2UKICAgIGlmIChvcHRzLnNraXBTZXR1cCB8fCBvcHRzLnNraXBfc2V0dXApIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpOwogICAgfQoKICAgIC8vIElmIHRoZXJlIGlzIGEgc2V0dXAgaW4gcHJvY2VzcyBvciBwcmV2aW91cyBzdWNjZXNzZnVsIHNldHVwCiAgICAvLyBkb25lIHRoZW4gd2Ugd2lsbCB1c2UgdGhhdAogICAgLy8gSWYgcHJldmlvdXMgc2V0dXBzIGhhdmUgYmVlbiByZWplY3RlZCB3ZSB3aWxsIHRyeSBhZ2FpbgogICAgaWYgKHNldHVwUHJvbWlzZSkgewogICAgICByZXR1cm4gc2V0dXBQcm9taXNlOwogICAgfQoKICAgIHZhciBjaGVja0V4aXN0cyA9IHttZXRob2Q6ICdHRVQnLCB1cmw6IGRiVXJsfTsKICAgIHZhciBjcmVhdGUgPSB7bWV0aG9kOiAnUFVUJywgdXJsOiBkYlVybH07CiAgICBzZXR1cFByb21pc2UgPSBhamF4UHJvbWlzZSh7fSwgY2hlY2tFeGlzdHMpLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICBpZiAoZXJyICYmIGVyci5zdGF0dXMgJiYgZXJyLnN0YXR1cyA9PT0gNDA0KSB7CiAgICAgICAgLy8gRG9lc250IGV4aXN0LCBjcmVhdGUgaXQKICAgICAgICB1dGlscy5leHBsYWluNDA0KCdQb3VjaERCIGlzIGp1c3QgZGV0ZWN0aW5nIGlmIHRoZSByZW1vdGUgZXhpc3RzLicpOwogICAgICAgIHJldHVybiBhamF4UHJvbWlzZSh7fSwgY3JlYXRlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKTsKICAgICAgfQogICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgIC8vIElmIHdlIGdldCBhbiBhdXRob3Jpc2F0aW9uIGVycm9yCiAgICAgIGlmIChlcnIgJiYgZXJyLnN0YXR1cyAmJiBlcnIuc3RhdHVzID09PSA0MDEpIHsKICAgICAgICByZXR1cm4gYWpheFByb21pc2Uoe30sIGNoZWNrRXhpc3RzKTsKICAgICAgfQogICAgICAvLyBJZiB3ZSB0cnkgdG8gY3JlYXRlIGEgZGF0YWJhc2UgdGhhdCBhbHJlYWR5IGV4aXN0cwogICAgICBpZiAoZXJyICYmIGVyci5zdGF0dXMgJiYgZXJyLnN0YXR1cyA9PT0gNDEyKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycik7CiAgICB9KTsKCiAgICBzZXR1cFByb21pc2UuY2F0Y2goZnVuY3Rpb24oKSB7CiAgICAgIHNldHVwUHJvbWlzZSA9IG51bGw7CiAgICB9KTsKCiAgICByZXR1cm4gc2V0dXBQcm9taXNlOwogIH0KCiAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgIGNhbGxiYWNrKG51bGwsIGFwaSk7CiAgfSk7CgogIGFwaS50eXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuICdodHRwJzsKICB9OwoKICBhcGkuaWQgPSBhZGFwdGVyRnVuKCdpZCcsIGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgYWpheCh7fSwge21ldGhvZDogJ0dFVCcsIHVybDogZ2VuVXJsKGhvc3QsICcnKX0sIGZ1bmN0aW9uIChlcnIsIHJlc3VsdCkgewogICAgICB2YXIgdXVpZCA9IChyZXN1bHQgJiYgcmVzdWx0LnV1aWQpID8KICAgICAgICAocmVzdWx0LnV1aWQgKyBob3N0LmRiKSA6IGdlbkRCVXJsKGhvc3QsICcnKTsKICAgICAgY2FsbGJhY2sobnVsbCwgdXVpZCk7CiAgICB9KTsKICB9KTsKCiAgYXBpLnJlcXVlc3QgPSBhZGFwdGVyRnVuKCdyZXF1ZXN0JywgZnVuY3Rpb24gKG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgICBvcHRpb25zLnVybCA9IGdlbkRCVXJsKGhvc3QsIG9wdGlvbnMudXJsKTsKICAgIGFqYXgoe30sIG9wdGlvbnMsIGNhbGxiYWNrKTsKICB9KTsKCiAgLy8gU2VuZHMgYSBQT1NUIHJlcXVlc3QgdG8gdGhlIGhvc3QgY2FsbGluZyB0aGUgY291Y2hkYiBfY29tcGFjdCBmdW5jdGlvbgogIC8vICAgIHZlcnNpb246IFRoZSB2ZXJzaW9uIG9mIENvdWNoREIgaXQgaXMgcnVubmluZwogIGFwaS5jb21wYWN0ID0gYWRhcHRlckZ1bignY29tcGFjdCcsIGZ1bmN0aW9uIChvcHRzLCBjYWxsYmFjaykgewogICAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNhbGxiYWNrID0gb3B0czsKICAgICAgb3B0cyA9IHt9OwogICAgfQogICAgb3B0cyA9IGNsb25lKG9wdHMpOwogICAgYWpheChvcHRzLCB7CiAgICAgIHVybDogZ2VuREJVcmwoaG9zdCwgJ19jb21wYWN0JyksCiAgICAgIG1ldGhvZDogJ1BPU1QnCiAgICB9LCBmdW5jdGlvbiAoKSB7CiAgICAgIGZ1bmN0aW9uIHBpbmcoKSB7CiAgICAgICAgYXBpLmluZm8oZnVuY3Rpb24gKGVyciwgcmVzKSB7CiAgICAgICAgICBpZiAoIXJlcy5jb21wYWN0X3J1bm5pbmcpIHsKICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwge29rOiB0cnVlfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXRUaW1lb3V0KHBpbmcsIG9wdHMuaW50ZXJ2YWwgfHwgMjAwKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICAvLyBQaW5nIHRoZSBodHRwIGlmIGl0J3MgZmluaXNoZWQgY29tcGFjdGlvbgogICAgICBwaW5nKCk7CiAgICB9KTsKICB9KTsKCiAgYXBpLmJ1bGtHZXQgPSB1dGlscy5hZGFwdGVyRnVuKCdidWxrR2V0JywgZnVuY3Rpb24gKG9wdHMsIGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgZnVuY3Rpb24gZG9CdWxrR2V0KGNiKSB7CiAgICAgIHZhciBwYXJhbXMgPSBbXTsKICAgICAgaWYgKG9wdHMucmV2cykgewogICAgICAgIHBhcmFtcy5wdXNoKCdyZXZzPXRydWUnKTsKICAgICAgfQogICAgICBpZiAob3B0cy5hdHRhY2htZW50cykgewogICAgICAgIHBhcmFtcy5wdXNoKCdhdHRhY2htZW50cz10cnVlJyk7CiAgICAgIH0KICAgICAgcGFyYW1zID0gcGFyYW1zLmpvaW4oJyYnKTsKICAgICAgaWYgKHBhcmFtcyAhPT0gJycpIHsKICAgICAgICBwYXJhbXMgPSAnPycgKyBwYXJhbXM7CiAgICAgIH0KCiAgICAgIGFqYXgoe30sIHsKICAgICAgICBoZWFkZXJzOiBob3N0LmhlYWRlcnMsCiAgICAgICAgdXJsOiBnZW5EQlVybChob3N0LCAnX2J1bGtfZ2V0JyArIHBhcmFtcyksCiAgICAgICAgbWV0aG9kOiAnUE9TVCcsCiAgICAgICAgYm9keTogeyBkb2NzOiBvcHRzLmRvY3N9CiAgICAgIH0sIGNiKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkb0J1bGtHZXRTaGltKCkgewogICAgICBpZiAoIW9wdHMuZG9jcy5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwge3Jlc3VsdHM6IFtdfSk7CiAgICAgIH0KCiAgICAgIC8vIGF2b2lkICJ1cmwgdG9vIGxvbmcgZXJyb3IiIGJ5IHNwbGl0dGluZyB1cCBpbnRvIG11bHRpcGxlIHJlcXVlc3RzCiAgICAgIHZhciBiYXRjaFNpemUgPSBNQVhfU0lNVUxUQU5FT1VTX1JFVlM7CiAgICAgIHZhciBudW1CYXRjaGVzID0gTWF0aC5jZWlsKG9wdHMuZG9jcy5sZW5ndGggLyBiYXRjaFNpemUpOwogICAgICB2YXIgbnVtRG9uZSA9IDA7CiAgICAgIHZhciByZXN1bHRzID0gbmV3IEFycmF5KG51bUJhdGNoZXMpOwoKICAgICAgZnVuY3Rpb24gb25SZXN1bHQoYmF0Y2hOdW0pIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGVyciwgcmVzKSB7CiAgICAgICAgICAvLyBlcnIgaXMgaW1wb3NzaWJsZSBiZWNhdXNlIHNoaW0gcmV0dXJucyBhIGxpc3Qgb2YgZXJycyBpbiB0aGF0IGNhc2UKICAgICAgICAgIHJlc3VsdHNbYmF0Y2hOdW1dID0gcmVzLnJlc3VsdHM7CiAgICAgICAgICBpZiAoKytudW1Eb25lID09PSBudW1CYXRjaGVzKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHtyZXN1bHRzOiBmbGF0dGVuKHJlc3VsdHMpfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBudW1CYXRjaGVzOyBpKyspIHsKICAgICAgICB2YXIgc3ViT3B0cyA9IHV0aWxzLnBpY2sob3B0cywgWydyZXZzJywgJ2F0dGFjaG1lbnRzJ10pOwogICAgICAgIHN1Yk9wdHMuZG9jcyA9IG9wdHMuZG9jcy5zbGljZShpICogYmF0Y2hTaXplLAogICAgICAgICAgTWF0aC5taW4ob3B0cy5kb2NzLmxlbmd0aCwgKGkgKyAxKSAqIGJhdGNoU2l6ZSkpOwogICAgICAgIGJ1bGtHZXRTaGltKHNlbGYsIHN1Yk9wdHMsIG9uUmVzdWx0KGkpKTsKICAgICAgfQogICAgfQoKICAgIC8vIG1hcmsgdGhlIHdob2xlIGRhdGFiYXNlIGFzIGVpdGhlciBzdXBwb3J0aW5nIG9yIG5vdCBzdXBwb3J0aW5nIF9idWxrX2dldAogICAgdmFyIGRiVXJsID0gZ2VuVXJsKGhvc3QsICcnKTsKICAgIHZhciBzdXBwb3J0c0J1bGtHZXQgPSBzdXBwb3J0c0J1bGtHZXRNYXBbZGJVcmxdOwoKICAgIGlmICh0eXBlb2Ygc3VwcG9ydHNCdWxrR2V0ICE9PSAnYm9vbGVhbicpIHsKICAgICAgLy8gY2hlY2sgaWYgdGhpcyBkYXRhYmFzZSBzdXBwb3J0cyBfYnVsa19nZXQKICAgICAgZG9CdWxrR2V0KGZ1bmN0aW9uIChlcnIsIHJlcykgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIGlmIChNYXRoLmZsb29yKGVyci5zdGF0dXMgLyAxMDApID09PSA0KSB7IC8vIDQweAogICAgICAgICAgICBzdXBwb3J0c0J1bGtHZXRNYXBbZGJVcmxdID0gZmFsc2U7CiAgICAgICAgICAgIGRvQnVsa0dldFNoaW0oKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN1cHBvcnRzQnVsa0dldE1hcFtkYlVybF0gPSB0cnVlOwogICAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChzdXBwb3J0c0J1bGtHZXQpIHsKICAgICAgZG9CdWxrR2V0KGNhbGxiYWNrKTsKICAgIH0gZWxzZSB7CiAgICAgIGRvQnVsa0dldFNoaW0oKTsKICAgIH0KICB9KTsKCiAgLy8gQ2FsbHMgR0VUIG9uIHRoZSBob3N0LCB3aGljaCBnZXRzIGJhY2sgYSBKU09OIHN0cmluZyBjb250YWluaW5nCiAgLy8gICAgY291Y2hkYjogQSB3ZWxjb21lIHN0cmluZwogIC8vICAgIHZlcnNpb246IFRoZSB2ZXJzaW9uIG9mIENvdWNoREIgaXQgaXMgcnVubmluZwogIGFwaS5faW5mbyA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgc2V0dXAoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBhamF4KHt9LCB7CiAgICAgICAgbWV0aG9kOiAnR0VUJywKICAgICAgICB1cmw6IGdlbkRCVXJsKGhvc3QsICcnKQogICAgICB9LCBmdW5jdGlvbiAoZXJyLCByZXMpIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICAgIGlmIChlcnIpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKICAgICAgICB9CiAgICAgICAgcmVzLmhvc3QgPSBnZW5EQlVybChob3N0LCAnJyk7CiAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzKTsKICAgICAgfSk7CiAgICB9KS5jYXRjaChjYWxsYmFjayk7CiAgfTsKCiAgLy8gR2V0IHRoZSBkb2N1bWVudCB3aXRoIHRoZSBnaXZlbiBpZCBmcm9tIHRoZSBkYXRhYmFzZSBnaXZlbiBieSBob3N0LgogIC8vIFRoZSBpZCBjb3VsZCBiZSBzb2xlbHkgdGhlIF9pZCBpbiB0aGUgZGF0YWJhc2UsIG9yIGl0IG1heSBiZSBhCiAgLy8gX2Rlc2lnbi9JRCBvciBfbG9jYWwvSUQgcGF0aAogIGFwaS5nZXQgPSBhZGFwdGVyRnVuKCdnZXQnLCBmdW5jdGlvbiAoaWQsIG9wdHMsIGNhbGxiYWNrKSB7CiAgICAvLyBJZiBubyBvcHRpb25zIHdlcmUgZ2l2ZW4sIHNldCB0aGUgY2FsbGJhY2sgdG8gdGhlIHNlY29uZCBwYXJhbWV0ZXIKICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYWxsYmFjayA9IG9wdHM7CiAgICAgIG9wdHMgPSB7fTsKICAgIH0KICAgIG9wdHMgPSBjbG9uZShvcHRzKTsKCiAgICAvLyBMaXN0IG9mIHBhcmFtZXRlcnMgdG8gYWRkIHRvIHRoZSBHRVQgcmVxdWVzdAogICAgdmFyIHBhcmFtcyA9IFtdOwoKICAgIC8vIElmIGl0IGV4aXN0cywgYWRkIHRoZSBvcHRzLnJldnMgdmFsdWUgdG8gdGhlIGxpc3Qgb2YgcGFyYW1ldGVycy4KICAgIC8vIElmIHJldnM9dHJ1ZSB0aGVuIHRoZSByZXN1bHRpbmcgSlNPTiB3aWxsIGluY2x1ZGUgYSBmaWVsZAogICAgLy8gX3JldmlzaW9ucyBjb250YWluaW5nIGFuIGFycmF5IG9mIHRoZSByZXZpc2lvbiBJRHMuCiAgICBpZiAob3B0cy5yZXZzKSB7CiAgICAgIHBhcmFtcy5wdXNoKCdyZXZzPXRydWUnKTsKICAgIH0KCiAgICAvLyBJZiBpdCBleGlzdHMsIGFkZCB0aGUgb3B0cy5yZXZzX2luZm8gdmFsdWUgdG8gdGhlIGxpc3Qgb2YgcGFyYW1ldGVycy4KICAgIC8vIElmIHJldnNfaW5mbz10cnVlIHRoZW4gdGhlIHJlc3VsdGluZyBKU09OIHdpbGwgaW5jbHVkZSB0aGUgZmllbGQKICAgIC8vIF9yZXZzX2luZm8gY29udGFpbmluZyBhbiBhcnJheSBvZiBvYmplY3RzIGluIHdoaWNoIGVhY2ggb2JqZWN0CiAgICAvLyByZXByZXNlbnRpbmcgYW4gYXZhaWxhYmxlIHJldmlzaW9uLgogICAgaWYgKG9wdHMucmV2c19pbmZvKSB7CiAgICAgIHBhcmFtcy5wdXNoKCdyZXZzX2luZm89dHJ1ZScpOwogICAgfQoKICAgIC8vIElmIGl0IGV4aXN0cywgYWRkIHRoZSBvcHRzLm9wZW5fcmV2cyB2YWx1ZSB0byB0aGUgbGlzdCBvZiBwYXJhbWV0ZXJzLgogICAgLy8gSWYgb3Blbl9yZXZzPWFsbCB0aGVuIHRoZSByZXN1bHRpbmcgSlNPTiB3aWxsIGluY2x1ZGUgYWxsIHRoZSBsZWFmCiAgICAvLyByZXZpc2lvbnMuIElmIG9wZW5fcmV2cz1bInJldjEiLCAicmV2MiIsLi4uXSB0aGVuIHRoZSByZXN1bHRpbmcgSlNPTgogICAgLy8gd2lsbCBjb250YWluIGFuIGFycmF5IG9mIG9iamVjdHMgY29udGFpbmluZyBkYXRhIG9mIGFsbCByZXZpc2lvbnMKICAgIGlmIChvcHRzLm9wZW5fcmV2cykgewogICAgICBpZiAob3B0cy5vcGVuX3JldnMgIT09ICJhbGwiKSB7CiAgICAgICAgb3B0cy5vcGVuX3JldnMgPSBKU09OLnN0cmluZ2lmeShvcHRzLm9wZW5fcmV2cyk7CiAgICAgIH0KICAgICAgcGFyYW1zLnB1c2goJ29wZW5fcmV2cz0nICsgb3B0cy5vcGVuX3JldnMpOwogICAgfQoKICAgIC8vIElmIGl0IGV4aXN0cywgYWRkIHRoZSBvcHRzLnJldiB2YWx1ZSB0byB0aGUgbGlzdCBvZiBwYXJhbWV0ZXJzLgogICAgLy8gSWYgcmV2IGlzIGdpdmVuIGEgcmV2aXNpb24gbnVtYmVyIHRoZW4gZ2V0IHRoZSBzcGVjaWZpZWQgcmV2aXNpb24uCiAgICBpZiAob3B0cy5yZXYpIHsKICAgICAgcGFyYW1zLnB1c2goJ3Jldj0nICsgb3B0cy5yZXYpOwogICAgfQoKICAgIC8vIElmIGl0IGV4aXN0cywgYWRkIHRoZSBvcHRzLmNvbmZsaWN0cyB2YWx1ZSB0byB0aGUgbGlzdCBvZiBwYXJhbWV0ZXJzLgogICAgLy8gSWYgY29uZmxpY3RzPXRydWUgdGhlbiB0aGUgcmVzdWx0aW5nIEpTT04gd2lsbCBpbmNsdWRlIHRoZSBmaWVsZAogICAgLy8gX2NvbmZsaWN0cyBjb250YWluaW5nIGFsbCB0aGUgY29uZmxpY3RpbmcgcmV2aXNpb25zLgogICAgaWYgKG9wdHMuY29uZmxpY3RzKSB7CiAgICAgIHBhcmFtcy5wdXNoKCdjb25mbGljdHM9JyArIG9wdHMuY29uZmxpY3RzKTsKICAgIH0KCiAgICAvLyBGb3JtYXQgdGhlIGxpc3Qgb2YgcGFyYW1ldGVycyBpbnRvIGEgdmFsaWQgVVJJIHF1ZXJ5IHN0cmluZwogICAgcGFyYW1zID0gcGFyYW1zLmpvaW4oJyYnKTsKICAgIHBhcmFtcyA9IHBhcmFtcyA9PT0gJycgPyAnJyA6ICc/JyArIHBhcmFtczsKCiAgICBpZCA9IGVuY29kZURvY0lkKGlkKTsKCiAgICAvLyBTZXQgdGhlIG9wdGlvbnMgZm9yIHRoZSBhamF4IGNhbGwKICAgIHZhciBvcHRpb25zID0gewogICAgICBtZXRob2Q6ICdHRVQnLAogICAgICB1cmw6IGdlbkRCVXJsKGhvc3QsIGlkICsgcGFyYW1zKQogICAgfTsKCiAgICBmdW5jdGlvbiBmZXRjaEF0dGFjaG1lbnRzKGRvYykgewogICAgICB2YXIgYXR0cyA9IGRvYy5fYXR0YWNobWVudHM7CiAgICAgIHZhciBmaWxlbmFtZXMgPSBhdHRzICYmIE9iamVjdC5rZXlzKGF0dHMpOwogICAgICBpZiAoIWF0dHMgfHwgIWZpbGVuYW1lcy5sZW5ndGgpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gd2UgZmV0Y2ggdGhlc2UgbWFudWFsbHkgaW4gc2VwYXJhdGUgWEhScywgYmVjYXVzZQogICAgICAvLyBTeW5jIEdhdGV3YXkgd291bGQgbm9ybWFsbHkgc2VuZCBpdCBiYWNrIGFzIG11bHRpcGFydC9taXhlZCwKICAgICAgLy8gd2hpY2ggd2UgY2Fubm90IHBhcnNlLiBBbHNvLCB0aGlzIGlzIG1vcmUgZWZmaWNpZW50IHRoYW4KICAgICAgLy8gcmVjZWl2aW5nIGF0dGFjaG1lbnRzIGFzIGJhc2U2NC1lbmNvZGVkIHN0cmluZ3MuCiAgICAgIHJldHVybiBQcm9taXNlLmFsbChmaWxlbmFtZXMubWFwKGZ1bmN0aW9uIChmaWxlbmFtZSkgewogICAgICAgIHZhciBhdHQgPSBhdHRzW2ZpbGVuYW1lXTsKICAgICAgICB2YXIgcGF0aCA9IGVuY29kZURvY0lkKGRvYy5faWQpICsgJy8nICsgZW5jb2RlQXR0YWNobWVudElkKGZpbGVuYW1lKSArCiAgICAgICAgICAnP3Jldj0nICsgZG9jLl9yZXY7CiAgICAgICAgcmV0dXJuIGFqYXhQcm9taXNlKG9wdHMsIHsKICAgICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgICB1cmw6IGdlbkRCVXJsKGhvc3QsIHBhdGgpLAogICAgICAgICAgYmluYXJ5OiB0cnVlCiAgICAgICAgfSkudGhlbihmdW5jdGlvbiAoYmxvYikgewogICAgICAgICAgaWYgKG9wdHMuYmluYXJ5KSB7CiAgICAgICAgICAgIHJldHVybiBibG9iOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJsdWZmZXJUb0Jhc2U2NChibG9iKTsKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBkZWxldGUgYXR0LnN0dWI7CiAgICAgICAgICBkZWxldGUgYXR0Lmxlbmd0aDsKICAgICAgICAgIGF0dC5kYXRhID0gZGF0YTsKICAgICAgICB9KTsKICAgICAgfSkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGZldGNoQWxsQXR0YWNobWVudHMoZG9jT3JEb2NzKSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGRvY09yRG9jcykpIHsKICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoZG9jT3JEb2NzLm1hcChmdW5jdGlvbiAoZG9jKSB7CiAgICAgICAgICBpZiAoZG9jLm9rKSB7CiAgICAgICAgICAgIHJldHVybiBmZXRjaEF0dGFjaG1lbnRzKGRvYy5vayk7CiAgICAgICAgICB9CiAgICAgICAgfSkpOwogICAgICB9CiAgICAgIHJldHVybiBmZXRjaEF0dGFjaG1lbnRzKGRvY09yRG9jcyk7CiAgICB9CgogICAgYWpheFByb21pc2Uob3B0cywgb3B0aW9ucykudGhlbihmdW5jdGlvbiAocmVzKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAob3B0cy5hdHRhY2htZW50cykgewogICAgICAgICAgcmV0dXJuIGZldGNoQWxsQXR0YWNobWVudHMocmVzKTsKICAgICAgICB9CiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIGNhbGxiYWNrKG51bGwsIHJlcyk7CiAgICAgIH0pOwogICAgfSkuY2F0Y2goY2FsbGJhY2spOwogIH0pOwoKICAvLyBEZWxldGUgdGhlIGRvY3VtZW50IGdpdmVuIGJ5IGRvYyBmcm9tIHRoZSBkYXRhYmFzZSBnaXZlbiBieSBob3N0LgogIGFwaS5yZW1vdmUgPSBhZGFwdGVyRnVuKCdyZW1vdmUnLAogICAgICBmdW5jdGlvbiAoZG9jT3JJZCwgb3B0c09yUmV2LCBvcHRzLCBjYWxsYmFjaykgewogICAgdmFyIGRvYzsKICAgIGlmICh0eXBlb2Ygb3B0c09yUmV2ID09PSAnc3RyaW5nJykgewogICAgICAvLyBpZCwgcmV2LCBvcHRzLCBjYWxsYmFjayBzdHlsZQogICAgICBkb2MgPSB7CiAgICAgICAgX2lkOiBkb2NPcklkLAogICAgICAgIF9yZXY6IG9wdHNPclJldgogICAgICB9OwogICAgICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjYWxsYmFjayA9IG9wdHM7CiAgICAgICAgb3B0cyA9IHt9OwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBkb2MsIG9wdHMsIGNhbGxiYWNrIHN0eWxlCiAgICAgIGRvYyA9IGRvY09ySWQ7CiAgICAgIGlmICh0eXBlb2Ygb3B0c09yUmV2ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBvcHRzT3JSZXY7CiAgICAgICAgb3B0cyA9IHt9OwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrID0gb3B0czsKICAgICAgICBvcHRzID0gb3B0c09yUmV2OwogICAgICB9CiAgICB9CgogICAgdmFyIHJldiA9IChkb2MuX3JldiB8fCBvcHRzLnJldik7CgogICAgLy8gRGVsZXRlIHRoZSBkb2N1bWVudAogICAgYWpheChvcHRzLCB7CiAgICAgIG1ldGhvZDogJ0RFTEVURScsCiAgICAgIHVybDogZ2VuREJVcmwoaG9zdCwgZW5jb2RlRG9jSWQoZG9jLl9pZCkpICsgJz9yZXY9JyArIHJldgogICAgfSwgY2FsbGJhY2spOwogIH0pOwoKICBmdW5jdGlvbiBlbmNvZGVBdHRhY2htZW50SWQoYXR0YWNobWVudElkKSB7CiAgICByZXR1cm4gYXR0YWNobWVudElkLnNwbGl0KCIvIikubWFwKGVuY29kZVVSSUNvbXBvbmVudCkuam9pbigiLyIpOwogIH0KCiAgLy8gR2V0IHRoZSBhdHRhY2htZW50CiAgYXBpLmdldEF0dGFjaG1lbnQgPQogICAgYWRhcHRlckZ1bignZ2V0QXR0YWNobWVudCcsIGZ1bmN0aW9uIChkb2NJZCwgYXR0YWNobWVudElkLCBvcHRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaykgewogICAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNhbGxiYWNrID0gb3B0czsKICAgICAgb3B0cyA9IHt9OwogICAgfQogICAgdmFyIHBhcmFtcyA9IG9wdHMucmV2ID8gKCc/cmV2PScgKyBvcHRzLnJldikgOiAnJzsKICAgIHZhciB1cmwgPSBnZW5EQlVybChob3N0LCBlbmNvZGVEb2NJZChkb2NJZCkpICsgJy8nICsKICAgICAgZW5jb2RlQXR0YWNobWVudElkKGF0dGFjaG1lbnRJZCkgKyBwYXJhbXM7CiAgICBhamF4KG9wdHMsIHsKICAgICAgbWV0aG9kOiAnR0VUJywKICAgICAgdXJsOiB1cmwsCiAgICAgIGJpbmFyeTogdHJ1ZQogICAgfSwgY2FsbGJhY2spOwogIH0pOwoKICAvLyBSZW1vdmUgdGhlIGF0dGFjaG1lbnQgZ2l2ZW4gYnkgdGhlIGlkIGFuZCByZXYKICBhcGkucmVtb3ZlQXR0YWNobWVudCA9CiAgICBhZGFwdGVyRnVuKCdyZW1vdmVBdHRhY2htZW50JywgZnVuY3Rpb24gKGRvY0lkLCBhdHRhY2htZW50SWQsIHJldiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2spIHsKCiAgICB2YXIgdXJsID0gZ2VuREJVcmwoaG9zdCwgZW5jb2RlRG9jSWQoZG9jSWQpICsgJy8nICsKICAgICAgZW5jb2RlQXR0YWNobWVudElkKGF0dGFjaG1lbnRJZCkpICsgJz9yZXY9JyArIHJldjsKCiAgICBhamF4KHt9LCB7CiAgICAgIG1ldGhvZDogJ0RFTEVURScsCiAgICAgIHVybDogdXJsCiAgICB9LCBjYWxsYmFjayk7CiAgfSk7CgogIC8vIEFkZCB0aGUgYXR0YWNobWVudCBnaXZlbiBieSBibG9iIGFuZCBpdHMgY29udGVudFR5cGUgcHJvcGVydHkKICAvLyB0byB0aGUgZG9jdW1lbnQgd2l0aCB0aGUgZ2l2ZW4gaWQsIHRoZSByZXZpc2lvbiBnaXZlbiBieSByZXYsIGFuZAogIC8vIGFkZCBpdCB0byB0aGUgZGF0YWJhc2UgZ2l2ZW4gYnkgaG9zdC4KICBhcGkucHV0QXR0YWNobWVudCA9CiAgICBhZGFwdGVyRnVuKCdwdXRBdHRhY2htZW50JywgZnVuY3Rpb24gKGRvY0lkLCBhdHRhY2htZW50SWQsIHJldiwgYmxvYiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSwgY2FsbGJhY2spIHsKICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYWxsYmFjayA9IHR5cGU7CiAgICAgIHR5cGUgPSBibG9iOwogICAgICBibG9iID0gcmV2OwogICAgICByZXYgPSBudWxsOwogICAgfQogICAgdmFyIGlkID0gZW5jb2RlRG9jSWQoZG9jSWQpICsgJy8nICsgZW5jb2RlQXR0YWNobWVudElkKGF0dGFjaG1lbnRJZCk7CiAgICB2YXIgdXJsID0gZ2VuREJVcmwoaG9zdCwgaWQpOwogICAgaWYgKHJldikgewogICAgICB1cmwgKz0gJz9yZXY9JyArIHJldjsKICAgIH0KCiAgICBpZiAodHlwZW9mIGJsb2IgPT09ICdzdHJpbmcnKSB7CiAgICAgIHZhciBiaW5hcnk7CiAgICAgIHRyeSB7CiAgICAgICAgYmluYXJ5ID0gYXRvYihibG9iKTsKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgLy8gaXQncyBub3QgYmFzZTY0LWVuY29kZWQsIHNvIHRocm93IGVycm9yCiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycm9ycy5lcnJvcihlcnJvcnMuQkFEX0FSRywKICAgICAgICAgICAgICAgICAgICAgICAgJ0F0dGFjaG1lbnRzIG5lZWQgdG8gYmUgYmFzZTY0IGVuY29kZWQnKSk7CiAgICAgIH0KICAgICAgYmxvYiA9IGJpbmFyeSA/IGJpblN0cmluZ1RvQmx1ZmZlcihiaW5hcnksIHR5cGUpIDogJyc7CiAgICB9CgogICAgdmFyIG9wdHMgPSB7CiAgICAgIGhlYWRlcnM6IHsnQ29udGVudC1UeXBlJzogdHlwZX0sCiAgICAgIG1ldGhvZDogJ1BVVCcsCiAgICAgIHVybDogdXJsLAogICAgICBwcm9jZXNzRGF0YTogZmFsc2UsCiAgICAgIGJvZHk6IGJsb2IsCiAgICAgIHRpbWVvdXQ6IGFqYXhPcHRzLnRpbWVvdXQgfHwgNjAwMDAKICAgIH07CiAgICAvLyBBZGQgdGhlIGF0dGFjaG1lbnQKICAgIGFqYXgoe30sIG9wdHMsIGNhbGxiYWNrKTsKICB9KTsKCiAgLy8gQWRkIHRoZSBkb2N1bWVudCBnaXZlbiBieSBkb2MgKGluIEpTT04gc3RyaW5nIGZvcm1hdCkgdG8gdGhlIGRhdGFiYXNlCiAgLy8gZ2l2ZW4gYnkgaG9zdC4gVGhpcyBmYWlscyBpZiB0aGUgZG9jIGhhcyBubyBfaWQgZmllbGQuCiAgYXBpLnB1dCA9IGFkYXB0ZXJGdW4oJ3B1dCcsIHV0aWxzLmdldEFyZ3VtZW50cyhmdW5jdGlvbiAoYXJncykgewogICAgdmFyIHRlbXAsIHRlbXB0eXBlLCBvcHRzOwogICAgdmFyIGRvYyA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBjYWxsYmFjayA9IGFyZ3MucG9wKCk7CgogICAgaWYgKHR5cGVvZiBkb2MgIT09ICdvYmplY3QnIHx8IEFycmF5LmlzQXJyYXkoZG9jKSkgewogICAgICByZXR1cm4gY2FsbGJhY2soZXJyb3JzLmVycm9yKGVycm9ycy5OT1RfQU5fT0JKRUNUKSk7CiAgICB9CgogICAgdmFyIGlkID0gJ19pZCcgaW4gZG9jOwogICAgZG9jID0gY2xvbmUoZG9jKTsKCiAgICBwcmVwcm9jZXNzQXR0YWNobWVudHMoZG9jKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICB0ZW1wID0gYXJncy5zaGlmdCgpOwogICAgICAgIHRlbXB0eXBlID0gdHlwZW9mIHRlbXA7CiAgICAgICAgaWYgKHRlbXB0eXBlID09PSAic3RyaW5nIiAmJiAhaWQpIHsKICAgICAgICAgIGRvYy5faWQgPSB0ZW1wOwogICAgICAgICAgaWQgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAodGVtcHR5cGUgPT09ICJzdHJpbmciICYmIGlkICYmICEoJ19yZXYnIGluIGRvYykpIHsKICAgICAgICAgIGRvYy5fcmV2ID0gdGVtcDsKICAgICAgICB9IGVsc2UgaWYgKHRlbXB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgb3B0cyA9IGNsb25lKHRlbXApOwogICAgICAgIH0KICAgICAgICBpZiAoIWFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgb3B0cyA9IG9wdHMgfHwge307CgogICAgICAvLyBjaGVjayBmb3IgYW55IGVycm9ycwogICAgICAvLyBUT0RPOiByZW5hbWUgdGhpcyBmdW5jdGlvbgogICAgICBwYXJzZURvYy5pbnZhbGlkSWRFcnJvcihkb2MuX2lkKTsKCiAgICAgIC8vIExpc3Qgb2YgcGFyYW1ldGVyIHRvIGFkZCB0byB0aGUgUFVUIHJlcXVlc3QKICAgICAgdmFyIHBhcmFtcyA9IFtdOwoKICAgICAgLy8gSWYgaXQgZXhpc3RzLCBhZGQgdGhlIG9wdHMubmV3X2VkaXRzIHZhbHVlIHRvIHRoZSBsaXN0IG9mIHBhcmFtZXRlcnMuCiAgICAgIC8vIElmIG5ld19lZGl0cyA9IGZhbHNlIHRoZW4gdGhlIGRhdGFiYXNlIHdpbGwgTk9UIGFzc2lnbiB0aGlzIGRvY3VtZW50IGEKICAgICAgLy8gbmV3IHJldmlzaW9uIG51bWJlcgogICAgICBpZiAob3B0cyAmJiB0eXBlb2Ygb3B0cy5uZXdfZWRpdHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgcGFyYW1zLnB1c2goJ25ld19lZGl0cz0nICsgb3B0cy5uZXdfZWRpdHMpOwogICAgICB9CgogICAgICAvLyBGb3JtYXQgdGhlIGxpc3Qgb2YgcGFyYW1ldGVycyBpbnRvIGEgdmFsaWQgVVJJIHF1ZXJ5IHN0cmluZwogICAgICBwYXJhbXMgPSBwYXJhbXMuam9pbignJicpOwogICAgICBpZiAocGFyYW1zICE9PSAnJykgewogICAgICAgIHBhcmFtcyA9ICc/JyArIHBhcmFtczsKICAgICAgfQoKICAgICAgdmFyIGFqYXhPcHRzID0gewogICAgICAgIG1ldGhvZDogJ1BVVCcsCiAgICAgICAgdXJsOiBnZW5EQlVybChob3N0LCBlbmNvZGVEb2NJZChkb2MuX2lkKSkgKyBwYXJhbXMsCiAgICAgICAgYm9keTogZG9jCiAgICAgIH07CgogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGhhc05vblN0dWJBdHRhY2htZW50cyA9IGRvYy5fYXR0YWNobWVudHMgJiYKICAgICAgICAgIE9iamVjdC5rZXlzKGRvYy5fYXR0YWNobWVudHMpLmZpbHRlcihmdW5jdGlvbiAoYXR0KSB7CiAgICAgICAgICAgIHJldHVybiAhZG9jLl9hdHRhY2htZW50c1thdHRdLnN0dWI7CiAgICAgICAgICB9KS5sZW5ndGg7CiAgICAgICAgaWYgKGhhc05vblN0dWJBdHRhY2htZW50cykgewogICAgICAgICAgLy8gdXNlIG11bHRpcGFydC9yZWxhdGVkIGZvciBtb3JlIGVmZmljaWVudCBhdHRhY2htZW50IHVwbG9hZGluZwogICAgICAgICAgdmFyIG11bHRpcGFydCA9IGNyZWF0ZU11bHRpcGFydChkb2MpOwogICAgICAgICAgYWpheE9wdHMuYm9keSA9IG11bHRpcGFydC5ib2R5OwogICAgICAgICAgYWpheE9wdHMucHJvY2Vzc0RhdGEgPSBmYWxzZTsKICAgICAgICAgIGFqYXhPcHRzLmhlYWRlcnMgPSBtdWx0aXBhcnQuaGVhZGVyczsKICAgICAgICB9CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uICgpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RpZCB5b3UgZm9yZ2V0IHRvIGJhc2U2NC1lbmNvZGUgYW4gYXR0YWNobWVudD8nKTsKICAgICAgfSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGFqYXhQcm9taXNlKG9wdHMsIGFqYXhPcHRzKTsKICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgcmVzLm9rID0gdHJ1ZTsgLy8gc21vb3RocyBvdXQgY2xvdWRhbnQgbm90IGRvaW5nIHRoaXMKICAgICAgICBjYWxsYmFjayhudWxsLCByZXMpOwogICAgICB9KTsKICAgIH0pLmNhdGNoKGNhbGxiYWNrKTsKICB9KSk7CgogIC8vIEFkZCB0aGUgZG9jdW1lbnQgZ2l2ZW4gYnkgZG9jIChpbiBKU09OIHN0cmluZyBmb3JtYXQpIHRvIHRoZSBkYXRhYmFzZQogIC8vIGdpdmVuIGJ5IGhvc3QuIFRoaXMgZG9lcyBub3QgYXNzdW1lIHRoYXQgZG9jIGlzIGEgbmV3IGRvY3VtZW50CiAgLy8gKGkuZS4gZG9lcyBub3QgaGF2ZSBhIF9pZCBvciBhIF9yZXYgZmllbGQuKQogIGFwaS5wb3N0ID0gYWRhcHRlckZ1bigncG9zdCcsIGZ1bmN0aW9uIChkb2MsIG9wdHMsIGNhbGxiYWNrKSB7CiAgICAvLyBJZiBubyBvcHRpb25zIHdlcmUgZ2l2ZW4sIHNldCB0aGUgY2FsbGJhY2sgdG8gYmUgdGhlIHNlY29uZCBwYXJhbWV0ZXIKICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYWxsYmFjayA9IG9wdHM7CiAgICAgIG9wdHMgPSB7fTsKICAgIH0KICAgIG9wdHMgPSBjbG9uZShvcHRzKTsKICAgIGlmICh0eXBlb2YgZG9jICE9PSAnb2JqZWN0JykgewogICAgICByZXR1cm4gY2FsbGJhY2soZXJyb3JzLmVycm9yKGVycm9ycy5OT1RfQU5fT0JKRUNUKSk7CiAgICB9CiAgICBpZiAoISAoIl9pZCIgaW4gZG9jKSkgewogICAgICBkb2MuX2lkID0gdXRpbHMudXVpZCgpOwogICAgfQogICAgYXBpLnB1dChkb2MsIG9wdHMsIGZ1bmN0aW9uIChlcnIsIHJlcykgewogICAgICBpZiAoZXJyKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7CiAgICAgIH0KICAgICAgcmVzLm9rID0gdHJ1ZTsKICAgICAgY2FsbGJhY2sobnVsbCwgcmVzKTsKICAgIH0pOwogIH0pOwoKICAvLyBVcGRhdGUvY3JlYXRlIG11bHRpcGxlIGRvY3VtZW50cyBnaXZlbiBieSByZXEgaW4gdGhlIGRhdGFiYXNlCiAgLy8gZ2l2ZW4gYnkgaG9zdC4KICBhcGkuX2J1bGtEb2NzID0gZnVuY3Rpb24gKHJlcSwgb3B0cywgY2FsbGJhY2spIHsKICAgIC8vIElmIG5ld19lZGl0cz1mYWxzZSB0aGVuIGl0IHByZXZlbnRzIHRoZSBkYXRhYmFzZSBmcm9tIGNyZWF0aW5nCiAgICAvLyBuZXcgcmV2aXNpb24gbnVtYmVycyBmb3IgdGhlIGRvY3VtZW50cy4gSW5zdGVhZCBpdCBqdXN0IHVzZXMKICAgIC8vIHRoZSBvbGQgb25lcy4gVGhpcyBpcyB1c2VkIGluIGRhdGFiYXNlIHJlcGxpY2F0aW9uLgogICAgcmVxLm5ld19lZGl0cyA9IG9wdHMubmV3X2VkaXRzOwoKICAgIHNldHVwKCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBQcm9taXNlLmFsbChyZXEuZG9jcy5tYXAocHJlcHJvY2Vzc0F0dGFjaG1lbnRzKSk7CiAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgLy8gVXBkYXRlL2NyZWF0ZSB0aGUgZG9jdW1lbnRzCiAgICAgIGFqYXgob3B0cywgewogICAgICAgIG1ldGhvZDogJ1BPU1QnLAogICAgICAgIHVybDogZ2VuREJVcmwoaG9zdCwgJ19idWxrX2RvY3MnKSwKICAgICAgICBib2R5OiByZXEKICAgICAgfSwgZnVuY3Rpb24gKGVyciwgcmVzdWx0cykgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwogICAgICAgIH0KICAgICAgICByZXN1bHRzLmZvckVhY2goZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgICAgcmVzdWx0Lm9rID0gdHJ1ZTsgLy8gc21vb3RocyBvdXQgY2xvdWRhbnQgbm90IGFkZGluZyB0aGlzCiAgICAgICAgfSk7CiAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzdWx0cyk7CiAgICAgIH0pOwogICAgfSkuY2F0Y2goY2FsbGJhY2spOwogIH07CgogIC8vIEdldCBhIGxpc3Rpbmcgb2YgdGhlIGRvY3VtZW50cyBpbiB0aGUgZGF0YWJhc2UgZ2l2ZW4KICAvLyBieSBob3N0IGFuZCBvcmRlcmVkIGJ5IGluY3JlYXNpbmcgaWQuCiAgYXBpLmFsbERvY3MgPSBhZGFwdGVyRnVuKCdhbGxEb2NzJywgZnVuY3Rpb24gKG9wdHMsIGNhbGxiYWNrKSB7CiAgICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2FsbGJhY2sgPSBvcHRzOwogICAgICBvcHRzID0ge307CiAgICB9CiAgICBvcHRzID0gY2xvbmUob3B0cyk7CiAgICAvLyBMaXN0IG9mIHBhcmFtZXRlcnMgdG8gYWRkIHRvIHRoZSBHRVQgcmVxdWVzdAogICAgdmFyIHBhcmFtcyA9IFtdOwogICAgdmFyIGJvZHk7CiAgICB2YXIgbWV0aG9kID0gJ0dFVCc7CgogICAgaWYgKG9wdHMuY29uZmxpY3RzKSB7CiAgICAgIHBhcmFtcy5wdXNoKCdjb25mbGljdHM9dHJ1ZScpOwogICAgfQoKICAgIC8vIElmIG9wdHMuZGVzY2VuZGluZyBpcyB0cnV0aHkgYWRkIGl0IHRvIHBhcmFtcwogICAgaWYgKG9wdHMuZGVzY2VuZGluZykgewogICAgICBwYXJhbXMucHVzaCgnZGVzY2VuZGluZz10cnVlJyk7CiAgICB9CgogICAgLy8gSWYgb3B0cy5pbmNsdWRlX2RvY3MgZXhpc3RzLCBhZGQgdGhlIGluY2x1ZGVfZG9jcyB2YWx1ZSB0byB0aGUKICAgIC8vIGxpc3Qgb2YgcGFyYW1ldGVycy4KICAgIC8vIElmIGluY2x1ZGVfZG9jcz10cnVlIHRoZW4gaW5jbHVkZSB0aGUgYXNzb2NpYXRlZCBkb2N1bWVudCB3aXRoIGVhY2gKICAgIC8vIHJlc3VsdC4KICAgIGlmIChvcHRzLmluY2x1ZGVfZG9jcykgewogICAgICBwYXJhbXMucHVzaCgnaW5jbHVkZV9kb2NzPXRydWUnKTsKICAgIH0KCiAgICBpZiAob3B0cy5hdHRhY2htZW50cykgewogICAgICAvLyBhZGRlZCBpbiBDb3VjaERCIDEuNi4wCiAgICAgIHBhcmFtcy5wdXNoKCdhdHRhY2htZW50cz10cnVlJyk7CiAgICB9CgogICAgaWYgKG9wdHMua2V5KSB7CiAgICAgIHBhcmFtcy5wdXNoKCdrZXk9JyArIGVuY29kZVVSSUNvbXBvbmVudChKU09OLnN0cmluZ2lmeShvcHRzLmtleSkpKTsKICAgIH0KCiAgICBpZiAob3B0cy5zdGFydF9rZXkpIHsKICAgICAgb3B0cy5zdGFydGtleSA9IG9wdHMuc3RhcnRfa2V5OwogICAgfQoKICAgIC8vIElmIG9wdHMuc3RhcnRrZXkgZXhpc3RzLCBhZGQgdGhlIHN0YXJ0a2V5IHZhbHVlIHRvIHRoZSBsaXN0IG9mCiAgICAvLyBwYXJhbWV0ZXJzLgogICAgLy8gSWYgc3RhcnRrZXkgaXMgZ2l2ZW4gdGhlbiB0aGUgcmV0dXJuZWQgbGlzdCBvZiBkb2N1bWVudHMgd2lsbAogICAgLy8gc3RhcnQgd2l0aCB0aGUgZG9jdW1lbnQgd2hvc2UgaWQgaXMgc3RhcnRrZXkuCiAgICBpZiAob3B0cy5zdGFydGtleSkgewogICAgICBwYXJhbXMucHVzaCgnc3RhcnRrZXk9JyArCiAgICAgICAgZW5jb2RlVVJJQ29tcG9uZW50KEpTT04uc3RyaW5naWZ5KG9wdHMuc3RhcnRrZXkpKSk7CiAgICB9CgogICAgaWYgKG9wdHMuZW5kX2tleSkgewogICAgICBvcHRzLmVuZGtleSA9IG9wdHMuZW5kX2tleTsKICAgIH0KCiAgICAvLyBJZiBvcHRzLmVuZGtleSBleGlzdHMsIGFkZCB0aGUgZW5ka2V5IHZhbHVlIHRvIHRoZSBsaXN0IG9mIHBhcmFtZXRlcnMuCiAgICAvLyBJZiBlbmRrZXkgaXMgZ2l2ZW4gdGhlbiB0aGUgcmV0dXJuZWQgbGlzdCBvZiBkb2N1ZW1udHMgd2lsbAogICAgLy8gZW5kIHdpdGggdGhlIGRvY3VtZW50IHdob3NlIGlkIGlzIGVuZGtleS4KICAgIGlmIChvcHRzLmVuZGtleSkgewogICAgICBwYXJhbXMucHVzaCgnZW5ka2V5PScgKyBlbmNvZGVVUklDb21wb25lbnQoSlNPTi5zdHJpbmdpZnkob3B0cy5lbmRrZXkpKSk7CiAgICB9CgogICAgaWYgKHR5cGVvZiBvcHRzLmluY2x1c2l2ZV9lbmQgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHBhcmFtcy5wdXNoKCdpbmNsdXNpdmVfZW5kPScgKyAhIW9wdHMuaW5jbHVzaXZlX2VuZCk7CiAgICB9CgogICAgLy8gSWYgb3B0cy5saW1pdCBleGlzdHMsIGFkZCB0aGUgbGltaXQgdmFsdWUgdG8gdGhlIHBhcmFtZXRlciBsaXN0LgogICAgaWYgKHR5cGVvZiBvcHRzLmxpbWl0ICE9PSAndW5kZWZpbmVkJykgewogICAgICBwYXJhbXMucHVzaCgnbGltaXQ9JyArIG9wdHMubGltaXQpOwogICAgfQoKICAgIGlmICh0eXBlb2Ygb3B0cy5za2lwICE9PSAndW5kZWZpbmVkJykgewogICAgICBwYXJhbXMucHVzaCgnc2tpcD0nICsgb3B0cy5za2lwKTsKICAgIH0KCiAgICAvLyBGb3JtYXQgdGhlIGxpc3Qgb2YgcGFyYW1ldGVycyBpbnRvIGEgdmFsaWQgVVJJIHF1ZXJ5IHN0cmluZwogICAgcGFyYW1zID0gcGFyYW1zLmpvaW4oJyYnKTsKICAgIGlmIChwYXJhbXMgIT09ICcnKSB7CiAgICAgIHBhcmFtcyA9ICc/JyArIHBhcmFtczsKICAgIH0KCiAgICBpZiAodHlwZW9mIG9wdHMua2V5cyAhPT0gJ3VuZGVmaW5lZCcpIHsKCiAgICAgIHZhciBrZXlzQXNTdHJpbmcgPQogICAgICAgICdrZXlzPScgKyBlbmNvZGVVUklDb21wb25lbnQoSlNPTi5zdHJpbmdpZnkob3B0cy5rZXlzKSk7CiAgICAgIGlmIChrZXlzQXNTdHJpbmcubGVuZ3RoICsgcGFyYW1zLmxlbmd0aCArIDEgPD0gTUFYX1VSTF9MRU5HVEgpIHsKICAgICAgICAvLyBJZiB0aGUga2V5cyBhcmUgc2hvcnQgZW5vdWdoLCBkbyBhIEdFVC4gd2UgZG8gdGhpcyB0byB3b3JrIGFyb3VuZAogICAgICAgIC8vIFNhZmFyaSBub3QgdW5kZXJzdGFuZGluZyAzMDRzIG9uIFBPU1RzIChzZWUgaXNzdWUgIzEyMzkpCiAgICAgICAgcGFyYW1zICs9IChwYXJhbXMuaW5kZXhPZignPycpICE9PSAtMSA/ICcmJyA6ICc/JykgKyBrZXlzQXNTdHJpbmc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYga2V5cyBhcmUgdG9vIGxvbmcsIGlzc3VlIGEgUE9TVCByZXF1ZXN0IHRvIGNpcmN1bXZlbnQgR0VUCiAgICAgICAgLy8gcXVlcnkgc3RyaW5nIGxpbWl0cwogICAgICAgIC8vIHNlZSBodHRwOi8vd2lraS5hcGFjaGUub3JnL2NvdWNoZGIvSFRUUF92aWV3X0FQSSNRdWVyeWluZ19PcHRpb25zCiAgICAgICAgbWV0aG9kID0gJ1BPU1QnOwogICAgICAgIGJvZHkgPSB7a2V5czogb3B0cy5rZXlzfTsKICAgICAgfQogICAgfQoKICAgIC8vIEdldCB0aGUgZG9jdW1lbnQgbGlzdGluZwogICAgYWpheFByb21pc2Uob3B0cywgewogICAgICBtZXRob2Q6IG1ldGhvZCwKICAgICAgdXJsOiBnZW5EQlVybChob3N0LCAnX2FsbF9kb2NzJyArIHBhcmFtcyksCiAgICAgIGJvZHk6IGJvZHkKICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlcykgewogICAgICBpZiAob3B0cy5pbmNsdWRlX2RvY3MgJiYgb3B0cy5hdHRhY2htZW50cyAmJiBvcHRzLmJpbmFyeSkgewogICAgICAgIHJlcy5yb3dzLmZvckVhY2gocmVhZEF0dGFjaG1lbnRzQXNCbG9iT3JCdWZmZXIpOwogICAgICB9CiAgICAgIGNhbGxiYWNrKG51bGwsIHJlcyk7CiAgICB9KS5jYXRjaChjYWxsYmFjayk7CiAgfSk7CgogIC8vIEdldCBhIGxpc3Qgb2YgY2hhbmdlcyBtYWRlIHRvIGRvY3VtZW50cyBpbiB0aGUgZGF0YWJhc2UgZ2l2ZW4gYnkgaG9zdC4KICAvLyBUT0RPIEFjY29yZGluZyB0byB0aGUgUkVBRE1FLCB0aGVyZSBzaG91bGQgYmUgdHdvIG90aGVyIG1ldGhvZHMgaGVyZSwKICAvLyBhcGkuY2hhbmdlcy5hZGRMaXN0ZW5lciBhbmQgYXBpLmNoYW5nZXMucmVtb3ZlTGlzdGVuZXIuCiAgYXBpLl9jaGFuZ2VzID0gZnVuY3Rpb24gKG9wdHMpIHsKCiAgICAvLyBXZSBpbnRlcm5hbGx5IHBhZ2UgdGhlIHJlc3VsdHMgb2YgYSBjaGFuZ2VzIHJlcXVlc3QsIHRoaXMgbWVhbnMKICAgIC8vIGlmIHRoZXJlIGlzIGEgbGFyZ2Ugc2V0IG9mIGNoYW5nZXMgdG8gYmUgcmV0dXJuZWQgd2UgY2FuIHN0YXJ0CiAgICAvLyBwcm9jZXNzaW5nIHRoZW0gcXVpY2tlciBpbnN0ZWFkIG9mIHdhaXRpbmcgb24gdGhlIGVudGlyZQogICAgLy8gc2V0IG9mIGNoYW5nZXMgdG8gcmV0dXJuIGFuZCBhdHRlbXB0aW5nIHRvIHByb2Nlc3MgdGhlbSBhdCBvbmNlCiAgICB2YXIgYmF0Y2hTaXplID0gJ2JhdGNoX3NpemUnIGluIG9wdHMgPyBvcHRzLmJhdGNoX3NpemUgOiBDSEFOR0VTX0JBVENIX1NJWkU7CgogICAgb3B0cyA9IGNsb25lKG9wdHMpOwogICAgb3B0cy50aW1lb3V0ID0gb3B0cy50aW1lb3V0IHx8IGFqYXhPcHRzLnRpbWVvdXQgfHwgMzAgKiAxMDAwOwoKICAgIC8vIFdlIGdpdmUgYSA1IHNlY29uZCBidWZmZXIgZm9yIENvdWNoREIgY2hhbmdlcyB0byByZXNwb25kIHdpdGgKICAgIC8vIGFuIG9rIHRpbWVvdXQKICAgIHZhciBwYXJhbXMgPSB7IHRpbWVvdXQ6IG9wdHMudGltZW91dCAtICg1ICogMTAwMCkgfTsKICAgIHZhciBsaW1pdCA9ICh0eXBlb2Ygb3B0cy5saW1pdCAhPT0gJ3VuZGVmaW5lZCcpID8gb3B0cy5saW1pdCA6IGZhbHNlOwogICAgdmFyIHJldHVybkRvY3M7CiAgICBpZiAoJ3JldHVybkRvY3MnIGluIG9wdHMpIHsKICAgICAgcmV0dXJuRG9jcyA9IG9wdHMucmV0dXJuRG9jczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybkRvY3MgPSB0cnVlOwogICAgfQogICAgLy8KICAgIHZhciBsZWZ0VG9GZXRjaCA9IGxpbWl0OwoKICAgIGlmIChvcHRzLnN0eWxlKSB7CiAgICAgIHBhcmFtcy5zdHlsZSA9IG9wdHMuc3R5bGU7CiAgICB9CgogICAgaWYgKG9wdHMuaW5jbHVkZV9kb2NzIHx8IG9wdHMuZmlsdGVyICYmIHR5cGVvZiBvcHRzLmZpbHRlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBwYXJhbXMuaW5jbHVkZV9kb2NzID0gdHJ1ZTsKICAgIH0KCiAgICBpZiAob3B0cy5hdHRhY2htZW50cykgewogICAgICBwYXJhbXMuYXR0YWNobWVudHMgPSB0cnVlOwogICAgfQoKICAgIGlmIChvcHRzLmNvbnRpbnVvdXMpIHsKICAgICAgcGFyYW1zLmZlZWQgPSAnbG9uZ3BvbGwnOwogICAgfQoKICAgIGlmIChvcHRzLmNvbmZsaWN0cykgewogICAgICBwYXJhbXMuY29uZmxpY3RzID0gdHJ1ZTsKICAgIH0KCiAgICBpZiAob3B0cy5kZXNjZW5kaW5nKSB7CiAgICAgIHBhcmFtcy5kZXNjZW5kaW5nID0gdHJ1ZTsKICAgIH0KCiAgICBpZiAob3B0cy5maWx0ZXIgJiYgdHlwZW9mIG9wdHMuZmlsdGVyID09PSAnc3RyaW5nJykgewogICAgICBwYXJhbXMuZmlsdGVyID0gb3B0cy5maWx0ZXI7CiAgICAgIGlmIChvcHRzLmZpbHRlciA9PT0gJ192aWV3JyAmJgogICAgICAgICAgb3B0cy52aWV3ICYmCiAgICAgICAgICB0eXBlb2Ygb3B0cy52aWV3ID09PSAnc3RyaW5nJykgewogICAgICAgIHBhcmFtcy52aWV3ID0gb3B0cy52aWV3OwogICAgICB9CiAgICB9CgogICAgLy8gSWYgb3B0cy5xdWVyeV9wYXJhbXMgZXhpc3RzLCBwYXNzIGl0IHRocm91Z2ggdG8gdGhlIGNoYW5nZXMgcmVxdWVzdC4KICAgIC8vIFRoZXNlIHBhcmFtZXRlcnMgbWF5IGJlIHVzZWQgYnkgdGhlIGZpbHRlciBvbiB0aGUgc291cmNlIGRhdGFiYXNlLgogICAgaWYgKG9wdHMucXVlcnlfcGFyYW1zICYmIHR5cGVvZiBvcHRzLnF1ZXJ5X3BhcmFtcyA9PT0gJ29iamVjdCcpIHsKICAgICAgZm9yICh2YXIgcGFyYW1fbmFtZSBpbiBvcHRzLnF1ZXJ5X3BhcmFtcykgewogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICAgICAgaWYgKG9wdHMucXVlcnlfcGFyYW1zLmhhc093blByb3BlcnR5KHBhcmFtX25hbWUpKSB7CiAgICAgICAgICBwYXJhbXNbcGFyYW1fbmFtZV0gPSBvcHRzLnF1ZXJ5X3BhcmFtc1twYXJhbV9uYW1lXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICB2YXIgbWV0aG9kID0gJ0dFVCc7CiAgICB2YXIgYm9keTsKCiAgICBpZiAob3B0cy5kb2NfaWRzKSB7CiAgICAgIC8vIHNldCB0aGlzIGF1dG9tYWdpY2FsbHkgZm9yIHRoZSB1c2VyOyBpdCdzIGFubm95aW5nIHRoYXQgY291Y2hkYgogICAgICAvLyByZXF1aXJlcyBib3RoIGEgImZpbHRlciIgYW5kIGEgImRvY19pZHMiIHBhcmFtLgogICAgICBwYXJhbXMuZmlsdGVyID0gJ19kb2NfaWRzJzsKCiAgICAgIHZhciBkb2NJZHNKc29uID0gSlNPTi5zdHJpbmdpZnkob3B0cy5kb2NfaWRzKTsKCiAgICAgIGlmIChkb2NJZHNKc29uLmxlbmd0aCA8IE1BWF9VUkxfTEVOR1RIKSB7CiAgICAgICAgcGFyYW1zLmRvY19pZHMgPSBkb2NJZHNKc29uOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGFueXRoaW5nIGdyZWF0ZXIgdGhhbiB+MjAwMCBpcyB1bnNhZmUgZm9yIGdldHMsIHNvCiAgICAgICAgLy8gdXNlIFBPU1QgaW5zdGVhZAogICAgICAgIG1ldGhvZCA9ICdQT1NUJzsKICAgICAgICBib2R5ID0ge2RvY19pZHM6IG9wdHMuZG9jX2lkcyB9OwogICAgICB9CiAgICB9CgogICAgdmFyIHhocjsKICAgIHZhciBsYXN0RmV0Y2hlZFNlcTsKCiAgICAvLyBHZXQgYWxsIHRoZSBjaGFuZ2VzIHN0YXJ0aW5nIHd0aWggdGhlIG9uZSBpbW1lZGlhdGVseSBhZnRlciB0aGUKICAgIC8vIHNlcXVlbmNlIG51bWJlciBnaXZlbiBieSBzaW5jZS4KICAgIHZhciBmZXRjaCA9IGZ1bmN0aW9uIChzaW5jZSwgY2FsbGJhY2spIHsKICAgICAgaWYgKG9wdHMuYWJvcnRlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBwYXJhbXMuc2luY2UgPSBzaW5jZTsKICAgICAgLy8gInNpbmNlIiBjYW4gYmUgYW55IGtpbmQgb2YganNvbiBvYmplY3QgaW4gQ291ZGFudC9Db3VjaERCIDIueAogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICBpZiAodHlwZW9mIHBhcmFtcy5zaW5jZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICBwYXJhbXMuc2luY2UgPSBKU09OLnN0cmluZ2lmeShwYXJhbXMuc2luY2UpOwogICAgICB9CgogICAgICBpZiAob3B0cy5kZXNjZW5kaW5nKSB7CiAgICAgICAgaWYgKGxpbWl0KSB7CiAgICAgICAgICBwYXJhbXMubGltaXQgPSBsZWZ0VG9GZXRjaDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFyYW1zLmxpbWl0ID0gKCFsaW1pdCB8fCBsZWZ0VG9GZXRjaCA+IGJhdGNoU2l6ZSkgPwogICAgICAgICAgYmF0Y2hTaXplIDogbGVmdFRvRmV0Y2g7CiAgICAgIH0KCiAgICAgIHZhciBwYXJhbVN0ciA9ICc/JyArIE9iamVjdC5rZXlzKHBhcmFtcykubWFwKGZ1bmN0aW9uIChrKSB7CiAgICAgICAgcmV0dXJuIGsgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQocGFyYW1zW2tdKTsKICAgICAgfSkuam9pbignJicpOwoKICAgICAgLy8gU2V0IHRoZSBvcHRpb25zIGZvciB0aGUgYWpheCBjYWxsCiAgICAgIHZhciB4aHJPcHRzID0gewogICAgICAgIG1ldGhvZDogbWV0aG9kLAogICAgICAgIHVybDogZ2VuREJVcmwoaG9zdCwgJ19jaGFuZ2VzJyArIHBhcmFtU3RyKSwKICAgICAgICAvLyBfY2hhbmdlcyBjYW4gdGFrZSBhIGxvbmcgdGltZSB0byBnZW5lcmF0ZSwgZXNwZWNpYWxseSB3aGVuIGZpbHRlcmVkCiAgICAgICAgdGltZW91dDogb3B0cy50aW1lb3V0LAogICAgICAgIGJvZHk6IGJvZHkKICAgICAgfTsKICAgICAgbGFzdEZldGNoZWRTZXEgPSBzaW5jZTsKCiAgICAgIGlmIChvcHRzLmFib3J0ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIEdldCB0aGUgY2hhbmdlcwogICAgICBzZXR1cCgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgeGhyID0gYWpheChvcHRzLCB4aHJPcHRzLCBjYWxsYmFjayk7CiAgICAgIH0pLmNhdGNoKGNhbGxiYWNrKTsKICAgIH07CgogICAgLy8gSWYgb3B0cy5zaW5jZSBleGlzdHMsIGdldCBhbGwgdGhlIGNoYW5nZXMgZnJvbSB0aGUgc2VxdWVuY2UKICAgIC8vIG51bWJlciBnaXZlbiBieSBvcHRzLnNpbmNlLiBPdGhlcndpc2UsIGdldCBhbGwgdGhlIGNoYW5nZXMKICAgIC8vIGZyb20gdGhlIHNlcXVlbmNlIG51bWJlciAwLgogICAgdmFyIGZldGNoVGltZW91dCA9IDEwOwogICAgdmFyIGZldGNoUmV0cnlDb3VudCA9IDA7CgogICAgdmFyIHJlc3VsdHMgPSB7cmVzdWx0czogW119OwoKICAgIHZhciBmZXRjaGVkID0gZnVuY3Rpb24gKGVyciwgcmVzKSB7CiAgICAgIGlmIChvcHRzLmFib3J0ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHJhd19yZXN1bHRzX2xlbmd0aCA9IDA7CiAgICAgIC8vIElmIHRoZSByZXN1bHQgb2YgdGhlIGFqYXggY2FsbCAocmVzKSBjb250YWlucyBjaGFuZ2VzIChyZXMucmVzdWx0cykKICAgICAgaWYgKHJlcyAmJiByZXMucmVzdWx0cykgewogICAgICAgIHJhd19yZXN1bHRzX2xlbmd0aCA9IHJlcy5yZXN1bHRzLmxlbmd0aDsKICAgICAgICByZXN1bHRzLmxhc3Rfc2VxID0gcmVzLmxhc3Rfc2VxOwogICAgICAgIC8vIEZvciBlYWNoIGNoYW5nZQogICAgICAgIHZhciByZXEgPSB7fTsKICAgICAgICByZXEucXVlcnkgPSBvcHRzLnF1ZXJ5X3BhcmFtczsKICAgICAgICByZXMucmVzdWx0cyA9IHJlcy5yZXN1bHRzLmZpbHRlcihmdW5jdGlvbiAoYykgewogICAgICAgICAgbGVmdFRvRmV0Y2gtLTsKICAgICAgICAgIHZhciByZXQgPSB1dGlscy5maWx0ZXJDaGFuZ2Uob3B0cykoYyk7CiAgICAgICAgICBpZiAocmV0KSB7CiAgICAgICAgICAgIGlmIChvcHRzLmluY2x1ZGVfZG9jcyAmJiBvcHRzLmF0dGFjaG1lbnRzICYmIG9wdHMuYmluYXJ5KSB7CiAgICAgICAgICAgICAgcmVhZEF0dGFjaG1lbnRzQXNCbG9iT3JCdWZmZXIoYyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJldHVybkRvY3MpIHsKICAgICAgICAgICAgICByZXN1bHRzLnJlc3VsdHMucHVzaChjKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvcHRzLm9uQ2hhbmdlKGMpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChlcnIpIHsKICAgICAgICAvLyBJbiBjYXNlIG9mIGFuIGVycm9yLCBzdG9wIGxpc3RlbmluZyBmb3IgY2hhbmdlcyBhbmQgY2FsbAogICAgICAgIC8vIG9wdHMuY29tcGxldGUKICAgICAgICBvcHRzLmFib3J0ZWQgPSB0cnVlOwogICAgICAgIG9wdHMuY29tcGxldGUoZXJyKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIFRoZSBjaGFuZ2VzIGZlZWQgbWF5IGhhdmUgdGltZWQgb3V0IHdpdGggbm8gcmVzdWx0cwogICAgICAvLyBpZiBzbyByZXVzZSBsYXN0IHVwZGF0ZSBzZXF1ZW5jZQogICAgICBpZiAocmVzICYmIHJlcy5sYXN0X3NlcSkgewogICAgICAgIGxhc3RGZXRjaGVkU2VxID0gcmVzLmxhc3Rfc2VxOwogICAgICB9CgogICAgICB2YXIgZmluaXNoZWQgPSAobGltaXQgJiYgbGVmdFRvRmV0Y2ggPD0gMCkgfHwKICAgICAgICAocmVzICYmIHJhd19yZXN1bHRzX2xlbmd0aCA8IGJhdGNoU2l6ZSkgfHwKICAgICAgICAob3B0cy5kZXNjZW5kaW5nKTsKCiAgICAgIGlmICgob3B0cy5jb250aW51b3VzICYmICEobGltaXQgJiYgbGVmdFRvRmV0Y2ggPD0gMCkpIHx8ICFmaW5pc2hlZCkgewogICAgICAgIC8vIEluY3JlYXNlIHJldHJ5IGRlbGF5IGV4cG9uZW50aWFsbHkgYXMgbG9uZyBhcyBlcnJvcnMgcGVyc2lzdAogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIGZldGNoUmV0cnlDb3VudCArPSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmZXRjaFJldHJ5Q291bnQgPSAwOwogICAgICAgIH0KICAgICAgICB2YXIgdGltZW91dE11bHRpcGxpZXIgPSAxIDw8IGZldGNoUmV0cnlDb3VudDsKICAgICAgICB2YXIgcmV0cnlXYWl0ID0gZmV0Y2hUaW1lb3V0ICogdGltZW91dE11bHRpcGxpZXI7CiAgICAgICAgdmFyIG1heGltdW1XYWl0ID0gb3B0cy5tYXhpbXVtV2FpdCB8fCAzMDAwMDsKCiAgICAgICAgaWYgKHJldHJ5V2FpdCA+IG1heGltdW1XYWl0KSB7CiAgICAgICAgICBvcHRzLmNvbXBsZXRlKGVyciB8fCBlcnJvcnMuZXJyb3IoZXJyb3JzLlVOS05PV05fRVJST1IpKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIFF1ZXVlIGEgY2FsbCB0byBmZXRjaCBhZ2FpbiB3aXRoIHRoZSBuZXdlc3Qgc2VxdWVuY2UgbnVtYmVyCiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IGZldGNoKGxhc3RGZXRjaGVkU2VxLCBmZXRjaGVkKTsgfSwgcmV0cnlXYWl0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBXZSdyZSBkb25lLCBjYWxsIHRoZSBjYWxsYmFjawogICAgICAgIG9wdHMuY29tcGxldGUobnVsbCwgcmVzdWx0cyk7CiAgICAgIH0KICAgIH07CgogICAgZmV0Y2gob3B0cy5zaW5jZSB8fCAwLCBmZXRjaGVkKTsKCiAgICAvLyBSZXR1cm4gYSBtZXRob2QgdG8gY2FuY2VsIHRoaXMgbWV0aG9kIGZyb20gcHJvY2Vzc2luZyBhbnkgbW9yZQogICAgcmV0dXJuIHsKICAgICAgY2FuY2VsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgb3B0cy5hYm9ydGVkID0gdHJ1ZTsKICAgICAgICBpZiAoeGhyKSB7CiAgICAgICAgICB4aHIuYWJvcnQoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfTsKCiAgLy8gR2l2ZW4gYSBzZXQgb2YgZG9jdW1lbnQvcmV2aXNpb24gSURzIChnaXZlbiBieSByZXEpLCB0ZXRzIHRoZSBzdWJzZXQgb2YKICAvLyB0aG9zZSB0aGF0IGRvIE5PVCBjb3JyZXNwb25kIHRvIHJldmlzaW9ucyBzdG9yZWQgaW4gdGhlIGRhdGFiYXNlLgogIC8vIFNlZSBodHRwOi8vd2lraS5hcGFjaGUub3JnL2NvdWNoZGIvSHR0cFBvc3RSZXZzRGlmZgogIGFwaS5yZXZzRGlmZiA9IGFkYXB0ZXJGdW4oJ3JldnNEaWZmJywgZnVuY3Rpb24gKHJlcSwgb3B0cywgY2FsbGJhY2spIHsKICAgIC8vIElmIG5vIG9wdGlvbnMgd2VyZSBnaXZlbiwgc2V0IHRoZSBjYWxsYmFjayB0byBiZSB0aGUgc2Vjb25kIHBhcmFtZXRlcgogICAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNhbGxiYWNrID0gb3B0czsKICAgICAgb3B0cyA9IHt9OwogICAgfQoKICAgIC8vIEdldCB0aGUgbWlzc2luZyBkb2N1bWVudC9yZXZpc2lvbiBJRHMKICAgIGFqYXgob3B0cywgewogICAgICBtZXRob2Q6ICdQT1NUJywKICAgICAgdXJsOiBnZW5EQlVybChob3N0LCAnX3JldnNfZGlmZicpLAogICAgICBib2R5OiByZXEKICAgIH0sIGNhbGxiYWNrKTsKICB9KTsKCiAgYXBpLl9jbG9zZSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgY2FsbGJhY2soKTsKICB9OwoKICBhcGkuX2Rlc3Ryb3kgPSBmdW5jdGlvbiAob3B0aW9ucywgY2FsbGJhY2spIHsKICAgIHNldHVwKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgYWpheChvcHRpb25zLCB7CiAgICAgICAgdXJsOiBnZW5EQlVybChob3N0LCAnJyksCiAgICAgICAgbWV0aG9kOiAnREVMRVRFJwogICAgICB9LCBmdW5jdGlvbiAoZXJyLCByZXNwKSB7CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICBhcGkuZW1pdCgnZXJyb3InLCBlcnIpOwogICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7CiAgICAgICAgfQogICAgICAgIGFwaS5lbWl0KCdkZXN0cm95ZWQnKTsKICAgICAgICBhcGkuY29uc3RydWN0b3IuZW1pdCgnZGVzdHJveWVkJywgb3B0cy5uYW1lKTsKICAgICAgICBjYWxsYmFjayhudWxsLCByZXNwKTsKICAgICAgfSk7CiAgICB9KS5jYXRjaChjYWxsYmFjayk7CiAgfTsKfQoKLy8gSHR0cFBvdWNoIGlzIGEgdmFsaWQgYWRhcHRlci4KSHR0cFBvdWNoLnZhbGlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0cnVlOwp9OwoKbW9kdWxlLmV4cG9ydHMgPSBIdHRwUG91Y2g7Cgp9LHsiLi4vLi4vZGVwcy9hamF4L211bHRpcGFydCI6MzcsIi4uLy4uL2RlcHMvYmluYXJ5L2Jhc2U2NCI6NDEsIi4uLy4uL2RlcHMvYmluYXJ5L2Jhc2U2NFN0cmluZ1RvQmxvYk9yQnVmZmVyIjo0MiwiLi4vLi4vZGVwcy9iaW5hcnkvYmluYXJ5U3RyaW5nVG9CbG9iT3JCdWZmZXIiOjQ0LCIuLi8uLi9kZXBzL2JpbmFyeS9ibG9iT3JCdWZmZXJUb0Jhc2U2NCI6NDYsIi4uLy4uL2RlcHMvYnVsa0dldFNoaW0iOjUyLCIuLi8uLi9kZXBzL2RvY3MvcGFyc2VEb2MiOjU4LCIuLi8uLi9kZXBzL2Vycm9ycyI6NjQsIi4uLy4uL2RlcHMvZmxhdHRlbiI6NjYsIi4uLy4uL3V0aWxzIjoxMDIsImRlYnVnIjo5fV0sMTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgZXJyb3JzID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9lcnJvcnMnKTsKdmFyIGlkYlV0aWxzID0gcmVxdWlyZSgnLi91dGlscycpOwp2YXIgaWRiQ29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKTsKdmFyIGNvbGxlY3RDb25mbGljdHMgPSByZXF1aXJlKCcuLi8uLi9kZXBzL21lcmdlL2NvbGxlY3RDb25mbGljdHMnKTsKCnZhciBBVFRBQ0hfU1RPUkUgPSBpZGJDb25zdGFudHMuQVRUQUNIX1NUT1JFOwp2YXIgQllfU0VRX1NUT1JFID0gaWRiQ29uc3RhbnRzLkJZX1NFUV9TVE9SRTsKdmFyIERPQ19TVE9SRSA9IGlkYkNvbnN0YW50cy5ET0NfU1RPUkU7Cgp2YXIgZGVjb2RlRG9jID0gaWRiVXRpbHMuZGVjb2RlRG9jOwp2YXIgZGVjb2RlTWV0YWRhdGEgPSBpZGJVdGlscy5kZWNvZGVNZXRhZGF0YTsKdmFyIGZldGNoQXR0YWNobWVudHNJZk5lY2Vzc2FyeSA9IGlkYlV0aWxzLmZldGNoQXR0YWNobWVudHNJZk5lY2Vzc2FyeTsKdmFyIHBvc3RQcm9jZXNzQXR0YWNobWVudHMgPSBpZGJVdGlscy5wb3N0UHJvY2Vzc0F0dGFjaG1lbnRzOwp2YXIgb3BlblRyYW5zYWN0aW9uU2FmZWx5ID0gaWRiVXRpbHMub3BlblRyYW5zYWN0aW9uU2FmZWx5OwoKZnVuY3Rpb24gY3JlYXRlS2V5UmFuZ2Uoc3RhcnQsIGVuZCwgaW5jbHVzaXZlRW5kLCBrZXksIGRlc2NlbmRpbmcpIHsKICB0cnkgewogICAgaWYgKHN0YXJ0ICYmIGVuZCkgewogICAgICBpZiAoZGVzY2VuZGluZykgewogICAgICAgIHJldHVybiBJREJLZXlSYW5nZS5ib3VuZChlbmQsIHN0YXJ0LCAhaW5jbHVzaXZlRW5kLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIElEQktleVJhbmdlLmJvdW5kKHN0YXJ0LCBlbmQsIGZhbHNlLCAhaW5jbHVzaXZlRW5kKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChzdGFydCkgewogICAgICBpZiAoZGVzY2VuZGluZykgewogICAgICAgIHJldHVybiBJREJLZXlSYW5nZS51cHBlckJvdW5kKHN0YXJ0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gSURCS2V5UmFuZ2UubG93ZXJCb3VuZChzdGFydCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZW5kKSB7CiAgICAgIGlmIChkZXNjZW5kaW5nKSB7CiAgICAgICAgcmV0dXJuIElEQktleVJhbmdlLmxvd2VyQm91bmQoZW5kLCAhaW5jbHVzaXZlRW5kKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gSURCS2V5UmFuZ2UudXBwZXJCb3VuZChlbmQsICFpbmNsdXNpdmVFbmQpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSkgewogICAgICByZXR1cm4gSURCS2V5UmFuZ2Uub25seShrZXkpOwogICAgfQogIH0gY2F0Y2ggKGUpIHsKICAgIHJldHVybiB7ZXJyb3I6IGV9OwogIH0KICByZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gaGFuZGxlS2V5UmFuZ2VFcnJvcihhcGksIG9wdHMsIGVyciwgY2FsbGJhY2spIHsKICBpZiAoZXJyLm5hbWUgPT09ICJEYXRhRXJyb3IiICYmIGVyci5jb2RlID09PSAwKSB7CiAgICAvLyBkYXRhIGVycm9yLCBzdGFydCBpcyBsZXNzIHRoYW4gZW5kCiAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgewogICAgICB0b3RhbF9yb3dzOiBhcGkuX21ldGEuZG9jQ291bnQsCiAgICAgIG9mZnNldDogb3B0cy5za2lwLAogICAgICByb3dzOiBbXQogICAgfSk7CiAgfQogIGNhbGxiYWNrKGVycm9ycy5lcnJvcihlcnJvcnMuSURCX0VSUk9SLCBlcnIubmFtZSwgZXJyLm1lc3NhZ2UpKTsKfQoKZnVuY3Rpb24gaWRiQWxsRG9jcyhvcHRzLCBhcGksIGlkYiwgY2FsbGJhY2spIHsKCiAgZnVuY3Rpb24gYWxsRG9jc1F1ZXJ5KG9wdHMsIGNhbGxiYWNrKSB7CiAgICB2YXIgc3RhcnQgPSAnc3RhcnRrZXknIGluIG9wdHMgPyBvcHRzLnN0YXJ0a2V5IDogZmFsc2U7CiAgICB2YXIgZW5kID0gJ2VuZGtleScgaW4gb3B0cyA/IG9wdHMuZW5ka2V5IDogZmFsc2U7CiAgICB2YXIga2V5ID0gJ2tleScgaW4gb3B0cyA/IG9wdHMua2V5IDogZmFsc2U7CiAgICB2YXIgc2tpcCA9IG9wdHMuc2tpcCB8fCAwOwogICAgdmFyIGxpbWl0ID0gdHlwZW9mIG9wdHMubGltaXQgPT09ICdudW1iZXInID8gb3B0cy5saW1pdCA6IC0xOwogICAgdmFyIGluY2x1c2l2ZUVuZCA9IG9wdHMuaW5jbHVzaXZlX2VuZCAhPT0gZmFsc2U7CiAgICB2YXIgZGVzY2VuZGluZyA9ICdkZXNjZW5kaW5nJyBpbiBvcHRzICYmIG9wdHMuZGVzY2VuZGluZyA/ICdwcmV2JyA6IG51bGw7CgogICAgdmFyIGtleVJhbmdlID0gY3JlYXRlS2V5UmFuZ2Uoc3RhcnQsIGVuZCwgaW5jbHVzaXZlRW5kLCBrZXksIGRlc2NlbmRpbmcpOwogICAgaWYgKGtleVJhbmdlICYmIGtleVJhbmdlLmVycm9yKSB7CiAgICAgIHJldHVybiBoYW5kbGVLZXlSYW5nZUVycm9yKGFwaSwgb3B0cywga2V5UmFuZ2UuZXJyb3IsIGNhbGxiYWNrKTsKICAgIH0KCiAgICB2YXIgc3RvcmVzID0gW0RPQ19TVE9SRSwgQllfU0VRX1NUT1JFXTsKCiAgICBpZiAob3B0cy5hdHRhY2htZW50cykgewogICAgICBzdG9yZXMucHVzaChBVFRBQ0hfU1RPUkUpOwogICAgfQogICAgdmFyIHR4blJlc3VsdCA9IG9wZW5UcmFuc2FjdGlvblNhZmVseShpZGIsIHN0b3JlcywgJ3JlYWRvbmx5Jyk7CiAgICBpZiAodHhuUmVzdWx0LmVycm9yKSB7CiAgICAgIHJldHVybiBjYWxsYmFjayh0eG5SZXN1bHQuZXJyb3IpOwogICAgfQogICAgdmFyIHR4biA9IHR4blJlc3VsdC50eG47CiAgICB2YXIgZG9jU3RvcmUgPSB0eG4ub2JqZWN0U3RvcmUoRE9DX1NUT1JFKTsKICAgIHZhciBzZXFTdG9yZSA9IHR4bi5vYmplY3RTdG9yZShCWV9TRVFfU1RPUkUpOwogICAgdmFyIGN1cnNvciA9IGRlc2NlbmRpbmcgPwogICAgICBkb2NTdG9yZS5vcGVuQ3Vyc29yKGtleVJhbmdlLCBkZXNjZW5kaW5nKSA6CiAgICAgIGRvY1N0b3JlLm9wZW5DdXJzb3Ioa2V5UmFuZ2UpOwogICAgdmFyIGRvY0lkUmV2SW5kZXggPSBzZXFTdG9yZS5pbmRleCgnX2RvY19pZF9yZXYnKTsKICAgIHZhciByZXN1bHRzID0gW107CiAgICB2YXIgZG9jQ291bnQgPSAwOwoKICAgIC8vIGlmIHRoZSB1c2VyIHNwZWNpZmllcyBpbmNsdWRlX2RvY3M9dHJ1ZSwgdGhlbiB3ZSBkb24ndAogICAgLy8gd2FudCB0byBibG9jayB0aGUgbWFpbiBjdXJzb3Igd2hpbGUgd2UncmUgZmV0Y2hpbmcgdGhlIGRvYwogICAgZnVuY3Rpb24gZmV0Y2hEb2NBc3luY2hyb25vdXNseShtZXRhZGF0YSwgcm93LCB3aW5uaW5nUmV2KSB7CiAgICAgIHZhciBrZXkgPSBtZXRhZGF0YS5pZCArICI6OiIgKyB3aW5uaW5nUmV2OwogICAgICBkb2NJZFJldkluZGV4LmdldChrZXkpLm9uc3VjY2VzcyA9ICBmdW5jdGlvbiBvbkdldERvYyhlKSB7CiAgICAgICAgcm93LmRvYyA9IGRlY29kZURvYyhlLnRhcmdldC5yZXN1bHQpOwogICAgICAgIGlmIChvcHRzLmNvbmZsaWN0cykgewogICAgICAgICAgcm93LmRvYy5fY29uZmxpY3RzID0gY29sbGVjdENvbmZsaWN0cyhtZXRhZGF0YSk7CiAgICAgICAgfQogICAgICAgIGZldGNoQXR0YWNobWVudHNJZk5lY2Vzc2FyeShyb3cuZG9jLCBvcHRzLCB0eG4pOwogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGFsbERvY3NJbm5lcihjdXJzb3IsIHdpbm5pbmdSZXYsIG1ldGFkYXRhKSB7CiAgICAgIHZhciByb3cgPSB7CiAgICAgICAgaWQ6IG1ldGFkYXRhLmlkLAogICAgICAgIGtleTogbWV0YWRhdGEuaWQsCiAgICAgICAgdmFsdWU6IHsKICAgICAgICAgIHJldjogd2lubmluZ1JldgogICAgICAgIH0KICAgICAgfTsKICAgICAgdmFyIGRlbGV0ZWQgPSBtZXRhZGF0YS5kZWxldGVkOwogICAgICBpZiAob3B0cy5kZWxldGVkID09PSAnb2snKSB7CiAgICAgICAgcmVzdWx0cy5wdXNoKHJvdyk7CiAgICAgICAgLy8gZGVsZXRlZCBkb2NzIGFyZSBva2F5IHdpdGggImtleXMiIHJlcXVlc3RzCiAgICAgICAgaWYgKGRlbGV0ZWQpIHsKICAgICAgICAgIHJvdy52YWx1ZS5kZWxldGVkID0gdHJ1ZTsKICAgICAgICAgIHJvdy5kb2MgPSBudWxsOwogICAgICAgIH0gZWxzZSBpZiAob3B0cy5pbmNsdWRlX2RvY3MpIHsKICAgICAgICAgIGZldGNoRG9jQXN5bmNocm9ub3VzbHkobWV0YWRhdGEsIHJvdywgd2lubmluZ1Jldik7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKCFkZWxldGVkICYmIHNraXAtLSA8PSAwKSB7CiAgICAgICAgcmVzdWx0cy5wdXNoKHJvdyk7CiAgICAgICAgaWYgKG9wdHMuaW5jbHVkZV9kb2NzKSB7CiAgICAgICAgICBmZXRjaERvY0FzeW5jaHJvbm91c2x5KG1ldGFkYXRhLCByb3csIHdpbm5pbmdSZXYpOwogICAgICAgIH0KICAgICAgICBpZiAoLS1saW1pdCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQogICAgICBjdXJzb3IuY29udGludWUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBvbkdldEN1cnNvcihlKSB7CiAgICAgIGRvY0NvdW50ID0gYXBpLl9tZXRhLmRvY0NvdW50OyAvLyBkbyB0aGlzIHdpdGhpbiB0aGUgdHhuIGZvciBjb25zaXN0ZW5jeQogICAgICB2YXIgY3Vyc29yID0gZS50YXJnZXQucmVzdWx0OwogICAgICBpZiAoIWN1cnNvcikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgbWV0YWRhdGEgPSBkZWNvZGVNZXRhZGF0YShjdXJzb3IudmFsdWUpOwogICAgICB2YXIgd2lubmluZ1JldiA9IG1ldGFkYXRhLndpbm5pbmdSZXY7CgogICAgICBhbGxEb2NzSW5uZXIoY3Vyc29yLCB3aW5uaW5nUmV2LCBtZXRhZGF0YSk7CiAgICB9CgogICAgZnVuY3Rpb24gb25SZXN1bHRzUmVhZHkoKSB7CiAgICAgIGNhbGxiYWNrKG51bGwsIHsKICAgICAgICB0b3RhbF9yb3dzOiBkb2NDb3VudCwKICAgICAgICBvZmZzZXQ6IG9wdHMuc2tpcCwKICAgICAgICByb3dzOiByZXN1bHRzCiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uVHhuQ29tcGxldGUoKSB7CiAgICAgIGlmIChvcHRzLmF0dGFjaG1lbnRzKSB7CiAgICAgICAgcG9zdFByb2Nlc3NBdHRhY2htZW50cyhyZXN1bHRzLCBvcHRzLmJpbmFyeSkudGhlbihvblJlc3VsdHNSZWFkeSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb25SZXN1bHRzUmVhZHkoKTsKICAgICAgfQogICAgfQoKICAgIHR4bi5vbmNvbXBsZXRlID0gb25UeG5Db21wbGV0ZTsKICAgIGN1cnNvci5vbnN1Y2Nlc3MgPSBvbkdldEN1cnNvcjsKICB9CgogIGZ1bmN0aW9uIGFsbERvY3Mob3B0cywgY2FsbGJhY2spIHsKCiAgICBpZiAob3B0cy5saW1pdCA9PT0gMCkgewogICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgewogICAgICAgIHRvdGFsX3Jvd3M6IGFwaS5fbWV0YS5kb2NDb3VudCwKICAgICAgICBvZmZzZXQ6IG9wdHMuc2tpcCwKICAgICAgICByb3dzOiBbXQogICAgICB9KTsKICAgIH0KICAgIGFsbERvY3NRdWVyeShvcHRzLCBjYWxsYmFjayk7CiAgfQoKICBhbGxEb2NzKG9wdHMsIGNhbGxiYWNrKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBpZGJBbGxEb2NzOwp9LHsiLi4vLi4vZGVwcy9lcnJvcnMiOjY0LCIuLi8uLi9kZXBzL21lcmdlL2NvbGxlY3RDb25mbGljdHMiOjY4LCIuL2NvbnN0YW50cyI6MjAsIi4vdXRpbHMiOjIyfV0sMTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgdXRpbHMgPSByZXF1aXJlKCcuLi8uLi91dGlscycpOwp2YXIgY3JlYXRlQmxvYiA9IHJlcXVpcmUoJy4uLy4uL2RlcHMvYmluYXJ5L2Jsb2InKTsKCnZhciBpZGJDb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpOwp2YXIgREVURUNUX0JMT0JfU1VQUE9SVF9TVE9SRSA9IGlkYkNvbnN0YW50cy5ERVRFQ1RfQkxPQl9TVVBQT1JUX1NUT1JFOwoKLy8KLy8gRGV0ZWN0IGJsb2Igc3VwcG9ydC4gQ2hyb21lIGRpZG4ndCBzdXBwb3J0IGl0IHVudGlsIHZlcnNpb24gMzguCi8vIEluIHZlcnNpb24gMzcgdGhleSBoYWQgYSBicm9rZW4gdmVyc2lvbiB3aGVyZSBQTkdzIChhbmQgcG9zc2libHkKLy8gb3RoZXIgYmluYXJ5IHR5cGVzKSBhcmVuJ3Qgc3RvcmVkIGNvcnJlY3RseSwgYmVjYXVzZSB3aGVuIHlvdSBmZXRjaAovLyB0aGVtLCB0aGUgY29udGVudCB0eXBlIGlzIGFsd2F5cyBudWxsLgovLwovLyBGdXJ0aGVybW9yZSwgdGhleSBoYXZlIHNvbWUgb3V0c3RhbmRpbmcgYnVncyB3aGVyZSBibG9icyBvY2Nhc2lvbmFsbHkKLy8gYXJlIHJlYWQgYnkgRmlsZVJlYWRlciBhcyBudWxsLCBvciBieSBhamF4IGFzIDQwNHMuCi8vCi8vIFNhZGx5IHdlIHVzZSB0aGUgNDA0IGJ1ZyB0byBkZXRlY3QgdGhlIEZpbGVSZWFkZXIgYnVnLCBzbyBpZiB0aGV5Ci8vIGdldCBmaXhlZCBpbmRlcGVuZGVudGx5IGFuZCByZWxlYXNlZCBpbiBkaWZmZXJlbnQgdmVyc2lvbnMgb2YgQ2hyb21lLAovLyB0aGVuIHRoZSBidWcgY291bGQgY29tZSBiYWNrLiBTbyBpdCdzIHdvcnRod2hpbGUgdG8gd2F0Y2ggdGhlc2UgaXNzdWVzOgovLyA0MDQgYnVnOiBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NDQ3OTE2Ci8vIEZpbGVSZWFkZXIgYnVnOiBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NDQ3ODM2Ci8vCmZ1bmN0aW9uIGNoZWNrQmxvYlN1cHBvcnQodHhuLCBpZGIpIHsKICByZXR1cm4gbmV3IHV0aWxzLlByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgdmFyIGJsb2IgPSBjcmVhdGVCbG9iKFsnJ10sIHt0eXBlOiAnaW1hZ2UvcG5nJ30pOwogICAgdHhuLm9iamVjdFN0b3JlKERFVEVDVF9CTE9CX1NVUFBPUlRfU1RPUkUpLnB1dChibG9iLCAna2V5Jyk7CgogICAgdHhuLm9uYWJvcnQgPSBmdW5jdGlvbiAoZSkgewogICAgICAvLyBJZiB0aGUgdHJhbnNhY3Rpb24gYWJvcnRzIG5vdyBpdHMgZHVlIHRvIG5vdCBiZWluZyBhYmxlIHRvCiAgICAgIC8vIHdyaXRlIHRvIHRoZSBkYXRhYmFzZSwgbGlrZWx5IGR1ZSB0byB0aGUgZGlzayBiZWluZyBmdWxsCiAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgcmVzb2x2ZShmYWxzZSk7CiAgICB9OwoKICAgIHR4bi5vbmNvbXBsZXRlID0gZnVuY3Rpb24gKCkgewogICAgICAvLyBoYXZlIHRvIGRvIGl0IGluIGEgc2VwYXJhdGUgdHJhbnNhY3Rpb24sIGVsc2UgdGhlIGNvcnJlY3QKICAgICAgLy8gY29udGVudCB0eXBlIGlzIGFsd2F5cyByZXR1cm5lZAogICAgICB2YXIgYmxvYlR4biA9IGlkYi50cmFuc2FjdGlvbihbREVURUNUX0JMT0JfU1VQUE9SVF9TVE9SRV0sCiAgICAgICAgJ3JlYWR3cml0ZScpOwogICAgICB2YXIgZ2V0QmxvYlJlcSA9IGJsb2JUeG4ub2JqZWN0U3RvcmUoCiAgICAgICAgREVURUNUX0JMT0JfU1VQUE9SVF9TVE9SRSkuZ2V0KCdrZXknKTsKICAgICAgZ2V0QmxvYlJlcS5vbmVycm9yID0gcmVqZWN0OwogICAgICBnZXRCbG9iUmVxLm9uc3VjY2VzcyA9IGZ1bmN0aW9uIChlKSB7CgogICAgICAgIHZhciBzdG9yZWRCbG9iID0gZS50YXJnZXQucmVzdWx0OwogICAgICAgIHZhciB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHN0b3JlZEJsb2IpOwoKICAgICAgICB1dGlscy5hamF4KHsKICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgY2FjaGU6IHRydWUsCiAgICAgICAgICBiaW5hcnk6IHRydWUKICAgICAgICB9LCBmdW5jdGlvbiAoZXJyLCByZXMpIHsKICAgICAgICAgIGlmIChlcnIgJiYgZXJyLnN0YXR1cyA9PT0gNDA1KSB7CiAgICAgICAgICAgIC8vIGZpcmVmb3ggd29uJ3QgbGV0IHVzIGRvIHRoYXQuIGJ1dCBmaXJlZm94IGRvZXNuJ3QKICAgICAgICAgICAgLy8gaGF2ZSB0aGUgYmxvYiB0eXBlIGJ1ZyB0aGF0IENocm9tZSBkb2VzLCBzbyB0aGF0J3Mgb2sKICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc29sdmUoISEocmVzICYmIHJlcy50eXBlID09PSAnaW1hZ2UvcG5nJykpOwogICAgICAgICAgICBpZiAoZXJyICYmIGVyci5zdGF0dXMgPT09IDQwNCkgewogICAgICAgICAgICAgIHV0aWxzLmV4cGxhaW40MDQoJ1BvdWNoREIgaXMganVzdCBkZXRlY3RpbmcgYmxvYiBVUkwgc3VwcG9ydC4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTCh1cmwpOwogICAgICAgIH0pOwogICAgICB9OwogICAgfTsKICB9KS5jYXRjaChmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gZmFsc2U7IC8vIGVycm9yLCBzbyBhc3N1bWUgdW5zdXBwb3J0ZWQKICB9KTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBjaGVja0Jsb2JTdXBwb3J0OwoKfSx7Ii4uLy4uL2RlcHMvYmluYXJ5L2Jsb2IiOjQ1LCIuLi8uLi91dGlscyI6MTAyLCIuL2NvbnN0YW50cyI6MjB9XSwxOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciB1dGlscyA9IHJlcXVpcmUoJy4uLy4uL3V0aWxzJyk7CnZhciBlcnJvcnMgPSByZXF1aXJlKCcuLi8uLi9kZXBzL2Vycm9ycycpOwp2YXIgcHJlcHJvY2Vzc0F0dGFjaG1lbnRzID0KICByZXF1aXJlKCcuLi8uLi9kZXBzL2RvY3MvcHJlcHJvY2Vzc0F0dGFjaG1lbnRzJyk7CnZhciBwcm9jZXNzRG9jcyA9IHJlcXVpcmUoJy4uLy4uL2RlcHMvZG9jcy9wcm9jZXNzRG9jcycpOwp2YXIgaXNMb2NhbElkID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9kb2NzL2lzTG9jYWxJZCcpOwp2YXIgaWRiVXRpbHMgPSByZXF1aXJlKCcuL3V0aWxzJyk7CnZhciBpZGJDb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpOwoKdmFyIEFUVEFDSF9BTkRfU0VRX1NUT1JFID0gaWRiQ29uc3RhbnRzLkFUVEFDSF9BTkRfU0VRX1NUT1JFOwp2YXIgQVRUQUNIX1NUT1JFID0gaWRiQ29uc3RhbnRzLkFUVEFDSF9TVE9SRTsKdmFyIEJZX1NFUV9TVE9SRSA9IGlkYkNvbnN0YW50cy5CWV9TRVFfU1RPUkU7CnZhciBET0NfU1RPUkUgPSBpZGJDb25zdGFudHMuRE9DX1NUT1JFOwp2YXIgTE9DQUxfU1RPUkUgPSBpZGJDb25zdGFudHMuTE9DQUxfU1RPUkU7CnZhciBNRVRBX1NUT1JFID0gaWRiQ29uc3RhbnRzLk1FVEFfU1RPUkU7Cgp2YXIgY29tcGFjdFJldnMgPSBpZGJVdGlscy5jb21wYWN0UmV2czsKdmFyIGRlY29kZU1ldGFkYXRhID0gaWRiVXRpbHMuZGVjb2RlTWV0YWRhdGE7CnZhciBlbmNvZGVNZXRhZGF0YSA9IGlkYlV0aWxzLmVuY29kZU1ldGFkYXRhOwp2YXIgaWRiRXJyb3IgPSBpZGJVdGlscy5pZGJFcnJvcjsKdmFyIG9wZW5UcmFuc2FjdGlvblNhZmVseSA9IGlkYlV0aWxzLm9wZW5UcmFuc2FjdGlvblNhZmVseTsKCmZ1bmN0aW9uIGlkYkJ1bGtEb2NzKHJlcSwgb3B0cywgYXBpLCBpZGIsIENoYW5nZXMsIGNhbGxiYWNrKSB7CiAgdmFyIGRvY0luZm9zID0gcmVxLmRvY3M7CiAgdmFyIHR4bjsKICB2YXIgZG9jU3RvcmU7CiAgdmFyIGJ5U2VxU3RvcmU7CiAgdmFyIGF0dGFjaFN0b3JlOwogIHZhciBhdHRhY2hBbmRTZXFTdG9yZTsKICB2YXIgZG9jSW5mb0Vycm9yOwogIHZhciBkb2NDb3VudERlbHRhID0gMDsKCiAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGRvY0luZm9zLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICB2YXIgZG9jID0gZG9jSW5mb3NbaV07CiAgICBpZiAoZG9jLl9pZCAmJiBpc0xvY2FsSWQoZG9jLl9pZCkpIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICBkb2MgPSBkb2NJbmZvc1tpXSA9IHV0aWxzLnBhcnNlRG9jKGRvYywgb3B0cy5uZXdfZWRpdHMpOwogICAgaWYgKGRvYy5lcnJvciAmJiAhZG9jSW5mb0Vycm9yKSB7CiAgICAgIGRvY0luZm9FcnJvciA9IGRvYzsKICAgIH0KICB9CgogIGlmIChkb2NJbmZvRXJyb3IpIHsKICAgIHJldHVybiBjYWxsYmFjayhkb2NJbmZvRXJyb3IpOwogIH0KCiAgdmFyIHJlc3VsdHMgPSBuZXcgQXJyYXkoZG9jSW5mb3MubGVuZ3RoKTsKICB2YXIgZmV0Y2hlZERvY3MgPSBuZXcgdXRpbHMuTWFwKCk7CiAgdmFyIHByZWNvbmRpdGlvbkVycm9yZWQgPSBmYWxzZTsKICB2YXIgYmxvYlR5cGUgPSBhcGkuX21ldGEuYmxvYlN1cHBvcnQgPyAnYmxvYicgOiAnYmFzZTY0JzsKCiAgcHJlcHJvY2Vzc0F0dGFjaG1lbnRzKGRvY0luZm9zLCBibG9iVHlwZSwgZnVuY3Rpb24gKGVycikgewogICAgaWYgKGVycikgewogICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKICAgIH0KICAgIHN0YXJ0VHJhbnNhY3Rpb24oKTsKICB9KTsKCiAgZnVuY3Rpb24gc3RhcnRUcmFuc2FjdGlvbigpIHsKCiAgICB2YXIgc3RvcmVzID0gWwogICAgICBET0NfU1RPUkUsIEJZX1NFUV9TVE9SRSwKICAgICAgQVRUQUNIX1NUT1JFLCBNRVRBX1NUT1JFLAogICAgICBMT0NBTF9TVE9SRSwgQVRUQUNIX0FORF9TRVFfU1RPUkUKICAgIF07CiAgICB2YXIgdHhuUmVzdWx0ID0gb3BlblRyYW5zYWN0aW9uU2FmZWx5KGlkYiwgc3RvcmVzLCAncmVhZHdyaXRlJyk7CiAgICBpZiAodHhuUmVzdWx0LmVycm9yKSB7CiAgICAgIHJldHVybiBjYWxsYmFjayh0eG5SZXN1bHQuZXJyb3IpOwogICAgfQogICAgdHhuID0gdHhuUmVzdWx0LnR4bjsKICAgIHR4bi5vbmFib3J0ID0gaWRiRXJyb3IoY2FsbGJhY2spOwogICAgdHhuLm9udGltZW91dCA9IGlkYkVycm9yKGNhbGxiYWNrKTsKICAgIHR4bi5vbmNvbXBsZXRlID0gY29tcGxldGU7CiAgICBkb2NTdG9yZSA9IHR4bi5vYmplY3RTdG9yZShET0NfU1RPUkUpOwogICAgYnlTZXFTdG9yZSA9IHR4bi5vYmplY3RTdG9yZShCWV9TRVFfU1RPUkUpOwogICAgYXR0YWNoU3RvcmUgPSB0eG4ub2JqZWN0U3RvcmUoQVRUQUNIX1NUT1JFKTsKICAgIGF0dGFjaEFuZFNlcVN0b3JlID0gdHhuLm9iamVjdFN0b3JlKEFUVEFDSF9BTkRfU0VRX1NUT1JFKTsKCiAgICB2ZXJpZnlBdHRhY2htZW50cyhmdW5jdGlvbiAoZXJyKSB7CiAgICAgIGlmIChlcnIpIHsKICAgICAgICBwcmVjb25kaXRpb25FcnJvcmVkID0gdHJ1ZTsKICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKICAgICAgfQogICAgICBmZXRjaEV4aXN0aW5nRG9jcygpOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBpZGJQcm9jZXNzRG9jcygpIHsKCiAgICBwcm9jZXNzRG9jcyhkb2NJbmZvcywgYXBpLCBmZXRjaGVkRG9jcywgdHhuLCByZXN1bHRzLCB3cml0ZURvYywgb3B0cyk7CiAgfQoKICBmdW5jdGlvbiBmZXRjaEV4aXN0aW5nRG9jcygpIHsKCiAgICBpZiAoIWRvY0luZm9zLmxlbmd0aCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIG51bUZldGNoZWQgPSAwOwoKICAgIGZ1bmN0aW9uIGNoZWNrRG9uZSgpIHsKICAgICAgaWYgKCsrbnVtRmV0Y2hlZCA9PT0gZG9jSW5mb3MubGVuZ3RoKSB7CiAgICAgICAgaWRiUHJvY2Vzc0RvY3MoKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHJlYWRNZXRhZGF0YShldmVudCkgewogICAgICB2YXIgbWV0YWRhdGEgPSBkZWNvZGVNZXRhZGF0YShldmVudC50YXJnZXQucmVzdWx0KTsKCiAgICAgIGlmIChtZXRhZGF0YSkgewogICAgICAgIGZldGNoZWREb2NzLnNldChtZXRhZGF0YS5pZCwgbWV0YWRhdGEpOwogICAgICB9CiAgICAgIGNoZWNrRG9uZSgpOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBkb2NJbmZvcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICB2YXIgZG9jSW5mbyA9IGRvY0luZm9zW2ldOwogICAgICBpZiAoZG9jSW5mby5faWQgJiYgaXNMb2NhbElkKGRvY0luZm8uX2lkKSkgewogICAgICAgIGNoZWNrRG9uZSgpOyAvLyBza2lwIGxvY2FsIGRvY3MKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICB2YXIgcmVxID0gZG9jU3RvcmUuZ2V0KGRvY0luZm8ubWV0YWRhdGEuaWQpOwogICAgICByZXEub25zdWNjZXNzID0gcmVhZE1ldGFkYXRhOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY29tcGxldGUoKSB7CiAgICBpZiAocHJlY29uZGl0aW9uRXJyb3JlZCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgQ2hhbmdlcy5ub3RpZnkoYXBpLl9tZXRhLm5hbWUpOwogICAgYXBpLl9tZXRhLmRvY0NvdW50ICs9IGRvY0NvdW50RGVsdGE7CiAgICBjYWxsYmFjayhudWxsLCByZXN1bHRzKTsKICB9CgogIGZ1bmN0aW9uIHZlcmlmeUF0dGFjaG1lbnQoZGlnZXN0LCBjYWxsYmFjaykgewoKICAgIHZhciByZXEgPSBhdHRhY2hTdG9yZS5nZXQoZGlnZXN0KTsKICAgIHJlcS5vbnN1Y2Nlc3MgPSBmdW5jdGlvbiAoZSkgewogICAgICBpZiAoIWUudGFyZ2V0LnJlc3VsdCkgewogICAgICAgIHZhciBlcnIgPSBlcnJvcnMuZXJyb3IoZXJyb3JzLk1JU1NJTkdfU1RVQiwKICAgICAgICAgICd1bmtub3duIHN0dWIgYXR0YWNobWVudCB3aXRoIGRpZ2VzdCAnICsKICAgICAgICAgIGRpZ2VzdCk7CiAgICAgICAgZXJyLnN0YXR1cyA9IDQxMjsKICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrKCk7CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiB2ZXJpZnlBdHRhY2htZW50cyhmaW5pc2gpIHsKCgogICAgdmFyIGRpZ2VzdHMgPSBbXTsKICAgIGRvY0luZm9zLmZvckVhY2goZnVuY3Rpb24gKGRvY0luZm8pIHsKICAgICAgaWYgKGRvY0luZm8uZGF0YSAmJiBkb2NJbmZvLmRhdGEuX2F0dGFjaG1lbnRzKSB7CiAgICAgICAgT2JqZWN0LmtleXMoZG9jSW5mby5kYXRhLl9hdHRhY2htZW50cykuZm9yRWFjaChmdW5jdGlvbiAoZmlsZW5hbWUpIHsKICAgICAgICAgIHZhciBhdHQgPSBkb2NJbmZvLmRhdGEuX2F0dGFjaG1lbnRzW2ZpbGVuYW1lXTsKICAgICAgICAgIGlmIChhdHQuc3R1YikgewogICAgICAgICAgICBkaWdlc3RzLnB1c2goYXR0LmRpZ2VzdCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKCFkaWdlc3RzLmxlbmd0aCkgewogICAgICByZXR1cm4gZmluaXNoKCk7CiAgICB9CiAgICB2YXIgbnVtRG9uZSA9IDA7CiAgICB2YXIgZXJyOwoKICAgIGZ1bmN0aW9uIGNoZWNrRG9uZSgpIHsKICAgICAgaWYgKCsrbnVtRG9uZSA9PT0gZGlnZXN0cy5sZW5ndGgpIHsKICAgICAgICBmaW5pc2goZXJyKTsKICAgICAgfQogICAgfQogICAgZGlnZXN0cy5mb3JFYWNoKGZ1bmN0aW9uIChkaWdlc3QpIHsKICAgICAgdmVyaWZ5QXR0YWNobWVudChkaWdlc3QsIGZ1bmN0aW9uIChhdHRFcnIpIHsKICAgICAgICBpZiAoYXR0RXJyICYmICFlcnIpIHsKICAgICAgICAgIGVyciA9IGF0dEVycjsKICAgICAgICB9CiAgICAgICAgY2hlY2tEb25lKCk7CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiB3cml0ZURvYyhkb2NJbmZvLCB3aW5uaW5nUmV2LCB3aW5uaW5nUmV2SXNEZWxldGVkLCBuZXdSZXZJc0RlbGV0ZWQsCiAgICAgICAgICAgICAgICAgICAgaXNVcGRhdGUsIGRlbHRhLCByZXN1bHRzSWR4LCBjYWxsYmFjaykgewoKICAgIGRvY0NvdW50RGVsdGEgKz0gZGVsdGE7CgogICAgZG9jSW5mby5tZXRhZGF0YS53aW5uaW5nUmV2ID0gd2lubmluZ1JldjsKICAgIGRvY0luZm8ubWV0YWRhdGEuZGVsZXRlZCA9IHdpbm5pbmdSZXZJc0RlbGV0ZWQ7CgogICAgdmFyIGRvYyA9IGRvY0luZm8uZGF0YTsKICAgIGRvYy5faWQgPSBkb2NJbmZvLm1ldGFkYXRhLmlkOwogICAgZG9jLl9yZXYgPSBkb2NJbmZvLm1ldGFkYXRhLnJldjsKCiAgICBpZiAobmV3UmV2SXNEZWxldGVkKSB7CiAgICAgIGRvYy5fZGVsZXRlZCA9IHRydWU7CiAgICB9CgogICAgdmFyIGhhc0F0dGFjaG1lbnRzID0gZG9jLl9hdHRhY2htZW50cyAmJgogICAgICBPYmplY3Qua2V5cyhkb2MuX2F0dGFjaG1lbnRzKS5sZW5ndGg7CiAgICBpZiAoaGFzQXR0YWNobWVudHMpIHsKICAgICAgcmV0dXJuIHdyaXRlQXR0YWNobWVudHMoZG9jSW5mbywgd2lubmluZ1Jldiwgd2lubmluZ1JldklzRGVsZXRlZCwKICAgICAgICBpc1VwZGF0ZSwgcmVzdWx0c0lkeCwgY2FsbGJhY2spOwogICAgfQoKICAgIGZpbmlzaERvYyhkb2NJbmZvLCB3aW5uaW5nUmV2LCB3aW5uaW5nUmV2SXNEZWxldGVkLAogICAgICBpc1VwZGF0ZSwgcmVzdWx0c0lkeCwgY2FsbGJhY2spOwogIH0KCiAgZnVuY3Rpb24gYXV0b0NvbXBhY3QoZG9jSW5mbykgewoKICAgIHZhciByZXZzVG9EZWxldGUgPSB1dGlscy5jb21wYWN0VHJlZShkb2NJbmZvLm1ldGFkYXRhKTsKICAgIGNvbXBhY3RSZXZzKHJldnNUb0RlbGV0ZSwgZG9jSW5mby5tZXRhZGF0YS5pZCwgdHhuKTsKICB9CgogIGZ1bmN0aW9uIGZpbmlzaERvYyhkb2NJbmZvLCB3aW5uaW5nUmV2LCB3aW5uaW5nUmV2SXNEZWxldGVkLAogICAgICAgICAgICAgICAgICAgICBpc1VwZGF0ZSwgcmVzdWx0c0lkeCwgY2FsbGJhY2spIHsKCiAgICB2YXIgZG9jID0gZG9jSW5mby5kYXRhOwogICAgdmFyIG1ldGFkYXRhID0gZG9jSW5mby5tZXRhZGF0YTsKCiAgICBkb2MuX2RvY19pZF9yZXYgPSBtZXRhZGF0YS5pZCArICc6OicgKyBtZXRhZGF0YS5yZXY7CiAgICBkZWxldGUgZG9jLl9pZDsKICAgIGRlbGV0ZSBkb2MuX3JldjsKCiAgICBmdW5jdGlvbiBhZnRlclB1dERvYyhlKSB7CiAgICAgIGlmIChpc1VwZGF0ZSAmJiBhcGkuYXV0b19jb21wYWN0aW9uKSB7CiAgICAgICAgYXV0b0NvbXBhY3QoZG9jSW5mbyk7CiAgICAgIH0KICAgICAgbWV0YWRhdGEuc2VxID0gZS50YXJnZXQucmVzdWx0OwogICAgICAvLyBDdXJyZW50IF9yZXYgaXMgY2FsY3VsYXRlZCBmcm9tIF9yZXZfdHJlZSBvbiByZWFkCiAgICAgIGRlbGV0ZSBtZXRhZGF0YS5yZXY7CiAgICAgIHZhciBtZXRhZGF0YVRvU3RvcmUgPSBlbmNvZGVNZXRhZGF0YShtZXRhZGF0YSwgd2lubmluZ1JldiwKICAgICAgICB3aW5uaW5nUmV2SXNEZWxldGVkKTsKICAgICAgdmFyIG1ldGFEYXRhUmVxID0gZG9jU3RvcmUucHV0KG1ldGFkYXRhVG9TdG9yZSk7CiAgICAgIG1ldGFEYXRhUmVxLm9uc3VjY2VzcyA9IGFmdGVyUHV0TWV0YWRhdGE7CiAgICB9CgogICAgZnVuY3Rpb24gYWZ0ZXJQdXREb2NFcnJvcihlKSB7CiAgICAgIC8vIENvbnN0cmFpbnRFcnJvciwgbmVlZCB0byB1cGRhdGUsIG5vdCBwdXQgKHNlZSAjMTYzOCBmb3IgZGV0YWlscykKICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOyAvLyBhdm9pZCB0cmFuc2FjdGlvbiBhYm9ydAogICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBhdm9pZCB0cmFuc2FjdGlvbiBvbmVycm9yCiAgICAgIHZhciBpbmRleCA9IGJ5U2VxU3RvcmUuaW5kZXgoJ19kb2NfaWRfcmV2Jyk7CiAgICAgIHZhciBnZXRLZXlSZXEgPSBpbmRleC5nZXRLZXkoZG9jLl9kb2NfaWRfcmV2KTsKICAgICAgZ2V0S2V5UmVxLm9uc3VjY2VzcyA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdmFyIHB1dFJlcSA9IGJ5U2VxU3RvcmUucHV0KGRvYywgZS50YXJnZXQucmVzdWx0KTsKICAgICAgICBwdXRSZXEub25zdWNjZXNzID0gYWZ0ZXJQdXREb2M7CiAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gYWZ0ZXJQdXRNZXRhZGF0YSgpIHsKICAgICAgcmVzdWx0c1tyZXN1bHRzSWR4XSA9IHsKICAgICAgICBvazogdHJ1ZSwKICAgICAgICBpZDogbWV0YWRhdGEuaWQsCiAgICAgICAgcmV2OiB3aW5uaW5nUmV2CiAgICAgIH07CiAgICAgIGZldGNoZWREb2NzLnNldChkb2NJbmZvLm1ldGFkYXRhLmlkLCBkb2NJbmZvLm1ldGFkYXRhKTsKICAgICAgaW5zZXJ0QXR0YWNobWVudE1hcHBpbmdzKGRvY0luZm8sIG1ldGFkYXRhLnNlcSwgY2FsbGJhY2spOwogICAgfQoKICAgIHZhciBwdXRSZXEgPSBieVNlcVN0b3JlLnB1dChkb2MpOwoKICAgIHB1dFJlcS5vbnN1Y2Nlc3MgPSBhZnRlclB1dERvYzsKICAgIHB1dFJlcS5vbmVycm9yID0gYWZ0ZXJQdXREb2NFcnJvcjsKICB9CgogIGZ1bmN0aW9uIHdyaXRlQXR0YWNobWVudHMoZG9jSW5mbywgd2lubmluZ1Jldiwgd2lubmluZ1JldklzRGVsZXRlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzVXBkYXRlLCByZXN1bHRzSWR4LCBjYWxsYmFjaykgewoKCiAgICB2YXIgZG9jID0gZG9jSW5mby5kYXRhOwoKICAgIHZhciBudW1Eb25lID0gMDsKICAgIHZhciBhdHRhY2htZW50cyA9IE9iamVjdC5rZXlzKGRvYy5fYXR0YWNobWVudHMpOwoKICAgIGZ1bmN0aW9uIGNvbGxlY3RSZXN1bHRzKCkgewogICAgICBpZiAobnVtRG9uZSA9PT0gYXR0YWNobWVudHMubGVuZ3RoKSB7CiAgICAgICAgZmluaXNoRG9jKGRvY0luZm8sIHdpbm5pbmdSZXYsIHdpbm5pbmdSZXZJc0RlbGV0ZWQsCiAgICAgICAgICBpc1VwZGF0ZSwgcmVzdWx0c0lkeCwgY2FsbGJhY2spOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gYXR0YWNobWVudFNhdmVkKCkgewogICAgICBudW1Eb25lKys7CiAgICAgIGNvbGxlY3RSZXN1bHRzKCk7CiAgICB9CgogICAgYXR0YWNobWVudHMuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBhdHQgPSBkb2NJbmZvLmRhdGEuX2F0dGFjaG1lbnRzW2tleV07CiAgICAgIGlmICghYXR0LnN0dWIpIHsKICAgICAgICB2YXIgZGF0YSA9IGF0dC5kYXRhOwogICAgICAgIGRlbGV0ZSBhdHQuZGF0YTsKICAgICAgICB2YXIgZGlnZXN0ID0gYXR0LmRpZ2VzdDsKICAgICAgICBzYXZlQXR0YWNobWVudChkaWdlc3QsIGRhdGEsIGF0dGFjaG1lbnRTYXZlZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbnVtRG9uZSsrOwogICAgICAgIGNvbGxlY3RSZXN1bHRzKCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgLy8gbWFwIHNlcXMgdG8gYXR0YWNobWVudCBkaWdlc3RzLCB3aGljaAogIC8vIHdlIHdpbGwgbmVlZCBsYXRlciBkdXJpbmcgY29tcGFjdGlvbgogIGZ1bmN0aW9uIGluc2VydEF0dGFjaG1lbnRNYXBwaW5ncyhkb2NJbmZvLCBzZXEsIGNhbGxiYWNrKSB7CgogICAgdmFyIGF0dHNBZGRlZCA9IDA7CiAgICB2YXIgYXR0c1RvQWRkID0gT2JqZWN0LmtleXMoZG9jSW5mby5kYXRhLl9hdHRhY2htZW50cyB8fCB7fSk7CgogICAgaWYgKCFhdHRzVG9BZGQubGVuZ3RoKSB7CiAgICAgIHJldHVybiBjYWxsYmFjaygpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNoZWNrRG9uZSgpIHsKICAgICAgaWYgKCsrYXR0c0FkZGVkID09PSBhdHRzVG9BZGQubGVuZ3RoKSB7CiAgICAgICAgY2FsbGJhY2soKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGFkZChhdHQpIHsKICAgICAgdmFyIGRpZ2VzdCA9IGRvY0luZm8uZGF0YS5fYXR0YWNobWVudHNbYXR0XS5kaWdlc3Q7CiAgICAgIHZhciByZXEgPSBhdHRhY2hBbmRTZXFTdG9yZS5wdXQoewogICAgICAgIHNlcTogc2VxLAogICAgICAgIGRpZ2VzdFNlcTogZGlnZXN0ICsgJzo6JyArIHNlcQogICAgICB9KTsKCiAgICAgIHJlcS5vbnN1Y2Nlc3MgPSBjaGVja0RvbmU7CiAgICAgIHJlcS5vbmVycm9yID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICAvLyB0aGlzIGNhbGxiYWNrIGlzIGZvciBhIGNvbnN0YWludCBlcnJvciwgd2hpY2ggd2UgaWdub3JlCiAgICAgICAgLy8gYmVjYXVzZSB0aGlzIGRvY2lkL3JldiBoYXMgYWxyZWFkeSBiZWVuIGFzc29jaWF0ZWQgd2l0aAogICAgICAgIC8vIHRoZSBkaWdlc3QgKGUuZy4gd2hlbiBuZXdfZWRpdHMgPT0gZmFsc2UpCiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOyAvLyBhdm9pZCB0cmFuc2FjdGlvbiBhYm9ydAogICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIGF2b2lkIHRyYW5zYWN0aW9uIG9uZXJyb3IKICAgICAgICBjaGVja0RvbmUoKTsKICAgICAgfTsKICAgIH0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXR0c1RvQWRkLmxlbmd0aDsgaSsrKSB7CiAgICAgIGFkZChhdHRzVG9BZGRbaV0pOyAvLyBkbyBpbiBwYXJhbGxlbAogICAgfQogIH0KCiAgZnVuY3Rpb24gc2F2ZUF0dGFjaG1lbnQoZGlnZXN0LCBkYXRhLCBjYWxsYmFjaykgewoKCiAgICB2YXIgZ2V0S2V5UmVxID0gYXR0YWNoU3RvcmUuY291bnQoZGlnZXN0KTsKICAgIGdldEtleVJlcS5vbnN1Y2Nlc3MgPSBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBjb3VudCA9IGUudGFyZ2V0LnJlc3VsdDsKICAgICAgaWYgKGNvdW50KSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKCk7IC8vIGFscmVhZHkgZXhpc3RzCiAgICAgIH0KICAgICAgdmFyIG5ld0F0dCA9IHsKICAgICAgICBkaWdlc3Q6IGRpZ2VzdCwKICAgICAgICBib2R5OiBkYXRhCiAgICAgIH07CiAgICAgIHZhciBwdXRSZXEgPSBhdHRhY2hTdG9yZS5wdXQobmV3QXR0KTsKICAgICAgcHV0UmVxLm9uc3VjY2VzcyA9IGNhbGxiYWNrOwogICAgfTsKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gaWRiQnVsa0RvY3M7Cgp9LHsiLi4vLi4vZGVwcy9kb2NzL2lzTG9jYWxJZCI6NTUsIi4uLy4uL2RlcHMvZG9jcy9wcmVwcm9jZXNzQXR0YWNobWVudHMiOjU5LCIuLi8uLi9kZXBzL2RvY3MvcHJvY2Vzc0RvY3MiOjYwLCIuLi8uLi9kZXBzL2Vycm9ycyI6NjQsIi4uLy4uL3V0aWxzIjoxMDIsIi4vY29uc3RhbnRzIjoyMCwiLi91dGlscyI6MjJ9XSwyMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIEluZGV4ZWREQiByZXF1aXJlcyBhIHZlcnNpb25lZCBkYXRhYmFzZSBzdHJ1Y3R1cmUsIHNvIHdlIHVzZSB0aGUKLy8gdmVyc2lvbiBoZXJlIHRvIG1hbmFnZSBtaWdyYXRpb25zLgpleHBvcnRzLkFEQVBURVJfVkVSU0lPTiA9IDU7CgovLyBUaGUgb2JqZWN0IHN0b3JlcyBjcmVhdGVkIGZvciBlYWNoIGRhdGFiYXNlCi8vIERPQ19TVE9SRSBzdG9yZXMgdGhlIGRvY3VtZW50IG1ldGEgZGF0YSwgaXRzIHJldmlzaW9uIGhpc3RvcnkgYW5kIHN0YXRlCi8vIEtleWVkIGJ5IGRvY3VtZW50IGlkCmV4cG9ydHMuIERPQ19TVE9SRSA9ICdkb2N1bWVudC1zdG9yZSc7Ci8vIEJZX1NFUV9TVE9SRSBzdG9yZXMgYSBwYXJ0aWN1bGFyIHZlcnNpb24gb2YgYSBkb2N1bWVudCwga2V5ZWQgYnkgaXRzCi8vIHNlcXVlbmNlIGlkCmV4cG9ydHMuQllfU0VRX1NUT1JFID0gJ2J5LXNlcXVlbmNlJzsKLy8gV2hlcmUgd2Ugc3RvcmUgYXR0YWNobWVudHMKZXhwb3J0cy5BVFRBQ0hfU1RPUkUgPSAnYXR0YWNoLXN0b3JlJzsKLy8gV2hlcmUgd2Ugc3RvcmUgbWFueS10by1tYW55IHJlbGF0aW9ucwovLyBiZXR3ZWVuIGF0dGFjaG1lbnQgZGlnZXN0cyBhbmQgc2VxcwpleHBvcnRzLkFUVEFDSF9BTkRfU0VRX1NUT1JFID0gJ2F0dGFjaC1zZXEtc3RvcmUnOwoKLy8gV2hlcmUgd2Ugc3RvcmUgZGF0YWJhc2Utd2lkZSBtZXRhIGRhdGEgaW4gYSBzaW5nbGUgcmVjb3JkCi8vIGtleWVkIGJ5IGlkOiBNRVRBX1NUT1JFCmV4cG9ydHMuTUVUQV9TVE9SRSA9ICdtZXRhLXN0b3JlJzsKLy8gV2hlcmUgd2Ugc3RvcmUgbG9jYWwgZG9jdW1lbnRzCmV4cG9ydHMuTE9DQUxfU1RPUkUgPSAnbG9jYWwtc3RvcmUnOwovLyBXaGVyZSB3ZSBkZXRlY3QgYmxvYiBzdXBwb3J0CmV4cG9ydHMuREVURUNUX0JMT0JfU1VQUE9SVF9TVE9SRSA9ICdkZXRlY3QtYmxvYi1zdXBwb3J0JzsKfSx7fV0sMjE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpewondXNlIHN0cmljdCc7Cgp2YXIgdXRpbHMgPSByZXF1aXJlKCcuLi8uLi91dGlscycpOwp2YXIgaXNEZWxldGVkID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9kb2NzL2lzRGVsZXRlZCcpOwp2YXIgaXNMb2NhbElkID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9kb2NzL2lzTG9jYWxJZCcpOwp2YXIgZXJyb3JzID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9lcnJvcnMnKTsKdmFyIGlkYlV0aWxzID0gcmVxdWlyZSgnLi91dGlscycpOwp2YXIgaWRiQ29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKTsKdmFyIGlkYkJ1bGtEb2NzID0gcmVxdWlyZSgnLi9idWxrRG9jcycpOwp2YXIgaWRiQWxsRG9jcyA9IHJlcXVpcmUoJy4vYWxsRG9jcycpOwp2YXIgY2hlY2tCbG9iU3VwcG9ydCA9IHJlcXVpcmUoJy4vYmxvYlN1cHBvcnQnKTsKdmFyIGhhc0xvY2FsU3RvcmFnZSA9IHJlcXVpcmUoJy4uLy4uL2RlcHMvZW52L2hhc0xvY2FsU3RvcmFnZScpOwp2YXIgY2FsY3VsYXRlV2lubmluZ1JldiA9IHJlcXVpcmUoJy4uLy4uL2RlcHMvbWVyZ2Uvd2lubmluZ1JldicpOwp2YXIgdHJhdmVyc2VSZXZUcmVlID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9tZXJnZS90cmF2ZXJzZVJldlRyZWUnKTsKCnZhciBBREFQVEVSX1ZFUlNJT04gPSBpZGJDb25zdGFudHMuQURBUFRFUl9WRVJTSU9OOwp2YXIgQVRUQUNIX0FORF9TRVFfU1RPUkUgPSBpZGJDb25zdGFudHMuQVRUQUNIX0FORF9TRVFfU1RPUkU7CnZhciBBVFRBQ0hfU1RPUkUgPSBpZGJDb25zdGFudHMuQVRUQUNIX1NUT1JFOwp2YXIgQllfU0VRX1NUT1JFID0gaWRiQ29uc3RhbnRzLkJZX1NFUV9TVE9SRTsKdmFyIERFVEVDVF9CTE9CX1NVUFBPUlRfU1RPUkUgPSBpZGJDb25zdGFudHMuREVURUNUX0JMT0JfU1VQUE9SVF9TVE9SRTsKdmFyIERPQ19TVE9SRSA9IGlkYkNvbnN0YW50cy5ET0NfU1RPUkU7CnZhciBMT0NBTF9TVE9SRSA9IGlkYkNvbnN0YW50cy5MT0NBTF9TVE9SRTsKdmFyIE1FVEFfU1RPUkUgPSBpZGJDb25zdGFudHMuTUVUQV9TVE9SRTsKCnZhciBhcHBseU5leHQgPSBpZGJVdGlscy5hcHBseU5leHQ7CnZhciBjb21wYWN0UmV2cyA9IGlkYlV0aWxzLmNvbXBhY3RSZXZzOwp2YXIgZGVjb2RlRG9jID0gaWRiVXRpbHMuZGVjb2RlRG9jOwp2YXIgZGVjb2RlTWV0YWRhdGEgPSBpZGJVdGlscy5kZWNvZGVNZXRhZGF0YTsKdmFyIGVuY29kZU1ldGFkYXRhID0gaWRiVXRpbHMuZW5jb2RlTWV0YWRhdGE7CnZhciBmZXRjaEF0dGFjaG1lbnRzSWZOZWNlc3NhcnkgPSBpZGJVdGlscy5mZXRjaEF0dGFjaG1lbnRzSWZOZWNlc3Nhcnk7CnZhciBpZGJFcnJvciA9IGlkYlV0aWxzLmlkYkVycm9yOwp2YXIgcG9zdFByb2Nlc3NBdHRhY2htZW50cyA9IGlkYlV0aWxzLnBvc3RQcm9jZXNzQXR0YWNobWVudHM7CnZhciByZWFkQmxvYkRhdGEgPSBpZGJVdGlscy5yZWFkQmxvYkRhdGE7CnZhciB0YXNrUXVldWUgPSBpZGJVdGlscy50YXNrUXVldWU7CnZhciBvcGVuVHJhbnNhY3Rpb25TYWZlbHkgPSBpZGJVdGlscy5vcGVuVHJhbnNhY3Rpb25TYWZlbHk7Cgp2YXIgY2FjaGVkREJzID0ge307CnZhciBibG9iU3VwcG9ydFByb21pc2U7CgpmdW5jdGlvbiBJZGJQb3VjaChvcHRzLCBjYWxsYmFjaykgewogIHZhciBhcGkgPSB0aGlzOwoKICB0YXNrUXVldWUucXVldWUucHVzaCh7CiAgICBhY3Rpb246IGZ1bmN0aW9uICh0aGlzQ2FsbGJhY2spIHsKICAgICAgaW5pdChhcGksIG9wdHMsIHRoaXNDYWxsYmFjayk7CiAgICB9LAogICAgY2FsbGJhY2s6IGNhbGxiYWNrCiAgfSk7CiAgYXBwbHlOZXh0KCk7Cn0KCmZ1bmN0aW9uIGluaXQoYXBpLCBvcHRzLCBjYWxsYmFjaykgewoKICB2YXIgZGJOYW1lID0gb3B0cy5uYW1lOwoKICB2YXIgaWRiID0gbnVsbDsKICBhcGkuX21ldGEgPSBudWxsOwoKICAvLyBjYWxsZWQgd2hlbiBjcmVhdGluZyBhIGZyZXNoIG5ldyBkYXRhYmFzZQogIGZ1bmN0aW9uIGNyZWF0ZVNjaGVtYShkYikgewogICAgdmFyIGRvY1N0b3JlID0gZGIuY3JlYXRlT2JqZWN0U3RvcmUoRE9DX1NUT1JFLCB7a2V5UGF0aCA6ICdpZCd9KTsKICAgIGRiLmNyZWF0ZU9iamVjdFN0b3JlKEJZX1NFUV9TVE9SRSwge2F1dG9JbmNyZW1lbnQ6IHRydWV9KQogICAgICAuY3JlYXRlSW5kZXgoJ19kb2NfaWRfcmV2JywgJ19kb2NfaWRfcmV2Jywge3VuaXF1ZTogdHJ1ZX0pOwogICAgZGIuY3JlYXRlT2JqZWN0U3RvcmUoQVRUQUNIX1NUT1JFLCB7a2V5UGF0aDogJ2RpZ2VzdCd9KTsKICAgIGRiLmNyZWF0ZU9iamVjdFN0b3JlKE1FVEFfU1RPUkUsIHtrZXlQYXRoOiAnaWQnLCBhdXRvSW5jcmVtZW50OiBmYWxzZX0pOwogICAgZGIuY3JlYXRlT2JqZWN0U3RvcmUoREVURUNUX0JMT0JfU1VQUE9SVF9TVE9SRSk7CgogICAgLy8gYWRkZWQgaW4gdjIKICAgIGRvY1N0b3JlLmNyZWF0ZUluZGV4KCdkZWxldGVkT3JMb2NhbCcsICdkZWxldGVkT3JMb2NhbCcsIHt1bmlxdWUgOiBmYWxzZX0pOwoKICAgIC8vIGFkZGVkIGluIHYzCiAgICBkYi5jcmVhdGVPYmplY3RTdG9yZShMT0NBTF9TVE9SRSwge2tleVBhdGg6ICdfaWQnfSk7CgogICAgLy8gYWRkZWQgaW4gdjQKICAgIHZhciBhdHRBbmRTZXFTdG9yZSA9IGRiLmNyZWF0ZU9iamVjdFN0b3JlKEFUVEFDSF9BTkRfU0VRX1NUT1JFLAogICAgICB7YXV0b0luY3JlbWVudDogdHJ1ZX0pOwogICAgYXR0QW5kU2VxU3RvcmUuY3JlYXRlSW5kZXgoJ3NlcScsICdzZXEnKTsKICAgIGF0dEFuZFNlcVN0b3JlLmNyZWF0ZUluZGV4KCdkaWdlc3RTZXEnLCAnZGlnZXN0U2VxJywge3VuaXF1ZTogdHJ1ZX0pOwogIH0KCiAgLy8gbWlncmF0aW9uIHRvIHZlcnNpb24gMgogIC8vIHVuZm9ydHVuYXRlbHkgImRlbGV0ZWRPckxvY2FsIiBpcyBhIG1pc25vbWVyIG5vdyB0aGF0IHdlIG5vIGxvbmdlcgogIC8vIHN0b3JlIGxvY2FsIGRvY3MgaW4gdGhlIG1haW4gZG9jLXN0b3JlLCBidXQgd2hhZGR5YWdvbm5hZG8KICBmdW5jdGlvbiBhZGREZWxldGVkT3JMb2NhbEluZGV4KHR4biwgY2FsbGJhY2spIHsKICAgIHZhciBkb2NTdG9yZSA9IHR4bi5vYmplY3RTdG9yZShET0NfU1RPUkUpOwogICAgZG9jU3RvcmUuY3JlYXRlSW5kZXgoJ2RlbGV0ZWRPckxvY2FsJywgJ2RlbGV0ZWRPckxvY2FsJywge3VuaXF1ZSA6IGZhbHNlfSk7CgogICAgZG9jU3RvcmUub3BlbkN1cnNvcigpLm9uc3VjY2VzcyA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICB2YXIgY3Vyc29yID0gZXZlbnQudGFyZ2V0LnJlc3VsdDsKICAgICAgaWYgKGN1cnNvcikgewogICAgICAgIHZhciBtZXRhZGF0YSA9IGN1cnNvci52YWx1ZTsKICAgICAgICB2YXIgZGVsZXRlZCA9IGlzRGVsZXRlZChtZXRhZGF0YSk7CiAgICAgICAgbWV0YWRhdGEuZGVsZXRlZE9yTG9jYWwgPSBkZWxldGVkID8gIjEiIDogIjAiOwogICAgICAgIGRvY1N0b3JlLnB1dChtZXRhZGF0YSk7CiAgICAgICAgY3Vyc29yLmNvbnRpbnVlKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2soKTsKICAgICAgfQogICAgfTsKICB9CgogIC8vIG1pZ3JhdGlvbiB0byB2ZXJzaW9uIDMgKHBhcnQgMSkKICBmdW5jdGlvbiBjcmVhdGVMb2NhbFN0b3JlU2NoZW1hKGRiKSB7CiAgICBkYi5jcmVhdGVPYmplY3RTdG9yZShMT0NBTF9TVE9SRSwge2tleVBhdGg6ICdfaWQnfSkKICAgICAgLmNyZWF0ZUluZGV4KCdfZG9jX2lkX3JldicsICdfZG9jX2lkX3JldicsIHt1bmlxdWU6IHRydWV9KTsKICB9CgogIC8vIG1pZ3JhdGlvbiB0byB2ZXJzaW9uIDMgKHBhcnQgMikKICBmdW5jdGlvbiBtaWdyYXRlTG9jYWxTdG9yZSh0eG4sIGNiKSB7CiAgICB2YXIgbG9jYWxTdG9yZSA9IHR4bi5vYmplY3RTdG9yZShMT0NBTF9TVE9SRSk7CiAgICB2YXIgZG9jU3RvcmUgPSB0eG4ub2JqZWN0U3RvcmUoRE9DX1NUT1JFKTsKICAgIHZhciBzZXFTdG9yZSA9IHR4bi5vYmplY3RTdG9yZShCWV9TRVFfU1RPUkUpOwoKICAgIHZhciBjdXJzb3IgPSBkb2NTdG9yZS5vcGVuQ3Vyc29yKCk7CiAgICBjdXJzb3Iub25zdWNjZXNzID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIHZhciBjdXJzb3IgPSBldmVudC50YXJnZXQucmVzdWx0OwogICAgICBpZiAoY3Vyc29yKSB7CiAgICAgICAgdmFyIG1ldGFkYXRhID0gY3Vyc29yLnZhbHVlOwogICAgICAgIHZhciBkb2NJZCA9IG1ldGFkYXRhLmlkOwogICAgICAgIHZhciBsb2NhbCA9IGlzTG9jYWxJZChkb2NJZCk7CiAgICAgICAgdmFyIHJldiA9IGNhbGN1bGF0ZVdpbm5pbmdSZXYobWV0YWRhdGEpOwogICAgICAgIGlmIChsb2NhbCkgewogICAgICAgICAgdmFyIGRvY0lkUmV2ID0gZG9jSWQgKyAiOjoiICsgcmV2OwogICAgICAgICAgLy8gcmVtb3ZlIGFsbCBzZXEgZW50cmllcwogICAgICAgICAgLy8gYXNzb2NpYXRlZCB3aXRoIHRoaXMgZG9jSWQKICAgICAgICAgIHZhciBzdGFydCA9IGRvY0lkICsgIjo6IjsKICAgICAgICAgIHZhciBlbmQgPSBkb2NJZCArICI6On4iOwogICAgICAgICAgdmFyIGluZGV4ID0gc2VxU3RvcmUuaW5kZXgoJ19kb2NfaWRfcmV2Jyk7CiAgICAgICAgICB2YXIgcmFuZ2UgPSBJREJLZXlSYW5nZS5ib3VuZChzdGFydCwgZW5kLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgdmFyIHNlcUN1cnNvciA9IGluZGV4Lm9wZW5DdXJzb3IocmFuZ2UpOwogICAgICAgICAgc2VxQ3Vyc29yLm9uc3VjY2VzcyA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIHNlcUN1cnNvciA9IGUudGFyZ2V0LnJlc3VsdDsKICAgICAgICAgICAgaWYgKCFzZXFDdXJzb3IpIHsKICAgICAgICAgICAgICAvLyBkb25lCiAgICAgICAgICAgICAgZG9jU3RvcmUuZGVsZXRlKGN1cnNvci5wcmltYXJ5S2V5KTsKICAgICAgICAgICAgICBjdXJzb3IuY29udGludWUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZGF0YSA9IHNlcUN1cnNvci52YWx1ZTsKICAgICAgICAgICAgICBpZiAoZGF0YS5fZG9jX2lkX3JldiA9PT0gZG9jSWRSZXYpIHsKICAgICAgICAgICAgICAgIGxvY2FsU3RvcmUucHV0KGRhdGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzZXFTdG9yZS5kZWxldGUoc2VxQ3Vyc29yLnByaW1hcnlLZXkpOwogICAgICAgICAgICAgIHNlcUN1cnNvci5jb250aW51ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdXJzb3IuY29udGludWUoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoY2IpIHsKICAgICAgICBjYigpOwogICAgICB9CiAgICB9OwogIH0KCiAgLy8gbWlncmF0aW9uIHRvIHZlcnNpb24gNCAocGFydCAxKQogIGZ1bmN0aW9uIGFkZEF0dGFjaEFuZFNlcVN0b3JlKGRiKSB7CiAgICB2YXIgYXR0QW5kU2VxU3RvcmUgPSBkYi5jcmVhdGVPYmplY3RTdG9yZShBVFRBQ0hfQU5EX1NFUV9TVE9SRSwKICAgICAge2F1dG9JbmNyZW1lbnQ6IHRydWV9KTsKICAgIGF0dEFuZFNlcVN0b3JlLmNyZWF0ZUluZGV4KCdzZXEnLCAnc2VxJyk7CiAgICBhdHRBbmRTZXFTdG9yZS5jcmVhdGVJbmRleCgnZGlnZXN0U2VxJywgJ2RpZ2VzdFNlcScsIHt1bmlxdWU6IHRydWV9KTsKICB9CgogIC8vIG1pZ3JhdGlvbiB0byB2ZXJzaW9uIDQgKHBhcnQgMikKICBmdW5jdGlvbiBtaWdyYXRlQXR0c0FuZFNlcXModHhuLCBjYWxsYmFjaykgewogICAgdmFyIHNlcVN0b3JlID0gdHhuLm9iamVjdFN0b3JlKEJZX1NFUV9TVE9SRSk7CiAgICB2YXIgYXR0U3RvcmUgPSB0eG4ub2JqZWN0U3RvcmUoQVRUQUNIX1NUT1JFKTsKICAgIHZhciBhdHRBbmRTZXFTdG9yZSA9IHR4bi5vYmplY3RTdG9yZShBVFRBQ0hfQU5EX1NFUV9TVE9SRSk7CgogICAgLy8gbmVlZCB0byBhY3R1YWxseSBwb3B1bGF0ZSB0aGUgdGFibGUuIHRoaXMgaXMgdGhlIGV4cGVuc2l2ZSBwYXJ0LAogICAgLy8gc28gYXMgYW4gb3B0aW1pemF0aW9uLCBjaGVjayBmaXJzdCB0aGF0IHRoaXMgZGF0YWJhc2UgZXZlbgogICAgLy8gY29udGFpbnMgYXR0YWNobWVudHMKICAgIHZhciByZXEgPSBhdHRTdG9yZS5jb3VudCgpOwogICAgcmVxLm9uc3VjY2VzcyA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBjb3VudCA9IGUudGFyZ2V0LnJlc3VsdDsKICAgICAgaWYgKCFjb3VudCkgewogICAgICAgIHJldHVybiBjYWxsYmFjaygpOyAvLyBkb25lCiAgICAgIH0KCiAgICAgIHNlcVN0b3JlLm9wZW5DdXJzb3IoKS5vbnN1Y2Nlc3MgPSBmdW5jdGlvbiAoZSkgewogICAgICAgIHZhciBjdXJzb3IgPSBlLnRhcmdldC5yZXN1bHQ7CiAgICAgICAgaWYgKCFjdXJzb3IpIHsKICAgICAgICAgIHJldHVybiBjYWxsYmFjaygpOyAvLyBkb25lCiAgICAgICAgfQogICAgICAgIHZhciBkb2MgPSBjdXJzb3IudmFsdWU7CiAgICAgICAgdmFyIHNlcSA9IGN1cnNvci5wcmltYXJ5S2V5OwogICAgICAgIHZhciBhdHRzID0gT2JqZWN0LmtleXMoZG9jLl9hdHRhY2htZW50cyB8fCB7fSk7CiAgICAgICAgdmFyIGRpZ2VzdE1hcCA9IHt9OwogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYXR0cy5sZW5ndGg7IGorKykgewogICAgICAgICAgdmFyIGF0dCA9IGRvYy5fYXR0YWNobWVudHNbYXR0c1tqXV07CiAgICAgICAgICBkaWdlc3RNYXBbYXR0LmRpZ2VzdF0gPSB0cnVlOyAvLyB1bmlxIGRpZ2VzdHMsIGp1c3QgaW4gY2FzZQogICAgICAgIH0KICAgICAgICB2YXIgZGlnZXN0cyA9IE9iamVjdC5rZXlzKGRpZ2VzdE1hcCk7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IGRpZ2VzdHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIHZhciBkaWdlc3QgPSBkaWdlc3RzW2pdOwogICAgICAgICAgYXR0QW5kU2VxU3RvcmUucHV0KHsKICAgICAgICAgICAgc2VxOiBzZXEsCiAgICAgICAgICAgIGRpZ2VzdFNlcTogZGlnZXN0ICsgJzo6JyArIHNlcQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGN1cnNvci5jb250aW51ZSgpOwogICAgICB9OwogICAgfTsKICB9CgogIC8vIG1pZ3JhdGlvbiB0byB2ZXJzaW9uIDUKICAvLyBJbnN0ZWFkIG9mIHJlbHlpbmcgb24gb24tdGhlLWZseSBtaWdyYXRpb24gb2YgbWV0YWRhdGEsCiAgLy8gdGhpcyBicmluZ3MgdGhlIGRvYy1zdG9yZSB0byBpdHMgbW9kZXJuIGZvcm06CiAgLy8gLSBtZXRhZGF0YS53aW5uaW5ncmV2CiAgLy8gLSBtZXRhZGF0YS5zZXEKICAvLyAtIHN0cmluZ2lmeSB0aGUgbWV0YWRhdGEgd2hlbiBzdG9yaW5nIGl0CiAgZnVuY3Rpb24gbWlncmF0ZU1ldGFkYXRhKHR4bikgewoKICAgIGZ1bmN0aW9uIGRlY29kZU1ldGFkYXRhQ29tcGF0KHN0b3JlZE9iamVjdCkgewogICAgICBpZiAoIXN0b3JlZE9iamVjdC5kYXRhKSB7CiAgICAgICAgLy8gb2xkIGZvcm1hdCwgd2hlbiB3ZSBkaWRuJ3Qgc3RvcmUgaXQgc3RyaW5naWZpZWQKICAgICAgICBzdG9yZWRPYmplY3QuZGVsZXRlZCA9IHN0b3JlZE9iamVjdC5kZWxldGVkT3JMb2NhbCA9PT0gJzEnOwogICAgICAgIHJldHVybiBzdG9yZWRPYmplY3Q7CiAgICAgIH0KICAgICAgcmV0dXJuIGRlY29kZU1ldGFkYXRhKHN0b3JlZE9iamVjdCk7CiAgICB9CgogICAgLy8gZW5zdXJlIHRoYXQgZXZlcnkgbWV0YWRhdGEgaGFzIGEgd2lubmluZ1JldiBhbmQgc2VxLAogICAgLy8gd2hpY2ggd2FzIHByZXZpb3VzbHkgY3JlYXRlZCBvbi10aGUtZmx5IGJ1dCBiZXR0ZXIgdG8gbWlncmF0ZQogICAgdmFyIGJ5U2VxU3RvcmUgPSB0eG4ub2JqZWN0U3RvcmUoQllfU0VRX1NUT1JFKTsKICAgIHZhciBkb2NTdG9yZSA9IHR4bi5vYmplY3RTdG9yZShET0NfU1RPUkUpOwogICAgdmFyIGN1cnNvciA9IGRvY1N0b3JlLm9wZW5DdXJzb3IoKTsKICAgIGN1cnNvci5vbnN1Y2Nlc3MgPSBmdW5jdGlvbiAoZSkgewogICAgICB2YXIgY3Vyc29yID0gZS50YXJnZXQucmVzdWx0OwogICAgICBpZiAoIWN1cnNvcikgewogICAgICAgIHJldHVybjsgLy8gZG9uZQogICAgICB9CiAgICAgIHZhciBtZXRhZGF0YSA9IGRlY29kZU1ldGFkYXRhQ29tcGF0KGN1cnNvci52YWx1ZSk7CgogICAgICBtZXRhZGF0YS53aW5uaW5nUmV2ID0gbWV0YWRhdGEud2lubmluZ1JldiB8fAogICAgICAgIGNhbGN1bGF0ZVdpbm5pbmdSZXYobWV0YWRhdGEpOwoKICAgICAgZnVuY3Rpb24gZmV0Y2hNZXRhZGF0YVNlcSgpIHsKICAgICAgICAvLyBtZXRhZGF0YS5zZXEgd2FzIGFkZGVkIHBvc3QtMy4yLjAsIHNvIGlmIGl0J3MgbWlzc2luZywKICAgICAgICAvLyB3ZSBuZWVkIHRvIGZldGNoIGl0IG1hbnVhbGx5CiAgICAgICAgdmFyIHN0YXJ0ID0gbWV0YWRhdGEuaWQgKyAnOjonOwogICAgICAgIHZhciBlbmQgPSBtZXRhZGF0YS5pZCArICc6Olx1ZmZmZic7CiAgICAgICAgdmFyIHJlcSA9IGJ5U2VxU3RvcmUuaW5kZXgoJ19kb2NfaWRfcmV2Jykub3BlbkN1cnNvcigKICAgICAgICAgIElEQktleVJhbmdlLmJvdW5kKHN0YXJ0LCBlbmQpKTsKCiAgICAgICAgdmFyIG1ldGFkYXRhU2VxID0gMDsKICAgICAgICByZXEub25zdWNjZXNzID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIHZhciBjdXJzb3IgPSBlLnRhcmdldC5yZXN1bHQ7CiAgICAgICAgICBpZiAoIWN1cnNvcikgewogICAgICAgICAgICBtZXRhZGF0YS5zZXEgPSBtZXRhZGF0YVNlcTsKICAgICAgICAgICAgcmV0dXJuIG9uR2V0TWV0YWRhdGFTZXEoKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzZXEgPSBjdXJzb3IucHJpbWFyeUtleTsKICAgICAgICAgIGlmIChzZXEgPiBtZXRhZGF0YVNlcSkgewogICAgICAgICAgICBtZXRhZGF0YVNlcSA9IHNlcTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnNvci5jb250aW51ZSgpOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIG9uR2V0TWV0YWRhdGFTZXEoKSB7CiAgICAgICAgdmFyIG1ldGFkYXRhVG9TdG9yZSA9IGVuY29kZU1ldGFkYXRhKG1ldGFkYXRhLAogICAgICAgICAgbWV0YWRhdGEud2lubmluZ1JldiwgbWV0YWRhdGEuZGVsZXRlZCk7CgogICAgICAgIHZhciByZXEgPSBkb2NTdG9yZS5wdXQobWV0YWRhdGFUb1N0b3JlKTsKICAgICAgICByZXEub25zdWNjZXNzID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgY3Vyc29yLmNvbnRpbnVlKCk7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgaWYgKG1ldGFkYXRhLnNlcSkgewogICAgICAgIHJldHVybiBvbkdldE1ldGFkYXRhU2VxKCk7CiAgICAgIH0KCiAgICAgIGZldGNoTWV0YWRhdGFTZXEoKTsKICAgIH07CgogIH0KCiAgYXBpLnR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gJ2lkYic7CiAgfTsKCiAgYXBpLl9pZCA9IHV0aWxzLnRvUHJvbWlzZShmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgIGNhbGxiYWNrKG51bGwsIGFwaS5fbWV0YS5pbnN0YW5jZUlkKTsKICB9KTsKCiAgYXBpLl9idWxrRG9jcyA9IGZ1bmN0aW9uIGlkYl9idWxrRG9jcyhyZXEsIG9wdHMsIGNhbGxiYWNrKSB7CiAgICBpZGJCdWxrRG9jcyhyZXEsIG9wdHMsIGFwaSwgaWRiLCBJZGJQb3VjaC5DaGFuZ2VzLCBjYWxsYmFjayk7CiAgfTsKCiAgLy8gRmlyc3Qgd2UgbG9vayB1cCB0aGUgbWV0YWRhdGEgaW4gdGhlIGlkcyBkYXRhYmFzZSwgdGhlbiB3ZSBmZXRjaCB0aGUKICAvLyBjdXJyZW50IHJldmlzaW9uKHMpIGZyb20gdGhlIGJ5IHNlcXVlbmNlIHN0b3JlCiAgYXBpLl9nZXQgPSBmdW5jdGlvbiBpZGJfZ2V0KGlkLCBvcHRzLCBjYWxsYmFjaykgewogICAgdmFyIGRvYzsKICAgIHZhciBtZXRhZGF0YTsKICAgIHZhciBlcnI7CiAgICB2YXIgdHhuID0gb3B0cy5jdHg7CiAgICBpZiAoIXR4bikgewogICAgICB2YXIgdHhuUmVzdWx0ID0gb3BlblRyYW5zYWN0aW9uU2FmZWx5KGlkYiwKICAgICAgICBbRE9DX1NUT1JFLCBCWV9TRVFfU1RPUkUsIEFUVEFDSF9TVE9SRV0sICdyZWFkb25seScpOwogICAgICBpZiAodHhuUmVzdWx0LmVycm9yKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHR4blJlc3VsdC5lcnJvcik7CiAgICAgIH0KICAgICAgdHhuID0gdHhuUmVzdWx0LnR4bjsKICAgIH0KCiAgICBmdW5jdGlvbiBmaW5pc2goKSB7CiAgICAgIGNhbGxiYWNrKGVyciwge2RvYzogZG9jLCBtZXRhZGF0YTogbWV0YWRhdGEsIGN0eDogdHhufSk7CiAgICB9CgogICAgdHhuLm9iamVjdFN0b3JlKERPQ19TVE9SRSkuZ2V0KGlkKS5vbnN1Y2Nlc3MgPSBmdW5jdGlvbiAoZSkgewogICAgICBtZXRhZGF0YSA9IGRlY29kZU1ldGFkYXRhKGUudGFyZ2V0LnJlc3VsdCk7CiAgICAgIC8vIHdlIGNhbiBkZXRlcm1pbmUgdGhlIHJlc3VsdCBoZXJlIGlmOgogICAgICAvLyAxLiB0aGVyZSBpcyBubyBzdWNoIGRvY3VtZW50CiAgICAgIC8vIDIuIHRoZSBkb2N1bWVudCBpcyBkZWxldGVkIGFuZCB3ZSBkb24ndCBhc2sgYWJvdXQgc3BlY2lmaWMgcmV2CiAgICAgIC8vIFdoZW4gd2UgYXNrIHdpdGggb3B0cy5yZXYgd2UgZXhwZWN0IHRoZSBhbnN3ZXIgdG8gYmUgZWl0aGVyCiAgICAgIC8vIGRvYyAocG9zc2libHkgd2l0aCBfZGVsZXRlZD10cnVlKSBvciBtaXNzaW5nIGVycm9yCiAgICAgIGlmICghbWV0YWRhdGEpIHsKICAgICAgICBlcnIgPSBlcnJvcnMuZXJyb3IoZXJyb3JzLk1JU1NJTkdfRE9DLCAnbWlzc2luZycpOwogICAgICAgIHJldHVybiBmaW5pc2goKTsKICAgICAgfQogICAgICBpZiAoaXNEZWxldGVkKG1ldGFkYXRhKSAmJiAhb3B0cy5yZXYpIHsKICAgICAgICBlcnIgPSBlcnJvcnMuZXJyb3IoZXJyb3JzLk1JU1NJTkdfRE9DLCAiZGVsZXRlZCIpOwogICAgICAgIHJldHVybiBmaW5pc2goKTsKICAgICAgfQogICAgICB2YXIgb2JqZWN0U3RvcmUgPSB0eG4ub2JqZWN0U3RvcmUoQllfU0VRX1NUT1JFKTsKCiAgICAgIHZhciByZXYgPSBvcHRzLnJldiB8fCBtZXRhZGF0YS53aW5uaW5nUmV2OwogICAgICB2YXIga2V5ID0gbWV0YWRhdGEuaWQgKyAnOjonICsgcmV2OwoKICAgICAgb2JqZWN0U3RvcmUuaW5kZXgoJ19kb2NfaWRfcmV2JykuZ2V0KGtleSkub25zdWNjZXNzID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICBkb2MgPSBlLnRhcmdldC5yZXN1bHQ7CiAgICAgICAgaWYgKGRvYykgewogICAgICAgICAgZG9jID0gZGVjb2RlRG9jKGRvYyk7CiAgICAgICAgfQogICAgICAgIGlmICghZG9jKSB7CiAgICAgICAgICBlcnIgPSBlcnJvcnMuZXJyb3IoZXJyb3JzLk1JU1NJTkdfRE9DLCAnbWlzc2luZycpOwogICAgICAgICAgcmV0dXJuIGZpbmlzaCgpOwogICAgICAgIH0KICAgICAgICBmaW5pc2goKTsKICAgICAgfTsKICAgIH07CiAgfTsKCiAgYXBpLl9nZXRBdHRhY2htZW50ID0gZnVuY3Rpb24gKGF0dGFjaG1lbnQsIG9wdHMsIGNhbGxiYWNrKSB7CiAgICB2YXIgdHhuOwogICAgaWYgKG9wdHMuY3R4KSB7CiAgICAgIHR4biA9IG9wdHMuY3R4OwogICAgfSBlbHNlIHsKICAgICAgdmFyIHR4blJlc3VsdCA9IG9wZW5UcmFuc2FjdGlvblNhZmVseShpZGIsCiAgICAgICAgW0RPQ19TVE9SRSwgQllfU0VRX1NUT1JFLCBBVFRBQ0hfU1RPUkVdLCAncmVhZG9ubHknKTsKICAgICAgaWYgKHR4blJlc3VsdC5lcnJvcikgewogICAgICAgIHJldHVybiBjYWxsYmFjayh0eG5SZXN1bHQuZXJyb3IpOwogICAgICB9CiAgICAgIHR4biA9IHR4blJlc3VsdC50eG47CiAgICB9CiAgICB2YXIgZGlnZXN0ID0gYXR0YWNobWVudC5kaWdlc3Q7CiAgICB2YXIgdHlwZSA9IGF0dGFjaG1lbnQuY29udGVudF90eXBlOwoKICAgIHR4bi5vYmplY3RTdG9yZShBVFRBQ0hfU1RPUkUpLmdldChkaWdlc3QpLm9uc3VjY2VzcyA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBib2R5ID0gZS50YXJnZXQucmVzdWx0LmJvZHk7CiAgICAgIHJlYWRCbG9iRGF0YShib2R5LCB0eXBlLCBvcHRzLmJpbmFyeSwgZnVuY3Rpb24gKGJsb2JEYXRhKSB7CiAgICAgICAgY2FsbGJhY2sobnVsbCwgYmxvYkRhdGEpOwogICAgICB9KTsKICAgIH07CiAgfTsKCiAgYXBpLl9pbmZvID0gZnVuY3Rpb24gaWRiX2luZm8oY2FsbGJhY2spIHsKCiAgICBpZiAoaWRiID09PSBudWxsIHx8ICFjYWNoZWREQnNbZGJOYW1lXSkgewogICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoJ2RiIGlzblwndCBvcGVuJyk7CiAgICAgIGVycm9yLmlkID0gJ2lkYk51bGwnOwogICAgICByZXR1cm4gY2FsbGJhY2soZXJyb3IpOwogICAgfQogICAgdmFyIHVwZGF0ZVNlcTsKICAgIHZhciBkb2NDb3VudDsKCiAgICB2YXIgdHhuUmVzdWx0ID0gb3BlblRyYW5zYWN0aW9uU2FmZWx5KGlkYiwgW0JZX1NFUV9TVE9SRV0sICdyZWFkb25seScpOwogICAgaWYgKHR4blJlc3VsdC5lcnJvcikgewogICAgICByZXR1cm4gY2FsbGJhY2sodHhuUmVzdWx0LmVycm9yKTsKICAgIH0KICAgIHZhciB0eG4gPSB0eG5SZXN1bHQudHhuOwogICAgdmFyIGN1cnNvciA9IHR4bi5vYmplY3RTdG9yZShCWV9TRVFfU1RPUkUpLm9wZW5DdXJzb3IobnVsbCwgJ3ByZXYnKTsKICAgIGN1cnNvci5vbnN1Y2Nlc3MgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgdmFyIGN1cnNvciA9IGV2ZW50LnRhcmdldC5yZXN1bHQ7CiAgICAgIHVwZGF0ZVNlcSA9IGN1cnNvciA/IGN1cnNvci5rZXkgOiAwOwogICAgICAvLyBjb3VudCB3aXRoaW4gdGhlIHNhbWUgdHhuIGZvciBjb25zaXN0ZW5jeQogICAgICBkb2NDb3VudCA9IGFwaS5fbWV0YS5kb2NDb3VudDsKICAgIH07CgogICAgdHhuLm9uY29tcGxldGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGNhbGxiYWNrKG51bGwsIHsKICAgICAgICBkb2NfY291bnQ6IGRvY0NvdW50LAogICAgICAgIHVwZGF0ZV9zZXE6IHVwZGF0ZVNlcSwKICAgICAgICAvLyBmb3IgZGVidWdnaW5nCiAgICAgICAgaWRiX2F0dGFjaG1lbnRfZm9ybWF0OiAoYXBpLl9tZXRhLmJsb2JTdXBwb3J0ID8gJ2JpbmFyeScgOiAnYmFzZTY0JykKICAgICAgfSk7CiAgICB9OwogIH07CgogIGFwaS5fYWxsRG9jcyA9IGZ1bmN0aW9uIGlkYl9hbGxEb2NzKG9wdHMsIGNhbGxiYWNrKSB7CiAgICBpZGJBbGxEb2NzKG9wdHMsIGFwaSwgaWRiLCBjYWxsYmFjayk7CiAgfTsKCiAgYXBpLl9jaGFuZ2VzID0gZnVuY3Rpb24gKG9wdHMpIHsKICAgIG9wdHMgPSB1dGlscy5jbG9uZShvcHRzKTsKCiAgICBpZiAob3B0cy5jb250aW51b3VzKSB7CiAgICAgIHZhciBpZCA9IGRiTmFtZSArICc6JyArIHV0aWxzLnV1aWQoKTsKICAgICAgSWRiUG91Y2guQ2hhbmdlcy5hZGRMaXN0ZW5lcihkYk5hbWUsIGlkLCBhcGksIG9wdHMpOwogICAgICBJZGJQb3VjaC5DaGFuZ2VzLm5vdGlmeShkYk5hbWUpOwogICAgICByZXR1cm4gewogICAgICAgIGNhbmNlbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgSWRiUG91Y2guQ2hhbmdlcy5yZW1vdmVMaXN0ZW5lcihkYk5hbWUsIGlkKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CgogICAgdmFyIGRvY0lkcyA9IG9wdHMuZG9jX2lkcyAmJiBuZXcgdXRpbHMuU2V0KG9wdHMuZG9jX2lkcyk7CgogICAgb3B0cy5zaW5jZSA9IG9wdHMuc2luY2UgfHwgMDsKICAgIHZhciBsYXN0U2VxID0gb3B0cy5zaW5jZTsKCiAgICB2YXIgbGltaXQgPSAnbGltaXQnIGluIG9wdHMgPyBvcHRzLmxpbWl0IDogLTE7CiAgICBpZiAobGltaXQgPT09IDApIHsKICAgICAgbGltaXQgPSAxOyAvLyBwZXIgQ291Y2hEQiBfY2hhbmdlcyBzcGVjCiAgICB9CiAgICB2YXIgcmV0dXJuRG9jczsKICAgIGlmICgncmV0dXJuRG9jcycgaW4gb3B0cykgewogICAgICByZXR1cm5Eb2NzID0gb3B0cy5yZXR1cm5Eb2NzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuRG9jcyA9IHRydWU7CiAgICB9CgogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIHZhciBudW1SZXN1bHRzID0gMDsKICAgIHZhciBmaWx0ZXIgPSB1dGlscy5maWx0ZXJDaGFuZ2Uob3B0cyk7CiAgICB2YXIgZG9jSWRzVG9NZXRhZGF0YSA9IG5ldyB1dGlscy5NYXAoKTsKCiAgICB2YXIgdHhuOwogICAgdmFyIGJ5U2VxU3RvcmU7CiAgICB2YXIgZG9jU3RvcmU7CiAgICB2YXIgZG9jSWRSZXZJbmRleDsKCiAgICBmdW5jdGlvbiBvbkdldEN1cnNvcihjdXJzb3IpIHsKCiAgICAgIHZhciBkb2MgPSBkZWNvZGVEb2MoY3Vyc29yLnZhbHVlKTsKICAgICAgdmFyIHNlcSA9IGN1cnNvci5rZXk7CgogICAgICBpZiAoZG9jSWRzICYmICFkb2NJZHMuaGFzKGRvYy5faWQpKSB7CiAgICAgICAgcmV0dXJuIGN1cnNvci5jb250aW51ZSgpOwogICAgICB9CgogICAgICB2YXIgbWV0YWRhdGE7CgogICAgICBmdW5jdGlvbiBvbkdldE1ldGFkYXRhKCkgewogICAgICAgIGlmIChtZXRhZGF0YS5zZXEgIT09IHNlcSkgewogICAgICAgICAgLy8gc29tZSBvdGhlciBzZXEgaXMgbGF0ZXIKICAgICAgICAgIHJldHVybiBjdXJzb3IuY29udGludWUoKTsKICAgICAgICB9CgogICAgICAgIGxhc3RTZXEgPSBzZXE7CgogICAgICAgIGlmIChtZXRhZGF0YS53aW5uaW5nUmV2ID09PSBkb2MuX3JldikgewogICAgICAgICAgcmV0dXJuIG9uR2V0V2lubmluZ0RvYyhkb2MpOwogICAgICAgIH0KCiAgICAgICAgZmV0Y2hXaW5uaW5nRG9jKCk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGZldGNoV2lubmluZ0RvYygpIHsKICAgICAgICB2YXIgZG9jSWRSZXYgPSBkb2MuX2lkICsgJzo6JyArIG1ldGFkYXRhLndpbm5pbmdSZXY7CiAgICAgICAgdmFyIHJlcSA9IGRvY0lkUmV2SW5kZXguZ2V0KGRvY0lkUmV2KTsKICAgICAgICByZXEub25zdWNjZXNzID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIG9uR2V0V2lubmluZ0RvYyhkZWNvZGVEb2MoZS50YXJnZXQucmVzdWx0KSk7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gb25HZXRXaW5uaW5nRG9jKHdpbm5pbmdEb2MpIHsKCiAgICAgICAgdmFyIGNoYW5nZSA9IG9wdHMucHJvY2Vzc0NoYW5nZSh3aW5uaW5nRG9jLCBtZXRhZGF0YSwgb3B0cyk7CiAgICAgICAgY2hhbmdlLnNlcSA9IG1ldGFkYXRhLnNlcTsKCiAgICAgICAgdmFyIGZpbHRlcmVkID0gZmlsdGVyKGNoYW5nZSk7CiAgICAgICAgaWYgKHR5cGVvZiBmaWx0ZXJlZCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgIHJldHVybiBvcHRzLmNvbXBsZXRlKGZpbHRlcmVkKTsKICAgICAgICB9CgogICAgICAgIGlmIChmaWx0ZXJlZCkgewogICAgICAgICAgbnVtUmVzdWx0cysrOwogICAgICAgICAgaWYgKHJldHVybkRvY3MpIHsKICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGNoYW5nZSk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBwcm9jZXNzIHRoZSBhdHRhY2htZW50IGltbWVkaWF0ZWx5CiAgICAgICAgICAvLyBmb3IgdGhlIGJlbmVmaXQgb2YgbGl2ZSBsaXN0ZW5lcnMKICAgICAgICAgIGlmIChvcHRzLmF0dGFjaG1lbnRzICYmIG9wdHMuaW5jbHVkZV9kb2NzKSB7CiAgICAgICAgICAgIGZldGNoQXR0YWNobWVudHNJZk5lY2Vzc2FyeSh3aW5uaW5nRG9jLCBvcHRzLCB0eG4sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBwb3N0UHJvY2Vzc0F0dGFjaG1lbnRzKFtjaGFuZ2VdLCBvcHRzLmJpbmFyeSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBvcHRzLm9uQ2hhbmdlKGNoYW5nZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb3B0cy5vbkNoYW5nZShjaGFuZ2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobnVtUmVzdWx0cyAhPT0gbGltaXQpIHsKICAgICAgICAgIGN1cnNvci5jb250aW51ZSgpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgbWV0YWRhdGEgPSBkb2NJZHNUb01ldGFkYXRhLmdldChkb2MuX2lkKTsKICAgICAgaWYgKG1ldGFkYXRhKSB7IC8vIGNhY2hlZAogICAgICAgIHJldHVybiBvbkdldE1ldGFkYXRhKCk7CiAgICAgIH0KICAgICAgLy8gbWV0YWRhdGEgbm90IGNhY2hlZCwgaGF2ZSB0byBnbyBmZXRjaCBpdAogICAgICBkb2NTdG9yZS5nZXQoZG9jLl9pZCkub25zdWNjZXNzID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgbWV0YWRhdGEgPSBkZWNvZGVNZXRhZGF0YShldmVudC50YXJnZXQucmVzdWx0KTsKICAgICAgICBkb2NJZHNUb01ldGFkYXRhLnNldChkb2MuX2lkLCBtZXRhZGF0YSk7CiAgICAgICAgb25HZXRNZXRhZGF0YSgpOwogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIG9uc3VjY2VzcyhldmVudCkgewogICAgICB2YXIgY3Vyc29yID0gZXZlbnQudGFyZ2V0LnJlc3VsdDsKCiAgICAgIGlmICghY3Vyc29yKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIG9uR2V0Q3Vyc29yKGN1cnNvcik7CiAgICB9CgogICAgZnVuY3Rpb24gZmV0Y2hDaGFuZ2VzKCkgewogICAgICB2YXIgb2JqZWN0U3RvcmVzID0gW0RPQ19TVE9SRSwgQllfU0VRX1NUT1JFXTsKICAgICAgaWYgKG9wdHMuYXR0YWNobWVudHMpIHsKICAgICAgICBvYmplY3RTdG9yZXMucHVzaChBVFRBQ0hfU1RPUkUpOwogICAgICB9CiAgICAgIHZhciB0eG5SZXN1bHQgPSBvcGVuVHJhbnNhY3Rpb25TYWZlbHkoaWRiLCBvYmplY3RTdG9yZXMsICdyZWFkb25seScpOwogICAgICBpZiAodHhuUmVzdWx0LmVycm9yKSB7CiAgICAgICAgcmV0dXJuIG9wdHMuY29tcGxldGUodHhuUmVzdWx0LmVycm9yKTsKICAgICAgfQogICAgICB0eG4gPSB0eG5SZXN1bHQudHhuOwogICAgICB0eG4ub25hYm9ydCA9IGlkYkVycm9yKG9wdHMuY29tcGxldGUpOwogICAgICB0eG4ub25jb21wbGV0ZSA9IG9uVHhuQ29tcGxldGU7CgogICAgICBieVNlcVN0b3JlID0gdHhuLm9iamVjdFN0b3JlKEJZX1NFUV9TVE9SRSk7CiAgICAgIGRvY1N0b3JlID0gdHhuLm9iamVjdFN0b3JlKERPQ19TVE9SRSk7CiAgICAgIGRvY0lkUmV2SW5kZXggPSBieVNlcVN0b3JlLmluZGV4KCdfZG9jX2lkX3JldicpOwoKICAgICAgdmFyIHJlcTsKCiAgICAgIGlmIChvcHRzLmRlc2NlbmRpbmcpIHsKICAgICAgICByZXEgPSBieVNlcVN0b3JlLm9wZW5DdXJzb3IobnVsbCwgJ3ByZXYnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXEgPSBieVNlcVN0b3JlLm9wZW5DdXJzb3IoSURCS2V5UmFuZ2UubG93ZXJCb3VuZChvcHRzLnNpbmNlLCB0cnVlKSk7CiAgICAgIH0KCiAgICAgIHJlcS5vbnN1Y2Nlc3MgPSBvbnN1Y2Nlc3M7CiAgICB9CgogICAgZmV0Y2hDaGFuZ2VzKCk7CgogICAgZnVuY3Rpb24gb25UeG5Db21wbGV0ZSgpIHsKCiAgICAgIGZ1bmN0aW9uIGZpbmlzaCgpIHsKICAgICAgICBvcHRzLmNvbXBsZXRlKG51bGwsIHsKICAgICAgICAgIHJlc3VsdHM6IHJlc3VsdHMsCiAgICAgICAgICBsYXN0X3NlcTogbGFzdFNlcQogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZiAoIW9wdHMuY29udGludW91cyAmJiBvcHRzLmF0dGFjaG1lbnRzKSB7CiAgICAgICAgLy8gY2Fubm90IGd1YXJhbnRlZSB0aGF0IHBvc3RQcm9jZXNzaW5nIHdhcyBhbHJlYWR5IGRvbmUsCiAgICAgICAgLy8gc28gZG8gaXQgYWdhaW4KICAgICAgICBwb3N0UHJvY2Vzc0F0dGFjaG1lbnRzKHJlc3VsdHMpLnRoZW4oZmluaXNoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmaW5pc2goKTsKICAgICAgfQogICAgfQogIH07CgogIGFwaS5fY2xvc2UgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgIGlmIChpZGIgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycm9ycy5lcnJvcihlcnJvcnMuTk9UX09QRU4pKTsKICAgIH0KCiAgICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0luZGV4ZWREQi9JREJEYXRhYmFzZSNjbG9zZQogICAgLy8gIlJldHVybnMgaW1tZWRpYXRlbHkgYW5kIGNsb3NlcyB0aGUgY29ubmVjdGlvbiBpbiBhIHNlcGFyYXRlIHRocmVhZC4uLiIKICAgIGlkYi5jbG9zZSgpOwogICAgZGVsZXRlIGNhY2hlZERCc1tkYk5hbWVdOwogICAgaWRiID0gbnVsbDsKICAgIGNhbGxiYWNrKCk7CiAgfTsKCiAgYXBpLl9nZXRSZXZpc2lvblRyZWUgPSBmdW5jdGlvbiAoZG9jSWQsIGNhbGxiYWNrKSB7CiAgICB2YXIgdHhuUmVzdWx0ID0gb3BlblRyYW5zYWN0aW9uU2FmZWx5KGlkYiwgW0RPQ19TVE9SRV0sICdyZWFkb25seScpOwogICAgaWYgKHR4blJlc3VsdC5lcnJvcikgewogICAgICByZXR1cm4gY2FsbGJhY2sodHhuUmVzdWx0LmVycm9yKTsKICAgIH0KICAgIHZhciB0eG4gPSB0eG5SZXN1bHQudHhuOwogICAgdmFyIHJlcSA9IHR4bi5vYmplY3RTdG9yZShET0NfU1RPUkUpLmdldChkb2NJZCk7CiAgICByZXEub25zdWNjZXNzID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIHZhciBkb2MgPSBkZWNvZGVNZXRhZGF0YShldmVudC50YXJnZXQucmVzdWx0KTsKICAgICAgaWYgKCFkb2MpIHsKICAgICAgICBjYWxsYmFjayhlcnJvcnMuZXJyb3IoZXJyb3JzLk1JU1NJTkdfRE9DKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2sobnVsbCwgZG9jLnJldl90cmVlKTsKICAgICAgfQogICAgfTsKICB9OwoKICAvLyBUaGlzIGZ1bmN0aW9uIHJlbW92ZXMgcmV2aXNpb25zIG9mIGRvY3VtZW50IGRvY0lkCiAgLy8gd2hpY2ggYXJlIGxpc3RlZCBpbiByZXZzIGFuZCBzZXRzIHRoaXMgZG9jdW1lbnQKICAvLyByZXZpc2lvbiB0byB0byByZXZfdHJlZQogIGFwaS5fZG9Db21wYWN0aW9uID0gZnVuY3Rpb24gKGRvY0lkLCByZXZzLCBjYWxsYmFjaykgewogICAgdmFyIHN0b3JlcyA9IFsKICAgICAgRE9DX1NUT1JFLAogICAgICBCWV9TRVFfU1RPUkUsCiAgICAgIEFUVEFDSF9TVE9SRSwKICAgICAgQVRUQUNIX0FORF9TRVFfU1RPUkUKICAgIF07CiAgICB2YXIgdHhuUmVzdWx0ID0gb3BlblRyYW5zYWN0aW9uU2FmZWx5KGlkYiwgc3RvcmVzLCAncmVhZHdyaXRlJyk7CiAgICBpZiAodHhuUmVzdWx0LmVycm9yKSB7CiAgICAgIHJldHVybiBjYWxsYmFjayh0eG5SZXN1bHQuZXJyb3IpOwogICAgfQogICAgdmFyIHR4biA9IHR4blJlc3VsdC50eG47CgogICAgdmFyIGRvY1N0b3JlID0gdHhuLm9iamVjdFN0b3JlKERPQ19TVE9SRSk7CgogICAgZG9jU3RvcmUuZ2V0KGRvY0lkKS5vbnN1Y2Nlc3MgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgdmFyIG1ldGFkYXRhID0gZGVjb2RlTWV0YWRhdGEoZXZlbnQudGFyZ2V0LnJlc3VsdCk7CiAgICAgIHRyYXZlcnNlUmV2VHJlZShtZXRhZGF0YS5yZXZfdHJlZSwgZnVuY3Rpb24gKGlzTGVhZiwgcG9zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXZIYXNoLCBjdHgsIG9wdHMpIHsKICAgICAgICB2YXIgcmV2ID0gcG9zICsgJy0nICsgcmV2SGFzaDsKICAgICAgICBpZiAocmV2cy5pbmRleE9mKHJldikgIT09IC0xKSB7CiAgICAgICAgICBvcHRzLnN0YXR1cyA9ICdtaXNzaW5nJzsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBjb21wYWN0UmV2cyhyZXZzLCBkb2NJZCwgdHhuKTsKICAgICAgdmFyIHdpbm5pbmdSZXYgPSBtZXRhZGF0YS53aW5uaW5nUmV2OwogICAgICB2YXIgZGVsZXRlZCA9IG1ldGFkYXRhLmRlbGV0ZWQ7CiAgICAgIHR4bi5vYmplY3RTdG9yZShET0NfU1RPUkUpLnB1dCgKICAgICAgICBlbmNvZGVNZXRhZGF0YShtZXRhZGF0YSwgd2lubmluZ1JldiwgZGVsZXRlZCkpOwogICAgfTsKICAgIHR4bi5vbmFib3J0ID0gaWRiRXJyb3IoY2FsbGJhY2spOwogICAgdHhuLm9uY29tcGxldGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGNhbGxiYWNrKCk7CiAgICB9OwogIH07CgoKICBhcGkuX2dldExvY2FsID0gZnVuY3Rpb24gKGlkLCBjYWxsYmFjaykgewogICAgdmFyIHR4blJlc3VsdCA9IG9wZW5UcmFuc2FjdGlvblNhZmVseShpZGIsIFtMT0NBTF9TVE9SRV0sICdyZWFkb25seScpOwogICAgaWYgKHR4blJlc3VsdC5lcnJvcikgewogICAgICByZXR1cm4gY2FsbGJhY2sodHhuUmVzdWx0LmVycm9yKTsKICAgIH0KICAgIHZhciB0eCA9IHR4blJlc3VsdC50eG47CiAgICB2YXIgcmVxID0gdHgub2JqZWN0U3RvcmUoTE9DQUxfU1RPUkUpLmdldChpZCk7CgogICAgcmVxLm9uZXJyb3IgPSBpZGJFcnJvcihjYWxsYmFjayk7CiAgICByZXEub25zdWNjZXNzID0gZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIGRvYyA9IGUudGFyZ2V0LnJlc3VsdDsKICAgICAgaWYgKCFkb2MpIHsKICAgICAgICBjYWxsYmFjayhlcnJvcnMuZXJyb3IoZXJyb3JzLk1JU1NJTkdfRE9DKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVsZXRlIGRvY1snX2RvY19pZF9yZXYnXTsgLy8gZm9yIGJhY2t3YXJkcyBjb21wYXQKICAgICAgICBjYWxsYmFjayhudWxsLCBkb2MpOwogICAgICB9CiAgICB9OwogIH07CgogIGFwaS5fcHV0TG9jYWwgPSBmdW5jdGlvbiAoZG9jLCBvcHRzLCBjYWxsYmFjaykgewogICAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNhbGxiYWNrID0gb3B0czsKICAgICAgb3B0cyA9IHt9OwogICAgfQogICAgZGVsZXRlIGRvYy5fcmV2aXNpb25zOyAvLyBpZ25vcmUgdGhpcywgdHJ1c3QgdGhlIHJldgogICAgdmFyIG9sZFJldiA9IGRvYy5fcmV2OwogICAgdmFyIGlkID0gZG9jLl9pZDsKICAgIGlmICghb2xkUmV2KSB7CiAgICAgIGRvYy5fcmV2ID0gJzAtMSc7CiAgICB9IGVsc2UgewogICAgICBkb2MuX3JldiA9ICcwLScgKyAocGFyc2VJbnQob2xkUmV2LnNwbGl0KCctJylbMV0sIDEwKSArIDEpOwogICAgfQoKICAgIHZhciB0eCA9IG9wdHMuY3R4OwogICAgdmFyIHJldDsKICAgIGlmICghdHgpIHsKICAgICAgdmFyIHR4blJlc3VsdCA9IG9wZW5UcmFuc2FjdGlvblNhZmVseShpZGIsIFtMT0NBTF9TVE9SRV0sICdyZWFkd3JpdGUnKTsKICAgICAgaWYgKHR4blJlc3VsdC5lcnJvcikgewogICAgICAgIHJldHVybiBjYWxsYmFjayh0eG5SZXN1bHQuZXJyb3IpOwogICAgICB9CiAgICAgIHR4ID0gdHhuUmVzdWx0LnR4bjsKICAgICAgdHgub25lcnJvciA9IGlkYkVycm9yKGNhbGxiYWNrKTsKICAgICAgdHgub25jb21wbGV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAocmV0KSB7CiAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXQpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KCiAgICB2YXIgb1N0b3JlID0gdHgub2JqZWN0U3RvcmUoTE9DQUxfU1RPUkUpOwogICAgdmFyIHJlcTsKICAgIGlmIChvbGRSZXYpIHsKICAgICAgcmVxID0gb1N0b3JlLmdldChpZCk7CiAgICAgIHJlcS5vbnN1Y2Nlc3MgPSBmdW5jdGlvbiAoZSkgewogICAgICAgIHZhciBvbGREb2MgPSBlLnRhcmdldC5yZXN1bHQ7CiAgICAgICAgaWYgKCFvbGREb2MgfHwgb2xkRG9jLl9yZXYgIT09IG9sZFJldikgewogICAgICAgICAgY2FsbGJhY2soZXJyb3JzLmVycm9yKGVycm9ycy5SRVZfQ09ORkxJQ1QpKTsKICAgICAgICB9IGVsc2UgeyAvLyB1cGRhdGUKICAgICAgICAgIHZhciByZXEgPSBvU3RvcmUucHV0KGRvYyk7CiAgICAgICAgICByZXEub25zdWNjZXNzID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXQgPSB7b2s6IHRydWUsIGlkOiBkb2MuX2lkLCByZXY6IGRvYy5fcmV2fTsKICAgICAgICAgICAgaWYgKG9wdHMuY3R4KSB7IC8vIHJldHVybiBpbW1lZGlhdGVseQogICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHJldCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9OwogICAgfSBlbHNlIHsgLy8gbmV3IGRvYwogICAgICByZXEgPSBvU3RvcmUuYWRkKGRvYyk7CiAgICAgIHJlcS5vbmVycm9yID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICAvLyBjb25zdHJhaW50IGVycm9yLCBhbHJlYWR5IGV4aXN0cwogICAgICAgIGNhbGxiYWNrKGVycm9ycy5lcnJvcihlcnJvcnMuUkVWX0NPTkZMSUNUKSk7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOyAvLyBhdm9pZCB0cmFuc2FjdGlvbiBhYm9ydAogICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIGF2b2lkIHRyYW5zYWN0aW9uIG9uZXJyb3IKICAgICAgfTsKICAgICAgcmVxLm9uc3VjY2VzcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXQgPSB7b2s6IHRydWUsIGlkOiBkb2MuX2lkLCByZXY6IGRvYy5fcmV2fTsKICAgICAgICBpZiAob3B0cy5jdHgpIHsgLy8gcmV0dXJuIGltbWVkaWF0ZWx5CiAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXQpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9OwoKICBhcGkuX3JlbW92ZUxvY2FsID0gZnVuY3Rpb24gKGRvYywgb3B0cywgY2FsbGJhY2spIHsKICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYWxsYmFjayA9IG9wdHM7CiAgICAgIG9wdHMgPSB7fTsKICAgIH0KICAgIHZhciB0eCA9IG9wdHMuY3R4OwogICAgaWYgKCF0eCkgewogICAgICB2YXIgdHhuUmVzdWx0ID0gb3BlblRyYW5zYWN0aW9uU2FmZWx5KGlkYiwgW0xPQ0FMX1NUT1JFXSwgJ3JlYWR3cml0ZScpOwogICAgICBpZiAodHhuUmVzdWx0LmVycm9yKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHR4blJlc3VsdC5lcnJvcik7CiAgICAgIH0KICAgICAgdHggPSB0eG5SZXN1bHQudHhuOwogICAgICB0eC5vbmNvbXBsZXRlID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChyZXQpIHsKICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHJldCk7CiAgICAgICAgfQogICAgICB9OwogICAgfQogICAgdmFyIHJldDsKICAgIHZhciBpZCA9IGRvYy5faWQ7CiAgICB2YXIgb1N0b3JlID0gdHgub2JqZWN0U3RvcmUoTE9DQUxfU1RPUkUpOwogICAgdmFyIHJlcSA9IG9TdG9yZS5nZXQoaWQpOwoKICAgIHJlcS5vbmVycm9yID0gaWRiRXJyb3IoY2FsbGJhY2spOwogICAgcmVxLm9uc3VjY2VzcyA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBvbGREb2MgPSBlLnRhcmdldC5yZXN1bHQ7CiAgICAgIGlmICghb2xkRG9jIHx8IG9sZERvYy5fcmV2ICE9PSBkb2MuX3JldikgewogICAgICAgIGNhbGxiYWNrKGVycm9ycy5lcnJvcihlcnJvcnMuTUlTU0lOR19ET0MpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvU3RvcmUuZGVsZXRlKGlkKTsKICAgICAgICByZXQgPSB7b2s6IHRydWUsIGlkOiBpZCwgcmV2OiAnMC0wJ307CiAgICAgICAgaWYgKG9wdHMuY3R4KSB7IC8vIHJldHVybiBpbW1lZGlhdGVseQogICAgICAgICAgY2FsbGJhY2sobnVsbCwgcmV0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfTsKCiAgYXBpLl9kZXN0cm95ID0gZnVuY3Rpb24gKG9wdHMsIGNhbGxiYWNrKSB7CiAgICBJZGJQb3VjaC5DaGFuZ2VzLnJlbW92ZUFsbExpc3RlbmVycyhkYk5hbWUpOwoKICAgIC8vQ2xvc2Ugb3BlbiByZXF1ZXN0IGZvciAiZGJOYW1lIiBkYXRhYmFzZSB0byBmaXggaWUgZGVsYXkuCiAgICBpZiAoSWRiUG91Y2gub3BlblJlcUxpc3RbZGJOYW1lXSAmJiBJZGJQb3VjaC5vcGVuUmVxTGlzdFtkYk5hbWVdLnJlc3VsdCkgewogICAgICBJZGJQb3VjaC5vcGVuUmVxTGlzdFtkYk5hbWVdLnJlc3VsdC5jbG9zZSgpOwogICAgICBkZWxldGUgY2FjaGVkREJzW2RiTmFtZV07CiAgICB9CiAgICB2YXIgcmVxID0gaW5kZXhlZERCLmRlbGV0ZURhdGFiYXNlKGRiTmFtZSk7CgogICAgcmVxLm9uc3VjY2VzcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgLy9SZW1vdmUgb3BlbiByZXF1ZXN0IGZyb20gdGhlIGxpc3QuCiAgICAgIGlmIChJZGJQb3VjaC5vcGVuUmVxTGlzdFtkYk5hbWVdKSB7CiAgICAgICAgSWRiUG91Y2gub3BlblJlcUxpc3RbZGJOYW1lXSA9IG51bGw7CiAgICAgIH0KICAgICAgaWYgKGhhc0xvY2FsU3RvcmFnZSgpICYmIChkYk5hbWUgaW4gbG9jYWxTdG9yYWdlKSkgewogICAgICAgIGRlbGV0ZSBsb2NhbFN0b3JhZ2VbZGJOYW1lXTsKICAgICAgfQogICAgICBjYWxsYmFjayhudWxsLCB7ICdvayc6IHRydWUgfSk7CiAgICB9OwoKICAgIHJlcS5vbmVycm9yID0gaWRiRXJyb3IoY2FsbGJhY2spOwogIH07CgogIHZhciBjYWNoZWQgPSBjYWNoZWREQnNbZGJOYW1lXTsKCiAgaWYgKGNhY2hlZCkgewogICAgaWRiID0gY2FjaGVkLmlkYjsKICAgIGFwaS5fbWV0YSA9IGNhY2hlZC5nbG9iYWw7CiAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgY2FsbGJhY2sobnVsbCwgYXBpKTsKICAgIH0pOwogICAgcmV0dXJuOwogIH0KCiAgdmFyIHJlcTsKICBpZiAob3B0cy5zdG9yYWdlKSB7CiAgICByZXEgPSBpbmRleGVkREIub3BlbihkYk5hbWUsIHsKICAgICAgdmVyc2lvbjogQURBUFRFUl9WRVJTSU9OLAogICAgICBzdG9yYWdlOiBvcHRzLnN0b3JhZ2UKICAgIH0pOwogIH0gZWxzZSB7CiAgICByZXEgPSBpbmRleGVkREIub3BlbihkYk5hbWUsIEFEQVBURVJfVkVSU0lPTik7CiAgfQoKICBpZiAoISgnb3BlblJlcUxpc3QnIGluIElkYlBvdWNoKSkgewogICAgSWRiUG91Y2gub3BlblJlcUxpc3QgPSB7fTsKICB9CiAgSWRiUG91Y2gub3BlblJlcUxpc3RbZGJOYW1lXSA9IHJlcTsKCiAgcmVxLm9udXBncmFkZW5lZWRlZCA9IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgZGIgPSBlLnRhcmdldC5yZXN1bHQ7CiAgICBpZiAoZS5vbGRWZXJzaW9uIDwgMSkgewogICAgICByZXR1cm4gY3JlYXRlU2NoZW1hKGRiKTsgLy8gbmV3IGRiLCBpbml0aWFsIHNjaGVtYQogICAgfQogICAgLy8gZG8gbWlncmF0aW9ucwoKICAgIHZhciB0eG4gPSBlLmN1cnJlbnRUYXJnZXQudHJhbnNhY3Rpb247CiAgICAvLyB0aGVzZSBtaWdyYXRpb25zIGhhdmUgdG8gYmUgZG9uZSBpbiB0aGlzIGZ1bmN0aW9uLCBiZWZvcmUKICAgIC8vIGNvbnRyb2wgaXMgcmV0dXJuZWQgdG8gdGhlIGV2ZW50IGxvb3AsIGJlY2F1c2UgSW5kZXhlZERCCgogICAgaWYgKGUub2xkVmVyc2lvbiA8IDMpIHsKICAgICAgY3JlYXRlTG9jYWxTdG9yZVNjaGVtYShkYik7IC8vIHYyIC0+IHYzCiAgICB9CiAgICBpZiAoZS5vbGRWZXJzaW9uIDwgNCkgewogICAgICBhZGRBdHRhY2hBbmRTZXFTdG9yZShkYik7IC8vIHYzIC0+IHY0CiAgICB9CgogICAgdmFyIG1pZ3JhdGlvbnMgPSBbCiAgICAgIGFkZERlbGV0ZWRPckxvY2FsSW5kZXgsIC8vIHYxIC0+IHYyCiAgICAgIG1pZ3JhdGVMb2NhbFN0b3JlLCAgICAgIC8vIHYyIC0+IHYzCiAgICAgIG1pZ3JhdGVBdHRzQW5kU2VxcywgICAgIC8vIHYzIC0+IHY0CiAgICAgIG1pZ3JhdGVNZXRhZGF0YSAgICAgICAgIC8vIHY0IC0+IHY1CiAgICBdOwoKICAgIHZhciBpID0gZS5vbGRWZXJzaW9uOwoKICAgIGZ1bmN0aW9uIG5leHQoKSB7CiAgICAgIHZhciBtaWdyYXRpb24gPSBtaWdyYXRpb25zW2kgLSAxXTsKICAgICAgaSsrOwogICAgICBpZiAobWlncmF0aW9uKSB7CiAgICAgICAgbWlncmF0aW9uKHR4biwgbmV4dCk7CiAgICAgIH0KICAgIH0KCiAgICBuZXh0KCk7CiAgfTsKCiAgcmVxLm9uc3VjY2VzcyA9IGZ1bmN0aW9uIChlKSB7CgogICAgaWRiID0gZS50YXJnZXQucmVzdWx0OwoKICAgIGlkYi5vbnZlcnNpb25jaGFuZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlkYi5jbG9zZSgpOwogICAgICBkZWxldGUgY2FjaGVkREJzW2RiTmFtZV07CiAgICB9OwoKICAgIGlkYi5vbmFib3J0ID0gZnVuY3Rpb24gKGUpIHsKICAgICAgY29uc29sZS5lcnJvcignRGF0YWJhc2UgaGFzIGEgZ2xvYmFsIGZhaWx1cmUnLCBlLnRhcmdldC5lcnJvcik7CiAgICAgIGlkYi5jbG9zZSgpOwogICAgICBkZWxldGUgY2FjaGVkREJzW2RiTmFtZV07CiAgICB9OwoKICAgIHZhciB0eG4gPSBpZGIudHJhbnNhY3Rpb24oWwogICAgICBNRVRBX1NUT1JFLAogICAgICBERVRFQ1RfQkxPQl9TVVBQT1JUX1NUT1JFLAogICAgICBET0NfU1RPUkUKICAgIF0sICdyZWFkd3JpdGUnKTsKCiAgICB2YXIgcmVxID0gdHhuLm9iamVjdFN0b3JlKE1FVEFfU1RPUkUpLmdldChNRVRBX1NUT1JFKTsKCiAgICB2YXIgYmxvYlN1cHBvcnQgPSBudWxsOwogICAgdmFyIGRvY0NvdW50ID0gbnVsbDsKICAgIHZhciBpbnN0YW5jZUlkID0gbnVsbDsKCiAgICByZXEub25zdWNjZXNzID0gZnVuY3Rpb24gKGUpIHsKCiAgICAgIHZhciBjaGVja1NldHVwQ29tcGxldGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGJsb2JTdXBwb3J0ID09PSBudWxsIHx8IGRvY0NvdW50ID09PSBudWxsIHx8CiAgICAgICAgICAgIGluc3RhbmNlSWQgPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXBpLl9tZXRhID0gewogICAgICAgICAgICBuYW1lOiBkYk5hbWUsCiAgICAgICAgICAgIGluc3RhbmNlSWQ6IGluc3RhbmNlSWQsCiAgICAgICAgICAgIGJsb2JTdXBwb3J0OiBibG9iU3VwcG9ydCwKICAgICAgICAgICAgZG9jQ291bnQ6IGRvY0NvdW50CiAgICAgICAgICB9OwoKICAgICAgICAgIGNhY2hlZERCc1tkYk5hbWVdID0gewogICAgICAgICAgICBpZGI6IGlkYiwKICAgICAgICAgICAgZ2xvYmFsOiBhcGkuX21ldGEKICAgICAgICAgIH07CiAgICAgICAgICBjYWxsYmFjayhudWxsLCBhcGkpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIC8vCiAgICAgIC8vIGZldGNoL3N0b3JlIHRoZSBpZAogICAgICAvLwoKICAgICAgdmFyIG1ldGEgPSBlLnRhcmdldC5yZXN1bHQgfHwge2lkOiBNRVRBX1NUT1JFfTsKICAgICAgaWYgKGRiTmFtZSAgKyAnX2lkJyBpbiBtZXRhKSB7CiAgICAgICAgaW5zdGFuY2VJZCA9IG1ldGFbZGJOYW1lICsgJ19pZCddOwogICAgICAgIGNoZWNrU2V0dXBDb21wbGV0ZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIGluc3RhbmNlSWQgPSB1dGlscy51dWlkKCk7CiAgICAgICAgbWV0YVtkYk5hbWUgKyAnX2lkJ10gPSBpbnN0YW5jZUlkOwogICAgICAgIHR4bi5vYmplY3RTdG9yZShNRVRBX1NUT1JFKS5wdXQobWV0YSkub25zdWNjZXNzID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgY2hlY2tTZXR1cENvbXBsZXRlKCk7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgLy8KICAgICAgLy8gY2hlY2sgYmxvYiBzdXBwb3J0CiAgICAgIC8vCgogICAgICBpZiAoIWJsb2JTdXBwb3J0UHJvbWlzZSkgewogICAgICAgIC8vIG1ha2Ugc3VyZSBibG9iIHN1cHBvcnQgaXMgb25seSBjaGVja2VkIG9uY2UKICAgICAgICBibG9iU3VwcG9ydFByb21pc2UgPSBjaGVja0Jsb2JTdXBwb3J0KHR4biwgaWRiKTsKICAgICAgfQoKICAgICAgYmxvYlN1cHBvcnRQcm9taXNlLnRoZW4oZnVuY3Rpb24gKHZhbCkgewogICAgICAgIGJsb2JTdXBwb3J0ID0gdmFsOwogICAgICAgIGNoZWNrU2V0dXBDb21wbGV0ZSgpOwogICAgICB9KTsKCiAgICAgIC8vCiAgICAgIC8vIGNvdW50IGRvY3MKICAgICAgLy8KCiAgICAgIHZhciBpbmRleCA9IHR4bi5vYmplY3RTdG9yZShET0NfU1RPUkUpLmluZGV4KCdkZWxldGVkT3JMb2NhbCcpOwogICAgICBpbmRleC5jb3VudChJREJLZXlSYW5nZS5vbmx5KCcwJykpLm9uc3VjY2VzcyA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgZG9jQ291bnQgPSBlLnRhcmdldC5yZXN1bHQ7CiAgICAgICAgY2hlY2tTZXR1cENvbXBsZXRlKCk7CiAgICAgIH07CgogICAgfTsKICB9OwoKICByZXEub25lcnJvciA9IGZ1bmN0aW9uKGUpIHsKICAgIHZhciBtc2cgPSAnRmFpbGVkIHRvIG9wZW4gaW5kZXhlZERCLCBhcmUgeW91IGluIHByaXZhdGUgYnJvd3NpbmcgbW9kZT8nOwogICAgY29uc29sZS5lcnJvcihtc2cpOwogICAgY2FsbGJhY2soZXJyb3JzLmVycm9yKGVycm9ycy5JREJfRVJST1IsIG1zZykpOwogIH07Cn0KCklkYlBvdWNoLnZhbGlkID0gZnVuY3Rpb24gKCkgewogIC8vIElzc3VlICMyNTMzLCB3ZSBmaW5hbGx5IGdhdmUgdXAgb24gZG9pbmcgYnVnCiAgLy8gZGV0ZWN0aW9uIGluc3RlYWQgb2YgYnJvd3NlciBzbmlmZmluZy4gU2FmYXJpIGJyb3VnaHQgdXMKICAvLyB0byBvdXIga25lZXMuCiAgdmFyIGlzU2FmYXJpID0gdHlwZW9mIG9wZW5EYXRhYmFzZSAhPT0gJ3VuZGVmaW5lZCcgJiYKICAgIC8oU2FmYXJpfGlQaG9uZXxpUGFkfGlQb2QpLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpICYmCiAgICAhL0Nocm9tZS8udGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSAmJgogICAgIS9CbGFja0JlcnJ5Ly50ZXN0KG5hdmlnYXRvci5wbGF0Zm9ybSk7CgogIC8vIHNvbWUgb3V0ZGF0ZWQgaW1wbGVtZW50YXRpb25zIG9mIElEQiB0aGF0IGFwcGVhciBvbiBTYW1zdW5nCiAgLy8gYW5kIEhUQyBBbmRyb2lkIGRldmljZXMgPDQuNCBhcmUgbWlzc2luZyBJREJLZXlSYW5nZQogIHJldHVybiAhaXNTYWZhcmkgJiYgdHlwZW9mIGluZGV4ZWREQiAhPT0gJ3VuZGVmaW5lZCcgJiYKICAgIHR5cGVvZiBJREJLZXlSYW5nZSAhPT0gJ3VuZGVmaW5lZCc7Cn07CgpJZGJQb3VjaC5DaGFuZ2VzID0gbmV3IHV0aWxzLkNoYW5nZXMoKTsKCm1vZHVsZS5leHBvcnRzID0gSWRiUG91Y2g7Cgp9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKfSx7Ii4uLy4uL2RlcHMvZG9jcy9pc0RlbGV0ZWQiOjU0LCIuLi8uLi9kZXBzL2RvY3MvaXNMb2NhbElkIjo1NSwiLi4vLi4vZGVwcy9lbnYvaGFzTG9jYWxTdG9yYWdlIjo2MiwiLi4vLi4vZGVwcy9lcnJvcnMiOjY0LCIuLi8uLi9kZXBzL21lcmdlL3RyYXZlcnNlUmV2VHJlZSI6NzMsIi4uLy4uL2RlcHMvbWVyZ2Uvd2lubmluZ1JldiI6NzQsIi4uLy4uL3V0aWxzIjoxMDIsIi4vYWxsRG9jcyI6MTcsIi4vYmxvYlN1cHBvcnQiOjE4LCIuL2J1bGtEb2NzIjoxOSwiLi9jb25zdGFudHMiOjIwLCIuL3V0aWxzIjoyMiwiX3Byb2Nlc3MiOjh9XSwyMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBlcnJvcnMgPSByZXF1aXJlKCcuLi8uLi9kZXBzL2Vycm9ycycpOwp2YXIgdXRpbHMgPSByZXF1aXJlKCcuLi8uLi91dGlscycpOwp2YXIgYmFzZTY0ID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9iaW5hcnkvYmFzZTY0Jyk7CnZhciBidG9hID0gYmFzZTY0LmJ0b2E7CnZhciBjb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpOwp2YXIgcmVhZEFzQmluYXJ5U3RyaW5nID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9iaW5hcnkvcmVhZEFzQmluYXJ5U3RyaW5nJyk7CnZhciBiNjRTdHJpbmdUb0Jsb2IgPSByZXF1aXJlKCcuLi8uLi9kZXBzL2JpbmFyeS9iYXNlNjRTdHJpbmdUb0Jsb2JPckJ1ZmZlcicpOwp2YXIgY3JlYXRlQmxvYiA9IHJlcXVpcmUoJy4uLy4uL2RlcHMvYmluYXJ5L2Jsb2InKTsKCmZ1bmN0aW9uIHRyeUNvZGUoZnVuLCB0aGF0LCBhcmdzKSB7CiAgdHJ5IHsKICAgIGZ1bi5hcHBseSh0aGF0LCBhcmdzKTsKICB9IGNhdGNoIChlcnIpIHsgLy8gc2hvdWxkbid0IGhhcHBlbgogICAgaWYgKHR5cGVvZiBQb3VjaERCICE9PSAndW5kZWZpbmVkJykgewogICAgICBQb3VjaERCLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgIH0KICB9Cn0KCmV4cG9ydHMudGFza1F1ZXVlID0gewogIHJ1bm5pbmc6IGZhbHNlLAogIHF1ZXVlOiBbXQp9OwoKZXhwb3J0cy5hcHBseU5leHQgPSBmdW5jdGlvbiAoKSB7CiAgaWYgKGV4cG9ydHMudGFza1F1ZXVlLnJ1bm5pbmcgfHwgIWV4cG9ydHMudGFza1F1ZXVlLnF1ZXVlLmxlbmd0aCkgewogICAgcmV0dXJuOwogIH0KICBleHBvcnRzLnRhc2tRdWV1ZS5ydW5uaW5nID0gdHJ1ZTsKICB2YXIgaXRlbSA9IGV4cG9ydHMudGFza1F1ZXVlLnF1ZXVlLnNoaWZ0KCk7CiAgaXRlbS5hY3Rpb24oZnVuY3Rpb24gKGVyciwgcmVzKSB7CiAgICB0cnlDb2RlKGl0ZW0uY2FsbGJhY2ssIHRoaXMsIFtlcnIsIHJlc10pOwogICAgZXhwb3J0cy50YXNrUXVldWUucnVubmluZyA9IGZhbHNlOwogICAgcHJvY2Vzcy5uZXh0VGljayhleHBvcnRzLmFwcGx5TmV4dCk7CiAgfSk7Cn07CgpleHBvcnRzLmlkYkVycm9yID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIChldnQpIHsKICAgIHZhciBtZXNzYWdlID0gJ3Vua25vd25fZXJyb3InOwogICAgaWYgKGV2dC50YXJnZXQgJiYgZXZ0LnRhcmdldC5lcnJvcikgewogICAgICBtZXNzYWdlID0gZXZ0LnRhcmdldC5lcnJvci5uYW1lIHx8IGV2dC50YXJnZXQuZXJyb3IubWVzc2FnZTsKICAgIH0KICAgIGNhbGxiYWNrKGVycm9ycy5lcnJvcihlcnJvcnMuSURCX0VSUk9SLCBtZXNzYWdlLCBldnQudHlwZSkpOwogIH07Cn07CgovLyBVbmZvcnR1bmF0ZWx5LCB0aGUgbWV0YWRhdGEgaGFzIHRvIGJlIHN0cmluZ2lmaWVkCi8vIHdoZW4gaXQgaXMgcHV0IGludG8gdGhlIGRhdGFiYXNlLCBiZWNhdXNlIG90aGVyd2lzZQovLyBJbmRleGVkREIgY2FuIHRocm93IGVycm9ycyBmb3IgZGVlcGx5LW5lc3RlZCBvYmplY3RzLgovLyBPcmlnaW5hbGx5IHdlIGp1c3QgdXNlZCBKU09OLnBhcnNlL0pTT04uc3RyaW5naWZ5OyBub3cKLy8gd2UgdXNlIHRoaXMgY3VzdG9tIHZ1dnV6ZWxhIGxpYnJhcnkgdGhhdCBhdm9pZHMgcmVjdXJzaW9uLgovLyBJZiB3ZSBjb3VsZCBkbyBpdCBhbGwgb3ZlciBhZ2Fpbiwgd2UnZCBwcm9iYWJseSB1c2UgYQovLyBmb3JtYXQgZm9yIHRoZSByZXZpc2lvbiB0cmVlcyBvdGhlciB0aGFuIEpTT04uCmV4cG9ydHMuZW5jb2RlTWV0YWRhdGEgPSBmdW5jdGlvbiAobWV0YWRhdGEsIHdpbm5pbmdSZXYsIGRlbGV0ZWQpIHsKICByZXR1cm4gewogICAgZGF0YTogdXRpbHMuc2FmZUpzb25TdHJpbmdpZnkobWV0YWRhdGEpLAogICAgd2lubmluZ1Jldjogd2lubmluZ1JldiwKICAgIGRlbGV0ZWRPckxvY2FsOiBkZWxldGVkID8gJzEnIDogJzAnLAogICAgc2VxOiBtZXRhZGF0YS5zZXEsIC8vIGhpZ2hlc3Qgc2VxIGZvciB0aGlzIGRvYwogICAgaWQ6IG1ldGFkYXRhLmlkCiAgfTsKfTsKCmV4cG9ydHMuZGVjb2RlTWV0YWRhdGEgPSBmdW5jdGlvbiAoc3RvcmVkT2JqZWN0KSB7CiAgaWYgKCFzdG9yZWRPYmplY3QpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgbWV0YWRhdGEgPSB1dGlscy5zYWZlSnNvblBhcnNlKHN0b3JlZE9iamVjdC5kYXRhKTsKICBtZXRhZGF0YS53aW5uaW5nUmV2ID0gc3RvcmVkT2JqZWN0Lndpbm5pbmdSZXY7CiAgbWV0YWRhdGEuZGVsZXRlZCA9IHN0b3JlZE9iamVjdC5kZWxldGVkT3JMb2NhbCA9PT0gJzEnOwogIG1ldGFkYXRhLnNlcSA9IHN0b3JlZE9iamVjdC5zZXE7CiAgcmV0dXJuIG1ldGFkYXRhOwp9OwoKLy8gcmVhZCB0aGUgZG9jIGJhY2sgb3V0IGZyb20gdGhlIGRhdGFiYXNlLiB3ZSBkb24ndCBzdG9yZSB0aGUKLy8gX2lkIG9yIF9yZXYgYmVjYXVzZSB3ZSBhbHJlYWR5IGhhdmUgX2RvY19pZF9yZXYuCmV4cG9ydHMuZGVjb2RlRG9jID0gZnVuY3Rpb24gKGRvYykgewogIGlmICghZG9jKSB7CiAgICByZXR1cm4gZG9jOwogIH0KICB2YXIgaWR4ID0gZG9jLl9kb2NfaWRfcmV2Lmxhc3RJbmRleE9mKCc6Jyk7CiAgZG9jLl9pZCA9IGRvYy5fZG9jX2lkX3Jldi5zdWJzdHJpbmcoMCwgaWR4IC0gMSk7CiAgZG9jLl9yZXYgPSBkb2MuX2RvY19pZF9yZXYuc3Vic3RyaW5nKGlkeCArIDEpOwogIGRlbGV0ZSBkb2MuX2RvY19pZF9yZXY7CiAgcmV0dXJuIGRvYzsKfTsKCi8vIFJlYWQgYSBibG9iIGZyb20gdGhlIGRhdGFiYXNlLCBlbmNvZGluZyBhcyBuZWNlc3NhcnkKLy8gYW5kIHRyYW5zbGF0aW5nIGZyb20gYmFzZTY0IGlmIHRoZSBJREIgZG9lc24ndCBzdXBwb3J0Ci8vIG5hdGl2ZSBCbG9icwpleHBvcnRzLnJlYWRCbG9iRGF0YSA9IGZ1bmN0aW9uIChib2R5LCB0eXBlLCBhc0Jsb2IsIGNhbGxiYWNrKSB7CiAgaWYgKGFzQmxvYikgewogICAgaWYgKCFib2R5KSB7CiAgICAgIGNhbGxiYWNrKGNyZWF0ZUJsb2IoWycnXSwge3R5cGU6IHR5cGV9KSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBib2R5ICE9PSAnc3RyaW5nJykgeyAvLyB3ZSBoYXZlIGJsb2Igc3VwcG9ydAogICAgICBjYWxsYmFjayhib2R5KTsKICAgIH0gZWxzZSB7IC8vIG5vIGJsb2Igc3VwcG9ydAogICAgICBjYWxsYmFjayhiNjRTdHJpbmdUb0Jsb2IoYm9keSwgdHlwZSkpOwogICAgfQogIH0gZWxzZSB7IC8vIGFzIGJhc2U2NCBzdHJpbmcKICAgIGlmICghYm9keSkgewogICAgICBjYWxsYmFjaygnJyk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBib2R5ICE9PSAnc3RyaW5nJykgeyAvLyB3ZSBoYXZlIGJsb2Igc3VwcG9ydAogICAgICByZWFkQXNCaW5hcnlTdHJpbmcoYm9keSwgZnVuY3Rpb24gKGJpbmFyeSkgewogICAgICAgIGNhbGxiYWNrKGJ0b2EoYmluYXJ5KSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsgLy8gbm8gYmxvYiBzdXBwb3J0CiAgICAgIGNhbGxiYWNrKGJvZHkpOwogICAgfQogIH0KfTsKCmV4cG9ydHMuZmV0Y2hBdHRhY2htZW50c0lmTmVjZXNzYXJ5ID0gZnVuY3Rpb24gKGRvYywgb3B0cywgdHhuLCBjYikgewogIHZhciBhdHRhY2htZW50cyA9IE9iamVjdC5rZXlzKGRvYy5fYXR0YWNobWVudHMgfHwge30pOwogIGlmICghYXR0YWNobWVudHMubGVuZ3RoKSB7CiAgICByZXR1cm4gY2IgJiYgY2IoKTsKICB9CiAgdmFyIG51bURvbmUgPSAwOwoKICBmdW5jdGlvbiBjaGVja0RvbmUoKSB7CiAgICBpZiAoKytudW1Eb25lID09PSBhdHRhY2htZW50cy5sZW5ndGggJiYgY2IpIHsKICAgICAgY2IoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGZldGNoQXR0YWNobWVudChkb2MsIGF0dCkgewogICAgdmFyIGF0dE9iaiA9IGRvYy5fYXR0YWNobWVudHNbYXR0XTsKICAgIHZhciBkaWdlc3QgPSBhdHRPYmouZGlnZXN0OwogICAgdmFyIHJlcSA9IHR4bi5vYmplY3RTdG9yZShjb25zdGFudHMuQVRUQUNIX1NUT1JFKS5nZXQoZGlnZXN0KTsKICAgIHJlcS5vbnN1Y2Nlc3MgPSBmdW5jdGlvbiAoZSkgewogICAgICBhdHRPYmouYm9keSA9IGUudGFyZ2V0LnJlc3VsdC5ib2R5OwogICAgICBjaGVja0RvbmUoKTsKICAgIH07CiAgfQoKICBhdHRhY2htZW50cy5mb3JFYWNoKGZ1bmN0aW9uIChhdHQpIHsKICAgIGlmIChvcHRzLmF0dGFjaG1lbnRzICYmIG9wdHMuaW5jbHVkZV9kb2NzKSB7CiAgICAgIGZldGNoQXR0YWNobWVudChkb2MsIGF0dCk7CiAgICB9IGVsc2UgewogICAgICBkb2MuX2F0dGFjaG1lbnRzW2F0dF0uc3R1YiA9IHRydWU7CiAgICAgIGNoZWNrRG9uZSgpOwogICAgfQogIH0pOwp9OwoKLy8gSURCLXNwZWNpZmljIHBvc3Rwcm9jZXNzaW5nIG5lY2Vzc2FyeSBiZWNhdXNlCi8vIHdlIGRvbid0IGtub3cgd2hldGhlciB3ZSBzdG9yZWQgYSB0cnVlIEJsb2Igb3IKLy8gYSBiYXNlNjQtZW5jb2RlZCBzdHJpbmcsIGFuZCBpZiBpdCdzIGEgQmxvYiBpdAovLyBuZWVkcyB0byBiZSByZWFkIG91dHNpZGUgb2YgdGhlIHRyYW5zYWN0aW9uIGNvbnRleHQKZXhwb3J0cy5wb3N0UHJvY2Vzc0F0dGFjaG1lbnRzID0gZnVuY3Rpb24gKHJlc3VsdHMsIGFzQmxvYikgewogIHJldHVybiB1dGlscy5Qcm9taXNlLmFsbChyZXN1bHRzLm1hcChmdW5jdGlvbiAocm93KSB7CiAgICBpZiAocm93LmRvYyAmJiByb3cuZG9jLl9hdHRhY2htZW50cykgewogICAgICB2YXIgYXR0TmFtZXMgPSBPYmplY3Qua2V5cyhyb3cuZG9jLl9hdHRhY2htZW50cyk7CiAgICAgIHJldHVybiB1dGlscy5Qcm9taXNlLmFsbChhdHROYW1lcy5tYXAoZnVuY3Rpb24gKGF0dCkgewogICAgICAgIHZhciBhdHRPYmogPSByb3cuZG9jLl9hdHRhY2htZW50c1thdHRdOwogICAgICAgIGlmICghKCdib2R5JyBpbiBhdHRPYmopKSB7IC8vIGFscmVhZHkgcHJvY2Vzc2VkCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBib2R5ID0gYXR0T2JqLmJvZHk7CiAgICAgICAgdmFyIHR5cGUgPSBhdHRPYmouY29udGVudF90eXBlOwogICAgICAgIHJldHVybiBuZXcgdXRpbHMuUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgICAgICAgZXhwb3J0cy5yZWFkQmxvYkRhdGEoYm9keSwgdHlwZSwgYXNCbG9iLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICByb3cuZG9jLl9hdHRhY2htZW50c1thdHRdID0gdXRpbHMuZXh0ZW5kKAogICAgICAgICAgICAgIHV0aWxzLnBpY2soYXR0T2JqLCBbJ2RpZ2VzdCcsICdjb250ZW50X3R5cGUnXSksCiAgICAgICAgICAgICAge2RhdGE6IGRhdGF9CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJlc29sdmUoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KSk7CiAgICB9CiAgfSkpOwp9OwoKZXhwb3J0cy5jb21wYWN0UmV2cyA9IGZ1bmN0aW9uIChyZXZzLCBkb2NJZCwgdHhuKSB7CgogIHZhciBwb3NzaWJseU9ycGhhbmVkRGlnZXN0cyA9IFtdOwogIHZhciBzZXFTdG9yZSA9IHR4bi5vYmplY3RTdG9yZShjb25zdGFudHMuQllfU0VRX1NUT1JFKTsKICB2YXIgYXR0U3RvcmUgPSB0eG4ub2JqZWN0U3RvcmUoY29uc3RhbnRzLkFUVEFDSF9TVE9SRSk7CiAgdmFyIGF0dEFuZFNlcVN0b3JlID0gdHhuLm9iamVjdFN0b3JlKGNvbnN0YW50cy5BVFRBQ0hfQU5EX1NFUV9TVE9SRSk7CiAgdmFyIGNvdW50ID0gcmV2cy5sZW5ndGg7CgogIGZ1bmN0aW9uIGNoZWNrRG9uZSgpIHsKICAgIGNvdW50LS07CiAgICBpZiAoIWNvdW50KSB7IC8vIGRvbmUgcHJvY2Vzc2luZyBhbGwgcmV2cwogICAgICBkZWxldGVPcnBoYW5lZEF0dGFjaG1lbnRzKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkZWxldGVPcnBoYW5lZEF0dGFjaG1lbnRzKCkgewogICAgaWYgKCFwb3NzaWJseU9ycGhhbmVkRGlnZXN0cy5sZW5ndGgpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcG9zc2libHlPcnBoYW5lZERpZ2VzdHMuZm9yRWFjaChmdW5jdGlvbiAoZGlnZXN0KSB7CiAgICAgIHZhciBjb3VudFJlcSA9IGF0dEFuZFNlcVN0b3JlLmluZGV4KCdkaWdlc3RTZXEnKS5jb3VudCgKICAgICAgICBJREJLZXlSYW5nZS5ib3VuZCgKICAgICAgICAgIGRpZ2VzdCArICc6OicsIGRpZ2VzdCArICc6Olx1ZmZmZicsIGZhbHNlLCBmYWxzZSkpOwogICAgICBjb3VudFJlcS5vbnN1Y2Nlc3MgPSBmdW5jdGlvbiAoZSkgewogICAgICAgIHZhciBjb3VudCA9IGUudGFyZ2V0LnJlc3VsdDsKICAgICAgICBpZiAoIWNvdW50KSB7CiAgICAgICAgICAvLyBvcnBoYW5lZAogICAgICAgICAgYXR0U3RvcmUuZGVsZXRlKGRpZ2VzdCk7CiAgICAgICAgfQogICAgICB9OwogICAgfSk7CiAgfQoKICByZXZzLmZvckVhY2goZnVuY3Rpb24gKHJldikgewogICAgdmFyIGluZGV4ID0gc2VxU3RvcmUuaW5kZXgoJ19kb2NfaWRfcmV2Jyk7CiAgICB2YXIga2V5ID0gZG9jSWQgKyAiOjoiICsgcmV2OwogICAgaW5kZXguZ2V0S2V5KGtleSkub25zdWNjZXNzID0gZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIHNlcSA9IGUudGFyZ2V0LnJlc3VsdDsKICAgICAgaWYgKHR5cGVvZiBzZXEgIT09ICdudW1iZXInKSB7CiAgICAgICAgcmV0dXJuIGNoZWNrRG9uZSgpOwogICAgICB9CiAgICAgIHNlcVN0b3JlLmRlbGV0ZShzZXEpOwoKICAgICAgdmFyIGN1cnNvciA9IGF0dEFuZFNlcVN0b3JlLmluZGV4KCdzZXEnKQogICAgICAgIC5vcGVuQ3Vyc29yKElEQktleVJhbmdlLm9ubHkoc2VxKSk7CgogICAgICBjdXJzb3Iub25zdWNjZXNzID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgdmFyIGN1cnNvciA9IGV2ZW50LnRhcmdldC5yZXN1bHQ7CiAgICAgICAgaWYgKGN1cnNvcikgewogICAgICAgICAgdmFyIGRpZ2VzdCA9IGN1cnNvci52YWx1ZS5kaWdlc3RTZXEuc3BsaXQoJzo6JylbMF07CiAgICAgICAgICBwb3NzaWJseU9ycGhhbmVkRGlnZXN0cy5wdXNoKGRpZ2VzdCk7CiAgICAgICAgICBhdHRBbmRTZXFTdG9yZS5kZWxldGUoY3Vyc29yLnByaW1hcnlLZXkpOwogICAgICAgICAgY3Vyc29yLmNvbnRpbnVlKCk7CiAgICAgICAgfSBlbHNlIHsgLy8gZG9uZQogICAgICAgICAgY2hlY2tEb25lKCk7CiAgICAgICAgfQogICAgICB9OwogICAgfTsKICB9KTsKfTsKCmV4cG9ydHMub3BlblRyYW5zYWN0aW9uU2FmZWx5ID0gZnVuY3Rpb24gKGlkYiwgc3RvcmVzLCBtb2RlKSB7CiAgdHJ5IHsKICAgIHJldHVybiB7CiAgICAgIHR4bjogaWRiLnRyYW5zYWN0aW9uKHN0b3JlcywgbW9kZSkKICAgIH07CiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gewogICAgICBlcnJvcjogZXJyCiAgICB9OwogIH0KfTsKCn0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiLi4vLi4vZGVwcy9iaW5hcnkvYmFzZTY0Ijo0MSwiLi4vLi4vZGVwcy9iaW5hcnkvYmFzZTY0U3RyaW5nVG9CbG9iT3JCdWZmZXIiOjQyLCIuLi8uLi9kZXBzL2JpbmFyeS9ibG9iIjo0NSwiLi4vLi4vZGVwcy9iaW5hcnkvcmVhZEFzQmluYXJ5U3RyaW5nIjo1MSwiLi4vLi4vZGVwcy9lcnJvcnMiOjY0LCIuLi8uLi91dGlscyI6MTAyLCIuL2NvbnN0YW50cyI6MjAsIl9wcm9jZXNzIjo4fV0sMjM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgdXRpbHMgPSByZXF1aXJlKCcuLi8uLi91dGlscycpOwp2YXIgZXJyb3JzID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9lcnJvcnMnKTsKdmFyIHByZXByb2Nlc3NBdHRhY2htZW50cyA9CiAgcmVxdWlyZSgnLi4vLi4vZGVwcy9kb2NzL3ByZXByb2Nlc3NBdHRhY2htZW50cycpOwp2YXIgaXNMb2NhbElkID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9kb2NzL2lzTG9jYWxJZCcpOwp2YXIgcHJvY2Vzc0RvY3MgPSByZXF1aXJlKCcuLi8uLi9kZXBzL2RvY3MvcHJvY2Vzc0RvY3MnKTsKCnZhciB3ZWJzcWxVdGlscyA9IHJlcXVpcmUoJy4vdXRpbHMnKTsKdmFyIHdlYnNxbENvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJyk7Cgp2YXIgRE9DX1NUT1JFID0gd2Vic3FsQ29uc3RhbnRzLkRPQ19TVE9SRTsKdmFyIEJZX1NFUV9TVE9SRSA9IHdlYnNxbENvbnN0YW50cy5CWV9TRVFfU1RPUkU7CnZhciBBVFRBQ0hfU1RPUkUgPSB3ZWJzcWxDb25zdGFudHMuQVRUQUNIX1NUT1JFOwp2YXIgQVRUQUNIX0FORF9TRVFfU1RPUkUgPSB3ZWJzcWxDb25zdGFudHMuQVRUQUNIX0FORF9TRVFfU1RPUkU7Cgp2YXIgc2VsZWN0ID0gd2Vic3FsVXRpbHMuc2VsZWN0Owp2YXIgc3RyaW5naWZ5RG9jID0gd2Vic3FsVXRpbHMuc3RyaW5naWZ5RG9jOwp2YXIgY29tcGFjdFJldnMgPSB3ZWJzcWxVdGlscy5jb21wYWN0UmV2czsKdmFyIHVua25vd25FcnJvciA9IHdlYnNxbFV0aWxzLndlYnNxbEVycm9yOwoKZnVuY3Rpb24gd2Vic3FsQnVsa0RvY3MocmVxLCBvcHRzLCBhcGksIGRiLCBDaGFuZ2VzLCBjYWxsYmFjaykgewogIHZhciBuZXdFZGl0cyA9IG9wdHMubmV3X2VkaXRzOwogIHZhciB1c2VyRG9jcyA9IHJlcS5kb2NzOwoKICAvLyBQYXJzZSB0aGUgZG9jcywgZ2l2ZSB0aGVtIGEgc2VxdWVuY2UgbnVtYmVyIGZvciB0aGUgcmVzdWx0CiAgdmFyIGRvY0luZm9zID0gdXNlckRvY3MubWFwKGZ1bmN0aW9uIChkb2MpIHsKICAgIGlmIChkb2MuX2lkICYmIGlzTG9jYWxJZChkb2MuX2lkKSkgewogICAgICByZXR1cm4gZG9jOwogICAgfQogICAgdmFyIG5ld0RvYyA9IHV0aWxzLnBhcnNlRG9jKGRvYywgbmV3RWRpdHMpOwogICAgcmV0dXJuIG5ld0RvYzsKICB9KTsKCiAgdmFyIGRvY0luZm9FcnJvcnMgPSBkb2NJbmZvcy5maWx0ZXIoZnVuY3Rpb24gKGRvY0luZm8pIHsKICAgIHJldHVybiBkb2NJbmZvLmVycm9yOwogIH0pOwogIGlmIChkb2NJbmZvRXJyb3JzLmxlbmd0aCkgewogICAgcmV0dXJuIGNhbGxiYWNrKGRvY0luZm9FcnJvcnNbMF0pOwogIH0KCiAgdmFyIHR4OwogIHZhciByZXN1bHRzID0gbmV3IEFycmF5KGRvY0luZm9zLmxlbmd0aCk7CiAgdmFyIGZldGNoZWREb2NzID0gbmV3IHV0aWxzLk1hcCgpOwoKICB2YXIgcHJlY29uZGl0aW9uRXJyb3JlZDsKICBmdW5jdGlvbiBjb21wbGV0ZSgpIHsKICAgIGlmIChwcmVjb25kaXRpb25FcnJvcmVkKSB7CiAgICAgIHJldHVybiBjYWxsYmFjayhwcmVjb25kaXRpb25FcnJvcmVkKTsKICAgIH0KICAgIENoYW5nZXMubm90aWZ5KGFwaS5fbmFtZSk7CiAgICBhcGkuX2RvY0NvdW50ID0gLTE7IC8vIGludmFsaWRhdGUKICAgIGNhbGxiYWNrKG51bGwsIHJlc3VsdHMpOwogIH0KCiAgZnVuY3Rpb24gdmVyaWZ5QXR0YWNobWVudChkaWdlc3QsIGNhbGxiYWNrKSB7CiAgICB2YXIgc3FsID0gJ1NFTEVDVCBjb3VudCgqKSBhcyBjbnQgRlJPTSAnICsgQVRUQUNIX1NUT1JFICsKICAgICAgJyBXSEVSRSBkaWdlc3Q9Pyc7CiAgICB0eC5leGVjdXRlU3FsKHNxbCwgW2RpZ2VzdF0sIGZ1bmN0aW9uICh0eCwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQucm93cy5pdGVtKDApLmNudCA9PT0gMCkgewogICAgICAgIHZhciBlcnIgPSBlcnJvcnMuZXJyb3IoZXJyb3JzLk1JU1NJTkdfU1RVQiwKICAgICAgICAgICd1bmtub3duIHN0dWIgYXR0YWNobWVudCB3aXRoIGRpZ2VzdCAnICsKICAgICAgICAgIGRpZ2VzdCk7CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjaygpOwogICAgICB9CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHZlcmlmeUF0dGFjaG1lbnRzKGZpbmlzaCkgewogICAgdmFyIGRpZ2VzdHMgPSBbXTsKICAgIGRvY0luZm9zLmZvckVhY2goZnVuY3Rpb24gKGRvY0luZm8pIHsKICAgICAgaWYgKGRvY0luZm8uZGF0YSAmJiBkb2NJbmZvLmRhdGEuX2F0dGFjaG1lbnRzKSB7CiAgICAgICAgT2JqZWN0LmtleXMoZG9jSW5mby5kYXRhLl9hdHRhY2htZW50cykuZm9yRWFjaChmdW5jdGlvbiAoZmlsZW5hbWUpIHsKICAgICAgICAgIHZhciBhdHQgPSBkb2NJbmZvLmRhdGEuX2F0dGFjaG1lbnRzW2ZpbGVuYW1lXTsKICAgICAgICAgIGlmIChhdHQuc3R1YikgewogICAgICAgICAgICBkaWdlc3RzLnB1c2goYXR0LmRpZ2VzdCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKCFkaWdlc3RzLmxlbmd0aCkgewogICAgICByZXR1cm4gZmluaXNoKCk7CiAgICB9CiAgICB2YXIgbnVtRG9uZSA9IDA7CiAgICB2YXIgZXJyOwoKICAgIGZ1bmN0aW9uIGNoZWNrRG9uZSgpIHsKICAgICAgaWYgKCsrbnVtRG9uZSA9PT0gZGlnZXN0cy5sZW5ndGgpIHsKICAgICAgICBmaW5pc2goZXJyKTsKICAgICAgfQogICAgfQogICAgZGlnZXN0cy5mb3JFYWNoKGZ1bmN0aW9uIChkaWdlc3QpIHsKICAgICAgdmVyaWZ5QXR0YWNobWVudChkaWdlc3QsIGZ1bmN0aW9uIChhdHRFcnIpIHsKICAgICAgICBpZiAoYXR0RXJyICYmICFlcnIpIHsKICAgICAgICAgIGVyciA9IGF0dEVycjsKICAgICAgICB9CiAgICAgICAgY2hlY2tEb25lKCk7CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiB3cml0ZURvYyhkb2NJbmZvLCB3aW5uaW5nUmV2LCB3aW5uaW5nUmV2SXNEZWxldGVkLCBuZXdSZXZJc0RlbGV0ZWQsCiAgICAgICAgICAgICAgICAgICAgaXNVcGRhdGUsIGRlbHRhLCByZXN1bHRzSWR4LCBjYWxsYmFjaykgewoKICAgIGZ1bmN0aW9uIGZpbmlzaCgpIHsKICAgICAgdmFyIGRhdGEgPSBkb2NJbmZvLmRhdGE7CiAgICAgIHZhciBkZWxldGVkSW50ID0gbmV3UmV2SXNEZWxldGVkID8gMSA6IDA7CgogICAgICB2YXIgaWQgPSBkYXRhLl9pZDsKICAgICAgdmFyIHJldiA9IGRhdGEuX3JldjsKICAgICAgdmFyIGpzb24gPSBzdHJpbmdpZnlEb2MoZGF0YSk7CiAgICAgIHZhciBzcWwgPSAnSU5TRVJUIElOVE8gJyArIEJZX1NFUV9TVE9SRSArCiAgICAgICAgJyAoZG9jX2lkLCByZXYsIGpzb24sIGRlbGV0ZWQpIFZBTFVFUyAoPywgPywgPywgPyk7JzsKICAgICAgdmFyIHNxbEFyZ3MgPSBbaWQsIHJldiwganNvbiwgZGVsZXRlZEludF07CgogICAgICAvLyBtYXAgc2VxcyB0byBhdHRhY2htZW50IGRpZ2VzdHMsIHdoaWNoCiAgICAgIC8vIHdlIHdpbGwgbmVlZCBsYXRlciBkdXJpbmcgY29tcGFjdGlvbgogICAgICBmdW5jdGlvbiBpbnNlcnRBdHRhY2htZW50TWFwcGluZ3Moc2VxLCBjYWxsYmFjaykgewogICAgICAgIHZhciBhdHRzQWRkZWQgPSAwOwogICAgICAgIHZhciBhdHRzVG9BZGQgPSBPYmplY3Qua2V5cyhkYXRhLl9hdHRhY2htZW50cyB8fCB7fSk7CgogICAgICAgIGlmICghYXR0c1RvQWRkLmxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRG9uZSgpIHsKICAgICAgICAgIGlmICgrK2F0dHNBZGRlZCA9PT0gYXR0c1RvQWRkLmxlbmd0aCkgewogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyBhY2sgaGFuZGxpbmcgYSBjb25zdHJhaW50IGVycm9yCiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZChhdHQpIHsKICAgICAgICAgIHZhciBzcWwgPSAnSU5TRVJUIElOVE8gJyArIEFUVEFDSF9BTkRfU0VRX1NUT1JFICsKICAgICAgICAgICAgJyAoZGlnZXN0LCBzZXEpIFZBTFVFUyAoPyw/KSc7CiAgICAgICAgICB2YXIgc3FsQXJncyA9IFtkYXRhLl9hdHRhY2htZW50c1thdHRdLmRpZ2VzdCwgc2VxXTsKICAgICAgICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBzcWxBcmdzLCBjaGVja0RvbmUsIGNoZWNrRG9uZSk7CiAgICAgICAgICAvLyBzZWNvbmQgY2FsbGJhY2sgaXMgZm9yIGEgY29uc3RhaW50IGVycm9yLCB3aGljaCB3ZSBpZ25vcmUKICAgICAgICAgIC8vIGJlY2F1c2UgdGhpcyBkb2NpZC9yZXYgaGFzIGFscmVhZHkgYmVlbiBhc3NvY2lhdGVkIHdpdGgKICAgICAgICAgIC8vIHRoZSBkaWdlc3QgKGUuZy4gd2hlbiBuZXdfZWRpdHMgPT0gZmFsc2UpCiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXR0c1RvQWRkLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBhZGQoYXR0c1RvQWRkW2ldKTsgLy8gZG8gaW4gcGFyYWxsZWwKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBzcWxBcmdzLCBmdW5jdGlvbiAodHgsIHJlc3VsdCkgewogICAgICAgIHZhciBzZXEgPSByZXN1bHQuaW5zZXJ0SWQ7CiAgICAgICAgaW5zZXJ0QXR0YWNobWVudE1hcHBpbmdzKHNlcSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgZGF0YVdyaXR0ZW4odHgsIHNlcSk7CiAgICAgICAgfSk7CiAgICAgIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBjb25zdHJhaW50IGVycm9yLCByZWNvdmVyIGJ5IHVwZGF0aW5nIGluc3RlYWQgKHNlZSAjMTYzOCkKICAgICAgICB2YXIgZmV0Y2hTcWwgPSBzZWxlY3QoJ3NlcScsIEJZX1NFUV9TVE9SRSwgbnVsbCwKICAgICAgICAgICdkb2NfaWQ9PyBBTkQgcmV2PT8nKTsKICAgICAgICB0eC5leGVjdXRlU3FsKGZldGNoU3FsLCBbaWQsIHJldl0sIGZ1bmN0aW9uICh0eCwgcmVzKSB7CiAgICAgICAgICB2YXIgc2VxID0gcmVzLnJvd3MuaXRlbSgwKS5zZXE7CiAgICAgICAgICB2YXIgc3FsID0gJ1VQREFURSAnICsgQllfU0VRX1NUT1JFICsKICAgICAgICAgICAgJyBTRVQganNvbj0/LCBkZWxldGVkPT8gV0hFUkUgZG9jX2lkPT8gQU5EIHJldj0/Oyc7CiAgICAgICAgICB2YXIgc3FsQXJncyA9IFtqc29uLCBkZWxldGVkSW50LCBpZCwgcmV2XTsKICAgICAgICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBzcWxBcmdzLCBmdW5jdGlvbiAodHgpIHsKICAgICAgICAgICAgaW5zZXJ0QXR0YWNobWVudE1hcHBpbmdzKHNlcSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGRhdGFXcml0dGVuKHR4LCBzZXEpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBmYWxzZTsgLy8gYWNrIHRoYXQgd2UndmUgaGFuZGxlZCB0aGUgZXJyb3IKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gY29sbGVjdFJlc3VsdHMoYXR0YWNobWVudEVycikgewogICAgICBpZiAoIWVycikgewogICAgICAgIGlmIChhdHRhY2htZW50RXJyKSB7CiAgICAgICAgICBlcnIgPSBhdHRhY2htZW50RXJyOwogICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICB9IGVsc2UgaWYgKHJlY3YgPT09IGF0dGFjaG1lbnRzLmxlbmd0aCkgewogICAgICAgICAgZmluaXNoKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdmFyIGVyciA9IG51bGw7CiAgICB2YXIgcmVjdiA9IDA7CgogICAgZG9jSW5mby5kYXRhLl9pZCA9IGRvY0luZm8ubWV0YWRhdGEuaWQ7CiAgICBkb2NJbmZvLmRhdGEuX3JldiA9IGRvY0luZm8ubWV0YWRhdGEucmV2OwogICAgdmFyIGF0dGFjaG1lbnRzID0gT2JqZWN0LmtleXMoZG9jSW5mby5kYXRhLl9hdHRhY2htZW50cyB8fCB7fSk7CgoKICAgIGlmIChuZXdSZXZJc0RlbGV0ZWQpIHsKICAgICAgZG9jSW5mby5kYXRhLl9kZWxldGVkID0gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBhdHRhY2htZW50U2F2ZWQoZXJyKSB7CiAgICAgIHJlY3YrKzsKICAgICAgY29sbGVjdFJlc3VsdHMoZXJyKTsKICAgIH0KCiAgICBhdHRhY2htZW50cy5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgdmFyIGF0dCA9IGRvY0luZm8uZGF0YS5fYXR0YWNobWVudHNba2V5XTsKICAgICAgaWYgKCFhdHQuc3R1YikgewogICAgICAgIHZhciBkYXRhID0gYXR0LmRhdGE7CiAgICAgICAgZGVsZXRlIGF0dC5kYXRhOwogICAgICAgIHZhciBkaWdlc3QgPSBhdHQuZGlnZXN0OwogICAgICAgIHNhdmVBdHRhY2htZW50KGRpZ2VzdCwgZGF0YSwgYXR0YWNobWVudFNhdmVkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZWN2Kys7CiAgICAgICAgY29sbGVjdFJlc3VsdHMoKTsKICAgICAgfQogICAgfSk7CgogICAgaWYgKCFhdHRhY2htZW50cy5sZW5ndGgpIHsKICAgICAgZmluaXNoKCk7CiAgICB9CgogICAgZnVuY3Rpb24gYXV0b0NvbXBhY3QoKSB7CiAgICAgIGlmICghaXNVcGRhdGUgfHwgIWFwaS5hdXRvX2NvbXBhY3Rpb24pIHsKICAgICAgICByZXR1cm47IC8vIG5vdGhpbmcgdG8gZG8KICAgICAgfQogICAgICB2YXIgaWQgPSBkb2NJbmZvLm1ldGFkYXRhLmlkOwogICAgICB2YXIgcmV2c1RvRGVsZXRlID0gdXRpbHMuY29tcGFjdFRyZWUoZG9jSW5mby5tZXRhZGF0YSk7CiAgICAgIGNvbXBhY3RSZXZzKHJldnNUb0RlbGV0ZSwgaWQsIHR4KTsKICAgIH0KCiAgICBmdW5jdGlvbiBkYXRhV3JpdHRlbih0eCwgc2VxKSB7CiAgICAgIGF1dG9Db21wYWN0KCk7CiAgICAgIGRvY0luZm8ubWV0YWRhdGEuc2VxID0gc2VxOwogICAgICBkZWxldGUgZG9jSW5mby5tZXRhZGF0YS5yZXY7CgogICAgICB2YXIgc3FsID0gaXNVcGRhdGUgPwogICAgICAnVVBEQVRFICcgKyBET0NfU1RPUkUgKwogICAgICAnIFNFVCBqc29uPT8sIG1heF9zZXE9Pywgd2lubmluZ3NlcT0nICsKICAgICAgJyhTRUxFQ1Qgc2VxIEZST00gJyArIEJZX1NFUV9TVE9SRSArCiAgICAgICcgV0hFUkUgZG9jX2lkPScgKyBET0NfU1RPUkUgKyAnLmlkIEFORCByZXY9PykgV0hFUkUgaWQ9PycKICAgICAgICA6ICdJTlNFUlQgSU5UTyAnICsgRE9DX1NUT1JFICsKICAgICAgJyAoaWQsIHdpbm5pbmdzZXEsIG1heF9zZXEsIGpzb24pIFZBTFVFUyAoPyw/LD8sPyk7JzsKICAgICAgdmFyIG1ldGFkYXRhU3RyID0gdXRpbHMuc2FmZUpzb25TdHJpbmdpZnkoZG9jSW5mby5tZXRhZGF0YSk7CiAgICAgIHZhciBpZCA9IGRvY0luZm8ubWV0YWRhdGEuaWQ7CiAgICAgIHZhciBwYXJhbXMgPSBpc1VwZGF0ZSA/CiAgICAgICAgW21ldGFkYXRhU3RyLCBzZXEsIHdpbm5pbmdSZXYsIGlkXSA6CiAgICAgICAgW2lkLCBzZXEsIHNlcSwgbWV0YWRhdGFTdHJdOwogICAgICB0eC5leGVjdXRlU3FsKHNxbCwgcGFyYW1zLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmVzdWx0c1tyZXN1bHRzSWR4XSA9IHsKICAgICAgICAgIG9rOiB0cnVlLAogICAgICAgICAgaWQ6IGRvY0luZm8ubWV0YWRhdGEuaWQsCiAgICAgICAgICByZXY6IHdpbm5pbmdSZXYKICAgICAgICB9OwogICAgICAgIGZldGNoZWREb2NzLnNldChpZCwgZG9jSW5mby5tZXRhZGF0YSk7CiAgICAgICAgY2FsbGJhY2soKTsKICAgICAgfSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB3ZWJzcWxQcm9jZXNzRG9jcygpIHsKICAgIHByb2Nlc3NEb2NzKGRvY0luZm9zLCBhcGksIGZldGNoZWREb2NzLCB0eCwgcmVzdWx0cywgd3JpdGVEb2MsIG9wdHMpOwogIH0KCiAgZnVuY3Rpb24gZmV0Y2hFeGlzdGluZ0RvY3MoY2FsbGJhY2spIHsKICAgIGlmICghZG9jSW5mb3MubGVuZ3RoKSB7CiAgICAgIHJldHVybiBjYWxsYmFjaygpOwogICAgfQoKICAgIHZhciBudW1GZXRjaGVkID0gMDsKCiAgICBmdW5jdGlvbiBjaGVja0RvbmUoKSB7CiAgICAgIGlmICgrK251bUZldGNoZWQgPT09IGRvY0luZm9zLmxlbmd0aCkgewogICAgICAgIGNhbGxiYWNrKCk7CiAgICAgIH0KICAgIH0KCiAgICBkb2NJbmZvcy5mb3JFYWNoKGZ1bmN0aW9uIChkb2NJbmZvKSB7CiAgICAgIGlmIChkb2NJbmZvLl9pZCAmJiBpc0xvY2FsSWQoZG9jSW5mby5faWQpKSB7CiAgICAgICAgcmV0dXJuIGNoZWNrRG9uZSgpOyAvLyBza2lwIGxvY2FsIGRvY3MKICAgICAgfQogICAgICB2YXIgaWQgPSBkb2NJbmZvLm1ldGFkYXRhLmlkOwogICAgICB0eC5leGVjdXRlU3FsKCdTRUxFQ1QganNvbiBGUk9NICcgKyBET0NfU1RPUkUgKwogICAgICAnIFdIRVJFIGlkID0gPycsIFtpZF0sIGZ1bmN0aW9uICh0eCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKHJlc3VsdC5yb3dzLmxlbmd0aCkgewogICAgICAgICAgdmFyIG1ldGFkYXRhID0gdXRpbHMuc2FmZUpzb25QYXJzZShyZXN1bHQucm93cy5pdGVtKDApLmpzb24pOwogICAgICAgICAgZmV0Y2hlZERvY3Muc2V0KGlkLCBtZXRhZGF0YSk7CiAgICAgICAgfQogICAgICAgIGNoZWNrRG9uZSgpOwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gc2F2ZUF0dGFjaG1lbnQoZGlnZXN0LCBkYXRhLCBjYWxsYmFjaykgewogICAgdmFyIHNxbCA9ICdTRUxFQ1QgZGlnZXN0IEZST00gJyArIEFUVEFDSF9TVE9SRSArICcgV0hFUkUgZGlnZXN0PT8nOwogICAgdHguZXhlY3V0ZVNxbChzcWwsIFtkaWdlc3RdLCBmdW5jdGlvbiAodHgsIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0LnJvd3MubGVuZ3RoKSB7IC8vIGF0dGFjaG1lbnQgYWxyZWFkeSBleGlzdHMKICAgICAgICByZXR1cm4gY2FsbGJhY2soKTsKICAgICAgfQogICAgICAvLyB3ZSBjb3VsZCBqdXN0IGluc2VydCBiZWZvcmUgc2VsZWN0aW5nIGFuZCBjYXRjaCB0aGUgZXJyb3IsCiAgICAgIC8vIGJ1dCBteSBodW5jaCBpcyB0aGF0IGl0J3MgY2hlYXBlciBub3QgdG8gc2VyaWFsaXplIHRoZSBibG9iCiAgICAgIC8vIGZyb20gSlMgdG8gQyBpZiB3ZSBkb24ndCBoYXZlIHRvIChUT0RPOiBjb25maXJtIHRoaXMpCiAgICAgIHNxbCA9ICdJTlNFUlQgSU5UTyAnICsgQVRUQUNIX1NUT1JFICsKICAgICAgJyAoZGlnZXN0LCBib2R5LCBlc2NhcGVkKSBWQUxVRVMgKD8sPywxKSc7CiAgICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBbZGlnZXN0LCB3ZWJzcWxVdGlscy5lc2NhcGVCbG9iKGRhdGEpXSwgZnVuY3Rpb24gKCkgewogICAgICAgIGNhbGxiYWNrKCk7CiAgICAgIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBpZ25vcmUgY29uc3RhaW50IGVycm9ycywgbWVhbnMgaXQgYWxyZWFkeSBleGlzdHMKICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIHJldHVybiBmYWxzZTsgLy8gYWNrIHdlIGhhbmRsZWQgdGhlIGVycm9yCiAgICAgIH0pOwogICAgfSk7CiAgfQoKICBwcmVwcm9jZXNzQXR0YWNobWVudHMoZG9jSW5mb3MsICdiaW5hcnknLCBmdW5jdGlvbiAoZXJyKSB7CiAgICBpZiAoZXJyKSB7CiAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwogICAgfQogICAgZGIudHJhbnNhY3Rpb24oZnVuY3Rpb24gKHR4bikgewogICAgICB0eCA9IHR4bjsKICAgICAgdmVyaWZ5QXR0YWNobWVudHMoZnVuY3Rpb24gKGVycikgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHByZWNvbmRpdGlvbkVycm9yZWQgPSBlcnI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZldGNoRXhpc3RpbmdEb2NzKHdlYnNxbFByb2Nlc3NEb2NzKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwgdW5rbm93bkVycm9yKGNhbGxiYWNrKSwgY29tcGxldGUpOwogIH0pOwp9Cgptb2R1bGUuZXhwb3J0cyA9IHdlYnNxbEJ1bGtEb2NzOwoKfSx7Ii4uLy4uL2RlcHMvZG9jcy9pc0xvY2FsSWQiOjU1LCIuLi8uLi9kZXBzL2RvY3MvcHJlcHJvY2Vzc0F0dGFjaG1lbnRzIjo1OSwiLi4vLi4vZGVwcy9kb2NzL3Byb2Nlc3NEb2NzIjo2MCwiLi4vLi4vZGVwcy9lcnJvcnMiOjY0LCIuLi8uLi91dGlscyI6MTAyLCIuL2NvbnN0YW50cyI6MjQsIi4vdXRpbHMiOjI2fV0sMjQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpmdW5jdGlvbiBxdW90ZShzdHIpIHsKICByZXR1cm4gIiciICsgc3RyICsgIiciOwp9CgpleHBvcnRzLkFEQVBURVJfVkVSU0lPTiA9IDc7IC8vIHVzZWQgdG8gbWFuYWdlIG1pZ3JhdGlvbnMKCi8vIFRoZSBvYmplY3Qgc3RvcmVzIGNyZWF0ZWQgZm9yIGVhY2ggZGF0YWJhc2UKLy8gRE9DX1NUT1JFIHN0b3JlcyB0aGUgZG9jdW1lbnQgbWV0YSBkYXRhLCBpdHMgcmV2aXNpb24gaGlzdG9yeSBhbmQgc3RhdGUKZXhwb3J0cy5ET0NfU1RPUkUgPSBxdW90ZSgnZG9jdW1lbnQtc3RvcmUnKTsKLy8gQllfU0VRX1NUT1JFIHN0b3JlcyBhIHBhcnRpY3VsYXIgdmVyc2lvbiBvZiBhIGRvY3VtZW50LCBrZXllZCBieSBpdHMKLy8gc2VxdWVuY2UgaWQKZXhwb3J0cy5CWV9TRVFfU1RPUkUgPSBxdW90ZSgnYnktc2VxdWVuY2UnKTsKLy8gV2hlcmUgd2Ugc3RvcmUgYXR0YWNobWVudHMKZXhwb3J0cy5BVFRBQ0hfU1RPUkUgPSBxdW90ZSgnYXR0YWNoLXN0b3JlJyk7CmV4cG9ydHMuTE9DQUxfU1RPUkUgPSBxdW90ZSgnbG9jYWwtc3RvcmUnKTsKZXhwb3J0cy5NRVRBX1NUT1JFID0gcXVvdGUoJ21ldGFkYXRhLXN0b3JlJyk7Ci8vIHdoZXJlIHdlIHN0b3JlIG1hbnktdG8tbWFueSByZWxhdGlvbnMgYmV0d2VlbiBhdHRhY2htZW50Ci8vIGRpZ2VzdHMgYW5kIHNlcXMKZXhwb3J0cy5BVFRBQ0hfQU5EX1NFUV9TVE9SRSA9IHF1b3RlKCdhdHRhY2gtc2VxLXN0b3JlJyk7CgoKfSx7fV0sMjU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgdXRpbHMgPSByZXF1aXJlKCcuLi8uLi91dGlscycpOwp2YXIgaXNEZWxldGVkID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9kb2NzL2lzRGVsZXRlZCcpOwp2YXIgaXNMb2NhbElkID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9kb2NzL2lzTG9jYWxJZCcpOwp2YXIgZXJyb3JzID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9lcnJvcnMnKTsKdmFyIHBhcnNlSGV4U3RyaW5nID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9wYXJzZUhleCcpOwp2YXIgYmluU3RyaW5nVG9CbG9iID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9iaW5hcnkvYmluYXJ5U3RyaW5nVG9CbG9iT3JCdWZmZXInKTsKdmFyIGhhc0xvY2FsU3RvcmFnZSA9IHJlcXVpcmUoJy4uLy4uL2RlcHMvZW52L2hhc0xvY2FsU3RvcmFnZScpOwp2YXIgY29sbGVjdENvbmZsaWN0cyA9IHJlcXVpcmUoJy4uLy4uL2RlcHMvbWVyZ2UvY29sbGVjdENvbmZsaWN0cycpOwp2YXIgdHJhdmVyc2VSZXZUcmVlID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9tZXJnZS90cmF2ZXJzZVJldlRyZWUnKTsKCnZhciB3ZWJzcWxDb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpOwp2YXIgd2Vic3FsVXRpbHMgPSByZXF1aXJlKCcuL3V0aWxzJyk7CnZhciB3ZWJzcWxCdWxrRG9jcyA9IHJlcXVpcmUoJy4vYnVsa0RvY3MnKTsKCnZhciBBREFQVEVSX1ZFUlNJT04gPSB3ZWJzcWxDb25zdGFudHMuQURBUFRFUl9WRVJTSU9OOwp2YXIgRE9DX1NUT1JFID0gd2Vic3FsQ29uc3RhbnRzLkRPQ19TVE9SRTsKdmFyIEJZX1NFUV9TVE9SRSA9IHdlYnNxbENvbnN0YW50cy5CWV9TRVFfU1RPUkU7CnZhciBBVFRBQ0hfU1RPUkUgPSB3ZWJzcWxDb25zdGFudHMuQVRUQUNIX1NUT1JFOwp2YXIgTE9DQUxfU1RPUkUgPSB3ZWJzcWxDb25zdGFudHMuTE9DQUxfU1RPUkU7CnZhciBNRVRBX1NUT1JFID0gd2Vic3FsQ29uc3RhbnRzLk1FVEFfU1RPUkU7CnZhciBBVFRBQ0hfQU5EX1NFUV9TVE9SRSA9IHdlYnNxbENvbnN0YW50cy5BVFRBQ0hfQU5EX1NFUV9TVE9SRTsKCnZhciBxTWFya3MgPSB3ZWJzcWxVdGlscy5xTWFya3M7CnZhciBzdHJpbmdpZnlEb2MgPSB3ZWJzcWxVdGlscy5zdHJpbmdpZnlEb2M7CnZhciB1bnN0cmluZ2lmeURvYyA9IHdlYnNxbFV0aWxzLnVuc3RyaW5naWZ5RG9jOwp2YXIgc2VsZWN0ID0gd2Vic3FsVXRpbHMuc2VsZWN0Owp2YXIgY29tcGFjdFJldnMgPSB3ZWJzcWxVdGlscy5jb21wYWN0UmV2czsKdmFyIHdlYnNxbEVycm9yID0gd2Vic3FsVXRpbHMud2Vic3FsRXJyb3I7CnZhciBnZXRTaXplID0gd2Vic3FsVXRpbHMuZ2V0U2l6ZTsKdmFyIG9wZW5EQiA9IHdlYnNxbFV0aWxzLm9wZW5EQjsKCmZ1bmN0aW9uIGZldGNoQXR0YWNobWVudHNJZk5lY2Vzc2FyeShkb2MsIG9wdHMsIGFwaSwgdHhuLCBjYikgewogIHZhciBhdHRhY2htZW50cyA9IE9iamVjdC5rZXlzKGRvYy5fYXR0YWNobWVudHMgfHwge30pOwogIGlmICghYXR0YWNobWVudHMubGVuZ3RoKSB7CiAgICByZXR1cm4gY2IgJiYgY2IoKTsKICB9CiAgdmFyIG51bURvbmUgPSAwOwoKICBmdW5jdGlvbiBjaGVja0RvbmUoKSB7CiAgICBpZiAoKytudW1Eb25lID09PSBhdHRhY2htZW50cy5sZW5ndGggJiYgY2IpIHsKICAgICAgY2IoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGZldGNoQXR0YWNobWVudChkb2MsIGF0dCkgewogICAgdmFyIGF0dE9iaiA9IGRvYy5fYXR0YWNobWVudHNbYXR0XTsKICAgIHZhciBhdHRPcHRzID0ge2JpbmFyeTogb3B0cy5iaW5hcnksIGN0eDogdHhufTsKICAgIGFwaS5fZ2V0QXR0YWNobWVudChhdHRPYmosIGF0dE9wdHMsIGZ1bmN0aW9uIChfLCBkYXRhKSB7CiAgICAgIGRvYy5fYXR0YWNobWVudHNbYXR0XSA9IHV0aWxzLmV4dGVuZCgKICAgICAgICB1dGlscy5waWNrKGF0dE9iaiwgWydkaWdlc3QnLCAnY29udGVudF90eXBlJ10pLAogICAgICAgIHsgZGF0YTogZGF0YSB9CiAgICAgICk7CiAgICAgIGNoZWNrRG9uZSgpOwogICAgfSk7CiAgfQoKICBhdHRhY2htZW50cy5mb3JFYWNoKGZ1bmN0aW9uIChhdHQpIHsKICAgIGlmIChvcHRzLmF0dGFjaG1lbnRzICYmIG9wdHMuaW5jbHVkZV9kb2NzKSB7CiAgICAgIGZldGNoQXR0YWNobWVudChkb2MsIGF0dCk7CiAgICB9IGVsc2UgewogICAgICBkb2MuX2F0dGFjaG1lbnRzW2F0dF0uc3R1YiA9IHRydWU7CiAgICAgIGNoZWNrRG9uZSgpOwogICAgfQogIH0pOwp9Cgp2YXIgUE9VQ0hfVkVSU0lPTiA9IDE7CgovLyB0aGVzZSBpbmRleGVzIGNvdmVyIHRoZSBncm91bmQgZm9yIG1vc3QgYWxsRG9jcyBxdWVyaWVzCnZhciBCWV9TRVFfU1RPUkVfREVMRVRFRF9JTkRFWF9TUUwgPQogICdDUkVBVEUgSU5ERVggSUYgTk9UIEVYSVNUUyBcJ2J5LXNlcS1kZWxldGVkLWlkeFwnIE9OICcgKwogIEJZX1NFUV9TVE9SRSArICcgKHNlcSwgZGVsZXRlZCknOwp2YXIgQllfU0VRX1NUT1JFX0RPQ19JRF9SRVZfSU5ERVhfU1FMID0KICAnQ1JFQVRFIFVOSVFVRSBJTkRFWCBJRiBOT1QgRVhJU1RTIFwnYnktc2VxLWRvYy1pZC1yZXZcJyBPTiAnICsKICAgIEJZX1NFUV9TVE9SRSArICcgKGRvY19pZCwgcmV2KSc7CnZhciBET0NfU1RPUkVfV0lOTklOR1NFUV9JTkRFWF9TUUwgPQogICdDUkVBVEUgSU5ERVggSUYgTk9UIEVYSVNUUyBcJ2RvYy13aW5uaW5nc2VxLWlkeFwnIE9OICcgKwogIERPQ19TVE9SRSArICcgKHdpbm5pbmdzZXEpJzsKdmFyIEFUVEFDSF9BTkRfU0VRX1NUT1JFX1NFUV9JTkRFWF9TUUwgPQogICdDUkVBVEUgSU5ERVggSUYgTk9UIEVYSVNUUyBcJ2F0dGFjaC1zZXEtc2VxLWlkeFwnIE9OICcgKwogICAgQVRUQUNIX0FORF9TRVFfU1RPUkUgKyAnIChzZXEpJzsKdmFyIEFUVEFDSF9BTkRfU0VRX1NUT1JFX0FUVEFDSF9JTkRFWF9TUUwgPQogICdDUkVBVEUgVU5JUVVFIElOREVYIElGIE5PVCBFWElTVFMgXCdhdHRhY2gtc2VxLWRpZ2VzdC1pZHhcJyBPTiAnICsKICAgIEFUVEFDSF9BTkRfU0VRX1NUT1JFICsgJyAoZGlnZXN0LCBzZXEpJzsKCnZhciBET0NfU1RPUkVfQU5EX0JZX1NFUV9KT0lORVIgPSBCWV9TRVFfU1RPUkUgKwogICcuc2VxID0gJyArIERPQ19TVE9SRSArICcud2lubmluZ3NlcSc7Cgp2YXIgU0VMRUNUX0RPQ1MgPSBCWV9TRVFfU1RPUkUgKyAnLnNlcSBBUyBzZXEsICcgKwogIEJZX1NFUV9TVE9SRSArICcuZGVsZXRlZCBBUyBkZWxldGVkLCAnICsKICBCWV9TRVFfU1RPUkUgKyAnLmpzb24gQVMgZGF0YSwgJyArCiAgQllfU0VRX1NUT1JFICsgJy5yZXYgQVMgcmV2LCAnICsKICBET0NfU1RPUkUgKyAnLmpzb24gQVMgbWV0YWRhdGEnOwoKZnVuY3Rpb24gV2ViU3FsUG91Y2gob3B0cywgY2FsbGJhY2spIHsKICB2YXIgYXBpID0gdGhpczsKICB2YXIgaW5zdGFuY2VJZCA9IG51bGw7CiAgdmFyIHNpemUgPSBnZXRTaXplKG9wdHMpOwogIHZhciBpZFJlcXVlc3RzID0gW107CiAgdmFyIGVuY29kaW5nOwoKICBhcGkuX2RvY0NvdW50ID0gLTE7IC8vIGNhY2hlIHNxbGl0ZSBjb3VudCgqKSBmb3IgcGVyZm9ybWFuY2UKICBhcGkuX25hbWUgPSBvcHRzLm5hbWU7CgogIHZhciBvcGVuREJSZXN1bHQgPSBvcGVuREIoewogICAgbmFtZTogYXBpLl9uYW1lLAogICAgdmVyc2lvbjogUE9VQ0hfVkVSU0lPTiwKICAgIGRlc2NyaXB0aW9uOiBhcGkuX25hbWUsCiAgICBzaXplOiBzaXplLAogICAgbG9jYXRpb246IG9wdHMubG9jYXRpb24sCiAgICBjcmVhdGVGcm9tTG9jYXRpb246IG9wdHMuY3JlYXRlRnJvbUxvY2F0aW9uLAogICAgYW5kcm9pZERhdGFiYXNlSW1wbGVtZW50YXRpb246IG9wdHMuYW5kcm9pZERhdGFiYXNlSW1wbGVtZW50YXRpb24KICB9KTsKICBpZiAob3BlbkRCUmVzdWx0LmVycm9yKSB7CiAgICByZXR1cm4gd2Vic3FsRXJyb3IoY2FsbGJhY2spKG9wZW5EQlJlc3VsdC5lcnJvcik7CiAgfQogIHZhciBkYiA9IG9wZW5EQlJlc3VsdC5kYjsKICBpZiAodHlwZW9mIGRiLnJlYWRUcmFuc2FjdGlvbiAhPT0gJ2Z1bmN0aW9uJykgewogICAgLy8gZG9lc24ndCBleGlzdCBpbiBzcWxpdGUgcGx1Z2luCiAgICBkYi5yZWFkVHJhbnNhY3Rpb24gPSBkYi50cmFuc2FjdGlvbjsKICB9CgogIGZ1bmN0aW9uIGRiQ3JlYXRlZCgpIHsKICAgIC8vIG5vdGUgdGhlIGRiIG5hbWUgaW4gY2FzZSB0aGUgYnJvd3NlciB1cGdyYWRlcyB0byBpZGIKICAgIGlmIChoYXNMb2NhbFN0b3JhZ2UoKSkgewogICAgICB3aW5kb3cubG9jYWxTdG9yYWdlWydfcG91Y2hfX3dlYnNxbGRiXycgKyBhcGkuX25hbWVdID0gdHJ1ZTsKICAgIH0KICAgIGNhbGxiYWNrKG51bGwsIGFwaSk7CiAgfQoKICAvLyBJbiB0aGlzIG1pZ3JhdGlvbiwgd2UgYWRkZWQgdGhlICdkZWxldGVkJyBhbmQgJ2xvY2FsJyBjb2x1bW5zIHRvIHRoZQogIC8vIGJ5LXNlcSBhbmQgZG9jIHN0b3JlIHRhYmxlcy4KICAvLyBUbyBwcmVzZXJ2ZSBleGlzdGluZyB1c2VyIGRhdGEsIHdlIHJlLXByb2Nlc3MgYWxsIHRoZSBleGlzdGluZyBKU09OCiAgLy8gYW5kIGFkZCB0aGVzZSB2YWx1ZXMuCiAgLy8gQ2FsbGVkIG1pZ3JhdGlvbjIgYmVjYXVzZSBpdCBjb3JyZXNwb25kcyB0byBhZGFwdGVyIHZlcnNpb24gKGRiX3ZlcnNpb24pICMyCiAgZnVuY3Rpb24gcnVuTWlncmF0aW9uMih0eCwgY2FsbGJhY2spIHsKICAgIC8vIGluZGV4IHVzZWQgZm9yIHRoZSBqb2luIGluIHRoZSBhbGxEb2NzIHF1ZXJ5CiAgICB0eC5leGVjdXRlU3FsKERPQ19TVE9SRV9XSU5OSU5HU0VRX0lOREVYX1NRTCk7CgogICAgdHguZXhlY3V0ZVNxbCgnQUxURVIgVEFCTEUgJyArIEJZX1NFUV9TVE9SRSArCiAgICAgICcgQUREIENPTFVNTiBkZWxldGVkIFRJTllJTlQoMSkgREVGQVVMVCAwJywgW10sIGZ1bmN0aW9uICgpIHsKICAgICAgdHguZXhlY3V0ZVNxbChCWV9TRVFfU1RPUkVfREVMRVRFRF9JTkRFWF9TUUwpOwogICAgICB0eC5leGVjdXRlU3FsKCdBTFRFUiBUQUJMRSAnICsgRE9DX1NUT1JFICsKICAgICAgICAnIEFERCBDT0xVTU4gbG9jYWwgVElOWUlOVCgxKSBERUZBVUxUIDAnLCBbXSwgZnVuY3Rpb24gKCkgewogICAgICAgIHR4LmV4ZWN1dGVTcWwoJ0NSRUFURSBJTkRFWCBJRiBOT1QgRVhJU1RTIFwnZG9jLXN0b3JlLWxvY2FsLWlkeFwnIE9OICcgKwogICAgICAgICAgRE9DX1NUT1JFICsgJyAobG9jYWwsIGlkKScpOwoKICAgICAgICB2YXIgc3FsID0gJ1NFTEVDVCAnICsgRE9DX1NUT1JFICsgJy53aW5uaW5nc2VxIEFTIHNlcSwgJyArIERPQ19TVE9SRSArCiAgICAgICAgICAnLmpzb24gQVMgbWV0YWRhdGEgRlJPTSAnICsgQllfU0VRX1NUT1JFICsgJyBKT0lOICcgKyBET0NfU1RPUkUgKwogICAgICAgICAgJyBPTiAnICsgQllfU0VRX1NUT1JFICsgJy5zZXEgPSAnICsgRE9DX1NUT1JFICsgJy53aW5uaW5nc2VxJzsKCiAgICAgICAgdHguZXhlY3V0ZVNxbChzcWwsIFtdLCBmdW5jdGlvbiAodHgsIHJlc3VsdCkgewoKICAgICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgICB2YXIgbG9jYWwgPSBbXTsKCiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc3VsdC5yb3dzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBpdGVtID0gcmVzdWx0LnJvd3MuaXRlbShpKTsKICAgICAgICAgICAgdmFyIHNlcSA9IGl0ZW0uc2VxOwogICAgICAgICAgICB2YXIgbWV0YWRhdGEgPSBKU09OLnBhcnNlKGl0ZW0ubWV0YWRhdGEpOwogICAgICAgICAgICBpZiAoaXNEZWxldGVkKG1ldGFkYXRhKSkgewogICAgICAgICAgICAgIGRlbGV0ZWQucHVzaChzZXEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0xvY2FsSWQobWV0YWRhdGEuaWQpKSB7CiAgICAgICAgICAgICAgbG9jYWwucHVzaChtZXRhZGF0YS5pZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHR4LmV4ZWN1dGVTcWwoJ1VQREFURSAnICsgRE9DX1NUT1JFICsgJ1NFVCBsb2NhbCA9IDEgV0hFUkUgaWQgSU4gJyArCiAgICAgICAgICAgIHFNYXJrcyhsb2NhbC5sZW5ndGgpLCBsb2NhbCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0eC5leGVjdXRlU3FsKCdVUERBVEUgJyArIEJZX1NFUV9TVE9SRSArCiAgICAgICAgICAgICAgJyBTRVQgZGVsZXRlZCA9IDEgV0hFUkUgc2VxIElOICcgKwogICAgICAgICAgICAgIHFNYXJrcyhkZWxldGVkLmxlbmd0aCksIGRlbGV0ZWQsIGNhbGxiYWNrKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgLy8gaW4gdGhpcyBtaWdyYXRpb24sIHdlIG1ha2UgYWxsIHRoZSBsb2NhbCBkb2NzIHVudmVyc2lvbmVkCiAgZnVuY3Rpb24gcnVuTWlncmF0aW9uMyh0eCwgY2FsbGJhY2spIHsKICAgIHZhciBsb2NhbCA9ICdDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAnICsgTE9DQUxfU1RPUkUgKwogICAgICAnIChpZCBVTklRVUUsIHJldiwganNvbiknOwogICAgdHguZXhlY3V0ZVNxbChsb2NhbCwgW10sIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHNxbCA9ICdTRUxFQ1QgJyArIERPQ19TVE9SRSArICcuaWQgQVMgaWQsICcgKwogICAgICAgIEJZX1NFUV9TVE9SRSArICcuanNvbiBBUyBkYXRhICcgKwogICAgICAgICdGUk9NICcgKyBCWV9TRVFfU1RPUkUgKyAnIEpPSU4gJyArCiAgICAgICAgRE9DX1NUT1JFICsgJyBPTiAnICsgQllfU0VRX1NUT1JFICsgJy5zZXEgPSAnICsKICAgICAgICBET0NfU1RPUkUgKyAnLndpbm5pbmdzZXEgV0hFUkUgbG9jYWwgPSAxJzsKICAgICAgdHguZXhlY3V0ZVNxbChzcWwsIFtdLCBmdW5jdGlvbiAodHgsIHJlcykgewogICAgICAgIHZhciByb3dzID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXMucm93cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgcm93cy5wdXNoKHJlcy5yb3dzLml0ZW0oaSkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkb05leHQoKSB7CiAgICAgICAgICBpZiAoIXJvd3MubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayh0eCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm93ID0gcm93cy5zaGlmdCgpOwogICAgICAgICAgdmFyIHJldiA9IEpTT04ucGFyc2Uocm93LmRhdGEpLl9yZXY7CiAgICAgICAgICB0eC5leGVjdXRlU3FsKCdJTlNFUlQgSU5UTyAnICsgTE9DQUxfU1RPUkUgKwogICAgICAgICAgICAgICcgKGlkLCByZXYsIGpzb24pIFZBTFVFUyAoPyw/LD8pJywKICAgICAgICAgICAgICBbcm93LmlkLCByZXYsIHJvdy5kYXRhXSwgZnVuY3Rpb24gKHR4KSB7CiAgICAgICAgICAgIHR4LmV4ZWN1dGVTcWwoJ0RFTEVURSBGUk9NICcgKyBET0NfU1RPUkUgKyAnIFdIRVJFIGlkPT8nLAogICAgICAgICAgICAgICAgW3Jvdy5pZF0sIGZ1bmN0aW9uICh0eCkgewogICAgICAgICAgICAgIHR4LmV4ZWN1dGVTcWwoJ0RFTEVURSBGUk9NICcgKyBCWV9TRVFfU1RPUkUgKyAnIFdIRVJFIHNlcT0/JywKICAgICAgICAgICAgICAgICAgW3Jvdy5zZXFdLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBkb05leHQoKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZG9OZXh0KCk7CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICAvLyBpbiB0aGlzIG1pZ3JhdGlvbiwgd2UgcmVtb3ZlIGRvY19pZF9yZXYgYW5kIGp1c3QgdXNlIHJldgogIGZ1bmN0aW9uIHJ1bk1pZ3JhdGlvbjQodHgsIGNhbGxiYWNrKSB7CgogICAgZnVuY3Rpb24gdXBkYXRlUm93cyhyb3dzKSB7CiAgICAgIGZ1bmN0aW9uIGRvTmV4dCgpIHsKICAgICAgICBpZiAoIXJvd3MubGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2sodHgpOwogICAgICAgIH0KICAgICAgICB2YXIgcm93ID0gcm93cy5zaGlmdCgpOwogICAgICAgIHZhciBkb2NfaWRfcmV2ID0gcGFyc2VIZXhTdHJpbmcocm93LmhleCwgZW5jb2RpbmcpOwogICAgICAgIHZhciBpZHggPSBkb2NfaWRfcmV2Lmxhc3RJbmRleE9mKCc6OicpOwogICAgICAgIHZhciBkb2NfaWQgPSBkb2NfaWRfcmV2LnN1YnN0cmluZygwLCBpZHgpOwogICAgICAgIHZhciByZXYgPSBkb2NfaWRfcmV2LnN1YnN0cmluZyhpZHggKyAyKTsKICAgICAgICB2YXIgc3FsID0gJ1VQREFURSAnICsgQllfU0VRX1NUT1JFICsKICAgICAgICAgICcgU0VUIGRvY19pZD0/LCByZXY9PyBXSEVSRSBkb2NfaWRfcmV2PT8nOwogICAgICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBbZG9jX2lkLCByZXYsIGRvY19pZF9yZXZdLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkb05leHQoKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBkb05leHQoKTsKICAgIH0KCiAgICB2YXIgc3FsID0gJ0FMVEVSIFRBQkxFICcgKyBCWV9TRVFfU1RPUkUgKyAnIEFERCBDT0xVTU4gZG9jX2lkJzsKICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBbXSwgZnVuY3Rpb24gKHR4KSB7CiAgICAgIHZhciBzcWwgPSAnQUxURVIgVEFCTEUgJyArIEJZX1NFUV9TVE9SRSArICcgQUREIENPTFVNTiByZXYnOwogICAgICB0eC5leGVjdXRlU3FsKHNxbCwgW10sIGZ1bmN0aW9uICh0eCkgewogICAgICAgIHR4LmV4ZWN1dGVTcWwoQllfU0VRX1NUT1JFX0RPQ19JRF9SRVZfSU5ERVhfU1FMLCBbXSwgZnVuY3Rpb24gKHR4KSB7CiAgICAgICAgICB2YXIgc3FsID0gJ1NFTEVDVCBoZXgoZG9jX2lkX3JldikgYXMgaGV4IEZST00gJyArIEJZX1NFUV9TVE9SRTsKICAgICAgICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBbXSwgZnVuY3Rpb24gKHR4LCByZXMpIHsKICAgICAgICAgICAgdmFyIHJvd3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXMucm93cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHJvd3MucHVzaChyZXMucm93cy5pdGVtKGkpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVSb3dzKHJvd3MpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICAvLyBpbiB0aGlzIG1pZ3JhdGlvbiwgd2UgYWRkIHRoZSBhdHRhY2hfYW5kX3NlcSB0YWJsZQogIC8vIGZvciBpc3N1ZSAjMjgxOAogIGZ1bmN0aW9uIHJ1bk1pZ3JhdGlvbjUodHgsIGNhbGxiYWNrKSB7CgogICAgZnVuY3Rpb24gbWlncmF0ZUF0dHNBbmRTZXFzKHR4KSB7CiAgICAgIC8vIG5lZWQgdG8gYWN0dWFsbHkgcG9wdWxhdGUgdGhlIHRhYmxlLiB0aGlzIGlzIHRoZSBleHBlbnNpdmUgcGFydCwKICAgICAgLy8gc28gYXMgYW4gb3B0aW1pemF0aW9uLCBjaGVjayBmaXJzdCB0aGF0IHRoaXMgZGF0YWJhc2UgZXZlbgogICAgICAvLyBjb250YWlucyBhdHRhY2htZW50cwogICAgICB2YXIgc3FsID0gJ1NFTEVDVCBDT1VOVCgqKSBBUyBjbnQgRlJPTSAnICsgQVRUQUNIX1NUT1JFOwogICAgICB0eC5leGVjdXRlU3FsKHNxbCwgW10sIGZ1bmN0aW9uICh0eCwgcmVzKSB7CiAgICAgICAgdmFyIGNvdW50ID0gcmVzLnJvd3MuaXRlbSgwKS5jbnQ7CiAgICAgICAgaWYgKCFjb3VudCkgewogICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHR4KTsKICAgICAgICB9CgogICAgICAgIHZhciBvZmZzZXQgPSAwOwogICAgICAgIHZhciBwYWdlU2l6ZSA9IDEwOwogICAgICAgIGZ1bmN0aW9uIG5leHRQYWdlKCkgewogICAgICAgICAgdmFyIHNxbCA9IHNlbGVjdCgKICAgICAgICAgICAgU0VMRUNUX0RPQ1MgKyAnLCAnICsgRE9DX1NUT1JFICsgJy5pZCBBUyBpZCcsCiAgICAgICAgICAgIFtET0NfU1RPUkUsIEJZX1NFUV9TVE9SRV0sCiAgICAgICAgICAgIERPQ19TVE9SRV9BTkRfQllfU0VRX0pPSU5FUiwKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgRE9DX1NUT1JFICsgJy5pZCAnCiAgICAgICAgICApOwogICAgICAgICAgc3FsICs9ICcgTElNSVQgJyArIHBhZ2VTaXplICsgJyBPRkZTRVQgJyArIG9mZnNldDsKICAgICAgICAgIG9mZnNldCArPSBwYWdlU2l6ZTsKICAgICAgICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBbXSwgZnVuY3Rpb24gKHR4LCByZXMpIHsKICAgICAgICAgICAgaWYgKCFyZXMucm93cy5sZW5ndGgpIHsKICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sodHgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkaWdlc3RTZXFzID0ge307CiAgICAgICAgICAgIGZ1bmN0aW9uIGFkZERpZ2VzdFNlcShkaWdlc3QsIHNlcSkgewogICAgICAgICAgICAgIC8vIHVuaXEgZGlnZXN0L3NlcSBwYWlycywganVzdCBpbiBjYXNlIHRoZXJlIGFyZSBkdXBzCiAgICAgICAgICAgICAgdmFyIHNlcXMgPSBkaWdlc3RTZXFzW2RpZ2VzdF0gPSAoZGlnZXN0U2Vxc1tkaWdlc3RdIHx8IFtdKTsKICAgICAgICAgICAgICBpZiAoc2Vxcy5pbmRleE9mKHNlcSkgPT09IC0xKSB7CiAgICAgICAgICAgICAgICBzZXFzLnB1c2goc2VxKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXMucm93cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciByb3cgPSByZXMucm93cy5pdGVtKGkpOwogICAgICAgICAgICAgIHZhciBkb2MgPSB1bnN0cmluZ2lmeURvYyhyb3cuZGF0YSwgcm93LmlkLCByb3cucmV2KTsKICAgICAgICAgICAgICB2YXIgYXR0cyA9IE9iamVjdC5rZXlzKGRvYy5fYXR0YWNobWVudHMgfHwge30pOwogICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYXR0cy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgdmFyIGF0dCA9IGRvYy5fYXR0YWNobWVudHNbYXR0c1tqXV07CiAgICAgICAgICAgICAgICBhZGREaWdlc3RTZXEoYXR0LmRpZ2VzdCwgcm93LnNlcSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkaWdlc3RTZXFQYWlycyA9IFtdOwogICAgICAgICAgICBPYmplY3Qua2V5cyhkaWdlc3RTZXFzKS5mb3JFYWNoKGZ1bmN0aW9uIChkaWdlc3QpIHsKICAgICAgICAgICAgICB2YXIgc2VxcyA9IGRpZ2VzdFNlcXNbZGlnZXN0XTsKICAgICAgICAgICAgICBzZXFzLmZvckVhY2goZnVuY3Rpb24gKHNlcSkgewogICAgICAgICAgICAgICAgZGlnZXN0U2VxUGFpcnMucHVzaChbZGlnZXN0LCBzZXFdKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmICghZGlnZXN0U2VxUGFpcnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5leHRQYWdlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG51bURvbmUgPSAwOwogICAgICAgICAgICBkaWdlc3RTZXFQYWlycy5mb3JFYWNoKGZ1bmN0aW9uIChwYWlyKSB7CiAgICAgICAgICAgICAgdmFyIHNxbCA9ICdJTlNFUlQgSU5UTyAnICsgQVRUQUNIX0FORF9TRVFfU1RPUkUgKwogICAgICAgICAgICAgICAgJyAoZGlnZXN0LCBzZXEpIFZBTFVFUyAoPyw/KSc7CiAgICAgICAgICAgICAgdHguZXhlY3V0ZVNxbChzcWwsIHBhaXIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICgrK251bURvbmUgPT09IGRpZ2VzdFNlcVBhaXJzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICBuZXh0UGFnZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBuZXh0UGFnZSgpOwogICAgICB9KTsKICAgIH0KCiAgICB2YXIgYXR0YWNoQW5kUmV2ID0gJ0NSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICcgKwogICAgICBBVFRBQ0hfQU5EX1NFUV9TVE9SRSArICcgKGRpZ2VzdCwgc2VxIElOVEVHRVIpJzsKICAgIHR4LmV4ZWN1dGVTcWwoYXR0YWNoQW5kUmV2LCBbXSwgZnVuY3Rpb24gKHR4KSB7CiAgICAgIHR4LmV4ZWN1dGVTcWwoCiAgICAgICAgQVRUQUNIX0FORF9TRVFfU1RPUkVfQVRUQUNIX0lOREVYX1NRTCwgW10sIGZ1bmN0aW9uICh0eCkgewogICAgICAgICAgdHguZXhlY3V0ZVNxbCgKICAgICAgICAgICAgQVRUQUNIX0FORF9TRVFfU1RPUkVfU0VRX0lOREVYX1NRTCwgW10sCiAgICAgICAgICAgIG1pZ3JhdGVBdHRzQW5kU2Vxcyk7CiAgICAgICAgfSk7CiAgICB9KTsKICB9CgogIC8vIGluIHRoaXMgbWlncmF0aW9uLCB3ZSB1c2UgZXNjYXBlQmxvYigpIGFuZCB1bmVzY2FwZUJsb2IoKQogIC8vIGluc3RlYWQgb2YgcmVhZGluZyBvdXQgdGhlIGJpbmFyeSBhcyBIRVgsIHdoaWNoIGlzIHNsb3cKICBmdW5jdGlvbiBydW5NaWdyYXRpb242KHR4LCBjYWxsYmFjaykgewogICAgdmFyIHNxbCA9ICdBTFRFUiBUQUJMRSAnICsgQVRUQUNIX1NUT1JFICsKICAgICAgJyBBREQgQ09MVU1OIGVzY2FwZWQgVElOWUlOVCgxKSBERUZBVUxUIDAnOwogICAgdHguZXhlY3V0ZVNxbChzcWwsIFtdLCBjYWxsYmFjayk7CiAgfQoKICAvLyBpc3N1ZSAjMzEzNiwgaW4gdGhpcyBtaWdyYXRpb24gd2UgbmVlZCBhICJsYXRlc3Qgc2VxIiBhcyB3ZWxsCiAgLy8gYXMgdGhlICJ3aW5uaW5nIHNlcSIgaW4gdGhlIGRvYyBzdG9yZQogIGZ1bmN0aW9uIHJ1bk1pZ3JhdGlvbjcodHgsIGNhbGxiYWNrKSB7CiAgICB2YXIgc3FsID0gJ0FMVEVSIFRBQkxFICcgKyBET0NfU1RPUkUgKwogICAgICAnIEFERCBDT0xVTU4gbWF4X3NlcSBJTlRFR0VSJzsKICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBbXSwgZnVuY3Rpb24gKHR4KSB7CiAgICAgIHZhciBzcWwgPSAnVVBEQVRFICcgKyBET0NfU1RPUkUgKyAnIFNFVCBtYXhfc2VxPShTRUxFQ1QgTUFYKHNlcSkgRlJPTSAnICsKICAgICAgICBCWV9TRVFfU1RPUkUgKyAnIFdIRVJFIGRvY19pZD1pZCknOwogICAgICB0eC5leGVjdXRlU3FsKHNxbCwgW10sIGZ1bmN0aW9uICh0eCkgewogICAgICAgIC8vIGFkZCB1bmlxdWUgaW5kZXggYWZ0ZXIgZmlsbGluZywgZWxzZSB3ZSdsbCBnZXQgYSBjb25zdHJhaW50CiAgICAgICAgLy8gZXJyb3Igd2hlbiB3ZSBkbyB0aGUgQUxURVIgVEFCTEUKICAgICAgICB2YXIgc3FsID0KICAgICAgICAgICdDUkVBVEUgVU5JUVVFIElOREVYIElGIE5PVCBFWElTVFMgXCdkb2MtbWF4LXNlcS1pZHhcJyBPTiAnICsKICAgICAgICAgIERPQ19TVE9SRSArICcgKG1heF9zZXEpJzsKICAgICAgICB0eC5leGVjdXRlU3FsKHNxbCwgW10sIGNhbGxiYWNrKTsKICAgICAgfSk7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGNoZWNrRW5jb2RpbmcodHgsIGNiKSB7CiAgICAvLyBVVEYtOCBvbiBjaHJvbWUvYW5kcm9pZCwgVVRGLTE2IG9uIHNhZmFyaSA8IDcuMQogICAgdHguZXhlY3V0ZVNxbCgnU0VMRUNUIEhFWCgiYSIpIEFTIGhleCcsIFtdLCBmdW5jdGlvbiAodHgsIHJlcykgewogICAgICAgIHZhciBoZXggPSByZXMucm93cy5pdGVtKDApLmhleDsKICAgICAgICBlbmNvZGluZyA9IGhleC5sZW5ndGggPT09IDIgPyAnVVRGLTgnIDogJ1VURi0xNic7CiAgICAgICAgY2IoKTsKICAgICAgfQogICAgKTsKICB9CgogIGZ1bmN0aW9uIG9uR2V0SW5zdGFuY2VJZCgpIHsKICAgIHdoaWxlIChpZFJlcXVlc3RzLmxlbmd0aCA+IDApIHsKICAgICAgdmFyIGlkQ2FsbGJhY2sgPSBpZFJlcXVlc3RzLnBvcCgpOwogICAgICBpZENhbGxiYWNrKG51bGwsIGluc3RhbmNlSWQpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gb25HZXRWZXJzaW9uKHR4LCBkYlZlcnNpb24pIHsKICAgIGlmIChkYlZlcnNpb24gPT09IDApIHsKICAgICAgLy8gaW5pdGlhbCBzY2hlbWEKCiAgICAgIHZhciBtZXRhID0gJ0NSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICcgKyBNRVRBX1NUT1JFICsKICAgICAgICAnIChkYmlkLCBkYl92ZXJzaW9uIElOVEVHRVIpJzsKICAgICAgdmFyIGF0dGFjaCA9ICdDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAnICsgQVRUQUNIX1NUT1JFICsKICAgICAgICAnIChkaWdlc3QgVU5JUVVFLCBlc2NhcGVkIFRJTllJTlQoMSksIGJvZHkgQkxPQiknOwogICAgICB2YXIgYXR0YWNoQW5kUmV2ID0gJ0NSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICcgKwogICAgICAgIEFUVEFDSF9BTkRfU0VRX1NUT1JFICsgJyAoZGlnZXN0LCBzZXEgSU5URUdFUiknOwogICAgICAvLyBUT0RPOiBtaWdyYXRlIHdpbm5pbmdzZXEgdG8gSU5URUdFUgogICAgICB2YXIgZG9jID0gJ0NSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICcgKyBET0NfU1RPUkUgKwogICAgICAgICcgKGlkIHVuaXF1ZSwganNvbiwgd2lubmluZ3NlcSwgbWF4X3NlcSBJTlRFR0VSIFVOSVFVRSknOwogICAgICB2YXIgc2VxID0gJ0NSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICcgKyBCWV9TRVFfU1RPUkUgKwogICAgICAgICcgKHNlcSBJTlRFR0VSIE5PVCBOVUxMIFBSSU1BUlkgS0VZIEFVVE9JTkNSRU1FTlQsICcgKwogICAgICAgICdqc29uLCBkZWxldGVkIFRJTllJTlQoMSksIGRvY19pZCwgcmV2KSc7CiAgICAgIHZhciBsb2NhbCA9ICdDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAnICsgTE9DQUxfU1RPUkUgKwogICAgICAgICcgKGlkIFVOSVFVRSwgcmV2LCBqc29uKSc7CgogICAgICAvLyBjcmVhdGVzCiAgICAgIHR4LmV4ZWN1dGVTcWwoYXR0YWNoKTsKICAgICAgdHguZXhlY3V0ZVNxbChsb2NhbCk7CiAgICAgIHR4LmV4ZWN1dGVTcWwoYXR0YWNoQW5kUmV2LCBbXSwgZnVuY3Rpb24gKCkgewogICAgICAgIHR4LmV4ZWN1dGVTcWwoQVRUQUNIX0FORF9TRVFfU1RPUkVfU0VRX0lOREVYX1NRTCk7CiAgICAgICAgdHguZXhlY3V0ZVNxbChBVFRBQ0hfQU5EX1NFUV9TVE9SRV9BVFRBQ0hfSU5ERVhfU1FMKTsKICAgICAgfSk7CiAgICAgIHR4LmV4ZWN1dGVTcWwoZG9jLCBbXSwgZnVuY3Rpb24gKCkgewogICAgICAgIHR4LmV4ZWN1dGVTcWwoRE9DX1NUT1JFX1dJTk5JTkdTRVFfSU5ERVhfU1FMKTsKICAgICAgICB0eC5leGVjdXRlU3FsKHNlcSwgW10sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHR4LmV4ZWN1dGVTcWwoQllfU0VRX1NUT1JFX0RFTEVURURfSU5ERVhfU1FMKTsKICAgICAgICAgIHR4LmV4ZWN1dGVTcWwoQllfU0VRX1NUT1JFX0RPQ19JRF9SRVZfSU5ERVhfU1FMKTsKICAgICAgICAgIHR4LmV4ZWN1dGVTcWwobWV0YSwgW10sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy8gbWFyayB0aGUgZGIgdmVyc2lvbiwgYW5kIG5ldyBkYmlkCiAgICAgICAgICAgIHZhciBpbml0U2VxID0gJ0lOU0VSVCBJTlRPICcgKyBNRVRBX1NUT1JFICsKICAgICAgICAgICAgICAnIChkYl92ZXJzaW9uLCBkYmlkKSBWQUxVRVMgKD8sPyknOwogICAgICAgICAgICBpbnN0YW5jZUlkID0gdXRpbHMudXVpZCgpOwogICAgICAgICAgICB2YXIgaW5pdFNlcUFyZ3MgPSBbQURBUFRFUl9WRVJTSU9OLCBpbnN0YW5jZUlkXTsKICAgICAgICAgICAgdHguZXhlY3V0ZVNxbChpbml0U2VxLCBpbml0U2VxQXJncywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIG9uR2V0SW5zdGFuY2VJZCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0gZWxzZSB7IC8vIHZlcnNpb24gPiAwCgogICAgICB2YXIgc2V0dXBEb25lID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBtaWdyYXRlZCA9IGRiVmVyc2lvbiA8IEFEQVBURVJfVkVSU0lPTjsKICAgICAgICBpZiAobWlncmF0ZWQpIHsKICAgICAgICAgIC8vIHVwZGF0ZSB0aGUgZGIgdmVyc2lvbiB3aXRoaW4gdGhpcyB0cmFuc2FjdGlvbgogICAgICAgICAgdHguZXhlY3V0ZVNxbCgnVVBEQVRFICcgKyBNRVRBX1NUT1JFICsgJyBTRVQgZGJfdmVyc2lvbiA9ICcgKwogICAgICAgICAgICBBREFQVEVSX1ZFUlNJT04pOwogICAgICAgIH0KICAgICAgICAvLyBub3RpZnkgZGIuaWQoKSBjYWxsZXJzCiAgICAgICAgdmFyIHNxbCA9ICdTRUxFQ1QgZGJpZCBGUk9NICcgKyBNRVRBX1NUT1JFOwogICAgICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBbXSwgZnVuY3Rpb24gKHR4LCByZXN1bHQpIHsKICAgICAgICAgIGluc3RhbmNlSWQgPSByZXN1bHQucm93cy5pdGVtKDApLmRiaWQ7CiAgICAgICAgICBvbkdldEluc3RhbmNlSWQoKTsKICAgICAgICB9KTsKICAgICAgfTsKCiAgICAgIC8vIHdvdWxkIGxvdmUgdG8gdXNlIHByb21pc2VzIGhlcmUsIGJ1dCB0aGVuIHdlYnNxbAogICAgICAvLyBlbmRzIHRoZSB0cmFuc2FjdGlvbiBlYXJseQogICAgICB2YXIgdGFza3MgPSBbCiAgICAgICAgcnVuTWlncmF0aW9uMiwKICAgICAgICBydW5NaWdyYXRpb24zLAogICAgICAgIHJ1bk1pZ3JhdGlvbjQsCiAgICAgICAgcnVuTWlncmF0aW9uNSwKICAgICAgICBydW5NaWdyYXRpb242LAogICAgICAgIHJ1bk1pZ3JhdGlvbjcsCiAgICAgICAgc2V0dXBEb25lCiAgICAgIF07CgogICAgICAvLyBydW4gZWFjaCBtaWdyYXRpb24gc2VxdWVudGlhbGx5CiAgICAgIHZhciBpID0gZGJWZXJzaW9uOwogICAgICB2YXIgbmV4dE1pZ3JhdGlvbiA9IGZ1bmN0aW9uICh0eCkgewogICAgICAgIHRhc2tzW2kgLSAxXSh0eCwgbmV4dE1pZ3JhdGlvbik7CiAgICAgICAgaSsrOwogICAgICB9OwogICAgICBuZXh0TWlncmF0aW9uKHR4KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHNldHVwKCkgewogICAgZGIudHJhbnNhY3Rpb24oZnVuY3Rpb24gKHR4KSB7CiAgICAgIC8vIGZpcnN0IGNoZWNrIHRoZSBlbmNvZGluZwogICAgICBjaGVja0VuY29kaW5nKHR4LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gdGhlbiBnZXQgdGhlIHZlcnNpb24KICAgICAgICBmZXRjaFZlcnNpb24odHgpOwogICAgICB9KTsKICAgIH0sIHdlYnNxbEVycm9yKGNhbGxiYWNrKSwgZGJDcmVhdGVkKTsKICB9CgogIGZ1bmN0aW9uIGZldGNoVmVyc2lvbih0eCkgewogICAgdmFyIHNxbCA9ICdTRUxFQ1Qgc3FsIEZST00gc3FsaXRlX21hc3RlciBXSEVSRSB0YmxfbmFtZSA9ICcgKyBNRVRBX1NUT1JFOwogICAgdHguZXhlY3V0ZVNxbChzcWwsIFtdLCBmdW5jdGlvbiAodHgsIHJlc3VsdCkgewogICAgICBpZiAoIXJlc3VsdC5yb3dzLmxlbmd0aCkgewogICAgICAgIC8vIGRhdGFiYXNlIGhhc24ndCBldmVuIGJlZW4gY3JlYXRlZCB5ZXQgKHZlcnNpb24gMCkKICAgICAgICBvbkdldFZlcnNpb24odHgsIDApOwogICAgICB9IGVsc2UgaWYgKCEvZGJfdmVyc2lvbi8udGVzdChyZXN1bHQucm93cy5pdGVtKDApLnNxbCkpIHsKICAgICAgICAvLyB0YWJsZSB3YXMgY3JlYXRlZCwgYnV0IHdpdGhvdXQgdGhlIG5ldyBkYl92ZXJzaW9uIGNvbHVtbiwKICAgICAgICAvLyBzbyBhZGQgaXQuCiAgICAgICAgdHguZXhlY3V0ZVNxbCgnQUxURVIgVEFCTEUgJyArIE1FVEFfU1RPUkUgKwogICAgICAgICAgJyBBREQgQ09MVU1OIGRiX3ZlcnNpb24gSU5URUdFUicsIFtdLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAvLyBiZWZvcmUgdmVyc2lvbiAyLCB0aGlzIGNvbHVtbiBkaWRuJ3QgZXZlbiBleGlzdAogICAgICAgICAgb25HZXRWZXJzaW9uKHR4LCAxKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsgLy8gY29sdW1uIGV4aXN0cywgd2UgY2FuIHNhZmVseSBnZXQgaXQKICAgICAgICB0eC5leGVjdXRlU3FsKCdTRUxFQ1QgZGJfdmVyc2lvbiBGUk9NICcgKyBNRVRBX1NUT1JFLAogICAgICAgICAgW10sIGZ1bmN0aW9uICh0eCwgcmVzdWx0KSB7CiAgICAgICAgICB2YXIgZGJWZXJzaW9uID0gcmVzdWx0LnJvd3MuaXRlbSgwKS5kYl92ZXJzaW9uOwogICAgICAgICAgb25HZXRWZXJzaW9uKHR4LCBkYlZlcnNpb24pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9CgogIGlmICh1dGlscy5pc0NvcmRvdmEoKSkgewogICAgLy90byB3YWl0IHVudGlsIGN1c3RvbSBhcGkgaXMgbWFkZSBpbiBwb3VjaC5hZGFwdGVycyBiZWZvcmUgZG9pbmcgc2V0dXAKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKGFwaS5fbmFtZSArICdfcG91Y2gnLCBmdW5jdGlvbiBjb3Jkb3ZhX2luaXQoKSB7CiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKGFwaS5fbmFtZSArICdfcG91Y2gnLCBjb3Jkb3ZhX2luaXQsIGZhbHNlKTsKICAgICAgc2V0dXAoKTsKICAgIH0sIGZhbHNlKTsKICB9IGVsc2UgewogICAgc2V0dXAoKTsKICB9CgogIGFwaS50eXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuICd3ZWJzcWwnOwogIH07CgogIGFwaS5faWQgPSB1dGlscy50b1Byb21pc2UoZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICBjYWxsYmFjayhudWxsLCBpbnN0YW5jZUlkKTsKICB9KTsKCiAgYXBpLl9pbmZvID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICBkYi5yZWFkVHJhbnNhY3Rpb24oZnVuY3Rpb24gKHR4KSB7CiAgICAgIGNvdW50RG9jcyh0eCwgZnVuY3Rpb24gKGRvY0NvdW50KSB7CiAgICAgICAgdmFyIHNxbCA9ICdTRUxFQ1QgTUFYKHNlcSkgQVMgc2VxIEZST00gJyArIEJZX1NFUV9TVE9SRTsKICAgICAgICB0eC5leGVjdXRlU3FsKHNxbCwgW10sIGZ1bmN0aW9uICh0eCwgcmVzKSB7CiAgICAgICAgICB2YXIgdXBkYXRlU2VxID0gcmVzLnJvd3MuaXRlbSgwKS5zZXEgfHwgMDsKICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHsKICAgICAgICAgICAgZG9jX2NvdW50OiBkb2NDb3VudCwKICAgICAgICAgICAgdXBkYXRlX3NlcTogdXBkYXRlU2VxLAogICAgICAgICAgICAvLyBmb3IgZGVidWdnaW5nCiAgICAgICAgICAgIHNxbGl0ZV9wbHVnaW46IGRiLl9zcWxpdGVQbHVnaW4sCiAgICAgICAgICAgIHdlYnNxbF9lbmNvZGluZzogZW5jb2RpbmcKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sIHdlYnNxbEVycm9yKGNhbGxiYWNrKSk7CiAgfTsKCiAgYXBpLl9idWxrRG9jcyA9IGZ1bmN0aW9uIChyZXEsIG9wdHMsIGNhbGxiYWNrKSB7CiAgICB3ZWJzcWxCdWxrRG9jcyhyZXEsIG9wdHMsIGFwaSwgZGIsIFdlYlNxbFBvdWNoLkNoYW5nZXMsIGNhbGxiYWNrKTsKICB9OwoKICBhcGkuX2dldCA9IGZ1bmN0aW9uIChpZCwgb3B0cywgY2FsbGJhY2spIHsKICAgIHZhciBkb2M7CiAgICB2YXIgbWV0YWRhdGE7CiAgICB2YXIgZXJyOwogICAgdmFyIHR4ID0gb3B0cy5jdHg7CiAgICBpZiAoIXR4KSB7CiAgICAgIHJldHVybiBkYi5yZWFkVHJhbnNhY3Rpb24oZnVuY3Rpb24gKHR4bikgewogICAgICAgIGFwaS5fZ2V0KGlkLCB1dGlscy5leHRlbmQoe2N0eDogdHhufSwgb3B0cyksIGNhbGxiYWNrKTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gZmluaXNoKCkgewogICAgICBjYWxsYmFjayhlcnIsIHtkb2M6IGRvYywgbWV0YWRhdGE6IG1ldGFkYXRhLCBjdHg6IHR4fSk7CiAgICB9CgogICAgdmFyIHNxbDsKICAgIHZhciBzcWxBcmdzOwogICAgaWYgKG9wdHMucmV2KSB7CiAgICAgIHNxbCA9IHNlbGVjdCgKICAgICAgICBTRUxFQ1RfRE9DUywKICAgICAgICBbRE9DX1NUT1JFLCBCWV9TRVFfU1RPUkVdLAogICAgICAgIERPQ19TVE9SRSArICcuaWQ9JyArIEJZX1NFUV9TVE9SRSArICcuZG9jX2lkJywKICAgICAgICBbQllfU0VRX1NUT1JFICsgJy5kb2NfaWQ9PycsIEJZX1NFUV9TVE9SRSArICcucmV2PT8nXSk7CiAgICAgIHNxbEFyZ3MgPSBbaWQsIG9wdHMucmV2XTsKICAgIH0gZWxzZSB7CiAgICAgIHNxbCA9IHNlbGVjdCgKICAgICAgICBTRUxFQ1RfRE9DUywKICAgICAgICBbRE9DX1NUT1JFLCBCWV9TRVFfU1RPUkVdLAogICAgICAgIERPQ19TVE9SRV9BTkRfQllfU0VRX0pPSU5FUiwKICAgICAgICBET0NfU1RPUkUgKyAnLmlkPT8nKTsKICAgICAgc3FsQXJncyA9IFtpZF07CiAgICB9CiAgICB0eC5leGVjdXRlU3FsKHNxbCwgc3FsQXJncywgZnVuY3Rpb24gKGEsIHJlc3VsdHMpIHsKICAgICAgaWYgKCFyZXN1bHRzLnJvd3MubGVuZ3RoKSB7CiAgICAgICAgZXJyID0gZXJyb3JzLmVycm9yKGVycm9ycy5NSVNTSU5HX0RPQywgJ21pc3NpbmcnKTsKICAgICAgICByZXR1cm4gZmluaXNoKCk7CiAgICAgIH0KICAgICAgdmFyIGl0ZW0gPSByZXN1bHRzLnJvd3MuaXRlbSgwKTsKICAgICAgbWV0YWRhdGEgPSB1dGlscy5zYWZlSnNvblBhcnNlKGl0ZW0ubWV0YWRhdGEpOwogICAgICBpZiAoaXRlbS5kZWxldGVkICYmICFvcHRzLnJldikgewogICAgICAgIGVyciA9IGVycm9ycy5lcnJvcihlcnJvcnMuTUlTU0lOR19ET0MsICdkZWxldGVkJyk7CiAgICAgICAgcmV0dXJuIGZpbmlzaCgpOwogICAgICB9CiAgICAgIGRvYyA9IHVuc3RyaW5naWZ5RG9jKGl0ZW0uZGF0YSwgbWV0YWRhdGEuaWQsIGl0ZW0ucmV2KTsKICAgICAgZmluaXNoKCk7CiAgICB9KTsKICB9OwoKICBmdW5jdGlvbiBjb3VudERvY3ModHgsIGNhbGxiYWNrKSB7CgogICAgaWYgKGFwaS5fZG9jQ291bnQgIT09IC0xKSB7CiAgICAgIHJldHVybiBjYWxsYmFjayhhcGkuX2RvY0NvdW50KTsKICAgIH0KCiAgICAvLyBjb3VudCB0aGUgdG90YWwgcm93cwogICAgdmFyIHNxbCA9IHNlbGVjdCgKICAgICAgJ0NPVU5UKCcgKyBET0NfU1RPUkUgKyAnLmlkKSBBUyBcJ251bVwnJywKICAgICAgW0RPQ19TVE9SRSwgQllfU0VRX1NUT1JFXSwKICAgICAgRE9DX1NUT1JFX0FORF9CWV9TRVFfSk9JTkVSLAogICAgICBCWV9TRVFfU1RPUkUgKyAnLmRlbGV0ZWQ9MCcpOwoKICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBbXSwgZnVuY3Rpb24gKHR4LCByZXN1bHQpIHsKICAgICAgYXBpLl9kb2NDb3VudCA9IHJlc3VsdC5yb3dzLml0ZW0oMCkubnVtOwogICAgICBjYWxsYmFjayhhcGkuX2RvY0NvdW50KTsKICAgIH0pOwogIH0KCiAgYXBpLl9hbGxEb2NzID0gZnVuY3Rpb24gKG9wdHMsIGNhbGxiYWNrKSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIHRvdGFsUm93czsKCiAgICB2YXIgc3RhcnQgPSAnc3RhcnRrZXknIGluIG9wdHMgPyBvcHRzLnN0YXJ0a2V5IDogZmFsc2U7CiAgICB2YXIgZW5kID0gJ2VuZGtleScgaW4gb3B0cyA/IG9wdHMuZW5ka2V5IDogZmFsc2U7CiAgICB2YXIga2V5ID0gJ2tleScgaW4gb3B0cyA/IG9wdHMua2V5IDogZmFsc2U7CiAgICB2YXIgZGVzY2VuZGluZyA9ICdkZXNjZW5kaW5nJyBpbiBvcHRzID8gb3B0cy5kZXNjZW5kaW5nIDogZmFsc2U7CiAgICB2YXIgbGltaXQgPSAnbGltaXQnIGluIG9wdHMgPyBvcHRzLmxpbWl0IDogLTE7CiAgICB2YXIgb2Zmc2V0ID0gJ3NraXAnIGluIG9wdHMgPyBvcHRzLnNraXAgOiAwOwogICAgdmFyIGluY2x1c2l2ZUVuZCA9IG9wdHMuaW5jbHVzaXZlX2VuZCAhPT0gZmFsc2U7CgogICAgdmFyIHNxbEFyZ3MgPSBbXTsKICAgIHZhciBjcml0ZXJpYSA9IFtdOwoKICAgIGlmIChrZXkgIT09IGZhbHNlKSB7CiAgICAgIGNyaXRlcmlhLnB1c2goRE9DX1NUT1JFICsgJy5pZCA9ID8nKTsKICAgICAgc3FsQXJncy5wdXNoKGtleSk7CiAgICB9IGVsc2UgaWYgKHN0YXJ0ICE9PSBmYWxzZSB8fCBlbmQgIT09IGZhbHNlKSB7CiAgICAgIGlmIChzdGFydCAhPT0gZmFsc2UpIHsKICAgICAgICBjcml0ZXJpYS5wdXNoKERPQ19TVE9SRSArICcuaWQgJyArIChkZXNjZW5kaW5nID8gJzw9JyA6ICc+PScpICsgJyA/Jyk7CiAgICAgICAgc3FsQXJncy5wdXNoKHN0YXJ0KTsKICAgICAgfQogICAgICBpZiAoZW5kICE9PSBmYWxzZSkgewogICAgICAgIHZhciBjb21wYXJhdG9yID0gZGVzY2VuZGluZyA/ICc+JyA6ICc8JzsKICAgICAgICBpZiAoaW5jbHVzaXZlRW5kKSB7CiAgICAgICAgICBjb21wYXJhdG9yICs9ICc9JzsKICAgICAgICB9CiAgICAgICAgY3JpdGVyaWEucHVzaChET0NfU1RPUkUgKyAnLmlkICcgKyBjb21wYXJhdG9yICsgJyA/Jyk7CiAgICAgICAgc3FsQXJncy5wdXNoKGVuZCk7CiAgICAgIH0KICAgICAgaWYgKGtleSAhPT0gZmFsc2UpIHsKICAgICAgICBjcml0ZXJpYS5wdXNoKERPQ19TVE9SRSArICcuaWQgPSA/Jyk7CiAgICAgICAgc3FsQXJncy5wdXNoKGtleSk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAob3B0cy5kZWxldGVkICE9PSAnb2snKSB7CiAgICAgIC8vIHJlcG9ydCBkZWxldGVkIGlmIGtleXMgYXJlIHNwZWNpZmllZAogICAgICBjcml0ZXJpYS5wdXNoKEJZX1NFUV9TVE9SRSArICcuZGVsZXRlZCA9IDAnKTsKICAgIH0KCiAgICBkYi5yZWFkVHJhbnNhY3Rpb24oZnVuY3Rpb24gKHR4KSB7CgogICAgICAvLyBmaXJzdCBjb3VudCB1cCB0aGUgdG90YWwgcm93cwogICAgICBjb3VudERvY3ModHgsIGZ1bmN0aW9uIChjb3VudCkgewogICAgICAgIHRvdGFsUm93cyA9IGNvdW50OwoKICAgICAgICBpZiAobGltaXQgPT09IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIHRoZW4gYWN0dWFsbHkgZmV0Y2ggdGhlIGRvY3VtZW50cwogICAgICAgIHZhciBzcWwgPSBzZWxlY3QoCiAgICAgICAgICBTRUxFQ1RfRE9DUywKICAgICAgICAgIFtET0NfU1RPUkUsIEJZX1NFUV9TVE9SRV0sCiAgICAgICAgICBET0NfU1RPUkVfQU5EX0JZX1NFUV9KT0lORVIsCiAgICAgICAgICBjcml0ZXJpYSwKICAgICAgICAgIERPQ19TVE9SRSArICcuaWQgJyArIChkZXNjZW5kaW5nID8gJ0RFU0MnIDogJ0FTQycpCiAgICAgICAgICApOwogICAgICAgIHNxbCArPSAnIExJTUlUICcgKyBsaW1pdCArICcgT0ZGU0VUICcgKyBvZmZzZXQ7CgogICAgICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBzcWxBcmdzLCBmdW5jdGlvbiAodHgsIHJlc3VsdCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSByZXN1bHQucm93cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSByZXN1bHQucm93cy5pdGVtKGkpOwogICAgICAgICAgICB2YXIgbWV0YWRhdGEgPSB1dGlscy5zYWZlSnNvblBhcnNlKGl0ZW0ubWV0YWRhdGEpOwogICAgICAgICAgICB2YXIgaWQgPSBtZXRhZGF0YS5pZDsKICAgICAgICAgICAgdmFyIGRhdGEgPSB1bnN0cmluZ2lmeURvYyhpdGVtLmRhdGEsIGlkLCBpdGVtLnJldik7CiAgICAgICAgICAgIHZhciB3aW5uaW5nUmV2ID0gZGF0YS5fcmV2OwogICAgICAgICAgICB2YXIgZG9jID0gewogICAgICAgICAgICAgIGlkOiBpZCwKICAgICAgICAgICAgICBrZXk6IGlkLAogICAgICAgICAgICAgIHZhbHVlOiB7cmV2OiB3aW5uaW5nUmV2fQogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAob3B0cy5pbmNsdWRlX2RvY3MpIHsKICAgICAgICAgICAgICBkb2MuZG9jID0gZGF0YTsKICAgICAgICAgICAgICBkb2MuZG9jLl9yZXYgPSB3aW5uaW5nUmV2OwogICAgICAgICAgICAgIGlmIChvcHRzLmNvbmZsaWN0cykgewogICAgICAgICAgICAgICAgZG9jLmRvYy5fY29uZmxpY3RzID0gY29sbGVjdENvbmZsaWN0cyhtZXRhZGF0YSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZldGNoQXR0YWNobWVudHNJZk5lY2Vzc2FyeShkb2MuZG9jLCBvcHRzLCBhcGksIHR4KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXRlbS5kZWxldGVkKSB7CiAgICAgICAgICAgICAgaWYgKG9wdHMuZGVsZXRlZCA9PT0gJ29rJykgewogICAgICAgICAgICAgICAgZG9jLnZhbHVlLmRlbGV0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgZG9jLmRvYyA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHRzLnB1c2goZG9jKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LCB3ZWJzcWxFcnJvcihjYWxsYmFjayksIGZ1bmN0aW9uICgpIHsKICAgICAgY2FsbGJhY2sobnVsbCwgewogICAgICAgIHRvdGFsX3Jvd3M6IHRvdGFsUm93cywKICAgICAgICBvZmZzZXQ6IG9wdHMuc2tpcCwKICAgICAgICByb3dzOiByZXN1bHRzCiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgYXBpLl9jaGFuZ2VzID0gZnVuY3Rpb24gKG9wdHMpIHsKICAgIG9wdHMgPSB1dGlscy5jbG9uZShvcHRzKTsKCiAgICBpZiAob3B0cy5jb250aW51b3VzKSB7CiAgICAgIHZhciBpZCA9IGFwaS5fbmFtZSArICc6JyArIHV0aWxzLnV1aWQoKTsKICAgICAgV2ViU3FsUG91Y2guQ2hhbmdlcy5hZGRMaXN0ZW5lcihhcGkuX25hbWUsIGlkLCBhcGksIG9wdHMpOwogICAgICBXZWJTcWxQb3VjaC5DaGFuZ2VzLm5vdGlmeShhcGkuX25hbWUpOwogICAgICByZXR1cm4gewogICAgICAgIGNhbmNlbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgV2ViU3FsUG91Y2guQ2hhbmdlcy5yZW1vdmVMaXN0ZW5lcihhcGkuX25hbWUsIGlkKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CgogICAgdmFyIGRlc2NlbmRpbmcgPSBvcHRzLmRlc2NlbmRpbmc7CgogICAgLy8gSWdub3JlIHRoZSBgc2luY2VgIHBhcmFtZXRlciB3aGVuIGBkZXNjZW5kaW5nYCBpcyB0cnVlCiAgICBvcHRzLnNpbmNlID0gb3B0cy5zaW5jZSAmJiAhZGVzY2VuZGluZyA/IG9wdHMuc2luY2UgOiAwOwoKICAgIHZhciBsaW1pdCA9ICdsaW1pdCcgaW4gb3B0cyA/IG9wdHMubGltaXQgOiAtMTsKICAgIGlmIChsaW1pdCA9PT0gMCkgewogICAgICBsaW1pdCA9IDE7IC8vIHBlciBDb3VjaERCIF9jaGFuZ2VzIHNwZWMKICAgIH0KCiAgICB2YXIgcmV0dXJuRG9jczsKICAgIGlmICgncmV0dXJuRG9jcycgaW4gb3B0cykgewogICAgICByZXR1cm5Eb2NzID0gb3B0cy5yZXR1cm5Eb2NzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuRG9jcyA9IHRydWU7CiAgICB9CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIG51bVJlc3VsdHMgPSAwOwoKICAgIGZ1bmN0aW9uIGZldGNoQ2hhbmdlcygpIHsKCiAgICAgIHZhciBzZWxlY3RTdG10ID0KICAgICAgICBET0NfU1RPUkUgKyAnLmpzb24gQVMgbWV0YWRhdGEsICcgKwogICAgICAgIERPQ19TVE9SRSArICcubWF4X3NlcSBBUyBtYXhTZXEsICcgKwogICAgICAgIEJZX1NFUV9TVE9SRSArICcuanNvbiBBUyB3aW5uaW5nRG9jLCAnICsKICAgICAgICBCWV9TRVFfU1RPUkUgKyAnLnJldiBBUyB3aW5uaW5nUmV2ICc7CgogICAgICB2YXIgZnJvbSA9IERPQ19TVE9SRSArICcgSk9JTiAnICsgQllfU0VRX1NUT1JFOwoKICAgICAgdmFyIGpvaW5lciA9IERPQ19TVE9SRSArICcuaWQ9JyArIEJZX1NFUV9TVE9SRSArICcuZG9jX2lkJyArCiAgICAgICAgJyBBTkQgJyArIERPQ19TVE9SRSArICcud2lubmluZ3NlcT0nICsgQllfU0VRX1NUT1JFICsgJy5zZXEnOwoKICAgICAgdmFyIGNyaXRlcmlhID0gWydtYXhTZXEgPiA/J107CiAgICAgIHZhciBzcWxBcmdzID0gW29wdHMuc2luY2VdOwoKICAgICAgaWYgKG9wdHMuZG9jX2lkcykgewogICAgICAgIGNyaXRlcmlhLnB1c2goRE9DX1NUT1JFICsgJy5pZCBJTiAnICsgcU1hcmtzKG9wdHMuZG9jX2lkcy5sZW5ndGgpKTsKICAgICAgICBzcWxBcmdzID0gc3FsQXJncy5jb25jYXQob3B0cy5kb2NfaWRzKTsKICAgICAgfQoKICAgICAgdmFyIG9yZGVyQnkgPSAnbWF4U2VxICcgKyAoZGVzY2VuZGluZyA/ICdERVNDJyA6ICdBU0MnKTsKCiAgICAgIHZhciBzcWwgPSBzZWxlY3Qoc2VsZWN0U3RtdCwgZnJvbSwgam9pbmVyLCBjcml0ZXJpYSwgb3JkZXJCeSk7CgogICAgICB2YXIgZmlsdGVyID0gdXRpbHMuZmlsdGVyQ2hhbmdlKG9wdHMpOwogICAgICBpZiAoIW9wdHMudmlldyAmJiAhb3B0cy5maWx0ZXIpIHsKICAgICAgICAvLyB3ZSBjYW4ganVzdCBsaW1pdCBpbiB0aGUgcXVlcnkKICAgICAgICBzcWwgKz0gJyBMSU1JVCAnICsgbGltaXQ7CiAgICAgIH0KCiAgICAgIHZhciBsYXN0U2VxID0gb3B0cy5zaW5jZSB8fCAwOwogICAgICBkYi5yZWFkVHJhbnNhY3Rpb24oZnVuY3Rpb24gKHR4KSB7CiAgICAgICAgdHguZXhlY3V0ZVNxbChzcWwsIHNxbEFyZ3MsIGZ1bmN0aW9uICh0eCwgcmVzdWx0KSB7CiAgICAgICAgICBmdW5jdGlvbiByZXBvcnRDaGFuZ2UoY2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgb3B0cy5vbkNoYW5nZShjaGFuZ2UpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSByZXN1bHQucm93cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSByZXN1bHQucm93cy5pdGVtKGkpOwogICAgICAgICAgICB2YXIgbWV0YWRhdGEgPSB1dGlscy5zYWZlSnNvblBhcnNlKGl0ZW0ubWV0YWRhdGEpOwogICAgICAgICAgICBsYXN0U2VxID0gaXRlbS5tYXhTZXE7CgogICAgICAgICAgICB2YXIgZG9jID0gdW5zdHJpbmdpZnlEb2MoaXRlbS53aW5uaW5nRG9jLCBtZXRhZGF0YS5pZCwKICAgICAgICAgICAgICBpdGVtLndpbm5pbmdSZXYpOwogICAgICAgICAgICB2YXIgY2hhbmdlID0gb3B0cy5wcm9jZXNzQ2hhbmdlKGRvYywgbWV0YWRhdGEsIG9wdHMpOwogICAgICAgICAgICBjaGFuZ2Uuc2VxID0gaXRlbS5tYXhTZXE7CgogICAgICAgICAgICB2YXIgZmlsdGVyZWQgPSBmaWx0ZXIoY2hhbmdlKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmaWx0ZXJlZCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICByZXR1cm4gb3B0cy5jb21wbGV0ZShmaWx0ZXJlZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmaWx0ZXJlZCkgewogICAgICAgICAgICAgIG51bVJlc3VsdHMrKzsKICAgICAgICAgICAgICBpZiAocmV0dXJuRG9jcykgewogICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGNoYW5nZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIHByb2Nlc3MgdGhlIGF0dGFjaG1lbnQgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAvLyBmb3IgdGhlIGJlbmVmaXQgb2YgbGl2ZSBsaXN0ZW5lcnMKICAgICAgICAgICAgICBpZiAob3B0cy5hdHRhY2htZW50cyAmJiBvcHRzLmluY2x1ZGVfZG9jcykgewogICAgICAgICAgICAgICAgZmV0Y2hBdHRhY2htZW50c0lmTmVjZXNzYXJ5KGRvYywgb3B0cywgYXBpLCB0eCwKICAgICAgICAgICAgICAgICAgcmVwb3J0Q2hhbmdlKGNoYW5nZSkpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXBvcnRDaGFuZ2UoY2hhbmdlKSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobnVtUmVzdWx0cyA9PT0gbGltaXQpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9LCB3ZWJzcWxFcnJvcihvcHRzLmNvbXBsZXRlKSwgZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghb3B0cy5jb250aW51b3VzKSB7CiAgICAgICAgICBvcHRzLmNvbXBsZXRlKG51bGwsIHsKICAgICAgICAgICAgcmVzdWx0czogcmVzdWx0cywKICAgICAgICAgICAgbGFzdF9zZXE6IGxhc3RTZXEKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgZmV0Y2hDaGFuZ2VzKCk7CiAgfTsKCiAgYXBpLl9jbG9zZSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgLy9XZWJTUUwgZGF0YWJhc2VzIGRvIG5vdCBuZWVkIHRvIGJlIGNsb3NlZAogICAgY2FsbGJhY2soKTsKICB9OwoKICBhcGkuX2dldEF0dGFjaG1lbnQgPSBmdW5jdGlvbiAoYXR0YWNobWVudCwgb3B0cywgY2FsbGJhY2spIHsKICAgIHZhciByZXM7CiAgICB2YXIgdHggPSBvcHRzLmN0eDsKICAgIHZhciBkaWdlc3QgPSBhdHRhY2htZW50LmRpZ2VzdDsKICAgIHZhciB0eXBlID0gYXR0YWNobWVudC5jb250ZW50X3R5cGU7CiAgICB2YXIgc3FsID0gJ1NFTEVDVCBlc2NhcGVkLCAnICsKICAgICAgJ0NBU0UgV0hFTiBlc2NhcGVkID0gMSBUSEVOIGJvZHkgRUxTRSBIRVgoYm9keSkgRU5EIEFTIGJvZHkgRlJPTSAnICsKICAgICAgQVRUQUNIX1NUT1JFICsgJyBXSEVSRSBkaWdlc3Q9Pyc7CiAgICB0eC5leGVjdXRlU3FsKHNxbCwgW2RpZ2VzdF0sIGZ1bmN0aW9uICh0eCwgcmVzdWx0KSB7CiAgICAgIC8vIHdlYnNxbCBoYXMgYSBidWcgd2hlcmUgXHUwMDAwIGNhdXNlcyBlYXJseSB0cnVuY2F0aW9uIGluIHN0cmluZ3MKICAgICAgLy8gYW5kIGJsb2JzLiB0byB3b3JrIGFyb3VuZCB0aGlzLCB3ZSB1c2VkIHRvIHVzZSB0aGUgaGV4KCkgZnVuY3Rpb24sCiAgICAgIC8vIGJ1dCB0aGF0J3Mgbm90IHBlcmZvcm1hbnQuIGFmdGVyIG1pZ3JhdGlvbiA2LCB3ZSByZW1vdmUgXHUwMDAwCiAgICAgIC8vIGFuZCBhZGQgaXQgYmFjayBpbiBhZnRlcndhcmRzCiAgICAgIHZhciBpdGVtID0gcmVzdWx0LnJvd3MuaXRlbSgwKTsKICAgICAgdmFyIGRhdGEgPSBpdGVtLmVzY2FwZWQgPyB3ZWJzcWxVdGlscy51bmVzY2FwZUJsb2IoaXRlbS5ib2R5KSA6CiAgICAgICAgcGFyc2VIZXhTdHJpbmcoaXRlbS5ib2R5LCBlbmNvZGluZyk7CiAgICAgIGlmIChvcHRzLmJpbmFyeSkgewogICAgICAgIHJlcyA9IGJpblN0cmluZ1RvQmxvYihkYXRhLCB0eXBlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXMgPSB1dGlscy5idG9hKGRhdGEpOwogICAgICB9CiAgICAgIGNhbGxiYWNrKG51bGwsIHJlcyk7CiAgICB9KTsKICB9OwoKICBhcGkuX2dldFJldmlzaW9uVHJlZSA9IGZ1bmN0aW9uIChkb2NJZCwgY2FsbGJhY2spIHsKICAgIGRiLnJlYWRUcmFuc2FjdGlvbihmdW5jdGlvbiAodHgpIHsKICAgICAgdmFyIHNxbCA9ICdTRUxFQ1QganNvbiBBUyBtZXRhZGF0YSBGUk9NICcgKyBET0NfU1RPUkUgKyAnIFdIRVJFIGlkID0gPyc7CiAgICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBbZG9jSWRdLCBmdW5jdGlvbiAodHgsIHJlc3VsdCkgewogICAgICAgIGlmICghcmVzdWx0LnJvd3MubGVuZ3RoKSB7CiAgICAgICAgICBjYWxsYmFjayhlcnJvcnMuZXJyb3IoZXJyb3JzLk1JU1NJTkdfRE9DKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBkYXRhID0gdXRpbHMuc2FmZUpzb25QYXJzZShyZXN1bHQucm93cy5pdGVtKDApLm1ldGFkYXRhKTsKICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGRhdGEucmV2X3RyZWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBhcGkuX2RvQ29tcGFjdGlvbiA9IGZ1bmN0aW9uIChkb2NJZCwgcmV2cywgY2FsbGJhY2spIHsKICAgIGlmICghcmV2cy5sZW5ndGgpIHsKICAgICAgcmV0dXJuIGNhbGxiYWNrKCk7CiAgICB9CiAgICBkYi50cmFuc2FjdGlvbihmdW5jdGlvbiAodHgpIHsKCiAgICAgIC8vIHVwZGF0ZSBkb2Mgc3RvcmUKICAgICAgdmFyIHNxbCA9ICdTRUxFQ1QganNvbiBBUyBtZXRhZGF0YSBGUk9NICcgKyBET0NfU1RPUkUgKyAnIFdIRVJFIGlkID0gPyc7CiAgICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBbZG9jSWRdLCBmdW5jdGlvbiAodHgsIHJlc3VsdCkgewogICAgICAgIHZhciBtZXRhZGF0YSA9IHV0aWxzLnNhZmVKc29uUGFyc2UocmVzdWx0LnJvd3MuaXRlbSgwKS5tZXRhZGF0YSk7CiAgICAgICAgdHJhdmVyc2VSZXZUcmVlKG1ldGFkYXRhLnJldl90cmVlLCBmdW5jdGlvbiAoaXNMZWFmLCBwb3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV2SGFzaCwgY3R4LCBvcHRzKSB7CiAgICAgICAgICB2YXIgcmV2ID0gcG9zICsgJy0nICsgcmV2SGFzaDsKICAgICAgICAgIGlmIChyZXZzLmluZGV4T2YocmV2KSAhPT0gLTEpIHsKICAgICAgICAgICAgb3B0cy5zdGF0dXMgPSAnbWlzc2luZyc7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHZhciBzcWwgPSAnVVBEQVRFICcgKyBET0NfU1RPUkUgKyAnIFNFVCBqc29uID0gPyBXSEVSRSBpZCA9ID8nOwogICAgICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBbdXRpbHMuc2FmZUpzb25TdHJpbmdpZnkobWV0YWRhdGEpLCBkb2NJZF0pOwogICAgICB9KTsKCiAgICAgIGNvbXBhY3RSZXZzKHJldnMsIGRvY0lkLCB0eCk7CiAgICB9LCB3ZWJzcWxFcnJvcihjYWxsYmFjayksIGZ1bmN0aW9uICgpIHsKICAgICAgY2FsbGJhY2soKTsKICAgIH0pOwogIH07CgogIGFwaS5fZ2V0TG9jYWwgPSBmdW5jdGlvbiAoaWQsIGNhbGxiYWNrKSB7CiAgICBkYi5yZWFkVHJhbnNhY3Rpb24oZnVuY3Rpb24gKHR4KSB7CiAgICAgIHZhciBzcWwgPSAnU0VMRUNUIGpzb24sIHJldiBGUk9NICcgKyBMT0NBTF9TVE9SRSArICcgV0hFUkUgaWQ9Pyc7CiAgICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCBbaWRdLCBmdW5jdGlvbiAodHgsIHJlcykgewogICAgICAgIGlmIChyZXMucm93cy5sZW5ndGgpIHsKICAgICAgICAgIHZhciBpdGVtID0gcmVzLnJvd3MuaXRlbSgwKTsKICAgICAgICAgIHZhciBkb2MgPSB1bnN0cmluZ2lmeURvYyhpdGVtLmpzb24sIGlkLCBpdGVtLnJldik7CiAgICAgICAgICBjYWxsYmFjayhudWxsLCBkb2MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjYWxsYmFjayhlcnJvcnMuZXJyb3IoZXJyb3JzLk1JU1NJTkdfRE9DKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIGFwaS5fcHV0TG9jYWwgPSBmdW5jdGlvbiAoZG9jLCBvcHRzLCBjYWxsYmFjaykgewogICAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNhbGxiYWNrID0gb3B0czsKICAgICAgb3B0cyA9IHt9OwogICAgfQogICAgZGVsZXRlIGRvYy5fcmV2aXNpb25zOyAvLyBpZ25vcmUgdGhpcywgdHJ1c3QgdGhlIHJldgogICAgdmFyIG9sZFJldiA9IGRvYy5fcmV2OwogICAgdmFyIGlkID0gZG9jLl9pZDsKICAgIHZhciBuZXdSZXY7CiAgICBpZiAoIW9sZFJldikgewogICAgICBuZXdSZXYgPSBkb2MuX3JldiA9ICcwLTEnOwogICAgfSBlbHNlIHsKICAgICAgbmV3UmV2ID0gZG9jLl9yZXYgPSAnMC0nICsgKHBhcnNlSW50KG9sZFJldi5zcGxpdCgnLScpWzFdLCAxMCkgKyAxKTsKICAgIH0KICAgIHZhciBqc29uID0gc3RyaW5naWZ5RG9jKGRvYyk7CgogICAgdmFyIHJldDsKICAgIGZ1bmN0aW9uIHB1dExvY2FsKHR4KSB7CiAgICAgIHZhciBzcWw7CiAgICAgIHZhciB2YWx1ZXM7CiAgICAgIGlmIChvbGRSZXYpIHsKICAgICAgICBzcWwgPSAnVVBEQVRFICcgKyBMT0NBTF9TVE9SRSArICcgU0VUIHJldj0/LCBqc29uPT8gJyArCiAgICAgICAgICAnV0hFUkUgaWQ9PyBBTkQgcmV2PT8nOwogICAgICAgIHZhbHVlcyA9IFtuZXdSZXYsIGpzb24sIGlkLCBvbGRSZXZdOwogICAgICB9IGVsc2UgewogICAgICAgIHNxbCA9ICdJTlNFUlQgSU5UTyAnICsgTE9DQUxfU1RPUkUgKyAnIChpZCwgcmV2LCBqc29uKSBWQUxVRVMgKD8sPyw/KSc7CiAgICAgICAgdmFsdWVzID0gW2lkLCBuZXdSZXYsIGpzb25dOwogICAgICB9CiAgICAgIHR4LmV4ZWN1dGVTcWwoc3FsLCB2YWx1ZXMsIGZ1bmN0aW9uICh0eCwgcmVzKSB7CiAgICAgICAgaWYgKHJlcy5yb3dzQWZmZWN0ZWQpIHsKICAgICAgICAgIHJldCA9IHtvazogdHJ1ZSwgaWQ6IGlkLCByZXY6IG5ld1Jldn07CiAgICAgICAgICBpZiAob3B0cy5jdHgpIHsgLy8gcmV0dXJuIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHJldCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNhbGxiYWNrKGVycm9ycy5lcnJvcihlcnJvcnMuUkVWX0NPTkZMSUNUKSk7CiAgICAgICAgfQogICAgICB9LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgY2FsbGJhY2soZXJyb3JzLmVycm9yKGVycm9ycy5SRVZfQ09ORkxJQ1QpKTsKICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGFjayB0aGF0IHdlIGhhbmRsZWQgdGhlIGVycm9yCiAgICAgIH0pOwogICAgfQoKICAgIGlmIChvcHRzLmN0eCkgewogICAgICBwdXRMb2NhbChvcHRzLmN0eCk7CiAgICB9IGVsc2UgewogICAgICBkYi50cmFuc2FjdGlvbihwdXRMb2NhbCwgd2Vic3FsRXJyb3IoY2FsbGJhY2spLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHJldCkgewogICAgICAgICAgY2FsbGJhY2sobnVsbCwgcmV0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIGFwaS5fcmVtb3ZlTG9jYWwgPSBmdW5jdGlvbiAoZG9jLCBvcHRzLCBjYWxsYmFjaykgewogICAgaWYgKHR5cGVvZiBvcHRzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNhbGxiYWNrID0gb3B0czsKICAgICAgb3B0cyA9IHt9OwogICAgfQogICAgdmFyIHJldDsKCiAgICBmdW5jdGlvbiByZW1vdmVMb2NhbCh0eCkgewogICAgICB2YXIgc3FsID0gJ0RFTEVURSBGUk9NICcgKyBMT0NBTF9TVE9SRSArICcgV0hFUkUgaWQ9PyBBTkQgcmV2PT8nOwogICAgICB2YXIgcGFyYW1zID0gW2RvYy5faWQsIGRvYy5fcmV2XTsKICAgICAgdHguZXhlY3V0ZVNxbChzcWwsIHBhcmFtcywgZnVuY3Rpb24gKHR4LCByZXMpIHsKICAgICAgICBpZiAoIXJlcy5yb3dzQWZmZWN0ZWQpIHsKICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnJvcnMuZXJyb3IoZXJyb3JzLk1JU1NJTkdfRE9DKSk7CiAgICAgICAgfQogICAgICAgIHJldCA9IHtvazogdHJ1ZSwgaWQ6IGRvYy5faWQsIHJldjogJzAtMCd9OwogICAgICAgIGlmIChvcHRzLmN0eCkgeyAvLyByZXR1cm4gaW1tZWRpYXRlbHkKICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHJldCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBpZiAob3B0cy5jdHgpIHsKICAgICAgcmVtb3ZlTG9jYWwob3B0cy5jdHgpOwogICAgfSBlbHNlIHsKICAgICAgZGIudHJhbnNhY3Rpb24ocmVtb3ZlTG9jYWwsIHdlYnNxbEVycm9yKGNhbGxiYWNrKSwgZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChyZXQpIHsKICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHJldCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICBhcGkuX2Rlc3Ryb3kgPSBmdW5jdGlvbiAob3B0cywgY2FsbGJhY2spIHsKICAgIFdlYlNxbFBvdWNoLkNoYW5nZXMucmVtb3ZlQWxsTGlzdGVuZXJzKGFwaS5fbmFtZSk7CiAgICBkYi50cmFuc2FjdGlvbihmdW5jdGlvbiAodHgpIHsKICAgICAgdmFyIHN0b3JlcyA9IFtET0NfU1RPUkUsIEJZX1NFUV9TVE9SRSwgQVRUQUNIX1NUT1JFLCBNRVRBX1NUT1JFLAogICAgICAgIExPQ0FMX1NUT1JFLCBBVFRBQ0hfQU5EX1NFUV9TVE9SRV07CiAgICAgIHN0b3Jlcy5mb3JFYWNoKGZ1bmN0aW9uIChzdG9yZSkgewogICAgICAgIHR4LmV4ZWN1dGVTcWwoJ0RST1AgVEFCTEUgSUYgRVhJU1RTICcgKyBzdG9yZSwgW10pOwogICAgICB9KTsKICAgIH0sIHdlYnNxbEVycm9yKGNhbGxiYWNrKSwgZnVuY3Rpb24gKCkgewogICAgICBpZiAoaGFzTG9jYWxTdG9yYWdlKCkpIHsKICAgICAgICBkZWxldGUgd2luZG93LmxvY2FsU3RvcmFnZVsnX3BvdWNoX193ZWJzcWxkYl8nICsgYXBpLl9uYW1lXTsKICAgICAgICBkZWxldGUgd2luZG93LmxvY2FsU3RvcmFnZVthcGkuX25hbWVdOwogICAgICB9CiAgICAgIGNhbGxiYWNrKG51bGwsIHsnb2snOiB0cnVlfSk7CiAgICB9KTsKICB9Owp9CgpXZWJTcWxQb3VjaC52YWxpZCA9IHdlYnNxbFV0aWxzLnZhbGlkOwoKV2ViU3FsUG91Y2guQ2hhbmdlcyA9IG5ldyB1dGlscy5DaGFuZ2VzKCk7Cgptb2R1bGUuZXhwb3J0cyA9IFdlYlNxbFBvdWNoOwoKfSx7Ii4uLy4uL2RlcHMvYmluYXJ5L2JpbmFyeVN0cmluZ1RvQmxvYk9yQnVmZmVyIjo0NCwiLi4vLi4vZGVwcy9kb2NzL2lzRGVsZXRlZCI6NTQsIi4uLy4uL2RlcHMvZG9jcy9pc0xvY2FsSWQiOjU1LCIuLi8uLi9kZXBzL2Vudi9oYXNMb2NhbFN0b3JhZ2UiOjYyLCIuLi8uLi9kZXBzL2Vycm9ycyI6NjQsIi4uLy4uL2RlcHMvbWVyZ2UvY29sbGVjdENvbmZsaWN0cyI6NjgsIi4uLy4uL2RlcHMvbWVyZ2UvdHJhdmVyc2VSZXZUcmVlIjo3MywiLi4vLi4vZGVwcy9wYXJzZUhleCI6NzYsIi4uLy4uL3V0aWxzIjoxMDIsIi4vYnVsa0RvY3MiOjIzLCIuL2NvbnN0YW50cyI6MjQsIi4vdXRpbHMiOjI2fV0sMjY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgdXRpbHMgPSByZXF1aXJlKCcuLi8uLi91dGlscycpOwp2YXIgZXJyb3JzID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9lcnJvcnMnKTsKCnZhciB3ZWJzcWxDb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpOwoKdmFyIEJZX1NFUV9TVE9SRSA9IHdlYnNxbENvbnN0YW50cy5CWV9TRVFfU1RPUkU7CnZhciBBVFRBQ0hfU1RPUkUgPSB3ZWJzcWxDb25zdGFudHMuQVRUQUNIX1NUT1JFOwp2YXIgQVRUQUNIX0FORF9TRVFfU1RPUkUgPSB3ZWJzcWxDb25zdGFudHMuQVRUQUNIX0FORF9TRVFfU1RPUkU7CgovLyBlc2NhcGVCbG9iIGFuZCB1bmVzY2FwZUJsb2IgYXJlIHdvcmthcm91bmRzIGZvciBhIHdlYnNxbCBidWc6Ci8vIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD00MjI2OTAKLy8gaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTEzNzYzNwovLyBUaGUgZ29hbCBpcyB0byBuZXZlciBhY3R1YWxseSBpbnNlcnQgdGhlIFx1MDAwMCBjaGFyYWN0ZXIKLy8gaW4gdGhlIGRhdGFiYXNlLgpmdW5jdGlvbiBlc2NhcGVCbG9iKHN0cikgewogIHJldHVybiBzdHIKICAgIC5yZXBsYWNlKC9cdTAwMDIvZywgJ1x1MDAwMlx1MDAwMicpCiAgICAucmVwbGFjZSgvXHUwMDAxL2csICdcdTAwMDFcdTAwMDInKQogICAgLnJlcGxhY2UoL1x1MDAwMC9nLCAnXHUwMDAxXHUwMDAxJyk7Cn0KCmZ1bmN0aW9uIHVuZXNjYXBlQmxvYihzdHIpIHsKICByZXR1cm4gc3RyCiAgICAucmVwbGFjZSgvXHUwMDAxXHUwMDAxL2csICdcdTAwMDAnKQogICAgLnJlcGxhY2UoL1x1MDAwMVx1MDAwMi9nLCAnXHUwMDAxJykKICAgIC5yZXBsYWNlKC9cdTAwMDJcdTAwMDIvZywgJ1x1MDAwMicpOwp9CgpmdW5jdGlvbiBzdHJpbmdpZnlEb2MoZG9jKSB7CiAgLy8gZG9uJ3QgYm90aGVyIHN0b3JpbmcgdGhlIGlkL3Jldi4gaXQgdXNlcyBsb3RzIG9mIHNwYWNlLAogIC8vIGluIHBlcnNpc3RlbnQgbWFwL3JlZHVjZSBlc3BlY2lhbGx5CiAgZGVsZXRlIGRvYy5faWQ7CiAgZGVsZXRlIGRvYy5fcmV2OwogIHJldHVybiBKU09OLnN0cmluZ2lmeShkb2MpOwp9CgpmdW5jdGlvbiB1bnN0cmluZ2lmeURvYyhkb2MsIGlkLCByZXYpIHsKICBkb2MgPSBKU09OLnBhcnNlKGRvYyk7CiAgZG9jLl9pZCA9IGlkOwogIGRvYy5fcmV2ID0gcmV2OwogIHJldHVybiBkb2M7Cn0KCi8vIHF1ZXN0aW9uIG1hcmsgZ3JvdXBzIElOIHF1ZXJpZXMsIGUuZy4gMyAtPiAnKD8sPyw/KScKZnVuY3Rpb24gcU1hcmtzKG51bSkgewogIHZhciBzID0gJygnOwogIHdoaWxlIChudW0tLSkgewogICAgcyArPSAnPyc7CiAgICBpZiAobnVtKSB7CiAgICAgIHMgKz0gJywnOwogICAgfQogIH0KICByZXR1cm4gcyArICcpJzsKfQoKZnVuY3Rpb24gc2VsZWN0KHNlbGVjdG9yLCB0YWJsZSwgam9pbmVyLCB3aGVyZSwgb3JkZXJCeSkgewogIHJldHVybiAnU0VMRUNUICcgKyBzZWxlY3RvciArICcgRlJPTSAnICsKICAgICh0eXBlb2YgdGFibGUgPT09ICdzdHJpbmcnID8gdGFibGUgOiB0YWJsZS5qb2luKCcgSk9JTiAnKSkgKwogICAgKGpvaW5lciA/ICgnIE9OICcgKyBqb2luZXIpIDogJycpICsKICAgICh3aGVyZSA/ICgnIFdIRVJFICcgKwogICAgKHR5cGVvZiB3aGVyZSA9PT0gJ3N0cmluZycgPyB3aGVyZSA6IHdoZXJlLmpvaW4oJyBBTkQgJykpKSA6ICcnKSArCiAgICAob3JkZXJCeSA/ICgnIE9SREVSIEJZICcgKyBvcmRlckJ5KSA6ICcnKTsKfQoKZnVuY3Rpb24gY29tcGFjdFJldnMocmV2cywgZG9jSWQsIHR4KSB7CgogIGlmICghcmV2cy5sZW5ndGgpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBudW1Eb25lID0gMDsKICB2YXIgc2VxcyA9IFtdOwoKICBmdW5jdGlvbiBjaGVja0RvbmUoKSB7CiAgICBpZiAoKytudW1Eb25lID09PSByZXZzLmxlbmd0aCkgeyAvLyBkb25lCiAgICAgIGRlbGV0ZU9ycGhhbnMoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGRlbGV0ZU9ycGhhbnMoKSB7CiAgICAvLyBmaW5kIG9ycGhhbmVkIGF0dGFjaG1lbnQgZGlnZXN0cwoKICAgIGlmICghc2Vxcy5sZW5ndGgpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBzcWwgPSAnU0VMRUNUIERJU1RJTkNUIGRpZ2VzdCBBUyBkaWdlc3QgRlJPTSAnICsKICAgICAgQVRUQUNIX0FORF9TRVFfU1RPUkUgKyAnIFdIRVJFIHNlcSBJTiAnICsgcU1hcmtzKHNlcXMubGVuZ3RoKTsKCiAgICB0eC5leGVjdXRlU3FsKHNxbCwgc2VxcywgZnVuY3Rpb24gKHR4LCByZXMpIHsKCiAgICAgIHZhciBkaWdlc3RzVG9DaGVjayA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlcy5yb3dzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZGlnZXN0c1RvQ2hlY2sucHVzaChyZXMucm93cy5pdGVtKGkpLmRpZ2VzdCk7CiAgICAgIH0KICAgICAgaWYgKCFkaWdlc3RzVG9DaGVjay5sZW5ndGgpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBzcWwgPSAnREVMRVRFIEZST00gJyArIEFUVEFDSF9BTkRfU0VRX1NUT1JFICsKICAgICAgICAnIFdIRVJFIHNlcSBJTiAoJyArCiAgICAgICAgc2Vxcy5tYXAoZnVuY3Rpb24gKCkgeyByZXR1cm4gJz8nOyB9KS5qb2luKCcsJykgKwogICAgICAgICcpJzsKICAgICAgdHguZXhlY3V0ZVNxbChzcWwsIHNlcXMsIGZ1bmN0aW9uICh0eCkgewoKICAgICAgICB2YXIgc3FsID0gJ1NFTEVDVCBkaWdlc3QgRlJPTSAnICsgQVRUQUNIX0FORF9TRVFfU1RPUkUgKwogICAgICAgICAgJyBXSEVSRSBkaWdlc3QgSU4gKCcgKwogICAgICAgICAgZGlnZXN0c1RvQ2hlY2subWFwKGZ1bmN0aW9uICgpIHsgcmV0dXJuICc/JzsgfSkuam9pbignLCcpICsKICAgICAgICAgICcpJzsKICAgICAgICB0eC5leGVjdXRlU3FsKHNxbCwgZGlnZXN0c1RvQ2hlY2ssIGZ1bmN0aW9uICh0eCwgcmVzKSB7CiAgICAgICAgICB2YXIgbm9uT3JwaGFuZWREaWdlc3RzID0gbmV3IHV0aWxzLlNldCgpOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXMucm93cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBub25PcnBoYW5lZERpZ2VzdHMuYWRkKHJlcy5yb3dzLml0ZW0oaSkuZGlnZXN0KTsKICAgICAgICAgIH0KICAgICAgICAgIGRpZ2VzdHNUb0NoZWNrLmZvckVhY2goZnVuY3Rpb24gKGRpZ2VzdCkgewogICAgICAgICAgICBpZiAobm9uT3JwaGFuZWREaWdlc3RzLmhhcyhkaWdlc3QpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHR4LmV4ZWN1dGVTcWwoCiAgICAgICAgICAgICAgJ0RFTEVURSBGUk9NICcgKyBBVFRBQ0hfQU5EX1NFUV9TVE9SRSArICcgV0hFUkUgZGlnZXN0PT8nLAogICAgICAgICAgICAgIFtkaWdlc3RdKTsKICAgICAgICAgICAgdHguZXhlY3V0ZVNxbCgKICAgICAgICAgICAgICAnREVMRVRFIEZST00gJyArIEFUVEFDSF9TVE9SRSArICcgV0hFUkUgZGlnZXN0PT8nLCBbZGlnZXN0XSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9KTsKICB9CgogIC8vIHVwZGF0ZSBieS1zZXEgYW5kIGF0dGFjaCBzdG9yZXMgaW4gcGFyYWxsZWwKICByZXZzLmZvckVhY2goZnVuY3Rpb24gKHJldikgewogICAgdmFyIHNxbCA9ICdTRUxFQ1Qgc2VxIEZST00gJyArIEJZX1NFUV9TVE9SRSArCiAgICAgICcgV0hFUkUgZG9jX2lkPT8gQU5EIHJldj0/JzsKCiAgICB0eC5leGVjdXRlU3FsKHNxbCwgW2RvY0lkLCByZXZdLCBmdW5jdGlvbiAodHgsIHJlcykgewogICAgICBpZiAoIXJlcy5yb3dzLmxlbmd0aCkgeyAvLyBhbHJlYWR5IGRlbGV0ZWQKICAgICAgICByZXR1cm4gY2hlY2tEb25lKCk7CiAgICAgIH0KICAgICAgdmFyIHNlcSA9IHJlcy5yb3dzLml0ZW0oMCkuc2VxOwogICAgICBzZXFzLnB1c2goc2VxKTsKCiAgICAgIHR4LmV4ZWN1dGVTcWwoCiAgICAgICAgJ0RFTEVURSBGUk9NICcgKyBCWV9TRVFfU1RPUkUgKyAnIFdIRVJFIHNlcT0/JywgW3NlcV0sIGNoZWNrRG9uZSk7CiAgICB9KTsKICB9KTsKfQoKZnVuY3Rpb24gd2Vic3FsRXJyb3IoY2FsbGJhY2spIHsKICByZXR1cm4gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICBjb25zb2xlLmVycm9yKCdXZWJTUUwgdGhyZXcgYW4gZXJyb3InLCBldmVudCk7CiAgICAvLyBldmVudCBtYXkgYWN0dWFsbHkgYmUgYSBTUUxFcnJvciBvYmplY3QsIHNvIHJlcG9ydCBpcyBhcyBzdWNoCiAgICB2YXIgZXJyb3JOYW1lTWF0Y2ggPSBldmVudCAmJiBldmVudC5jb25zdHJ1Y3Rvci50b1N0cmluZygpCiAgICAgICAgLm1hdGNoKC9mdW5jdGlvbiAoW15cKF0rKS8pOwogICAgdmFyIGVycm9yTmFtZSA9IChlcnJvck5hbWVNYXRjaCAmJiBlcnJvck5hbWVNYXRjaFsxXSkgfHwgZXZlbnQudHlwZTsKICAgIHZhciBlcnJvclJlYXNvbiA9IGV2ZW50LnRhcmdldCB8fCBldmVudC5tZXNzYWdlOwogICAgY2FsbGJhY2soZXJyb3JzLmVycm9yKGVycm9ycy5XU1FfRVJST1IsIGVycm9yUmVhc29uLCBlcnJvck5hbWUpKTsKICB9Owp9CgpmdW5jdGlvbiBnZXRTaXplKG9wdHMpIHsKICBpZiAoJ3NpemUnIGluIG9wdHMpIHsKICAgIC8vIHRyaWdnZXJzIGltbWVkaWF0ZSBwb3B1cCBpbiBpT1MsIGZpeGVzICMyMzQ3CiAgICAvLyBlLmcuIDUwMDAwMDEgYXNrcyBmb3IgNSBNQiwgMTAwMDAwMDEgYXNrcyBmb3IgMTAgTUIsCiAgICByZXR1cm4gb3B0cy5zaXplICogMTAwMDAwMDsKICB9CiAgLy8gSW4gaU9TLCBkb2Vzbid0IG1hdHRlciBhcyBsb25nIGFzIGl0J3MgPD0gNTAwMDAwMC4KICAvLyBFeGNlcHQgdGhhdCBpZiB5b3UgcmVxdWVzdCB0b28gbXVjaCwgb3VyIHRlc3RzIGZhaWwKICAvLyBiZWNhdXNlIG9mIHRoZSBuYXRpdmUgImRvIHlvdSBhY2NlcHQ/IiBwb3B1cC4KICAvLyBJbiBBbmRyb2lkIDw9NC4zLCB0aGlzIHZhbHVlIGlzIGFjdHVhbGx5IHVzZWQgYXMgYW4KICAvLyBob25lc3QtdG8tZ29kIGNlaWxpbmcgZm9yIGRhdGEsIHNvIHdlIG5lZWQgdG8KICAvLyBzZXQgaXQgdG8gYSBkZWNlbnRseSBoaWdoIG51bWJlci4KICB2YXIgaXNBbmRyb2lkID0gL0FuZHJvaWQvLnRlc3Qod2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQpOwogIHJldHVybiBpc0FuZHJvaWQgPyA1MDAwMDAwIDogMTsgLy8gaW4gUGhhbnRvbUpTLCBpZiB5b3UgdXNlIDAgaXQgd2lsbCBjcmFzaAp9CgpmdW5jdGlvbiBjcmVhdGVPcGVuREJGdW5jdGlvbigpIHsKICBpZiAodHlwZW9mIHNxbGl0ZVBsdWdpbiAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIC8vIFRoZSBTUUxpdGUgUGx1Z2luIHN0YXJ0ZWQgZGV2aWF0aW5nIHByZXR0eSBoZWF2aWx5IGZyb20gdGhlCiAgICAvLyBzdGFuZGFyZCBvcGVuRGF0YWJhc2UoKSBmdW5jdGlvbiwgYXMgdGhleSBzdGFydGVkIGFkZGluZyBtb3JlIGZlYXR1cmVzLgogICAgLy8gSXQncyBiZXR0ZXIgdG8ganVzdCB1c2UgdGhlaXIgIm5ldyIgZm9ybWF0IGFuZCBwYXNzIGluIGEgYmlnIG9sJwogICAgLy8gb3B0aW9ucyBvYmplY3QuCiAgICByZXR1cm4gc3FsaXRlUGx1Z2luLm9wZW5EYXRhYmFzZS5iaW5kKHNxbGl0ZVBsdWdpbik7CiAgfQoKICBpZiAodHlwZW9mIG9wZW5EYXRhYmFzZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHJldHVybiBmdW5jdGlvbiBvcGVuREIob3B0cykgewogICAgICAvLyBUcmFkaXRpb25hbCBXZWJTUUwgQVBJCiAgICAgIHJldHVybiBvcGVuRGF0YWJhc2Uob3B0cy5uYW1lLCBvcHRzLnZlcnNpb24sIG9wdHMuZGVzY3JpcHRpb24sIG9wdHMuc2l6ZSk7CiAgICB9OwogIH0KfQoKZnVuY3Rpb24gb3BlbkRCU2FmZWx5KG9wZW5EQkZ1bmN0aW9uLCBvcHRzKSB7CiAgdHJ5IHsKICAgIHJldHVybiB7CiAgICAgIGRiOiBvcGVuREJGdW5jdGlvbihvcHRzKQogICAgfTsKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiB7CiAgICAgIGVycm9yOiBlcnIKICAgIH07CiAgfQp9Cgp2YXIgY2FjaGVkRGF0YWJhc2VzID0ge307CgpmdW5jdGlvbiBvcGVuREIob3B0cykgewogIHZhciBjYWNoZWRSZXN1bHQgPSBjYWNoZWREYXRhYmFzZXNbb3B0cy5uYW1lXTsKICBpZiAoIWNhY2hlZFJlc3VsdCkgewogICAgdmFyIG9wZW5EQkZ1biA9IGNyZWF0ZU9wZW5EQkZ1bmN0aW9uKCk7CiAgICBjYWNoZWRSZXN1bHQgPSBjYWNoZWREYXRhYmFzZXNbb3B0cy5uYW1lXSA9IG9wZW5EQlNhZmVseShvcGVuREJGdW4sIG9wdHMpOwogICAgaWYgKGNhY2hlZFJlc3VsdC5kYikgewogICAgICBjYWNoZWRSZXN1bHQuZGIuX3NxbGl0ZVBsdWdpbiA9IHR5cGVvZiBzcWxpdGVQbHVnaW4gIT09ICd1bmRlZmluZWQnOwogICAgfQogIH0KICByZXR1cm4gY2FjaGVkUmVzdWx0Owp9CgpmdW5jdGlvbiB2YWxpZCgpIHsKICAvLyBTUUxpdGVQbHVnaW4gbGVha3MgdGhpcyBnbG9iYWwgb2JqZWN0LCB3aGljaCB3ZSBjYW4gdXNlCiAgLy8gdG8gZGV0ZWN0IGlmIGl0J3MgaW5zdGFsbGVkIG9yIG5vdC4gVGhlIGJlbmVmaXQgaXMgdGhhdCBpdCdzCiAgLy8gZGVjbGFyZWQgaW1tZWRpYXRlbHksIGJlZm9yZSB0aGUgJ2RldmljZXJlYWR5JyBldmVudCBoYXMgZmlyZWQuCiAgcmV0dXJuIHR5cGVvZiBvcGVuRGF0YWJhc2UgIT09ICd1bmRlZmluZWQnIHx8CiAgICB0eXBlb2YgU1FMaXRlUGx1Z2luICE9PSAndW5kZWZpbmVkJzsKfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgZXNjYXBlQmxvYjogZXNjYXBlQmxvYiwKICB1bmVzY2FwZUJsb2I6IHVuZXNjYXBlQmxvYiwKICBzdHJpbmdpZnlEb2M6IHN0cmluZ2lmeURvYywKICB1bnN0cmluZ2lmeURvYzogdW5zdHJpbmdpZnlEb2MsCiAgcU1hcmtzOiBxTWFya3MsCiAgc2VsZWN0OiBzZWxlY3QsCiAgY29tcGFjdFJldnM6IGNvbXBhY3RSZXZzLAogIHdlYnNxbEVycm9yOiB3ZWJzcWxFcnJvciwKICBnZXRTaXplOiBnZXRTaXplLAogIG9wZW5EQjogb3BlbkRCLAogIHZhbGlkOiB2YWxpZAp9Owp9LHsiLi4vLi4vZGVwcy9lcnJvcnMiOjY0LCIuLi8uLi91dGlscyI6MTAyLCIuL2NvbnN0YW50cyI6MjR9XSwyNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKdmFyIHV0aWxzID0gcmVxdWlyZSgnLi91dGlscycpOwp2YXIgaXNEZWxldGVkID0gcmVxdWlyZSgnLi9kZXBzL2RvY3MvaXNEZWxldGVkJyk7CnZhciBlcnJvcnMgPSByZXF1aXJlKCcuL2RlcHMvZXJyb3JzJyk7CnZhciBFRSA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKdmFyIGV2YWxGaWx0ZXIgPSByZXF1aXJlKCcuL2V2YWxGaWx0ZXInKTsKdmFyIGV2YWxWaWV3ID0gcmVxdWlyZSgnLi9ldmFsVmlldycpOwp2YXIgcGFyc2VEZG9jRnVuY3Rpb25OYW1lID0gcmVxdWlyZSgnLi9kZXBzL2RvY3MvcGFyc2VEZG9jRnVuY3Rpb25OYW1lJyk7CnZhciBub3JtYWxpemVEZG9jRnVuY3Rpb25OYW1lID0KICByZXF1aXJlKCcuL2RlcHMvZG9jcy9ub3JtYWxpemVEZG9jRnVuY3Rpb25OYW1lJyk7CnZhciBjb2xsZWN0TGVhdmVzID0gcmVxdWlyZSgnLi9kZXBzL21lcmdlL2NvbGxlY3RMZWF2ZXMnKTsKdmFyIGNvbGxlY3RDb25mbGljdHMgPSByZXF1aXJlKCcuL2RlcHMvbWVyZ2UvY29sbGVjdENvbmZsaWN0cycpOwptb2R1bGUuZXhwb3J0cyA9IENoYW5nZXM7CnV0aWxzLmluaGVyaXRzKENoYW5nZXMsIEVFKTsKCmZ1bmN0aW9uIENoYW5nZXMoZGIsIG9wdHMsIGNhbGxiYWNrKSB7CiAgRUUuY2FsbCh0aGlzKTsKICB2YXIgc2VsZiA9IHRoaXM7CiAgdGhpcy5kYiA9IGRiOwogIG9wdHMgPSBvcHRzID8gdXRpbHMuY2xvbmUob3B0cykgOiB7fTsKICB2YXIgY29tcGxldGUgPSBvcHRzLmNvbXBsZXRlID0gdXRpbHMub25jZShmdW5jdGlvbiAoZXJyLCByZXNwKSB7CiAgICBpZiAoZXJyKSB7CiAgICAgIHNlbGYuZW1pdCgnZXJyb3InLCBlcnIpOwogICAgfSBlbHNlIHsKICAgICAgc2VsZi5lbWl0KCdjb21wbGV0ZScsIHJlc3ApOwogICAgfQogICAgc2VsZi5yZW1vdmVBbGxMaXN0ZW5lcnMoKTsKICAgIGRiLnJlbW92ZUxpc3RlbmVyKCdkZXN0cm95ZWQnLCBvbkRlc3Ryb3kpOwogIH0pOwogIGlmIChjYWxsYmFjaykgewogICAgc2VsZi5vbignY29tcGxldGUnLCBmdW5jdGlvbiAocmVzcCkgewogICAgICBjYWxsYmFjayhudWxsLCByZXNwKTsKICAgIH0pOwogICAgc2VsZi5vbignZXJyb3InLCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgIGNhbGxiYWNrKGVycik7CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gb25EZXN0cm95KCkgewogICAgc2VsZi5jYW5jZWwoKTsKICB9CiAgZGIub25jZSgnZGVzdHJveWVkJywgb25EZXN0cm95KTsKCiAgb3B0cy5vbkNoYW5nZSA9IGZ1bmN0aW9uIChjaGFuZ2UpIHsKICAgIGlmIChvcHRzLmlzQ2FuY2VsbGVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHNlbGYuZW1pdCgnY2hhbmdlJywgY2hhbmdlKTsKICAgIGlmIChzZWxmLnN0YXJ0U2VxICYmIHNlbGYuc3RhcnRTZXEgPD0gY2hhbmdlLnNlcSkgewogICAgICBzZWxmLnN0YXJ0U2VxID0gZmFsc2U7CiAgICB9CiAgfTsKCiAgdmFyIHByb21pc2UgPSBuZXcgdXRpbHMuUHJvbWlzZShmdW5jdGlvbiAoZnVsZmlsbCwgcmVqZWN0KSB7CiAgICBvcHRzLmNvbXBsZXRlID0gZnVuY3Rpb24gKGVyciwgcmVzKSB7CiAgICAgIGlmIChlcnIpIHsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmdWxmaWxsKHJlcyk7CiAgICAgIH0KICAgIH07CiAgfSk7CiAgc2VsZi5vbmNlKCdjYW5jZWwnLCBmdW5jdGlvbiAoKSB7CiAgICBkYi5yZW1vdmVMaXN0ZW5lcignZGVzdHJveWVkJywgb25EZXN0cm95KTsKICAgIG9wdHMuY29tcGxldGUobnVsbCwge3N0YXR1czogJ2NhbmNlbGxlZCd9KTsKICB9KTsKICB0aGlzLnRoZW4gPSBwcm9taXNlLnRoZW4uYmluZChwcm9taXNlKTsKICB0aGlzWydjYXRjaCddID0gcHJvbWlzZVsnY2F0Y2gnXS5iaW5kKHByb21pc2UpOwogIHRoaXMudGhlbihmdW5jdGlvbiAocmVzdWx0KSB7CiAgICBjb21wbGV0ZShudWxsLCByZXN1bHQpOwogIH0sIGNvbXBsZXRlKTsKCgoKICBpZiAoIWRiLnRhc2txdWV1ZS5pc1JlYWR5KSB7CiAgICBkYi50YXNrcXVldWUuYWRkVGFzayhmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChzZWxmLmlzQ2FuY2VsbGVkKSB7CiAgICAgICAgc2VsZi5lbWl0KCdjYW5jZWwnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZWxmLmRvQ2hhbmdlcyhvcHRzKTsKICAgICAgfQogICAgfSk7CiAgfSBlbHNlIHsKICAgIHNlbGYuZG9DaGFuZ2VzKG9wdHMpOwogIH0KfQpDaGFuZ2VzLnByb3RvdHlwZS5jYW5jZWwgPSBmdW5jdGlvbiAoKSB7CiAgdGhpcy5pc0NhbmNlbGxlZCA9IHRydWU7CiAgaWYgKHRoaXMuZGIudGFza3F1ZXVlLmlzUmVhZHkpIHsKICAgIHRoaXMuZW1pdCgnY2FuY2VsJyk7CiAgfQp9OwpmdW5jdGlvbiBwcm9jZXNzQ2hhbmdlKGRvYywgbWV0YWRhdGEsIG9wdHMpIHsKICB2YXIgY2hhbmdlTGlzdCA9IFt7cmV2OiBkb2MuX3Jldn1dOwogIGlmIChvcHRzLnN0eWxlID09PSAnYWxsX2RvY3MnKSB7CiAgICBjaGFuZ2VMaXN0ID0gY29sbGVjdExlYXZlcyhtZXRhZGF0YS5yZXZfdHJlZSkKICAgIC5tYXAoZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHtyZXY6IHgucmV2fTsgfSk7CiAgfQogIHZhciBjaGFuZ2UgPSB7CiAgICBpZDogbWV0YWRhdGEuaWQsCiAgICBjaGFuZ2VzOiBjaGFuZ2VMaXN0LAogICAgZG9jOiBkb2MKICB9OwoKICBpZiAoaXNEZWxldGVkKG1ldGFkYXRhLCBkb2MuX3JldikpIHsKICAgIGNoYW5nZS5kZWxldGVkID0gdHJ1ZTsKICB9CiAgaWYgKG9wdHMuY29uZmxpY3RzKSB7CiAgICBjaGFuZ2UuZG9jLl9jb25mbGljdHMgPSBjb2xsZWN0Q29uZmxpY3RzKG1ldGFkYXRhKTsKICAgIGlmICghY2hhbmdlLmRvYy5fY29uZmxpY3RzLmxlbmd0aCkgewogICAgICBkZWxldGUgY2hhbmdlLmRvYy5fY29uZmxpY3RzOwogICAgfQogIH0KICByZXR1cm4gY2hhbmdlOwp9CgpDaGFuZ2VzLnByb3RvdHlwZS5kb0NoYW5nZXMgPSBmdW5jdGlvbiAob3B0cykgewogIHZhciBzZWxmID0gdGhpczsKICB2YXIgY2FsbGJhY2sgPSBvcHRzLmNvbXBsZXRlOwoKICBvcHRzID0gdXRpbHMuY2xvbmUob3B0cyk7CiAgaWYgKCdsaXZlJyBpbiBvcHRzICYmICEoJ2NvbnRpbnVvdXMnIGluIG9wdHMpKSB7CiAgICBvcHRzLmNvbnRpbnVvdXMgPSBvcHRzLmxpdmU7CiAgfQogIG9wdHMucHJvY2Vzc0NoYW5nZSA9IHByb2Nlc3NDaGFuZ2U7CgogIGlmIChvcHRzLnNpbmNlID09PSAnbGF0ZXN0JykgewogICAgb3B0cy5zaW5jZSA9ICdub3cnOwogIH0KICBpZiAoIW9wdHMuc2luY2UpIHsKICAgIG9wdHMuc2luY2UgPSAwOwogIH0KICBpZiAob3B0cy5zaW5jZSA9PT0gJ25vdycpIHsKICAgIHRoaXMuZGIuaW5mbygpLnRoZW4oZnVuY3Rpb24gKGluZm8pIHsKICAgICAgaWYgKHNlbGYuaXNDYW5jZWxsZWQpIHsKICAgICAgICBjYWxsYmFjayhudWxsLCB7c3RhdHVzOiAnY2FuY2VsbGVkJ30pOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBvcHRzLnNpbmNlID0gaW5mby51cGRhdGVfc2VxOwogICAgICBzZWxmLmRvQ2hhbmdlcyhvcHRzKTsKICAgIH0sIGNhbGxiYWNrKTsKICAgIHJldHVybjsKICB9CgogIGlmIChvcHRzLmNvbnRpbnVvdXMgJiYgb3B0cy5zaW5jZSAhPT0gJ25vdycpIHsKICAgIHRoaXMuZGIuaW5mbygpLnRoZW4oZnVuY3Rpb24gKGluZm8pIHsKICAgICAgc2VsZi5zdGFydFNlcSA9IGluZm8udXBkYXRlX3NlcTsKICAgIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgaWYgKGVyci5pZCA9PT0gJ2lkYk51bGwnKSB7CiAgICAgICAgLy9kYiBjbG9zZWQgYmVmb3JlIHRoaXMgcmV0dXJuZWQKICAgICAgICAvL3RoYXRzIG9rCiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRocm93IGVycjsKICAgIH0pOwogIH0KCiAgaWYgKG9wdHMuZmlsdGVyICYmIHR5cGVvZiBvcHRzLmZpbHRlciA9PT0gJ3N0cmluZycpIHsKICAgIGlmIChvcHRzLmZpbHRlciA9PT0gJ192aWV3JykgewogICAgICBvcHRzLnZpZXcgPSBub3JtYWxpemVEZG9jRnVuY3Rpb25OYW1lKG9wdHMudmlldyk7CiAgICB9IGVsc2UgewogICAgICBvcHRzLmZpbHRlciA9IG5vcm1hbGl6ZURkb2NGdW5jdGlvbk5hbWUob3B0cy5maWx0ZXIpOwogICAgfQoKICAgIGlmICh0aGlzLmRiLnR5cGUoKSAhPT0gJ2h0dHAnICYmICFvcHRzLmRvY19pZHMpIHsKICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyQ2hhbmdlcyhvcHRzKTsKICAgIH0KICB9CgogIGlmICghKCdkZXNjZW5kaW5nJyBpbiBvcHRzKSkgewogICAgb3B0cy5kZXNjZW5kaW5nID0gZmFsc2U7CiAgfQoKICAvLyAwIGFuZCAxIHNob3VsZCByZXR1cm4gMSBkb2N1bWVudAogIG9wdHMubGltaXQgPSBvcHRzLmxpbWl0ID09PSAwID8gMSA6IG9wdHMubGltaXQ7CiAgb3B0cy5jb21wbGV0ZSA9IGNhbGxiYWNrOwogIHZhciBuZXdQcm9taXNlID0gdGhpcy5kYi5fY2hhbmdlcyhvcHRzKTsKICBpZiAobmV3UHJvbWlzZSAmJiB0eXBlb2YgbmV3UHJvbWlzZS5jYW5jZWwgPT09ICdmdW5jdGlvbicpIHsKICAgIHZhciBjYW5jZWwgPSBzZWxmLmNhbmNlbDsKICAgIHNlbGYuY2FuY2VsID0gdXRpbHMuZ2V0QXJndW1lbnRzKGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgIG5ld1Byb21pc2UuY2FuY2VsKCk7CiAgICAgIGNhbmNlbC5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0pOwogIH0KfTsKCkNoYW5nZXMucHJvdG90eXBlLmZpbHRlckNoYW5nZXMgPSBmdW5jdGlvbiAob3B0cykgewogIHZhciBzZWxmID0gdGhpczsKICB2YXIgY2FsbGJhY2sgPSBvcHRzLmNvbXBsZXRlOwogIGlmIChvcHRzLmZpbHRlciA9PT0gJ192aWV3JykgewogICAgaWYgKCFvcHRzLnZpZXcgfHwgdHlwZW9mIG9wdHMudmlldyAhPT0gJ3N0cmluZycpIHsKICAgICAgdmFyIGVyciA9IGVycm9ycy5lcnJvcihlcnJvcnMuQkFEX1JFUVVFU1QsCiAgICAgICAgJ2B2aWV3YCBmaWx0ZXIgcGFyYW1ldGVyIG5vdCBmb3VuZCBvciBpbnZhbGlkLicpOwogICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKICAgIH0KICAgIC8vIGZldGNoIGEgdmlldyBmcm9tIGEgZGVzaWduIGRvYywgbWFrZSBpdCBiZWhhdmUgbGlrZSBhIGZpbHRlcgogICAgdmFyIHZpZXdOYW1lID0gcGFyc2VEZG9jRnVuY3Rpb25OYW1lKG9wdHMudmlldyk7CiAgICB0aGlzLmRiLmdldCgnX2Rlc2lnbi8nICsgdmlld05hbWVbMF0sIGZ1bmN0aW9uIChlcnIsIGRkb2MpIHsKICAgICAgaWYgKHNlbGYuaXNDYW5jZWxsZWQpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwge3N0YXR1czogJ2NhbmNlbGxlZCd9KTsKICAgICAgfQogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICBpZiAoZXJyKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycm9ycy5nZW5lcmF0ZUVycm9yRnJvbVJlc3BvbnNlKGVycikpOwogICAgICB9CiAgICAgIHZhciBtYXBGdW4gPSBkZG9jICYmIGRkb2Mudmlld3MgJiYgZGRvYy52aWV3c1t2aWV3TmFtZVsxXV0gJiYKICAgICAgICBkZG9jLnZpZXdzW3ZpZXdOYW1lWzFdXS5tYXA7CiAgICAgIGlmICghbWFwRnVuKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycm9ycy5lcnJvcihlcnJvcnMuTUlTU0lOR19ET0MsCiAgICAgICAgICAoZGRvYy52aWV3cyA/ICdtaXNzaW5nIGpzb24ga2V5OiAnICsgdmlld05hbWVbMV0gOgogICAgICAgICAgICAnbWlzc2luZyBqc29uIGtleTogdmlld3MnKSkpOwogICAgICB9CiAgICAgIG9wdHMuZmlsdGVyID0gZXZhbFZpZXcobWFwRnVuKTsKICAgICAgc2VsZi5kb0NoYW5nZXMob3B0cyk7CiAgICB9KTsKICB9IGVsc2UgewogICAgLy8gZmV0Y2ggYSBmaWx0ZXIgZnJvbSBhIGRlc2lnbiBkb2MKICAgIHZhciBmaWx0ZXJOYW1lID0gcGFyc2VEZG9jRnVuY3Rpb25OYW1lKG9wdHMuZmlsdGVyKTsKICAgIGlmICghZmlsdGVyTmFtZSkgewogICAgICByZXR1cm4gY2FsbGJhY2soZXJyb3JzLmVycm9yKGVycm9ycy5CQURfUkVRVUVTVCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYGZpbHRlcmAgZmlsdGVyIHBhcmFtZXRlciBpbnZhbGlkLicpKTsKICAgIH0KICAgIHRoaXMuZGIuZ2V0KCdfZGVzaWduLycgKyBmaWx0ZXJOYW1lWzBdLCBmdW5jdGlvbiAoZXJyLCBkZG9jKSB7CiAgICAgIGlmIChzZWxmLmlzQ2FuY2VsbGVkKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHtzdGF0dXM6ICdjYW5jZWxsZWQnfSk7CiAgICAgIH0KICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgICAgaWYgKGVycikgewogICAgICAgIHJldHVybiBjYWxsYmFjayhlcnJvcnMuZ2VuZXJhdGVFcnJvckZyb21SZXNwb25zZShlcnIpKTsKICAgICAgfQogICAgICB2YXIgZmlsdGVyRnVuID0gZGRvYyAmJiBkZG9jLmZpbHRlcnMgJiYgZGRvYy5maWx0ZXJzW2ZpbHRlck5hbWVbMV1dOwogICAgICBpZiAoIWZpbHRlckZ1bikgewogICAgICAgIHJldHVybiBjYWxsYmFjayhlcnJvcnMuZXJyb3IoZXJyb3JzLk1JU1NJTkdfRE9DLAogICAgICAgICAgKChkZG9jICYmIGRkb2MuZmlsdGVycykgPyAnbWlzc2luZyBqc29uIGtleTogJyArIGZpbHRlck5hbWVbMV0KICAgICAgICAgICAgOiAnbWlzc2luZyBqc29uIGtleTogZmlsdGVycycpKSk7CiAgICAgIH0KICAgICAgb3B0cy5maWx0ZXIgPSBldmFsRmlsdGVyKGZpbHRlckZ1bik7CiAgICAgIHNlbGYuZG9DaGFuZ2VzKG9wdHMpOwogICAgfSk7CiAgfQp9OwoKfSx7Ii4vZGVwcy9kb2NzL2lzRGVsZXRlZCI6NTQsIi4vZGVwcy9kb2NzL25vcm1hbGl6ZURkb2NGdW5jdGlvbk5hbWUiOjU2LCIuL2RlcHMvZG9jcy9wYXJzZURkb2NGdW5jdGlvbk5hbWUiOjU3LCIuL2RlcHMvZXJyb3JzIjo2NCwiLi9kZXBzL21lcmdlL2NvbGxlY3RDb25mbGljdHMiOjY4LCIuL2RlcHMvbWVyZ2UvY29sbGVjdExlYXZlcyI6NjksIi4vZXZhbEZpbHRlciI6ODMsIi4vZXZhbFZpZXciOjg0LCIuL3V0aWxzIjoxMDIsImV2ZW50cyI6N31dLDI4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKdmFyIGluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKdmFyIGlzQ2hyb21lQXBwID0gcmVxdWlyZSgnLi9kZXBzL2Vudi9pc0Nocm9tZUFwcCcpOwp2YXIgaGFzTG9jYWxTdG9yYWdlID0gcmVxdWlyZSgnLi9kZXBzL2Vudi9oYXNMb2NhbFN0b3JhZ2UnKTsKdmFyIHBpY2sgPSByZXF1aXJlKCcuL2RlcHMvcGljaycpOwoKaW5oZXJpdHMoQ2hhbmdlcywgRXZlbnRFbWl0dGVyKTsKCi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCmZ1bmN0aW9uIGF0dGFjaEJyb3dzZXJFdmVudHMoc2VsZikgewogIGlmIChpc0Nocm9tZUFwcCgpKSB7CiAgICBjaHJvbWUuc3RvcmFnZS5vbkNoYW5nZWQuYWRkTGlzdGVuZXIoZnVuY3Rpb24gKGUpIHsKICAgICAgLy8gbWFrZSBzdXJlIGl0J3MgZXZlbnQgYWRkcmVzc2VkIHRvIHVzCiAgICAgIGlmIChlLmRiX25hbWUgIT0gbnVsbCkgewogICAgICAgIC8vb2JqZWN0IG9ubHkgaGFzIG9sZFZhbHVlLCBuZXdWYWx1ZSBtZW1iZXJzCiAgICAgICAgc2VsZi5lbWl0KGUuZGJOYW1lLm5ld1ZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgfSBlbHNlIGlmIChoYXNMb2NhbFN0b3JhZ2UoKSkgewogICAgaWYgKHR5cGVvZiBhZGRFdmVudExpc3RlbmVyICE9PSAndW5kZWZpbmVkJykgewogICAgICBhZGRFdmVudExpc3RlbmVyKCJzdG9yYWdlIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICBzZWxmLmVtaXQoZS5rZXkpOwogICAgICB9KTsKICAgIH0gZWxzZSB7IC8vIG9sZCBJRQogICAgICB3aW5kb3cuYXR0YWNoRXZlbnQoInN0b3JhZ2UiLCBmdW5jdGlvbiAoZSkgewogICAgICAgIHNlbGYuZW1pdChlLmtleSk7CiAgICAgIH0pOwogICAgfQogIH0KfQoKZnVuY3Rpb24gQ2hhbmdlcygpIHsKICBFdmVudEVtaXR0ZXIuY2FsbCh0aGlzKTsKICB0aGlzLl9saXN0ZW5lcnMgPSB7fTsKCiAgYXR0YWNoQnJvd3NlckV2ZW50cyh0aGlzKTsKfQpDaGFuZ2VzLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IGZ1bmN0aW9uIChkYk5hbWUsIGlkLCBkYiwgb3B0cykgewogIGlmICh0aGlzLl9saXN0ZW5lcnNbaWRdKSB7CiAgICByZXR1cm47CiAgfQogIHZhciBzZWxmID0gdGhpczsKICB2YXIgaW5wcm9ncmVzcyA9IGZhbHNlOwogIGZ1bmN0aW9uIGV2ZW50RnVuY3Rpb24oKSB7CiAgICBpZiAoIXNlbGYuX2xpc3RlbmVyc1tpZF0pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGlucHJvZ3Jlc3MpIHsKICAgICAgaW5wcm9ncmVzcyA9ICd3YWl0aW5nJzsKICAgICAgcmV0dXJuOwogICAgfQogICAgaW5wcm9ncmVzcyA9IHRydWU7CiAgICB2YXIgY2hhbmdlc09wdHMgPSBwaWNrKG9wdHMsIFsKICAgICAgJ3N0eWxlJywgJ2luY2x1ZGVfZG9jcycsICdhdHRhY2htZW50cycsICdjb25mbGljdHMnLCAnZmlsdGVyJywKICAgICAgJ2RvY19pZHMnLCAndmlldycsICdzaW5jZScsICdxdWVyeV9wYXJhbXMnLCAnYmluYXJ5JwogICAgXSk7CgogICAgZGIuY2hhbmdlcyhjaGFuZ2VzT3B0cykub24oJ2NoYW5nZScsIGZ1bmN0aW9uIChjKSB7CiAgICAgIGlmIChjLnNlcSA+IG9wdHMuc2luY2UgJiYgIW9wdHMuY2FuY2VsbGVkKSB7CiAgICAgICAgb3B0cy5zaW5jZSA9IGMuc2VxOwogICAgICAgIG9wdHMub25DaGFuZ2UoYyk7CiAgICAgIH0KICAgIH0pLm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGlucHJvZ3Jlc3MgPT09ICd3YWl0aW5nJykgewogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgIGV2ZW50RnVuY3Rpb24oKTsKICAgICAgICB9LDApOwogICAgICB9CiAgICAgIGlucHJvZ3Jlc3MgPSBmYWxzZTsKICAgIH0pLm9uKCdlcnJvcicsIGZ1bmN0aW9uICgpIHsKICAgICAgaW5wcm9ncmVzcyA9IGZhbHNlOwogICAgfSk7CiAgfQogIHRoaXMuX2xpc3RlbmVyc1tpZF0gPSBldmVudEZ1bmN0aW9uOwogIHRoaXMub24oZGJOYW1lLCBldmVudEZ1bmN0aW9uKTsKfTsKCkNoYW5nZXMucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyID0gZnVuY3Rpb24gKGRiTmFtZSwgaWQpIHsKICBpZiAoIShpZCBpbiB0aGlzLl9saXN0ZW5lcnMpKSB7CiAgICByZXR1cm47CiAgfQogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIuY2FsbCh0aGlzLCBkYk5hbWUsCiAgICB0aGlzLl9saXN0ZW5lcnNbaWRdKTsKfTsKCgovKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwpDaGFuZ2VzLnByb3RvdHlwZS5ub3RpZnlMb2NhbFdpbmRvd3MgPSBmdW5jdGlvbiAoZGJOYW1lKSB7CiAgLy9kbyBhIHVzZWxlc3MgY2hhbmdlIG9uIGEgc3RvcmFnZSB0aGluZwogIC8vaW4gb3JkZXIgdG8gZ2V0IG90aGVyIHdpbmRvd3MncyBsaXN0ZW5lcnMgdG8gYWN0aXZhdGUKICBpZiAoaXNDaHJvbWVBcHAoKSkgewogICAgY2hyb21lLnN0b3JhZ2UubG9jYWwuc2V0KHtkYk5hbWU6IGRiTmFtZX0pOwogIH0gZWxzZSBpZiAoaGFzTG9jYWxTdG9yYWdlKCkpIHsKICAgIGxvY2FsU3RvcmFnZVtkYk5hbWVdID0gKGxvY2FsU3RvcmFnZVtkYk5hbWVdID09PSAiYSIpID8gImIiIDogImEiOwogIH0KfTsKCkNoYW5nZXMucHJvdG90eXBlLm5vdGlmeSA9IGZ1bmN0aW9uIChkYk5hbWUpIHsKICB0aGlzLmVtaXQoZGJOYW1lKTsKICB0aGlzLm5vdGlmeUxvY2FsV2luZG93cyhkYk5hbWUpOwp9OwoKbW9kdWxlLmV4cG9ydHMgPSBDaGFuZ2VzOwoKfSx7Ii4vZGVwcy9lbnYvaGFzTG9jYWxTdG9yYWdlIjo2MiwiLi9kZXBzL2Vudi9pc0Nocm9tZUFwcCI6NjMsIi4vZGVwcy9waWNrIjo3OCwiZXZlbnRzIjo3LCJpbmhlcml0cyI6MTJ9XSwyOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAoZ2xvYmFsKXsKLypnbG9iYWxzIGNvcmRvdmEgKi8KInVzZSBzdHJpY3QiOwoKdmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKTsKCnZhciBBZGFwdGVyID0gcmVxdWlyZSgnLi9hZGFwdGVyJyk7CnZhciB1dGlscyA9IHJlcXVpcmUoJy4vdXRpbHMnKTsKdmFyIFRhc2tRdWV1ZSA9IHJlcXVpcmUoJy4vdGFza3F1ZXVlJyk7CnZhciBQcm9taXNlID0gdXRpbHMuUHJvbWlzZTsKCmZ1bmN0aW9uIGRlZmF1bHRDYWxsYmFjayhlcnIpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogIGlmIChlcnIgJiYgZ2xvYmFsLmRlYnVnKSB7CiAgICBjb25zb2xlLmVycm9yKGVycik7CiAgfQp9CgovLyBPSywgc28gaGVyZSdzIHRoZSBkZWFsLiBDb25zaWRlciB0aGlzIGNvZGU6Ci8vICAgICB2YXIgZGIxID0gbmV3IFBvdWNoREIoJ2ZvbycpOwovLyAgICAgdmFyIGRiMiA9IG5ldyBQb3VjaERCKCdmb28nKTsKLy8gICAgIGRiMS5kZXN0cm95KCk7Ci8vIF4gdGhlc2UgdHdvIGJvdGggbmVlZCB0byBlbWl0ICdkZXN0cm95ZWQnIGV2ZW50cywKLy8gYXMgd2VsbCBhcyB0aGUgUG91Y2hEQiBjb25zdHJ1Y3RvciBpdHNlbGYuCi8vIFNvIHdlIGhhdmUgb25lIGRiIG9iamVjdCAod2hpY2hldmVyIG9uZSBnb3QgZGVzdHJveSgpIGNhbGxlZCBvbiBpdCkKLy8gcmVzcG9uc2libGUgZm9yIGVtaXR0aW5nIHRoZSBpbml0aWFsIGV2ZW50LCB3aGljaCB0aGVuIGdldHMgZW1pdHRlZAovLyBieSB0aGUgY29uc3RydWN0b3IsIHdoaWNoIHRoZW4gYnJvYWRjYXN0cyBpdCB0byBhbnkgb3RoZXIgZGJzCi8vIHRoYXQgbWF5IGhhdmUgYmVlbiBjcmVhdGVkIHdpdGggdGhlIHNhbWUgbmFtZS4KZnVuY3Rpb24gcHJlcGFyZUZvckRlc3RydWN0aW9uKHNlbGYsIG9wdHMpIHsKICB2YXIgbmFtZSA9IG9wdHMub3JpZ2luYWxOYW1lOwogIHZhciBjdG9yID0gc2VsZi5jb25zdHJ1Y3RvcjsKICB2YXIgZGVzdHJ1Y3Rpb25MaXN0ZW5lcnMgPSBjdG9yLl9kZXN0cnVjdGlvbkxpc3RlbmVyczsKCiAgZnVuY3Rpb24gb25EZXN0cm95ZWQoKSB7CiAgICBjdG9yLmVtaXQoJ2Rlc3Ryb3llZCcsIG5hbWUpOwogICAgLy9zbyB3ZSBkb24ndCBoYXZlIHRvIHNpZnQgdGhyb3VnaCBhbGwgZGJuYW1lcwogICAgY3Rvci5lbWl0KG5hbWUsICdkZXN0cm95ZWQnKTsKICB9CgogIGZ1bmN0aW9uIG9uQ29uc3RydWN0b3JEZXN0cm95ZWQoKSB7CiAgICBzZWxmLnJlbW92ZUxpc3RlbmVyKCdkZXN0cm95ZWQnLCBvbkRlc3Ryb3llZCk7CiAgICBzZWxmLmVtaXQoJ2Rlc3Ryb3llZCcsIHNlbGYpOwogIH0KCiAgc2VsZi5vbmNlKCdkZXN0cm95ZWQnLCBvbkRlc3Ryb3llZCk7CgogIC8vIGluIHNldHVwLmpzLCB0aGUgY29uc3RydWN0b3IgaXMgcHJpbWVkIHRvIGxpc3RlbiBmb3IgZGVzdHJveSBldmVudHMKICBpZiAoIWRlc3RydWN0aW9uTGlzdGVuZXJzLmhhcyhuYW1lKSkgewogICAgZGVzdHJ1Y3Rpb25MaXN0ZW5lcnMuc2V0KG5hbWUsIFtdKTsKICB9CiAgZGVzdHJ1Y3Rpb25MaXN0ZW5lcnMuZ2V0KG5hbWUpLnB1c2gob25Db25zdHJ1Y3RvckRlc3Ryb3llZCk7Cn0KCnV0aWxzLmluaGVyaXRzKFBvdWNoREIsIEFkYXB0ZXIpOwpmdW5jdGlvbiBQb3VjaERCKG5hbWUsIG9wdHMsIGNhbGxiYWNrKSB7CgogIGlmICghKHRoaXMgaW5zdGFuY2VvZiBQb3VjaERCKSkgewogICAgcmV0dXJuIG5ldyBQb3VjaERCKG5hbWUsIG9wdHMsIGNhbGxiYWNrKTsKICB9CiAgdmFyIHNlbGYgPSB0aGlzOwogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJyB8fCB0eXBlb2Ygb3B0cyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgIGNhbGxiYWNrID0gb3B0czsKICAgIG9wdHMgPSB7fTsKICB9CgogIGlmIChuYW1lICYmIHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgb3B0cyA9IG5hbWU7CiAgICBuYW1lID0gdW5kZWZpbmVkOwogIH0KICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAndW5kZWZpbmVkJykgewogICAgY2FsbGJhY2sgPSBkZWZhdWx0Q2FsbGJhY2s7CiAgfQogIG5hbWUgPSBuYW1lIHx8IG9wdHMubmFtZTsKICBvcHRzID0gdXRpbHMuY2xvbmUob3B0cyk7CiAgLy8gaWYgbmFtZSB3YXMgc3BlY2lmaWVkIHZpYSBvcHRzLCBpZ25vcmUgZm9yIHRoZSBzYWtlIG9mIGRlcGVuZGVudERicwogIGRlbGV0ZSBvcHRzLm5hbWU7CiAgdGhpcy5fX29wdHMgPSBvcHRzOwogIHZhciBvbGRDQiA9IGNhbGxiYWNrOwogIHNlbGYuYXV0b19jb21wYWN0aW9uID0gb3B0cy5hdXRvX2NvbXBhY3Rpb247CiAgc2VsZi5wcmVmaXggPSBQb3VjaERCLnByZWZpeDsKICBBZGFwdGVyLmNhbGwoc2VsZik7CiAgc2VsZi50YXNrcXVldWUgPSBuZXcgVGFza1F1ZXVlKCk7CiAgdmFyIHByb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAoZnVsZmlsbCwgcmVqZWN0KSB7CiAgICBjYWxsYmFjayA9IGZ1bmN0aW9uIChlcnIsIHJlc3ApIHsKICAgICAgaWYgKGVycikgewogICAgICAgIHJldHVybiByZWplY3QoZXJyKTsKICAgICAgfQogICAgICBkZWxldGUgcmVzcC50aGVuOwogICAgICBmdWxmaWxsKHJlc3ApOwogICAgfTsKICAKICAgIG9wdHMgPSB1dGlscy5jbG9uZShvcHRzKTsKICAgIHZhciBvcmlnaW5hbE5hbWUgPSBvcHRzLm5hbWUgfHwgbmFtZTsKICAgIHZhciBiYWNrZW5kLCBlcnJvcjsKICAgIChmdW5jdGlvbiAoKSB7CiAgICAgIHRyeSB7CgogICAgICAgIGlmICh0eXBlb2Ygb3JpZ2luYWxOYW1lICE9PSAnc3RyaW5nJykgewogICAgICAgICAgZXJyb3IgPSBuZXcgRXJyb3IoJ01pc3NpbmcvaW52YWxpZCBEQiBuYW1lJyk7CiAgICAgICAgICBlcnJvci5jb2RlID0gNDAwOwogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfQoKICAgICAgICBiYWNrZW5kID0gUG91Y2hEQi5wYXJzZUFkYXB0ZXIob3JpZ2luYWxOYW1lLCBvcHRzKTsKICAgICAgICAKICAgICAgICBvcHRzLm9yaWdpbmFsTmFtZSA9IG9yaWdpbmFsTmFtZTsKICAgICAgICBvcHRzLm5hbWUgPSBiYWNrZW5kLm5hbWU7CiAgICAgICAgaWYgKG9wdHMucHJlZml4ICYmIGJhY2tlbmQuYWRhcHRlciAhPT0gJ2h0dHAnICYmCiAgICAgICAgICAgIGJhY2tlbmQuYWRhcHRlciAhPT0gJ2h0dHBzJykgewogICAgICAgICAgb3B0cy5uYW1lID0gb3B0cy5wcmVmaXggKyBvcHRzLm5hbWU7CiAgICAgICAgfQogICAgICAgIG9wdHMuYWRhcHRlciA9IG9wdHMuYWRhcHRlciB8fCBiYWNrZW5kLmFkYXB0ZXI7CiAgICAgICAgc2VsZi5fYWRhcHRlciA9IG9wdHMuYWRhcHRlcjsKICAgICAgICBkZWJ1ZygncG91Y2hkYjphZGFwdGVyJykoJ1BpY2tlZCBhZGFwdGVyOiAnICsgb3B0cy5hZGFwdGVyKTsKCiAgICAgICAgc2VsZi5fZGJfbmFtZSA9IG9yaWdpbmFsTmFtZTsKICAgICAgICBpZiAoIVBvdWNoREIuYWRhcHRlcnNbb3B0cy5hZGFwdGVyXSkgewogICAgICAgICAgZXJyb3IgPSBuZXcgRXJyb3IoJ0FkYXB0ZXIgaXMgbWlzc2luZycpOwogICAgICAgICAgZXJyb3IuY29kZSA9IDQwNDsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFQb3VjaERCLmFkYXB0ZXJzW29wdHMuYWRhcHRlcl0udmFsaWQoKSkgewogICAgICAgICAgZXJyb3IgPSBuZXcgRXJyb3IoJ0ludmFsaWQgQWRhcHRlcicpOwogICAgICAgICAgZXJyb3IuY29kZSA9IDQwNDsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgc2VsZi50YXNrcXVldWUuZmFpbChlcnIpOwogICAgICB9CiAgICB9KCkpOwogICAgaWYgKGVycm9yKSB7CiAgICAgIHJldHVybiByZWplY3QoZXJyb3IpOyAvLyBjb25zdHJ1Y3RvciBlcnJvciwgc2VlIGFib3ZlCiAgICB9CiAgICBzZWxmLmFkYXB0ZXIgPSBvcHRzLmFkYXB0ZXI7CgogICAgLy8gbmVlZHMgYWNjZXNzIHRvIFBvdWNoREI7CiAgICBzZWxmLnJlcGxpY2F0ZSA9IHt9OwoKICAgIHNlbGYucmVwbGljYXRlLmZyb20gPSBmdW5jdGlvbiAodXJsLCBvcHRzLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gc2VsZi5jb25zdHJ1Y3Rvci5yZXBsaWNhdGUodXJsLCBzZWxmLCBvcHRzLCBjYWxsYmFjayk7CiAgICB9OwoKICAgIHNlbGYucmVwbGljYXRlLnRvID0gZnVuY3Rpb24gKHVybCwgb3B0cywgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHNlbGYuY29uc3RydWN0b3IucmVwbGljYXRlKHNlbGYsIHVybCwgb3B0cywgY2FsbGJhY2spOwogICAgfTsKCiAgICBzZWxmLnN5bmMgPSBmdW5jdGlvbiAoZGJOYW1lLCBvcHRzLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gc2VsZi5jb25zdHJ1Y3Rvci5zeW5jKHNlbGYsIGRiTmFtZSwgb3B0cywgY2FsbGJhY2spOwogICAgfTsKCiAgICBzZWxmLnJlcGxpY2F0ZS5zeW5jID0gc2VsZi5zeW5jOwoKICAgIFBvdWNoREIuYWRhcHRlcnNbb3B0cy5hZGFwdGVyXS5jYWxsKHNlbGYsIG9wdHMsIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgaWYgKGVycikgewogICAgICAgIHNlbGYudGFza3F1ZXVlLmZhaWwoZXJyKTsKICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBwcmVwYXJlRm9yRGVzdHJ1Y3Rpb24oc2VsZiwgb3B0cyk7CgogICAgICBzZWxmLmVtaXQoJ2NyZWF0ZWQnLCBzZWxmKTsKICAgICAgUG91Y2hEQi5lbWl0KCdjcmVhdGVkJywgb3B0cy5vcmlnaW5hbE5hbWUpOwogICAgICBzZWxmLnRhc2txdWV1ZS5yZWFkeShzZWxmKTsKICAgICAgY2FsbGJhY2sobnVsbCwgc2VsZik7CiAgICB9KTsKCiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgaWYgKHV0aWxzLmlzQ29yZG92YSgpKSB7CiAgICAgIC8vdG8gaW5mb3JtIHdlYnNxbCBhZGFwdGVyIHRoYXQgd2UgY2FuIHVzZSBhcGkKICAgICAgY29yZG92YS5maXJlV2luZG93RXZlbnQob3B0cy5uYW1lICsgIl9wb3VjaCIsIHt9KTsKICAgIH0KICB9KTsKICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHsKICAgIG9sZENCKG51bGwsIHJlc3ApOwogIH0sIG9sZENCKTsKICBzZWxmLnRoZW4gPSBwcm9taXNlLnRoZW4uYmluZChwcm9taXNlKTsKICBzZWxmLmNhdGNoID0gcHJvbWlzZS5jYXRjaC5iaW5kKHByb21pc2UpOwp9CgpQb3VjaERCLmRlYnVnID0gZGVidWc7Cgptb2R1bGUuZXhwb3J0cyA9IFBvdWNoREI7Cgp9KS5jYWxsKHRoaXMsdHlwZW9mIGdsb2JhbCAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWwgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKfSx7Ii4vYWRhcHRlciI6MTQsIi4vdGFza3F1ZXVlIjoxMDEsIi4vdXRpbHMiOjEwMiwiZGVidWciOjl9XSwzMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCnZhciByZXF1ZXN0ID0gcmVxdWlyZSgncmVxdWVzdCcpOwoKdmFyIGVycm9ycyA9IHJlcXVpcmUoJy4vLi4vZXJyb3JzJyk7CnZhciB1dGlscyA9IHJlcXVpcmUoJy4uLy4uL3V0aWxzJyk7CnZhciBhcHBseVR5cGVUb0J1ZmZlciA9IHJlcXVpcmUoJy4vYXBwbHlUeXBlVG9CdWZmZXInKTsKdmFyIGRlZmF1bHRCb2R5ID0gcmVxdWlyZSgnLi9kZWZhdWx0Qm9keScpOwp2YXIgZXhwbGFpbkNvcnMgPSByZXF1aXJlKCcuL2V4cGxhaW5Db3JzJyk7CgpmdW5jdGlvbiBhamF4KG9wdGlvbnMsIGNhbGxiYWNrKSB7CgogIG9wdGlvbnMgPSB1dGlscy5jbG9uZShvcHRpb25zKTsKCiAgdmFyIGRlZmF1bHRPcHRpb25zID0gewogICAgbWV0aG9kIDogIkdFVCIsCiAgICBoZWFkZXJzOiB7fSwKICAgIGpzb246IHRydWUsCiAgICBwcm9jZXNzRGF0YTogdHJ1ZSwKICAgIHRpbWVvdXQ6IDEwMDAwLAogICAgY2FjaGU6IGZhbHNlCiAgfTsKCiAgb3B0aW9ucyA9IHV0aWxzLmV4dGVuZChkZWZhdWx0T3B0aW9ucywgb3B0aW9ucyk7CgoKICBmdW5jdGlvbiBvblN1Y2Nlc3Mob2JqLCByZXNwLCBjYikgewogICAgaWYgKCFvcHRpb25zLmJpbmFyeSAmJiAhb3B0aW9ucy5qc29uICYmIG9wdGlvbnMucHJvY2Vzc0RhdGEgJiYKICAgICAgdHlwZW9mIG9iaiAhPT0gJ3N0cmluZycpIHsKICAgICAgb2JqID0gSlNPTi5zdHJpbmdpZnkob2JqKTsKICAgIH0gZWxzZSBpZiAoIW9wdGlvbnMuYmluYXJ5ICYmIG9wdGlvbnMuanNvbiAmJiB0eXBlb2Ygb2JqID09PSAnc3RyaW5nJykgewogICAgICB0cnkgewogICAgICAgIG9iaiA9IEpTT04ucGFyc2Uob2JqKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIC8vIFByb2JhYmx5IGEgbWFsZm9ybWVkIEpTT04gZnJvbSBzZXJ2ZXIKICAgICAgICByZXR1cm4gY2IoZSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKICAgICAgb2JqID0gb2JqLm1hcChmdW5jdGlvbiAodikgewogICAgICAgIGlmICh2LmVycm9yIHx8IHYubWlzc2luZykgewogICAgICAgICAgcmV0dXJuIGVycm9ycy5nZW5lcmF0ZUVycm9yRnJvbVJlc3BvbnNlKHYpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gdjsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgaWYgKG9wdGlvbnMuYmluYXJ5KSB7CiAgICAgIGFwcGx5VHlwZVRvQnVmZmVyKG9iaiwgcmVzcCk7CiAgICB9CiAgICBjYihudWxsLCBvYmosIHJlc3ApOwogIH0KCiAgZnVuY3Rpb24gb25FcnJvcihlcnIsIGNiKSB7CiAgICB2YXIgZXJyUGFyc2VkLCBlcnJPYmo7CiAgICBpZiAoZXJyLmNvZGUgJiYgZXJyLnN0YXR1cykgewogICAgICB2YXIgZXJyMiA9IG5ldyBFcnJvcihlcnIubWVzc2FnZSB8fCBlcnIuY29kZSk7CiAgICAgIGVycjIuc3RhdHVzID0gZXJyLnN0YXR1czsKICAgICAgcmV0dXJuIGNiKGVycjIpOwogICAgfQogICAgdHJ5IHsKICAgICAgZXJyUGFyc2VkID0gSlNPTi5wYXJzZShlcnIucmVzcG9uc2VUZXh0KTsKICAgICAgLy93b3VsZCBwcmVmZXIgbm90IHRvIGhhdmUgYSB0cnkvY2F0Y2ggY2xhdXNlCiAgICAgIGVyck9iaiA9IGVycm9ycy5nZW5lcmF0ZUVycm9yRnJvbVJlc3BvbnNlKGVyclBhcnNlZCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGVyck9iaiA9IGVycm9ycy5nZW5lcmF0ZUVycm9yRnJvbVJlc3BvbnNlKGVycik7CiAgICB9CiAgICBjYihlcnJPYmopOwogIH0KCgogIGlmIChvcHRpb25zLmpzb24pIHsKICAgIGlmICghb3B0aW9ucy5iaW5hcnkpIHsKICAgICAgb3B0aW9ucy5oZWFkZXJzLkFjY2VwdCA9ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgIH0KICAgIG9wdGlvbnMuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSBvcHRpb25zLmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddIHx8CiAgICAgICdhcHBsaWNhdGlvbi9qc29uJzsKICB9CgogIGlmIChvcHRpb25zLmJpbmFyeSkgewogICAgb3B0aW9ucy5lbmNvZGluZyA9IG51bGw7CiAgICBvcHRpb25zLmpzb24gPSBmYWxzZTsKICB9CgogIGlmICghb3B0aW9ucy5wcm9jZXNzRGF0YSkgewogICAgb3B0aW9ucy5qc29uID0gZmFsc2U7CiAgfQoKICByZXR1cm4gcmVxdWVzdChvcHRpb25zLCBmdW5jdGlvbiAoZXJyLCByZXNwb25zZSwgYm9keSkgewogICAgaWYgKGVycikgewogICAgICBpZiAocmVzcG9uc2UpIHsKICAgICAgICB2YXIgb3JpZ2luID0gKHR5cGVvZiBkb2N1bWVudCAhPT0gJ3VuZGVmaW5lZCcpICYmCiAgICAgICAgICBkb2N1bWVudC5sb2NhdGlvbi5vcmlnaW47CiAgICAgICAgdmFyIGlzQ3Jvc3NPcmlnaW4gPSBvcmlnaW4gJiYgb3B0aW9ucy51cmwuaW5kZXhPZihvcmlnaW4pID09PSAwOwogICAgICAgIGlmIChpc0Nyb3NzT3JpZ2luICYmIHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDApIHsKICAgICAgICAgIGV4cGxhaW5Db3JzKCk7CiAgICAgICAgfQogICAgICAgIGVyci5zdGF0dXMgPSByZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICB9IGVsc2UgewogICAgICAgIGVyci5zdGF0dXMgPSA0MDA7CiAgICAgIH0KICAgICAgcmV0dXJuIG9uRXJyb3IoZXJyLCBjYWxsYmFjayk7CiAgICB9CgogICAgdmFyIGVycm9yOwogICAgdmFyIGNvbnRlbnRfdHlwZSA9IHJlc3BvbnNlLmhlYWRlcnMgJiYgcmVzcG9uc2UuaGVhZGVyc1snY29udGVudC10eXBlJ107CiAgICB2YXIgZGF0YSA9IGJvZHkgfHwgZGVmYXVsdEJvZHkoKTsKCiAgICAvLyBDb3VjaERCIGRvZXNuJ3QgYWx3YXlzIHJldHVybiB0aGUgcmlnaHQgY29udGVudC10eXBlIGZvciBKU09OIGRhdGEsIHNvCiAgICAvLyB3ZSBjaGVjayBmb3IgXnsgYW5kIH0kIChpZ25vcmluZyBsZWFkaW5nL3RyYWlsaW5nIHdoaXRlc3BhY2UpCiAgICBpZiAoIW9wdGlvbnMuYmluYXJ5ICYmIChvcHRpb25zLmpzb24gfHwgIW9wdGlvbnMucHJvY2Vzc0RhdGEpICYmCiAgICAgICAgdHlwZW9mIGRhdGEgIT09ICdvYmplY3QnICYmCiAgICAgICAgKC9qc29uLy50ZXN0KGNvbnRlbnRfdHlwZSkgfHwKICAgICAgICAgKC9eW1xzXSpcey8udGVzdChkYXRhKSAmJiAvXH1bXHNdKiQvLnRlc3QoZGF0YSkpKSkgewogICAgICB0cnkgewogICAgICAgIGRhdGEgPSBKU09OLnBhcnNlKGRhdGEudG9TdHJpbmcoKSk7CiAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICB9CgogICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPj0gMjAwICYmIHJlc3BvbnNlLnN0YXR1c0NvZGUgPCAzMDApIHsKICAgICAgb25TdWNjZXNzKGRhdGEsIHJlc3BvbnNlLCBjYWxsYmFjayk7CiAgICB9IGVsc2UgewogICAgICBlcnJvciA9IGVycm9ycy5nZW5lcmF0ZUVycm9yRnJvbVJlc3BvbnNlKGRhdGEpOwogICAgICBlcnJvci5zdGF0dXMgPSByZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICBjYWxsYmFjayhlcnJvcik7CiAgICB9CiAgfSk7Cn0KCm1vZHVsZS5leHBvcnRzID0gYWpheDsKCn0seyIuLi8uLi91dGlscyI6MTAyLCIuLy4uL2Vycm9ycyI6NjQsIi4vYXBwbHlUeXBlVG9CdWZmZXIiOjMxLCIuL2RlZmF1bHRCb2R5IjozNCwiLi9leHBsYWluQ29ycyI6MzYsInJlcXVlc3QiOjM5fV0sMzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyB0aGUgYmxvYiBhbHJlYWR5IGhhcyBhIHR5cGU7IGRvIG5vdGhpbmcKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7fTsKfSx7fV0sMzI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgY3JlYXRlQmxvYiA9IHJlcXVpcmUoJy4uL2JpbmFyeS9ibG9iJyk7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGNyZWF0ZUJsb2JPckJ1ZmZlckZyb21QYXJ0cyhwYXJ0cywgdHlwZSkgewogIHJldHVybiBjcmVhdGVCbG9iKHBhcnRzLCB7dHlwZTogdHlwZX0pOwp9Owp9LHsiLi4vYmluYXJ5L2Jsb2IiOjQ1fV0sMzM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgYmluYXJ5U3RyaW5nVG9BcnJheUJ1ZmZlciA9IHJlcXVpcmUoJy4uL2JpbmFyeS9iaW5hcnlTdHJpbmdUb0FycmF5QnVmZmVyJyk7CgovLyBjcmVhdGUgYSAicGFydCIgc3VpdGFibGUgZm9yIG11bHRpcGFydC4gaW4gdGhlIGJyb3dzZXIKLy8gdGhpcyBpcyBhbiBBcnJheUJ1ZmZlcjsgaW4gTm9kZSBpdCdzIGEgYmluYXJ5IHN0cmluZwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGNyZWF0ZU11bHRpcGFydFBhcnQoZGF0YSkgewogIHJldHVybiBiaW5hcnlTdHJpbmdUb0FycmF5QnVmZmVyKGRhdGEpOwp9Owp9LHsiLi4vYmluYXJ5L2JpbmFyeVN0cmluZ1RvQXJyYXlCdWZmZXIiOjQzfV0sMzQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGRlZmF1bHRCb2R5KCkgewogIHJldHVybiAnJzsKfTsKfSx7fV0sMzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKGdsb2JhbCl7Cid1c2Ugc3RyaWN0JzsKCi8vIGRlc2lnbmVkIHRvIGdpdmUgaW5mbyB0byBicm93c2VyIHVzZXJzLCB3aG8gYXJlIGRpc3R1cmJlZAovLyB3aGVuIHRoZXkgc2VlIDQwNHMgaW4gdGhlIGNvbnNvbGUKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBleHBsYWluNDA0KHN0cikgewogIGlmICgnY29uc29sZScgaW4gZ2xvYmFsICYmICdpbmZvJyBpbiBjb25zb2xlKSB7CiAgICBjb25zb2xlLmluZm8oJ1RoZSBhYm92ZSA0MDQgaXMgdG90YWxseSBub3JtYWwuICcgKyBzdHIpOwogIH0KfTsKfSkuY2FsbCh0aGlzLHR5cGVvZiBnbG9iYWwgIT09ICJ1bmRlZmluZWQiID8gZ2xvYmFsIDogdHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDoge30pCn0se31dLDM2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChnbG9iYWwpewondXNlIHN0cmljdCc7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHsKICBpZiAoJ2NvbnNvbGUnIGluIGdsb2JhbCAmJiAnd2FybicgaW4gY29uc29sZSkgewogICAgY29uc29sZS53YXJuKCdQb3VjaERCOiB0aGUgcmVtb3RlIGRhdGFiYXNlIG1heSBub3QgaGF2ZSBDT1JTIGVuYWJsZWQuJyArCiAgICAgICdJZiBub3QgcGxlYXNlIGVuYWJsZSBDT1JTOiAnICsKICAgICAgJ2h0dHA6Ly9wb3VjaGRiLmNvbS9lcnJvcnMuaHRtbCNub19hY2Nlc3NfY29udHJvbF9hbGxvd19vcmlnaW5faGVhZGVyJyk7CiAgfQp9OwoKfSkuY2FsbCh0aGlzLHR5cGVvZiBnbG9iYWwgIT09ICJ1bmRlZmluZWQiID8gZ2xvYmFsIDogdHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDoge30pCn0se31dLDM3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gQ3JlYXRlIGEgbXVsdGlwYXJ0L3JlbGF0ZWQgc3RyZWFtIG91dCBvZiBhIGRvY3VtZW50LAovLyBzbyB3ZSBjYW4gdXBsb2FkIGRvY3VtZW50cyBpbiB0aGF0IGZvcm1hdCB3aGVuCi8vIGF0dGFjaG1lbnRzIGFyZSBsYXJnZS4gVGhpcyBpcyBzaGFtZWZ1bGx5IHN0b2xlbiBmcm9tCi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9zYmFsbGVzdGVyb3MvY291Y2gtbXVsdGlwYXJ0LXN0cmVhbS8KLy8gYW5kIGh0dHBzOi8vZ2l0aHViLmNvbS9ucG0vbnBtLWZ1bGxmYXQtcmVnaXN0cnkKCnZhciBiYXNlNjQgPSByZXF1aXJlKCcuLy4uL2JpbmFyeS9iYXNlNjQnKTsKdmFyIGF0b2IgPSBiYXNlNjQuYXRvYjsKdmFyIHV1aWQgPSByZXF1aXJlKCcuLy4uL3V1aWQnKTsKdmFyIHV0aWxzID0gcmVxdWlyZSgnLi4vLi4vdXRpbHMnKTsKdmFyIGNsb25lID0gdXRpbHMuY2xvbmU7Cgp2YXIgY3JlYXRlQmx1ZmZlckZyb21QYXJ0cyA9IHJlcXVpcmUoJy4vY3JlYXRlQmxvYk9yQnVmZmVyRnJvbVBhcnRzJyk7CnZhciBjcmVhdGVNdWx0aXBhcnRQYXJ0ID0gcmVxdWlyZSgnLi9jcmVhdGVNdWx0aXBhcnRQYXJ0Jyk7CgpmdW5jdGlvbiBjcmVhdGVNdWx0aXBhcnQoZG9jKSB7CiAgZG9jID0gY2xvbmUoZG9jKTsKCiAgdmFyIGJvdW5kYXJ5ID0gdXVpZCgpOwoKICB2YXIgbm9uU3R1YkF0dGFjaG1lbnRzID0ge307CgogIE9iamVjdC5rZXlzKGRvYy5fYXR0YWNobWVudHMpLmZvckVhY2goZnVuY3Rpb24gKGZpbGVuYW1lKSB7CiAgICB2YXIgYXR0ID0gZG9jLl9hdHRhY2htZW50c1tmaWxlbmFtZV07CiAgICBpZiAoYXR0LnN0dWIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGJpbkRhdGEgPSBhdG9iKGF0dC5kYXRhKTsKICAgIG5vblN0dWJBdHRhY2htZW50c1tmaWxlbmFtZV0gPSB7dHlwZTogYXR0LmNvbnRlbnRfdHlwZSwgZGF0YTogYmluRGF0YX07CiAgICBhdHQubGVuZ3RoID0gYmluRGF0YS5sZW5ndGg7CiAgICBhdHQuZm9sbG93cyA9IHRydWU7CiAgICBkZWxldGUgYXR0LmRpZ2VzdDsKICAgIGRlbGV0ZSBhdHQuZGF0YTsKICB9KTsKCiAgdmFyIHByZWFtYmxlID0gJy0tJyArIGJvdW5kYXJ5ICsKICAgICdcclxuQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uXHJcblxyXG4nOwoKICB2YXIgcGFydHMgPSBbcHJlYW1ibGUsIEpTT04uc3RyaW5naWZ5KGRvYyldOwoKICBPYmplY3Qua2V5cyhub25TdHViQXR0YWNobWVudHMpLmZvckVhY2goZnVuY3Rpb24gKGZpbGVuYW1lKSB7CiAgICB2YXIgYXR0ID0gbm9uU3R1YkF0dGFjaG1lbnRzW2ZpbGVuYW1lXTsKICAgIHZhciBwcmVhbWJsZSA9ICdcclxuLS0nICsgYm91bmRhcnkgKwogICAgICAnXHJcbkNvbnRlbnQtRGlzcG9zaXRpb246IGF0dGFjaG1lbnQ7IGZpbGVuYW1lPScgKwogICAgICAgIEpTT04uc3RyaW5naWZ5KGZpbGVuYW1lKSArCiAgICAgICdcclxuQ29udGVudC1UeXBlOiAnICsgYXR0LnR5cGUgKwogICAgICAnXHJcbkNvbnRlbnQtTGVuZ3RoOiAnICsgYXR0LmRhdGEubGVuZ3RoICsKICAgICAgJ1xyXG5cclxuJzsKICAgIHBhcnRzLnB1c2gocHJlYW1ibGUpOwogICAgcGFydHMucHVzaChjcmVhdGVNdWx0aXBhcnRQYXJ0KGF0dC5kYXRhKSk7CiAgfSk7CgogIHBhcnRzLnB1c2goJ1xyXG4tLScgKyBib3VuZGFyeSArICctLScpOwoKICB2YXIgdHlwZSA9ICdtdWx0aXBhcnQvcmVsYXRlZDsgYm91bmRhcnk9JyArIGJvdW5kYXJ5OwogIHZhciBib2R5ID0gY3JlYXRlQmx1ZmZlckZyb21QYXJ0cyhwYXJ0cywgdHlwZSk7CgogIHJldHVybiB7CiAgICBoZWFkZXJzOiB7CiAgICAgICdDb250ZW50LVR5cGUnOiB0eXBlCiAgICB9LAogICAgYm9keTogYm9keQogIH07Cn0KCm1vZHVsZS5leHBvcnRzID0gY3JlYXRlTXVsdGlwYXJ0OwoKfSx7Ii4uLy4uL3V0aWxzIjoxMDIsIi4vLi4vYmluYXJ5L2Jhc2U2NCI6NDEsIi4vLi4vdXVpZCI6ODIsIi4vY3JlYXRlQmxvYk9yQnVmZmVyRnJvbVBhcnRzIjozMiwiLi9jcmVhdGVNdWx0aXBhcnRQYXJ0IjozM31dLDM4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIGFqYXggPSByZXF1aXJlKCcuL2FqYXhDb3JlJyk7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKG9wdHMsIGNhbGxiYWNrKSB7CgogIC8vIGNhY2hlLWJ1c3Rlciwgc3BlY2lmaWNhbGx5IGRlc2lnbmVkIHRvIHdvcmsgYXJvdW5kIElFJ3MgYWdncmVzc2l2ZSBjYWNoaW5nCiAgLy8gc2VlIGh0dHA6Ly93d3cuZGFzaGJheS5jb20vMjAxMS8wNS9pbnRlcm5ldC1leHBsb3Jlci1jYWNoZXMtYWpheC8KICAvLyBBbHNvIFNhZmFyaSBjYWNoZXMgUE9TVHMsIHNvIHdlIG5lZWQgdG8gY2FjaGUtYnVzdCB0aG9zZSB0b28uCiAgaWYgKChvcHRzLm1ldGhvZCA9PT0gJ1BPU1QnIHx8IG9wdHMubWV0aG9kID09PSAnR0VUJykgJiYgIW9wdHMuY2FjaGUpIHsKICAgIHZhciBoYXNBcmdzID0gb3B0cy51cmwuaW5kZXhPZignPycpICE9PSAtMTsKICAgIG9wdHMudXJsICs9IChoYXNBcmdzID8gJyYnIDogJz8nKSArICdfbm9uY2U9JyArIERhdGUubm93KCk7CiAgfQoKICByZXR1cm4gYWpheChvcHRzLCBjYWxsYmFjayk7Cn07Cgp9LHsiLi9hamF4Q29yZSI6MzB9XSwzOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIGdsb2JhbCBmZXRjaCAqLwovKiBnbG9iYWwgSGVhZGVycyAqLwondXNlIHN0cmljdCc7Cgp2YXIgY3JlYXRlQmxvYiA9IHJlcXVpcmUoJy4vLi4vYmluYXJ5L2Jsb2IuanMnKTsKdmFyIHV0aWxzID0gcmVxdWlyZSgnLi4vLi4vdXRpbHMnKTsKdmFyIHJlYWRBc0FycmF5QnVmZmVyID0gcmVxdWlyZSgnLi8uLi9iaW5hcnkvcmVhZEFzQXJyYXlCdWZmZXInKTsKCmZ1bmN0aW9uIHdyYXBwZWRGZXRjaCgpIHsKICB2YXIgd3JhcHBlZFByb21pc2UgPSB7fTsKCiAgdmFyIHByb21pc2UgPSBuZXcgdXRpbHMuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgIHdyYXBwZWRQcm9taXNlLnJlc29sdmUgPSByZXNvbHZlOwogICAgd3JhcHBlZFByb21pc2UucmVqZWN0ID0gcmVqZWN0OwogIH0pOwoKICB2YXIgYXJncyA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CiAgICBhcmdzW2ldID0gYXJndW1lbnRzW2ldOwogIH0KCiAgd3JhcHBlZFByb21pc2UucHJvbWlzZSA9IHByb21pc2U7CgogIHV0aWxzLlByb21pc2UucmVzb2x2ZSgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGZldGNoLmFwcGx5KG51bGwsIGFyZ3MpOwogIH0pLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgIHdyYXBwZWRQcm9taXNlLnJlc29sdmUocmVzcG9uc2UpOwogIH0pLmNhdGNoKGZ1bmN0aW9uKGVycm9yKSB7CiAgICB3cmFwcGVkUHJvbWlzZS5yZWplY3QoZXJyb3IpOwogIH0pOwoKICByZXR1cm4gd3JhcHBlZFByb21pc2U7Cn0KCmZ1bmN0aW9uIGZldGNoUmVxdWVzdChvcHRpb25zLCBjYWxsYmFjaykgewogIHZhciB3cmFwcGVkUHJvbWlzZSwgdGltZXIsIHJlc3BvbnNlOwoKICB2YXIgaGVhZGVycyA9IG5ldyBIZWFkZXJzKCk7CgogIHZhciBmZXRjaE9wdGlvbnMgPSB7CiAgICBtZXRob2Q6IG9wdGlvbnMubWV0aG9kLAogICAgY3JlZGVudGlhbHM6ICdpbmNsdWRlJywKICAgIGhlYWRlcnM6IGhlYWRlcnMKICB9OwoKICBpZiAob3B0aW9ucy5qc29uKSB7CiAgICBoZWFkZXJzLnNldCgnQWNjZXB0JywgJ2FwcGxpY2F0aW9uL2pzb24nKTsKICAgIGhlYWRlcnMuc2V0KCdDb250ZW50LVR5cGUnLCBvcHRpb25zLmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddIHx8CiAgICAgICdhcHBsaWNhdGlvbi9qc29uJyk7CiAgfQoKICBpZiAob3B0aW9ucy5ib2R5ICYmIChvcHRpb25zLmJvZHkgaW5zdGFuY2VvZiBCbG9iKSkgewogICAgcmVhZEFzQXJyYXlCdWZmZXIob3B0aW9ucy5ib2R5LCBmdW5jdGlvbiAoYXJyYXlCdWZmZXIpIHsKICAgICAgZmV0Y2hPcHRpb25zLmJvZHkgPSBhcnJheUJ1ZmZlcjsKICAgIH0pOwogIH0gZWxzZSBpZiAob3B0aW9ucy5ib2R5ICYmCiAgICAgICAgICAgICBvcHRpb25zLnByb2Nlc3NEYXRhICYmCiAgICAgICAgICAgICB0eXBlb2Ygb3B0aW9ucy5ib2R5ICE9PSAnc3RyaW5nJykgewogICAgZmV0Y2hPcHRpb25zLmJvZHkgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmJvZHkpOwogIH0gZWxzZSBpZiAoJ2JvZHknIGluIG9wdGlvbnMpIHsKICAgIGZldGNoT3B0aW9ucy5ib2R5ID0gb3B0aW9ucy5ib2R5OwogIH0gZWxzZSB7CiAgICBmZXRjaE9wdGlvbnMuYm9keSA9IG51bGw7CiAgfQoKICBPYmplY3Qua2V5cyhvcHRpb25zLmhlYWRlcnMpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICBpZiAob3B0aW9ucy5oZWFkZXJzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgaGVhZGVycy5zZXQoa2V5LCBvcHRpb25zLmhlYWRlcnNba2V5XSk7CiAgICB9CiAgfSk7CgogIHdyYXBwZWRQcm9taXNlID0gd3JhcHBlZEZldGNoKG9wdGlvbnMudXJsLCBmZXRjaE9wdGlvbnMpOwoKICBpZiAob3B0aW9ucy50aW1lb3V0ID4gMCkgewogICAgdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICB3cmFwcGVkUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdMb2FkIHRpbWVvdXQgZm9yIHJlc291cmNlOiAnICsKICAgICAgICBvcHRpb25zLnVybCkpOwogICAgfSwgb3B0aW9ucy50aW1lb3V0KTsKICB9CgogIHdyYXBwZWRQcm9taXNlLnByb21pc2UudGhlbihmdW5jdGlvbihmZXRjaFJlc3BvbnNlKSB7CiAgICByZXNwb25zZSA9IHsKICAgICAgc3RhdHVzQ29kZTogZmV0Y2hSZXNwb25zZS5zdGF0dXMKICAgIH07CgogICAgaWYgKG9wdGlvbnMudGltZW91dCA+IDApIHsKICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKICAgIH0KCiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA+PSAyMDAgJiYgcmVzcG9uc2Uuc3RhdHVzQ29kZSA8IDMwMCkgewogICAgICByZXR1cm4gb3B0aW9ucy5iaW5hcnkgPyBmZXRjaFJlc3BvbnNlLmJsb2IoKSA6IGZldGNoUmVzcG9uc2UudGV4dCgpOwogICAgfQoKICAgIHJldHVybiBmZXRjaFJlc3BvbnNlLmpzb24oKTsKICB9KS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPj0gMjAwICYmIHJlc3BvbnNlLnN0YXR1c0NvZGUgPCAzMDApIHsKICAgICAgY2FsbGJhY2sobnVsbCwgcmVzcG9uc2UsIHJlc3VsdCk7CiAgICB9IGVsc2UgewogICAgICBjYWxsYmFjayhyZXN1bHQsIHJlc3BvbnNlKTsKICAgIH0KICB9KS5jYXRjaChmdW5jdGlvbihlcnJvcikgewogICAgY2FsbGJhY2soZXJyb3IsIHJlc3BvbnNlKTsKICB9KTsKCiAgcmV0dXJuIHthYm9ydDogd3JhcHBlZFByb21pc2UucmVqZWN0fTsKfQoKZnVuY3Rpb24geGhSZXF1ZXN0KG9wdGlvbnMsIGNhbGxiYWNrKSB7CgogIHZhciB4aHIsIHRpbWVyLCBoYXNVcGxvYWQ7CgogIHZhciBhYm9ydFJlcSA9IGZ1bmN0aW9uICgpIHsKICAgIHhoci5hYm9ydCgpOwogIH07CgogIGlmIChvcHRpb25zLnhocikgewogICAgeGhyID0gbmV3IG9wdGlvbnMueGhyKCk7CiAgfSBlbHNlIHsKICAgIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogIH0KCiAgeGhyLm9wZW4ob3B0aW9ucy5tZXRob2QsIG9wdGlvbnMudXJsKTsKICB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsKCiAgaWYgKG9wdGlvbnMubWV0aG9kID09PSAnR0VUJykgewogICAgZGVsZXRlIG9wdGlvbnMuaGVhZGVyc1snQ29udGVudC1UeXBlJ107CiAgfSBlbHNlIGlmIChvcHRpb25zLmpzb24pIHsKICAgIG9wdGlvbnMuaGVhZGVycy5BY2NlcHQgPSAnYXBwbGljYXRpb24vanNvbic7CiAgICBvcHRpb25zLmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gb3B0aW9ucy5oZWFkZXJzWydDb250ZW50LVR5cGUnXSB8fAogICAgICAnYXBwbGljYXRpb24vanNvbic7CiAgICBpZiAob3B0aW9ucy5ib2R5ICYmCiAgICAgICAgb3B0aW9ucy5wcm9jZXNzRGF0YSAmJgogICAgICAgIHR5cGVvZiBvcHRpb25zLmJvZHkgIT09ICJzdHJpbmciKSB7CiAgICAgIG9wdGlvbnMuYm9keSA9IEpTT04uc3RyaW5naWZ5KG9wdGlvbnMuYm9keSk7CiAgICB9CiAgfQoKICBpZiAob3B0aW9ucy5iaW5hcnkpIHsKICAgIHhoci5yZXNwb25zZVR5cGUgPSAnYXJyYXlidWZmZXInOwogIH0KCiAgaWYgKCEoJ2JvZHknIGluIG9wdGlvbnMpKSB7CiAgICBvcHRpb25zLmJvZHkgPSBudWxsOwogIH0KCiAgZm9yICh2YXIga2V5IGluIG9wdGlvbnMuaGVhZGVycykgewogICAgaWYgKG9wdGlvbnMuaGVhZGVycy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgb3B0aW9ucy5oZWFkZXJzW2tleV0pOwogICAgfQogIH0KCiAgaWYgKG9wdGlvbnMudGltZW91dCA+IDApIHsKICAgIHRpbWVyID0gc2V0VGltZW91dChhYm9ydFJlcSwgb3B0aW9ucy50aW1lb3V0KTsKICAgIHhoci5vbnByb2dyZXNzID0gZnVuY3Rpb24gKCkgewogICAgICBjbGVhclRpbWVvdXQodGltZXIpOwogICAgICB0aW1lciA9IHNldFRpbWVvdXQoYWJvcnRSZXEsIG9wdGlvbnMudGltZW91dCk7CiAgICB9OwogICAgaWYgKHR5cGVvZiBoYXNVcGxvYWQgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgIC8vIElFIHRocm93cyBhbiBlcnJvciBpZiB5b3UgdHJ5IHRvIGFjY2VzcyBpdCBkaXJlY3RseQogICAgICBoYXNVcGxvYWQgPSBPYmplY3Qua2V5cyh4aHIpLmluZGV4T2YoJ3VwbG9hZCcpICE9PSAtMSAmJgogICAgICAgICAgICAgICAgICB0eXBlb2YgeGhyLnVwbG9hZCAhPT0gJ3VuZGVmaW5lZCc7CiAgICB9CiAgICBpZiAoaGFzVXBsb2FkKSB7IC8vIGRvZXMgbm90IGV4aXN0IGluIGllOQogICAgICB4aHIudXBsb2FkLm9ucHJvZ3Jlc3MgPSB4aHIub25wcm9ncmVzczsKICAgIH0KICB9CgogIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoeGhyLnJlYWR5U3RhdGUgIT09IDQpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciByZXNwb25zZSA9IHsKICAgICAgc3RhdHVzQ29kZTogeGhyLnN0YXR1cwogICAgfTsKCiAgICBpZiAoeGhyLnN0YXR1cyA+PSAyMDAgJiYgeGhyLnN0YXR1cyA8IDMwMCkgewogICAgICB2YXIgZGF0YTsKICAgICAgaWYgKG9wdGlvbnMuYmluYXJ5KSB7CiAgICAgICAgZGF0YSA9IGNyZWF0ZUJsb2IoW3hoci5yZXNwb25zZSB8fCAnJ10sIHsKICAgICAgICAgIHR5cGU6IHhoci5nZXRSZXNwb25zZUhlYWRlcignQ29udGVudC1UeXBlJykKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkYXRhID0geGhyLnJlc3BvbnNlVGV4dDsKICAgICAgfQogICAgICBjYWxsYmFjayhudWxsLCByZXNwb25zZSwgZGF0YSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgZXJyID0ge307CiAgICAgIHRyeSB7CiAgICAgICAgZXJyID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2UpOwogICAgICB9IGNhdGNoKGUpIHt9CiAgICAgIGNhbGxiYWNrKGVyciwgcmVzcG9uc2UpOwogICAgfQogIH07CgogIGlmIChvcHRpb25zLmJvZHkgJiYgKG9wdGlvbnMuYm9keSBpbnN0YW5jZW9mIEJsb2IpKSB7CiAgICByZWFkQXNBcnJheUJ1ZmZlcihvcHRpb25zLmJvZHksIGZ1bmN0aW9uIChhcnJheUJ1ZmZlcikgewogICAgICB4aHIuc2VuZChhcnJheUJ1ZmZlcik7CiAgICB9KTsKICB9IGVsc2UgewogICAgeGhyLnNlbmQob3B0aW9ucy5ib2R5KTsKICB9CgogIHJldHVybiB7YWJvcnQ6IGFib3J0UmVxfTsKfQoKZnVuY3Rpb24gdGVzdFhocigpIHsKICB0cnkgewogICAgbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICByZXR1cm4gdHJ1ZTsKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBmYWxzZTsKICB9Cn0KCnZhciBoYXNYaHIgPSB0ZXN0WGhyKCk7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgaWYgKGhhc1hociB8fCBvcHRpb25zLnhocikgewogICAgcmV0dXJuIHhoUmVxdWVzdChvcHRpb25zLCBjYWxsYmFjayk7CiAgfSBlbHNlIHsKICAgIHJldHVybiBmZXRjaFJlcXVlc3Qob3B0aW9ucywgY2FsbGJhY2spOwogIH0KfTsKCn0seyIuLi8uLi91dGlscyI6MTAyLCIuLy4uL2JpbmFyeS9ibG9iLmpzIjo0NSwiLi8uLi9iaW5hcnkvcmVhZEFzQXJyYXlCdWZmZXIiOjUwfV0sNDA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovL0Nhbid0IGZpbmQgb3JpZ2luYWwgcG9zdCwgYnV0IHRoaXMgaXMgY2xvc2UKLy9odHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzY5NjUxMDcvIChjb250aW51ZXMgb24gbmV4dCBsaW5lKQovL2NvbnZlcnRpbmctYmV0d2Vlbi1zdHJpbmdzLWFuZC1hcnJheWJ1ZmZlcnMKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgdmFyIGJpbmFyeSA9ICcnOwogIHZhciBieXRlcyA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlcik7CiAgdmFyIGxlbmd0aCA9IGJ5dGVzLmJ5dGVMZW5ndGg7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgYmluYXJ5ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnl0ZXNbaV0pOwogIH0KICByZXR1cm4gYmluYXJ5Owp9Owp9LHt9XSw0MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBidWZmZXIgPSByZXF1aXJlKCcuL2J1ZmZlcicpOwoKLyogaXN0YW5idWwgaWdub3JlIGlmICovCmlmICh0eXBlb2YgYXRvYiA9PT0gJ2Z1bmN0aW9uJykgewogIGV4cG9ydHMuYXRvYiA9IGZ1bmN0aW9uIChzdHIpIHsKICAgIC8qIGdsb2JhbCBhdG9iICovCiAgICByZXR1cm4gYXRvYihzdHIpOwogIH07Cn0gZWxzZSB7CiAgZXhwb3J0cy5hdG9iID0gZnVuY3Rpb24gKHN0cikgewogICAgdmFyIGJhc2U2NCA9IG5ldyBidWZmZXIoc3RyLCAnYmFzZTY0Jyk7CiAgICAvLyBOb2RlLmpzIHdpbGwganVzdCBza2lwIHRoZSBjaGFyYWN0ZXJzIGl0IGNhbid0IGVuY29kZSBpbnN0ZWFkIG9mCiAgICAvLyB0aHJvd2luZyBhbmQgZXhjZXB0aW9uCiAgICBpZiAoYmFzZTY0LnRvU3RyaW5nKCdiYXNlNjQnKSAhPT0gc3RyKSB7CiAgICAgIHRocm93ICgiQ2Fubm90IGJhc2U2NCBlbmNvZGUgZnVsbCBzdHJpbmciKTsKICAgIH0KICAgIHJldHVybiBiYXNlNjQudG9TdHJpbmcoJ2JpbmFyeScpOwogIH07Cn0KCi8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwppZiAodHlwZW9mIGJ0b2EgPT09ICdmdW5jdGlvbicpIHsKICBleHBvcnRzLmJ0b2EgPSBmdW5jdGlvbiAoc3RyKSB7CiAgICAvKiBnbG9iYWwgYnRvYSAqLwogICAgcmV0dXJuIGJ0b2Eoc3RyKTsKICB9Owp9IGVsc2UgewogIGV4cG9ydHMuYnRvYSA9IGZ1bmN0aW9uIChzdHIpIHsKICAgIHJldHVybiBuZXcgYnVmZmVyKHN0ciwgJ2JpbmFyeScpLnRvU3RyaW5nKCdiYXNlNjQnKTsKICB9Owp9Cn0seyIuL2J1ZmZlciI6NDd9XSw0MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBhdG9iID0gcmVxdWlyZSgnLi9iYXNlNjQnKS5hdG9iOwp2YXIgYmluYXJ5U3RyaW5nVG9CbG9iT3JCdWZmZXIgPSByZXF1aXJlKCcuL2JpbmFyeVN0cmluZ1RvQmxvYk9yQnVmZmVyJyk7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChiNjQsIHR5cGUpIHsKICByZXR1cm4gYmluYXJ5U3RyaW5nVG9CbG9iT3JCdWZmZXIoYXRvYihiNjQpLCB0eXBlKTsKfTsKfSx7Ii4vYmFzZTY0Ijo0MSwiLi9iaW5hcnlTdHJpbmdUb0Jsb2JPckJ1ZmZlciI6NDR9XSw0MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIEZyb20gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xNDk2NzY0Ny8gKGNvbnRpbnVlcyBvbiBuZXh0IGxpbmUpCi8vIGVuY29kZS1kZWNvZGUtaW1hZ2Utd2l0aC1iYXNlNjQtYnJlYWtzLWltYWdlICgyMDEzLTA0LTIxKQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChiaW4pIHsKICB2YXIgbGVuZ3RoID0gYmluLmxlbmd0aDsKICB2YXIgYnVmID0gbmV3IEFycmF5QnVmZmVyKGxlbmd0aCk7CiAgdmFyIGFyciA9IG5ldyBVaW50OEFycmF5KGJ1Zik7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgYXJyW2ldID0gYmluLmNoYXJDb2RlQXQoaSk7CiAgfQogIHJldHVybiBidWY7Cn07Cn0se31dLDQ0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIGNyZWF0ZUJsb2IgPSByZXF1aXJlKCcuL2Jsb2InKTsKdmFyIGJpbmFyeVN0cmluZ1RvQXJyYXlCdWZmZXIgPSByZXF1aXJlKCcuL2JpbmFyeVN0cmluZ1RvQXJyYXlCdWZmZXInKTsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKGJpblN0cmluZywgdHlwZSkgewogIHJldHVybiBjcmVhdGVCbG9iKFtiaW5hcnlTdHJpbmdUb0FycmF5QnVmZmVyKGJpblN0cmluZyldLCB7dHlwZTogdHlwZX0pOwp9Owp9LHsiLi9iaW5hcnlTdHJpbmdUb0FycmF5QnVmZmVyIjo0MywiLi9ibG9iIjo0NX1dLDQ1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKLy8gQWJzdHJhY3RzIGNvbnN0cnVjdGluZyBhIEJsb2Igb2JqZWN0LCBzbyBpdCBhbHNvIHdvcmtzIGluIG9sZGVyCi8vIGJyb3dzZXJzIHRoYXQgZG9uJ3Qgc3VwcG9ydCB0aGUgbmF0aXZlIEJsb2IgY29uc3RydWN0b3IgKGUuZy4KLy8gb2xkIFF0V2ViS2l0IHZlcnNpb25zLCBBbmRyb2lkIDwgNC40KS4KZnVuY3Rpb24gY3JlYXRlQmxvYihwYXJ0cywgcHJvcGVydGllcykgewogIC8qIGdsb2JhbCBCbG9iQnVpbGRlcixNU0Jsb2JCdWlsZGVyLE1vekJsb2JCdWlsZGVyLFdlYktpdEJsb2JCdWlsZGVyICovCiAgcGFydHMgPSBwYXJ0cyB8fCBbXTsKICBwcm9wZXJ0aWVzID0gcHJvcGVydGllcyB8fCB7fTsKICB0cnkgewogICAgcmV0dXJuIG5ldyBCbG9iKHBhcnRzLCBwcm9wZXJ0aWVzKTsKICB9IGNhdGNoIChlKSB7CiAgICBpZiAoZS5uYW1lICE9PSAiVHlwZUVycm9yIikgewogICAgICB0aHJvdyBlOwogICAgfQogICAgdmFyIEJ1aWxkZXIgPSB0eXBlb2YgQmxvYkJ1aWxkZXIgIT09ICd1bmRlZmluZWQnID8gQmxvYkJ1aWxkZXIgOgogICAgICAgICAgICAgICAgICB0eXBlb2YgTVNCbG9iQnVpbGRlciAhPT0gJ3VuZGVmaW5lZCcgPyBNU0Jsb2JCdWlsZGVyIDoKICAgICAgICAgICAgICAgICAgdHlwZW9mIE1vekJsb2JCdWlsZGVyICE9PSAndW5kZWZpbmVkJyA/IE1vekJsb2JCdWlsZGVyIDoKICAgICAgICAgICAgICAgICAgV2ViS2l0QmxvYkJ1aWxkZXI7CiAgICB2YXIgYnVpbGRlciA9IG5ldyBCdWlsZGVyKCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSArPSAxKSB7CiAgICAgIGJ1aWxkZXIuYXBwZW5kKHBhcnRzW2ldKTsKICAgIH0KICAgIHJldHVybiBidWlsZGVyLmdldEJsb2IocHJvcGVydGllcy50eXBlKTsKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gY3JlYXRlQmxvYjsKCgp9LHt9XSw0NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBQcm9taXNlID0gcmVxdWlyZSgnLi4vcHJvbWlzZScpOwp2YXIgcmVhZEFzQmluYXJ5U3RyaW5nID0gcmVxdWlyZSgnLi9yZWFkQXNCaW5hcnlTdHJpbmcnKTsKdmFyIGJ0b2EgPSByZXF1aXJlKCcuL2Jhc2U2NCcpLmJ0b2E7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGJsb2JUb0Jhc2U2NChibG9iT3JCdWZmZXIpIHsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgIHJlYWRBc0JpbmFyeVN0cmluZyhibG9iT3JCdWZmZXIsIGZ1bmN0aW9uIChiaW4pIHsKICAgICAgcmVzb2x2ZShidG9hKGJpbikpOwogICAgfSk7CiAgfSk7Cn07Cn0seyIuLi9wcm9taXNlIjo3OSwiLi9iYXNlNjQiOjQxLCIuL3JlYWRBc0JpbmFyeVN0cmluZyI6NTF9XSw0NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIGhleSBndWVzcyB3aGF0LCB3ZSBkb24ndCBuZWVkIHRoaXMgaW4gdGhlIGJyb3dzZXIKbW9kdWxlLmV4cG9ydHMgPSB7fTsKfSx7fV0sNDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpmdW5jdGlvbiBjbG9uZUFycmF5QnVmZmVyKGJ1ZmYpIHsKICBpZiAodHlwZW9mIGJ1ZmYuc2xpY2UgPT09ICdmdW5jdGlvbicpIHsKICAgIHJldHVybiBidWZmLnNsaWNlKDApOwogIH0KICAvLyBJRTEwLTExIHNsaWNlKCkgcG9seWZpbGwKICB2YXIgdGFyZ2V0ID0gbmV3IEFycmF5QnVmZmVyKGJ1ZmYuYnl0ZUxlbmd0aCk7CiAgdmFyIHRhcmdldEFycmF5ID0gbmV3IFVpbnQ4QXJyYXkodGFyZ2V0KTsKICB2YXIgc291cmNlQXJyYXkgPSBuZXcgVWludDhBcnJheShidWZmKTsKICB0YXJnZXRBcnJheS5zZXQoc291cmNlQXJyYXkpOwogIHJldHVybiB0YXJnZXQ7Cn0KCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gY2xvbmVCaW5hcnlPYmplY3Qob2JqZWN0KSB7CiAgaWYgKG9iamVjdCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7CiAgICByZXR1cm4gY2xvbmVBcnJheUJ1ZmZlcihvYmplY3QpOwogIH0KICB2YXIgc2l6ZSA9IG9iamVjdC5zaXplOwogIHZhciB0eXBlID0gb2JqZWN0LnR5cGU7CiAgLy8gQmxvYgogIGlmICh0eXBlb2Ygb2JqZWN0LnNsaWNlID09PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm4gb2JqZWN0LnNsaWNlKDAsIHNpemUsIHR5cGUpOwogIH0KICAvLyBQaGFudG9tSlMgc2xpY2UoKSByZXBsYWNlbWVudAogIHJldHVybiBvYmplY3Qud2Via2l0U2xpY2UoMCwgc2l6ZSwgdHlwZSk7Cn07Cgp9LHt9XSw0OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gaXNCaW5hcnlPYmplY3Qob2JqZWN0KSB7CiAgcmV0dXJuIG9iamVjdCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyIHx8CiAgICAodHlwZW9mIEJsb2IgIT09ICd1bmRlZmluZWQnICYmIG9iamVjdCBpbnN0YW5jZW9mIEJsb2IpOwp9Owp9LHt9XSw1MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIHNpbXBsaWZpZWQgQVBJLiB1bml2ZXJzYWwgYnJvd3NlciBzdXBwb3J0IGlzIGFzc3VtZWQKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoYmxvYiwgY2FsbGJhY2spIHsKICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsKICByZWFkZXIub25sb2FkZW5kID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciByZXN1bHQgPSBlLnRhcmdldC5yZXN1bHQgfHwgbmV3IEFycmF5QnVmZmVyKDApOwogICAgY2FsbGJhY2socmVzdWx0KTsKICB9OwogIHJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihibG9iKTsKfTsKfSx7fV0sNTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgYXJyYXlCdWZmZXJUb0JpbmFyeVN0cmluZyA9IHJlcXVpcmUoJy4vYXJyYXlCdWZmZXJUb0JpbmFyeVN0cmluZycpOwoKLy8gc2hpbSBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBzdXBwb3J0IGl0Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKGJsb2IsIGNhbGxiYWNrKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7CiAgdmFyIGhhc0JpbmFyeVN0cmluZyA9IHR5cGVvZiByZWFkZXIucmVhZEFzQmluYXJ5U3RyaW5nID09PSAnZnVuY3Rpb24nOwogIHJlYWRlci5vbmxvYWRlbmQgPSBmdW5jdGlvbiAoZSkgewogICAgdmFyIHJlc3VsdCA9IGUudGFyZ2V0LnJlc3VsdCB8fCAnJzsKICAgIGlmIChoYXNCaW5hcnlTdHJpbmcpIHsKICAgICAgcmV0dXJuIGNhbGxiYWNrKHJlc3VsdCk7CiAgICB9CiAgICBjYWxsYmFjayhhcnJheUJ1ZmZlclRvQmluYXJ5U3RyaW5nKHJlc3VsdCkpOwogIH07CiAgaWYgKGhhc0JpbmFyeVN0cmluZykgewogICAgcmVhZGVyLnJlYWRBc0JpbmFyeVN0cmluZyhibG9iKTsKICB9IGVsc2UgewogICAgcmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKGJsb2IpOwogIH0KfTsKfSx7Ii4vYXJyYXlCdWZmZXJUb0JpbmFyeVN0cmluZyI6NDB9XSw1MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBwaWNrID0gcmVxdWlyZSgnLi4vZGVwcy9waWNrJyk7CgovLyBzaGltIGZvciBQL0NvdWNoREIgYWRhcHRlcnMgdGhhdCBkb24ndCBkaXJlY3RseSBpbXBsZW1lbnQgX2J1bGtfZ2V0CmZ1bmN0aW9uIGJ1bGtHZXQoZGIsIG9wdHMsIGNhbGxiYWNrKSB7CiAgdmFyIHJlcXVlc3RzID0gQXJyYXkuaXNBcnJheShvcHRzKSA/IG9wdHMgOiBvcHRzLmRvY3M7CiAgaWYgKCFyZXF1ZXN0cy5sZW5ndGgpIHsKICAgIHJldHVybiBjYWxsYmFjayhudWxsLCB7cmVzdWx0czogW119KTsKICB9CgogIC8vIGNvbnNvbGlkYXRlIGludG8gb25lIHJlcXVlc3QgcGVyIGRvYyBpZiBwb3NzaWJsZQogIHZhciByZXF1ZXN0c0J5SWQgPSB7fTsKICByZXF1ZXN0cy5mb3JFYWNoKGZ1bmN0aW9uIChyZXF1ZXN0KSB7CiAgICBpZiAocmVxdWVzdC5pZCBpbiByZXF1ZXN0c0J5SWQpIHsKICAgICAgcmVxdWVzdHNCeUlkW3JlcXVlc3QuaWRdLnB1c2gocmVxdWVzdCk7CiAgICB9IGVsc2UgewogICAgICByZXF1ZXN0c0J5SWRbcmVxdWVzdC5pZF0gPSBbcmVxdWVzdF07CiAgICB9CiAgfSk7CgogIHZhciBudW1Eb2NzID0gT2JqZWN0LmtleXMocmVxdWVzdHNCeUlkKS5sZW5ndGg7CiAgdmFyIG51bURvbmUgPSAwOwogIHZhciBwZXJEb2NSZXN1bHRzID0gbmV3IEFycmF5KG51bURvY3MpOwoKICBmdW5jdGlvbiBjb2xsYXBzZVJlc3VsdHMoKSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgcGVyRG9jUmVzdWx0cy5mb3JFYWNoKGZ1bmN0aW9uIChyZXMpIHsKICAgICAgcmVzLmRvY3MuZm9yRWFjaChmdW5jdGlvbiAoaW5mbykgewogICAgICAgIHJlc3VsdHMucHVzaCh7CiAgICAgICAgICBpZDogcmVzLmlkLAogICAgICAgICAgZG9jczogW2luZm9dCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSk7CiAgICBjYWxsYmFjayhudWxsLCB7cmVzdWx0czogcmVzdWx0c30pOwogIH0KCiAgZnVuY3Rpb24gY2hlY2tEb25lKCkgewogICAgaWYgKCsrbnVtRG9uZSA9PT0gbnVtRG9jcykgewogICAgICBjb2xsYXBzZVJlc3VsdHMoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdvdFJlc3VsdChpLCBpZCwgZG9jcykgewogICAgcGVyRG9jUmVzdWx0c1tpXSA9IHtpZDogaWQsIGRvY3M6IGRvY3N9OwogICAgY2hlY2tEb25lKCk7CiAgfQoKICBPYmplY3Qua2V5cyhyZXF1ZXN0c0J5SWQpLmZvckVhY2goZnVuY3Rpb24gKGRvY0lkLCBpKSB7CgogICAgdmFyIGRvY1JlcXVlc3RzID0gcmVxdWVzdHNCeUlkW2RvY0lkXTsKCiAgICAvLyBqdXN0IHVzZSB0aGUgZmlyc3QgcmVxdWVzdCBhcyB0aGUgInRlbXBsYXRlIgogICAgLy8gVE9ETzogVGhlIF9idWxrX2dldCBBUEkgYWxsb3dzIGZvciBtb3JlIHN1YnRsZSB1c2UgY2FzZXMgdGhhbiB0aGlzLAogICAgLy8gYnV0IGZvciBub3cgaXQgaXMgdW5saWtlbHkgdGhhdCB0aGVyZSB3aWxsIGJlIGEgbWl4IG9mIGRpZmZlcmVudAogICAgLy8gImF0dHNfc2luY2UiIG9yICJhdHRhY2htZW50cyIgaW4gdGhlIHNhbWUgcmVxdWVzdCwgc2luY2UgaXQncyBqdXN0CiAgICAvLyByZXBsaWNhdGUuanMgdGhhdCBpcyB1c2luZyB0aGlzIGZvciB0aGUgbW9tZW50LgogICAgLy8gQWxzbywgYXR0c19zaW5jZSBpcyBhc3BpcmF0aW9uYWwsIHNpbmNlIHdlIGRvbid0IHN1cHBvcnQgaXQgeWV0LgogICAgdmFyIGRvY09wdHMgPSBwaWNrKGRvY1JlcXVlc3RzWzBdLCBbJ2F0dHNfc2luY2UnLCAnYXR0YWNobWVudHMnXSk7CiAgICBkb2NPcHRzLm9wZW5fcmV2cyA9IGRvY1JlcXVlc3RzLm1hcChmdW5jdGlvbiAocmVxdWVzdCkgewogICAgICAvLyByZXYgaXMgcmVxdWlyZWQsIG9wZW5fcmV2cyBkaXNhbGxvd2VkCiAgICAgIHJldHVybiByZXF1ZXN0LnJldjsKICAgIH0pOwogICAgLy8gZ2xvYmFsbHktc3VwcGxpZWQgb3B0aW9ucwogICAgWydyZXZzJywgJ2F0dGFjaG1lbnRzJywgJ2JpbmFyeSddLmZvckVhY2goZnVuY3Rpb24gKHBhcmFtKSB7CiAgICAgIGlmIChwYXJhbSBpbiBvcHRzKSB7CiAgICAgICAgZG9jT3B0c1twYXJhbV0gPSBvcHRzW3BhcmFtXTsKICAgICAgfQogICAgfSk7CiAgICBkYi5nZXQoZG9jSWQsIGRvY09wdHMsIGZ1bmN0aW9uIChlcnIsIHJlcykgewogICAgICBnb3RSZXN1bHQoaSwgZG9jSWQsIGVyciA/IFt7ZXJyb3I6IGVycn1dIDogcmVzKTsKICAgIH0pOwogIH0pOwp9Cgptb2R1bGUuZXhwb3J0cyA9IGJ1bGtHZXQ7Cn0seyIuLi9kZXBzL3BpY2siOjc4fV0sNTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgaXNCaW5hcnlPYmplY3QgPSByZXF1aXJlKCcuL2JpbmFyeS9pc0JpbmFyeU9iamVjdCcpOwp2YXIgY2xvbmVCaW5hcnlPYmplY3QgPSByZXF1aXJlKCcuL2JpbmFyeS9jbG9uZUJpbmFyeU9iamVjdCcpOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBjbG9uZShvYmplY3QpIHsKICB2YXIgbmV3T2JqZWN0OwogIHZhciBpOwogIHZhciBsZW47CgogIGlmICghb2JqZWN0IHx8IHR5cGVvZiBvYmplY3QgIT09ICdvYmplY3QnKSB7CiAgICByZXR1cm4gb2JqZWN0OwogIH0KCiAgaWYgKEFycmF5LmlzQXJyYXkob2JqZWN0KSkgewogICAgbmV3T2JqZWN0ID0gW107CiAgICBmb3IgKGkgPSAwLCBsZW4gPSBvYmplY3QubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgbmV3T2JqZWN0W2ldID0gY2xvbmUob2JqZWN0W2ldKTsKICAgIH0KICAgIHJldHVybiBuZXdPYmplY3Q7CiAgfQoKICAvLyBzcGVjaWFsIGNhc2U6IHRvIGF2b2lkIGluY29uc2lzdGVuY2llcyBiZXR3ZWVuIEluZGV4ZWREQgogIC8vIGFuZCBvdGhlciBiYWNrZW5kcywgd2UgYXV0b21hdGljYWxseSBzdHJpbmdpZnkgRGF0ZXMKICBpZiAob2JqZWN0IGluc3RhbmNlb2YgRGF0ZSkgewogICAgcmV0dXJuIG9iamVjdC50b0lTT1N0cmluZygpOwogIH0KCiAgaWYgKGlzQmluYXJ5T2JqZWN0KG9iamVjdCkpIHsKICAgIHJldHVybiBjbG9uZUJpbmFyeU9iamVjdChvYmplY3QpOwogIH0KCiAgbmV3T2JqZWN0ID0ge307CiAgZm9yIChpIGluIG9iamVjdCkgewogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGkpKSB7CiAgICAgIHZhciB2YWx1ZSA9IGNsb25lKG9iamVjdFtpXSk7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgbmV3T2JqZWN0W2ldID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIG5ld09iamVjdDsKfTsKCn0seyIuL2JpbmFyeS9jbG9uZUJpbmFyeU9iamVjdCI6NDgsIi4vYmluYXJ5L2lzQmluYXJ5T2JqZWN0Ijo0OX1dLDU0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIHdpbm5pbmdSZXYgPSByZXF1aXJlKCcuLi8uLi9kZXBzL21lcmdlL3dpbm5pbmdSZXYnKTsKCmZ1bmN0aW9uIGdldFRyZWVzKG5vZGUpIHsKICByZXR1cm4gbm9kZS5pZHM7Cn0KCi8vIGNoZWNrIGlmIGEgc3BlY2lmaWMgcmV2aXNpb24gb2YgYSBkb2MgaGFzIGJlZW4gZGVsZXRlZAovLyAgLSBtZXRhZGF0YTogdGhlIG1ldGFkYXRhIG9iamVjdCBmcm9tIHRoZSBkb2Mgc3RvcmUKLy8gIC0gcmV2OiAob3B0aW9uYWwpIHRoZSByZXZpc2lvbiB0byBjaGVjay4gZGVmYXVsdHMgdG8gd2lubmluZyByZXZpc2lvbgpmdW5jdGlvbiBpc0RlbGV0ZWQobWV0YWRhdGEsIHJldikgewogIGlmICghcmV2KSB7CiAgICByZXYgPSB3aW5uaW5nUmV2KG1ldGFkYXRhKTsKICB9CiAgdmFyIGlkID0gcmV2LnN1YnN0cmluZyhyZXYuaW5kZXhPZignLScpICsgMSk7CiAgdmFyIHRvVmlzaXQgPSBtZXRhZGF0YS5yZXZfdHJlZS5tYXAoZ2V0VHJlZXMpOwoKICB2YXIgdHJlZTsKICB3aGlsZSAoKHRyZWUgPSB0b1Zpc2l0LnBvcCgpKSkgewogICAgaWYgKHRyZWVbMF0gPT09IGlkKSB7CiAgICAgIHJldHVybiAhIXRyZWVbMV0uZGVsZXRlZDsKICAgIH0KICAgIHRvVmlzaXQgPSB0b1Zpc2l0LmNvbmNhdCh0cmVlWzJdKTsKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gaXNEZWxldGVkOwp9LHsiLi4vLi4vZGVwcy9tZXJnZS93aW5uaW5nUmV2Ijo3NH1dLDU1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKZnVuY3Rpb24gaXNMb2NhbElkKGlkKSB7CiAgcmV0dXJuICgvXl9sb2NhbC8pLnRlc3QoaWQpOwp9Cgptb2R1bGUuZXhwb3J0cyA9IGlzTG9jYWxJZDsKfSx7fV0sNTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgcGFyc2VEZG9jRnVuY3Rpb25OYW1lID0gcmVxdWlyZSgnLi9wYXJzZURkb2NGdW5jdGlvbk5hbWUnKTsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gbm9ybWFsaXplRGVzaWduRG9jRnVuY3Rpb25OYW1lKHMpIHsKICB2YXIgbm9ybWFsaXplZCA9IHBhcnNlRGRvY0Z1bmN0aW9uTmFtZShzKTsKICByZXR1cm4gbm9ybWFsaXplZCA/IG5vcm1hbGl6ZWQuam9pbignLycpIDogbnVsbDsKfTsKfSx7Ii4vcGFyc2VEZG9jRnVuY3Rpb25OYW1lIjo1N31dLDU3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBwYXJzZURlc2lnbkRvY0Z1bmN0aW9uTmFtZShzKSB7CiAgaWYgKCFzKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHBhcnRzID0gcy5zcGxpdCgnLycpOwogIGlmIChwYXJ0cy5sZW5ndGggPT09IDIpIHsKICAgIHJldHVybiBwYXJ0czsKICB9CiAgaWYgKHBhcnRzLmxlbmd0aCA9PT0gMSkgewogICAgcmV0dXJuIFtzLCBzXTsKICB9CiAgcmV0dXJuIG51bGw7Cn07Cn0se31dLDU4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIGVycm9ycyA9IHJlcXVpcmUoJy4vLi4vZXJyb3JzJyk7CnZhciB1dWlkID0gcmVxdWlyZSgnLi8uLi91dWlkJyk7CgpmdW5jdGlvbiB0b09iamVjdChhcnJheSkgewogIHJldHVybiBhcnJheS5yZWR1Y2UoZnVuY3Rpb24gKG9iaiwgaXRlbSkgewogICAgb2JqW2l0ZW1dID0gdHJ1ZTsKICAgIHJldHVybiBvYmo7CiAgfSwge30pOwp9Ci8vIExpc3Qgb2YgdG9wIGxldmVsIHJlc2VydmVkIHdvcmRzIGZvciBkb2MKdmFyIHJlc2VydmVkV29yZHMgPSB0b09iamVjdChbCiAgJ19pZCcsCiAgJ19yZXYnLAogICdfYXR0YWNobWVudHMnLAogICdfZGVsZXRlZCcsCiAgJ19yZXZpc2lvbnMnLAogICdfcmV2c19pbmZvJywKICAnX2NvbmZsaWN0cycsCiAgJ19kZWxldGVkX2NvbmZsaWN0cycsCiAgJ19sb2NhbF9zZXEnLAogICdfcmV2X3RyZWUnLAogIC8vcmVwbGljYXRpb24gZG9jdW1lbnRzCiAgJ19yZXBsaWNhdGlvbl9pZCcsCiAgJ19yZXBsaWNhdGlvbl9zdGF0ZScsCiAgJ19yZXBsaWNhdGlvbl9zdGF0ZV90aW1lJywKICAnX3JlcGxpY2F0aW9uX3N0YXRlX3JlYXNvbicsCiAgJ19yZXBsaWNhdGlvbl9zdGF0cycsCiAgLy8gU3BlY2lmaWMgdG8gQ291Y2hiYXNlIFN5bmMgR2F0ZXdheQogICdfcmVtb3ZlZCcKXSk7CgovLyBMaXN0IG9mIHJlc2VydmVkIHdvcmRzIHRoYXQgc2hvdWxkIGVuZCB1cCB0aGUgZG9jdW1lbnQKdmFyIGRhdGFXb3JkcyA9IHRvT2JqZWN0KFsKICAnX2F0dGFjaG1lbnRzJywKICAvL3JlcGxpY2F0aW9uIGRvY3VtZW50cwogICdfcmVwbGljYXRpb25faWQnLAogICdfcmVwbGljYXRpb25fc3RhdGUnLAogICdfcmVwbGljYXRpb25fc3RhdGVfdGltZScsCiAgJ19yZXBsaWNhdGlvbl9zdGF0ZV9yZWFzb24nLAogICdfcmVwbGljYXRpb25fc3RhdHMnCl0pOwoKLy8gRGV0ZXJtaW5lIGlkIGFuIElEIGlzIHZhbGlkCi8vICAgLSBpbnZhbGlkIElEcyBiZWdpbiB3aXRoIGFuIHVuZGVyZXNjb3JlIHRoYXQgZG9lcyBub3QgYmVnaW4gJ19kZXNpZ24nIG9yCi8vICAgICAnX2xvY2FsJwovLyAgIC0gYW55IG90aGVyIHN0cmluZyB2YWx1ZSBpcyBhIHZhbGlkIGlkCi8vIFJldHVybnMgdGhlIHNwZWNpZmljIGVycm9yIG9iamVjdCBmb3IgZWFjaCBjYXNlCmV4cG9ydHMuaW52YWxpZElkRXJyb3IgPSBmdW5jdGlvbiAoaWQpIHsKICB2YXIgZXJyOwogIGlmICghaWQpIHsKICAgIGVyciA9IGVycm9ycy5lcnJvcihlcnJvcnMuTUlTU0lOR19JRCk7CiAgfSBlbHNlIGlmICh0eXBlb2YgaWQgIT09ICdzdHJpbmcnKSB7CiAgICBlcnIgPSBlcnJvcnMuZXJyb3IoZXJyb3JzLklOVkFMSURfSUQpOwogIH0gZWxzZSBpZiAoL15fLy50ZXN0KGlkKSAmJiAhKC9eXyhkZXNpZ258bG9jYWwpLykudGVzdChpZCkpIHsKICAgIGVyciA9IGVycm9ycy5lcnJvcihlcnJvcnMuUkVTRVJWRURfSUQpOwogIH0KICBpZiAoZXJyKSB7CiAgICB0aHJvdyBlcnI7CiAgfQp9OwoKZnVuY3Rpb24gcGFyc2VSZXZpc2lvbkluZm8ocmV2KSB7CiAgaWYgKCEvXlxkK1wtLi8udGVzdChyZXYpKSB7CiAgICByZXR1cm4gZXJyb3JzLmVycm9yKGVycm9ycy5JTlZBTElEX1JFVik7CiAgfQogIHZhciBpZHggPSByZXYuaW5kZXhPZignLScpOwogIHZhciBsZWZ0ID0gcmV2LnN1YnN0cmluZygwLCBpZHgpOwogIHZhciByaWdodCA9IHJldi5zdWJzdHJpbmcoaWR4ICsgMSk7CiAgcmV0dXJuIHsKICAgIHByZWZpeDogcGFyc2VJbnQobGVmdCwgMTApLAogICAgaWQ6IHJpZ2h0CiAgfTsKfQoKZnVuY3Rpb24gbWFrZVJldlRyZWVGcm9tUmV2aXNpb25zKHJldmlzaW9ucywgb3B0cykgewogIHZhciBwb3MgPSByZXZpc2lvbnMuc3RhcnQgLSByZXZpc2lvbnMuaWRzLmxlbmd0aCArIDE7CgogIHZhciByZXZpc2lvbklkcyA9IHJldmlzaW9ucy5pZHM7CiAgdmFyIGlkcyA9IFtyZXZpc2lvbklkc1swXSwgb3B0cywgW11dOwoKICBmb3IgKHZhciBpID0gMSwgbGVuID0gcmV2aXNpb25JZHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgIGlkcyA9IFtyZXZpc2lvbklkc1tpXSwge3N0YXR1czogJ21pc3NpbmcnfSwgW2lkc11dOwogIH0KCiAgcmV0dXJuIFt7CiAgICBwb3M6IHBvcywKICAgIGlkczogaWRzCiAgfV07Cn0KCi8vIFByZXByb2Nlc3MgZG9jdW1lbnRzLCBwYXJzZSB0aGVpciByZXZpc2lvbnMsIGFzc2lnbiBhbiBpZCBhbmQgYQovLyByZXZpc2lvbiBmb3IgbmV3IHdyaXRlcyB0aGF0IGFyZSBtaXNzaW5nIHRoZW0sIGV0YwpleHBvcnRzLnBhcnNlRG9jID0gZnVuY3Rpb24gKGRvYywgbmV3RWRpdHMpIHsKCiAgdmFyIG5SZXZOdW07CiAgdmFyIG5ld1JldklkOwogIHZhciByZXZJbmZvOwogIHZhciBvcHRzID0ge3N0YXR1czogJ2F2YWlsYWJsZSd9OwogIGlmIChkb2MuX2RlbGV0ZWQpIHsKICAgIG9wdHMuZGVsZXRlZCA9IHRydWU7CiAgfQoKICBpZiAobmV3RWRpdHMpIHsKICAgIGlmICghZG9jLl9pZCkgewogICAgICBkb2MuX2lkID0gdXVpZCgpOwogICAgfQogICAgbmV3UmV2SWQgPSB1dWlkKDMyLCAxNikudG9Mb3dlckNhc2UoKTsKICAgIGlmIChkb2MuX3JldikgewogICAgICByZXZJbmZvID0gcGFyc2VSZXZpc2lvbkluZm8oZG9jLl9yZXYpOwogICAgICBpZiAocmV2SW5mby5lcnJvcikgewogICAgICAgIHJldHVybiByZXZJbmZvOwogICAgICB9CiAgICAgIGRvYy5fcmV2X3RyZWUgPSBbewogICAgICAgIHBvczogcmV2SW5mby5wcmVmaXgsCiAgICAgICAgaWRzOiBbcmV2SW5mby5pZCwge3N0YXR1czogJ21pc3NpbmcnfSwgW1tuZXdSZXZJZCwgb3B0cywgW11dXV0KICAgICAgfV07CiAgICAgIG5SZXZOdW0gPSByZXZJbmZvLnByZWZpeCArIDE7CiAgICB9IGVsc2UgewogICAgICBkb2MuX3Jldl90cmVlID0gW3sKICAgICAgICBwb3M6IDEsCiAgICAgICAgaWRzIDogW25ld1JldklkLCBvcHRzLCBbXV0KICAgICAgfV07CiAgICAgIG5SZXZOdW0gPSAxOwogICAgfQogIH0gZWxzZSB7CiAgICBpZiAoZG9jLl9yZXZpc2lvbnMpIHsKICAgICAgZG9jLl9yZXZfdHJlZSA9IG1ha2VSZXZUcmVlRnJvbVJldmlzaW9ucyhkb2MuX3JldmlzaW9ucywgb3B0cyk7CiAgICAgIG5SZXZOdW0gPSBkb2MuX3JldmlzaW9ucy5zdGFydDsKICAgICAgbmV3UmV2SWQgPSBkb2MuX3JldmlzaW9ucy5pZHNbMF07CiAgICB9CiAgICBpZiAoIWRvYy5fcmV2X3RyZWUpIHsKICAgICAgcmV2SW5mbyA9IHBhcnNlUmV2aXNpb25JbmZvKGRvYy5fcmV2KTsKICAgICAgaWYgKHJldkluZm8uZXJyb3IpIHsKICAgICAgICByZXR1cm4gcmV2SW5mbzsKICAgICAgfQogICAgICBuUmV2TnVtID0gcmV2SW5mby5wcmVmaXg7CiAgICAgIG5ld1JldklkID0gcmV2SW5mby5pZDsKICAgICAgZG9jLl9yZXZfdHJlZSA9IFt7CiAgICAgICAgcG9zOiBuUmV2TnVtLAogICAgICAgIGlkczogW25ld1JldklkLCBvcHRzLCBbXV0KICAgICAgfV07CiAgICB9CiAgfQoKICBleHBvcnRzLmludmFsaWRJZEVycm9yKGRvYy5faWQpOwoKICBkb2MuX3JldiA9IG5SZXZOdW0gKyAnLScgKyBuZXdSZXZJZDsKCiAgdmFyIHJlc3VsdCA9IHttZXRhZGF0YSA6IHt9LCBkYXRhIDoge319OwogIGZvciAodmFyIGtleSBpbiBkb2MpIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGRvYywga2V5KSkgewogICAgICB2YXIgc3BlY2lhbEtleSA9IGtleVswXSA9PT0gJ18nOwogICAgICBpZiAoc3BlY2lhbEtleSAmJiAhcmVzZXJ2ZWRXb3Jkc1trZXldKSB7CiAgICAgICAgdmFyIGVycm9yID0gZXJyb3JzLmVycm9yKGVycm9ycy5ET0NfVkFMSURBVElPTiwga2V5KTsKICAgICAgICBlcnJvci5tZXNzYWdlID0gZXJyb3JzLkRPQ19WQUxJREFUSU9OLm1lc3NhZ2UgKyAnOiAnICsga2V5OwogICAgICAgIHRocm93IGVycm9yOwogICAgICB9IGVsc2UgaWYgKHNwZWNpYWxLZXkgJiYgIWRhdGFXb3Jkc1trZXldKSB7CiAgICAgICAgcmVzdWx0Lm1ldGFkYXRhW2tleS5zbGljZSgxKV0gPSBkb2Nba2V5XTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHQuZGF0YVtrZXldID0gZG9jW2tleV07CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfTsKCn0seyIuLy4uL2Vycm9ycyI6NjQsIi4vLi4vdXVpZCI6ODJ9XSw1OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBiYXNlNjQgPSByZXF1aXJlKCcuLi9iaW5hcnkvYmFzZTY0Jyk7CnZhciBhcnJheUJ1ZmZUb0JpblN0cmluZyA9IHJlcXVpcmUoJy4uL2JpbmFyeS9hcnJheUJ1ZmZlclRvQmluYXJ5U3RyaW5nJyk7CnZhciByZWFkQXNBcnJheUJ1ZmZlciA9IHJlcXVpcmUoJy4uL2JpbmFyeS9yZWFkQXNBcnJheUJ1ZmZlcicpOwp2YXIgYmluU3RyaW5nVG9CbG9iT3JCdWZmZXIgPSByZXF1aXJlKCcuLi9iaW5hcnkvYmluYXJ5U3RyaW5nVG9CbG9iT3JCdWZmZXInKTsKdmFyIGVycm9ycyA9IHJlcXVpcmUoJy4uL2Vycm9ycycpOwp2YXIgbWQ1ID0gcmVxdWlyZSgnLi4vbWQ1Jyk7CgpmdW5jdGlvbiBwcmVwcm9jZXNzQXR0YWNobWVudHMoZG9jSW5mb3MsIGJsb2JUeXBlLCBjYWxsYmFjaykgewoKICBpZiAoIWRvY0luZm9zLmxlbmd0aCkgewogICAgcmV0dXJuIGNhbGxiYWNrKCk7CiAgfQoKICB2YXIgZG9jdiA9IDA7CgogIGZ1bmN0aW9uIHBhcnNlQmFzZTY0KGRhdGEpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBiYXNlNjQuYXRvYihkYXRhKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgdmFyIGVyciA9IGVycm9ycy5lcnJvcihlcnJvcnMuQkFEX0FSRywKICAgICAgICAnQXR0YWNobWVudHMgbmVlZCB0byBiZSBiYXNlNjQgZW5jb2RlZCcpOwogICAgICByZXR1cm4ge2Vycm9yOiBlcnJ9OwogICAgfQogIH0KCiAgZnVuY3Rpb24gcHJlcHJvY2Vzc0F0dGFjaG1lbnQoYXR0LCBjYWxsYmFjaykgewogICAgaWYgKGF0dC5zdHViKSB7CiAgICAgIHJldHVybiBjYWxsYmFjaygpOwogICAgfQogICAgaWYgKHR5cGVvZiBhdHQuZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgLy8gaW5wdXQgaXMgYSBiYXNlNjQgc3RyaW5nCgogICAgICB2YXIgYXNCaW5hcnkgPSBwYXJzZUJhc2U2NChhdHQuZGF0YSk7CiAgICAgIGlmIChhc0JpbmFyeS5lcnJvcikgewogICAgICAgIHJldHVybiBjYWxsYmFjayhhc0JpbmFyeS5lcnJvcik7CiAgICAgIH0KCiAgICAgIGF0dC5sZW5ndGggPSBhc0JpbmFyeS5sZW5ndGg7CiAgICAgIGlmIChibG9iVHlwZSA9PT0gJ2Jsb2InKSB7CiAgICAgICAgYXR0LmRhdGEgPSBiaW5TdHJpbmdUb0Jsb2JPckJ1ZmZlcihhc0JpbmFyeSwgYXR0LmNvbnRlbnRfdHlwZSk7CiAgICAgIH0gZWxzZSBpZiAoYmxvYlR5cGUgPT09ICdiYXNlNjQnKSB7CiAgICAgICAgYXR0LmRhdGEgPSBiYXNlNjQuYnRvYShhc0JpbmFyeSk7CiAgICAgIH0gZWxzZSB7IC8vIGJpbmFyeQogICAgICAgIGF0dC5kYXRhID0gYXNCaW5hcnk7CiAgICAgIH0KICAgICAgbWQ1KGFzQmluYXJ5KS50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICBhdHQuZGlnZXN0ID0gJ21kNS0nICsgcmVzdWx0OwogICAgICAgIGNhbGxiYWNrKCk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsgLy8gaW5wdXQgaXMgYSBibG9iCiAgICAgIHJlYWRBc0FycmF5QnVmZmVyKGF0dC5kYXRhLCBmdW5jdGlvbiAoYnVmZikgewogICAgICAgIGlmIChibG9iVHlwZSA9PT0gJ2JpbmFyeScpIHsKICAgICAgICAgIGF0dC5kYXRhID0gYXJyYXlCdWZmVG9CaW5TdHJpbmcoYnVmZik7CiAgICAgICAgfSBlbHNlIGlmIChibG9iVHlwZSA9PT0gJ2Jhc2U2NCcpIHsKICAgICAgICAgIGF0dC5kYXRhID0gYmFzZTY0LmJ0b2EoYXJyYXlCdWZmVG9CaW5TdHJpbmcoYnVmZikpOwogICAgICAgIH0KICAgICAgICBtZDUoYnVmZikudGhlbihmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgICBhdHQuZGlnZXN0ID0gJ21kNS0nICsgcmVzdWx0OwogICAgICAgICAgYXR0Lmxlbmd0aCA9IGJ1ZmYuYnl0ZUxlbmd0aDsKICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH0KCiAgdmFyIG92ZXJhbGxFcnI7CgogIGRvY0luZm9zLmZvckVhY2goZnVuY3Rpb24gKGRvY0luZm8pIHsKICAgIHZhciBhdHRhY2htZW50cyA9IGRvY0luZm8uZGF0YSAmJiBkb2NJbmZvLmRhdGEuX2F0dGFjaG1lbnRzID8KICAgICAgT2JqZWN0LmtleXMoZG9jSW5mby5kYXRhLl9hdHRhY2htZW50cykgOiBbXTsKICAgIHZhciByZWN2ID0gMDsKCiAgICBpZiAoIWF0dGFjaG1lbnRzLmxlbmd0aCkgewogICAgICByZXR1cm4gZG9uZSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHByb2Nlc3NlZEF0dGFjaG1lbnQoZXJyKSB7CiAgICAgIG92ZXJhbGxFcnIgPSBlcnI7CiAgICAgIHJlY3YrKzsKICAgICAgaWYgKHJlY3YgPT09IGF0dGFjaG1lbnRzLmxlbmd0aCkgewogICAgICAgIGRvbmUoKTsKICAgICAgfQogICAgfQoKICAgIGZvciAodmFyIGtleSBpbiBkb2NJbmZvLmRhdGEuX2F0dGFjaG1lbnRzKSB7CiAgICAgIGlmIChkb2NJbmZvLmRhdGEuX2F0dGFjaG1lbnRzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICBwcmVwcm9jZXNzQXR0YWNobWVudChkb2NJbmZvLmRhdGEuX2F0dGFjaG1lbnRzW2tleV0sCiAgICAgICAgICBwcm9jZXNzZWRBdHRhY2htZW50KTsKICAgICAgfQogICAgfQogIH0pOwoKICBmdW5jdGlvbiBkb25lKCkgewogICAgZG9jdisrOwogICAgaWYgKGRvY0luZm9zLmxlbmd0aCA9PT0gZG9jdikgewogICAgICBpZiAob3ZlcmFsbEVycikgewogICAgICAgIGNhbGxiYWNrKG92ZXJhbGxFcnIpOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrKCk7CiAgICAgIH0KICAgIH0KICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gcHJlcHJvY2Vzc0F0dGFjaG1lbnRzOwp9LHsiLi4vYmluYXJ5L2FycmF5QnVmZmVyVG9CaW5hcnlTdHJpbmciOjQwLCIuLi9iaW5hcnkvYmFzZTY0Ijo0MSwiLi4vYmluYXJ5L2JpbmFyeVN0cmluZ1RvQmxvYk9yQnVmZmVyIjo0NCwiLi4vYmluYXJ5L3JlYWRBc0FycmF5QnVmZmVyIjo1MCwiLi4vZXJyb3JzIjo2NCwiLi4vbWQ1Ijo2N31dLDYwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIGVycm9ycyA9IHJlcXVpcmUoJy4uL2Vycm9ycycpOwp2YXIgdXBkYXRlRG9jID0gcmVxdWlyZSgnLi91cGRhdGVEb2MnKTsKdmFyIGlzRGVsZXRlZCA9IHJlcXVpcmUoJy4vaXNEZWxldGVkJyk7CnZhciBpc0xvY2FsSWQgPSByZXF1aXJlKCcuL2lzTG9jYWxJZCcpOwp2YXIgY2FsY3VsYXRlV2lubmluZ1JldiA9IHJlcXVpcmUoJy4uLy4uL2RlcHMvbWVyZ2Uvd2lubmluZ1JldicpOwp2YXIgbWVyZ2UgPSByZXF1aXJlKCcuLi8uLi9kZXBzL21lcmdlJyk7CnZhciBjb2xsZWN0aW9ucyA9IHJlcXVpcmUoJ3BvdWNoZGItY29sbGVjdGlvbnMnKTsKdmFyIE1hcCA9IGNvbGxlY3Rpb25zLk1hcDsKCmZ1bmN0aW9uIHByb2Nlc3NEb2NzKGRvY0luZm9zLCBhcGksIGZldGNoZWREb2NzLCB0eCwgcmVzdWx0cywgd3JpdGVEb2MsIG9wdHMsCiAgICAgICAgICAgICAgICAgICAgIG92ZXJhbGxDYWxsYmFjaykgewoKICBmdW5jdGlvbiBpbnNlcnREb2MoZG9jSW5mbywgcmVzdWx0c0lkeCwgY2FsbGJhY2spIHsKICAgIC8vIENhbnQgaW5zZXJ0IG5ldyBkZWxldGVkIGRvY3VtZW50cwogICAgdmFyIHdpbm5pbmdSZXYgPSBjYWxjdWxhdGVXaW5uaW5nUmV2KGRvY0luZm8ubWV0YWRhdGEpOwogICAgdmFyIGRlbGV0ZWQgPSBpc0RlbGV0ZWQoZG9jSW5mby5tZXRhZGF0YSwgd2lubmluZ1Jldik7CiAgICBpZiAoJ3dhc19kZWxldGUnIGluIG9wdHMgJiYgZGVsZXRlZCkgewogICAgICByZXN1bHRzW3Jlc3VsdHNJZHhdID0gZXJyb3JzLmVycm9yKGVycm9ycy5NSVNTSU5HX0RPQywgJ2RlbGV0ZWQnKTsKICAgICAgcmV0dXJuIGNhbGxiYWNrKCk7CiAgICB9CgogICAgdmFyIGRlbHRhID0gZGVsZXRlZCA/IDAgOiAxOwoKICAgIHdyaXRlRG9jKGRvY0luZm8sIHdpbm5pbmdSZXYsIGRlbGV0ZWQsIGRlbGV0ZWQsIGZhbHNlLAogICAgICBkZWx0YSwgcmVzdWx0c0lkeCwgY2FsbGJhY2spOwogIH0KCiAgdmFyIG5ld0VkaXRzID0gb3B0cy5uZXdfZWRpdHM7CiAgdmFyIGlkc1RvRG9jcyA9IG5ldyBNYXAoKTsKCiAgdmFyIGRvY3NEb25lID0gMDsKICB2YXIgZG9jc1RvRG8gPSBkb2NJbmZvcy5sZW5ndGg7CgogIGZ1bmN0aW9uIGNoZWNrQWxsRG9jc0RvbmUoKSB7CiAgICBpZiAoKytkb2NzRG9uZSA9PT0gZG9jc1RvRG8gJiYgb3ZlcmFsbENhbGxiYWNrKSB7CiAgICAgIG92ZXJhbGxDYWxsYmFjaygpOwogICAgfQogIH0KCiAgZG9jSW5mb3MuZm9yRWFjaChmdW5jdGlvbiAoY3VycmVudERvYywgcmVzdWx0c0lkeCkgewoKICAgIGlmIChjdXJyZW50RG9jLl9pZCAmJiBpc0xvY2FsSWQoY3VycmVudERvYy5faWQpKSB7CiAgICAgIGFwaVtjdXJyZW50RG9jLl9kZWxldGVkID8gJ19yZW1vdmVMb2NhbCcgOiAnX3B1dExvY2FsJ10oCiAgICAgICAgY3VycmVudERvYywge2N0eDogdHh9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHJlc3VsdHNbcmVzdWx0c0lkeF0gPSBlcnI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHRzW3Jlc3VsdHNJZHhdID0ge29rOiB0cnVlfTsKICAgICAgICAgIH0KICAgICAgICAgIGNoZWNrQWxsRG9jc0RvbmUoKTsKICAgICAgICB9KTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBpZCA9IGN1cnJlbnREb2MubWV0YWRhdGEuaWQ7CiAgICBpZiAoaWRzVG9Eb2NzLmhhcyhpZCkpIHsKICAgICAgZG9jc1RvRG8tLTsgLy8gZHVwbGljYXRlCiAgICAgIGlkc1RvRG9jcy5nZXQoaWQpLnB1c2goW2N1cnJlbnREb2MsIHJlc3VsdHNJZHhdKTsKICAgIH0gZWxzZSB7CiAgICAgIGlkc1RvRG9jcy5zZXQoaWQsIFtbY3VycmVudERvYywgcmVzdWx0c0lkeF1dKTsKICAgIH0KICB9KTsKCiAgLy8gaW4gdGhlIGNhc2Ugb2YgbmV3X2VkaXRzLCB0aGUgdXNlciBjYW4gcHJvdmlkZSBtdWx0aXBsZSBkb2NzCiAgLy8gd2l0aCB0aGUgc2FtZSBpZC4gdGhlc2UgbmVlZCB0byBiZSBwcm9jZXNzZWQgc2VxdWVudGlhbGx5CiAgaWRzVG9Eb2NzLmZvckVhY2goZnVuY3Rpb24gKGRvY3MsIGlkKSB7CiAgICB2YXIgbnVtRG9uZSA9IDA7CgogICAgZnVuY3Rpb24gZG9jV3JpdHRlbigpIHsKICAgICAgaWYgKCsrbnVtRG9uZSA8IGRvY3MubGVuZ3RoKSB7CiAgICAgICAgbmV4dERvYygpOwogICAgICB9IGVsc2UgewogICAgICAgIGNoZWNrQWxsRG9jc0RvbmUoKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gbmV4dERvYygpIHsKICAgICAgdmFyIHZhbHVlID0gZG9jc1tudW1Eb25lXTsKICAgICAgdmFyIGN1cnJlbnREb2MgPSB2YWx1ZVswXTsKICAgICAgdmFyIHJlc3VsdHNJZHggPSB2YWx1ZVsxXTsKCiAgICAgIGlmIChmZXRjaGVkRG9jcy5oYXMoaWQpKSB7CiAgICAgICAgdXBkYXRlRG9jKGZldGNoZWREb2NzLmdldChpZCksIGN1cnJlbnREb2MsIHJlc3VsdHMsCiAgICAgICAgICByZXN1bHRzSWR4LCBkb2NXcml0dGVuLCB3cml0ZURvYywgbmV3RWRpdHMpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIEVuc3VyZSBzdGVtbWluZyBhcHBsaWVzIHRvIG5ldyB3cml0ZXMgYXMgd2VsbAogICAgICAgIHZhciBtZXJnZWQgPSBtZXJnZShbXSwgY3VycmVudERvYy5tZXRhZGF0YS5yZXZfdHJlZVswXSwgMTAwMCk7CiAgICAgICAgY3VycmVudERvYy5tZXRhZGF0YS5yZXZfdHJlZSA9IG1lcmdlZC50cmVlOwogICAgICAgIGluc2VydERvYyhjdXJyZW50RG9jLCByZXN1bHRzSWR4LCBkb2NXcml0dGVuKTsKICAgICAgfQogICAgfQogICAgbmV4dERvYygpOwogIH0pOwp9Cgptb2R1bGUuZXhwb3J0cyA9IHByb2Nlc3NEb2NzOwoKfSx7Ii4uLy4uL2RlcHMvbWVyZ2UiOjcwLCIuLi8uLi9kZXBzL21lcmdlL3dpbm5pbmdSZXYiOjc0LCIuLi9lcnJvcnMiOjY0LCIuL2lzRGVsZXRlZCI6NTQsIi4vaXNMb2NhbElkIjo1NSwiLi91cGRhdGVEb2MiOjYxLCJwb3VjaGRiLWNvbGxlY3Rpb25zIjoxMDh9XSw2MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBlcnJvcnMgPSByZXF1aXJlKCcuLi9lcnJvcnMnKTsKdmFyIGlzRGVsZXRlZCA9IHJlcXVpcmUoJy4vaXNEZWxldGVkJyk7CnZhciBwYXJzZURvYyA9IHJlcXVpcmUoJy4vcGFyc2VEb2MnKS5wYXJzZURvYzsKdmFyIGNhbGN1bGF0ZVdpbm5pbmdSZXYgPSByZXF1aXJlKCcuLi8uLi9kZXBzL21lcmdlL3dpbm5pbmdSZXYnKTsKdmFyIG1lcmdlID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9tZXJnZScpOwp2YXIgcmV2RXhpc3RzID0gcmVxdWlyZSgnLi4vLi4vZGVwcy9tZXJnZS9yZXZFeGlzdHMnKTsKCmZ1bmN0aW9uIHVwZGF0ZURvYyhwcmV2LCBkb2NJbmZvLCByZXN1bHRzLCBpLCBjYiwgd3JpdGVEb2MsIG5ld0VkaXRzKSB7CgogIGlmIChyZXZFeGlzdHMocHJldi5yZXZfdHJlZSwgZG9jSW5mby5tZXRhZGF0YS5yZXYpKSB7CiAgICByZXN1bHRzW2ldID0gZG9jSW5mbzsKICAgIHJldHVybiBjYigpOwogIH0KCiAgLy8gc29tZXRpbWVzIHRoaXMgaXMgcHJlLWNhbGN1bGF0ZWQuIGhpc3RvcmljYWxseSBub3QgYWx3YXlzCiAgdmFyIHByZXZpb3VzV2lubmluZ1JldiA9IHByZXYud2lubmluZ1JldiB8fCBjYWxjdWxhdGVXaW5uaW5nUmV2KHByZXYpOwogIHZhciBwcmV2aW91c2x5RGVsZXRlZCA9ICdkZWxldGVkJyBpbiBwcmV2ID8gcHJldi5kZWxldGVkIDoKICAgIGlzRGVsZXRlZChwcmV2LCBwcmV2aW91c1dpbm5pbmdSZXYpOwogIHZhciBkZWxldGVkID0gJ2RlbGV0ZWQnIGluIGRvY0luZm8ubWV0YWRhdGEgPyBkb2NJbmZvLm1ldGFkYXRhLmRlbGV0ZWQgOgogICAgaXNEZWxldGVkKGRvY0luZm8ubWV0YWRhdGEpOwogIHZhciBpc1Jvb3QgPSAvXjEtLy50ZXN0KGRvY0luZm8ubWV0YWRhdGEucmV2KTsKCiAgaWYgKHByZXZpb3VzbHlEZWxldGVkICYmICFkZWxldGVkICYmIG5ld0VkaXRzICYmIGlzUm9vdCkgewogICAgdmFyIG5ld0RvYyA9IGRvY0luZm8uZGF0YTsKICAgIG5ld0RvYy5fcmV2ID0gcHJldmlvdXNXaW5uaW5nUmV2OwogICAgbmV3RG9jLl9pZCA9IGRvY0luZm8ubWV0YWRhdGEuaWQ7CiAgICBkb2NJbmZvID0gcGFyc2VEb2MobmV3RG9jLCBuZXdFZGl0cyk7CiAgfQoKICB2YXIgbWVyZ2VkID0gbWVyZ2UocHJldi5yZXZfdHJlZSwgZG9jSW5mby5tZXRhZGF0YS5yZXZfdHJlZVswXSwgMTAwMCk7CgogIHZhciBpbkNvbmZsaWN0ID0gbmV3RWRpdHMgJiYgKCgocHJldmlvdXNseURlbGV0ZWQgJiYgZGVsZXRlZCkgfHwKICAgICghcHJldmlvdXNseURlbGV0ZWQgJiYgbWVyZ2VkLmNvbmZsaWN0cyAhPT0gJ25ld19sZWFmJykgfHwKICAgIChwcmV2aW91c2x5RGVsZXRlZCAmJiAhZGVsZXRlZCAmJiBtZXJnZWQuY29uZmxpY3RzID09PSAnbmV3X2JyYW5jaCcpKSk7CgogIGlmIChpbkNvbmZsaWN0KSB7CiAgICB2YXIgZXJyID0gZXJyb3JzLmVycm9yKGVycm9ycy5SRVZfQ09ORkxJQ1QpOwogICAgcmVzdWx0c1tpXSA9IGVycjsKICAgIHJldHVybiBjYigpOwogIH0KCiAgdmFyIG5ld1JldiA9IGRvY0luZm8ubWV0YWRhdGEucmV2OwogIGRvY0luZm8ubWV0YWRhdGEucmV2X3RyZWUgPSBtZXJnZWQudHJlZTsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogIGlmIChwcmV2LnJldl9tYXApIHsKICAgIGRvY0luZm8ubWV0YWRhdGEucmV2X21hcCA9IHByZXYucmV2X21hcDsgLy8gdXNlZCBvbmx5IGJ5IGxldmVsZGIKICB9CgogIC8vIHJlY2FsY3VsYXRlCiAgdmFyIHdpbm5pbmdSZXYgPSBjYWxjdWxhdGVXaW5uaW5nUmV2KGRvY0luZm8ubWV0YWRhdGEpOwogIHZhciB3aW5uaW5nUmV2SXNEZWxldGVkID0gaXNEZWxldGVkKGRvY0luZm8ubWV0YWRhdGEsIHdpbm5pbmdSZXYpOwoKICAvLyBjYWxjdWxhdGUgdGhlIHRvdGFsIG51bWJlciBvZiBkb2N1bWVudHMgdGhhdCB3ZXJlIGFkZGVkL3JlbW92ZWQsCiAgLy8gZnJvbSB0aGUgcGVyc3BlY3RpdmUgb2YgdG90YWxfcm93cy9kb2NfY291bnQKICB2YXIgZGVsdGEgPSAocHJldmlvdXNseURlbGV0ZWQgPT09IHdpbm5pbmdSZXZJc0RlbGV0ZWQpID8gMCA6CiAgICBwcmV2aW91c2x5RGVsZXRlZCA8IHdpbm5pbmdSZXZJc0RlbGV0ZWQgPyAtMSA6IDE7CgogIHZhciBuZXdSZXZJc0RlbGV0ZWQ7CiAgaWYgKG5ld1JldiA9PT0gd2lubmluZ1JldikgewogICAgLy8gaWYgdGhlIG5ldyByZXYgaXMgdGhlIHNhbWUgYXMgdGhlIHdpbm5pbmcgcmV2LCB3ZSBjYW4gcmV1c2UgdGhhdCB2YWx1ZQogICAgbmV3UmV2SXNEZWxldGVkID0gd2lubmluZ1JldklzRGVsZXRlZDsKICB9IGVsc2UgewogICAgLy8gaWYgdGhleSdyZSBub3QgdGhlIHNhbWUsIHRoZW4gd2UgbmVlZCB0byByZWNhbGN1bGF0ZQogICAgbmV3UmV2SXNEZWxldGVkID0gaXNEZWxldGVkKGRvY0luZm8ubWV0YWRhdGEsIG5ld1Jldik7CiAgfQoKICB3cml0ZURvYyhkb2NJbmZvLCB3aW5uaW5nUmV2LCB3aW5uaW5nUmV2SXNEZWxldGVkLCBuZXdSZXZJc0RlbGV0ZWQsCiAgICB0cnVlLCBkZWx0YSwgaSwgY2IpOwp9Cgptb2R1bGUuZXhwb3J0cyA9IHVwZGF0ZURvYzsKfSx7Ii4uLy4uL2RlcHMvbWVyZ2UiOjcwLCIuLi8uLi9kZXBzL21lcmdlL3JldkV4aXN0cyI6NzEsIi4uLy4uL2RlcHMvbWVyZ2Uvd2lubmluZ1JldiI6NzQsIi4uL2Vycm9ycyI6NjQsIi4vaXNEZWxldGVkIjo1NCwiLi9wYXJzZURvYyI6NTh9XSw2MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBpc0Nocm9tZUFwcCA9IHJlcXVpcmUoJy4vaXNDaHJvbWVBcHAnKTsKCnZhciBoYXNMb2NhbDsKCmlmIChpc0Nocm9tZUFwcCgpKSB7CiAgaGFzTG9jYWwgPSBmYWxzZTsKfSBlbHNlIHsKICB0cnkgewogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ19wb3VjaF9jaGVja19sb2NhbHN0b3JhZ2UnLCAxKTsKICAgIGhhc0xvY2FsID0gISFsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnX3BvdWNoX2NoZWNrX2xvY2Fsc3RvcmFnZScpOwogIH0gY2F0Y2ggKGUpIHsKICAgIGhhc0xvY2FsID0gZmFsc2U7CiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGhhc0xvY2FsU3RvcmFnZSgpIHsKICByZXR1cm4gaGFzTG9jYWw7Cn07Cn0seyIuL2lzQ2hyb21lQXBwIjo2M31dLDYzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpc0Nocm9tZUFwcCgpIHsKICByZXR1cm4gKHR5cGVvZiBjaHJvbWUgIT09ICJ1bmRlZmluZWQiICYmCiAgICB0eXBlb2YgY2hyb21lLnN0b3JhZ2UgIT09ICJ1bmRlZmluZWQiICYmCiAgICB0eXBlb2YgY2hyb21lLnN0b3JhZ2UubG9jYWwgIT09ICJ1bmRlZmluZWQiKTsKfTsKfSx7fV0sNjQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7Cgp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwppbmhlcml0cyhQb3VjaEVycm9yLCBFcnJvcik7CgpmdW5jdGlvbiBQb3VjaEVycm9yKG9wdHMpIHsKICBFcnJvci5jYWxsKHRoaXMsIG9wdHMucmVhc29uKTsKICB0aGlzLnN0YXR1cyA9IG9wdHMuc3RhdHVzOwogIHRoaXMubmFtZSA9IG9wdHMuZXJyb3I7CiAgdGhpcy5tZXNzYWdlID0gb3B0cy5yZWFzb247CiAgdGhpcy5lcnJvciA9IHRydWU7Cn0KClBvdWNoRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBKU09OLnN0cmluZ2lmeSh7CiAgICBzdGF0dXM6IHRoaXMuc3RhdHVzLAogICAgbmFtZTogdGhpcy5uYW1lLAogICAgbWVzc2FnZTogdGhpcy5tZXNzYWdlLAogICAgcmVhc29uOiB0aGlzLnJlYXNvbgogIH0pOwp9OwoKZXhwb3J0cy5VTkFVVEhPUklaRUQgPSBuZXcgUG91Y2hFcnJvcih7CiAgc3RhdHVzOiA0MDEsCiAgZXJyb3I6ICd1bmF1dGhvcml6ZWQnLAogIHJlYXNvbjogIk5hbWUgb3IgcGFzc3dvcmQgaXMgaW5jb3JyZWN0LiIKfSk7CgpleHBvcnRzLk1JU1NJTkdfQlVMS19ET0NTID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNDAwLAogIGVycm9yOiAnYmFkX3JlcXVlc3QnLAogIHJlYXNvbjogIk1pc3NpbmcgSlNPTiBsaXN0IG9mICdkb2NzJyIKfSk7CgpleHBvcnRzLk1JU1NJTkdfRE9DID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNDA0LAogIGVycm9yOiAnbm90X2ZvdW5kJywKICByZWFzb246ICdtaXNzaW5nJwp9KTsKCmV4cG9ydHMuUkVWX0NPTkZMSUNUID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNDA5LAogIGVycm9yOiAnY29uZmxpY3QnLAogIHJlYXNvbjogJ0RvY3VtZW50IHVwZGF0ZSBjb25mbGljdCcKfSk7CgpleHBvcnRzLklOVkFMSURfSUQgPSBuZXcgUG91Y2hFcnJvcih7CiAgc3RhdHVzOiA0MDAsCiAgZXJyb3I6ICdpbnZhbGlkX2lkJywKICByZWFzb246ICdfaWQgZmllbGQgbXVzdCBjb250YWluIGEgc3RyaW5nJwp9KTsKCmV4cG9ydHMuTUlTU0lOR19JRCA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDQxMiwKICBlcnJvcjogJ21pc3NpbmdfaWQnLAogIHJlYXNvbjogJ19pZCBpcyByZXF1aXJlZCBmb3IgcHV0cycKfSk7CgpleHBvcnRzLlJFU0VSVkVEX0lEID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNDAwLAogIGVycm9yOiAnYmFkX3JlcXVlc3QnLAogIHJlYXNvbjogJ09ubHkgcmVzZXJ2ZWQgZG9jdW1lbnQgaWRzIG1heSBzdGFydCB3aXRoIHVuZGVyc2NvcmUuJwp9KTsKCmV4cG9ydHMuTk9UX09QRU4gPSBuZXcgUG91Y2hFcnJvcih7CiAgc3RhdHVzOiA0MTIsCiAgZXJyb3I6ICdwcmVjb25kaXRpb25fZmFpbGVkJywKICByZWFzb246ICdEYXRhYmFzZSBub3Qgb3BlbicKfSk7CgpleHBvcnRzLlVOS05PV05fRVJST1IgPSBuZXcgUG91Y2hFcnJvcih7CiAgc3RhdHVzOiA1MDAsCiAgZXJyb3I6ICd1bmtub3duX2Vycm9yJywKICByZWFzb246ICdEYXRhYmFzZSBlbmNvdW50ZXJlZCBhbiB1bmtub3duIGVycm9yJwp9KTsKCmV4cG9ydHMuQkFEX0FSRyA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDUwMCwKICBlcnJvcjogJ2JhZGFyZycsCiAgcmVhc29uOiAnU29tZSBxdWVyeSBhcmd1bWVudCBpcyBpbnZhbGlkJwp9KTsKCmV4cG9ydHMuSU5WQUxJRF9SRVFVRVNUID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNDAwLAogIGVycm9yOiAnaW52YWxpZF9yZXF1ZXN0JywKICByZWFzb246ICdSZXF1ZXN0IHdhcyBpbnZhbGlkJwp9KTsKCmV4cG9ydHMuUVVFUllfUEFSU0VfRVJST1IgPSBuZXcgUG91Y2hFcnJvcih7CiAgc3RhdHVzOiA0MDAsCiAgZXJyb3I6ICdxdWVyeV9wYXJzZV9lcnJvcicsCiAgcmVhc29uOiAnU29tZSBxdWVyeSBwYXJhbWV0ZXIgaXMgaW52YWxpZCcKfSk7CgpleHBvcnRzLkRPQ19WQUxJREFUSU9OID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNTAwLAogIGVycm9yOiAnZG9jX3ZhbGlkYXRpb24nLAogIHJlYXNvbjogJ0JhZCBzcGVjaWFsIGRvY3VtZW50IG1lbWJlcicKfSk7CgpleHBvcnRzLkJBRF9SRVFVRVNUID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNDAwLAogIGVycm9yOiAnYmFkX3JlcXVlc3QnLAogIHJlYXNvbjogJ1NvbWV0aGluZyB3cm9uZyB3aXRoIHRoZSByZXF1ZXN0Jwp9KTsKCmV4cG9ydHMuTk9UX0FOX09CSkVDVCA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDQwMCwKICBlcnJvcjogJ2JhZF9yZXF1ZXN0JywKICByZWFzb246ICdEb2N1bWVudCBtdXN0IGJlIGEgSlNPTiBvYmplY3QnCn0pOwoKZXhwb3J0cy5EQl9NSVNTSU5HID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNDA0LAogIGVycm9yOiAnbm90X2ZvdW5kJywKICByZWFzb246ICdEYXRhYmFzZSBub3QgZm91bmQnCn0pOwoKZXhwb3J0cy5JREJfRVJST1IgPSBuZXcgUG91Y2hFcnJvcih7CiAgc3RhdHVzOiA1MDAsCiAgZXJyb3I6ICdpbmRleGVkX2RiX3dlbnRfYmFkJywKICByZWFzb246ICd1bmtub3duJwp9KTsKCmV4cG9ydHMuV1NRX0VSUk9SID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNTAwLAogIGVycm9yOiAnd2ViX3NxbF93ZW50X2JhZCcsCiAgcmVhc29uOiAndW5rbm93bicKfSk7CgpleHBvcnRzLkxEQl9FUlJPUiA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDUwMCwKICBlcnJvcjogJ2xldmVsREJfd2VudF93ZW50X2JhZCcsCiAgcmVhc29uOiAndW5rbm93bicKfSk7CgpleHBvcnRzLkZPUkJJRERFTiA9IG5ldyBQb3VjaEVycm9yKHsKICBzdGF0dXM6IDQwMywKICBlcnJvcjogJ2ZvcmJpZGRlbicsCiAgcmVhc29uOiAnRm9yYmlkZGVuIGJ5IGRlc2lnbiBkb2MgdmFsaWRhdGVfZG9jX3VwZGF0ZSBmdW5jdGlvbicKfSk7CgpleHBvcnRzLklOVkFMSURfUkVWID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNDAwLAogIGVycm9yOiAnYmFkX3JlcXVlc3QnLAogIHJlYXNvbjogJ0ludmFsaWQgcmV2IGZvcm1hdCcKfSk7CgpleHBvcnRzLkZJTEVfRVhJU1RTID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNDEyLAogIGVycm9yOiAnZmlsZV9leGlzdHMnLAogIHJlYXNvbjogJ1RoZSBkYXRhYmFzZSBjb3VsZCBub3QgYmUgY3JlYXRlZCwgdGhlIGZpbGUgYWxyZWFkeSBleGlzdHMuJwp9KTsKCmV4cG9ydHMuTUlTU0lOR19TVFVCID0gbmV3IFBvdWNoRXJyb3IoewogIHN0YXR1czogNDEyLAogIGVycm9yOiAnbWlzc2luZ19zdHViJwp9KTsKCmV4cG9ydHMuZXJyb3IgPSBmdW5jdGlvbiAoZXJyb3IsIHJlYXNvbiwgbmFtZSkgewogIGZ1bmN0aW9uIEN1c3RvbVBvdWNoRXJyb3IocmVhc29uKSB7CiAgICAvLyBpbmhlcml0IGVycm9yIHByb3BlcnRpZXMgZnJvbSBvdXIgcGFyZW50IGVycm9yIG1hbnVhbGx5CiAgICAvLyBzbyBhcyB0byBhbGxvdyBwcm9wZXIgSlNPTiBwYXJzaW5nLgogICAgLyoganNoaW50IGlnbm9yZTpzdGFydCAqLwogICAgZm9yICh2YXIgcCBpbiBlcnJvcikgewogICAgICBpZiAodHlwZW9mIGVycm9yW3BdICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhpc1twXSA9IGVycm9yW3BdOwogICAgICB9CiAgICB9CiAgICAvKiBqc2hpbnQgaWdub3JlOmVuZCAqLwogICAgaWYgKG5hbWUgIT09IHVuZGVmaW5lZCkgewogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgfQogICAgaWYgKHJlYXNvbiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHRoaXMucmVhc29uID0gcmVhc29uOwogICAgfQogIH0KICBDdXN0b21Qb3VjaEVycm9yLnByb3RvdHlwZSA9IFBvdWNoRXJyb3IucHJvdG90eXBlOwogIHJldHVybiBuZXcgQ3VzdG9tUG91Y2hFcnJvcihyZWFzb24pOwp9OwoKLy8gRmluZCBvbmUgb2YgdGhlIGVycm9ycyBkZWZpbmVkIGFib3ZlIGJhc2VkIG9uIHRoZSB2YWx1ZQovLyBvZiB0aGUgc3BlY2lmaWVkIHByb3BlcnR5LgovLyBJZiByZWFzb24gaXMgcHJvdmlkZWQgcHJlZmVyIHRoZSBlcnJvciBtYXRjaGluZyB0aGF0IHJlYXNvbi4KLy8gVGhpcyBpcyBmb3IgZGlmZmVyZW50aWF0aW5nIGJldHdlZW4gZXJyb3JzIHdpdGggdGhlIHNhbWUgbmFtZSBhbmQgc3RhdHVzLAovLyBlZywgYmFkX3JlcXVlc3QuCmV4cG9ydHMuZ2V0RXJyb3JUeXBlQnlQcm9wID0gZnVuY3Rpb24gKHByb3AsIHZhbHVlLCByZWFzb24pIHsKICB2YXIgZXJyb3JzID0gZXhwb3J0czsKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGZ1bmN0aW9uIChrZXkpIHsKICAgIHZhciBlcnJvciA9IGVycm9yc1trZXldOwogICAgcmV0dXJuIHR5cGVvZiBlcnJvciAhPT0gJ2Z1bmN0aW9uJyAmJiBlcnJvcltwcm9wXSA9PT0gdmFsdWU7CiAgfSk7CiAgdmFyIGtleSA9IHJlYXNvbiAmJiBrZXlzLmZpbHRlcihmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgdmFyIGVycm9yID0gZXJyb3JzW2tleV07CiAgICAgICAgcmV0dXJuIGVycm9yLm1lc3NhZ2UgPT09IHJlYXNvbjsKICAgICAgfSlbMF0gfHwga2V5c1swXTsKICByZXR1cm4gKGtleSkgPyBlcnJvcnNba2V5XSA6IG51bGw7Cn07CgpleHBvcnRzLmdlbmVyYXRlRXJyb3JGcm9tUmVzcG9uc2UgPSBmdW5jdGlvbiAocmVzKSB7CiAgdmFyIGVycm9yLCBlcnJOYW1lLCBlcnJUeXBlLCBlcnJNc2csIGVyclJlYXNvbjsKICB2YXIgZXJyb3JzID0gZXhwb3J0czsKCiAgZXJyTmFtZSA9IChyZXMuZXJyb3IgPT09IHRydWUgJiYgdHlwZW9mIHJlcy5uYW1lID09PSAnc3RyaW5nJykgPwogICAgICAgICAgICAgIHJlcy5uYW1lIDoKICAgICAgICAgICAgICByZXMuZXJyb3I7CiAgZXJyUmVhc29uID0gcmVzLnJlYXNvbjsKICBlcnJUeXBlID0gZXJyb3JzLmdldEVycm9yVHlwZUJ5UHJvcCgnbmFtZScsIGVyck5hbWUsIGVyclJlYXNvbik7CgogIGlmIChyZXMubWlzc2luZyB8fAogICAgICBlcnJSZWFzb24gPT09ICdtaXNzaW5nJyB8fAogICAgICBlcnJSZWFzb24gPT09ICdkZWxldGVkJyB8fAogICAgICBlcnJOYW1lID09PSAnbm90X2ZvdW5kJykgewogICAgZXJyVHlwZSA9IGVycm9ycy5NSVNTSU5HX0RPQzsKICB9IGVsc2UgaWYgKGVyck5hbWUgPT09ICdkb2NfdmFsaWRhdGlvbicpIHsKICAgIC8vIGRvYyB2YWxpZGF0aW9uIG5lZWRzIHNwZWNpYWwgdHJlYXRtZW50IHNpbmNlCiAgICAvLyByZXMucmVhc29uIGRlcGVuZHMgb24gdGhlIHZhbGlkYXRpb24gZXJyb3IuCiAgICAvLyBzZWUgdXRpbHMuanMKICAgIGVyclR5cGUgPSBlcnJvcnMuRE9DX1ZBTElEQVRJT047CiAgICBlcnJNc2cgPSBlcnJSZWFzb247CiAgfSBlbHNlIGlmIChlcnJOYW1lID09PSAnYmFkX3JlcXVlc3QnICYmIGVyclR5cGUubWVzc2FnZSAhPT0gZXJyUmVhc29uKSB7CiAgICAvLyBpZiBiYWRfcmVxdWVzdCBlcnJvciBhbHJlYWR5IGZvdW5kIGJhc2VkIG9uIHJlYXNvbiBkb24ndCBvdmVycmlkZS4KICAgIGVyclR5cGUgPSBlcnJvcnMuQkFEX1JFUVVFU1Q7CiAgfQoKICAvLyBmYWxsYmFjayB0byBlcnJvciBieSBzdGF0dXMgb3IgdW5rbm93biBlcnJvci4KICBpZiAoIWVyclR5cGUpIHsKICAgIGVyclR5cGUgPSBlcnJvcnMuZ2V0RXJyb3JUeXBlQnlQcm9wKCdzdGF0dXMnLCByZXMuc3RhdHVzLCBlcnJSZWFzb24pIHx8CiAgICAgICAgICAgICAgICBlcnJvcnMuVU5LTk9XTl9FUlJPUjsKICB9CgogIGVycm9yID0gZXJyb3JzLmVycm9yKGVyclR5cGUsIGVyclJlYXNvbiwgZXJyTmFtZSk7CgogIC8vIEtlZXAgY3VzdG9tIG1lc3NhZ2UuCiAgaWYgKGVyck1zZykgewogICAgZXJyb3IubWVzc2FnZSA9IGVyck1zZzsKICB9CgogIC8vIEtlZXAgaGVscGZ1bCByZXNwb25zZSBkYXRhIGluIG91ciBlcnJvciBtZXNzYWdlcy4KICBpZiAocmVzLmlkKSB7CiAgICBlcnJvci5pZCA9IHJlcy5pZDsKICB9CiAgaWYgKHJlcy5zdGF0dXMpIHsKICAgIGVycm9yLnN0YXR1cyA9IHJlcy5zdGF0dXM7CiAgfQogIGlmIChyZXMubWlzc2luZykgewogICAgZXJyb3IubWlzc2luZyA9IHJlcy5taXNzaW5nOwogIH0KCiAgcmV0dXJuIGVycm9yOwp9OwoKfSx7ImluaGVyaXRzIjoxMn1dLDY1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIGNsb25lID0gcmVxdWlyZSgnLi9jbG9uZScpOwoKZnVuY3Rpb24gZXh0ZW5kSW5uZXIob2JqLCBvdGhlck9iaikgewogIGZvciAodmFyIGtleSBpbiBvdGhlck9iaikgewogICAgaWYgKG90aGVyT2JqLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgdmFyIHZhbHVlID0gY2xvbmUob3RoZXJPYmpba2V5XSk7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgb2JqW2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgfQogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBleHRlbmQob2JqLCBvYmoyLCBvYmozKSB7CiAgZXh0ZW5kSW5uZXIob2JqLCBvYmoyKTsKICBpZiAob2JqMykgewogICAgZXh0ZW5kSW5uZXIob2JqLCBvYmozKTsKICB9CiAgcmV0dXJuIG9iajsKfTsKfSx7Ii4vY2xvbmUiOjUzfV0sNjY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBmbGF0dGVuIGFuIGFycmF5IG9mIGFycmF5cywgd2l0aCBvcHRpb25hbCBub24tYXJyYXlzIGluc2lkZQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGZsYXR0ZW4oYXJyYXlzKSB7CiAgdmFyIHJlcyA9IFtdOwogIGFycmF5cy5mb3JFYWNoKGZ1bmN0aW9uIChhcnJheSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkoYXJyYXkpKSB7CiAgICAgIHJlcyA9IHJlcy5jb25jYXQoYXJyYXkpOwogICAgfSBlbHNlIHsKICAgICAgcmVzLnB1c2goYXJyYXkpOwogICAgfQogIH0pOwogIHJldHVybiByZXM7Cn07Cn0se31dLDY3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChnbG9iYWwpewondXNlIHN0cmljdCc7Cgp2YXIgdG9Qcm9taXNlID0gcmVxdWlyZSgnLi90b1Byb21pc2UnKTsKdmFyIGJhc2U2NCA9IHJlcXVpcmUoJy4vYmluYXJ5L2Jhc2U2NCcpOwp2YXIgTWQ1ID0gcmVxdWlyZSgnc3BhcmstbWQ1Jyk7CnZhciBzZXRJbW1lZGlhdGVTaGltID0gZ2xvYmFsLnNldEltbWVkaWF0ZSB8fCBnbG9iYWwuc2V0VGltZW91dDsKdmFyIE1ENV9DSFVOS19TSVpFID0gMzI3Njg7CgovLyBjb252ZXJ0IGEgNjQtYml0IGludCB0byBhIGJpbmFyeSBzdHJpbmcKZnVuY3Rpb24gaW50VG9TdHJpbmcoaW50KSB7CiAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoaW50ICYgMHhmZikgKwogICAgU3RyaW5nLmZyb21DaGFyQ29kZSgoaW50ID4+PiA4KSAmIDB4ZmYpICsKICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoKGludCA+Pj4gMTYpICYgMHhmZikgKwogICAgU3RyaW5nLmZyb21DaGFyQ29kZSgoaW50ID4+PiAyNCkgJiAweGZmKTsKfQoKLy8gY29udmVydCBhbiBhcnJheSBvZiA2NC1iaXQgaW50cyBpbnRvCi8vIGEgYmFzZTY0LWVuY29kZWQgc3RyaW5nCmZ1bmN0aW9uIHJhd1RvQmFzZTY0KHJhdykgewogIHZhciByZXMgPSAnJzsKICBmb3IgKHZhciBpID0gMCwgbGVuID0gcmF3Lmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICByZXMgKz0gaW50VG9TdHJpbmcocmF3W2ldKTsKICB9CiAgcmV0dXJuIGJhc2U2NC5idG9hKHJlcyk7Cn0KCmZ1bmN0aW9uIGFwcGVuZEJ1ZmZlcihidWZmZXIsIGRhdGEsIHN0YXJ0LCBlbmQpIHsKICBpZiAoc3RhcnQgPiAwIHx8IGVuZCA8IGRhdGEuYnl0ZUxlbmd0aCkgewogICAgLy8gb25seSBjcmVhdGUgYSBzdWJhcnJheSBpZiB3ZSByZWFsbHkgbmVlZCB0bwogICAgZGF0YSA9IG5ldyBVaW50OEFycmF5KGRhdGEsIHN0YXJ0LAogICAgICBNYXRoLm1pbihlbmQsIGRhdGEuYnl0ZUxlbmd0aCkgLSBzdGFydCk7CiAgfQogIGJ1ZmZlci5hcHBlbmQoZGF0YSk7Cn0KCmZ1bmN0aW9uIGFwcGVuZFN0cmluZyhidWZmZXIsIGRhdGEsIHN0YXJ0LCBlbmQpIHsKICBpZiAoc3RhcnQgPiAwIHx8IGVuZCA8IGRhdGEubGVuZ3RoKSB7CiAgICAvLyBvbmx5IGNyZWF0ZSBhIHN1YnN0cmluZyBpZiB3ZSByZWFsbHkgbmVlZCB0bwogICAgZGF0YSA9IGRhdGEuc3Vic3RyaW5nKHN0YXJ0LCBlbmQpOwogIH0KICBidWZmZXIuYXBwZW5kQmluYXJ5KGRhdGEpOwp9Cgptb2R1bGUuZXhwb3J0cyA9IHRvUHJvbWlzZShmdW5jdGlvbiAoZGF0YSwgY2FsbGJhY2spIHsKICB2YXIgaW5wdXRJc1N0cmluZyA9IHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJzsKICB2YXIgbGVuID0gaW5wdXRJc1N0cmluZyA/IGRhdGEubGVuZ3RoIDogZGF0YS5ieXRlTGVuZ3RoOwogIHZhciBjaHVua1NpemUgPSBNYXRoLm1pbihNRDVfQ0hVTktfU0laRSwgbGVuKTsKICB2YXIgY2h1bmtzID0gTWF0aC5jZWlsKGxlbiAvIGNodW5rU2l6ZSk7CiAgdmFyIGN1cnJlbnRDaHVuayA9IDA7CiAgdmFyIGJ1ZmZlciA9IGlucHV0SXNTdHJpbmcgPyBuZXcgTWQ1KCkgOiBuZXcgTWQ1LkFycmF5QnVmZmVyKCk7CgogIHZhciBhcHBlbmQgPSBpbnB1dElzU3RyaW5nID8gYXBwZW5kU3RyaW5nIDogYXBwZW5kQnVmZmVyOwoKICBmdW5jdGlvbiBsb2FkTmV4dENodW5rKCkgewogICAgdmFyIHN0YXJ0ID0gY3VycmVudENodW5rICogY2h1bmtTaXplOwogICAgdmFyIGVuZCA9IHN0YXJ0ICsgY2h1bmtTaXplOwogICAgY3VycmVudENodW5rKys7CiAgICBpZiAoY3VycmVudENodW5rIDwgY2h1bmtzKSB7CiAgICAgIGFwcGVuZChidWZmZXIsIGRhdGEsIHN0YXJ0LCBlbmQpOwogICAgICBzZXRJbW1lZGlhdGVTaGltKGxvYWROZXh0Q2h1bmspOwogICAgfSBlbHNlIHsKICAgICAgYXBwZW5kKGJ1ZmZlciwgZGF0YSwgc3RhcnQsIGVuZCk7CiAgICAgIHZhciByYXcgPSBidWZmZXIuZW5kKHRydWUpOwogICAgICB2YXIgYmFzZTY0ID0gcmF3VG9CYXNlNjQocmF3KTsKICAgICAgY2FsbGJhY2sobnVsbCwgYmFzZTY0KTsKICAgICAgYnVmZmVyLmRlc3Ryb3koKTsKICAgIH0KICB9CiAgbG9hZE5leHRDaHVuaygpOwp9KTsKCn0pLmNhbGwodGhpcyx0eXBlb2YgZ2xvYmFsICE9PSAidW5kZWZpbmVkIiA/IGdsb2JhbCA6IHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIiA/IHNlbGYgOiB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdyA6IHt9KQp9LHsiLi9iaW5hcnkvYmFzZTY0Ijo0MSwiLi90b1Byb21pc2UiOjgwLCJzcGFyay1tZDUiOjEwOX1dLDY4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIHdpbm5pbmdSZXYgPSByZXF1aXJlKCcuL3dpbm5pbmdSZXYnKTsKdmFyIGNvbGxlY3RMZWF2ZXMgPSByZXF1aXJlKCcuL2NvbGxlY3RMZWF2ZXMnKTsKCi8vIHJldHVybnMgcmV2cyBvZiBhbGwgY29uZmxpY3RzIHRoYXQgaXMgbGVhdmVzIHN1Y2ggdGhhdAovLyAxLiBhcmUgbm90IGRlbGV0ZWQgYW5kCi8vIDIuIGFyZSBkaWZmZXJlbnQgdGhhbiB3aW5uaW5nIHJldmlzaW9uCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gY29sbGVjdENvbmZsaWN0cyhtZXRhZGF0YSkgewogIHZhciB3aW4gPSB3aW5uaW5nUmV2KG1ldGFkYXRhKTsKICB2YXIgbGVhdmVzID0gY29sbGVjdExlYXZlcyhtZXRhZGF0YS5yZXZfdHJlZSk7CiAgdmFyIGNvbmZsaWN0cyA9IFtdOwogIGZvciAodmFyIGkgPSAwLCBsZW4gPSBsZWF2ZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgIHZhciBsZWFmID0gbGVhdmVzW2ldOwogICAgaWYgKGxlYWYucmV2ICE9PSB3aW4gJiYgIWxlYWYub3B0cy5kZWxldGVkKSB7CiAgICAgIGNvbmZsaWN0cy5wdXNoKGxlYWYucmV2KTsKICAgIH0KICB9CiAgcmV0dXJuIGNvbmZsaWN0czsKfTsKfSx7Ii4vY29sbGVjdExlYXZlcyI6NjksIi4vd2lubmluZ1JldiI6NzR9XSw2OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciB0cmF2ZXJzZVJldlRyZWUgPSByZXF1aXJlKCcuL3RyYXZlcnNlUmV2VHJlZScpOwoKZnVuY3Rpb24gc29ydEJ5UG9zKGEsIGIpIHsKICByZXR1cm4gYS5wb3MgLSBiLnBvczsKfQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBjb2xsZWN0TGVhdmVzKHJldnMpIHsKICB2YXIgbGVhdmVzID0gW107CiAgdHJhdmVyc2VSZXZUcmVlKHJldnMsIGZ1bmN0aW9uIChpc0xlYWYsIHBvcywgaWQsIGFjYywgb3B0cykgewogICAgaWYgKGlzTGVhZikgewogICAgICBsZWF2ZXMucHVzaCh7cmV2OiBwb3MgKyAiLSIgKyBpZCwgcG9zOiBwb3MsIG9wdHM6IG9wdHN9KTsKICAgIH0KICB9KTsKICBsZWF2ZXMuc29ydChzb3J0QnlQb3MpLnJldmVyc2UoKTsKICBmb3IgKHZhciBpID0gMCwgbGVuID0gbGVhdmVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICBkZWxldGUgbGVhdmVzW2ldLnBvczsKICB9CiAgcmV0dXJuIGxlYXZlczsKfTsKfSx7Ii4vdHJhdmVyc2VSZXZUcmVlIjo3M31dLDcwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gZm9yIGEgYmV0dGVyIG92ZXJ2aWV3IG9mIHdoYXQgdGhpcyBpcyBkb2luZywgcmVhZDoKLy8gaHR0cHM6Ly9naXRodWIuY29tL2FwYWNoZS9jb3VjaGRiL2Jsb2IvbWFzdGVyL3NyYy9jb3VjaGRiL2NvdWNoX2tleV90cmVlLmVybAovLwovLyBCdXQgZm9yIGEgcXVpY2sgaW50cm8sIENvdWNoREIgdXNlcyBhIHJldmlzaW9uIHRyZWUgdG8gc3RvcmUgYSBkb2N1bWVudHMKLy8gaGlzdG9yeSwgQSAtPiBCIC0+IEMsIHdoZW4gYSBkb2N1bWVudCBoYXMgY29uZmxpY3RzLCB0aGF0IGlzIGEgYnJhbmNoIGluIHRoZQovLyB0cmVlLCBBIC0+IChCMSB8IEIyIC0+IEMpLCBXZSBzdG9yZSB0aGVzZSBhcyBhIG5lc3RlZCBhcnJheSBpbiB0aGUgZm9ybWF0Ci8vCi8vIEtleVRyZWUgPSBbUGF0aCAuLi4gXQovLyBQYXRoID0ge3BvczogcG9zaXRpb25fZnJvbV9yb290LCBpZHM6IFRyZWV9Ci8vIFRyZWUgPSBbS2V5LCBPcHRzLCBbVHJlZSwgLi4uXV0sIGluIHBhcnRpY3VsYXIgc2luZ2xlIG5vZGU6IFtLZXksIFtdXQoKdmFyIHJvb3RUb0xlYWYgPSByZXF1aXJlKCcuL3Jvb3RUb0xlYWYnKTsKCmZ1bmN0aW9uIHNvcnRCeVBvcyhhLCBiKSB7CiAgcmV0dXJuIGEucG9zIC0gYi5wb3M7Cn0KCi8vIGNsYXNzaWMgYmluYXJ5IHNlYXJjaApmdW5jdGlvbiBiaW5hcnlTZWFyY2goYXJyLCBpdGVtLCBjb21wYXJhdG9yKSB7CiAgdmFyIGxvdyA9IDA7CiAgdmFyIGhpZ2ggPSBhcnIubGVuZ3RoOwogIHZhciBtaWQ7CiAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgIG1pZCA9IChsb3cgKyBoaWdoKSA+Pj4gMTsKICAgIGlmIChjb21wYXJhdG9yKGFyclttaWRdLCBpdGVtKSA8IDApIHsKICAgICAgbG93ID0gbWlkICsgMTsKICAgIH0gZWxzZSB7CiAgICAgIGhpZ2ggPSBtaWQ7CiAgICB9CiAgfQogIHJldHVybiBsb3c7Cn0KCi8vIGFzc3VtaW5nIHRoZSBhcnIgaXMgc29ydGVkLCBpbnNlcnQgdGhlIGl0ZW0gaW4gdGhlIHByb3BlciBwbGFjZQpmdW5jdGlvbiBpbnNlcnRTb3J0ZWQoYXJyLCBpdGVtLCBjb21wYXJhdG9yKSB7CiAgdmFyIGlkeCA9IGJpbmFyeVNlYXJjaChhcnIsIGl0ZW0sIGNvbXBhcmF0b3IpOwogIGFyci5zcGxpY2UoaWR4LCAwLCBpdGVtKTsKfQoKLy8gVHVybiBhIHBhdGggYXMgYSBmbGF0IGFycmF5IGludG8gYSB0cmVlIHdpdGggYSBzaW5nbGUgYnJhbmNoLgovLyBJZiBhbnkgc2hvdWxkIGJlIHN0ZW1tZWQgZnJvbSB0aGUgYmVnaW5uaW5nIG9mIHRoZSBhcnJheSwgdGhhdCdzIHBhc3NlZAovLyBpbiBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50CmZ1bmN0aW9uIHBhdGhUb1RyZWUocGF0aCwgbnVtU3RlbW1lZCkgewogIHZhciByb290OwogIHZhciBsZWFmOwogIGZvciAodmFyIGkgPSBudW1TdGVtbWVkLCBsZW4gPSBwYXRoLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICB2YXIgbm9kZSA9IHBhdGhbaV07CiAgICB2YXIgY3VycmVudExlYWYgPSBbbm9kZS5pZCwgbm9kZS5vcHRzLCBbXV07CiAgICBpZiAobGVhZikgewogICAgICBsZWFmWzJdLnB1c2goY3VycmVudExlYWYpOwogICAgICBsZWFmID0gY3VycmVudExlYWY7CiAgICB9IGVsc2UgewogICAgICByb290ID0gbGVhZiA9IGN1cnJlbnRMZWFmOwogICAgfQogIH0KICByZXR1cm4gcm9vdDsKfQoKLy8gY29tcGFyZSB0aGUgSURzIG9mIHR3byB0cmVlcwpmdW5jdGlvbiBjb21wYXJlVHJlZShhLCBiKSB7CiAgcmV0dXJuIGFbMF0gPCBiWzBdID8gLTEgOiAxOwp9CgovLyBNZXJnZSB0d28gdHJlZXMgdG9nZXRoZXIKLy8gVGhlIHJvb3RzIG9mIHRyZWUxIGFuZCB0cmVlMiBtdXN0IGJlIHRoZSBzYW1lIHJldmlzaW9uCmZ1bmN0aW9uIG1lcmdlVHJlZShpbl90cmVlMSwgaW5fdHJlZTIpIHsKICB2YXIgcXVldWUgPSBbe3RyZWUxOiBpbl90cmVlMSwgdHJlZTI6IGluX3RyZWUyfV07CiAgdmFyIGNvbmZsaWN0cyA9IGZhbHNlOwogIHdoaWxlIChxdWV1ZS5sZW5ndGggPiAwKSB7CiAgICB2YXIgaXRlbSA9IHF1ZXVlLnBvcCgpOwogICAgdmFyIHRyZWUxID0gaXRlbS50cmVlMTsKICAgIHZhciB0cmVlMiA9IGl0ZW0udHJlZTI7CgogICAgaWYgKHRyZWUxWzFdLnN0YXR1cyB8fCB0cmVlMlsxXS5zdGF0dXMpIHsKICAgICAgdHJlZTFbMV0uc3RhdHVzID0KICAgICAgICAodHJlZTFbMV0uc3RhdHVzID09PSAgJ2F2YWlsYWJsZScgfHwKICAgICAgICB0cmVlMlsxXS5zdGF0dXMgPT09ICdhdmFpbGFibGUnKSA/ICdhdmFpbGFibGUnIDogJ21pc3NpbmcnOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHJlZTJbMl0ubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKCF0cmVlMVsyXVswXSkgewogICAgICAgIGNvbmZsaWN0cyA9ICduZXdfbGVhZic7CiAgICAgICAgdHJlZTFbMl1bMF0gPSB0cmVlMlsyXVtpXTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgdmFyIG1lcmdlZCA9IGZhbHNlOwogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRyZWUxWzJdLmxlbmd0aDsgaisrKSB7CiAgICAgICAgaWYgKHRyZWUxWzJdW2pdWzBdID09PSB0cmVlMlsyXVtpXVswXSkgewogICAgICAgICAgcXVldWUucHVzaCh7dHJlZTE6IHRyZWUxWzJdW2pdLCB0cmVlMjogdHJlZTJbMl1baV19KTsKICAgICAgICAgIG1lcmdlZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghbWVyZ2VkKSB7CiAgICAgICAgY29uZmxpY3RzID0gJ25ld19icmFuY2gnOwogICAgICAgIGluc2VydFNvcnRlZCh0cmVlMVsyXSwgdHJlZTJbMl1baV0sIGNvbXBhcmVUcmVlKTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4ge2NvbmZsaWN0czogY29uZmxpY3RzLCB0cmVlOiBpbl90cmVlMX07Cn0KCmZ1bmN0aW9uIGRvTWVyZ2UodHJlZSwgcGF0aCwgZG9udEV4cGFuZCkgewogIHZhciByZXN0cmVlID0gW107CiAgdmFyIGNvbmZsaWN0cyA9IGZhbHNlOwogIHZhciBtZXJnZWQgPSBmYWxzZTsKICB2YXIgcmVzOwoKICBpZiAoIXRyZWUubGVuZ3RoKSB7CiAgICByZXR1cm4ge3RyZWU6IFtwYXRoXSwgY29uZmxpY3RzOiAnbmV3X2xlYWYnfTsKICB9CgogIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0cmVlLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICB2YXIgYnJhbmNoID0gdHJlZVtpXTsKICAgIGlmIChicmFuY2gucG9zID09PSBwYXRoLnBvcyAmJiBicmFuY2guaWRzWzBdID09PSBwYXRoLmlkc1swXSkgewogICAgICAvLyBQYXRocyBzdGFydCBhdCB0aGUgc2FtZSBwb3NpdGlvbiBhbmQgaGF2ZSB0aGUgc2FtZSByb290LCBzbyB0aGV5IG5lZWQKICAgICAgLy8gbWVyZ2VkCiAgICAgIHJlcyA9IG1lcmdlVHJlZShicmFuY2guaWRzLCBwYXRoLmlkcyk7CiAgICAgIHJlc3RyZWUucHVzaCh7cG9zOiBicmFuY2gucG9zLCBpZHM6IHJlcy50cmVlfSk7CiAgICAgIGNvbmZsaWN0cyA9IGNvbmZsaWN0cyB8fCByZXMuY29uZmxpY3RzOwogICAgICBtZXJnZWQgPSB0cnVlOwogICAgfSBlbHNlIGlmIChkb250RXhwYW5kICE9PSB0cnVlKSB7CiAgICAgIC8vIFRoZSBwYXRocyBzdGFydCBhdCBhIGRpZmZlcmVudCBwb3NpdGlvbiwgdGFrZSB0aGUgZWFybGllc3QgcGF0aCBhbmQKICAgICAgLy8gdHJhdmVyc2UgdXAgdW50aWwgaXQgYXMgYXQgdGhlIHNhbWUgcG9pbnQgZnJvbSByb290IGFzIHRoZSBwYXRoIHdlCiAgICAgIC8vIHdhbnQgdG8gbWVyZ2UuICBJZiB0aGUga2V5cyBtYXRjaCB3ZSByZXR1cm4gdGhlIGxvbmdlciBwYXRoIHdpdGggdGhlCiAgICAgIC8vIG90aGVyIG1lcmdlZCBBZnRlciBzdGVtbWluZyB3ZSBkb250IHdhbnQgdG8gZXhwYW5kIHRoZSB0cmVlcwoKICAgICAgdmFyIHQxID0gYnJhbmNoLnBvcyA8IHBhdGgucG9zID8gYnJhbmNoIDogcGF0aDsKICAgICAgdmFyIHQyID0gYnJhbmNoLnBvcyA8IHBhdGgucG9zID8gcGF0aCA6IGJyYW5jaDsKICAgICAgdmFyIGRpZmYgPSB0Mi5wb3MgLSB0MS5wb3M7CgogICAgICB2YXIgY2FuZGlkYXRlUGFyZW50cyA9IFtdOwoKICAgICAgdmFyIHRyZWVzID0gW107CiAgICAgIHRyZWVzLnB1c2goe2lkczogdDEuaWRzLCBkaWZmOiBkaWZmLCBwYXJlbnQ6IG51bGwsIHBhcmVudElkeDogbnVsbH0pOwogICAgICB3aGlsZSAodHJlZXMubGVuZ3RoID4gMCkgewogICAgICAgIHZhciBpdGVtID0gdHJlZXMucG9wKCk7CiAgICAgICAgaWYgKGl0ZW0uZGlmZiA9PT0gMCkgewogICAgICAgICAgaWYgKGl0ZW0uaWRzWzBdID09PSB0Mi5pZHNbMF0pIHsKICAgICAgICAgICAgY2FuZGlkYXRlUGFyZW50cy5wdXNoKGl0ZW0pOwogICAgICAgICAgfQogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIHZhciBlbGVtZW50cyA9IGl0ZW0uaWRzWzJdOwogICAgICAgIGZvciAodmFyIGogPSAwLCBlbGVtZW50c0xlbiA9IGVsZW1lbnRzLmxlbmd0aDsgaiA8IGVsZW1lbnRzTGVuOyBqKyspIHsKICAgICAgICAgIHRyZWVzLnB1c2goewogICAgICAgICAgICBpZHM6IGVsZW1lbnRzW2pdLAogICAgICAgICAgICBkaWZmOiBpdGVtLmRpZmYgLSAxLAogICAgICAgICAgICBwYXJlbnQ6IGl0ZW0uaWRzLAogICAgICAgICAgICBwYXJlbnRJZHg6IGoKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIGVsID0gY2FuZGlkYXRlUGFyZW50c1swXTsKCiAgICAgIGlmICghZWwpIHsKICAgICAgICByZXN0cmVlLnB1c2goYnJhbmNoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXMgPSBtZXJnZVRyZWUoZWwuaWRzLCB0Mi5pZHMpOwogICAgICAgIGVsLnBhcmVudFsyXVtlbC5wYXJlbnRJZHhdID0gcmVzLnRyZWU7CiAgICAgICAgcmVzdHJlZS5wdXNoKHtwb3M6IHQxLnBvcywgaWRzOiB0MS5pZHN9KTsKICAgICAgICBjb25mbGljdHMgPSBjb25mbGljdHMgfHwgcmVzLmNvbmZsaWN0czsKICAgICAgICBtZXJnZWQgPSB0cnVlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXN0cmVlLnB1c2goYnJhbmNoKTsKICAgIH0KICB9CgogIC8vIFdlIGRpZG50IGZpbmQKICBpZiAoIW1lcmdlZCkgewogICAgcmVzdHJlZS5wdXNoKHBhdGgpOwogIH0KCiAgcmVzdHJlZS5zb3J0KHNvcnRCeVBvcyk7CgogIHJldHVybiB7CiAgICB0cmVlOiByZXN0cmVlLAogICAgY29uZmxpY3RzOiBjb25mbGljdHMgfHwgJ2ludGVybmFsX25vZGUnCiAgfTsKfQoKLy8gVG8gZW5zdXJlIHdlIGRvbnQgZ3JvdyB0aGUgcmV2aXNpb24gdHJlZSBpbmZpbml0ZWx5LCB3ZSBzdGVtIG9sZCByZXZpc2lvbnMKZnVuY3Rpb24gc3RlbSh0cmVlLCBkZXB0aCkgewogIC8vIEZpcnN0IHdlIGJyZWFrIG91dCB0aGUgdHJlZSBpbnRvIGEgY29tcGxldGUgbGlzdCBvZiByb290IHRvIGxlYWYgcGF0aHMKICB2YXIgcGF0aHMgPSByb290VG9MZWFmKHRyZWUpOwogIHZhciByZXN1bHQ7CiAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHBhdGhzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAvLyBUaGVuIGZvciBlYWNoIHBhdGgsIHdlIGN1dCBvZmYgdGhlIHN0YXJ0IG9mIHRoZSBwYXRoIGJhc2VkIG9uIHRoZQogICAgLy8gYGRlcHRoYCB0byBzdGVtIHRvLCBhbmQgZ2VuZXJhdGUgYSBuZXcgc2V0IG9mIGZsYXQgdHJlZXMKICAgIHZhciBwYXRoID0gcGF0aHNbaV07CiAgICB2YXIgc3RlbW1lZCA9IHBhdGguaWRzOwogICAgdmFyIG51bVN0ZW1tZWQgPSBNYXRoLm1heCgwLCBzdGVtbWVkLmxlbmd0aCAtIGRlcHRoKTsKICAgIHZhciBzdGVtbWVkTm9kZSA9IHsKICAgICAgcG9zOiBwYXRoLnBvcyArIG51bVN0ZW1tZWQsCiAgICAgIGlkczogcGF0aFRvVHJlZShzdGVtbWVkLCBudW1TdGVtbWVkKQogICAgfTsKICAgIC8vIFRoZW4gd2UgcmVtZXJnZSBhbGwgdGhvc2UgZmxhdCB0cmVlcyB0b2dldGhlciwgZW5zdXJpbmcgdGhhdCB3ZSBkb250CiAgICAvLyBjb25uZWN0IHRyZWVzIHRoYXQgd291bGQgZ28gYmV5b25kIHRoZSBkZXB0aCBsaW1pdAogICAgaWYgKHJlc3VsdCkgewogICAgICByZXN1bHQgPSBkb01lcmdlKHJlc3VsdCwgc3RlbW1lZE5vZGUsIHRydWUpLnRyZWU7CiAgICB9IGVsc2UgewogICAgICByZXN1bHQgPSBbc3RlbW1lZE5vZGVdOwogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIG1lcmdlKHRyZWUsIHBhdGgsIGRlcHRoKSB7CiAgdmFyIG5ld1RyZWUgPSBkb01lcmdlKHRyZWUsIHBhdGgpOwogIHJldHVybiB7CiAgICB0cmVlOiBzdGVtKG5ld1RyZWUudHJlZSwgZGVwdGgpLAogICAgY29uZmxpY3RzOiBuZXdUcmVlLmNvbmZsaWN0cwogIH07Cn07Cn0seyIuL3Jvb3RUb0xlYWYiOjcyfV0sNzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyByZXR1cm4gdHJ1ZSBpZiBhIHJldiBleGlzdHMgaW4gdGhlIHJldiB0cmVlLCBmYWxzZSBvdGhlcndpc2UKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiByZXZFeGlzdHMocmV2cywgcmV2KSB7CiAgdmFyIHRvVmlzaXQgPSByZXZzLnNsaWNlKCk7CiAgdmFyIHNwbGl0UmV2ID0gcmV2LnNwbGl0KCctJyk7CiAgdmFyIHRhcmdldFBvcyA9IHBhcnNlSW50KHNwbGl0UmV2WzBdLCAxMCk7CiAgdmFyIHRhcmdldElkID0gc3BsaXRSZXZbMV07CgogIHZhciBub2RlOwogIHdoaWxlICgobm9kZSA9IHRvVmlzaXQucG9wKCkpKSB7CiAgICBpZiAobm9kZS5wb3MgPT09IHRhcmdldFBvcyAmJiBub2RlLmlkc1swXSA9PT0gdGFyZ2V0SWQpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICB2YXIgYnJhbmNoZXMgPSBub2RlLmlkc1syXTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBicmFuY2hlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICB0b1Zpc2l0LnB1c2goe3Bvczogbm9kZS5wb3MgKyAxLCBpZHM6IGJyYW5jaGVzW2ldfSk7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfTsKfSx7fV0sNzI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Ci8vIGJ1aWxkIHVwIGEgbGlzdCBvZiBhbGwgdGhlIHBhdGhzIHRvIHRoZSBsZWFmcyBpbiB0aGlzIHJldmlzaW9uIHRyZWUKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiByb290VG9MZWFmKHJldnMpIHsKICB2YXIgcGF0aHMgPSBbXTsKICB2YXIgdG9WaXNpdCA9IHJldnMuc2xpY2UoKTsKICB2YXIgbm9kZTsKICB3aGlsZSAoKG5vZGUgPSB0b1Zpc2l0LnBvcCgpKSkgewogICAgdmFyIHBvcyA9IG5vZGUucG9zOwogICAgdmFyIHRyZWUgPSBub2RlLmlkczsKICAgIHZhciBpZCA9IHRyZWVbMF07CiAgICB2YXIgb3B0cyA9IHRyZWVbMV07CiAgICB2YXIgYnJhbmNoZXMgPSB0cmVlWzJdOwogICAgdmFyIGlzTGVhZiA9IGJyYW5jaGVzLmxlbmd0aCA9PT0gMDsKCiAgICB2YXIgaGlzdG9yeSA9IG5vZGUuaGlzdG9yeSA/IG5vZGUuaGlzdG9yeS5zbGljZSgpIDogW107CiAgICBoaXN0b3J5LnB1c2goe2lkOiBpZCwgb3B0czogb3B0c30pOwogICAgaWYgKGlzTGVhZikgewogICAgICBwYXRocy5wdXNoKHtwb3M6IChwb3MgKyAxIC0gaGlzdG9yeS5sZW5ndGgpLCBpZHM6IGhpc3Rvcnl9KTsKICAgIH0KICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBicmFuY2hlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICB0b1Zpc2l0LnB1c2goe3BvczogcG9zICsgMSwgaWRzOiBicmFuY2hlc1tpXSwgaGlzdG9yeTogaGlzdG9yeX0pOwogICAgfQogIH0KICByZXR1cm4gcGF0aHMucmV2ZXJzZSgpOwp9Owp9LHt9XSw3MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIFByZXR0eSBtdWNoIGFsbCBiZWxvdyBjYW4gYmUgY29tYmluZWQgaW50byBhIGhpZ2hlciBvcmRlciBmdW5jdGlvbiB0bwovLyB0cmF2ZXJzZSByZXZpc2lvbnMKLy8gVGhlIHJldHVybiB2YWx1ZSBmcm9tIHRoZSBjYWxsYmFjayB3aWxsIGJlIHBhc3NlZCBhcyBjb250ZXh0IHRvIGFsbAovLyBjaGlsZHJlbiBvZiB0aGF0IG5vZGUKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiB0cmF2ZXJzZVJldlRyZWUocmV2cywgY2FsbGJhY2spIHsKICB2YXIgdG9WaXNpdCA9IHJldnMuc2xpY2UoKTsKCiAgdmFyIG5vZGU7CiAgd2hpbGUgKChub2RlID0gdG9WaXNpdC5wb3AoKSkpIHsKICAgIHZhciBwb3MgPSBub2RlLnBvczsKICAgIHZhciB0cmVlID0gbm9kZS5pZHM7CiAgICB2YXIgYnJhbmNoZXMgPSB0cmVlWzJdOwogICAgdmFyIG5ld0N0eCA9CiAgICAgIGNhbGxiYWNrKGJyYW5jaGVzLmxlbmd0aCA9PT0gMCwgcG9zLCB0cmVlWzBdLCBub2RlLmN0eCwgdHJlZVsxXSk7CiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gYnJhbmNoZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgdG9WaXNpdC5wdXNoKHtwb3M6IHBvcyArIDEsIGlkczogYnJhbmNoZXNbaV0sIGN0eDogbmV3Q3R4fSk7CiAgICB9CiAgfQp9Owp9LHt9XSw3NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIFdlIGZldGNoIGFsbCBsZWFmcyBvZiB0aGUgcmV2aXNpb24gdHJlZSwgYW5kIHNvcnQgdGhlbSBiYXNlZCBvbiB0cmVlIGxlbmd0aAovLyBhbmQgd2hldGhlciB0aGV5IHdlcmUgZGVsZXRlZCwgdW5kZWxldGVkIGRvY3VtZW50cyB3aXRoIHRoZSBsb25nZXN0IHJldmlzaW9uCi8vIHRyZWUgKG1vc3QgZWRpdHMpIHdpbgovLyBUaGUgZmluYWwgc29ydCBhbGdvcml0aG0gaXMgc2xpZ2h0bHkgZG9jdW1lbnRlZCBpbiBhIHNpZGViYXIgaGVyZToKLy8gaHR0cDovL2d1aWRlLmNvdWNoZGIub3JnL2RyYWZ0L2NvbmZsaWN0cy5odG1sCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gd2lubmluZ1JldihtZXRhZGF0YSkgewogIHZhciB3aW5uaW5nSWQ7CiAgdmFyIHdpbm5pbmdQb3M7CiAgdmFyIHdpbm5pbmdEZWxldGVkOwogIHZhciB0b1Zpc2l0ID0gbWV0YWRhdGEucmV2X3RyZWUuc2xpY2UoKTsKICB2YXIgbm9kZTsKICB3aGlsZSAoKG5vZGUgPSB0b1Zpc2l0LnBvcCgpKSkgewogICAgdmFyIHRyZWUgPSBub2RlLmlkczsKICAgIHZhciBicmFuY2hlcyA9IHRyZWVbMl07CiAgICB2YXIgcG9zID0gbm9kZS5wb3M7CiAgICBpZiAoYnJhbmNoZXMubGVuZ3RoKSB7IC8vIG5vbi1sZWFmCiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBicmFuY2hlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgIHRvVmlzaXQucHVzaCh7cG9zOiBwb3MgKyAxLCBpZHM6IGJyYW5jaGVzW2ldfSk7CiAgICAgIH0KICAgICAgY29udGludWU7CiAgICB9CiAgICB2YXIgZGVsZXRlZCA9ICEhdHJlZVsxXS5kZWxldGVkOwogICAgdmFyIGlkID0gdHJlZVswXTsKICAgIC8vIHNvcnQgYnkgZGVsZXRlZCwgdGhlbiBwb3MsIHRoZW4gaWQKICAgIGlmICghd2lubmluZ0lkIHx8ICh3aW5uaW5nRGVsZXRlZCAhPT0gZGVsZXRlZCA/IHdpbm5pbmdEZWxldGVkIDoKICAgICAgICB3aW5uaW5nUG9zICE9PSBwb3MgPyB3aW5uaW5nUG9zIDwgcG9zIDogd2lubmluZ0lkIDwgaWQpKSB7CiAgICAgIHdpbm5pbmdJZCA9IGlkOwogICAgICB3aW5uaW5nUG9zID0gcG9zOwogICAgICB3aW5uaW5nRGVsZXRlZCA9IGRlbGV0ZWQ7CiAgICB9CiAgfQoKICByZXR1cm4gd2lubmluZ1BvcyArICctJyArIHdpbm5pbmdJZDsKfTsKfSx7fV0sNzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgZ2V0QXJndW1lbnRzID0gcmVxdWlyZSgnYXJnc2FycmF5Jyk7CgpmdW5jdGlvbiBvbmNlKGZ1bikgewogIHZhciBjYWxsZWQgPSBmYWxzZTsKICByZXR1cm4gZ2V0QXJndW1lbnRzKGZ1bmN0aW9uIChhcmdzKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChjYWxsZWQpIHsKICAgICAgLy8gdGhpcyBpcyBhIHNtb2tlIHRlc3QgYW5kIHNob3VsZCBuZXZlciBhY3R1YWxseSBoYXBwZW4KICAgICAgdGhyb3cgbmV3IEVycm9yKCdvbmNlIGNhbGxlZCBtb3JlIHRoYW4gb25jZScpOwogICAgfSBlbHNlIHsKICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgZnVuLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfQogIH0pOwp9Cgptb2R1bGUuZXhwb3J0cyA9IG9uY2U7Cn0seyJhcmdzYXJyYXkiOjZ9XSw3NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vCi8vIFBhcnNpbmcgaGV4IHN0cmluZ3MuIFllYWguCi8vCi8vIFNvIGJhc2ljYWxseSB3ZSBuZWVkIHRoaXMgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBXZWJTUUw6Ci8vIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD00MjI2OTAKLy8gaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTEzNzYzNwovLwovLyBVVEYtOCBhbmQgVVRGLTE2IGFyZSBwcm92aWRlZCBhcyBzZXBhcmF0ZSBmdW5jdGlvbnMKLy8gZm9yIG1lYWdlciBwZXJmb3JtYW5jZSBpbXByb3ZlbWVudHMKLy8KCmZ1bmN0aW9uIGRlY29kZVV0Zjgoc3RyKSB7CiAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudCh3aW5kb3cuZXNjYXBlKHN0cikpOwp9CgpmdW5jdGlvbiBoZXhUb0ludChjaGFyQ29kZSkgewogIC8vICcwJy0nOScgaXMgNDgtNTcKICAvLyAnQSctJ0YnIGlzIDY1LTcwCiAgLy8gU1FMaXRlIHdpbGwgb25seSBnaXZlIHVzIHVwcGVyY2FzZSBoZXgKICByZXR1cm4gY2hhckNvZGUgPCA2NSA/IChjaGFyQ29kZSAtIDQ4KSA6IChjaGFyQ29kZSAtIDU1KTsKfQoKCi8vIEV4YW1wbGU6Ci8vIHByYWdtYSBlbmNvZGluZz11dGY4OwovLyBzZWxlY3QgaGV4KCdBJyk7Ci8vIHJldHVybnMgJzQxJwpmdW5jdGlvbiBwYXJzZUhleFV0Zjgoc3RyLCBzdGFydCwgZW5kKSB7CiAgdmFyIHJlc3VsdCA9ICcnOwogIHdoaWxlIChzdGFydCA8IGVuZCkgewogICAgcmVzdWx0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoCiAgICAgIChoZXhUb0ludChzdHIuY2hhckNvZGVBdChzdGFydCsrKSkgPDwgNCkgfAogICAgICAgIGhleFRvSW50KHN0ci5jaGFyQ29kZUF0KHN0YXJ0KyspKSk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCi8vIEV4YW1wbGU6Ci8vIHByYWdtYSBlbmNvZGluZz11dGYxNjsKLy8gc2VsZWN0IGhleCgnQScpOwovLyByZXR1cm5zICc0MTAwJwovLyBub3RpY2UgdGhhdCB0aGUgMDAgY29tZXMgYWZ0ZXIgdGhlIDQxIChpLmUuIGl0J3Mgc3dpenpsZWQpCmZ1bmN0aW9uIHBhcnNlSGV4VXRmMTYoc3RyLCBzdGFydCwgZW5kKSB7CiAgdmFyIHJlc3VsdCA9ICcnOwogIHdoaWxlIChzdGFydCA8IGVuZCkgewogICAgLy8gVVRGLTE2LCBzbyBzd2l6emxlIHRoZSBieXRlcwogICAgcmVzdWx0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoCiAgICAgIChoZXhUb0ludChzdHIuY2hhckNvZGVBdChzdGFydCArIDIpKSA8PCAxMikgfAogICAgICAgIChoZXhUb0ludChzdHIuY2hhckNvZGVBdChzdGFydCArIDMpKSA8PCA4KSB8CiAgICAgICAgKGhleFRvSW50KHN0ci5jaGFyQ29kZUF0KHN0YXJ0KSkgPDwgNCkgfAogICAgICAgIGhleFRvSW50KHN0ci5jaGFyQ29kZUF0KHN0YXJ0ICsgMSkpKTsKICAgIHN0YXJ0ICs9IDQ7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCmZ1bmN0aW9uIHBhcnNlSGV4U3RyaW5nKHN0ciwgZW5jb2RpbmcpIHsKICBpZiAoZW5jb2RpbmcgPT09ICdVVEYtOCcpIHsKICAgIHJldHVybiBkZWNvZGVVdGY4KHBhcnNlSGV4VXRmOChzdHIsIDAsIHN0ci5sZW5ndGgpKTsKICB9IGVsc2UgewogICAgcmV0dXJuIHBhcnNlSGV4VXRmMTYoc3RyLCAwLCBzdHIubGVuZ3RoKTsKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gcGFyc2VIZXhTdHJpbmc7Cn0se31dLDc3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gb3JpZ2luYWxseSBwYXJzZVVyaSAxLjIuMiwgbm93IHBhdGNoZWQgYnkgdXMKLy8gKGMpIFN0ZXZlbiBMZXZpdGhhbiA8c3RldmVubGV2aXRoYW4uY29tPgovLyBNSVQgTGljZW5zZQp2YXIga2V5cyA9IFsic291cmNlIiwgInByb3RvY29sIiwgImF1dGhvcml0eSIsICJ1c2VySW5mbyIsICJ1c2VyIiwgInBhc3N3b3JkIiwKICAgICJob3N0IiwgInBvcnQiLCAicmVsYXRpdmUiLCAicGF0aCIsICJkaXJlY3RvcnkiLCAiZmlsZSIsICJxdWVyeSIsICJhbmNob3IiXTsKdmFyIHFOYW1lID0icXVlcnlLZXkiOwp2YXIgcVBhcnNlciA9IC8oPzpefCYpKFteJj1dKik9PyhbXiZdKikvZzsKCi8vIHVzZSB0aGUgImxvb3NlIiBwYXJzZXIKLyoganNoaW50IG1heGxlbjogZmFsc2UgKi8KdmFyIHBhcnNlciA9IC9eKD86KD8hW146QF0rOlteOkBcL10qQCkoW146XC8/Iy5dKyk6KT8oPzpcL1wvKT8oKD86KChbXjpAXSopKD86OihbXjpAXSopKT8pP0ApPyhbXjpcLz8jXSopKD86OihcZCopKT8pKCgoXC8oPzpbXj8jXSg/IVtePyNcL10qXC5bXj8jXC8uXSsoPzpbPyNdfCQpKSkqXC8/KT8oW14/I1wvXSopKSg/Olw/KFteI10qKSk/KD86IyguKikpPykvOwoKZnVuY3Rpb24gcGFyc2VVcmkoc3RyKSB7CiAgdmFyIG0gPSBwYXJzZXIuZXhlYyhzdHIpOwogIHZhciB1cmkgPSB7fTsKICB2YXIgaSA9IDE0OwoKICB3aGlsZSAoaS0tKSB7CiAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgIHZhciB2YWx1ZSA9IG1baV0gfHwgIiI7CiAgICB2YXIgZW5jb2RlZCA9IFsndXNlcicsICdwYXNzd29yZCddLmluZGV4T2Yoa2V5KSAhPT0gLTE7CiAgICB1cmlba2V5XSA9IGVuY29kZWQgPyBkZWNvZGVVUklDb21wb25lbnQodmFsdWUpIDogdmFsdWU7CiAgfQoKICB1cmlbcU5hbWVdID0ge307CiAgdXJpW2tleXNbMTJdXS5yZXBsYWNlKHFQYXJzZXIsIGZ1bmN0aW9uICgkMCwgJDEsICQyKSB7CiAgICBpZiAoJDEpIHsKICAgICAgdXJpW3FOYW1lXVskMV0gPSAkMjsKICAgIH0KICB9KTsKCiAgcmV0dXJuIHVyaTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBwYXJzZVVyaTsKfSx7fV0sNzg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBsaWtlIHVuZGVyc2NvcmUvbG9kYXNoIF8ucGljaygpCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gcGljayhvYmosIGFycikgewogIHZhciByZXMgPSB7fTsKICBmb3IgKHZhciBpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICB2YXIgcHJvcCA9IGFycltpXTsKICAgIGlmIChwcm9wIGluIG9iaikgewogICAgICByZXNbcHJvcF0gPSBvYmpbcHJvcF07CiAgICB9CiAgfQogIHJldHVybiByZXM7Cn07Cn0se31dLDc5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwovKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwptb2R1bGUuZXhwb3J0cyA9IHR5cGVvZiBQcm9taXNlID09PSAnZnVuY3Rpb24nID8gUHJvbWlzZSA6IHJlcXVpcmUoJ2xpZScpOwoKfSx7ImxpZSI6MTA0fV0sODA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpewondXNlIHN0cmljdCc7Cgp2YXIgUHJvbWlzZSA9IHJlcXVpcmUoJy4vcHJvbWlzZScpOwp2YXIgZ2V0QXJndW1lbnRzID0gcmVxdWlyZSgnYXJnc2FycmF5Jyk7CnZhciBjbG9uZSA9IHJlcXVpcmUoJy4vY2xvbmUnKTsKdmFyIG9uY2UgPSByZXF1aXJlKCcuL29uY2UnKTsKCmZ1bmN0aW9uIHRvUHJvbWlzZShmdW5jKSB7CiAgLy9jcmVhdGUgdGhlIGZ1bmN0aW9uIHdlIHdpbGwgYmUgcmV0dXJuaW5nCiAgcmV0dXJuIGdldEFyZ3VtZW50cyhmdW5jdGlvbiAoYXJncykgewogICAgLy8gQ2xvbmUgYXJndW1lbnRzCiAgICBhcmdzID0gY2xvbmUoYXJncyk7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgdGVtcENCID0KICAgICAgKHR5cGVvZiBhcmdzW2FyZ3MubGVuZ3RoIC0gMV0gPT09ICdmdW5jdGlvbicpID8gYXJncy5wb3AoKSA6IGZhbHNlOwogICAgLy8gaWYgdGhlIGxhc3QgYXJndW1lbnQgaXMgYSBmdW5jdGlvbiwgYXNzdW1lIGl0cyBhIGNhbGxiYWNrCiAgICB2YXIgdXNlZENCOwogICAgaWYgKHRlbXBDQikgewogICAgICAvLyBpZiBpdCB3YXMgYSBjYWxsYmFjaywgY3JlYXRlIGEgbmV3IGNhbGxiYWNrIHdoaWNoIGNhbGxzIGl0LAogICAgICAvLyBidXQgZG8gc28gYXN5bmMgc28gd2UgZG9uJ3QgdHJhcCBhbnkgZXJyb3JzCiAgICAgIHVzZWRDQiA9IGZ1bmN0aW9uIChlcnIsIHJlc3ApIHsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHRlbXBDQihlcnIsIHJlc3ApOwogICAgICAgIH0pOwogICAgICB9OwogICAgfQogICAgdmFyIHByb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAoZnVsZmlsbCwgcmVqZWN0KSB7CiAgICAgIHZhciByZXNwOwogICAgICB0cnkgewogICAgICAgIHZhciBjYWxsYmFjayA9IG9uY2UoZnVuY3Rpb24gKGVyciwgbWVzZykgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZ1bGZpbGwobWVzZyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgLy8gY3JlYXRlIGEgY2FsbGJhY2sgZm9yIHRoaXMgaW52b2NhdGlvbgogICAgICAgIC8vIGFwcGx5IHRoZSBmdW5jdGlvbiBpbiB0aGUgb3JpZyBjb250ZXh0CiAgICAgICAgYXJncy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICByZXNwID0gZnVuYy5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICBpZiAocmVzcCAmJiB0eXBlb2YgcmVzcC50aGVuID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBmdWxmaWxsKHJlc3ApOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHJlamVjdChlKTsKICAgICAgfQogICAgfSk7CiAgICAvLyBpZiB0aGVyZSBpcyBhIGNhbGxiYWNrLCBjYWxsIGl0IGJhY2sKICAgIGlmICh1c2VkQ0IpIHsKICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICB1c2VkQ0IobnVsbCwgcmVzdWx0KTsKICAgICAgfSwgdXNlZENCKTsKICAgIH0KICAgIHJldHVybiBwcm9taXNlOwogIH0pOwp9Cgptb2R1bGUuZXhwb3J0cyA9IHRvUHJvbWlzZTsKCn0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiLi9jbG9uZSI6NTMsIi4vb25jZSI6NzUsIi4vcHJvbWlzZSI6NzksIl9wcm9jZXNzIjo4LCJhcmdzYXJyYXkiOjZ9XSw4MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBQcm9taXNlID0gcmVxdWlyZSgnLi9wcm9taXNlJyk7CgovLyB0aGlzIGlzIGVzc2VudGlhbGx5IHRoZSAidXBkYXRlIHN1Z2FyIiBmdW5jdGlvbiBmcm9tIGRhbGVoYXJ2ZXkvcG91Y2hkYiMxMzg4Ci8vIHRoZSBkaWZmRnVuIHRlbGxzIHVzIHdoYXQgZGVsdGEgdG8gYXBwbHkgdG8gdGhlIGRvYy4gIGl0IGVpdGhlciByZXR1cm5zCi8vIHRoZSBkb2MsIG9yIGZhbHNlIGlmIGl0IGRvZXNuJ3QgbmVlZCB0byBkbyBhbiB1cGRhdGUgYWZ0ZXIgYWxsCnZhciB1cHNlcnQgPSBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIHVwc2VydChkYiwgZG9jSWQsIGRpZmZGdW4pIHsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKGZ1bGZpbGwsIHJlamVjdCkgewogICAgaWYgKHR5cGVvZiBkb2NJZCAhPT0gJ3N0cmluZycpIHsKICAgICAgcmV0dXJuIHJlamVjdChuZXcgRXJyb3IoJ2RvYyBpZCBpcyByZXF1aXJlZCcpKTsKICAgIH0KCiAgICBkYi5nZXQoZG9jSWQsIGZ1bmN0aW9uIChlcnIsIGRvYykgewogICAgICBpZiAoZXJyKSB7CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgICAgICBpZiAoZXJyLnN0YXR1cyAhPT0gNDA0KSB7CiAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7CiAgICAgICAgfQogICAgICAgIGRvYyA9IHt9OwogICAgICB9CgogICAgICAvLyB0aGUgdXNlciBtaWdodCBjaGFuZ2UgdGhlIF9yZXYsIHNvIHNhdmUgaXQgZm9yIHBvc3Rlcml0eQogICAgICB2YXIgZG9jUmV2ID0gZG9jLl9yZXY7CiAgICAgIHZhciBuZXdEb2MgPSBkaWZmRnVuKGRvYyk7CgogICAgICBpZiAoIW5ld0RvYykgewogICAgICAgIC8vIGlmIHRoZSBkaWZmRnVuIHJldHVybnMgZmFsc3ksIHdlIHNob3J0LWNpcmN1aXQgYXMKICAgICAgICAvLyBhbiBvcHRpbWl6YXRpb24KICAgICAgICByZXR1cm4gZnVsZmlsbCh7dXBkYXRlZDogZmFsc2UsIHJldjogZG9jUmV2fSk7CiAgICAgIH0KCiAgICAgIC8vIHVzZXJzIGFyZW4ndCBhbGxvd2VkIHRvIG1vZGlmeSB0aGVzZSB2YWx1ZXMsCiAgICAgIC8vIHNvIHJlc2V0IHRoZW0gaGVyZQogICAgICBuZXdEb2MuX2lkID0gZG9jSWQ7CiAgICAgIG5ld0RvYy5fcmV2ID0gZG9jUmV2OwogICAgICBmdWxmaWxsKHRyeUFuZFB1dChkYiwgbmV3RG9jLCBkaWZmRnVuKSk7CiAgICB9KTsKICB9KTsKfTsKCmZ1bmN0aW9uIHRyeUFuZFB1dChkYiwgZG9jLCBkaWZmRnVuKSB7CiAgcmV0dXJuIGRiLnB1dChkb2MpLnRoZW4oZnVuY3Rpb24gKHJlcykgewogICAgcmV0dXJuIHsKICAgICAgdXBkYXRlZDogdHJ1ZSwKICAgICAgcmV2OiByZXMucmV2CiAgICB9OwogIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICBpZiAoZXJyLnN0YXR1cyAhPT0gNDA5KSB7CiAgICAgIHRocm93IGVycjsKICAgIH0KICAgIHJldHVybiB1cHNlcnQoZGIsIGRvYy5faWQsIGRpZmZGdW4pOwogIH0pOwp9Cgp9LHsiLi9wcm9taXNlIjo3OX1dLDgyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKLy8gQkVHSU4gTWF0aC51dWlkLmpzCgovKiEKTWF0aC51dWlkLmpzICh2MS40KQpodHRwOi8vd3d3LmJyb29mYS5jb20KbWFpbHRvOnJvYmVydEBicm9vZmEuY29tCgpDb3B5cmlnaHQgKGMpIDIwMTAgUm9iZXJ0IEtpZWZmZXIKRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCiovCgovKgogKiBHZW5lcmF0ZSBhIHJhbmRvbSB1dWlkLgogKgogKiBVU0FHRTogTWF0aC51dWlkKGxlbmd0aCwgcmFkaXgpCiAqICAgbGVuZ3RoIC0gdGhlIGRlc2lyZWQgbnVtYmVyIG9mIGNoYXJhY3RlcnMKICogICByYWRpeCAgLSB0aGUgbnVtYmVyIG9mIGFsbG93YWJsZSB2YWx1ZXMgZm9yIGVhY2ggY2hhcmFjdGVyLgogKgogKiBFWEFNUExFUzoKICogICAvLyBObyBhcmd1bWVudHMgIC0gcmV0dXJucyBSRkM0MTIyLCB2ZXJzaW9uIDQgSUQKICogICA+Pj4gTWF0aC51dWlkKCkKICogICAiOTIzMjlEMzktNkY1Qy00NTIwLUFCRkMtQUFCNjQ1NDRFMTcyIgogKgogKiAgIC8vIE9uZSBhcmd1bWVudCAtIHJldHVybnMgSUQgb2YgdGhlIHNwZWNpZmllZCBsZW5ndGgKICogICA+Pj4gTWF0aC51dWlkKDE1KSAgICAgLy8gMTUgY2hhcmFjdGVyIElEIChkZWZhdWx0IGJhc2U9NjIpCiAqICAgIlZjeWR4Z2x0eHJWWlNUViIKICoKICogICAvLyBUd28gYXJndW1lbnRzIC0gcmV0dXJucyBJRCBvZiB0aGUgc3BlY2lmaWVkIGxlbmd0aCwgYW5kIHJhZGl4LiAKICogICAvLyAoUmFkaXggbXVzdCBiZSA8PSA2MikKICogICA+Pj4gTWF0aC51dWlkKDgsIDIpICAvLyA4IGNoYXJhY3RlciBJRCAoYmFzZT0yKQogKiAgICIwMTAwMTAxMCIKICogICA+Pj4gTWF0aC51dWlkKDgsIDEwKSAvLyA4IGNoYXJhY3RlciBJRCAoYmFzZT0xMCkKICogICAiNDc0NzMwNDYiCiAqICAgPj4+IE1hdGgudXVpZCg4LCAxNikgLy8gOCBjaGFyYWN0ZXIgSUQgKGJhc2U9MTYpCiAqICAgIjA5OEY0RDM1IgogKi8KdmFyIGNoYXJzID0gKAogICcwMTIzNDU2Nzg5QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVonICsKICAnYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXonCikuc3BsaXQoJycpOwpmdW5jdGlvbiBnZXRWYWx1ZShyYWRpeCkgewogIHJldHVybiAwIHwgTWF0aC5yYW5kb20oKSAqIHJhZGl4Owp9CmZ1bmN0aW9uIHV1aWQobGVuLCByYWRpeCkgewogIHJhZGl4ID0gcmFkaXggfHwgY2hhcnMubGVuZ3RoOwogIHZhciBvdXQgPSAnJzsKICB2YXIgaSA9IC0xOwoKICBpZiAobGVuKSB7CiAgICAvLyBDb21wYWN0IGZvcm0KICAgIHdoaWxlICgrK2kgPCBsZW4pIHsKICAgICAgb3V0ICs9IGNoYXJzW2dldFZhbHVlKHJhZGl4KV07CiAgICB9CiAgICByZXR1cm4gb3V0OwogIH0KICAgIC8vIHJmYzQxMjIsIHZlcnNpb24gNCBmb3JtCiAgICAvLyBGaWxsIGluIHJhbmRvbSBkYXRhLiAgQXQgaT09MTkgc2V0IHRoZSBoaWdoIGJpdHMgb2YgY2xvY2sgc2VxdWVuY2UgYXMKICAgIC8vIHBlciByZmM0MTIyLCBzZWMuIDQuMS41CiAgd2hpbGUgKCsraSA8IDM2KSB7CiAgICBzd2l0Y2ggKGkpIHsKICAgICAgY2FzZSA4OgogICAgICBjYXNlIDEzOgogICAgICBjYXNlIDE4OgogICAgICBjYXNlIDIzOgogICAgICAgIG91dCArPSAnLSc7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMTk6CiAgICAgICAgb3V0ICs9IGNoYXJzWyhnZXRWYWx1ZSgxNikgJiAweDMpIHwgMHg4XTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBvdXQgKz0gY2hhcnNbZ2V0VmFsdWUoMTYpXTsKICAgIH0KICB9CgogIHJldHVybiBvdXQ7Cn0KCgoKbW9kdWxlLmV4cG9ydHMgPSB1dWlkOwoKCn0se31dLDgzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSBldmFsRmlsdGVyOwpmdW5jdGlvbiBldmFsRmlsdGVyKGlucHV0KSB7CiAgLypqc2hpbnQgZXZpbDogdHJ1ZSAqLwogIHJldHVybiBldmFsKFsKICAgICcoZnVuY3Rpb24gKCkgeyByZXR1cm4gJywKICAgIGlucHV0LAogICAgJyB9KSgpJwogIF0uam9pbignJykpOwp9Cn0se31dLDg0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSBldmFsVmlldzsKZnVuY3Rpb24gZXZhbFZpZXcoaW5wdXQpIHsKICAvKmpzaGludCBldmlsOiB0cnVlICovCiAgcmV0dXJuIGV2YWwoWwogICAgJyhmdW5jdGlvbiAoKSB7JywKICAgICcgIHJldHVybiBmdW5jdGlvbiAoZG9jKSB7JywKICAgICcgICAgdmFyIGVtaXR0ZWQgPSBmYWxzZTsnLAogICAgJyAgICB2YXIgZW1pdCA9IGZ1bmN0aW9uIChhLCBiKSB7JywKICAgICcgICAgICBlbWl0dGVkID0gdHJ1ZTsnLAogICAgJyAgICB9OycsCiAgICAnICAgIHZhciB2aWV3ID0gJyArIGlucHV0ICsgJzsnLAogICAgJyAgICB2aWV3KGRvYyk7JywKICAgICcgICAgaWYgKGVtaXR0ZWQpIHsnLAogICAgJyAgICAgIHJldHVybiB0cnVlOycsCiAgICAnICAgIH0nLAogICAgJyAgfScsCiAgICAnfSkoKScKICBdLmpvaW4oJ1xuJykpOwp9Cn0se31dLDg1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKdmFyIFBvdWNoREIgPSByZXF1aXJlKCcuL3NldHVwJyk7Cgptb2R1bGUuZXhwb3J0cyA9IFBvdWNoREI7CgpQb3VjaERCLmFqYXggPSByZXF1aXJlKCcuL2RlcHMvYWpheC9wcmVxdWVzdCcpOwpQb3VjaERCLnV0aWxzID0gcmVxdWlyZSgnLi91dGlscycpOwpQb3VjaERCLkVycm9ycyA9IHJlcXVpcmUoJy4vZGVwcy9lcnJvcnMnKTsKUG91Y2hEQi5yZXBsaWNhdGUgPSByZXF1aXJlKCcuL3JlcGxpY2F0ZScpLnJlcGxpY2F0ZTsKUG91Y2hEQi5zeW5jID0gcmVxdWlyZSgnLi9zeW5jJyk7ClBvdWNoREIudmVyc2lvbiA9IHJlcXVpcmUoJy4vdmVyc2lvbicpOwp2YXIgaHR0cEFkYXB0ZXIgPSByZXF1aXJlKCcuL2FkYXB0ZXJzL2h0dHAnKTsKUG91Y2hEQi5hZGFwdGVyKCdodHRwJywgaHR0cEFkYXB0ZXIpOwpQb3VjaERCLmFkYXB0ZXIoJ2h0dHBzJywgaHR0cEFkYXB0ZXIpOwoKUG91Y2hEQi5wbHVnaW4ocmVxdWlyZSgnLi9tYXByZWR1Y2UnKSk7Cgp2YXIgYWRhcHRlcnMgPSByZXF1aXJlKCcuL2FkYXB0ZXJzJyk7CgpPYmplY3Qua2V5cyhhZGFwdGVycykuZm9yRWFjaChmdW5jdGlvbiAoYWRhcHRlck5hbWUpIHsKICBQb3VjaERCLmFkYXB0ZXIoYWRhcHRlck5hbWUsIGFkYXB0ZXJzW2FkYXB0ZXJOYW1lXSwgdHJ1ZSk7Cn0pOwoKfSx7Ii4vYWRhcHRlcnMiOjE1LCIuL2FkYXB0ZXJzL2h0dHAiOjE2LCIuL2RlcHMvYWpheC9wcmVxdWVzdCI6MzgsIi4vZGVwcy9lcnJvcnMiOjY0LCIuL21hcHJlZHVjZSI6ODgsIi4vcmVwbGljYXRlIjo5NiwiLi9zZXR1cCI6OTksIi4vc3luYyI6MTAwLCIuL3V0aWxzIjoxMDIsIi4vdmVyc2lvbiI6MTAzfV0sODY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgdXBzZXJ0ID0gcmVxdWlyZSgnLi4vZGVwcy91cHNlcnQnKTsKdmFyIFByb21pc2UgPSByZXF1aXJlKCcuLi9kZXBzL3Byb21pc2UnKTsKdmFyIG1kNSA9IHJlcXVpcmUoJy4vbWQ1Jyk7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChvcHRzKSB7CiAgdmFyIHNvdXJjZURCID0gb3B0cy5kYjsKICB2YXIgdmlld05hbWUgPSBvcHRzLnZpZXdOYW1lOwogIHZhciBtYXBGdW4gPSBvcHRzLm1hcDsKICB2YXIgcmVkdWNlRnVuID0gb3B0cy5yZWR1Y2U7CiAgdmFyIHRlbXBvcmFyeSA9IG9wdHMudGVtcG9yYXJ5OwoKICAvLyB0aGUgInVuZGVmaW5lZCIgcGFydCBpcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkKICB2YXIgdmlld1NpZ25hdHVyZSA9IG1hcEZ1bi50b1N0cmluZygpICsgKHJlZHVjZUZ1biAmJiByZWR1Y2VGdW4udG9TdHJpbmcoKSkgKwogICAgJ3VuZGVmaW5lZCc7CgogIGlmICghdGVtcG9yYXJ5ICYmIHNvdXJjZURCLl9jYWNoZWRWaWV3cykgewogICAgdmFyIGNhY2hlZFZpZXcgPSBzb3VyY2VEQi5fY2FjaGVkVmlld3Nbdmlld1NpZ25hdHVyZV07CiAgICBpZiAoY2FjaGVkVmlldykgewogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNhY2hlZFZpZXcpOwogICAgfQogIH0KCiAgcmV0dXJuIHNvdXJjZURCLmluZm8oKS50aGVuKGZ1bmN0aW9uIChpbmZvKSB7CgogICAgdmFyIGRlcERiTmFtZSA9IGluZm8uZGJfbmFtZSArICctbXJ2aWV3LScgKwogICAgICAodGVtcG9yYXJ5ID8gJ3RlbXAnIDogbWQ1KHZpZXdTaWduYXR1cmUpKTsKCiAgICAvLyBzYXZlIHRoZSB2aWV3IG5hbWUgaW4gdGhlIHNvdXJjZSBkYiBzbyBpdCBjYW4gYmUgY2xlYW5lZCB1cCBpZiBuZWNlc3NhcnkKICAgIC8vIChlLmcuIHdoZW4gdGhlIF9kZXNpZ24gZG9jIGlzIGRlbGV0ZWQsIHJlbW92ZSBhbGwgYXNzb2NpYXRlZCB2aWV3IGRhdGEpCiAgICBmdW5jdGlvbiBkaWZmRnVuY3Rpb24oZG9jKSB7CiAgICAgIGRvYy52aWV3cyA9IGRvYy52aWV3cyB8fCB7fTsKICAgICAgdmFyIGZ1bGxWaWV3TmFtZSA9IHZpZXdOYW1lOwogICAgICBpZiAoZnVsbFZpZXdOYW1lLmluZGV4T2YoJy8nKSA9PT0gLTEpIHsKICAgICAgICBmdWxsVmlld05hbWUgPSB2aWV3TmFtZSArICcvJyArIHZpZXdOYW1lOwogICAgICB9CiAgICAgIHZhciBkZXBEYnMgPSBkb2Mudmlld3NbZnVsbFZpZXdOYW1lXSA9IGRvYy52aWV3c1tmdWxsVmlld05hbWVdIHx8IHt9OwogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgaWYgKGRlcERic1tkZXBEYk5hbWVdKSB7CiAgICAgICAgcmV0dXJuOyAvLyBubyB1cGRhdGUgbmVjZXNzYXJ5CiAgICAgIH0KICAgICAgZGVwRGJzW2RlcERiTmFtZV0gPSB0cnVlOwogICAgICByZXR1cm4gZG9jOwogICAgfQogICAgcmV0dXJuIHVwc2VydChzb3VyY2VEQiwgJ19sb2NhbC9tcnZpZXdzJywgZGlmZkZ1bmN0aW9uKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHNvdXJjZURCLnJlZ2lzdGVyRGVwZW5kZW50RGF0YWJhc2UoZGVwRGJOYW1lKS50aGVuKGZ1bmN0aW9uIChyZXMpIHsKICAgICAgICB2YXIgZGIgPSByZXMuZGI7CiAgICAgICAgZGIuYXV0b19jb21wYWN0aW9uID0gdHJ1ZTsKICAgICAgICB2YXIgdmlldyA9IHsKICAgICAgICAgIG5hbWU6IGRlcERiTmFtZSwKICAgICAgICAgIGRiOiBkYiwKICAgICAgICAgIHNvdXJjZURCOiBzb3VyY2VEQiwKICAgICAgICAgIGFkYXB0ZXI6IHNvdXJjZURCLmFkYXB0ZXIsCiAgICAgICAgICBtYXBGdW46IG1hcEZ1biwKICAgICAgICAgIHJlZHVjZUZ1bjogcmVkdWNlRnVuCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gdmlldy5kYi5nZXQoJ19sb2NhbC9sYXN0U2VxJykuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgICBpZiAoZXJyLnN0YXR1cyAhPT0gNDA0KSB7CiAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgIH0KICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChsYXN0U2VxRG9jKSB7CiAgICAgICAgICB2aWV3LnNlcSA9IGxhc3RTZXFEb2MgPyBsYXN0U2VxRG9jLnNlcSA6IDA7CiAgICAgICAgICBpZiAoIXRlbXBvcmFyeSkgewogICAgICAgICAgICBzb3VyY2VEQi5fY2FjaGVkVmlld3MgPSBzb3VyY2VEQi5fY2FjaGVkVmlld3MgfHwge307CiAgICAgICAgICAgIHNvdXJjZURCLl9jYWNoZWRWaWV3c1t2aWV3U2lnbmF0dXJlXSA9IHZpZXc7CiAgICAgICAgICAgIHZpZXcuZGIub25jZSgnZGVzdHJveWVkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGRlbGV0ZSBzb3VyY2VEQi5fY2FjaGVkVmlld3Nbdmlld1NpZ25hdHVyZV07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZpZXc7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSk7CiAgfSk7Cn07Cgp9LHsiLi4vZGVwcy9wcm9taXNlIjo3OSwiLi4vZGVwcy91cHNlcnQiOjgxLCIuL21kNSI6ODl9XSw4NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKGZ1bmMsIGVtaXQsIHN1bSwgbG9nLCBpc0FycmF5LCB0b0pTT04pIHsKICAvKmpzaGludCBldmlsOnRydWUsdW51c2VkOmZhbHNlICovCiAgcmV0dXJuIGV2YWwoIigiICsgZnVuYy5yZXBsYWNlKC87XHMqJC8sICIiKSArICIpOyIpOwp9OwoKfSx7fV0sODg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpewondXNlIHN0cmljdCc7Cgp2YXIgYjY0VG9CbHVmZmVyID0gcmVxdWlyZSgnLi4vZGVwcy9iaW5hcnkvYmFzZTY0U3RyaW5nVG9CbG9iT3JCdWZmZXInKTsKdmFyIHBvdWNoQ29sbGF0ZSA9IHJlcXVpcmUoJ3BvdWNoZGItY29sbGF0ZScpOwp2YXIgVGFza1F1ZXVlID0gcmVxdWlyZSgnLi90YXNrcXVldWUnKTsKdmFyIGNvbGxhdGUgPSBwb3VjaENvbGxhdGUuY29sbGF0ZTsKdmFyIHRvSW5kZXhhYmxlU3RyaW5nID0gcG91Y2hDb2xsYXRlLnRvSW5kZXhhYmxlU3RyaW5nOwp2YXIgbm9ybWFsaXplS2V5ID0gcG91Y2hDb2xsYXRlLm5vcm1hbGl6ZUtleTsKdmFyIHBhcnNlSW5kZXhhYmxlU3RyaW5nID0gcG91Y2hDb2xsYXRlLnBhcnNlSW5kZXhhYmxlU3RyaW5nOwp2YXIgY3JlYXRlVmlldyA9IHJlcXVpcmUoJy4vY3JlYXRlVmlldycpOwp2YXIgZXZhbEZ1bmMgPSByZXF1aXJlKCcuL2V2YWxmdW5jJyk7CnZhciBsb2c7Ci8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCmlmICgodHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnKSAmJiAodHlwZW9mIGNvbnNvbGUubG9nID09PSAnZnVuY3Rpb24nKSkgewogIGxvZyA9IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kLmNhbGwoY29uc29sZS5sb2csIGNvbnNvbGUpOwp9IGVsc2UgewogIGxvZyA9IGZ1bmN0aW9uICgpIHt9Owp9CnZhciB1dGlscyA9IHJlcXVpcmUoJy4vdXRpbHMnKTsKdmFyIFByb21pc2UgPSByZXF1aXJlKCcuLi9kZXBzL3Byb21pc2UnKTsKdmFyIGluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKdmFyIHBlcnNpc3RlbnRRdWV1ZXMgPSB7fTsKdmFyIHRlbXBWaWV3UXVldWUgPSBuZXcgVGFza1F1ZXVlKCk7CnZhciBDSEFOR0VTX0JBVENIX1NJWkUgPSA1MDsKCmZ1bmN0aW9uIHBhcnNlVmlld05hbWUobmFtZSkgewogIC8vIGNhbiBiZSBlaXRoZXIgJ2Rkb2NuYW1lL3ZpZXduYW1lJyBvciBqdXN0ICd2aWV3bmFtZScKICAvLyAod2hlcmUgdGhlIGRkb2MgbmFtZSBpcyB0aGUgc2FtZSkKICByZXR1cm4gbmFtZS5pbmRleE9mKCcvJykgPT09IC0xID8gW25hbWUsIG5hbWVdIDogbmFtZS5zcGxpdCgnLycpOwp9CgpmdW5jdGlvbiBpc0dlbk9uZShjaGFuZ2VzKSB7CiAgLy8gb25seSByZXR1cm4gdHJ1ZSBpZiB0aGUgY3VycmVudCBjaGFuZ2UgaXMgMS0KICAvLyBhbmQgdGhlcmUgYXJlIG5vIG90aGVyIGxlYWZzCiAgcmV0dXJuIGNoYW5nZXMubGVuZ3RoID09PSAxICYmIC9eMS0vLnRlc3QoY2hhbmdlc1swXS5yZXYpOwp9CgpmdW5jdGlvbiBlbWl0RXJyb3IoZGIsIGUpIHsKICB0cnkgewogICAgZGIuZW1pdCgnZXJyb3InLCBlKTsKICB9IGNhdGNoIChlcnIpIHsKICAgIGNvbnNvbGUuZXJyb3IoCiAgICAgICdUaGUgdXNlclwncyBtYXAvcmVkdWNlIGZ1bmN0aW9uIHRocmV3IGFuIHVuY2F1Z2h0IGVycm9yLlxuJyArCiAgICAgICdZb3UgY2FuIGRlYnVnIHRoaXMgZXJyb3IgYnkgZG9pbmc6XG4nICsKICAgICAgJ215RGF0YWJhc2Uub24oXCdlcnJvclwnLCBmdW5jdGlvbiAoZXJyKSB7IGRlYnVnZ2VyOyB9KTtcbicgKwogICAgICAnUGxlYXNlIGRvdWJsZS1jaGVjayB5b3VyIG1hcC9yZWR1Y2UgZnVuY3Rpb24uJyk7CiAgICBjb25zb2xlLmVycm9yKGUpOwogIH0KfQoKZnVuY3Rpb24gdHJ5Q29kZShkYiwgZnVuLCBhcmdzKSB7CiAgLy8gZW1pdCBhbiBldmVudCBpZiB0aGVyZSB3YXMgYW4gZXJyb3IgdGhyb3duIGJ5IGEgbWFwL3JlZHVjZSBmdW5jdGlvbi4KICAvLyBwdXR0aW5nIHRyeS9jYXRjaGVzIGluIGEgc2luZ2xlIGZ1bmN0aW9uIGFsc28gYXZvaWRzIGRlb3B0aW1pemF0aW9ucy4KICB0cnkgewogICAgcmV0dXJuIHsKICAgICAgb3V0cHV0IDogZnVuLmFwcGx5KG51bGwsIGFyZ3MpCiAgICB9OwogIH0gY2F0Y2ggKGUpIHsKICAgIGVtaXRFcnJvcihkYiwgZSk7CiAgICByZXR1cm4ge2Vycm9yOiBlfTsKICB9Cn0KCmZ1bmN0aW9uIHNvcnRCeUtleVRoZW5WYWx1ZSh4LCB5KSB7CiAgdmFyIGtleUNvbXBhcmUgPSBjb2xsYXRlKHgua2V5LCB5LmtleSk7CiAgcmV0dXJuIGtleUNvbXBhcmUgIT09IDAgPyBrZXlDb21wYXJlIDogY29sbGF0ZSh4LnZhbHVlLCB5LnZhbHVlKTsKfQoKZnVuY3Rpb24gc2xpY2VSZXN1bHRzKHJlc3VsdHMsIGxpbWl0LCBza2lwKSB7CiAgc2tpcCA9IHNraXAgfHwgMDsKICBpZiAodHlwZW9mIGxpbWl0ID09PSAnbnVtYmVyJykgewogICAgcmV0dXJuIHJlc3VsdHMuc2xpY2Uoc2tpcCwgbGltaXQgKyBza2lwKTsKICB9IGVsc2UgaWYgKHNraXAgPiAwKSB7CiAgICByZXR1cm4gcmVzdWx0cy5zbGljZShza2lwKTsKICB9CiAgcmV0dXJuIHJlc3VsdHM7Cn0KCmZ1bmN0aW9uIHJvd1RvRG9jSWQocm93KSB7CiAgdmFyIHZhbCA9IHJvdy52YWx1ZTsKICAvLyBVc2VycyBjYW4gZXhwbGljaXRseSBzcGVjaWZ5IGEgam9pbmVkIGRvYyBfaWQsIG9yIGl0CiAgLy8gZGVmYXVsdHMgdG8gdGhlIGRvYyBfaWQgdGhhdCBlbWl0dGVkIHRoZSBrZXkvdmFsdWUuCiAgdmFyIGRvY0lkID0gKHZhbCAmJiB0eXBlb2YgdmFsID09PSAnb2JqZWN0JyAmJiB2YWwuX2lkKSB8fCByb3cuaWQ7CiAgcmV0dXJuIGRvY0lkOwp9CgpmdW5jdGlvbiByZWFkQXR0YWNobWVudHNBc0Jsb2JPckJ1ZmZlcihyZXMpIHsKICByZXMucm93cy5mb3JFYWNoKGZ1bmN0aW9uIChyb3cpIHsKICAgIHZhciBhdHRzID0gcm93LmRvYyAmJiByb3cuZG9jLl9hdHRhY2htZW50czsKICAgIGlmICghYXR0cykgewogICAgICByZXR1cm47CiAgICB9CiAgICBPYmplY3Qua2V5cyhhdHRzKS5mb3JFYWNoKGZ1bmN0aW9uIChmaWxlbmFtZSkgewogICAgICB2YXIgYXR0ID0gYXR0c1tmaWxlbmFtZV07CiAgICAgIGF0dHNbZmlsZW5hbWVdLmRhdGEgPSBiNjRUb0JsdWZmZXIoYXR0LmRhdGEsIGF0dC5jb250ZW50X3R5cGUpOwogICAgfSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIHBvc3Rwcm9jZXNzQXR0YWNobWVudHMob3B0cykgewogIHJldHVybiBmdW5jdGlvbiAocmVzKSB7CiAgICBpZiAob3B0cy5pbmNsdWRlX2RvY3MgJiYgb3B0cy5hdHRhY2htZW50cyAmJiBvcHRzLmJpbmFyeSkgewogICAgICByZWFkQXR0YWNobWVudHNBc0Jsb2JPckJ1ZmZlcihyZXMpOwogICAgfQogICAgcmV0dXJuIHJlczsKICB9Owp9CgpmdW5jdGlvbiBjcmVhdGVCdWlsdEluRXJyb3IobmFtZSkgewogIHZhciBtZXNzYWdlID0gJ2J1aWx0aW4gJyArIG5hbWUgKwogICAgJyBmdW5jdGlvbiByZXF1aXJlcyBtYXAgdmFsdWVzIHRvIGJlIG51bWJlcnMnICsKICAgICcgb3IgbnVtYmVyIGFycmF5cyc7CiAgcmV0dXJuIG5ldyBCdWlsdEluRXJyb3IobWVzc2FnZSk7Cn0KCmZ1bmN0aW9uIHN1bSh2YWx1ZXMpIHsKICB2YXIgcmVzdWx0ID0gMDsKICBmb3IgKHZhciBpID0gMCwgbGVuID0gdmFsdWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICB2YXIgbnVtID0gdmFsdWVzW2ldOwogICAgaWYgKHR5cGVvZiBudW0gIT09ICdudW1iZXInKSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KG51bSkpIHsKICAgICAgICAvLyBsaXN0cyBvZiBudW1iZXJzIGFyZSBhbHNvIGFsbG93ZWQsIHN1bSB0aGVtIHNlcGFyYXRlbHkKICAgICAgICByZXN1bHQgPSB0eXBlb2YgcmVzdWx0ID09PSAnbnVtYmVyJyA/IFtyZXN1bHRdIDogcmVzdWx0OwogICAgICAgIGZvciAodmFyIGogPSAwLCBqTGVuID0gbnVtLmxlbmd0aDsgaiA8IGpMZW47IGorKykgewogICAgICAgICAgdmFyIGpOdW0gPSBudW1bal07CiAgICAgICAgICBpZiAodHlwZW9mIGpOdW0gIT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIHRocm93IGNyZWF0ZUJ1aWx0SW5FcnJvcignX3N1bScpOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcmVzdWx0W2pdID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICByZXN1bHQucHVzaChqTnVtKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdFtqXSArPSBqTnVtOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsgLy8gbm90IGFycmF5L251bWJlcgogICAgICAgIHRocm93IGNyZWF0ZUJ1aWx0SW5FcnJvcignX3N1bScpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHR5cGVvZiByZXN1bHQgPT09ICdudW1iZXInKSB7CiAgICAgIHJlc3VsdCArPSBudW07CiAgICB9IGVsc2UgeyAvLyBhZGQgbnVtYmVyIHRvIGFycmF5CiAgICAgIHJlc3VsdFswXSArPSBudW07CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCnZhciBidWlsdEluUmVkdWNlID0gewogIF9zdW06IGZ1bmN0aW9uIChrZXlzLCB2YWx1ZXMpIHsKICAgIHJldHVybiBzdW0odmFsdWVzKTsKICB9LAoKICBfY291bnQ6IGZ1bmN0aW9uIChrZXlzLCB2YWx1ZXMpIHsKICAgIHJldHVybiB2YWx1ZXMubGVuZ3RoOwogIH0sCgogIF9zdGF0czogZnVuY3Rpb24gKGtleXMsIHZhbHVlcykgewogICAgLy8gbm8gbmVlZCB0byBpbXBsZW1lbnQgcmVyZWR1Y2U9dHJ1ZSwgYmVjYXVzZSBQb3VjaAogICAgLy8gd2lsbCBuZXZlciBjYWxsIGl0CiAgICBmdW5jdGlvbiBzdW1zcXIodmFsdWVzKSB7CiAgICAgIHZhciBfc3Vtc3FyID0gMDsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHZhbHVlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgIHZhciBudW0gPSB2YWx1ZXNbaV07CiAgICAgICAgX3N1bXNxciArPSAobnVtICogbnVtKTsKICAgICAgfQogICAgICByZXR1cm4gX3N1bXNxcjsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHN1bSAgICAgOiBzdW0odmFsdWVzKSwKICAgICAgbWluICAgICA6IE1hdGgubWluLmFwcGx5KG51bGwsIHZhbHVlcyksCiAgICAgIG1heCAgICAgOiBNYXRoLm1heC5hcHBseShudWxsLCB2YWx1ZXMpLAogICAgICBjb3VudCAgIDogdmFsdWVzLmxlbmd0aCwKICAgICAgc3Vtc3FyIDogc3Vtc3FyKHZhbHVlcykKICAgIH07CiAgfQp9OwoKZnVuY3Rpb24gYWRkSHR0cFBhcmFtKHBhcmFtTmFtZSwgb3B0cywgcGFyYW1zLCBhc0pzb24pIHsKICAvLyBhZGQgYW4gaHR0cCBwYXJhbSBmcm9tIG9wdHMgdG8gcGFyYW1zLCBvcHRpb25hbGx5IGpzb24tZW5jb2RlZAogIHZhciB2YWwgPSBvcHRzW3BhcmFtTmFtZV07CiAgaWYgKHR5cGVvZiB2YWwgIT09ICd1bmRlZmluZWQnKSB7CiAgICBpZiAoYXNKc29uKSB7CiAgICAgIHZhbCA9IGVuY29kZVVSSUNvbXBvbmVudChKU09OLnN0cmluZ2lmeSh2YWwpKTsKICAgIH0KICAgIHBhcmFtcy5wdXNoKHBhcmFtTmFtZSArICc9JyArIHZhbCk7CiAgfQp9CgpmdW5jdGlvbiBjaGVja1F1ZXJ5UGFyc2VFcnJvcihvcHRpb25zLCBmdW4pIHsKICB2YXIgc3RhcnRrZXlOYW1lID0gb3B0aW9ucy5kZXNjZW5kaW5nID8gJ2VuZGtleScgOiAnc3RhcnRrZXknOwogIHZhciBlbmRrZXlOYW1lID0gb3B0aW9ucy5kZXNjZW5kaW5nID8gJ3N0YXJ0a2V5JyA6ICdlbmRrZXknOwoKICBpZiAodHlwZW9mIG9wdGlvbnNbc3RhcnRrZXlOYW1lXSAhPT0gJ3VuZGVmaW5lZCcgJiYKICAgIHR5cGVvZiBvcHRpb25zW2VuZGtleU5hbWVdICE9PSAndW5kZWZpbmVkJyAmJgogICAgY29sbGF0ZShvcHRpb25zW3N0YXJ0a2V5TmFtZV0sIG9wdGlvbnNbZW5ka2V5TmFtZV0pID4gMCkgewogICAgdGhyb3cgbmV3IFF1ZXJ5UGFyc2VFcnJvcignTm8gcm93cyBjYW4gbWF0Y2ggeW91ciBrZXkgcmFuZ2UsICcgKwogICAgJ3JldmVyc2UgeW91ciBzdGFydF9rZXkgYW5kIGVuZF9rZXkgb3Igc2V0IHtkZXNjZW5kaW5nIDogdHJ1ZX0nKTsKICB9IGVsc2UgaWYgKGZ1bi5yZWR1Y2UgJiYgb3B0aW9ucy5yZWR1Y2UgIT09IGZhbHNlKSB7CiAgICBpZiAob3B0aW9ucy5pbmNsdWRlX2RvY3MpIHsKICAgICAgdGhyb3cgbmV3IFF1ZXJ5UGFyc2VFcnJvcigne2luY2x1ZGVfZG9jczp0cnVlfSBpcyBpbnZhbGlkIGZvciByZWR1Y2UnKTsKICAgIH0gZWxzZSBpZiAob3B0aW9ucy5rZXlzICYmIG9wdGlvbnMua2V5cy5sZW5ndGggPiAxICYmCiAgICAgICAgIW9wdGlvbnMuZ3JvdXAgJiYgIW9wdGlvbnMuZ3JvdXBfbGV2ZWwpIHsKICAgICAgdGhyb3cgbmV3IFF1ZXJ5UGFyc2VFcnJvcignTXVsdGkta2V5IGZldGNoZXMgZm9yIHJlZHVjZSB2aWV3cyBtdXN0IHVzZSAnICsKICAgICAgJ3tncm91cDogdHJ1ZX0nKTsKICAgIH0KICB9CiAgaWYgKG9wdGlvbnMuZ3JvdXBfbGV2ZWwpIHsKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5ncm91cF9sZXZlbCAhPT0gJ251bWJlcicpIHsKICAgICAgdGhyb3cgbmV3IFF1ZXJ5UGFyc2VFcnJvcignSW52YWxpZCB2YWx1ZSBmb3IgaW50ZWdlcjogIicgKwogICAgICBvcHRpb25zLmdyb3VwX2xldmVsICsgJyInKTsKICAgIH0KICAgIGlmIChvcHRpb25zLmdyb3VwX2xldmVsIDwgMCkgewogICAgICB0aHJvdyBuZXcgUXVlcnlQYXJzZUVycm9yKCdJbnZhbGlkIHZhbHVlIGZvciBwb3NpdGl2ZSBpbnRlZ2VyOiAnICsKICAgICAgICAnIicgKyBvcHRpb25zLmdyb3VwX2xldmVsICsgJyInKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGh0dHBRdWVyeShkYiwgZnVuLCBvcHRzKSB7CiAgLy8gTGlzdCBvZiBwYXJhbWV0ZXJzIHRvIGFkZCB0byB0aGUgUFVUIHJlcXVlc3QKICB2YXIgcGFyYW1zID0gW107CiAgdmFyIGJvZHk7CiAgdmFyIG1ldGhvZCA9ICdHRVQnOwoKICAvLyBJZiBvcHRzLnJlZHVjZSBleGlzdHMgYW5kIGlzIGRlZmluZWQsIHRoZW4gYWRkIGl0IHRvIHRoZSBsaXN0CiAgLy8gb2YgcGFyYW1ldGVycy4KICAvLyBJZiByZWR1Y2U9ZmFsc2UgdGhlbiB0aGUgcmVzdWx0cyBhcmUgdGhhdCBvZiBvbmx5IHRoZSBtYXAgZnVuY3Rpb24KICAvLyBub3QgdGhlIGZpbmFsIHJlc3VsdCBvZiBtYXAgYW5kIHJlZHVjZS4KICBhZGRIdHRwUGFyYW0oJ3JlZHVjZScsIG9wdHMsIHBhcmFtcyk7CiAgYWRkSHR0cFBhcmFtKCdpbmNsdWRlX2RvY3MnLCBvcHRzLCBwYXJhbXMpOwogIGFkZEh0dHBQYXJhbSgnYXR0YWNobWVudHMnLCBvcHRzLCBwYXJhbXMpOwogIGFkZEh0dHBQYXJhbSgnbGltaXQnLCBvcHRzLCBwYXJhbXMpOwogIGFkZEh0dHBQYXJhbSgnZGVzY2VuZGluZycsIG9wdHMsIHBhcmFtcyk7CiAgYWRkSHR0cFBhcmFtKCdncm91cCcsIG9wdHMsIHBhcmFtcyk7CiAgYWRkSHR0cFBhcmFtKCdncm91cF9sZXZlbCcsIG9wdHMsIHBhcmFtcyk7CiAgYWRkSHR0cFBhcmFtKCdza2lwJywgb3B0cywgcGFyYW1zKTsKICBhZGRIdHRwUGFyYW0oJ3N0YWxlJywgb3B0cywgcGFyYW1zKTsKICBhZGRIdHRwUGFyYW0oJ2NvbmZsaWN0cycsIG9wdHMsIHBhcmFtcyk7CiAgYWRkSHR0cFBhcmFtKCdzdGFydGtleScsIG9wdHMsIHBhcmFtcywgdHJ1ZSk7CiAgYWRkSHR0cFBhcmFtKCdzdGFydF9rZXknLCBvcHRzLCBwYXJhbXMsIHRydWUpOwogIGFkZEh0dHBQYXJhbSgnZW5ka2V5Jywgb3B0cywgcGFyYW1zLCB0cnVlKTsKICBhZGRIdHRwUGFyYW0oJ2VuZF9rZXknLCBvcHRzLCBwYXJhbXMsIHRydWUpOwogIGFkZEh0dHBQYXJhbSgnaW5jbHVzaXZlX2VuZCcsIG9wdHMsIHBhcmFtcyk7CiAgYWRkSHR0cFBhcmFtKCdrZXknLCBvcHRzLCBwYXJhbXMsIHRydWUpOwoKICAvLyBGb3JtYXQgdGhlIGxpc3Qgb2YgcGFyYW1ldGVycyBpbnRvIGEgdmFsaWQgVVJJIHF1ZXJ5IHN0cmluZwogIHBhcmFtcyA9IHBhcmFtcy5qb2luKCcmJyk7CiAgcGFyYW1zID0gcGFyYW1zID09PSAnJyA/ICcnIDogJz8nICsgcGFyYW1zOwoKICAvLyBJZiBrZXlzIGFyZSBzdXBwbGllZCwgaXNzdWUgYSBQT1NUIHRvIGNpcmN1bXZlbnQgR0VUIHF1ZXJ5IHN0cmluZyBsaW1pdHMKICAvLyBzZWUgaHR0cDovL3dpa2kuYXBhY2hlLm9yZy9jb3VjaGRiL0hUVFBfdmlld19BUEkjUXVlcnlpbmdfT3B0aW9ucwogIGlmICh0eXBlb2Ygb3B0cy5rZXlzICE9PSAndW5kZWZpbmVkJykgewogICAgdmFyIE1BWF9VUkxfTEVOR1RIID0gMjAwMDsKICAgIC8vIGFjY29yZGluZyB0byBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS80MTcxODQvNjgwNzQyLAogICAgLy8gdGhlIGRlIGZhY3RvIFVSTCBsZW5ndGggbGltaXQgaXMgMjAwMCBjaGFyYWN0ZXJzCgogICAgdmFyIGtleXNBc1N0cmluZyA9CiAgICAgICdrZXlzPScgKyBlbmNvZGVVUklDb21wb25lbnQoSlNPTi5zdHJpbmdpZnkob3B0cy5rZXlzKSk7CiAgICBpZiAoa2V5c0FzU3RyaW5nLmxlbmd0aCArIHBhcmFtcy5sZW5ndGggKyAxIDw9IE1BWF9VUkxfTEVOR1RIKSB7CiAgICAgIC8vIElmIHRoZSBrZXlzIGFyZSBzaG9ydCBlbm91Z2gsIGRvIGEgR0VULiB3ZSBkbyB0aGlzIHRvIHdvcmsgYXJvdW5kCiAgICAgIC8vIFNhZmFyaSBub3QgdW5kZXJzdGFuZGluZyAzMDRzIG9uIFBPU1RzIChzZWUgcG91Y2hkYi9wb3VjaGRiIzEyMzkpCiAgICAgIHBhcmFtcyArPSAocGFyYW1zWzBdID09PSAnPycgPyAnJicgOiAnPycpICsga2V5c0FzU3RyaW5nOwogICAgfSBlbHNlIHsKICAgICAgbWV0aG9kID0gJ1BPU1QnOwogICAgICBpZiAodHlwZW9mIGZ1biA9PT0gJ3N0cmluZycpIHsKICAgICAgICBib2R5ID0ge2tleXM6IG9wdHMua2V5c307CiAgICAgIH0gZWxzZSB7IC8vIGZ1biBpcyB7bWFwIDogbWFwZnVufSwgc28gYXBwZW5kIHRvIHRoaXMKICAgICAgICBmdW4ua2V5cyA9IG9wdHMua2V5czsKICAgICAgfQogICAgfQogIH0KCiAgLy8gV2UgYXJlIHJlZmVyZW5jaW5nIGEgcXVlcnkgZGVmaW5lZCBpbiB0aGUgZGVzaWduIGRvYwogIGlmICh0eXBlb2YgZnVuID09PSAnc3RyaW5nJykgewogICAgdmFyIHBhcnRzID0gcGFyc2VWaWV3TmFtZShmdW4pOwogICAgcmV0dXJuIGRiLnJlcXVlc3QoewogICAgICBtZXRob2Q6IG1ldGhvZCwKICAgICAgdXJsOiAnX2Rlc2lnbi8nICsgcGFydHNbMF0gKyAnL192aWV3LycgKyBwYXJ0c1sxXSArIHBhcmFtcywKICAgICAgYm9keTogYm9keQogICAgfSkudGhlbihwb3N0cHJvY2Vzc0F0dGFjaG1lbnRzKG9wdHMpKTsKICB9CgogIC8vIFdlIGFyZSB1c2luZyBhIHRlbXBvcmFyeSB2aWV3LCB0ZXJyaWJsZSBmb3IgcGVyZm9ybWFuY2UsIGdvb2QgZm9yIHRlc3RpbmcKICBib2R5ID0gYm9keSB8fCB7fTsKICBPYmplY3Qua2V5cyhmdW4pLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkoZnVuW2tleV0pKSB7CiAgICAgIGJvZHlba2V5XSA9IGZ1bltrZXldOwogICAgfSBlbHNlIHsKICAgICAgYm9keVtrZXldID0gZnVuW2tleV0udG9TdHJpbmcoKTsKICAgIH0KICB9KTsKICByZXR1cm4gZGIucmVxdWVzdCh7CiAgICBtZXRob2Q6ICdQT1NUJywKICAgIHVybDogJ190ZW1wX3ZpZXcnICsgcGFyYW1zLAogICAgYm9keTogYm9keQogIH0pLnRoZW4ocG9zdHByb2Nlc3NBdHRhY2htZW50cyhvcHRzKSk7Cn0KCmZ1bmN0aW9uIGRlZmF1bHRzVG8odmFsdWUpIHsKICByZXR1cm4gZnVuY3Rpb24gKHJlYXNvbikgewogICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KICAgIGlmIChyZWFzb24uc3RhdHVzID09PSA0MDQpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgcmVhc29uOwogICAgfQogIH07Cn0KCi8vIHJldHVybnMgYSBwcm9taXNlIGZvciBhIGxpc3Qgb2YgZG9jcyB0byB1cGRhdGUsIGJhc2VkIG9uIHRoZSBpbnB1dCBkb2NJZC4KLy8gdGhlIG9yZGVyIGRvZXNuJ3QgbWF0dGVyLCBiZWNhdXNlIHBvc3QtMy4yLjAsIGJ1bGtEb2NzCi8vIGlzIGFuIGF0b21pYyBvcGVyYXRpb24gaW4gYWxsIHRocmVlIGFkYXB0ZXJzLgpmdW5jdGlvbiBnZXREb2NzVG9QZXJzaXN0KGRvY0lkLCB2aWV3LCBkb2NJZHNUb0NoYW5nZXNBbmRFbWl0cykgewogIHZhciBtZXRhRG9jSWQgPSAnX2xvY2FsL2RvY18nICsgZG9jSWQ7CiAgdmFyIGRlZmF1bHRNZXRhRG9jID0ge19pZDogbWV0YURvY0lkLCBrZXlzOiBbXX07CiAgdmFyIGRvY0RhdGEgPSBkb2NJZHNUb0NoYW5nZXNBbmRFbWl0c1tkb2NJZF07CiAgdmFyIGluZGV4YWJsZUtleXNUb0tleVZhbHVlcyA9IGRvY0RhdGEuaW5kZXhhYmxlS2V5c1RvS2V5VmFsdWVzOwogIHZhciBjaGFuZ2VzID0gZG9jRGF0YS5jaGFuZ2VzOwoKICBmdW5jdGlvbiBnZXRNZXRhRG9jKCkgewogICAgaWYgKGlzR2VuT25lKGNoYW5nZXMpKSB7CiAgICAgIC8vIGdlbmVyYXRpb24gMSwgc28gd2UgY2FuIHNhZmVseSBhc3N1bWUgaW5pdGlhbCBzdGF0ZQogICAgICAvLyBmb3IgcGVyZm9ybWFuY2UgcmVhc29ucyAoYXZvaWRzIHVubmVjZXNzYXJ5IEdFVHMpCiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZGVmYXVsdE1ldGFEb2MpOwogICAgfQogICAgcmV0dXJuIHZpZXcuZGIuZ2V0KG1ldGFEb2NJZCkuY2F0Y2goZGVmYXVsdHNUbyhkZWZhdWx0TWV0YURvYykpOwogIH0KCiAgZnVuY3Rpb24gZ2V0S2V5VmFsdWVEb2NzKG1ldGFEb2MpIHsKICAgIGlmICghbWV0YURvYy5rZXlzLmxlbmd0aCkgewogICAgICAvLyBubyBrZXlzLCBubyBuZWVkIGZvciBhIGxvb2t1cAogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtyb3dzOiBbXX0pOwogICAgfQogICAgcmV0dXJuIHZpZXcuZGIuYWxsRG9jcyh7CiAgICAgIGtleXM6IG1ldGFEb2Mua2V5cywKICAgICAgaW5jbHVkZV9kb2NzOiB0cnVlCiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHByb2Nlc3NLdkRvY3MobWV0YURvYywga3ZEb2NzUmVzKSB7CiAgICB2YXIga3ZEb2NzID0gW107CiAgICB2YXIgb2xkS2V5c01hcCA9IHt9OwoKICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBrdkRvY3NSZXMucm93cy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICB2YXIgcm93ID0ga3ZEb2NzUmVzLnJvd3NbaV07CiAgICAgIHZhciBkb2MgPSByb3cuZG9jOwogICAgICBpZiAoIWRvYykgeyAvLyBkZWxldGVkCiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAga3ZEb2NzLnB1c2goZG9jKTsKICAgICAgb2xkS2V5c01hcFtkb2MuX2lkXSA9IHRydWU7CiAgICAgIGRvYy5fZGVsZXRlZCA9ICFpbmRleGFibGVLZXlzVG9LZXlWYWx1ZXNbZG9jLl9pZF07CiAgICAgIGlmICghZG9jLl9kZWxldGVkKSB7CiAgICAgICAgdmFyIGtleVZhbHVlID0gaW5kZXhhYmxlS2V5c1RvS2V5VmFsdWVzW2RvYy5faWRdOwogICAgICAgIGlmICgndmFsdWUnIGluIGtleVZhbHVlKSB7CiAgICAgICAgICBkb2MudmFsdWUgPSBrZXlWYWx1ZS52YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICB2YXIgbmV3S2V5cyA9IE9iamVjdC5rZXlzKGluZGV4YWJsZUtleXNUb0tleVZhbHVlcyk7CiAgICBuZXdLZXlzLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBpZiAoIW9sZEtleXNNYXBba2V5XSkgewogICAgICAgIC8vIG5ldyBkb2MKICAgICAgICB2YXIga3ZEb2MgPSB7CiAgICAgICAgICBfaWQ6IGtleQogICAgICAgIH07CiAgICAgICAgdmFyIGtleVZhbHVlID0gaW5kZXhhYmxlS2V5c1RvS2V5VmFsdWVzW2tleV07CiAgICAgICAgaWYgKCd2YWx1ZScgaW4ga2V5VmFsdWUpIHsKICAgICAgICAgIGt2RG9jLnZhbHVlID0ga2V5VmFsdWUudmFsdWU7CiAgICAgICAgfQogICAgICAgIGt2RG9jcy5wdXNoKGt2RG9jKTsKICAgICAgfQogICAgfSk7CiAgICBtZXRhRG9jLmtleXMgPSB1dGlscy51bmlxKG5ld0tleXMuY29uY2F0KG1ldGFEb2Mua2V5cykpOwogICAga3ZEb2NzLnB1c2gobWV0YURvYyk7CgogICAgcmV0dXJuIGt2RG9jczsKICB9CgogIHJldHVybiBnZXRNZXRhRG9jKCkudGhlbihmdW5jdGlvbiAobWV0YURvYykgewogICAgcmV0dXJuIGdldEtleVZhbHVlRG9jcyhtZXRhRG9jKS50aGVuKGZ1bmN0aW9uIChrdkRvY3NSZXMpIHsKICAgICAgcmV0dXJuIHByb2Nlc3NLdkRvY3MobWV0YURvYywga3ZEb2NzUmVzKTsKICAgIH0pOwogIH0pOwp9CgovLyB1cGRhdGVzIGFsbCBlbWl0dGVkIGtleS92YWx1ZSBkb2NzIGFuZCBtZXRhRG9jcyBpbiB0aGUgbXJ2aWV3IGRhdGFiYXNlCi8vIGZvciB0aGUgZ2l2ZW4gYmF0Y2ggb2YgZG9jdW1lbnRzIGZyb20gdGhlIHNvdXJjZSBkYXRhYmFzZQpmdW5jdGlvbiBzYXZlS2V5VmFsdWVzKHZpZXcsIGRvY0lkc1RvQ2hhbmdlc0FuZEVtaXRzLCBzZXEpIHsKICB2YXIgc2VxRG9jSWQgPSAnX2xvY2FsL2xhc3RTZXEnOwogIHJldHVybiB2aWV3LmRiLmdldChzZXFEb2NJZCkKICAuY2F0Y2goZGVmYXVsdHNUbyh7X2lkOiBzZXFEb2NJZCwgc2VxOiAwfSkpCiAgLnRoZW4oZnVuY3Rpb24gKGxhc3RTZXFEb2MpIHsKICAgIHZhciBkb2NJZHMgPSBPYmplY3Qua2V5cyhkb2NJZHNUb0NoYW5nZXNBbmRFbWl0cyk7CiAgICByZXR1cm4gUHJvbWlzZS5hbGwoZG9jSWRzLm1hcChmdW5jdGlvbiAoZG9jSWQpIHsKICAgICAgcmV0dXJuIGdldERvY3NUb1BlcnNpc3QoZG9jSWQsIHZpZXcsIGRvY0lkc1RvQ2hhbmdlc0FuZEVtaXRzKTsKICAgIH0pKS50aGVuKGZ1bmN0aW9uIChsaXN0T2ZEb2NzVG9QZXJzaXN0KSB7CiAgICAgIHZhciBkb2NzVG9QZXJzaXN0ID0gdXRpbHMuZmxhdHRlbihsaXN0T2ZEb2NzVG9QZXJzaXN0KTsKICAgICAgbGFzdFNlcURvYy5zZXEgPSBzZXE7CiAgICAgIGRvY3NUb1BlcnNpc3QucHVzaChsYXN0U2VxRG9jKTsKICAgICAgLy8gd3JpdGUgYWxsIGRvY3MgaW4gYSBzaW5nbGUgb3BlcmF0aW9uLCB1cGRhdGUgdGhlIHNlcSBvbmNlCiAgICAgIHJldHVybiB2aWV3LmRiLmJ1bGtEb2NzKHtkb2NzIDogZG9jc1RvUGVyc2lzdH0pOwogICAgfSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGdldFF1ZXVlKHZpZXcpIHsKICB2YXIgdmlld05hbWUgPSB0eXBlb2YgdmlldyA9PT0gJ3N0cmluZycgPyB2aWV3IDogdmlldy5uYW1lOwogIHZhciBxdWV1ZSA9IHBlcnNpc3RlbnRRdWV1ZXNbdmlld05hbWVdOwogIGlmICghcXVldWUpIHsKICAgIHF1ZXVlID0gcGVyc2lzdGVudFF1ZXVlc1t2aWV3TmFtZV0gPSBuZXcgVGFza1F1ZXVlKCk7CiAgfQogIHJldHVybiBxdWV1ZTsKfQoKZnVuY3Rpb24gdXBkYXRlVmlldyh2aWV3KSB7CiAgcmV0dXJuIHV0aWxzLnNlcXVlbnRpYWxpemUoZ2V0UXVldWUodmlldyksIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB1cGRhdGVWaWV3SW5RdWV1ZSh2aWV3KTsKICB9KSgpOwp9CgpmdW5jdGlvbiB1cGRhdGVWaWV3SW5RdWV1ZSh2aWV3KSB7CiAgLy8gYmluZCB0aGUgZW1pdCBmdW5jdGlvbiBvbmNlCiAgdmFyIG1hcFJlc3VsdHM7CiAgdmFyIGRvYzsKCiAgZnVuY3Rpb24gZW1pdChrZXksIHZhbHVlKSB7CiAgICB2YXIgb3V0cHV0ID0ge2lkOiBkb2MuX2lkLCBrZXk6IG5vcm1hbGl6ZUtleShrZXkpfTsKICAgIC8vIERvbid0IGV4cGxpY2l0bHkgc3RvcmUgdGhlIHZhbHVlIHVubGVzcyBpdCdzIGRlZmluZWQgYW5kIG5vbi1udWxsLgogICAgLy8gVGhpcyBzYXZlcyBvbiBzdG9yYWdlIHNwYWNlLCBiZWNhdXNlIG9mdGVuIHBlb3BsZSBkb24ndCB1c2UgaXQuCiAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJyAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgICBvdXRwdXQudmFsdWUgPSBub3JtYWxpemVLZXkodmFsdWUpOwogICAgfQogICAgbWFwUmVzdWx0cy5wdXNoKG91dHB1dCk7CiAgfQoKICB2YXIgbWFwRnVuOwogIC8vIGZvciB0ZW1wX3ZpZXdzIG9uZSBjYW4gdXNlIGVtaXQoZG9jLCBlbWl0KSwgc2VlICMzOAogIGlmICh0eXBlb2Ygdmlldy5tYXBGdW4gPT09ICJmdW5jdGlvbiIgJiYgdmlldy5tYXBGdW4ubGVuZ3RoID09PSAyKSB7CiAgICB2YXIgb3JpZ01hcCA9IHZpZXcubWFwRnVuOwogICAgbWFwRnVuID0gZnVuY3Rpb24gKGRvYykgewogICAgICByZXR1cm4gb3JpZ01hcChkb2MsIGVtaXQpOwogICAgfTsKICB9IGVsc2UgewogICAgbWFwRnVuID0gZXZhbEZ1bmModmlldy5tYXBGdW4udG9TdHJpbmcoKSwgZW1pdCwgc3VtLCBsb2csIEFycmF5LmlzQXJyYXksCiAgICAgIEpTT04ucGFyc2UpOwogIH0KCiAgdmFyIGN1cnJlbnRTZXEgPSB2aWV3LnNlcSB8fCAwOwoKICBmdW5jdGlvbiBwcm9jZXNzQ2hhbmdlKGRvY0lkc1RvQ2hhbmdlc0FuZEVtaXRzLCBzZXEpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBzYXZlS2V5VmFsdWVzKHZpZXcsIGRvY0lkc1RvQ2hhbmdlc0FuZEVtaXRzLCBzZXEpOwogICAgfTsKICB9CgogIHZhciBxdWV1ZSA9IG5ldyBUYXNrUXVldWUoKTsKICAvLyBUT0RPKG5lb2pza2kpOiBodHRwczovL2dpdGh1Yi5jb20vZGFsZWhhcnZleS9wb3VjaGRiL2lzc3Vlcy8xNTIxCgogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgogICAgZnVuY3Rpb24gY29tcGxldGUoKSB7CiAgICAgIHF1ZXVlLmZpbmlzaCgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIHZpZXcuc2VxID0gY3VycmVudFNlcTsKICAgICAgICByZXNvbHZlKCk7CiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIHByb2Nlc3NOZXh0QmF0Y2goKSB7CiAgICAgIHZpZXcuc291cmNlREIuY2hhbmdlcyh7CiAgICAgICAgY29uZmxpY3RzOiB0cnVlLAogICAgICAgIGluY2x1ZGVfZG9jczogdHJ1ZSwKICAgICAgICBzdHlsZTogJ2FsbF9kb2NzJywKICAgICAgICBzaW5jZTogY3VycmVudFNlcSwKICAgICAgICBsaW1pdDogQ0hBTkdFU19CQVRDSF9TSVpFCiAgICAgIH0pLm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgIHZhciByZXN1bHRzID0gcmVzcG9uc2UucmVzdWx0czsKICAgICAgICBpZiAoIXJlc3VsdHMubGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4gY29tcGxldGUoKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRvY0lkc1RvQ2hhbmdlc0FuZEVtaXRzID0ge307CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSByZXN1bHRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdmFyIGNoYW5nZSA9IHJlc3VsdHNbaV07CiAgICAgICAgICBpZiAoY2hhbmdlLmRvYy5faWRbMF0gIT09ICdfJykgewogICAgICAgICAgICBtYXBSZXN1bHRzID0gW107CiAgICAgICAgICAgIGRvYyA9IGNoYW5nZS5kb2M7CgogICAgICAgICAgICBpZiAoIWRvYy5fZGVsZXRlZCkgewogICAgICAgICAgICAgIHRyeUNvZGUodmlldy5zb3VyY2VEQiwgbWFwRnVuLCBbZG9jXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWFwUmVzdWx0cy5zb3J0KHNvcnRCeUtleVRoZW5WYWx1ZSk7CgogICAgICAgICAgICB2YXIgaW5kZXhhYmxlS2V5c1RvS2V5VmFsdWVzID0ge307CiAgICAgICAgICAgIHZhciBsYXN0S2V5OwogICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgamwgPSBtYXBSZXN1bHRzLmxlbmd0aDsgaiA8IGpsOyBqKyspIHsKICAgICAgICAgICAgICB2YXIgb2JqID0gbWFwUmVzdWx0c1tqXTsKICAgICAgICAgICAgICB2YXIgY29tcGxleEtleSA9IFtvYmoua2V5LCBvYmouaWRdOwogICAgICAgICAgICAgIGlmIChjb2xsYXRlKG9iai5rZXksIGxhc3RLZXkpID09PSAwKSB7CiAgICAgICAgICAgICAgICBjb21wbGV4S2V5LnB1c2goaik7IC8vIGR1cCBrZXkraWQsIHNvIG1ha2UgaXQgdW5pcXVlCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBpbmRleGFibGVLZXkgPSB0b0luZGV4YWJsZVN0cmluZyhjb21wbGV4S2V5KTsKICAgICAgICAgICAgICBpbmRleGFibGVLZXlzVG9LZXlWYWx1ZXNbaW5kZXhhYmxlS2V5XSA9IG9iajsKICAgICAgICAgICAgICBsYXN0S2V5ID0gb2JqLmtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkb2NJZHNUb0NoYW5nZXNBbmRFbWl0c1tjaGFuZ2UuZG9jLl9pZF0gPSB7CiAgICAgICAgICAgICAgaW5kZXhhYmxlS2V5c1RvS2V5VmFsdWVzOiBpbmRleGFibGVLZXlzVG9LZXlWYWx1ZXMsCiAgICAgICAgICAgICAgY2hhbmdlczogY2hhbmdlLmNoYW5nZXMKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRTZXEgPSBjaGFuZ2Uuc2VxOwogICAgICAgIH0KICAgICAgICBxdWV1ZS5hZGQocHJvY2Vzc0NoYW5nZShkb2NJZHNUb0NoYW5nZXNBbmRFbWl0cywgY3VycmVudFNlcSkpOwogICAgICAgIGlmIChyZXN1bHRzLmxlbmd0aCA8IENIQU5HRVNfQkFUQ0hfU0laRSkgewogICAgICAgICAgcmV0dXJuIGNvbXBsZXRlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwcm9jZXNzTmV4dEJhdGNoKCk7CiAgICAgIH0pLm9uKCdlcnJvcicsIG9uRXJyb3IpOwogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICBmdW5jdGlvbiBvbkVycm9yKGVycikgewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9CiAgICB9CgogICAgcHJvY2Vzc05leHRCYXRjaCgpOwogIH0pOwp9CgpmdW5jdGlvbiByZWR1Y2VWaWV3KHZpZXcsIHJlc3VsdHMsIG9wdGlvbnMpIHsKICBpZiAob3B0aW9ucy5ncm91cF9sZXZlbCA9PT0gMCkgewogICAgZGVsZXRlIG9wdGlvbnMuZ3JvdXBfbGV2ZWw7CiAgfQoKICB2YXIgc2hvdWxkR3JvdXAgPSBvcHRpb25zLmdyb3VwIHx8IG9wdGlvbnMuZ3JvdXBfbGV2ZWw7CgogIHZhciByZWR1Y2VGdW47CiAgaWYgKGJ1aWx0SW5SZWR1Y2Vbdmlldy5yZWR1Y2VGdW5dKSB7CiAgICByZWR1Y2VGdW4gPSBidWlsdEluUmVkdWNlW3ZpZXcucmVkdWNlRnVuXTsKICB9IGVsc2UgewogICAgcmVkdWNlRnVuID0gZXZhbEZ1bmMoCiAgICAgIHZpZXcucmVkdWNlRnVuLnRvU3RyaW5nKCksIG51bGwsIHN1bSwgbG9nLCBBcnJheS5pc0FycmF5LCBKU09OLnBhcnNlKTsKICB9CgogIHZhciBncm91cHMgPSBbXTsKICB2YXIgbHZsID0gb3B0aW9ucy5ncm91cF9sZXZlbDsKICByZXN1bHRzLmZvckVhY2goZnVuY3Rpb24gKGUpIHsKICAgIHZhciBsYXN0ID0gZ3JvdXBzW2dyb3Vwcy5sZW5ndGggLSAxXTsKICAgIHZhciBrZXkgPSBzaG91bGRHcm91cCA/IGUua2V5IDogbnVsbDsKCiAgICAvLyBvbmx5IHNldCBncm91cF9sZXZlbCBmb3IgYXJyYXkga2V5cwogICAgaWYgKHNob3VsZEdyb3VwICYmIEFycmF5LmlzQXJyYXkoa2V5KSAmJiB0eXBlb2YgbHZsID09PSAnbnVtYmVyJykgewogICAgICBrZXkgPSBrZXkubGVuZ3RoID4gbHZsID8ga2V5LnNsaWNlKDAsIGx2bCkgOiBrZXk7CiAgICB9CgogICAgaWYgKGxhc3QgJiYgY29sbGF0ZShsYXN0LmtleVswXVswXSwga2V5KSA9PT0gMCkgewogICAgICBsYXN0LmtleS5wdXNoKFtrZXksIGUuaWRdKTsKICAgICAgbGFzdC52YWx1ZS5wdXNoKGUudmFsdWUpOwogICAgICByZXR1cm47CiAgICB9CiAgICBncm91cHMucHVzaCh7a2V5OiBbCiAgICAgIFtrZXksIGUuaWRdCiAgICBdLCB2YWx1ZTogW2UudmFsdWVdfSk7CiAgfSk7CiAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGdyb3Vwcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgdmFyIGUgPSBncm91cHNbaV07CiAgICB2YXIgcmVkdWNlVHJ5ID0gdHJ5Q29kZSh2aWV3LnNvdXJjZURCLCByZWR1Y2VGdW4sIFtlLmtleSwgZS52YWx1ZSwgZmFsc2VdKTsKICAgIGlmIChyZWR1Y2VUcnkuZXJyb3IgJiYgcmVkdWNlVHJ5LmVycm9yIGluc3RhbmNlb2YgQnVpbHRJbkVycm9yKSB7CiAgICAgIC8vIENvdWNoREIgcmV0dXJucyBhbiBlcnJvciBpZiBhIGJ1aWx0LWluIGVycm9ycyBvdXQKICAgICAgdGhyb3cgcmVkdWNlVHJ5LmVycm9yOwogICAgfQogICAgLy8gQ291Y2hEQiBqdXN0IHNldHMgdGhlIHZhbHVlIHRvIG51bGwgaWYgYSBub24tYnVpbHQtaW4gZXJyb3JzIG91dAogICAgZS52YWx1ZSA9IHJlZHVjZVRyeS5lcnJvciA/IG51bGwgOiByZWR1Y2VUcnkub3V0cHV0OwogICAgZS5rZXkgPSBlLmtleVswXVswXTsKICB9CiAgLy8gbm8gdG90YWxfcm93cy9vZmZzZXQgd2hlbiByZWR1Y2luZwogIHJldHVybiB7cm93czogc2xpY2VSZXN1bHRzKGdyb3Vwcywgb3B0aW9ucy5saW1pdCwgb3B0aW9ucy5za2lwKX07Cn0KCmZ1bmN0aW9uIHF1ZXJ5Vmlldyh2aWV3LCBvcHRzKSB7CiAgcmV0dXJuIHV0aWxzLnNlcXVlbnRpYWxpemUoZ2V0UXVldWUodmlldyksIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBxdWVyeVZpZXdJblF1ZXVlKHZpZXcsIG9wdHMpOwogIH0pKCk7Cn0KCmZ1bmN0aW9uIHF1ZXJ5Vmlld0luUXVldWUodmlldywgb3B0cykgewogIHZhciB0b3RhbFJvd3M7CiAgdmFyIHNob3VsZFJlZHVjZSA9IHZpZXcucmVkdWNlRnVuICYmIG9wdHMucmVkdWNlICE9PSBmYWxzZTsKICB2YXIgc2tpcCA9IG9wdHMuc2tpcCB8fCAwOwogIGlmICh0eXBlb2Ygb3B0cy5rZXlzICE9PSAndW5kZWZpbmVkJyAmJiAhb3B0cy5rZXlzLmxlbmd0aCkgewogICAgLy8gZXF1aXZhbGVudCBxdWVyeQogICAgb3B0cy5saW1pdCA9IDA7CiAgICBkZWxldGUgb3B0cy5rZXlzOwogIH0KCiAgZnVuY3Rpb24gZmV0Y2hGcm9tVmlldyh2aWV3T3B0cykgewogICAgdmlld09wdHMuaW5jbHVkZV9kb2NzID0gdHJ1ZTsKICAgIHJldHVybiB2aWV3LmRiLmFsbERvY3Modmlld09wdHMpLnRoZW4oZnVuY3Rpb24gKHJlcykgewogICAgICB0b3RhbFJvd3MgPSByZXMudG90YWxfcm93czsKICAgICAgcmV0dXJuIHJlcy5yb3dzLm1hcChmdW5jdGlvbiAocmVzdWx0KSB7CgogICAgICAgIC8vIGltcGxpY2l0IG1pZ3JhdGlvbiAtIGluIG9sZGVyIHZlcnNpb25zIG9mIFBvdWNoREIsCiAgICAgICAgLy8gd2UgZXhwbGljaXRseSBzdG9yZWQgdGhlIGRvYyBhcyB7aWQ6IC4uLiwga2V5OiAuLi4sIHZhbHVlOiAuLi59CiAgICAgICAgLy8gdGhpcyBpcyB0ZXN0ZWQgaW4gYSBtaWdyYXRpb24gdGVzdAogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICAgICAgaWYgKCd2YWx1ZScgaW4gcmVzdWx0LmRvYyAmJiB0eXBlb2YgcmVzdWx0LmRvYy52YWx1ZSA9PT0gJ29iamVjdCcgJiYKICAgICAgICAgICAgcmVzdWx0LmRvYy52YWx1ZSAhPT0gbnVsbCkgewogICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhyZXN1bHQuZG9jLnZhbHVlKS5zb3J0KCk7CiAgICAgICAgICAvLyB0aGlzIGRldGVjdGlvbiBtZXRob2QgaXMgbm90IHBlcmZlY3QsIGJ1dCBpdCdzIHVubGlrZWx5IHRoZSB1c2VyCiAgICAgICAgICAvLyBlbWl0dGVkIGEgdmFsdWUgd2hpY2ggd2FzIGFuIG9iamVjdCB3aXRoIHRoZXNlIDMgZXhhY3Qga2V5cwogICAgICAgICAgdmFyIGV4cGVjdGVkS2V5cyA9IFsnaWQnLCAna2V5JywgJ3ZhbHVlJ107CiAgICAgICAgICBpZiAoIShrZXlzIDwgZXhwZWN0ZWRLZXlzIHx8IGtleXMgPiBleHBlY3RlZEtleXMpKSB7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQuZG9jLnZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIHBhcnNlZEtleUFuZERvY0lkID0gcGFyc2VJbmRleGFibGVTdHJpbmcocmVzdWx0LmRvYy5faWQpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBrZXk6IHBhcnNlZEtleUFuZERvY0lkWzBdLAogICAgICAgICAgaWQ6IHBhcnNlZEtleUFuZERvY0lkWzFdLAogICAgICAgICAgdmFsdWU6ICgndmFsdWUnIGluIHJlc3VsdC5kb2MgPyByZXN1bHQuZG9jLnZhbHVlIDogbnVsbCkKICAgICAgICB9OwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gb25NYXBSZXN1bHRzUmVhZHkocm93cykgewogICAgdmFyIGZpbmFsUmVzdWx0czsKICAgIGlmIChzaG91bGRSZWR1Y2UpIHsKICAgICAgZmluYWxSZXN1bHRzID0gcmVkdWNlVmlldyh2aWV3LCByb3dzLCBvcHRzKTsKICAgIH0gZWxzZSB7CiAgICAgIGZpbmFsUmVzdWx0cyA9IHsKICAgICAgICB0b3RhbF9yb3dzOiB0b3RhbFJvd3MsCiAgICAgICAgb2Zmc2V0OiBza2lwLAogICAgICAgIHJvd3M6IHJvd3MKICAgICAgfTsKICAgIH0KICAgIGlmIChvcHRzLmluY2x1ZGVfZG9jcykgewogICAgICB2YXIgZG9jSWRzID0gdXRpbHMudW5pcShyb3dzLm1hcChyb3dUb0RvY0lkKSk7CgogICAgICByZXR1cm4gdmlldy5zb3VyY2VEQi5hbGxEb2NzKHsKICAgICAgICBrZXlzOiBkb2NJZHMsCiAgICAgICAgaW5jbHVkZV9kb2NzOiB0cnVlLAogICAgICAgIGNvbmZsaWN0czogb3B0cy5jb25mbGljdHMsCiAgICAgICAgYXR0YWNobWVudHM6IG9wdHMuYXR0YWNobWVudHMsCiAgICAgICAgYmluYXJ5OiBvcHRzLmJpbmFyeQogICAgICB9KS50aGVuKGZ1bmN0aW9uIChhbGxEb2NzUmVzKSB7CiAgICAgICAgdmFyIGRvY0lkc1RvRG9jcyA9IHt9OwogICAgICAgIGFsbERvY3NSZXMucm93cy5mb3JFYWNoKGZ1bmN0aW9uIChyb3cpIHsKICAgICAgICAgIGlmIChyb3cuZG9jKSB7CiAgICAgICAgICAgIGRvY0lkc1RvRG9jc1snJCcgKyByb3cuaWRdID0gcm93LmRvYzsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByb3dzLmZvckVhY2goZnVuY3Rpb24gKHJvdykgewogICAgICAgICAgdmFyIGRvY0lkID0gcm93VG9Eb2NJZChyb3cpOwogICAgICAgICAgdmFyIGRvYyA9IGRvY0lkc1RvRG9jc1snJCcgKyBkb2NJZF07CiAgICAgICAgICBpZiAoZG9jKSB7CiAgICAgICAgICAgIHJvdy5kb2MgPSBkb2M7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGZpbmFsUmVzdWx0czsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmluYWxSZXN1bHRzOwogICAgfQogIH0KCiAgdmFyIGZsYXR0ZW4gPSBmdW5jdGlvbiAoYXJyYXkpIHsKICAgIHJldHVybiBhcnJheS5yZWR1Y2UoZnVuY3Rpb24gKHByZXYsIGN1cikgewogICAgICByZXR1cm4gcHJldi5jb25jYXQoY3VyKTsKICAgIH0pOwogIH07CgogIGlmICh0eXBlb2Ygb3B0cy5rZXlzICE9PSAndW5kZWZpbmVkJykgewogICAgdmFyIGtleXMgPSBvcHRzLmtleXM7CiAgICB2YXIgZmV0Y2hQcm9taXNlcyA9IGtleXMubWFwKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgdmFyIHZpZXdPcHRzID0gewogICAgICAgIHN0YXJ0a2V5IDogdG9JbmRleGFibGVTdHJpbmcoW2tleV0pLAogICAgICAgIGVuZGtleSAgIDogdG9JbmRleGFibGVTdHJpbmcoW2tleSwge31dKQogICAgICB9OwogICAgICByZXR1cm4gZmV0Y2hGcm9tVmlldyh2aWV3T3B0cyk7CiAgICB9KTsKICAgIHJldHVybiBQcm9taXNlLmFsbChmZXRjaFByb21pc2VzKS50aGVuKGZsYXR0ZW4pLnRoZW4ob25NYXBSZXN1bHRzUmVhZHkpOwogIH0gZWxzZSB7IC8vIG5vcm1hbCBxdWVyeSwgbm8gJ2tleXMnCiAgICB2YXIgdmlld09wdHMgPSB7CiAgICAgIGRlc2NlbmRpbmcgOiBvcHRzLmRlc2NlbmRpbmcKICAgIH07CiAgICBpZiAob3B0cy5zdGFydF9rZXkpIHsKICAgICAgICBvcHRzLnN0YXJ0a2V5ID0gb3B0cy5zdGFydF9rZXk7CiAgICB9CiAgICBpZiAob3B0cy5lbmRfa2V5KSB7CiAgICAgICAgb3B0cy5lbmRrZXkgPSBvcHRzLmVuZF9rZXk7CiAgICB9CiAgICBpZiAodHlwZW9mIG9wdHMuc3RhcnRrZXkgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHZpZXdPcHRzLnN0YXJ0a2V5ID0gb3B0cy5kZXNjZW5kaW5nID8KICAgICAgICB0b0luZGV4YWJsZVN0cmluZyhbb3B0cy5zdGFydGtleSwge31dKSA6CiAgICAgICAgdG9JbmRleGFibGVTdHJpbmcoW29wdHMuc3RhcnRrZXldKTsKICAgIH0KICAgIGlmICh0eXBlb2Ygb3B0cy5lbmRrZXkgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHZhciBpbmNsdXNpdmVFbmQgPSBvcHRzLmluY2x1c2l2ZV9lbmQgIT09IGZhbHNlOwogICAgICBpZiAob3B0cy5kZXNjZW5kaW5nKSB7CiAgICAgICAgaW5jbHVzaXZlRW5kID0gIWluY2x1c2l2ZUVuZDsKICAgICAgfQoKICAgICAgdmlld09wdHMuZW5ka2V5ID0gdG9JbmRleGFibGVTdHJpbmcoCiAgICAgICAgaW5jbHVzaXZlRW5kID8gW29wdHMuZW5ka2V5LCB7fV0gOiBbb3B0cy5lbmRrZXldKTsKICAgIH0KICAgIGlmICh0eXBlb2Ygb3B0cy5rZXkgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHZhciBrZXlTdGFydCA9IHRvSW5kZXhhYmxlU3RyaW5nKFtvcHRzLmtleV0pOwogICAgICB2YXIga2V5RW5kID0gdG9JbmRleGFibGVTdHJpbmcoW29wdHMua2V5LCB7fV0pOwogICAgICBpZiAodmlld09wdHMuZGVzY2VuZGluZykgewogICAgICAgIHZpZXdPcHRzLmVuZGtleSA9IGtleVN0YXJ0OwogICAgICAgIHZpZXdPcHRzLnN0YXJ0a2V5ID0ga2V5RW5kOwogICAgICB9IGVsc2UgewogICAgICAgIHZpZXdPcHRzLnN0YXJ0a2V5ID0ga2V5U3RhcnQ7CiAgICAgICAgdmlld09wdHMuZW5ka2V5ID0ga2V5RW5kOwogICAgICB9CiAgICB9CiAgICBpZiAoIXNob3VsZFJlZHVjZSkgewogICAgICBpZiAodHlwZW9mIG9wdHMubGltaXQgPT09ICdudW1iZXInKSB7CiAgICAgICAgdmlld09wdHMubGltaXQgPSBvcHRzLmxpbWl0OwogICAgICB9CiAgICAgIHZpZXdPcHRzLnNraXAgPSBza2lwOwogICAgfQogICAgcmV0dXJuIGZldGNoRnJvbVZpZXcodmlld09wdHMpLnRoZW4ob25NYXBSZXN1bHRzUmVhZHkpOwogIH0KfQoKZnVuY3Rpb24gaHR0cFZpZXdDbGVhbnVwKGRiKSB7CiAgcmV0dXJuIGRiLnJlcXVlc3QoewogICAgbWV0aG9kOiAnUE9TVCcsCiAgICB1cmw6ICdfdmlld19jbGVhbnVwJwogIH0pOwp9CgpmdW5jdGlvbiBsb2NhbFZpZXdDbGVhbnVwKGRiKSB7CiAgcmV0dXJuIGRiLmdldCgnX2xvY2FsL21ydmlld3MnKS50aGVuKGZ1bmN0aW9uIChtZXRhRG9jKSB7CiAgICB2YXIgZG9jc1RvVmlld3MgPSB7fTsKICAgIE9iamVjdC5rZXlzKG1ldGFEb2Mudmlld3MpLmZvckVhY2goZnVuY3Rpb24gKGZ1bGxWaWV3TmFtZSkgewogICAgICB2YXIgcGFydHMgPSBwYXJzZVZpZXdOYW1lKGZ1bGxWaWV3TmFtZSk7CiAgICAgIHZhciBkZXNpZ25Eb2NOYW1lID0gJ19kZXNpZ24vJyArIHBhcnRzWzBdOwogICAgICB2YXIgdmlld05hbWUgPSBwYXJ0c1sxXTsKICAgICAgZG9jc1RvVmlld3NbZGVzaWduRG9jTmFtZV0gPSBkb2NzVG9WaWV3c1tkZXNpZ25Eb2NOYW1lXSB8fCB7fTsKICAgICAgZG9jc1RvVmlld3NbZGVzaWduRG9jTmFtZV1bdmlld05hbWVdID0gdHJ1ZTsKICAgIH0pOwogICAgdmFyIG9wdHMgPSB7CiAgICAgIGtleXMgOiBPYmplY3Qua2V5cyhkb2NzVG9WaWV3cyksCiAgICAgIGluY2x1ZGVfZG9jcyA6IHRydWUKICAgIH07CiAgICByZXR1cm4gZGIuYWxsRG9jcyhvcHRzKS50aGVuKGZ1bmN0aW9uIChyZXMpIHsKICAgICAgdmFyIHZpZXdzVG9TdGF0dXMgPSB7fTsKICAgICAgcmVzLnJvd3MuZm9yRWFjaChmdW5jdGlvbiAocm93KSB7CiAgICAgICAgdmFyIGRkb2NOYW1lID0gcm93LmtleS5zdWJzdHJpbmcoOCk7CiAgICAgICAgT2JqZWN0LmtleXMoZG9jc1RvVmlld3Nbcm93LmtleV0pLmZvckVhY2goZnVuY3Rpb24gKHZpZXdOYW1lKSB7CiAgICAgICAgICB2YXIgZnVsbFZpZXdOYW1lID0gZGRvY05hbWUgKyAnLycgKyB2aWV3TmFtZTsKICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgICAgaWYgKCFtZXRhRG9jLnZpZXdzW2Z1bGxWaWV3TmFtZV0pIHsKICAgICAgICAgICAgLy8gbmV3IGZvcm1hdCwgd2l0aG91dCBzbGFzaGVzLCB0byBzdXBwb3J0IFBvdWNoREIgMi4yLjAKICAgICAgICAgICAgLy8gbWlncmF0aW9uIHRlc3QgaW4gcG91Y2hkYidzIGJyb3dzZXIubWlncmF0aW9uLmpzIHZlcmlmaWVzIHRoaXMKICAgICAgICAgICAgZnVsbFZpZXdOYW1lID0gdmlld05hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdmlld0RCTmFtZXMgPSBPYmplY3Qua2V5cyhtZXRhRG9jLnZpZXdzW2Z1bGxWaWV3TmFtZV0pOwogICAgICAgICAgLy8gZGVzaWduIGRvYyBkZWxldGVkLCBvciB2aWV3IGZ1bmN0aW9uIG5vbmV4aXN0ZW50CiAgICAgICAgICB2YXIgc3RhdHVzSXNHb29kID0gcm93LmRvYyAmJiByb3cuZG9jLnZpZXdzICYmCiAgICAgICAgICAgIHJvdy5kb2Mudmlld3Nbdmlld05hbWVdOwogICAgICAgICAgdmlld0RCTmFtZXMuZm9yRWFjaChmdW5jdGlvbiAodmlld0RCTmFtZSkgewogICAgICAgICAgICB2aWV3c1RvU3RhdHVzW3ZpZXdEQk5hbWVdID0KICAgICAgICAgICAgICB2aWV3c1RvU3RhdHVzW3ZpZXdEQk5hbWVdIHx8IHN0YXR1c0lzR29vZDsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgdmFyIGRic1RvRGVsZXRlID0gT2JqZWN0LmtleXModmlld3NUb1N0YXR1cykuZmlsdGVyKAogICAgICAgIGZ1bmN0aW9uICh2aWV3REJOYW1lKSB7IHJldHVybiAhdmlld3NUb1N0YXR1c1t2aWV3REJOYW1lXTsgfSk7CiAgICAgIHZhciBkZXN0cm95UHJvbWlzZXMgPSBkYnNUb0RlbGV0ZS5tYXAoZnVuY3Rpb24gKHZpZXdEQk5hbWUpIHsKICAgICAgICByZXR1cm4gdXRpbHMuc2VxdWVudGlhbGl6ZShnZXRRdWV1ZSh2aWV3REJOYW1lKSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIG5ldyBkYi5jb25zdHJ1Y3Rvcih2aWV3REJOYW1lLCBkYi5fX29wdHMpLmRlc3Ryb3koKTsKICAgICAgICB9KSgpOwogICAgICB9KTsKICAgICAgcmV0dXJuIFByb21pc2UuYWxsKGRlc3Ryb3lQcm9taXNlcykudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHtvazogdHJ1ZX07CiAgICAgIH0pOwogICAgfSk7CiAgfSwgZGVmYXVsdHNUbyh7b2s6IHRydWV9KSk7Cn0KCmV4cG9ydHMudmlld0NsZWFudXAgPSB1dGlscy5jYWxsYmFja2lmeShmdW5jdGlvbiAoKSB7CiAgdmFyIGRiID0gdGhpczsKICBpZiAoZGIudHlwZSgpID09PSAnaHR0cCcpIHsKICAgIHJldHVybiBodHRwVmlld0NsZWFudXAoZGIpOwogIH0KICByZXR1cm4gbG9jYWxWaWV3Q2xlYW51cChkYik7Cn0pOwoKZnVuY3Rpb24gcXVlcnlQcm9taXNlZChkYiwgZnVuLCBvcHRzKSB7CiAgaWYgKGRiLnR5cGUoKSA9PT0gJ2h0dHAnKSB7CiAgICByZXR1cm4gaHR0cFF1ZXJ5KGRiLCBmdW4sIG9wdHMpOwogIH0KCiAgaWYgKHR5cGVvZiBmdW4gIT09ICdzdHJpbmcnKSB7CiAgICAvLyB0ZW1wX3ZpZXcKICAgIGNoZWNrUXVlcnlQYXJzZUVycm9yKG9wdHMsIGZ1bik7CgogICAgdmFyIGNyZWF0ZVZpZXdPcHRzID0gewogICAgICBkYiA6IGRiLAogICAgICB2aWV3TmFtZSA6ICd0ZW1wX3ZpZXcvdGVtcF92aWV3JywKICAgICAgbWFwIDogZnVuLm1hcCwKICAgICAgcmVkdWNlIDogZnVuLnJlZHVjZSwKICAgICAgdGVtcG9yYXJ5IDogdHJ1ZQogICAgfTsKICAgIHRlbXBWaWV3UXVldWUuYWRkKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGNyZWF0ZVZpZXcoY3JlYXRlVmlld09wdHMpLnRoZW4oZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgICBmdW5jdGlvbiBjbGVhbnVwKCkgewogICAgICAgICAgcmV0dXJuIHZpZXcuZGIuZGVzdHJveSgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdXRpbHMuZmluKHVwZGF0ZVZpZXcodmlldykudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gcXVlcnlWaWV3KHZpZXcsIG9wdHMpOwogICAgICAgIH0pLCBjbGVhbnVwKTsKICAgICAgfSk7CiAgICB9KTsKICAgIHJldHVybiB0ZW1wVmlld1F1ZXVlLmZpbmlzaCgpOwogIH0gZWxzZSB7CiAgICAvLyBwZXJzaXN0ZW50IHZpZXcKICAgIHZhciBmdWxsVmlld05hbWUgPSBmdW47CiAgICB2YXIgcGFydHMgPSBwYXJzZVZpZXdOYW1lKGZ1bGxWaWV3TmFtZSk7CiAgICB2YXIgZGVzaWduRG9jTmFtZSA9IHBhcnRzWzBdOwogICAgdmFyIHZpZXdOYW1lID0gcGFydHNbMV07CiAgICByZXR1cm4gZGIuZ2V0KCdfZGVzaWduLycgKyBkZXNpZ25Eb2NOYW1lKS50aGVuKGZ1bmN0aW9uIChkb2MpIHsKICAgICAgdmFyIGZ1biA9IGRvYy52aWV3cyAmJiBkb2Mudmlld3Nbdmlld05hbWVdOwoKICAgICAgaWYgKCFmdW4gfHwgdHlwZW9mIGZ1bi5tYXAgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoJ2Rkb2MgJyArIGRlc2lnbkRvY05hbWUgKwogICAgICAgICcgaGFzIG5vIHZpZXcgbmFtZWQgJyArIHZpZXdOYW1lKTsKICAgICAgfQogICAgICBjaGVja1F1ZXJ5UGFyc2VFcnJvcihvcHRzLCBmdW4pOwoKICAgICAgdmFyIGNyZWF0ZVZpZXdPcHRzID0gewogICAgICAgIGRiIDogZGIsCiAgICAgICAgdmlld05hbWUgOiBmdWxsVmlld05hbWUsCiAgICAgICAgbWFwIDogZnVuLm1hcCwKICAgICAgICByZWR1Y2UgOiBmdW4ucmVkdWNlCiAgICAgIH07CiAgICAgIHJldHVybiBjcmVhdGVWaWV3KGNyZWF0ZVZpZXdPcHRzKS50aGVuKGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgaWYgKG9wdHMuc3RhbGUgPT09ICdvaycgfHwgb3B0cy5zdGFsZSA9PT0gJ3VwZGF0ZV9hZnRlcicpIHsKICAgICAgICAgIGlmIChvcHRzLnN0YWxlID09PSAndXBkYXRlX2FmdGVyJykgewogICAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB1cGRhdGVWaWV3KHZpZXcpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBxdWVyeVZpZXcodmlldywgb3B0cyk7CiAgICAgICAgfSBlbHNlIHsgLy8gc3RhbGUgbm90IG9rCiAgICAgICAgICByZXR1cm4gdXBkYXRlVmlldyh2aWV3KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHF1ZXJ5Vmlldyh2aWV3LCBvcHRzKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9Cn0KCmV4cG9ydHMucXVlcnkgPSBmdW5jdGlvbiAoZnVuLCBvcHRzLCBjYWxsYmFjaykgewogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2FsbGJhY2sgPSBvcHRzOwogICAgb3B0cyA9IHt9OwogIH0KICBvcHRzID0gb3B0cyB8fCB7fTsKCiAgaWYgKHR5cGVvZiBmdW4gPT09ICdmdW5jdGlvbicpIHsKICAgIGZ1biA9IHttYXAgOiBmdW59OwogIH0KCiAgdmFyIGRiID0gdGhpczsKICB2YXIgcHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHF1ZXJ5UHJvbWlzZWQoZGIsIGZ1biwgb3B0cyk7CiAgfSk7CiAgdXRpbHMucHJvbWlzZWRDYWxsYmFjayhwcm9taXNlLCBjYWxsYmFjayk7CiAgcmV0dXJuIHByb21pc2U7Cn07CgpmdW5jdGlvbiBRdWVyeVBhcnNlRXJyb3IobWVzc2FnZSkgewogIHRoaXMuc3RhdHVzID0gNDAwOwogIHRoaXMubmFtZSA9ICdxdWVyeV9wYXJzZV9lcnJvcic7CiAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZTsKICB0aGlzLmVycm9yID0gdHJ1ZTsKICB0cnkgewogICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgUXVlcnlQYXJzZUVycm9yKTsKICB9IGNhdGNoIChlKSB7fQp9Cgppbmhlcml0cyhRdWVyeVBhcnNlRXJyb3IsIEVycm9yKTsKCmZ1bmN0aW9uIE5vdEZvdW5kRXJyb3IobWVzc2FnZSkgewogIHRoaXMuc3RhdHVzID0gNDA0OwogIHRoaXMubmFtZSA9ICdub3RfZm91bmQnOwogIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgdGhpcy5lcnJvciA9IHRydWU7CiAgdHJ5IHsKICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIE5vdEZvdW5kRXJyb3IpOwogIH0gY2F0Y2ggKGUpIHt9Cn0KCmluaGVyaXRzKE5vdEZvdW5kRXJyb3IsIEVycm9yKTsKCmZ1bmN0aW9uIEJ1aWx0SW5FcnJvcihtZXNzYWdlKSB7CiAgdGhpcy5zdGF0dXMgPSA1MDA7CiAgdGhpcy5uYW1lID0gJ2ludmFsaWRfdmFsdWUnOwogIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgdGhpcy5lcnJvciA9IHRydWU7CiAgdHJ5IHsKICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIEJ1aWx0SW5FcnJvcik7CiAgfSBjYXRjaCAoZSkge30KfQoKaW5oZXJpdHMoQnVpbHRJbkVycm9yLCBFcnJvcik7Cgp9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKfSx7Ii4uL2RlcHMvYmluYXJ5L2Jhc2U2NFN0cmluZ1RvQmxvYk9yQnVmZmVyIjo0MiwiLi4vZGVwcy9wcm9taXNlIjo3OSwiLi9jcmVhdGVWaWV3Ijo4NiwiLi9ldmFsZnVuYyI6ODcsIi4vdGFza3F1ZXVlIjo5MCwiLi91dGlscyI6OTEsIl9wcm9jZXNzIjo4LCJpbmhlcml0cyI6MTIsInBvdWNoZGItY29sbGF0ZSI6MTA2fV0sODk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgTWQ1ID0gcmVxdWlyZSgnc3BhcmstbWQ1Jyk7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChzdHJpbmcpIHsKICByZXR1cm4gTWQ1Lmhhc2goc3RyaW5nKTsKfTsKfSx7InNwYXJrLW1kNSI6MTA5fV0sOTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Ci8qCiAqIFNpbXBsZSB0YXNrIHF1ZXVlIHRvIHNlcXVlbnRpYWxpemUgYWN0aW9ucy4gQXNzdW1lcwogKiBjYWxsYmFja3Mgd2lsbCBldmVudHVhbGx5IGZpcmUgKG9uY2UpLgogKi8KCnZhciBQcm9taXNlID0gcmVxdWlyZSgnLi4vZGVwcy9wcm9taXNlJyk7CgpmdW5jdGlvbiBUYXNrUXVldWUoKSB7CiAgdGhpcy5wcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKGZ1bGZpbGwpIHtmdWxmaWxsKCk7IH0pOwp9ClRhc2tRdWV1ZS5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gKHByb21pc2VGYWN0b3J5KSB7CiAgdGhpcy5wcm9taXNlID0gdGhpcy5wcm9taXNlLmNhdGNoKGZ1bmN0aW9uICgpIHsKICAgIC8vIGp1c3QgcmVjb3ZlcgogIH0pLnRoZW4oZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHByb21pc2VGYWN0b3J5KCk7CiAgfSk7CiAgcmV0dXJuIHRoaXMucHJvbWlzZTsKfTsKVGFza1F1ZXVlLnByb3RvdHlwZS5maW5pc2ggPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMucHJvbWlzZTsKfTsKCm1vZHVsZS5leHBvcnRzID0gVGFza1F1ZXVlOwoKfSx7Ii4uL2RlcHMvcHJvbWlzZSI6Nzl9XSw5MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBhcmdzYXJyYXkgPSByZXF1aXJlKCdhcmdzYXJyYXknKTsKCmV4cG9ydHMucHJvbWlzZWRDYWxsYmFjayA9IGZ1bmN0aW9uIChwcm9taXNlLCBjYWxsYmFjaykgewogIGlmIChjYWxsYmFjaykgewogICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uIChyZXMpIHsKICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzKTsKICAgICAgfSk7CiAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgIGNhbGxiYWNrKHJlYXNvbik7CiAgICAgIH0pOwogICAgfSk7CiAgfQogIHJldHVybiBwcm9taXNlOwp9OwoKZXhwb3J0cy5jYWxsYmFja2lmeSA9IGZ1bmN0aW9uIChmdW4pIHsKICByZXR1cm4gYXJnc2FycmF5KGZ1bmN0aW9uIChhcmdzKSB7CiAgICB2YXIgY2IgPSBhcmdzLnBvcCgpOwogICAgdmFyIHByb21pc2UgPSBmdW4uYXBwbHkodGhpcywgYXJncyk7CiAgICBpZiAodHlwZW9mIGNiID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGV4cG9ydHMucHJvbWlzZWRDYWxsYmFjayhwcm9taXNlLCBjYik7CiAgICB9CiAgICByZXR1cm4gcHJvbWlzZTsKICB9KTsKfTsKCi8vIFByb21pc2UgZmluYWxseSB1dGlsIHNpbWlsYXIgdG8gUS5maW5hbGx5CmV4cG9ydHMuZmluID0gZnVuY3Rpb24gKHByb21pc2UsIGZpbmFsUHJvbWlzZUZhY3RvcnkpIHsKICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uIChyZXMpIHsKICAgIHJldHVybiBmaW5hbFByb21pc2VGYWN0b3J5KCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiByZXM7CiAgICB9KTsKICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICByZXR1cm4gZmluYWxQcm9taXNlRmFjdG9yeSgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICB0aHJvdyByZWFzb247CiAgICB9KTsKICB9KTsKfTsKCmV4cG9ydHMuc2VxdWVudGlhbGl6ZSA9IGZ1bmN0aW9uIChxdWV1ZSwgcHJvbWlzZUZhY3RvcnkpIHsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICByZXR1cm4gcXVldWUuYWRkKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHByb21pc2VGYWN0b3J5LmFwcGx5KHRoYXQsIGFyZ3MpOwogICAgfSk7CiAgfTsKfTsKCmV4cG9ydHMuZmxhdHRlbiA9IGZ1bmN0aW9uIChhcnJzKSB7CiAgdmFyIHJlcyA9IFtdOwogIGZvciAodmFyIGkgPSAwLCBsZW4gPSBhcnJzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICByZXMgPSByZXMuY29uY2F0KGFycnNbaV0pOwogIH0KICByZXR1cm4gcmVzOwp9OwoKLy8gdW5pcSBhbiBhcnJheSBvZiBzdHJpbmdzLCBvcmRlciBub3QgZ3VhcmFudGVlZAovLyBzaW1pbGFyIHRvIHVuZGVyc2NvcmUvbG9kYXNoIF8udW5pcQpleHBvcnRzLnVuaXEgPSBmdW5jdGlvbiAoYXJyKSB7CiAgdmFyIG1hcCA9IHt9OwoKICBmb3IgKHZhciBpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICBtYXBbJyQnICsgYXJyW2ldXSA9IHRydWU7CiAgfQoKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG1hcCk7CiAgdmFyIG91dHB1dCA9IG5ldyBBcnJheShrZXlzLmxlbmd0aCk7CgogIGZvciAoaSA9IDAsIGxlbiA9IGtleXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgIG91dHB1dFtpXSA9IGtleXNbaV0uc3Vic3RyaW5nKDEpOwogIH0KICByZXR1cm4gb3V0cHV0Owp9Owp9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKfSx7Il9wcm9jZXNzIjo4LCJhcmdzYXJyYXkiOjZ9XSw5MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBTVEFSVElOR19CQUNLX09GRiA9IDA7CgpmdW5jdGlvbiByYW5kb21OdW1iZXIobWluLCBtYXgpIHsKICBtaW4gPSBwYXJzZUludChtaW4sIDEwKTsKICBtYXggPSBwYXJzZUludChtYXgsIDEwKTsKICBpZiAobWluICE9PSBtaW4pIHsKICAgIG1pbiA9IDA7CiAgfQogIGlmIChtYXggIT09IG1heCB8fCBtYXggPD0gbWluKSB7CiAgICBtYXggPSAobWluIHx8IDEpIDw8IDE7IC8vZG91YmxpbmcKICB9IGVsc2UgewogICAgbWF4ID0gbWF4ICsgMTsKICB9CiAgdmFyIHJhdGlvID0gTWF0aC5yYW5kb20oKTsKICB2YXIgcmFuZ2UgPSBtYXggLSBtaW47CgogIHJldHVybiB+fihyYW5nZSAqIHJhdGlvICsgbWluKTsgLy8gfn4gY29lcmNlcyB0byBhbiBpbnQsIGJ1dCBmYXN0Lgp9CgpmdW5jdGlvbiBkZWZhdWx0QmFja09mZihtaW4pIHsKICB2YXIgbWF4ID0gMDsKICBpZiAoIW1pbikgewogICAgbWF4ID0gMjAwMDsKICB9CiAgcmV0dXJuIHJhbmRvbU51bWJlcihtaW4sIG1heCk7Cn0KCmZ1bmN0aW9uIGJhY2tPZmYob3B0cywgcmV0dXJuVmFsdWUsIGVycm9yLCBjYWxsYmFjaykgewogIGlmIChvcHRzLnJldHJ5ID09PSBmYWxzZSkgewogICAgcmV0dXJuVmFsdWUuZW1pdCgnZXJyb3InLCBlcnJvcik7CiAgICByZXR1cm5WYWx1ZS5yZW1vdmVBbGxMaXN0ZW5lcnMoKTsKICAgIHJldHVybjsKICB9CiAgaWYgKHR5cGVvZiBvcHRzLmJhY2tfb2ZmX2Z1bmN0aW9uICE9PSAnZnVuY3Rpb24nKSB7CiAgICBvcHRzLmJhY2tfb2ZmX2Z1bmN0aW9uID0gZGVmYXVsdEJhY2tPZmY7CiAgfQogIHJldHVyblZhbHVlLmVtaXQoJ3JlcXVlc3RFcnJvcicsIGVycm9yKTsKICBpZiAocmV0dXJuVmFsdWUuc3RhdGUgPT09ICdhY3RpdmUnIHx8IHJldHVyblZhbHVlLnN0YXRlID09PSAncGVuZGluZycpIHsKICAgIHJldHVyblZhbHVlLmVtaXQoJ3BhdXNlZCcsIGVycm9yKTsKICAgIHJldHVyblZhbHVlLnN0YXRlID0gJ3N0b3BwZWQnOwogICAgcmV0dXJuVmFsdWUub25jZSgnYWN0aXZlJywgZnVuY3Rpb24gKCkgewogICAgICBvcHRzLmN1cnJlbnRfYmFja19vZmYgPSBTVEFSVElOR19CQUNLX09GRjsKICAgIH0pOwogIH0KCiAgb3B0cy5jdXJyZW50X2JhY2tfb2ZmID0gb3B0cy5jdXJyZW50X2JhY2tfb2ZmIHx8IFNUQVJUSU5HX0JBQ0tfT0ZGOwogIG9wdHMuY3VycmVudF9iYWNrX29mZiA9IG9wdHMuYmFja19vZmZfZnVuY3Rpb24ob3B0cy5jdXJyZW50X2JhY2tfb2ZmKTsKICBzZXRUaW1lb3V0KGNhbGxiYWNrLCBvcHRzLmN1cnJlbnRfYmFja19vZmYpOwp9Cgptb2R1bGUuZXhwb3J0cyA9IGJhY2tPZmY7Cgp9LHt9XSw5MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBQcm9taXNlID0gcmVxdWlyZSgnLi8uLi9kZXBzL3Byb21pc2UnKTsKdmFyIGV4cGxhaW40MDQgPSByZXF1aXJlKCcuLy4uL2RlcHMvYWpheC9leHBsYWluNDA0Jyk7CnZhciBwb3VjaENvbGxhdGUgPSByZXF1aXJlKCdwb3VjaGRiLWNvbGxhdGUnKTsKdmFyIGNvbGxhdGUgPSBwb3VjaENvbGxhdGUuY29sbGF0ZTsKCnZhciBDSEVDS1BPSU5UX1ZFUlNJT04gPSAxOwp2YXIgUkVQTElDQVRPUiA9ICJwb3VjaGRiIjsKLy8gVGhpcyBpcyBhbiBhcmJpdHJhcnkgbnVtYmVyIHRvIGxpbWl0IHRoZQovLyBhbW91bnQgb2YgcmVwbGljYXRpb24gaGlzdG9yeSB3ZSBzYXZlIGluIHRoZSBjaGVja3BvaW50LgovLyBJZiB3ZSBzYXZlIHRvbyBtdWNoLCB0aGUgY2hlY2twb2luZyBkb2NzIHdpbGwgYmVjb21lIHZlcnkgYmlnLAovLyBpZiB3ZSBzYXZlIGZld2VyLCB3ZSdsbCBydW4gYSBncmVhdGVyIHJpc2sgb2YgaGF2aW5nIHRvCi8vIHJlYWQgYWxsIHRoZSBjaGFuZ2VzIGZyb20gMCB3aGVuIGNoZWNrcG9pbnQgUFVUcyBmYWlsCi8vIENvdWNoREIgMi4wIGhhcyBhIG1vcmUgaW52b2x2ZWQgaGlzdG9yeSBwcnVuaW5nLAovLyBidXQgbGV0J3MgZ28gZm9yIHRoZSBzaW1wbGUgdmVyc2lvbiBmb3Igbm93Lgp2YXIgQ0hFQ0tQT0lOVF9ISVNUT1JZX1NJWkUgPSA1Owp2YXIgTE9XRVNUX1NFUSA9IDA7CgpmdW5jdGlvbiB1cGRhdGVDaGVja3BvaW50KGRiLCBpZCwgY2hlY2twb2ludCwgc2Vzc2lvbiwgcmV0dXJuVmFsdWUpIHsKICByZXR1cm4gZGIuZ2V0KGlkKS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICBpZiAoZXJyLnN0YXR1cyA9PT0gNDA0KSB7CiAgICAgIGlmIChkYi50eXBlKCkgPT09ICdodHRwJykgewogICAgICAgIGV4cGxhaW40MDQoJ1BvdWNoREIgaXMganVzdCBjaGVja2luZyBpZiBhIHJlbW90ZSBjaGVja3BvaW50IGV4aXN0cy4nKTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHNlc3Npb25faWQ6IHNlc3Npb24sCiAgICAgICAgX2lkOiBpZCwKICAgICAgICBoaXN0b3J5OiBbXSwKICAgICAgICByZXBsaWNhdG9yOiBSRVBMSUNBVE9SLAogICAgICAgIHZlcnNpb246IENIRUNLUE9JTlRfVkVSU0lPTgogICAgICB9OwogICAgfQogICAgdGhyb3cgZXJyOwogIH0pLnRoZW4oZnVuY3Rpb24gKGRvYykgewogICAgaWYgKHJldHVyblZhbHVlLmNhbmNlbGxlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICAvLyBGaWx0ZXIgb3V0IGN1cnJlbnQgZW50cnkgZm9yIHRoaXMgcmVwbGljYXRpb24KICAgIGRvYy5oaXN0b3J5ID0gKGRvYy5oaXN0b3J5IHx8IFtdKS5maWx0ZXIoZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgcmV0dXJuIGl0ZW0uc2Vzc2lvbl9pZCAhPT0gc2Vzc2lvbjsKICAgIH0pOwoKICAgIC8vIEFkZCB0aGUgbGF0ZXN0IGNoZWNrcG9pbnQgdG8gaGlzdG9yeQogICAgZG9jLmhpc3RvcnkudW5zaGlmdCh7CiAgICAgIGxhc3Rfc2VxOiBjaGVja3BvaW50LAogICAgICBzZXNzaW9uX2lkOiBzZXNzaW9uCiAgICB9KTsKCiAgICAvLyBKdXN0IHRha2UgdGhlIGxhc3QgcGllY2VzIGluIGhpc3RvcnksIHRvCiAgICAvLyBhdm9pZCByZWFsbHkgYmlnIGNoZWNrcG9pbnQgZG9jcy4KICAgIC8vIHNlZSBjb21tZW50IG9uIGhpc3Rvcnkgc2l6ZSBhYm92ZQogICAgZG9jLmhpc3RvcnkgPSBkb2MuaGlzdG9yeS5zbGljZSgwLCBDSEVDS1BPSU5UX0hJU1RPUllfU0laRSk7CgogICAgZG9jLnZlcnNpb24gPSBDSEVDS1BPSU5UX1ZFUlNJT047CiAgICBkb2MucmVwbGljYXRvciA9IFJFUExJQ0FUT1I7CgogICAgZG9jLnNlc3Npb25faWQgPSBzZXNzaW9uOwogICAgZG9jLmxhc3Rfc2VxID0gY2hlY2twb2ludDsKCiAgICByZXR1cm4gZGIucHV0KGRvYykuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICBpZiAoZXJyLnN0YXR1cyA9PT0gNDA5KSB7CiAgICAgICAgLy8gcmV0cnk7IHNvbWVvbmUgaXMgdHJ5aW5nIHRvIHdyaXRlIGEgY2hlY2twb2ludCBzaW11bHRhbmVvdXNseQogICAgICAgIHJldHVybiB1cGRhdGVDaGVja3BvaW50KGRiLCBpZCwgY2hlY2twb2ludCwgc2Vzc2lvbiwgcmV0dXJuVmFsdWUpOwogICAgICB9CiAgICAgIHRocm93IGVycjsKICAgIH0pOwogIH0pOwp9CgpmdW5jdGlvbiBDaGVja3BvaW50ZXIoc3JjLCB0YXJnZXQsIGlkLCByZXR1cm5WYWx1ZSkgewogIHRoaXMuc3JjID0gc3JjOwogIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogIHRoaXMuaWQgPSBpZDsKICB0aGlzLnJldHVyblZhbHVlID0gcmV0dXJuVmFsdWU7Cn0KCkNoZWNrcG9pbnRlci5wcm90b3R5cGUud3JpdGVDaGVja3BvaW50ID0gZnVuY3Rpb24gKGNoZWNrcG9pbnQsIHNlc3Npb24pIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgcmV0dXJuIHRoaXMudXBkYXRlVGFyZ2V0KGNoZWNrcG9pbnQsIHNlc3Npb24pLnRoZW4oZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHNlbGYudXBkYXRlU291cmNlKGNoZWNrcG9pbnQsIHNlc3Npb24pOwogIH0pOwp9OwoKQ2hlY2twb2ludGVyLnByb3RvdHlwZS51cGRhdGVUYXJnZXQgPSBmdW5jdGlvbiAoY2hlY2twb2ludCwgc2Vzc2lvbikgewogIHJldHVybiB1cGRhdGVDaGVja3BvaW50KHRoaXMudGFyZ2V0LCB0aGlzLmlkLCBjaGVja3BvaW50LAogICAgICBzZXNzaW9uLCB0aGlzLnJldHVyblZhbHVlKTsKfTsKCkNoZWNrcG9pbnRlci5wcm90b3R5cGUudXBkYXRlU291cmNlID0gZnVuY3Rpb24gKGNoZWNrcG9pbnQsIHNlc3Npb24pIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgaWYgKHRoaXMucmVhZE9ubHlTb3VyY2UpIHsKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodHJ1ZSk7CiAgfQogIHJldHVybiB1cGRhdGVDaGVja3BvaW50KHRoaXMuc3JjLCB0aGlzLmlkLCBjaGVja3BvaW50LAogICAgICBzZXNzaW9uLCB0aGlzLnJldHVyblZhbHVlKQogICAgLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgdmFyIGlzRm9yYmlkZGVuID0gdHlwZW9mIGVyci5zdGF0dXMgPT09ICdudW1iZXInICYmCiAgICAgICAgTWF0aC5mbG9vcihlcnIuc3RhdHVzIC8gMTAwKSA9PT0gNDsKICAgICAgaWYgKGlzRm9yYmlkZGVuKSB7CiAgICAgICAgc2VsZi5yZWFkT25seVNvdXJjZSA9IHRydWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyOwogICAgfSk7Cn07Cgp2YXIgY29tcGFyaXNvbnMgPSB7CiAgInVuZGVmaW5lZCI6IGZ1bmN0aW9uKHRhcmdldERvYywgc291cmNlRG9jKSB7CiAgICAvLyBUaGlzIGlzIHRoZSBwcmV2aW91cyBjb21wYXJpc29uIGZ1bmN0aW9uCiAgICBpZiAoY29sbGF0ZSh0YXJnZXREb2MubGFzdF9zZXEsIHNvdXJjZURvYy5sYXN0X3NlcSkgPT09IDApIHsKICAgICAgcmV0dXJuIHNvdXJjZURvYy5sYXN0X3NlcTsKICAgIH0KCiAgICByZXR1cm4gMDsKICB9LAogICIxIjogZnVuY3Rpb24odGFyZ2V0RG9jLCBzb3VyY2VEb2MpIHsKICAgIC8vIFRoaXMgaXMgdGhlIGNvbXBhcmlzb24gZnVuY3Rpb24gcG9ydGVkIGZyb20gQ291Y2hEQgogICAgcmV0dXJuIGNvbXBhcmVSZXBsaWNhdGlvbkxvZ3Moc291cmNlRG9jLCB0YXJnZXREb2MpLmxhc3Rfc2VxOwogIH0KfTsKCkNoZWNrcG9pbnRlci5wcm90b3R5cGUuZ2V0Q2hlY2twb2ludCA9IGZ1bmN0aW9uICgpIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgcmV0dXJuIHNlbGYudGFyZ2V0LmdldChzZWxmLmlkKS50aGVuKGZ1bmN0aW9uICh0YXJnZXREb2MpIHsKICAgIHJldHVybiBzZWxmLnNyYy5nZXQoc2VsZi5pZCkudGhlbihmdW5jdGlvbiAoc291cmNlRG9jKSB7CiAgICAgIC8vIFNpbmNlIHdlIGNhbid0IG1pZ3JhdGUgYW4gb2xkIHZlcnNpb24gZG9jIHRvIGEgbmV3IG9uZQogICAgICAvLyAobm8gc2Vzc2lvbiBpZCksIHdlIGp1c3QgZ28gd2l0aCB0aGUgbG93ZXN0IHNlcSBpbiB0aGlzIGNhc2UKICAgICAgaWYgKHRhcmdldERvYy52ZXJzaW9uICE9PQogICAgICAgICBzb3VyY2VEb2MudmVyc2lvbikgewogICAgICAgIHJldHVybiBMT1dFU1RfU0VROwogICAgICB9CgogICAgICB2YXIgdmVyc2lvbjsKICAgICAgaWYgKHRhcmdldERvYy52ZXJzaW9uKSB7CiAgICAgICAgdmVyc2lvbiA9IHRhcmdldERvYy52ZXJzaW9uLnRvU3RyaW5nKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmVyc2lvbiA9ICJ1bmRlZmluZWQiOwogICAgICB9CgogICAgICBpZiAodmVyc2lvbiBpbiBjb21wYXJpc29ucykgewogICAgICAgIHJldHVybiBjb21wYXJpc29uc1t2ZXJzaW9uXSh0YXJnZXREb2MsIHNvdXJjZURvYyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBMT1dFU1RfU0VROwogICAgfSwgZnVuY3Rpb24gKGVycikgewogICAgICBpZiAoZXJyLnN0YXR1cyA9PT0gNDA0ICYmIHRhcmdldERvYy5sYXN0X3NlcSkgewogICAgICAgIHJldHVybiBzZWxmLnNyYy5wdXQoewogICAgICAgICAgX2lkOiBzZWxmLmlkLAogICAgICAgICAgbGFzdF9zZXE6IExPV0VTVF9TRVEKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBMT1dFU1RfU0VROwogICAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgIGlmIChlcnIuc3RhdHVzID09PSA0MDEpIHsKICAgICAgICAgICAgc2VsZi5yZWFkT25seVNvdXJjZSA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiB0YXJnZXREb2MubGFzdF9zZXE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gTE9XRVNUX1NFUTsKICAgICAgICB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnI7CiAgICB9KTsKICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICBpZiAoZXJyLnN0YXR1cyAhPT0gNDA0KSB7CiAgICAgIHRocm93IGVycjsKICAgIH0KICAgIHJldHVybiBMT1dFU1RfU0VROwogIH0pOwp9OwovLyBUaGlzIGNoZWNrcG9pbnQgY29tcGFyaXNvbiBpcyBwb3J0ZWQgZnJvbSBDb3VjaERCcyBzb3VyY2UKLy8gdGhleSBjb21lIGZyb20gaGVyZToKLy8gaHR0cHM6Ly9naXRodWIuY29tL2FwYWNoZS9jb3VjaGRiLWNvdWNoLXJlcGxpY2F0b3IvYmxvYi9tYXN0ZXIvc3JjL2NvdWNoX3JlcGxpY2F0b3IuZXJsI0w4NjMtTDkwNgoKZnVuY3Rpb24gY29tcGFyZVJlcGxpY2F0aW9uTG9ncyAoc3JjRG9jLCB0Z3REb2MpIHsKICBpZiAoc3JjRG9jLnNlc3Npb25faWQgPT09IHRndERvYy5zZXNzaW9uX2lkKSB7CiAgICByZXR1cm4gewogICAgICBsYXN0X3NlcTogc3JjRG9jLmxhc3Rfc2VxLAogICAgICBoaXN0b3J5OiBzcmNEb2MuaGlzdG9yeSB8fCBbXQogICAgfTsKICB9CgogIHZhciBzb3VyY2VIaXN0b3J5ID0gc3JjRG9jLmhpc3RvcnkgfHwgW107CiAgdmFyIHRhcmdldEhpc3RvcnkgPSB0Z3REb2MuaGlzdG9yeSB8fCBbXTsKICByZXR1cm4gY29tcGFyZVJlcGxpY2F0aW9uSGlzdG9yeShzb3VyY2VIaXN0b3J5LCB0YXJnZXRIaXN0b3J5KTsKfQoKZnVuY3Rpb24gY29tcGFyZVJlcGxpY2F0aW9uSGlzdG9yeSAoc291cmNlSGlzdG9yeSwgdGFyZ2V0SGlzdG9yeSkgewogIC8vIHRoZSBlcmxhbmcgbG9vcCB2aWEgZnVuY3Rpb24gYXJndW1lbnRzIGlzIG5vdCBzbyBlYXN5IHRvIHJlcGVhdCBpbiBKUwogIC8vIHRoZXJlZm9yZSwgZG9pbmcgdGhpcyBhcyByZWN1cnNpb24KICB2YXIgUyA9IHNvdXJjZUhpc3RvcnlbMF07CiAgdmFyIHNvdXJjZVJlc3QgPSBzb3VyY2VIaXN0b3J5LnNsaWNlKDEpOwogIHZhciBUID0gdGFyZ2V0SGlzdG9yeVswXTsKICB2YXIgdGFyZ2V0UmVzdCA9IHRhcmdldEhpc3Rvcnkuc2xpY2UoMSk7CgogIGlmICghUyB8fCB0YXJnZXRIaXN0b3J5Lmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHsKICAgICAgbGFzdF9zZXE6IExPV0VTVF9TRVEsCiAgICAgIGhpc3Rvcnk6IFtdCiAgICB9OwogIH0KCiAgdmFyIHNvdXJjZUlkID0gUy5zZXNzaW9uX2lkOwogIGlmIChoYXNTZXNzaW9uSWQoc291cmNlSWQsIHRhcmdldEhpc3RvcnkpKSB7CiAgICByZXR1cm4gewogICAgICBsYXN0X3NlcTogUy5sYXN0X3NlcSwKICAgICAgaGlzdG9yeTogc291cmNlSGlzdG9yeQogICAgfTsKICB9CgogIHZhciB0YXJnZXRJZCA9IFQuc2Vzc2lvbl9pZDsKICBpZiAoaGFzU2Vzc2lvbklkKHRhcmdldElkLCBzb3VyY2VSZXN0KSkgewogICAgcmV0dXJuIHsKICAgICAgbGFzdF9zZXE6IFQubGFzdF9zZXEsCiAgICAgIGhpc3Rvcnk6IHRhcmdldFJlc3QKICAgIH07CiAgfQoKICByZXR1cm4gY29tcGFyZVJlcGxpY2F0aW9uSGlzdG9yeShzb3VyY2VSZXN0LCB0YXJnZXRSZXN0KTsKfQoKZnVuY3Rpb24gaGFzU2Vzc2lvbklkIChzZXNzaW9uSWQsIGhpc3RvcnkpIHsKICB2YXIgcHJvcHMgPSBoaXN0b3J5WzBdOwogIHZhciByZXN0ID0gaGlzdG9yeS5zbGljZSgxKTsKCiAgaWYgKCFzZXNzaW9uSWQgfHwgaGlzdG9yeS5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGlmIChzZXNzaW9uSWQgPT09IHByb3BzLnNlc3Npb25faWQpIHsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgcmV0dXJuIGhhc1Nlc3Npb25JZChzZXNzaW9uSWQsIHJlc3QpOwp9CgoKbW9kdWxlLmV4cG9ydHMgPSBDaGVja3BvaW50ZXI7Cgp9LHsiLi8uLi9kZXBzL2FqYXgvZXhwbGFpbjQwNCI6MzUsIi4vLi4vZGVwcy9wcm9taXNlIjo3OSwicG91Y2hkYi1jb2xsYXRlIjoxMDZ9XSw5NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBQcm9taXNlID0gcmVxdWlyZSgnLi8uLi9kZXBzL3Byb21pc2UnKTsKdmFyIG1kNSA9IHJlcXVpcmUoJy4uL2RlcHMvbWQ1Jyk7CnZhciBjb2xsYXRlID0gcmVxdWlyZSgncG91Y2hkYi1jb2xsYXRlJykuY29sbGF0ZTsKCmZ1bmN0aW9uIHNvcnRPYmplY3RQcm9wZXJ0aWVzQnlLZXkocXVlcnlQYXJhbXMpIHsKICByZXR1cm4gT2JqZWN0LmtleXMocXVlcnlQYXJhbXMpLnNvcnQoY29sbGF0ZSkucmVkdWNlKGZ1bmN0aW9uIChyZXN1bHQsIGtleSkgewogICAgcmVzdWx0W2tleV0gPSBxdWVyeVBhcmFtc1trZXldOwogICAgcmV0dXJuIHJlc3VsdDsKICB9LCB7fSk7Cn0KCi8vIEdlbmVyYXRlIGEgdW5pcXVlIGlkIHBhcnRpY3VsYXIgdG8gdGhpcyByZXBsaWNhdGlvbi4KLy8gTm90IGd1YXJhbnRlZWQgdG8gYWxpZ24gcGVyZmVjdGx5IHdpdGggQ291Y2hEQidzIHJlcCBpZHMuCmZ1bmN0aW9uIGdlbmVyYXRlUmVwbGljYXRpb25JZChzcmMsIHRhcmdldCwgb3B0cykgewogIHZhciBkb2NJZHMgPSBvcHRzLmRvY19pZHMgPyBvcHRzLmRvY19pZHMuc29ydChjb2xsYXRlKSA6ICcnOwogIHZhciBmaWx0ZXJGdW4gPSBvcHRzLmZpbHRlciA/IG9wdHMuZmlsdGVyLnRvU3RyaW5nKCkgOiAnJzsKICB2YXIgcXVlcnlQYXJhbXMgPSAnJzsKICB2YXIgZmlsdGVyVmlld05hbWUgPSAgJyc7CgogIGlmIChvcHRzLmZpbHRlciAmJiBvcHRzLnF1ZXJ5X3BhcmFtcykgewogICAgcXVlcnlQYXJhbXMgPSBKU09OLnN0cmluZ2lmeShzb3J0T2JqZWN0UHJvcGVydGllc0J5S2V5KG9wdHMucXVlcnlfcGFyYW1zKSk7CiAgfQoKICBpZiAob3B0cy5maWx0ZXIgJiYgb3B0cy5maWx0ZXIgPT09ICdfdmlldycpIHsKICAgIGZpbHRlclZpZXdOYW1lID0gb3B0cy52aWV3LnRvU3RyaW5nKCk7CiAgfQoKICByZXR1cm4gUHJvbWlzZS5hbGwoW3NyYy5pZCgpLCB0YXJnZXQuaWQoKV0pLnRoZW4oZnVuY3Rpb24gKHJlcykgewogICAgdmFyIHF1ZXJ5RGF0YSA9IHJlc1swXSArIHJlc1sxXSArIGZpbHRlckZ1biArIGZpbHRlclZpZXdOYW1lICsKICAgICAgcXVlcnlQYXJhbXMgKyBkb2NJZHM7CiAgICByZXR1cm4gbWQ1KHF1ZXJ5RGF0YSk7CiAgfSkudGhlbihmdW5jdGlvbiAobWQ1c3VtKSB7CiAgICAvLyBjYW4ndCB1c2Ugc3RyYWlnaHQtdXAgbWQ1IGFscGhhYmV0LCBiZWNhdXNlCiAgICAvLyB0aGUgY2hhciAnLycgaXMgaW50ZXJwcmV0ZWQgYXMgYmVpbmcgZm9yIGF0dGFjaG1lbnRzLAogICAgLy8gYW5kICsgaXMgYWxzbyBub3QgdXJsLXNhZmUKICAgIG1kNXN1bSA9IG1kNXN1bS5yZXBsYWNlKC9cLy9nLCAnLicpLnJlcGxhY2UoL1wrL2csICdfJyk7CiAgICByZXR1cm4gJ19sb2NhbC8nICsgbWQ1c3VtOwogIH0pOwp9Cgptb2R1bGUuZXhwb3J0cyA9IGdlbmVyYXRlUmVwbGljYXRpb25JZDsKCn0seyIuLi9kZXBzL21kNSI6NjcsIi4vLi4vZGVwcy9wcm9taXNlIjo3OSwicG91Y2hkYi1jb2xsYXRlIjoxMDZ9XSw5NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciB1dGlscyA9IHJlcXVpcmUoJy4vLi4vdXRpbHMnKTsKdmFyIGNsb25lID0gdXRpbHMuY2xvbmU7CnZhciBQcm9taXNlID0gdXRpbHMuUHJvbWlzZTsKCmZ1bmN0aW9uIGlzR2VuT25lKHJldikgewogIHJldHVybiAvXjEtLy50ZXN0KHJldik7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUJ1bGtHZXRPcHRzKGRpZmZzKSB7CiAgdmFyIHJlcXVlc3RzID0gW107CiAgT2JqZWN0LmtleXMoZGlmZnMpLmZvckVhY2goZnVuY3Rpb24gKGlkKSB7CiAgICB2YXIgbWlzc2luZ1JldnMgPSBkaWZmc1tpZF0ubWlzc2luZzsKICAgIG1pc3NpbmdSZXZzLmZvckVhY2goZnVuY3Rpb24gKG1pc3NpbmdSZXYpIHsKICAgICAgcmVxdWVzdHMucHVzaCh7CiAgICAgICAgaWQ6IGlkLAogICAgICAgIHJldjogbWlzc2luZ1JldgogICAgICB9KTsKICAgIH0pOwogIH0pOwoKICByZXR1cm4gewogICAgZG9jczogcmVxdWVzdHMsCiAgICByZXZzOiB0cnVlLAogICAgYXR0YWNobWVudHM6IHRydWUsCiAgICBiaW5hcnk6IHRydWUKICB9Owp9CgovLwovLyBGZXRjaCBhbGwgdGhlIGRvY3VtZW50cyBmcm9tIHRoZSBzcmMgYXMgZGVzY3JpYmVkIGluIHRoZSAiZGlmZnMiLAovLyB3aGljaCBpcyBhIG1hcHBpbmcgb2YgZG9jcyBJRHMgdG8gcmV2aXNpb25zLiBJZiB0aGUgc3RhdGUgZXZlcgovLyBjaGFuZ2VzIHRvICJjYW5jZWxsZWQiLCB0aGVuIHRoZSByZXR1cm5lZCBwcm9taXNlIHdpbGwgYmUgcmVqZWN0ZWQuCi8vIEVsc2UgaXQgd2lsbCBiZSByZXNvbHZlZCB3aXRoIGEgbGlzdCBvZiBmZXRjaGVkIGRvY3VtZW50cy4KLy8KZnVuY3Rpb24gZ2V0RG9jcyhzcmMsIGRpZmZzLCBzdGF0ZSkgewogIGRpZmZzID0gY2xvbmUoZGlmZnMpOyAvLyB3ZSBkbyBub3QgbmVlZCB0byBtb2RpZnkgdGhpcwoKICB2YXIgcmVzdWx0RG9jcyA9IFtdOwoKICBmdW5jdGlvbiBnZXRBbGxEb2NzKCkgewoKICAgIHZhciBidWxrR2V0T3B0cyA9IGNyZWF0ZUJ1bGtHZXRPcHRzKGRpZmZzKTsKCiAgICByZXR1cm4gc3JjLmJ1bGtHZXQoYnVsa0dldE9wdHMpLnRoZW4oZnVuY3Rpb24gKGJ1bGtHZXRSZXNwb25zZSkgewogICAgICBpZiAoc3RhdGUuY2FuY2VsbGVkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdjYW5jZWxsZWQnKTsKICAgICAgfQogICAgICBidWxrR2V0UmVzcG9uc2UucmVzdWx0cy5mb3JFYWNoKGZ1bmN0aW9uIChidWxrR2V0SW5mbykgewogICAgICAgIGJ1bGtHZXRJbmZvLmRvY3MuZm9yRWFjaChmdW5jdGlvbiAoZG9jKSB7CiAgICAgICAgICBpZiAoZG9jLm9rKSB7CiAgICAgICAgICAgIHJlc3VsdERvY3MucHVzaChkb2Mub2spOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gaGFzQXR0YWNobWVudHMoZG9jKSB7CiAgICByZXR1cm4gZG9jLl9hdHRhY2htZW50cyAmJiBPYmplY3Qua2V5cyhkb2MuX2F0dGFjaG1lbnRzKS5sZW5ndGggPiAwOwogIH0KCiAgZnVuY3Rpb24gZmV0Y2hSZXZpc2lvbk9uZURvY3MoaWRzKSB7CiAgICAvLyBPcHRpbWl6YXRpb246IGZldGNoIGdlbi0xIGRvY3MgYW5kIGF0dGFjaG1lbnRzIGluCiAgICAvLyBhIHNpbmdsZSByZXF1ZXN0IHVzaW5nIF9hbGxfZG9jcwogICAgcmV0dXJuIHNyYy5hbGxEb2NzKHsKICAgICAga2V5czogaWRzLAogICAgICBpbmNsdWRlX2RvY3M6IHRydWUKICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlcykgewogICAgICBpZiAoc3RhdGUuY2FuY2VsbGVkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdjYW5jZWxsZWQnKTsKICAgICAgfQogICAgICByZXMucm93cy5mb3JFYWNoKGZ1bmN0aW9uIChyb3cpIHsKICAgICAgICBpZiAocm93LmRlbGV0ZWQgfHwgIXJvdy5kb2MgfHwgIWlzR2VuT25lKHJvdy52YWx1ZS5yZXYpIHx8CiAgICAgICAgICAgIGhhc0F0dGFjaG1lbnRzKHJvdy5kb2MpKSB7CiAgICAgICAgICAvLyBpZiBhbnkgb2YgdGhlc2UgY29uZGl0aW9ucyBhcHBseSwgd2UgbmVlZCB0byBmZXRjaCB1c2luZyBnZXQoKQogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gdGhlIGRvYyB3ZSBnb3QgYmFjayBmcm9tIGFsbERvY3MoKSBpcyBzdWZmaWNpZW50CiAgICAgICAgcmVzdWx0RG9jcy5wdXNoKHJvdy5kb2MpOwogICAgICAgIGRlbGV0ZSBkaWZmc1tyb3cuaWRdOwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gZ2V0UmV2aXNpb25PbmVEb2NzKCkgewogICAgLy8gZmlsdGVyIG91dCB0aGUgZ2VuZXJhdGlvbiAxIGRvY3MgYW5kIGdldCB0aGVtCiAgICAvLyBsZWF2aW5nIHRoZSBub24tZ2VuZXJhdGlvbiBvbmUgZG9jcyB0byBiZSBnb3Qgb3RoZXJ3aXNlCiAgICB2YXIgaWRzID0gT2JqZWN0LmtleXMoZGlmZnMpLmZpbHRlcihmdW5jdGlvbiAoaWQpIHsKICAgICAgdmFyIG1pc3NpbmcgPSBkaWZmc1tpZF0ubWlzc2luZzsKICAgICAgcmV0dXJuIG1pc3NpbmcubGVuZ3RoID09PSAxICYmIGlzR2VuT25lKG1pc3NpbmdbMF0pOwogICAgfSk7CiAgICBpZiAoaWRzLmxlbmd0aCA+IDApIHsKICAgICAgcmV0dXJuIGZldGNoUmV2aXNpb25PbmVEb2NzKGlkcyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZXR1cm5Eb2NzKCkgewogICAgcmV0dXJuIHJlc3VsdERvY3M7CiAgfQoKICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKICAgIC50aGVuKGdldFJldmlzaW9uT25lRG9jcykKICAgIC50aGVuKGdldEFsbERvY3MpCiAgICAudGhlbihyZXR1cm5Eb2NzKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBnZXREb2NzOwp9LHsiLi8uLi91dGlscyI6MTAyfV0sOTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgdXRpbHMgPSByZXF1aXJlKCcuLi91dGlscycpOwp2YXIgcmVwbGljYXRlID0gcmVxdWlyZSgnLi9yZXBsaWNhdGUnKTsKdmFyIFJlcGxpY2F0aW9uID0gcmVxdWlyZSgnLi9yZXBsaWNhdGlvbicpOwoKdmFyIGVycm9ycyA9IHJlcXVpcmUoJy4uL2RlcHMvZXJyb3JzJyk7CgpmdW5jdGlvbiB0b1BvdWNoKGRiLCBvcHRzKSB7CiAgdmFyIFBvdWNoQ29uc3RydWN0b3IgPSBvcHRzLlBvdWNoQ29uc3RydWN0b3I7CiAgaWYgKHR5cGVvZiBkYiA9PT0gJ3N0cmluZycpIHsKICAgIHJldHVybiBuZXcgUG91Y2hDb25zdHJ1Y3RvcihkYiwgb3B0cyk7CiAgfSBlbHNlIHsKICAgIHJldHVybiBkYjsKICB9Cn0KCmZ1bmN0aW9uIHJlcGxpY2F0ZVdyYXBwZXIoc3JjLCB0YXJnZXQsIG9wdHMsIGNhbGxiYWNrKSB7CgogIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2FsbGJhY2sgPSBvcHRzOwogICAgb3B0cyA9IHt9OwogIH0KICBpZiAodHlwZW9mIG9wdHMgPT09ICd1bmRlZmluZWQnKSB7CiAgICBvcHRzID0ge307CiAgfQoKICBpZiAob3B0cy5kb2NfaWRzICYmICFBcnJheS5pc0FycmF5KG9wdHMuZG9jX2lkcykpIHsKICAgIHRocm93IGVycm9ycy5lcnJvcihlcnJvcnMuQkFEX1JFUVVFU1QsCiAgICAgICAgICAgICAgICAgICAgICAgImBkb2NfaWRzYCBmaWx0ZXIgcGFyYW1ldGVyIGlzIG5vdCBhIGxpc3QuIik7CiAgfQoKICBvcHRzLmNvbXBsZXRlID0gY2FsbGJhY2s7CiAgb3B0cyA9IHV0aWxzLmNsb25lKG9wdHMpOwogIG9wdHMuY29udGludW91cyA9IG9wdHMuY29udGludW91cyB8fCBvcHRzLmxpdmU7CiAgb3B0cy5yZXRyeSA9ICgncmV0cnknIGluIG9wdHMpID8gb3B0cy5yZXRyeSA6IGZhbHNlOwogIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovCiAgb3B0cy5Qb3VjaENvbnN0cnVjdG9yID0gb3B0cy5Qb3VjaENvbnN0cnVjdG9yIHx8IHRoaXM7CiAgdmFyIHJlcGxpY2F0ZVJldCA9IG5ldyBSZXBsaWNhdGlvbihvcHRzKTsKICB2YXIgc3JjUG91Y2ggPSB0b1BvdWNoKHNyYywgb3B0cyk7CiAgdmFyIHRhcmdldFBvdWNoID0gdG9Qb3VjaCh0YXJnZXQsIG9wdHMpOwogIHJlcGxpY2F0ZShzcmNQb3VjaCwgdGFyZ2V0UG91Y2gsIG9wdHMsIHJlcGxpY2F0ZVJldCk7CiAgcmV0dXJuIHJlcGxpY2F0ZVJldDsKfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgcmVwbGljYXRlOiByZXBsaWNhdGVXcmFwcGVyLAogIHRvUG91Y2g6IHRvUG91Y2gKfTsKCn0seyIuLi9kZXBzL2Vycm9ycyI6NjQsIi4uL3V0aWxzIjoxMDIsIi4vcmVwbGljYXRlIjo5NywiLi9yZXBsaWNhdGlvbiI6OTh9XSw5NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciB1dGlscyA9IHJlcXVpcmUoJy4vLi4vdXRpbHMnKTsKdmFyIENoZWNrcG9pbnRlciA9IHJlcXVpcmUoJy4vY2hlY2twb2ludGVyJyk7CnZhciBiYWNrT2ZmID0gcmVxdWlyZSgnLi9iYWNrb2ZmJyk7CnZhciBnZW5lcmF0ZVJlcGxpY2F0aW9uSWQgPSByZXF1aXJlKCcuL2dlbmVyYXRlUmVwbGljYXRpb25JZCcpOwp2YXIgZ2V0RG9jcyA9IHJlcXVpcmUoJy4vZ2V0RG9jcycpOwoKZnVuY3Rpb24gcmVwbGljYXRlKHNyYywgdGFyZ2V0LCBvcHRzLCByZXR1cm5WYWx1ZSwgcmVzdWx0KSB7CiAgdmFyIGJhdGNoZXMgPSBbXTsgICAgICAgICAgICAgICAvLyBsaXN0IG9mIGJhdGNoZXMgdG8gYmUgcHJvY2Vzc2VkCiAgdmFyIGN1cnJlbnRCYXRjaDsgICAgICAgICAgICAgICAvLyB0aGUgYmF0Y2ggY3VycmVudGx5IGJlaW5nIHByb2Nlc3NlZAogIHZhciBwZW5kaW5nQmF0Y2ggPSB7CiAgICBzZXE6IDAsCiAgICBjaGFuZ2VzOiBbXSwKICAgIGRvY3M6IFtdCiAgfTsgLy8gbmV4dCBiYXRjaCwgbm90IHlldCByZWFkeSB0byBiZSBwcm9jZXNzZWQKICB2YXIgd3JpdGluZ0NoZWNrcG9pbnQgPSBmYWxzZTsgIC8vIHRydWUgd2hpbGUgY2hlY2twb2ludCBpcyBiZWluZyB3cml0dGVuCiAgdmFyIGNoYW5nZXNDb21wbGV0ZWQgPSBmYWxzZTsgICAvLyB0cnVlIHdoZW4gYWxsIGNoYW5nZXMgcmVjZWl2ZWQKICB2YXIgcmVwbGljYXRpb25Db21wbGV0ZWQgPSBmYWxzZTsgLy8gdHJ1ZSB3aGVuIHJlcGxpY2F0aW9uIGhhcyBjb21wbGV0ZWQKICB2YXIgbGFzdF9zZXEgPSAwOwogIHZhciBjb250aW51b3VzID0gb3B0cy5jb250aW51b3VzIHx8IG9wdHMubGl2ZSB8fCBmYWxzZTsKICB2YXIgYmF0Y2hfc2l6ZSA9IG9wdHMuYmF0Y2hfc2l6ZSB8fCAxMDA7CiAgdmFyIGJhdGNoZXNfbGltaXQgPSBvcHRzLmJhdGNoZXNfbGltaXQgfHwgMTA7CiAgdmFyIGNoYW5nZXNQZW5kaW5nID0gZmFsc2U7ICAgICAvLyB0cnVlIHdoaWxlIHNyYy5jaGFuZ2VzIGlzIHJ1bm5pbmcKICB2YXIgZG9jX2lkcyA9IG9wdHMuZG9jX2lkczsKICB2YXIgc3RhdGUgPSB7CiAgICBjYW5jZWxsZWQ6IGZhbHNlCiAgfTsKICB2YXIgcmVwSWQ7CiAgdmFyIGNoZWNrcG9pbnRlcjsKICB2YXIgYWxsRXJyb3JzID0gW107CiAgdmFyIGNoYW5nZWREb2NzID0gW107CiAgLy8gTGlrZSBjb3VjaGRiLCBldmVyeSByZXBsaWNhdGlvbiBnZXRzIGEgdW5pcXVlIHNlc3Npb24gaWQKICB2YXIgc2Vzc2lvbiA9IHV0aWxzLnV1aWQoKTsKCiAgcmVzdWx0ID0gcmVzdWx0IHx8IHsKICAgIG9rOiB0cnVlLAogICAgc3RhcnRfdGltZTogbmV3IERhdGUoKSwKICAgIGRvY3NfcmVhZDogMCwKICAgIGRvY3Nfd3JpdHRlbjogMCwKICAgIGRvY193cml0ZV9mYWlsdXJlczogMCwKICAgIGVycm9yczogW10KICB9OwoKICB2YXIgY2hhbmdlc09wdHMgPSB7fTsKICByZXR1cm5WYWx1ZS5yZWFkeShzcmMsIHRhcmdldCk7CgogIGZ1bmN0aW9uIGluaXRDaGVja3BvaW50ZXIoKSB7CiAgICBpZiAoY2hlY2twb2ludGVyKSB7CiAgICAgIHJldHVybiB1dGlscy5Qcm9taXNlLnJlc29sdmUoKTsKICAgIH0KICAgIHJldHVybiBnZW5lcmF0ZVJlcGxpY2F0aW9uSWQoc3JjLCB0YXJnZXQsIG9wdHMpLnRoZW4oZnVuY3Rpb24gKHJlcykgewogICAgICByZXBJZCA9IHJlczsKICAgICAgY2hlY2twb2ludGVyID0gbmV3IENoZWNrcG9pbnRlcihzcmMsIHRhcmdldCwgcmVwSWQsIHN0YXRlKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gd3JpdGVEb2NzKCkgewogICAgaWYgKGN1cnJlbnRCYXRjaC5kb2NzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgZG9jcyA9IGN1cnJlbnRCYXRjaC5kb2NzOwogICAgcmV0dXJuIHRhcmdldC5idWxrRG9jcyh7ZG9jczogZG9jcywgbmV3X2VkaXRzOiBmYWxzZX0pLnRoZW4oZnVuY3Rpb24gKHJlcykgewogICAgICBpZiAoc3RhdGUuY2FuY2VsbGVkKSB7CiAgICAgICAgY29tcGxldGVSZXBsaWNhdGlvbigpOwogICAgICAgIHRocm93IG5ldyBFcnJvcignY2FuY2VsbGVkJyk7CiAgICAgIH0KICAgICAgdmFyIGVycm9ycyA9IFtdOwogICAgICB2YXIgZXJyb3JzQnlJZCA9IHt9OwogICAgICByZXMuZm9yRWFjaChmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgaWYgKHJlcy5lcnJvcikgewogICAgICAgICAgcmVzdWx0LmRvY193cml0ZV9mYWlsdXJlcysrOwogICAgICAgICAgZXJyb3JzLnB1c2gocmVzKTsKICAgICAgICAgIGVycm9yc0J5SWRbcmVzLmlkXSA9IHJlczsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBhbGxFcnJvcnMgPSBhbGxFcnJvcnMuY29uY2F0KGVycm9ycyk7CiAgICAgIHJlc3VsdC5kb2NzX3dyaXR0ZW4gKz0gY3VycmVudEJhdGNoLmRvY3MubGVuZ3RoIC0gZXJyb3JzLmxlbmd0aDsKICAgICAgdmFyIG5vbjQwM3MgPSBlcnJvcnMuZmlsdGVyKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgIHJldHVybiBlcnJvci5uYW1lICE9PSAndW5hdXRob3JpemVkJyAmJiBlcnJvci5uYW1lICE9PSAnZm9yYmlkZGVuJzsKICAgICAgfSk7CgogICAgICBjaGFuZ2VkRG9jcyA9IFtdOwogICAgICBkb2NzLmZvckVhY2goZnVuY3Rpb24oZG9jKSB7CiAgICAgICAgdmFyIGVycm9yID0gZXJyb3JzQnlJZFtkb2MuX2lkXTsKICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgIHJldHVyblZhbHVlLmVtaXQoJ2RlbmllZCcsIHV0aWxzLmNsb25lKGVycm9yKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNoYW5nZWREb2NzLnB1c2goZG9jKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgaWYgKG5vbjQwM3MubGVuZ3RoID4gMCkgewogICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcignYnVsa0RvY3MgZXJyb3InKTsKICAgICAgICBlcnJvci5vdGhlcl9lcnJvcnMgPSBlcnJvcnM7CiAgICAgICAgYWJvcnRSZXBsaWNhdGlvbigndGFyZ2V0LmJ1bGtEb2NzIGZhaWxlZCB0byB3cml0ZSBkb2NzJywgZXJyb3IpOwogICAgICAgIHRocm93IG5ldyBFcnJvcignYnVsa1dyaXRlIHBhcnRpYWwgZmFpbHVyZScpOwogICAgICB9CiAgICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgIHJlc3VsdC5kb2Nfd3JpdGVfZmFpbHVyZXMgKz0gZG9jcy5sZW5ndGg7CiAgICAgIHRocm93IGVycjsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gZmluaXNoQmF0Y2goKSB7CiAgICByZXN1bHQubGFzdF9zZXEgPSBsYXN0X3NlcSA9IGN1cnJlbnRCYXRjaC5zZXE7CiAgICB2YXIgb3V0UmVzdWx0ID0gdXRpbHMuY2xvbmUocmVzdWx0KTsKICAgIGlmIChjaGFuZ2VkRG9jcy5sZW5ndGgpIHsKICAgICAgb3V0UmVzdWx0LmRvY3MgPSBjaGFuZ2VkRG9jczsKICAgICAgcmV0dXJuVmFsdWUuZW1pdCgnY2hhbmdlJywgb3V0UmVzdWx0KTsKICAgIH0KICAgIHdyaXRpbmdDaGVja3BvaW50ID0gdHJ1ZTsKICAgIHJldHVybiBjaGVja3BvaW50ZXIud3JpdGVDaGVja3BvaW50KGN1cnJlbnRCYXRjaC5zZXEsCiAgICAgICAgc2Vzc2lvbikudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIHdyaXRpbmdDaGVja3BvaW50ID0gZmFsc2U7CiAgICAgIGlmIChzdGF0ZS5jYW5jZWxsZWQpIHsKICAgICAgICBjb21wbGV0ZVJlcGxpY2F0aW9uKCk7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdjYW5jZWxsZWQnKTsKICAgICAgfQogICAgICBjdXJyZW50QmF0Y2ggPSB1bmRlZmluZWQ7CiAgICAgIGdldENoYW5nZXMoKTsKICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgd3JpdGluZ0NoZWNrcG9pbnQgPSBmYWxzZTsKICAgICAgYWJvcnRSZXBsaWNhdGlvbignd3JpdGVDaGVja3BvaW50IGNvbXBsZXRlZCB3aXRoIGVycm9yJywgZXJyKTsKICAgICAgdGhyb3cgZXJyOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBnZXREaWZmcygpIHsKICAgIHZhciBkaWZmID0ge307CiAgICBjdXJyZW50QmF0Y2guY2hhbmdlcy5mb3JFYWNoKGZ1bmN0aW9uIChjaGFuZ2UpIHsKICAgICAgLy8gQ291Y2hiYXNlIFN5bmMgR2F0ZXdheSBlbWl0cyB0aGVzZSwgYnV0IHdlIGNhbiBpZ25vcmUgdGhlbQogICAgICBpZiAoY2hhbmdlLmlkID09PSAiX3VzZXIvIikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBkaWZmW2NoYW5nZS5pZF0gPSBjaGFuZ2UuY2hhbmdlcy5tYXAoZnVuY3Rpb24gKHgpIHsKICAgICAgICByZXR1cm4geC5yZXY7CiAgICAgIH0pOwogICAgfSk7CiAgICByZXR1cm4gdGFyZ2V0LnJldnNEaWZmKGRpZmYpLnRoZW4oZnVuY3Rpb24gKGRpZmZzKSB7CiAgICAgIGlmIChzdGF0ZS5jYW5jZWxsZWQpIHsKICAgICAgICBjb21wbGV0ZVJlcGxpY2F0aW9uKCk7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdjYW5jZWxsZWQnKTsKICAgICAgfQogICAgICAvLyBjdXJyZW50QmF0Y2guZGlmZnMgZWxlbWVudHMgYXJlIGRlbGV0ZWQgYXMgdGhlIGRvY3VtZW50cyBhcmUgd3JpdHRlbgogICAgICBjdXJyZW50QmF0Y2guZGlmZnMgPSBkaWZmczsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gZ2V0QmF0Y2hEb2NzKCkgewogICAgcmV0dXJuIGdldERvY3Moc3JjLCBjdXJyZW50QmF0Y2guZGlmZnMsIHN0YXRlKS50aGVuKGZ1bmN0aW9uIChkb2NzKSB7CiAgICAgIGRvY3MuZm9yRWFjaChmdW5jdGlvbiAoZG9jKSB7CiAgICAgICAgZGVsZXRlIGN1cnJlbnRCYXRjaC5kaWZmc1tkb2MuX2lkXTsKICAgICAgICByZXN1bHQuZG9jc19yZWFkKys7CiAgICAgICAgY3VycmVudEJhdGNoLmRvY3MucHVzaChkb2MpOwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gc3RhcnROZXh0QmF0Y2goKSB7CiAgICBpZiAoc3RhdGUuY2FuY2VsbGVkIHx8IGN1cnJlbnRCYXRjaCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoYmF0Y2hlcy5sZW5ndGggPT09IDApIHsKICAgICAgcHJvY2Vzc1BlbmRpbmdCYXRjaCh0cnVlKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY3VycmVudEJhdGNoID0gYmF0Y2hlcy5zaGlmdCgpOwogICAgZ2V0RGlmZnMoKQogICAgICAudGhlbihnZXRCYXRjaERvY3MpCiAgICAgIC50aGVuKHdyaXRlRG9jcykKICAgICAgLnRoZW4oZmluaXNoQmF0Y2gpCiAgICAgIC50aGVuKHN0YXJ0TmV4dEJhdGNoKQogICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgIGFib3J0UmVwbGljYXRpb24oJ2JhdGNoIHByb2Nlc3NpbmcgdGVybWluYXRlZCB3aXRoIGVycm9yJywgZXJyKTsKICAgICAgfSk7CiAgfQoKCiAgZnVuY3Rpb24gcHJvY2Vzc1BlbmRpbmdCYXRjaChpbW1lZGlhdGUpIHsKICAgIGlmIChwZW5kaW5nQmF0Y2guY2hhbmdlcy5sZW5ndGggPT09IDApIHsKICAgICAgaWYgKGJhdGNoZXMubGVuZ3RoID09PSAwICYmICFjdXJyZW50QmF0Y2gpIHsKICAgICAgICBpZiAoKGNvbnRpbnVvdXMgJiYgY2hhbmdlc09wdHMubGl2ZSkgfHwgY2hhbmdlc0NvbXBsZXRlZCkgewogICAgICAgICAgcmV0dXJuVmFsdWUuc3RhdGUgPSAncGVuZGluZyc7CiAgICAgICAgICByZXR1cm5WYWx1ZS5lbWl0KCdwYXVzZWQnKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNoYW5nZXNDb21wbGV0ZWQpIHsKICAgICAgICAgIGNvbXBsZXRlUmVwbGljYXRpb24oKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKAogICAgICBpbW1lZGlhdGUgfHwKICAgICAgY2hhbmdlc0NvbXBsZXRlZCB8fAogICAgICBwZW5kaW5nQmF0Y2guY2hhbmdlcy5sZW5ndGggPj0gYmF0Y2hfc2l6ZQogICAgKSB7CiAgICAgIGJhdGNoZXMucHVzaChwZW5kaW5nQmF0Y2gpOwogICAgICBwZW5kaW5nQmF0Y2ggPSB7CiAgICAgICAgc2VxOiAwLAogICAgICAgIGNoYW5nZXM6IFtdLAogICAgICAgIGRvY3M6IFtdCiAgICAgIH07CiAgICAgIGlmIChyZXR1cm5WYWx1ZS5zdGF0ZSA9PT0gJ3BlbmRpbmcnIHx8IHJldHVyblZhbHVlLnN0YXRlID09PSAnc3RvcHBlZCcpIHsKICAgICAgICByZXR1cm5WYWx1ZS5zdGF0ZSA9ICdhY3RpdmUnOwogICAgICAgIHJldHVyblZhbHVlLmVtaXQoJ2FjdGl2ZScpOwogICAgICB9CiAgICAgIHN0YXJ0TmV4dEJhdGNoKCk7CiAgICB9CiAgfQoKCiAgZnVuY3Rpb24gYWJvcnRSZXBsaWNhdGlvbihyZWFzb24sIGVycikgewogICAgaWYgKHJlcGxpY2F0aW9uQ29tcGxldGVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghZXJyLm1lc3NhZ2UpIHsKICAgICAgZXJyLm1lc3NhZ2UgPSByZWFzb247CiAgICB9CiAgICByZXN1bHQub2sgPSBmYWxzZTsKICAgIHJlc3VsdC5zdGF0dXMgPSAnYWJvcnRpbmcnOwogICAgcmVzdWx0LmVycm9ycy5wdXNoKGVycik7CiAgICBhbGxFcnJvcnMgPSBhbGxFcnJvcnMuY29uY2F0KGVycik7CiAgICBiYXRjaGVzID0gW107CiAgICBwZW5kaW5nQmF0Y2ggPSB7CiAgICAgIHNlcTogMCwKICAgICAgY2hhbmdlczogW10sCiAgICAgIGRvY3M6IFtdCiAgICB9OwogICAgY29tcGxldGVSZXBsaWNhdGlvbigpOwogIH0KCgogIGZ1bmN0aW9uIGNvbXBsZXRlUmVwbGljYXRpb24oKSB7CiAgICBpZiAocmVwbGljYXRpb25Db21wbGV0ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHN0YXRlLmNhbmNlbGxlZCkgewogICAgICByZXN1bHQuc3RhdHVzID0gJ2NhbmNlbGxlZCc7CiAgICAgIGlmICh3cml0aW5nQ2hlY2twb2ludCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogICAgcmVzdWx0LnN0YXR1cyA9IHJlc3VsdC5zdGF0dXMgfHwgJ2NvbXBsZXRlJzsKICAgIHJlc3VsdC5lbmRfdGltZSA9IG5ldyBEYXRlKCk7CiAgICByZXN1bHQubGFzdF9zZXEgPSBsYXN0X3NlcTsKICAgIHJlcGxpY2F0aW9uQ29tcGxldGVkID0gc3RhdGUuY2FuY2VsbGVkID0gdHJ1ZTsKICAgIHZhciBub240MDNzID0gYWxsRXJyb3JzLmZpbHRlcihmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgcmV0dXJuIGVycm9yLm5hbWUgIT09ICd1bmF1dGhvcml6ZWQnICYmIGVycm9yLm5hbWUgIT09ICdmb3JiaWRkZW4nOwogICAgfSk7CiAgICBpZiAobm9uNDAzcy5sZW5ndGggPiAwKSB7CiAgICAgIHZhciBlcnJvciA9IGFsbEVycm9ycy5wb3AoKTsKICAgICAgaWYgKGFsbEVycm9ycy5sZW5ndGggPiAwKSB7CiAgICAgICAgZXJyb3Iub3RoZXJfZXJyb3JzID0gYWxsRXJyb3JzOwogICAgICB9CiAgICAgIGVycm9yLnJlc3VsdCA9IHJlc3VsdDsKICAgICAgYmFja09mZihvcHRzLCByZXR1cm5WYWx1ZSwgZXJyb3IsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXBsaWNhdGUoc3JjLCB0YXJnZXQsIG9wdHMsIHJldHVyblZhbHVlKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICByZXN1bHQuZXJyb3JzID0gYWxsRXJyb3JzOwogICAgICByZXR1cm5WYWx1ZS5lbWl0KCdjb21wbGV0ZScsIHJlc3VsdCk7CiAgICAgIHJldHVyblZhbHVlLnJlbW92ZUFsbExpc3RlbmVycygpOwogICAgfQogIH0KCgogIGZ1bmN0aW9uIG9uQ2hhbmdlKGNoYW5nZSkgewogICAgaWYgKHN0YXRlLmNhbmNlbGxlZCkgewogICAgICByZXR1cm4gY29tcGxldGVSZXBsaWNhdGlvbigpOwogICAgfQogICAgdmFyIGZpbHRlciA9IHV0aWxzLmZpbHRlckNoYW5nZShvcHRzKShjaGFuZ2UpOwogICAgaWYgKCFmaWx0ZXIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcGVuZGluZ0JhdGNoLnNlcSA9IGNoYW5nZS5zZXE7CiAgICBwZW5kaW5nQmF0Y2guY2hhbmdlcy5wdXNoKGNoYW5nZSk7CiAgICBwcm9jZXNzUGVuZGluZ0JhdGNoKGJhdGNoZXMubGVuZ3RoID09PSAwKTsKICB9CgoKICBmdW5jdGlvbiBvbkNoYW5nZXNDb21wbGV0ZShjaGFuZ2VzKSB7CiAgICBjaGFuZ2VzUGVuZGluZyA9IGZhbHNlOwogICAgaWYgKHN0YXRlLmNhbmNlbGxlZCkgewogICAgICByZXR1cm4gY29tcGxldGVSZXBsaWNhdGlvbigpOwogICAgfQoKICAgIC8vIGlmIG5vIHJlc3VsdHMgd2VyZSByZXR1cm5lZCB0aGVuIHdlJ3JlIGRvbmUsCiAgICAvLyBlbHNlIGZldGNoIG1vcmUKICAgIGlmIChjaGFuZ2VzLnJlc3VsdHMubGVuZ3RoID4gMCkgewogICAgICBjaGFuZ2VzT3B0cy5zaW5jZSA9IGNoYW5nZXMubGFzdF9zZXE7CiAgICAgIGdldENoYW5nZXMoKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChjb250aW51b3VzKSB7CiAgICAgICAgY2hhbmdlc09wdHMubGl2ZSA9IHRydWU7CiAgICAgICAgZ2V0Q2hhbmdlcygpOwogICAgICB9IGVsc2UgewogICAgICAgIGNoYW5nZXNDb21wbGV0ZWQgPSB0cnVlOwogICAgICB9CiAgICB9CiAgICBwcm9jZXNzUGVuZGluZ0JhdGNoKHRydWUpOwogIH0KCgogIGZ1bmN0aW9uIG9uQ2hhbmdlc0Vycm9yKGVycikgewogICAgY2hhbmdlc1BlbmRpbmcgPSBmYWxzZTsKICAgIGlmIChzdGF0ZS5jYW5jZWxsZWQpIHsKICAgICAgcmV0dXJuIGNvbXBsZXRlUmVwbGljYXRpb24oKTsKICAgIH0KICAgIGFib3J0UmVwbGljYXRpb24oJ2NoYW5nZXMgcmVqZWN0ZWQnLCBlcnIpOwogIH0KCgogIGZ1bmN0aW9uIGdldENoYW5nZXMoKSB7CiAgICBpZiAoISgKICAgICAgIWNoYW5nZXNQZW5kaW5nICYmCiAgICAgICFjaGFuZ2VzQ29tcGxldGVkICYmCiAgICAgIGJhdGNoZXMubGVuZ3RoIDwgYmF0Y2hlc19saW1pdAogICAgICApKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNoYW5nZXNQZW5kaW5nID0gdHJ1ZTsKICAgIGZ1bmN0aW9uIGFib3J0Q2hhbmdlcygpIHsKICAgICAgY2hhbmdlcy5jYW5jZWwoKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlbW92ZUxpc3RlbmVyKCkgewogICAgICByZXR1cm5WYWx1ZS5yZW1vdmVMaXN0ZW5lcignY2FuY2VsJywgYWJvcnRDaGFuZ2VzKTsKICAgIH0KCiAgICBpZiAocmV0dXJuVmFsdWUuX2NoYW5nZXMpIHsgLy8gcmVtb3ZlIG9sZCBjaGFuZ2VzKCkgYW5kIGxpc3RlbmVycwogICAgICByZXR1cm5WYWx1ZS5yZW1vdmVMaXN0ZW5lcignY2FuY2VsJywgcmV0dXJuVmFsdWUuX2Fib3J0Q2hhbmdlcyk7CiAgICAgIHJldHVyblZhbHVlLl9jaGFuZ2VzLmNhbmNlbCgpOwogICAgfQogICAgcmV0dXJuVmFsdWUub25jZSgnY2FuY2VsJywgYWJvcnRDaGFuZ2VzKTsKCiAgICB2YXIgY2hhbmdlcyA9IHNyYy5jaGFuZ2VzKGNoYW5nZXNPcHRzKQogICAgICAub24oJ2NoYW5nZScsIG9uQ2hhbmdlKTsKICAgIGNoYW5nZXMudGhlbihyZW1vdmVMaXN0ZW5lciwgcmVtb3ZlTGlzdGVuZXIpOwogICAgY2hhbmdlcy50aGVuKG9uQ2hhbmdlc0NvbXBsZXRlKQogICAgICAuY2F0Y2gob25DaGFuZ2VzRXJyb3IpOwoKICAgIGlmIChvcHRzLnJldHJ5KSB7CiAgICAgIC8vIHNhdmUgZm9yIGxhdGVyIHNvIHdlIGNhbiBjYW5jZWwgaWYgbmVjZXNzYXJ5CiAgICAgIHJldHVyblZhbHVlLl9jaGFuZ2VzID0gY2hhbmdlczsKICAgICAgcmV0dXJuVmFsdWUuX2Fib3J0Q2hhbmdlcyA9IGFib3J0Q2hhbmdlczsKICAgIH0KICB9CgoKICBmdW5jdGlvbiBzdGFydENoYW5nZXMoKSB7CiAgICBpbml0Q2hlY2twb2ludGVyKCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChzdGF0ZS5jYW5jZWxsZWQpIHsKICAgICAgICBjb21wbGV0ZVJlcGxpY2F0aW9uKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHJldHVybiBjaGVja3BvaW50ZXIuZ2V0Q2hlY2twb2ludCgpLnRoZW4oZnVuY3Rpb24gKGNoZWNrcG9pbnQpIHsKICAgICAgICBsYXN0X3NlcSA9IGNoZWNrcG9pbnQ7CiAgICAgICAgY2hhbmdlc09wdHMgPSB7CiAgICAgICAgICBzaW5jZTogbGFzdF9zZXEsCiAgICAgICAgICBsaW1pdDogYmF0Y2hfc2l6ZSwKICAgICAgICAgIGJhdGNoX3NpemU6IGJhdGNoX3NpemUsCiAgICAgICAgICBzdHlsZTogJ2FsbF9kb2NzJywKICAgICAgICAgIGRvY19pZHM6IGRvY19pZHMsCiAgICAgICAgICByZXR1cm5Eb2NzOiB0cnVlIC8vIHJlcXVpcmVkIHNvIHdlIGtub3cgd2hlbiB3ZSdyZSBkb25lCiAgICAgICAgfTsKICAgICAgICBpZiAob3B0cy5maWx0ZXIpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygb3B0cy5maWx0ZXIgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIC8vIHJlcXVpcmVkIGZvciB0aGUgY2xpZW50LXNpZGUgZmlsdGVyIGluIG9uQ2hhbmdlCiAgICAgICAgICAgIGNoYW5nZXNPcHRzLmluY2x1ZGVfZG9jcyA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgeyAvLyBkZG9jIGZpbHRlcgogICAgICAgICAgICBjaGFuZ2VzT3B0cy5maWx0ZXIgPSBvcHRzLmZpbHRlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG9wdHMucXVlcnlfcGFyYW1zKSB7CiAgICAgICAgICBjaGFuZ2VzT3B0cy5xdWVyeV9wYXJhbXMgPSBvcHRzLnF1ZXJ5X3BhcmFtczsKICAgICAgICB9CiAgICAgICAgaWYgKG9wdHMudmlldykgewogICAgICAgICAgY2hhbmdlc09wdHMudmlldyA9IG9wdHMudmlldzsKICAgICAgICB9CiAgICAgICAgZ2V0Q2hhbmdlcygpOwogICAgICB9KTsKICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgYWJvcnRSZXBsaWNhdGlvbignZ2V0Q2hlY2twb2ludCByZWplY3RlZCB3aXRoICcsIGVycik7CiAgICB9KTsKICB9CgogIGlmIChyZXR1cm5WYWx1ZS5jYW5jZWxsZWQpIHsgLy8gY2FuY2VsbGVkIGltbWVkaWF0ZWx5CiAgICBjb21wbGV0ZVJlcGxpY2F0aW9uKCk7CiAgICByZXR1cm47CiAgfQoKICBpZiAoIXJldHVyblZhbHVlLl9hZGRlZExpc3RlbmVycykgewogICAgcmV0dXJuVmFsdWUub25jZSgnY2FuY2VsJywgY29tcGxldGVSZXBsaWNhdGlvbik7CgogICAgaWYgKHR5cGVvZiBvcHRzLmNvbXBsZXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJldHVyblZhbHVlLm9uY2UoJ2Vycm9yJywgb3B0cy5jb21wbGV0ZSk7CiAgICAgIHJldHVyblZhbHVlLm9uY2UoJ2NvbXBsZXRlJywgZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgIG9wdHMuY29tcGxldGUobnVsbCwgcmVzdWx0KTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm5WYWx1ZS5fYWRkZWRMaXN0ZW5lcnMgPSB0cnVlOwogIH0KCiAgaWYgKHR5cGVvZiBvcHRzLnNpbmNlID09PSAndW5kZWZpbmVkJykgewogICAgc3RhcnRDaGFuZ2VzKCk7CiAgfSBlbHNlIHsKICAgIGluaXRDaGVja3BvaW50ZXIoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgd3JpdGluZ0NoZWNrcG9pbnQgPSB0cnVlOwogICAgICByZXR1cm4gY2hlY2twb2ludGVyLndyaXRlQ2hlY2twb2ludChvcHRzLnNpbmNlLCBzZXNzaW9uKTsKICAgIH0pLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICB3cml0aW5nQ2hlY2twb2ludCA9IGZhbHNlOwogICAgICBpZiAoc3RhdGUuY2FuY2VsbGVkKSB7CiAgICAgICAgY29tcGxldGVSZXBsaWNhdGlvbigpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBsYXN0X3NlcSA9IG9wdHMuc2luY2U7CiAgICAgIHN0YXJ0Q2hhbmdlcygpOwogICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICB3cml0aW5nQ2hlY2twb2ludCA9IGZhbHNlOwogICAgICBhYm9ydFJlcGxpY2F0aW9uKCd3cml0ZUNoZWNrcG9pbnQgY29tcGxldGVkIHdpdGggZXJyb3InLCBlcnIpOwogICAgICB0aHJvdyBlcnI7CiAgICB9KTsKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gcmVwbGljYXRlOwoKfSx7Ii4vLi4vdXRpbHMiOjEwMiwiLi9iYWNrb2ZmIjo5MiwiLi9jaGVja3BvaW50ZXIiOjkzLCIuL2dlbmVyYXRlUmVwbGljYXRpb25JZCI6OTQsIi4vZ2V0RG9jcyI6OTV9XSw5ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciB1dGlscyA9IHJlcXVpcmUoJy4vLi4vdXRpbHMnKTsKdmFyIEVFID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyOwp2YXIgUHJvbWlzZSA9IHV0aWxzLlByb21pc2U7CgovLyBXZSBjcmVhdGUgYSBiYXNpYyBwcm9taXNlIHNvIHRoZSBjYWxsZXIgY2FuIGNhbmNlbCB0aGUgcmVwbGljYXRpb24gcG9zc2libHkKLy8gYmVmb3JlIHdlIGhhdmUgYWN0dWFsbHkgc3RhcnRlZCBsaXN0ZW5pbmcgdG8gY2hhbmdlcyBldGMKdXRpbHMuaW5oZXJpdHMoUmVwbGljYXRpb24sIEVFKTsKZnVuY3Rpb24gUmVwbGljYXRpb24oKSB7CiAgRUUuY2FsbCh0aGlzKTsKICB0aGlzLmNhbmNlbGxlZCA9IGZhbHNlOwogIHRoaXMuc3RhdGUgPSAncGVuZGluZyc7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHZhciBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKGZ1bGZpbGwsIHJlamVjdCkgewogICAgc2VsZi5vbmNlKCdjb21wbGV0ZScsIGZ1bGZpbGwpOwogICAgc2VsZi5vbmNlKCdlcnJvcicsIHJlamVjdCk7CiAgfSk7CiAgc2VsZi50aGVuID0gZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgcmV0dXJuIHByb21pc2UudGhlbihyZXNvbHZlLCByZWplY3QpOwogIH07CiAgc2VsZi5jYXRjaCA9IGZ1bmN0aW9uIChyZWplY3QpIHsKICAgIHJldHVybiBwcm9taXNlLmNhdGNoKHJlamVjdCk7CiAgfTsKICAvLyBBcyB3ZSBhbGxvdyBlcnJvciBoYW5kbGluZyB2aWEgImVycm9yIiBldmVudCBhcyB3ZWxsLAogIC8vIHB1dCBhIHN0dWIgaW4gaGVyZSBzbyB0aGF0IHJlamVjdGluZyBuZXZlciB0aHJvd3MgVW5oYW5kbGVkRXJyb3IuCiAgc2VsZi5jYXRjaChmdW5jdGlvbiAoKSB7fSk7Cn0KClJlcGxpY2F0aW9uLnByb3RvdHlwZS5jYW5jZWwgPSBmdW5jdGlvbiAoKSB7CiAgdGhpcy5jYW5jZWxsZWQgPSB0cnVlOwogIHRoaXMuc3RhdGUgPSAnY2FuY2VsbGVkJzsKICB0aGlzLmVtaXQoJ2NhbmNlbCcpOwp9OwoKUmVwbGljYXRpb24ucHJvdG90eXBlLnJlYWR5ID0gZnVuY3Rpb24gKHNyYywgdGFyZ2V0KSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIGlmIChzZWxmLl9yZWFkeUNhbGxlZCkgewogICAgcmV0dXJuOwogIH0KICBzZWxmLl9yZWFkeUNhbGxlZCA9IHRydWU7CgogIGZ1bmN0aW9uIG9uRGVzdHJveSgpIHsKICAgIHNlbGYuY2FuY2VsKCk7CiAgfQogIHNyYy5vbmNlKCdkZXN0cm95ZWQnLCBvbkRlc3Ryb3kpOwogIHRhcmdldC5vbmNlKCdkZXN0cm95ZWQnLCBvbkRlc3Ryb3kpOwogIGZ1bmN0aW9uIGNsZWFudXAoKSB7CiAgICBzcmMucmVtb3ZlTGlzdGVuZXIoJ2Rlc3Ryb3llZCcsIG9uRGVzdHJveSk7CiAgICB0YXJnZXQucmVtb3ZlTGlzdGVuZXIoJ2Rlc3Ryb3llZCcsIG9uRGVzdHJveSk7CiAgfQogIHNlbGYub25jZSgnY29tcGxldGUnLCBjbGVhbnVwKTsKfTsKCm1vZHVsZS5leHBvcnRzID0gUmVwbGljYXRpb247Cn0seyIuLy4uL3V0aWxzIjoxMDIsImV2ZW50cyI6N31dLDk5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKdmFyIFBvdWNoREIgPSByZXF1aXJlKCIuL2NvbnN0cnVjdG9yIik7CnZhciB1dGlscyA9IHJlcXVpcmUoJy4vdXRpbHMnKTsKdmFyIEVFID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyOwp2YXIgaGFzTG9jYWxTdG9yYWdlID0gcmVxdWlyZSgnLi9kZXBzL2Vudi9oYXNMb2NhbFN0b3JhZ2UnKTsKClBvdWNoREIuYWRhcHRlcnMgPSB7fTsKUG91Y2hEQi5wcmVmZXJyZWRBZGFwdGVycyA9IFtdOwoKUG91Y2hEQi5wcmVmaXggPSAnX3BvdWNoXyc7Cgp2YXIgZXZlbnRFbWl0dGVyID0gbmV3IEVFKCk7CgpmdW5jdGlvbiBzZXRVcEV2ZW50RW1pdHRlcihQb3VjaCkgewogIE9iamVjdC5rZXlzKEVFLnByb3RvdHlwZSkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICBpZiAodHlwZW9mIEVFLnByb3RvdHlwZVtrZXldID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIFBvdWNoW2tleV0gPSBldmVudEVtaXR0ZXJba2V5XS5iaW5kKGV2ZW50RW1pdHRlcik7CiAgICB9CiAgfSk7CgogIC8vIHRoZXNlIGFyZSBjcmVhdGVkIGluIGNvbnN0cnVjdG9yLmpzLCBhbmQgYWxsb3cgdXMgdG8gbm90aWZ5IGVhY2ggREIgd2l0aAogIC8vIHRoZSBzYW1lIG5hbWUgdGhhdCBpdCB3YXMgZGVzdHJveWVkLCB2aWEgdGhlIGNvbnN0cnVjdG9yIG9iamVjdAogIHZhciBkZXN0cnVjdGlvbkxpc3RlbmVycyA9IFBvdWNoLl9kZXN0cnVjdGlvbkxpc3RlbmVycyA9IG5ldyB1dGlscy5NYXAoKTsKICBQb3VjaC5vbignZGVzdHJveWVkJywgZnVuY3Rpb24gb25Db25zdHJ1Y3RvckRlc3Ryb3llZChuYW1lKSB7CiAgICBpZiAoIWRlc3RydWN0aW9uTGlzdGVuZXJzLmhhcyhuYW1lKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBkZXN0cnVjdGlvbkxpc3RlbmVycy5nZXQobmFtZSkuZm9yRWFjaChmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgY2FsbGJhY2soKTsKICAgIH0pOwogICAgZGVzdHJ1Y3Rpb25MaXN0ZW5lcnMuZGVsZXRlKG5hbWUpOwogIH0pOwp9CgpzZXRVcEV2ZW50RW1pdHRlcihQb3VjaERCKTsKClBvdWNoREIucGFyc2VBZGFwdGVyID0gZnVuY3Rpb24gKG5hbWUsIG9wdHMpIHsKICB2YXIgbWF0Y2ggPSBuYW1lLm1hdGNoKC8oW2EtelwtXSopOlwvXC8oLiopLyk7CiAgdmFyIGFkYXB0ZXIsIGFkYXB0ZXJOYW1lOwogIGlmIChtYXRjaCkgewogICAgLy8gdGhlIGh0dHAgYWRhcHRlciBleHBlY3RzIHRoZSBmdWxseSBxdWFsaWZpZWQgbmFtZQogICAgbmFtZSA9IC9odHRwKHM/KS8udGVzdChtYXRjaFsxXSkgPyBtYXRjaFsxXSArICc6Ly8nICsgbWF0Y2hbMl0gOiBtYXRjaFsyXTsKICAgIGFkYXB0ZXIgPSBtYXRjaFsxXTsKICAgIGlmICghUG91Y2hEQi5hZGFwdGVyc1thZGFwdGVyXS52YWxpZCgpKSB7CiAgICAgIHRocm93ICdJbnZhbGlkIGFkYXB0ZXInOwogICAgfQogICAgcmV0dXJuIHtuYW1lOiBuYW1lLCBhZGFwdGVyOiBtYXRjaFsxXX07CiAgfQoKICAvLyBjaGVjayBmb3IgYnJvd3NlcnMgdGhhdCBoYXZlIGJlZW4gdXBncmFkZWQgZnJvbSB3ZWJzcWwtb25seSB0byB3ZWJzcWwraWRiCiAgdmFyIHNraXBJZGIgPSAnaWRiJyBpbiBQb3VjaERCLmFkYXB0ZXJzICYmICd3ZWJzcWwnIGluIFBvdWNoREIuYWRhcHRlcnMgJiYKICAgIGhhc0xvY2FsU3RvcmFnZSgpICYmCiAgICBsb2NhbFN0b3JhZ2VbJ19wb3VjaF9fd2Vic3FsZGJfJyArIFBvdWNoREIucHJlZml4ICsgbmFtZV07CgoKICBpZiAob3B0cy5hZGFwdGVyKSB7CiAgICBhZGFwdGVyTmFtZSA9IG9wdHMuYWRhcHRlcjsKICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRzICE9PSAndW5kZWZpbmVkJyAmJiBvcHRzLmRiKSB7CiAgICBhZGFwdGVyTmFtZSA9ICdsZXZlbGRiJzsKICB9IGVsc2UgeyAvLyBhdXRvbWF0aWNhbGx5IGRldGVybWluZSBhZGFwdGVyCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IFBvdWNoREIucHJlZmVycmVkQWRhcHRlcnMubGVuZ3RoOyArK2kpIHsKICAgICAgYWRhcHRlck5hbWUgPSBQb3VjaERCLnByZWZlcnJlZEFkYXB0ZXJzW2ldOwogICAgICBpZiAoYWRhcHRlck5hbWUgaW4gUG91Y2hEQi5hZGFwdGVycykgewogICAgICAgIGlmIChza2lwSWRiICYmIGFkYXB0ZXJOYW1lID09PSAnaWRiJykgewogICAgICAgICAgLy8gbG9nIGl0LCBiZWNhdXNlIHRoaXMgY2FuIGJlIGNvbmZ1c2luZyBkdXJpbmcgZGV2ZWxvcG1lbnQKICAgICAgICAgIGNvbnNvbGUubG9nKCdQb3VjaERCIGlzIGRvd25ncmFkaW5nICInICsgbmFtZSArICciIHRvIFdlYlNRTCB0bycgKwogICAgICAgICAgICAnIGF2b2lkIGRhdGEgbG9zcywgYmVjYXVzZSBpdCB3YXMgYWxyZWFkeSBvcGVuZWQgd2l0aCBXZWJTUUwuJyk7CiAgICAgICAgICBjb250aW51ZTsgLy8ga2VlcCB1c2luZyB3ZWJzcWwgdG8gYXZvaWQgdXNlciBkYXRhIGxvc3MKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9CgogIGFkYXB0ZXIgPSBQb3VjaERCLmFkYXB0ZXJzW2FkYXB0ZXJOYW1lXTsKCiAgLy8gaWYgYWRhcHRlciBpcyBpbnZhbGlkLCB0aGVuIGFuIGVycm9yIHdpbGwgYmUgdGhyb3duIGxhdGVyCiAgdmFyIHVzZVByZWZpeCA9IChhZGFwdGVyICYmICd1c2VfcHJlZml4JyBpbiBhZGFwdGVyKSA/CiAgICAgIGFkYXB0ZXIudXNlX3ByZWZpeCA6IHRydWU7CgogIHJldHVybiB7CiAgICBuYW1lOiB1c2VQcmVmaXggPyAoUG91Y2hEQi5wcmVmaXggKyBuYW1lKSA6IG5hbWUsCiAgICBhZGFwdGVyOiBhZGFwdGVyTmFtZQogIH07Cn07CgpQb3VjaERCLmFkYXB0ZXIgPSBmdW5jdGlvbiAoaWQsIG9iaiwgYWRkVG9QcmVmZXJyZWRBZGFwdGVycykgewogIGlmIChvYmoudmFsaWQoKSkgewogICAgUG91Y2hEQi5hZGFwdGVyc1tpZF0gPSBvYmo7CiAgICBpZiAoYWRkVG9QcmVmZXJyZWRBZGFwdGVycykgewogICAgICBQb3VjaERCLnByZWZlcnJlZEFkYXB0ZXJzLnB1c2goaWQpOwogICAgfQogIH0KfTsKClBvdWNoREIucGx1Z2luID0gZnVuY3Rpb24gKG9iaikgewogIE9iamVjdC5rZXlzKG9iaikuZm9yRWFjaChmdW5jdGlvbiAoaWQpIHsKICAgIFBvdWNoREIucHJvdG90eXBlW2lkXSA9IG9ialtpZF07CiAgfSk7CgogIHJldHVybiBQb3VjaERCOwp9OwoKUG91Y2hEQi5kZWZhdWx0cyA9IGZ1bmN0aW9uIChkZWZhdWx0T3B0cykgewogIGZ1bmN0aW9uIFBvdWNoQWx0KG5hbWUsIG9wdHMsIGNhbGxiYWNrKSB7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUG91Y2hBbHQpKSB7CiAgICAgIHJldHVybiBuZXcgUG91Y2hBbHQobmFtZSwgb3B0cywgY2FsbGJhY2spOwogICAgfQoKICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJyB8fCB0eXBlb2Ygb3B0cyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgY2FsbGJhY2sgPSBvcHRzOwogICAgICBvcHRzID0ge307CiAgICB9CiAgICBpZiAobmFtZSAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIHsKICAgICAgb3B0cyA9IG5hbWU7CiAgICAgIG5hbWUgPSB1bmRlZmluZWQ7CiAgICB9CgogICAgb3B0cyA9IHV0aWxzLmV4dGVuZCh7fSwgZGVmYXVsdE9wdHMsIG9wdHMpOwogICAgUG91Y2hEQi5jYWxsKHRoaXMsIG5hbWUsIG9wdHMsIGNhbGxiYWNrKTsKICB9CgogIHV0aWxzLmluaGVyaXRzKFBvdWNoQWx0LCBQb3VjaERCKTsKCiAgc2V0VXBFdmVudEVtaXR0ZXIoUG91Y2hBbHQpOwoKICBQb3VjaEFsdC5wcmVmZXJyZWRBZGFwdGVycyA9IFBvdWNoREIucHJlZmVycmVkQWRhcHRlcnMuc2xpY2UoKTsKICBPYmplY3Qua2V5cyhQb3VjaERCKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgIGlmICghKGtleSBpbiBQb3VjaEFsdCkpIHsKICAgICAgUG91Y2hBbHRba2V5XSA9IFBvdWNoREJba2V5XTsKICAgIH0KICB9KTsKCiAgcmV0dXJuIFBvdWNoQWx0Owp9OwoKbW9kdWxlLmV4cG9ydHMgPSBQb3VjaERCOwoKfSx7Ii4vY29uc3RydWN0b3IiOjI5LCIuL2RlcHMvZW52L2hhc0xvY2FsU3RvcmFnZSI6NjIsIi4vdXRpbHMiOjEwMiwiZXZlbnRzIjo3fV0sMTAwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIHV0aWxzID0gcmVxdWlyZSgnLi91dGlscycpOwp2YXIgcmVwbGljYXRpb24gPSByZXF1aXJlKCcuL3JlcGxpY2F0ZScpOwp2YXIgcmVwbGljYXRlID0gcmVwbGljYXRpb24ucmVwbGljYXRlOwp2YXIgRUUgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7Cgp1dGlscy5pbmhlcml0cyhTeW5jLCBFRSk7Cm1vZHVsZS5leHBvcnRzID0gc3luYzsKZnVuY3Rpb24gc3luYyhzcmMsIHRhcmdldCwgb3B0cywgY2FsbGJhY2spIHsKICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgIGNhbGxiYWNrID0gb3B0czsKICAgIG9wdHMgPSB7fTsKICB9CiAgaWYgKHR5cGVvZiBvcHRzID09PSAndW5kZWZpbmVkJykgewogICAgb3B0cyA9IHt9OwogIH0KICBvcHRzID0gdXRpbHMuY2xvbmUob3B0cyk7CiAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICBvcHRzLlBvdWNoQ29uc3RydWN0b3IgPSBvcHRzLlBvdWNoQ29uc3RydWN0b3IgfHwgdGhpczsKICBzcmMgPSByZXBsaWNhdGlvbi50b1BvdWNoKHNyYywgb3B0cyk7CiAgdGFyZ2V0ID0gcmVwbGljYXRpb24udG9Qb3VjaCh0YXJnZXQsIG9wdHMpOwogIHJldHVybiBuZXcgU3luYyhzcmMsIHRhcmdldCwgb3B0cywgY2FsbGJhY2spOwp9CgpmdW5jdGlvbiBTeW5jKHNyYywgdGFyZ2V0LCBvcHRzLCBjYWxsYmFjaykgewogIHZhciBzZWxmID0gdGhpczsKICB0aGlzLmNhbmNlbGVkID0gZmFsc2U7CgogIHZhciBvcHRzUHVzaCA9IG9wdHMucHVzaCA/IHV0aWxzLmV4dGVuZCh7fSwgb3B0cywgb3B0cy5wdXNoKSA6IG9wdHM7CiAgdmFyIG9wdHNQdWxsID0gb3B0cy5wdWxsID8gdXRpbHMuZXh0ZW5kKHt9LCBvcHRzLCBvcHRzLnB1bGwpIDogb3B0czsKCiAgdGhpcy5wdXNoID0gcmVwbGljYXRlKHNyYywgdGFyZ2V0LCBvcHRzUHVzaCk7CiAgdGhpcy5wdWxsID0gcmVwbGljYXRlKHRhcmdldCwgc3JjLCBvcHRzUHVsbCk7CgogIHRoaXMucHVzaFBhdXNlZCA9IHRydWU7CiAgdGhpcy5wdWxsUGF1c2VkID0gdHJ1ZTsKCiAgZnVuY3Rpb24gcHVsbENoYW5nZShjaGFuZ2UpIHsKICAgIHNlbGYuZW1pdCgnY2hhbmdlJywgewogICAgICBkaXJlY3Rpb246ICdwdWxsJywKICAgICAgY2hhbmdlOiBjaGFuZ2UKICAgIH0pOwogIH0KICBmdW5jdGlvbiBwdXNoQ2hhbmdlKGNoYW5nZSkgewogICAgc2VsZi5lbWl0KCdjaGFuZ2UnLCB7CiAgICAgIGRpcmVjdGlvbjogJ3B1c2gnLAogICAgICBjaGFuZ2U6IGNoYW5nZQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIHB1c2hEZW5pZWQoZG9jKSB7CiAgICBzZWxmLmVtaXQoJ2RlbmllZCcsIHsKICAgICAgZGlyZWN0aW9uOiAncHVzaCcsCiAgICAgIGRvYzogZG9jCiAgICB9KTsKICB9CiAgZnVuY3Rpb24gcHVsbERlbmllZChkb2MpIHsKICAgIHNlbGYuZW1pdCgnZGVuaWVkJywgewogICAgICBkaXJlY3Rpb246ICdwdWxsJywKICAgICAgZG9jOiBkb2MKICAgIH0pOwogIH0KICBmdW5jdGlvbiBwdXNoUGF1c2VkKCkgewogICAgc2VsZi5wdXNoUGF1c2VkID0gdHJ1ZTsKICAgIGlmIChzZWxmLnB1bGxQYXVzZWQpIHsKICAgICAgc2VsZi5lbWl0KCdwYXVzZWQnKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gcHVsbFBhdXNlZCgpIHsKICAgIHNlbGYucHVsbFBhdXNlZCA9IHRydWU7CiAgICBpZiAoc2VsZi5wdXNoUGF1c2VkKSB7CiAgICAgIHNlbGYuZW1pdCgncGF1c2VkJyk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHB1c2hBY3RpdmUoKSB7CiAgICBzZWxmLnB1c2hQYXVzZWQgPSBmYWxzZTsKICAgIGlmIChzZWxmLnB1bGxQYXVzZWQpIHsKICAgICAgc2VsZi5lbWl0KCdhY3RpdmUnLCB7CiAgICAgICAgZGlyZWN0aW9uOiAncHVzaCcKICAgICAgfSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHB1bGxBY3RpdmUoKSB7CiAgICBzZWxmLnB1bGxQYXVzZWQgPSBmYWxzZTsKICAgIGlmIChzZWxmLnB1c2hQYXVzZWQpIHsKICAgICAgc2VsZi5lbWl0KCdhY3RpdmUnLCB7CiAgICAgICAgZGlyZWN0aW9uOiAncHVsbCcKICAgICAgfSk7CiAgICB9CiAgfQoKICB2YXIgcmVtb3ZlZCA9IHt9OwoKICBmdW5jdGlvbiByZW1vdmVBbGwodHlwZSkgeyAvLyB0eXBlIGlzICdwdXNoJyBvciAncHVsbCcKICAgIHJldHVybiBmdW5jdGlvbiAoZXZlbnQsIGZ1bmMpIHsKICAgICAgdmFyIGlzQ2hhbmdlID0gZXZlbnQgPT09ICdjaGFuZ2UnICYmCiAgICAgICAgKGZ1bmMgPT09IHB1bGxDaGFuZ2UgfHwgZnVuYyA9PT0gcHVzaENoYW5nZSk7CiAgICAgIHZhciBpc0RlbmllZCA9IGV2ZW50ID09PSAnZGVuaWVkJyAmJgogICAgICAgIChmdW5jID09PSBwdWxsRGVuaWVkIHx8IGZ1bmMgPT09IHB1c2hEZW5pZWQpOwogICAgICB2YXIgaXNQYXVzZWQgPSBldmVudCA9PT0gJ3BhdXNlZCcgJiYKICAgICAgICAoZnVuYyA9PT0gcHVsbFBhdXNlZCB8fCBmdW5jID09PSBwdXNoUGF1c2VkKTsKICAgICAgdmFyIGlzQWN0aXZlID0gZXZlbnQgPT09ICdhY3RpdmUnICYmCiAgICAgICAgKGZ1bmMgPT09IHB1bGxBY3RpdmUgfHwgZnVuYyA9PT0gcHVzaEFjdGl2ZSk7CgogICAgICBpZiAoaXNDaGFuZ2UgfHwgaXNEZW5pZWQgfHwgaXNQYXVzZWQgfHwgaXNBY3RpdmUpIHsKICAgICAgICBpZiAoIShldmVudCBpbiByZW1vdmVkKSkgewogICAgICAgICAgcmVtb3ZlZFtldmVudF0gPSB7fTsKICAgICAgICB9CiAgICAgICAgcmVtb3ZlZFtldmVudF1bdHlwZV0gPSB0cnVlOwogICAgICAgIGlmIChPYmplY3Qua2V5cyhyZW1vdmVkW2V2ZW50XSkubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICAvLyBib3RoIHB1c2ggYW5kIHB1bGwgaGF2ZSBhc2tlZCB0byBiZSByZW1vdmVkCiAgICAgICAgICBzZWxmLnJlbW92ZUFsbExpc3RlbmVycyhldmVudCk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH0KCiAgaWYgKG9wdHMubGl2ZSkgewogICAgdGhpcy5wdXNoLm9uKCdjb21wbGV0ZScsIHNlbGYucHVsbC5jYW5jZWwuYmluZChzZWxmLnB1bGwpKTsKICAgIHRoaXMucHVsbC5vbignY29tcGxldGUnLCBzZWxmLnB1c2guY2FuY2VsLmJpbmQoc2VsZi5wdXNoKSk7CiAgfQoKICB0aGlzLm9uKCduZXdMaXN0ZW5lcicsIGZ1bmN0aW9uIChldmVudCkgewogICAgaWYgKGV2ZW50ID09PSAnY2hhbmdlJykgewogICAgICBzZWxmLnB1bGwub24oJ2NoYW5nZScsIHB1bGxDaGFuZ2UpOwogICAgICBzZWxmLnB1c2gub24oJ2NoYW5nZScsIHB1c2hDaGFuZ2UpOwogICAgfSBlbHNlIGlmIChldmVudCA9PT0gJ2RlbmllZCcpIHsKICAgICAgc2VsZi5wdWxsLm9uKCdkZW5pZWQnLCBwdWxsRGVuaWVkKTsKICAgICAgc2VsZi5wdXNoLm9uKCdkZW5pZWQnLCBwdXNoRGVuaWVkKTsKICAgIH0gZWxzZSBpZiAoZXZlbnQgPT09ICdhY3RpdmUnKSB7CiAgICAgIHNlbGYucHVsbC5vbignYWN0aXZlJywgcHVsbEFjdGl2ZSk7CiAgICAgIHNlbGYucHVzaC5vbignYWN0aXZlJywgcHVzaEFjdGl2ZSk7CiAgICB9IGVsc2UgaWYgKGV2ZW50ID09PSAncGF1c2VkJykgewogICAgICBzZWxmLnB1bGwub24oJ3BhdXNlZCcsIHB1bGxQYXVzZWQpOwogICAgICBzZWxmLnB1c2gub24oJ3BhdXNlZCcsIHB1c2hQYXVzZWQpOwogICAgfQogIH0pOwoKICB0aGlzLm9uKCdyZW1vdmVMaXN0ZW5lcicsIGZ1bmN0aW9uIChldmVudCkgewogICAgaWYgKGV2ZW50ID09PSAnY2hhbmdlJykgewogICAgICBzZWxmLnB1bGwucmVtb3ZlTGlzdGVuZXIoJ2NoYW5nZScsIHB1bGxDaGFuZ2UpOwogICAgICBzZWxmLnB1c2gucmVtb3ZlTGlzdGVuZXIoJ2NoYW5nZScsIHB1c2hDaGFuZ2UpOwogICAgfSBlbHNlIGlmIChldmVudCA9PT0gJ2RlbmllZCcpIHsKICAgICAgc2VsZi5wdWxsLnJlbW92ZUxpc3RlbmVyKCdkZW5pZWQnLCBwdWxsRGVuaWVkKTsKICAgICAgc2VsZi5wdXNoLnJlbW92ZUxpc3RlbmVyKCdkZW5pZWQnLCBwdXNoRGVuaWVkKTsKICAgIH0gZWxzZSBpZiAoZXZlbnQgPT09ICdhY3RpdmUnKSB7CiAgICAgIHNlbGYucHVsbC5yZW1vdmVMaXN0ZW5lcignYWN0aXZlJywgcHVsbEFjdGl2ZSk7CiAgICAgIHNlbGYucHVzaC5yZW1vdmVMaXN0ZW5lcignYWN0aXZlJywgcHVzaEFjdGl2ZSk7CiAgICB9IGVsc2UgaWYgKGV2ZW50ID09PSAncGF1c2VkJykgewogICAgICBzZWxmLnB1bGwucmVtb3ZlTGlzdGVuZXIoJ3BhdXNlZCcsIHB1bGxQYXVzZWQpOwogICAgICBzZWxmLnB1c2gucmVtb3ZlTGlzdGVuZXIoJ3BhdXNlZCcsIHB1c2hQYXVzZWQpOwogICAgfQogIH0pOwoKICB0aGlzLnB1bGwub24oJ3JlbW92ZUxpc3RlbmVyJywgcmVtb3ZlQWxsKCdwdWxsJykpOwogIHRoaXMucHVzaC5vbigncmVtb3ZlTGlzdGVuZXInLCByZW1vdmVBbGwoJ3B1c2gnKSk7CgogIHZhciBwcm9taXNlID0gdXRpbHMuUHJvbWlzZS5hbGwoWwogICAgdGhpcy5wdXNoLAogICAgdGhpcy5wdWxsCiAgXSkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgdmFyIG91dCA9IHsKICAgICAgcHVzaDogcmVzcFswXSwKICAgICAgcHVsbDogcmVzcFsxXQogICAgfTsKICAgIHNlbGYuZW1pdCgnY29tcGxldGUnLCBvdXQpOwogICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgIGNhbGxiYWNrKG51bGwsIG91dCk7CiAgICB9CiAgICBzZWxmLnJlbW92ZUFsbExpc3RlbmVycygpOwogICAgcmV0dXJuIG91dDsKICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICBzZWxmLmNhbmNlbCgpOwogICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgIC8vIGlmIHRoZXJlJ3MgYSBjYWxsYmFjaywgdGhlbiB0aGUgY2FsbGJhY2sgY2FuIHJlY2VpdmUKICAgICAgLy8gdGhlIGVycm9yIGV2ZW50CiAgICAgIGNhbGxiYWNrKGVycik7CiAgICB9IGVsc2UgewogICAgICAvLyBpZiB0aGVyZSdzIG5vIGNhbGxiYWNrLCB0aGVuIHdlJ3JlIHNhZmUgdG8gZW1pdCBhbiBlcnJvcgogICAgICAvLyBldmVudCwgd2hpY2ggd291bGQgb3RoZXJ3aXNlIHRocm93IGFuIHVuaGFuZGxlZCBlcnJvcgogICAgICAvLyBkdWUgdG8gJ2Vycm9yJyBiZWluZyBhIHNwZWNpYWwgZXZlbnQgaW4gRXZlbnRFbWl0dGVycwogICAgICBzZWxmLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgIH0KICAgIHNlbGYucmVtb3ZlQWxsTGlzdGVuZXJzKCk7CiAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgLy8gbm8gc2Vuc2UgdGhyb3dpbmcgaWYgd2UncmUgYWxyZWFkeSBlbWl0dGluZyBhbiAnZXJyb3InIGV2ZW50CiAgICAgIHRocm93IGVycjsKICAgIH0KICB9KTsKCiAgdGhpcy50aGVuID0gZnVuY3Rpb24gKHN1Y2Nlc3MsIGVycikgewogICAgcmV0dXJuIHByb21pc2UudGhlbihzdWNjZXNzLCBlcnIpOwogIH07CgogIHRoaXMuY2F0Y2ggPSBmdW5jdGlvbiAoZXJyKSB7CiAgICByZXR1cm4gcHJvbWlzZS5jYXRjaChlcnIpOwogIH07Cn0KClN5bmMucHJvdG90eXBlLmNhbmNlbCA9IGZ1bmN0aW9uICgpIHsKICBpZiAoIXRoaXMuY2FuY2VsZWQpIHsKICAgIHRoaXMuY2FuY2VsZWQgPSB0cnVlOwogICAgdGhpcy5wdXNoLmNhbmNlbCgpOwogICAgdGhpcy5wdWxsLmNhbmNlbCgpOwogIH0KfTsKCn0seyIuL3JlcGxpY2F0ZSI6OTYsIi4vdXRpbHMiOjEwMiwiZXZlbnRzIjo3fV0sMTAxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSBUYXNrUXVldWU7CgpmdW5jdGlvbiBUYXNrUXVldWUoKSB7CiAgdGhpcy5pc1JlYWR5ID0gZmFsc2U7CiAgdGhpcy5mYWlsZWQgPSBmYWxzZTsKICB0aGlzLnF1ZXVlID0gW107Cn0KClRhc2tRdWV1ZS5wcm90b3R5cGUuZXhlY3V0ZSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgZnVuOwogIGlmICh0aGlzLmZhaWxlZCkgewogICAgd2hpbGUgKChmdW4gPSB0aGlzLnF1ZXVlLnNoaWZ0KCkpKSB7CiAgICAgIGZ1bih0aGlzLmZhaWxlZCk7CiAgICB9CiAgfSBlbHNlIHsKICAgIHdoaWxlICgoZnVuID0gdGhpcy5xdWV1ZS5zaGlmdCgpKSkgewogICAgICBmdW4oKTsKICAgIH0KICB9Cn07CgpUYXNrUXVldWUucHJvdG90eXBlLmZhaWwgPSBmdW5jdGlvbiAoZXJyKSB7CiAgdGhpcy5mYWlsZWQgPSBlcnI7CiAgdGhpcy5leGVjdXRlKCk7Cn07CgpUYXNrUXVldWUucHJvdG90eXBlLnJlYWR5ID0gZnVuY3Rpb24gKGRiKSB7CiAgdGhpcy5pc1JlYWR5ID0gdHJ1ZTsKICB0aGlzLmRiID0gZGI7CiAgdGhpcy5leGVjdXRlKCk7Cn07CgpUYXNrUXVldWUucHJvdG90eXBlLmFkZFRhc2sgPSBmdW5jdGlvbiAoZnVuKSB7CiAgdGhpcy5xdWV1ZS5wdXNoKGZ1bik7CiAgaWYgKHRoaXMuZmFpbGVkKSB7CiAgICB0aGlzLmV4ZWN1dGUoKTsKICB9Cn07Cgp9LHt9XSwxMDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKmpzaGludCBzdHJpY3Q6IGZhbHNlICovCnZhciB0cmF2ZXJzZVJldlRyZWUgPSByZXF1aXJlKCcuL2RlcHMvbWVyZ2UvdHJhdmVyc2VSZXZUcmVlJyk7CmV4cG9ydHMuYWpheCA9IHJlcXVpcmUoJy4vZGVwcy9hamF4L3ByZXF1ZXN0Jyk7CmV4cG9ydHMudXVpZCA9IHJlcXVpcmUoJy4vZGVwcy91dWlkJyk7CmV4cG9ydHMuZ2V0QXJndW1lbnRzID0gcmVxdWlyZSgnYXJnc2FycmF5Jyk7CnZhciBjb2xsZWN0aW9ucyA9IHJlcXVpcmUoJ3BvdWNoZGItY29sbGVjdGlvbnMnKTsKZXhwb3J0cy5NYXAgPSBjb2xsZWN0aW9ucy5NYXA7CmV4cG9ydHMuU2V0ID0gY29sbGVjdGlvbnMuU2V0Owp2YXIgcGFyc2VEb2MgPSByZXF1aXJlKCcuL2RlcHMvZG9jcy9wYXJzZURvYycpOwoKdmFyIFByb21pc2UgPSByZXF1aXJlKCcuL2RlcHMvcHJvbWlzZScpOwpleHBvcnRzLlByb21pc2UgPSBQcm9taXNlOwoKdmFyIGJhc2U2NCA9IHJlcXVpcmUoJy4vZGVwcy9iaW5hcnkvYmFzZTY0Jyk7CnZhciBlcnJvcnMgPSByZXF1aXJlKCcuL2RlcHMvZXJyb3JzJyk7CgovLyBUT0RPOiBkb24ndCBleHBvcnQgdGhlc2UKZXhwb3J0cy5hdG9iID0gYmFzZTY0LmF0b2I7CmV4cG9ydHMuYnRvYSA9IGJhc2U2NC5idG9hOwoKdmFyIGJpblN0cmluZ1RvQmxvYk9yQnVmZmVyID0KICByZXF1aXJlKCcuL2RlcHMvYmluYXJ5L2JpbmFyeVN0cmluZ1RvQmxvYk9yQnVmZmVyJyk7CgovLyBUT0RPOiBvbmx5IHVzZWQgYnkgdGhlIGludGVncmF0aW9uIHRlc3RzCmV4cG9ydHMuYmluYXJ5U3RyaW5nVG9CbG9iT3JCdWZmZXIgPSBiaW5TdHJpbmdUb0Jsb2JPckJ1ZmZlcjsKCmV4cG9ydHMuY2xvbmUgPSByZXF1aXJlKCcuL2RlcHMvY2xvbmUnKTsKZXhwb3J0cy5leHRlbmQgPSByZXF1aXJlKCcuL2RlcHMvZXh0ZW5kJyk7CgpleHBvcnRzLnBpY2sgPSByZXF1aXJlKCcuL2RlcHMvcGljaycpOwpleHBvcnRzLmluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKCmZ1bmN0aW9uIHRyeUZpbHRlcihmaWx0ZXIsIGRvYywgcmVxKSB7CiAgdHJ5IHsKICAgIHJldHVybiAhZmlsdGVyKGRvYywgcmVxKTsKICB9IGNhdGNoIChlcnIpIHsKICAgIHZhciBtc2cgPSAnRmlsdGVyIGZ1bmN0aW9uIHRocmV3OiAnICsgZXJyLnRvU3RyaW5nKCk7CiAgICByZXR1cm4gZXJyb3JzLmVycm9yKGVycm9ycy5CQURfUkVRVUVTVCwgbXNnKTsKICB9Cn0KCmV4cG9ydHMuZmlsdGVyQ2hhbmdlID0gZnVuY3Rpb24gZmlsdGVyQ2hhbmdlKG9wdHMpIHsKICB2YXIgcmVxID0ge307CiAgdmFyIGhhc0ZpbHRlciA9IG9wdHMuZmlsdGVyICYmIHR5cGVvZiBvcHRzLmZpbHRlciA9PT0gJ2Z1bmN0aW9uJzsKICByZXEucXVlcnkgPSBvcHRzLnF1ZXJ5X3BhcmFtczsKCiAgcmV0dXJuIGZ1bmN0aW9uIGZpbHRlcihjaGFuZ2UpIHsKICAgIGlmICghY2hhbmdlLmRvYykgewogICAgICAvLyBDU0cgc2VuZHMgZXZlbnRzIG9uIHRoZSBjaGFuZ2VzIGZlZWQgdGhhdCBkb24ndCBoYXZlIGRvY3VtZW50cywKICAgICAgLy8gdGhpcyBoYWNrIG1ha2VzIGEgd2hvbGUgbG90IG9mIGV4aXN0aW5nIGNvZGUgcm9idXN0LgogICAgICBjaGFuZ2UuZG9jID0ge307CiAgICB9CgogICAgdmFyIGZpbHRlclJldHVybiA9IGhhc0ZpbHRlciAmJiB0cnlGaWx0ZXIob3B0cy5maWx0ZXIsIGNoYW5nZS5kb2MsIHJlcSk7CgogICAgaWYgKHR5cGVvZiBmaWx0ZXJSZXR1cm4gPT09ICdvYmplY3QnKSB7CiAgICAgIHJldHVybiBmaWx0ZXJSZXR1cm47CiAgICB9CgogICAgaWYgKGZpbHRlclJldHVybikgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKCFvcHRzLmluY2x1ZGVfZG9jcykgewogICAgICBkZWxldGUgY2hhbmdlLmRvYzsKICAgIH0gZWxzZSBpZiAoIW9wdHMuYXR0YWNobWVudHMpIHsKICAgICAgZm9yICh2YXIgYXR0IGluIGNoYW5nZS5kb2MuX2F0dGFjaG1lbnRzKSB7CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KICAgICAgICBpZiAoY2hhbmdlLmRvYy5fYXR0YWNobWVudHMuaGFzT3duUHJvcGVydHkoYXR0KSkgewogICAgICAgICAgY2hhbmdlLmRvYy5fYXR0YWNobWVudHNbYXR0XS5zdHViID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwogIH07Cn07CgpleHBvcnRzLnBhcnNlRG9jID0gcGFyc2VEb2MucGFyc2VEb2M7CmV4cG9ydHMuaW52YWxpZElkRXJyb3IgPSBwYXJzZURvYy5pbnZhbGlkSWRFcnJvcjsKCmV4cG9ydHMuaXNDb3Jkb3ZhID0gZnVuY3Rpb24gKCkgewogIHJldHVybiAodHlwZW9mIGNvcmRvdmEgIT09ICJ1bmRlZmluZWQiIHx8CiAgICAgICAgICB0eXBlb2YgUGhvbmVHYXAgIT09ICJ1bmRlZmluZWQiIHx8CiAgICAgICAgICB0eXBlb2YgcGhvbmVnYXAgIT09ICJ1bmRlZmluZWQiKTsKfTsKCmV4cG9ydHMuQ2hhbmdlcyA9IHJlcXVpcmUoJy4vY2hhbmdlc0hhbmRsZXInKTsKCmV4cG9ydHMub25jZSA9IHJlcXVpcmUoJy4vZGVwcy9vbmNlJyk7CgpleHBvcnRzLnRvUHJvbWlzZSA9IHJlcXVpcmUoJy4vZGVwcy90b1Byb21pc2UnKTsKCmV4cG9ydHMuYWRhcHRlckZ1biA9IGZ1bmN0aW9uIChuYW1lLCBjYWxsYmFjaykgewogIHZhciBsb2cgPSByZXF1aXJlKCdkZWJ1ZycpKCdwb3VjaGRiOmFwaScpOwoKICBmdW5jdGlvbiBsb2dBcGlDYWxsKHNlbGYsIG5hbWUsIGFyZ3MpIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGxvZy5lbmFibGVkKSB7CiAgICAgIHZhciBsb2dBcmdzID0gW3NlbGYuX2RiX25hbWUsIG5hbWVdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgbG9nQXJncy5wdXNoKGFyZ3NbaV0pOwogICAgICB9CiAgICAgIGxvZy5hcHBseShudWxsLCBsb2dBcmdzKTsKCiAgICAgIC8vIG92ZXJyaWRlIHRoZSBjYWxsYmFjayBpdHNlbGYgdG8gbG9nIHRoZSByZXNwb25zZQogICAgICB2YXIgb3JpZ0NhbGxiYWNrID0gYXJnc1thcmdzLmxlbmd0aCAtIDFdOwogICAgICBhcmdzW2FyZ3MubGVuZ3RoIC0gMV0gPSBmdW5jdGlvbiAoZXJyLCByZXMpIHsKICAgICAgICB2YXIgcmVzcG9uc2VBcmdzID0gW3NlbGYuX2RiX25hbWUsIG5hbWVdOwogICAgICAgIHJlc3BvbnNlQXJncyA9IHJlc3BvbnNlQXJncy5jb25jYXQoCiAgICAgICAgICBlcnIgPyBbJ2Vycm9yJywgZXJyXSA6IFsnc3VjY2VzcycsIHJlc10KICAgICAgICApOwogICAgICAgIGxvZy5hcHBseShudWxsLCByZXNwb25zZUFyZ3MpOwogICAgICAgIG9yaWdDYWxsYmFjayhlcnIsIHJlcyk7CiAgICAgIH07CiAgICB9CiAgfQoKICByZXR1cm4gZXhwb3J0cy50b1Byb21pc2UoZXhwb3J0cy5nZXRBcmd1bWVudHMoZnVuY3Rpb24gKGFyZ3MpIHsKICAgIGlmICh0aGlzLl9jbG9zZWQpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignZGF0YWJhc2UgaXMgY2xvc2VkJykpOwogICAgfQogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgbG9nQXBpQ2FsbChzZWxmLCBuYW1lLCBhcmdzKTsKICAgIGlmICghdGhpcy50YXNrcXVldWUuaXNSZWFkeSkgewogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKGZ1bGZpbGwsIHJlamVjdCkgewogICAgICAgIHNlbGYudGFza3F1ZXVlLmFkZFRhc2soZnVuY3Rpb24gKGZhaWxlZCkgewogICAgICAgICAgaWYgKGZhaWxlZCkgewogICAgICAgICAgICByZWplY3QoZmFpbGVkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZ1bGZpbGwoc2VsZltuYW1lXS5hcHBseShzZWxmLCBhcmdzKSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpOwogIH0pKTsKfTsKCmV4cG9ydHMuZXhwbGFpbjQwNCA9IHJlcXVpcmUoJy4vZGVwcy9hamF4L2V4cGxhaW40MDQnKTsKCmV4cG9ydHMucGFyc2VVcmkgPSByZXF1aXJlKCcuL2RlcHMvcGFyc2VVcmknKTsKCmV4cG9ydHMuY29tcGFyZSA9IGZ1bmN0aW9uIChsZWZ0LCByaWdodCkgewogIHJldHVybiBsZWZ0IDwgcmlnaHQgPyAtMSA6IGxlZnQgPiByaWdodCA/IDEgOiAwOwp9OwoKCi8vIGNvbXBhY3QgYSB0cmVlIGJ5IG1hcmtpbmcgaXRzIG5vbi1sZWFmcyBhcyBtaXNzaW5nLAovLyBhbmQgcmV0dXJuIGEgbGlzdCBvZiByZXZzIHRvIGRlbGV0ZQpleHBvcnRzLmNvbXBhY3RUcmVlID0gZnVuY3Rpb24gY29tcGFjdFRyZWUobWV0YWRhdGEpIHsKICB2YXIgcmV2cyA9IFtdOwogIHRyYXZlcnNlUmV2VHJlZShtZXRhZGF0YS5yZXZfdHJlZSwgZnVuY3Rpb24gKGlzTGVhZiwgcG9zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldkhhc2gsIGN0eCwgb3B0cykgewogICAgaWYgKG9wdHMuc3RhdHVzID09PSAnYXZhaWxhYmxlJyAmJiAhaXNMZWFmKSB7CiAgICAgIHJldnMucHVzaChwb3MgKyAnLScgKyByZXZIYXNoKTsKICAgICAgb3B0cy5zdGF0dXMgPSAnbWlzc2luZyc7CiAgICB9CiAgfSk7CiAgcmV0dXJuIHJldnM7Cn07Cgp2YXIgdnV2dXplbGEgPSByZXF1aXJlKCd2dXZ1emVsYScpOwoKZXhwb3J0cy5zYWZlSnNvblBhcnNlID0gZnVuY3Rpb24gc2FmZUpzb25QYXJzZShzdHIpIHsKICB0cnkgewogICAgcmV0dXJuIEpTT04ucGFyc2Uoc3RyKTsKICB9IGNhdGNoIChlKSB7CiAgICByZXR1cm4gdnV2dXplbGEucGFyc2Uoc3RyKTsKICB9Cn07CgpleHBvcnRzLnNhZmVKc29uU3RyaW5naWZ5ID0gZnVuY3Rpb24gc2FmZUpzb25TdHJpbmdpZnkoanNvbikgewogIHRyeSB7CiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoanNvbik7CiAgfSBjYXRjaCAoZSkgewogICAgcmV0dXJuIHZ1dnV6ZWxhLnN0cmluZ2lmeShqc29uKTsKICB9Cn07Cgp9LHsiLi9jaGFuZ2VzSGFuZGxlciI6MjgsIi4vZGVwcy9hamF4L2V4cGxhaW40MDQiOjM1LCIuL2RlcHMvYWpheC9wcmVxdWVzdCI6MzgsIi4vZGVwcy9iaW5hcnkvYmFzZTY0Ijo0MSwiLi9kZXBzL2JpbmFyeS9iaW5hcnlTdHJpbmdUb0Jsb2JPckJ1ZmZlciI6NDQsIi4vZGVwcy9jbG9uZSI6NTMsIi4vZGVwcy9kb2NzL3BhcnNlRG9jIjo1OCwiLi9kZXBzL2Vycm9ycyI6NjQsIi4vZGVwcy9leHRlbmQiOjY1LCIuL2RlcHMvbWVyZ2UvdHJhdmVyc2VSZXZUcmVlIjo3MywiLi9kZXBzL29uY2UiOjc1LCIuL2RlcHMvcGFyc2VVcmkiOjc3LCIuL2RlcHMvcGljayI6NzgsIi4vZGVwcy9wcm9taXNlIjo3OSwiLi9kZXBzL3RvUHJvbWlzZSI6ODAsIi4vZGVwcy91dWlkIjo4MiwiYXJnc2FycmF5Ijo2LCJkZWJ1ZyI6OSwiaW5oZXJpdHMiOjEyLCJwb3VjaGRiLWNvbGxlY3Rpb25zIjoxMDgsInZ1dnV6ZWxhIjoxMTB9XSwxMDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9ICI0LjAuNC1wcmVyZWxlYXNlIjsKCn0se31dLDEwNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKdmFyIGltbWVkaWF0ZSA9IHJlcXVpcmUoJ2ltbWVkaWF0ZScpOwoKLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KZnVuY3Rpb24gSU5URVJOQUwoKSB7fQoKdmFyIGhhbmRsZXJzID0ge307Cgp2YXIgUkVKRUNURUQgPSBbJ1JFSkVDVEVEJ107CnZhciBGVUxGSUxMRUQgPSBbJ0ZVTEZJTExFRCddOwp2YXIgUEVORElORyA9IFsnUEVORElORyddOwp2YXIgVU5IQU5ETEVEOwoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gUHJvbWlzZTsKCmZ1bmN0aW9uIFByb21pc2UocmVzb2x2ZXIpIHsKICBpZiAodHlwZW9mIHJlc29sdmVyICE9PSAnZnVuY3Rpb24nKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdyZXNvbHZlciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICB9CiAgdGhpcy5zdGF0ZSA9IFBFTkRJTkc7CiAgdGhpcy5xdWV1ZSA9IFtdOwogIHRoaXMub3V0Y29tZSA9IHZvaWQgMDsKICBpZiAocmVzb2x2ZXIgIT09IElOVEVSTkFMKSB7CiAgICBzYWZlbHlSZXNvbHZlVGhlbmFibGUodGhpcywgcmVzb2x2ZXIpOwogIH0KfQoKUHJvbWlzZS5wcm90b3R5cGVbImNhdGNoIl0gPSBmdW5jdGlvbiAob25SZWplY3RlZCkgewogIHJldHVybiB0aGlzLnRoZW4obnVsbCwgb25SZWplY3RlZCk7Cn07ClByb21pc2UucHJvdG90eXBlLnRoZW4gPSBmdW5jdGlvbiAob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQpIHsKICBpZiAodHlwZW9mIG9uRnVsZmlsbGVkICE9PSAnZnVuY3Rpb24nICYmIHRoaXMuc3RhdGUgPT09IEZVTEZJTExFRCB8fAogICAgdHlwZW9mIG9uUmVqZWN0ZWQgIT09ICdmdW5jdGlvbicgJiYgdGhpcy5zdGF0ZSA9PT0gUkVKRUNURUQpIHsKICAgIHJldHVybiB0aGlzOwogIH0KICB2YXIgcHJvbWlzZSA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKElOVEVSTkFMKTsKICBpZiAodGhpcy5zdGF0ZSAhPT0gUEVORElORykgewogICAgdmFyIHJlc29sdmVyID0gdGhpcy5zdGF0ZSA9PT0gRlVMRklMTEVEID8gb25GdWxmaWxsZWQgOiBvblJlamVjdGVkOwogICAgdW53cmFwKHByb21pc2UsIHJlc29sdmVyLCB0aGlzLm91dGNvbWUpOwogIH0gZWxzZSB7CiAgICB0aGlzLnF1ZXVlLnB1c2gobmV3IFF1ZXVlSXRlbShwcm9taXNlLCBvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCkpOwogIH0KCiAgcmV0dXJuIHByb21pc2U7Cn07CmZ1bmN0aW9uIFF1ZXVlSXRlbShwcm9taXNlLCBvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCkgewogIHRoaXMucHJvbWlzZSA9IHByb21pc2U7CiAgaWYgKHR5cGVvZiBvbkZ1bGZpbGxlZCA9PT0gJ2Z1bmN0aW9uJykgewogICAgdGhpcy5vbkZ1bGZpbGxlZCA9IG9uRnVsZmlsbGVkOwogICAgdGhpcy5jYWxsRnVsZmlsbGVkID0gdGhpcy5vdGhlckNhbGxGdWxmaWxsZWQ7CiAgfQogIGlmICh0eXBlb2Ygb25SZWplY3RlZCA9PT0gJ2Z1bmN0aW9uJykgewogICAgdGhpcy5vblJlamVjdGVkID0gb25SZWplY3RlZDsKICAgIHRoaXMuY2FsbFJlamVjdGVkID0gdGhpcy5vdGhlckNhbGxSZWplY3RlZDsKICB9Cn0KUXVldWVJdGVtLnByb3RvdHlwZS5jYWxsRnVsZmlsbGVkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgaGFuZGxlcnMucmVzb2x2ZSh0aGlzLnByb21pc2UsIHZhbHVlKTsKfTsKUXVldWVJdGVtLnByb3RvdHlwZS5vdGhlckNhbGxGdWxmaWxsZWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICB1bndyYXAodGhpcy5wcm9taXNlLCB0aGlzLm9uRnVsZmlsbGVkLCB2YWx1ZSk7Cn07ClF1ZXVlSXRlbS5wcm90b3R5cGUuY2FsbFJlamVjdGVkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgaGFuZGxlcnMucmVqZWN0KHRoaXMucHJvbWlzZSwgdmFsdWUpOwp9OwpRdWV1ZUl0ZW0ucHJvdG90eXBlLm90aGVyQ2FsbFJlamVjdGVkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgdW53cmFwKHRoaXMucHJvbWlzZSwgdGhpcy5vblJlamVjdGVkLCB2YWx1ZSk7Cn07CgpmdW5jdGlvbiB1bndyYXAocHJvbWlzZSwgZnVuYywgdmFsdWUpIHsKICBpbW1lZGlhdGUoZnVuY3Rpb24gKCkgewogICAgdmFyIHJldHVyblZhbHVlOwogICAgdHJ5IHsKICAgICAgcmV0dXJuVmFsdWUgPSBmdW5jKHZhbHVlKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIGhhbmRsZXJzLnJlamVjdChwcm9taXNlLCBlKTsKICAgIH0KICAgIGlmIChyZXR1cm5WYWx1ZSA9PT0gcHJvbWlzZSkgewogICAgICBoYW5kbGVycy5yZWplY3QocHJvbWlzZSwgbmV3IFR5cGVFcnJvcignQ2Fubm90IHJlc29sdmUgcHJvbWlzZSB3aXRoIGl0c2VsZicpKTsKICAgIH0gZWxzZSB7CiAgICAgIGhhbmRsZXJzLnJlc29sdmUocHJvbWlzZSwgcmV0dXJuVmFsdWUpOwogICAgfQogIH0pOwp9CgpoYW5kbGVycy5yZXNvbHZlID0gZnVuY3Rpb24gKHNlbGYsIHZhbHVlKSB7CiAgdmFyIHJlc3VsdCA9IHRyeUNhdGNoKGdldFRoZW4sIHZhbHVlKTsKICBpZiAocmVzdWx0LnN0YXR1cyA9PT0gJ2Vycm9yJykgewogICAgcmV0dXJuIGhhbmRsZXJzLnJlamVjdChzZWxmLCByZXN1bHQudmFsdWUpOwogIH0KICB2YXIgdGhlbmFibGUgPSByZXN1bHQudmFsdWU7CgogIGlmICh0aGVuYWJsZSkgewogICAgc2FmZWx5UmVzb2x2ZVRoZW5hYmxlKHNlbGYsIHRoZW5hYmxlKTsKICB9IGVsc2UgewogICAgc2VsZi5zdGF0ZSA9IEZVTEZJTExFRDsKICAgIHNlbGYub3V0Y29tZSA9IHZhbHVlOwogICAgdmFyIGkgPSAtMTsKICAgIHZhciBsZW4gPSBzZWxmLnF1ZXVlLmxlbmd0aDsKICAgIHdoaWxlICgrK2kgPCBsZW4pIHsKICAgICAgc2VsZi5xdWV1ZVtpXS5jYWxsRnVsZmlsbGVkKHZhbHVlKTsKICAgIH0KICB9CiAgcmV0dXJuIHNlbGY7Cn07CmhhbmRsZXJzLnJlamVjdCA9IGZ1bmN0aW9uIChzZWxmLCBlcnJvcikgewogIHNlbGYuc3RhdGUgPSBSRUpFQ1RFRDsKICBzZWxmLm91dGNvbWUgPSBlcnJvcjsKICB2YXIgaSA9IC0xOwogIHZhciBsZW4gPSBzZWxmLnF1ZXVlLmxlbmd0aDsKICB3aGlsZSAoKytpIDwgbGVuKSB7CiAgICBzZWxmLnF1ZXVlW2ldLmNhbGxSZWplY3RlZChlcnJvcik7CiAgfQogIHJldHVybiBzZWxmOwp9OwoKZnVuY3Rpb24gZ2V0VGhlbihvYmopIHsKICAvLyBNYWtlIHN1cmUgd2Ugb25seSBhY2Nlc3MgdGhlIGFjY2Vzc29yIG9uY2UgYXMgcmVxdWlyZWQgYnkgdGhlIHNwZWMKICB2YXIgdGhlbiA9IG9iaiAmJiBvYmoudGhlbjsKICBpZiAob2JqICYmIHR5cGVvZiBvYmogPT09ICdvYmplY3QnICYmIHR5cGVvZiB0aGVuID09PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gYXBweVRoZW4oKSB7CiAgICAgIHRoZW4uYXBwbHkob2JqLCBhcmd1bWVudHMpOwogICAgfTsKICB9Cn0KCmZ1bmN0aW9uIHNhZmVseVJlc29sdmVUaGVuYWJsZShzZWxmLCB0aGVuYWJsZSkgewogIC8vIEVpdGhlciBmdWxmaWxsLCByZWplY3Qgb3IgcmVqZWN0IHdpdGggZXJyb3IKICB2YXIgY2FsbGVkID0gZmFsc2U7CiAgZnVuY3Rpb24gb25FcnJvcih2YWx1ZSkgewogICAgaWYgKGNhbGxlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjYWxsZWQgPSB0cnVlOwogICAgaGFuZGxlcnMucmVqZWN0KHNlbGYsIHZhbHVlKTsKICB9CgogIGZ1bmN0aW9uIG9uU3VjY2Vzcyh2YWx1ZSkgewogICAgaWYgKGNhbGxlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjYWxsZWQgPSB0cnVlOwogICAgaGFuZGxlcnMucmVzb2x2ZShzZWxmLCB2YWx1ZSk7CiAgfQoKICBmdW5jdGlvbiB0cnlUb1Vud3JhcCgpIHsKICAgIHRoZW5hYmxlKG9uU3VjY2Vzcywgb25FcnJvcik7CiAgfQoKICB2YXIgcmVzdWx0ID0gdHJ5Q2F0Y2godHJ5VG9VbndyYXApOwogIGlmIChyZXN1bHQuc3RhdHVzID09PSAnZXJyb3InKSB7CiAgICBvbkVycm9yKHJlc3VsdC52YWx1ZSk7CiAgfQp9CgpmdW5jdGlvbiB0cnlDYXRjaChmdW5jLCB2YWx1ZSkgewogIHZhciBvdXQgPSB7fTsKICB0cnkgewogICAgb3V0LnZhbHVlID0gZnVuYyh2YWx1ZSk7CiAgICBvdXQuc3RhdHVzID0gJ3N1Y2Nlc3MnOwogIH0gY2F0Y2ggKGUpIHsKICAgIG91dC5zdGF0dXMgPSAnZXJyb3InOwogICAgb3V0LnZhbHVlID0gZTsKICB9CiAgcmV0dXJuIG91dDsKfQoKZXhwb3J0cy5yZXNvbHZlID0gcmVzb2x2ZTsKZnVuY3Rpb24gcmVzb2x2ZSh2YWx1ZSkgewogIGlmICh2YWx1ZSBpbnN0YW5jZW9mIHRoaXMpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgcmV0dXJuIGhhbmRsZXJzLnJlc29sdmUobmV3IHRoaXMoSU5URVJOQUwpLCB2YWx1ZSk7Cn0KCmV4cG9ydHMucmVqZWN0ID0gcmVqZWN0OwpmdW5jdGlvbiByZWplY3QocmVhc29uKSB7CiAgdmFyIHByb21pc2UgPSBuZXcgdGhpcyhJTlRFUk5BTCk7CiAgcmV0dXJuIGhhbmRsZXJzLnJlamVjdChwcm9taXNlLCByZWFzb24pOwp9CgpleHBvcnRzLmFsbCA9IGFsbDsKZnVuY3Rpb24gYWxsKGl0ZXJhYmxlKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaXRlcmFibGUpICE9PSAnW29iamVjdCBBcnJheV0nKSB7CiAgICByZXR1cm4gdGhpcy5yZWplY3QobmV3IFR5cGVFcnJvcignbXVzdCBiZSBhbiBhcnJheScpKTsKICB9CgogIHZhciBsZW4gPSBpdGVyYWJsZS5sZW5ndGg7CiAgdmFyIGNhbGxlZCA9IGZhbHNlOwogIGlmICghbGVuKSB7CiAgICByZXR1cm4gdGhpcy5yZXNvbHZlKFtdKTsKICB9CgogIHZhciB2YWx1ZXMgPSBuZXcgQXJyYXkobGVuKTsKICB2YXIgcmVzb2x2ZWQgPSAwOwogIHZhciBpID0gLTE7CiAgdmFyIHByb21pc2UgPSBuZXcgdGhpcyhJTlRFUk5BTCk7CgogIHdoaWxlICgrK2kgPCBsZW4pIHsKICAgIGFsbFJlc29sdmVyKGl0ZXJhYmxlW2ldLCBpKTsKICB9CiAgcmV0dXJuIHByb21pc2U7CiAgZnVuY3Rpb24gYWxsUmVzb2x2ZXIodmFsdWUsIGkpIHsKICAgIHNlbGYucmVzb2x2ZSh2YWx1ZSkudGhlbihyZXNvbHZlRnJvbUFsbCwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgIGlmICghY2FsbGVkKSB7CiAgICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgICBoYW5kbGVycy5yZWplY3QocHJvbWlzZSwgZXJyb3IpOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIHJlc29sdmVGcm9tQWxsKG91dFZhbHVlKSB7CiAgICAgIHZhbHVlc1tpXSA9IG91dFZhbHVlOwogICAgICBpZiAoKytyZXNvbHZlZCA9PT0gbGVuICYmICFjYWxsZWQpIHsKICAgICAgICBjYWxsZWQgPSB0cnVlOwogICAgICAgIGhhbmRsZXJzLnJlc29sdmUocHJvbWlzZSwgdmFsdWVzKTsKICAgICAgfQogICAgfQogIH0KfQoKZXhwb3J0cy5yYWNlID0gcmFjZTsKZnVuY3Rpb24gcmFjZShpdGVyYWJsZSkgewogIHZhciBzZWxmID0gdGhpczsKICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGl0ZXJhYmxlKSAhPT0gJ1tvYmplY3QgQXJyYXldJykgewogICAgcmV0dXJuIHRoaXMucmVqZWN0KG5ldyBUeXBlRXJyb3IoJ211c3QgYmUgYW4gYXJyYXknKSk7CiAgfQoKICB2YXIgbGVuID0gaXRlcmFibGUubGVuZ3RoOwogIHZhciBjYWxsZWQgPSBmYWxzZTsKICBpZiAoIWxlbikgewogICAgcmV0dXJuIHRoaXMucmVzb2x2ZShbXSk7CiAgfQoKICB2YXIgaSA9IC0xOwogIHZhciBwcm9taXNlID0gbmV3IHRoaXMoSU5URVJOQUwpOwoKICB3aGlsZSAoKytpIDwgbGVuKSB7CiAgICByZXNvbHZlcihpdGVyYWJsZVtpXSk7CiAgfQogIHJldHVybiBwcm9taXNlOwogIGZ1bmN0aW9uIHJlc29sdmVyKHZhbHVlKSB7CiAgICBzZWxmLnJlc29sdmUodmFsdWUpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGlmICghY2FsbGVkKSB7CiAgICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgICBoYW5kbGVycy5yZXNvbHZlKHByb21pc2UsIHJlc3BvbnNlKTsKICAgICAgfQogICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgIGlmICghY2FsbGVkKSB7CiAgICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgICBoYW5kbGVycy5yZWplY3QocHJvbWlzZSwgZXJyb3IpOwogICAgICB9CiAgICB9KTsKICB9Cn0KCn0seyJpbW1lZGlhdGUiOjEwNX1dLDEwNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAoZ2xvYmFsKXsKJ3VzZSBzdHJpY3QnOwp2YXIgTXV0YXRpb24gPSBnbG9iYWwuTXV0YXRpb25PYnNlcnZlciB8fCBnbG9iYWwuV2ViS2l0TXV0YXRpb25PYnNlcnZlcjsKCnZhciBzY2hlZHVsZURyYWluOwoKewogIGlmIChNdXRhdGlvbikgewogICAgdmFyIGNhbGxlZCA9IDA7CiAgICB2YXIgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb24obmV4dFRpY2spOwogICAgdmFyIGVsZW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJycpOwogICAgb2JzZXJ2ZXIub2JzZXJ2ZShlbGVtZW50LCB7CiAgICAgIGNoYXJhY3RlckRhdGE6IHRydWUKICAgIH0pOwogICAgc2NoZWR1bGVEcmFpbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgZWxlbWVudC5kYXRhID0gKGNhbGxlZCA9ICsrY2FsbGVkICUgMik7CiAgICB9OwogIH0gZWxzZSBpZiAoIWdsb2JhbC5zZXRJbW1lZGlhdGUgJiYgdHlwZW9mIGdsb2JhbC5NZXNzYWdlQ2hhbm5lbCAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBjaGFubmVsID0gbmV3IGdsb2JhbC5NZXNzYWdlQ2hhbm5lbCgpOwogICAgY2hhbm5lbC5wb3J0MS5vbm1lc3NhZ2UgPSBuZXh0VGljazsKICAgIHNjaGVkdWxlRHJhaW4gPSBmdW5jdGlvbiAoKSB7CiAgICAgIGNoYW5uZWwucG9ydDIucG9zdE1lc3NhZ2UoMCk7CiAgICB9OwogIH0gZWxzZSBpZiAoJ2RvY3VtZW50JyBpbiBnbG9iYWwgJiYgJ29ucmVhZHlzdGF0ZWNoYW5nZScgaW4gZ2xvYmFsLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpKSB7CiAgICBzY2hlZHVsZURyYWluID0gZnVuY3Rpb24gKCkgewoKICAgICAgLy8gQ3JlYXRlIGEgPHNjcmlwdD4gZWxlbWVudDsgaXRzIHJlYWR5c3RhdGVjaGFuZ2UgZXZlbnQgd2lsbCBiZSBmaXJlZCBhc3luY2hyb25vdXNseSBvbmNlIGl0IGlzIGluc2VydGVkCiAgICAgIC8vIGludG8gdGhlIGRvY3VtZW50LiBEbyBzbywgdGh1cyBxdWV1aW5nIHVwIHRoZSB0YXNrLiBSZW1lbWJlciB0byBjbGVhbiB1cCBvbmNlIGl0J3MgYmVlbiBjYWxsZWQuCiAgICAgIHZhciBzY3JpcHRFbCA9IGdsb2JhbC5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKICAgICAgc2NyaXB0RWwub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgICAgIG5leHRUaWNrKCk7CgogICAgICAgIHNjcmlwdEVsLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7CiAgICAgICAgc2NyaXB0RWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHRFbCk7CiAgICAgICAgc2NyaXB0RWwgPSBudWxsOwogICAgICB9OwogICAgICBnbG9iYWwuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKHNjcmlwdEVsKTsKICAgIH07CiAgfSBlbHNlIHsKICAgIHNjaGVkdWxlRHJhaW4gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHNldFRpbWVvdXQobmV4dFRpY2ssIDApOwogICAgfTsKICB9Cn0KCnZhciBkcmFpbmluZzsKdmFyIHF1ZXVlID0gW107Ci8vbmFtZWQgbmV4dFRpY2sgZm9yIGxlc3MgY29uZnVzaW5nIHN0YWNrIHRyYWNlcwpmdW5jdGlvbiBuZXh0VGljaygpIHsKICBkcmFpbmluZyA9IHRydWU7CiAgdmFyIGksIG9sZFF1ZXVlOwogIHZhciBsZW4gPSBxdWV1ZS5sZW5ndGg7CiAgd2hpbGUgKGxlbikgewogICAgb2xkUXVldWUgPSBxdWV1ZTsKICAgIHF1ZXVlID0gW107CiAgICBpID0gLTE7CiAgICB3aGlsZSAoKytpIDwgbGVuKSB7CiAgICAgIG9sZFF1ZXVlW2ldKCk7CiAgICB9CiAgICBsZW4gPSBxdWV1ZS5sZW5ndGg7CiAgfQogIGRyYWluaW5nID0gZmFsc2U7Cn0KCm1vZHVsZS5leHBvcnRzID0gaW1tZWRpYXRlOwpmdW5jdGlvbiBpbW1lZGlhdGUodGFzaykgewogIGlmIChxdWV1ZS5wdXNoKHRhc2spID09PSAxICYmICFkcmFpbmluZykgewogICAgc2NoZWR1bGVEcmFpbigpOwogIH0KfQoKfSkuY2FsbCh0aGlzLHR5cGVvZiBnbG9iYWwgIT09ICJ1bmRlZmluZWQiID8gZ2xvYmFsIDogdHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDoge30pCn0se31dLDEwNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBNSU5fTUFHTklUVURFID0gLTMyNDsgLy8gdmVyaWZpZWQgYnkgLU51bWJlci5NSU5fVkFMVUUKdmFyIE1BR05JVFVERV9ESUdJVFMgPSAzOyAvLyBkaXR0bwp2YXIgU0VQID0gJyc7IC8vIHNldCB0byAnXycgZm9yIGVhc2llciBkZWJ1Z2dpbmcgCgp2YXIgdXRpbHMgPSByZXF1aXJlKCcuL3V0aWxzJyk7CgpleHBvcnRzLmNvbGxhdGUgPSBmdW5jdGlvbiAoYSwgYikgewoKICBpZiAoYSA9PT0gYikgewogICAgcmV0dXJuIDA7CiAgfQoKICBhID0gZXhwb3J0cy5ub3JtYWxpemVLZXkoYSk7CiAgYiA9IGV4cG9ydHMubm9ybWFsaXplS2V5KGIpOwoKICB2YXIgYWkgPSBjb2xsYXRpb25JbmRleChhKTsKICB2YXIgYmkgPSBjb2xsYXRpb25JbmRleChiKTsKICBpZiAoKGFpIC0gYmkpICE9PSAwKSB7CiAgICByZXR1cm4gYWkgLSBiaTsKICB9CiAgaWYgKGEgPT09IG51bGwpIHsKICAgIHJldHVybiAwOwogIH0KICBzd2l0Y2ggKHR5cGVvZiBhKSB7CiAgICBjYXNlICdudW1iZXInOgogICAgICByZXR1cm4gYSAtIGI7CiAgICBjYXNlICdib29sZWFuJzoKICAgICAgcmV0dXJuIGEgPT09IGIgPyAwIDogKGEgPCBiID8gLTEgOiAxKTsKICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgIHJldHVybiBzdHJpbmdDb2xsYXRlKGEsIGIpOwogIH0KICByZXR1cm4gQXJyYXkuaXNBcnJheShhKSA/IGFycmF5Q29sbGF0ZShhLCBiKSA6IG9iamVjdENvbGxhdGUoYSwgYik7Cn07CgovLyBjb3VjaCBjb25zaWRlcnMgbnVsbC9OYU4vSW5maW5pdHkvLUluZmluaXR5ID09PSB1bmRlZmluZWQsCi8vIGZvciB0aGUgcHVycG9zZXMgb2YgbWFwcmVkdWNlIGluZGV4ZXMuIGFsc28sIGRhdGVzIGdldCBzdHJpbmdpZmllZC4KZXhwb3J0cy5ub3JtYWxpemVLZXkgPSBmdW5jdGlvbiAoa2V5KSB7CiAgc3dpdGNoICh0eXBlb2Yga2V5KSB7CiAgICBjYXNlICd1bmRlZmluZWQnOgogICAgICByZXR1cm4gbnVsbDsKICAgIGNhc2UgJ251bWJlcic6CiAgICAgIGlmIChrZXkgPT09IEluZmluaXR5IHx8IGtleSA9PT0gLUluZmluaXR5IHx8IGlzTmFOKGtleSkpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICByZXR1cm4ga2V5OwogICAgY2FzZSAnb2JqZWN0JzoKICAgICAgdmFyIG9yaWdLZXkgPSBrZXk7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGtleSkpIHsKICAgICAgICB2YXIgbGVuID0ga2V5Lmxlbmd0aDsKICAgICAgICBrZXkgPSBuZXcgQXJyYXkobGVuKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBrZXlbaV0gPSBleHBvcnRzLm5vcm1hbGl6ZUtleShvcmlnS2V5W2ldKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoa2V5IGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgIHJldHVybiBrZXkudG9KU09OKCk7CiAgICAgIH0gZWxzZSBpZiAoa2V5ICE9PSBudWxsKSB7IC8vIGdlbmVyaWMgb2JqZWN0CiAgICAgICAga2V5ID0ge307CiAgICAgICAgZm9yICh2YXIgayBpbiBvcmlnS2V5KSB7CiAgICAgICAgICBpZiAob3JpZ0tleS5oYXNPd25Qcm9wZXJ0eShrKSkgewogICAgICAgICAgICB2YXIgdmFsID0gb3JpZ0tleVtrXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWwgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAga2V5W2tdID0gZXhwb3J0cy5ub3JtYWxpemVLZXkodmFsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogIH0KICByZXR1cm4ga2V5Owp9OwoKZnVuY3Rpb24gaW5kZXhpZnkoa2V5KSB7CiAgaWYgKGtleSAhPT0gbnVsbCkgewogICAgc3dpdGNoICh0eXBlb2Yga2V5KSB7CiAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgIHJldHVybiBrZXkgPyAxIDogMDsKICAgICAgY2FzZSAnbnVtYmVyJzoKICAgICAgICByZXR1cm4gbnVtVG9JbmRleGFibGVTdHJpbmcoa2V5KTsKICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAvLyBXZSd2ZSB0byBiZSBzdXJlIHRoYXQga2V5IGRvZXMgbm90IGNvbnRhaW4gXHUwMDAwCiAgICAgICAgLy8gRG8gb3JkZXItcHJlc2VydmluZyByZXBsYWNlbWVudHM6CiAgICAgICAgLy8gMCAtPiAxLCAxCiAgICAgICAgLy8gMSAtPiAxLCAyCiAgICAgICAgLy8gMiAtPiAyLCAyCiAgICAgICAgcmV0dXJuIGtleQogICAgICAgICAgLnJlcGxhY2UoL1x1MDAwMi9nLCAnXHUwMDAyXHUwMDAyJykKICAgICAgICAgIC5yZXBsYWNlKC9cdTAwMDEvZywgJ1x1MDAwMVx1MDAwMicpCiAgICAgICAgICAucmVwbGFjZSgvXHUwMDAwL2csICdcdTAwMDFcdTAwMDEnKTsKICAgICAgY2FzZSAnb2JqZWN0JzoKICAgICAgICB2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkoa2V5KTsKICAgICAgICB2YXIgYXJyID0gaXNBcnJheSA/IGtleSA6IE9iamVjdC5rZXlzKGtleSk7CiAgICAgICAgdmFyIGkgPSAtMTsKICAgICAgICB2YXIgbGVuID0gYXJyLmxlbmd0aDsKICAgICAgICB2YXIgcmVzdWx0ID0gJyc7CiAgICAgICAgaWYgKGlzQXJyYXkpIHsKICAgICAgICAgIHdoaWxlICgrK2kgPCBsZW4pIHsKICAgICAgICAgICAgcmVzdWx0ICs9IGV4cG9ydHMudG9JbmRleGFibGVTdHJpbmcoYXJyW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgd2hpbGUgKCsraSA8IGxlbikgewogICAgICAgICAgICB2YXIgb2JqS2V5ID0gYXJyW2ldOwogICAgICAgICAgICByZXN1bHQgKz0gZXhwb3J0cy50b0luZGV4YWJsZVN0cmluZyhvYmpLZXkpICsKICAgICAgICAgICAgICAgIGV4cG9ydHMudG9JbmRleGFibGVTdHJpbmcoa2V5W29iaktleV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIH0KICByZXR1cm4gJyc7Cn0KCi8vIGNvbnZlcnQgdGhlIGdpdmVuIGtleSB0byBhIHN0cmluZyB0aGF0IHdvdWxkIGJlIGFwcHJvcHJpYXRlCi8vIGZvciBsZXhpY2FsIHNvcnRpbmcsIGUuZy4gd2l0aGluIGEgZGF0YWJhc2UsIHdoZXJlIHRoZQovLyBzb3J0aW5nIGlzIHRoZSBzYW1lIGdpdmVuIGJ5IHRoZSBjb2xsYXRlKCkgZnVuY3Rpb24uCmV4cG9ydHMudG9JbmRleGFibGVTdHJpbmcgPSBmdW5jdGlvbiAoa2V5KSB7CiAgdmFyIHplcm8gPSAnXHUwMDAwJzsKICBrZXkgPSBleHBvcnRzLm5vcm1hbGl6ZUtleShrZXkpOwogIHJldHVybiBjb2xsYXRpb25JbmRleChrZXkpICsgU0VQICsgaW5kZXhpZnkoa2V5KSArIHplcm87Cn07CgpmdW5jdGlvbiBwYXJzZU51bWJlcihzdHIsIGkpIHsKICB2YXIgb3JpZ2luYWxJZHggPSBpOwogIHZhciBudW07CiAgdmFyIHplcm8gPSBzdHJbaV0gPT09ICcxJzsKICBpZiAoemVybykgewogICAgbnVtID0gMDsKICAgIGkrKzsKICB9IGVsc2UgewogICAgdmFyIG5lZyA9IHN0cltpXSA9PT0gJzAnOwogICAgaSsrOwogICAgdmFyIG51bUFzU3RyaW5nID0gJyc7CiAgICB2YXIgbWFnQXNTdHJpbmcgPSBzdHIuc3Vic3RyaW5nKGksIGkgKyBNQUdOSVRVREVfRElHSVRTKTsKICAgIHZhciBtYWduaXR1ZGUgPSBwYXJzZUludChtYWdBc1N0cmluZywgMTApICsgTUlOX01BR05JVFVERTsKICAgIGlmIChuZWcpIHsKICAgICAgbWFnbml0dWRlID0gLW1hZ25pdHVkZTsKICAgIH0KICAgIGkgKz0gTUFHTklUVURFX0RJR0lUUzsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIHZhciBjaCA9IHN0cltpXTsKICAgICAgaWYgKGNoID09PSAnXHUwMDAwJykgewogICAgICAgIGJyZWFrOwogICAgICB9IGVsc2UgewogICAgICAgIG51bUFzU3RyaW5nICs9IGNoOwogICAgICB9CiAgICAgIGkrKzsKICAgIH0KICAgIG51bUFzU3RyaW5nID0gbnVtQXNTdHJpbmcuc3BsaXQoJy4nKTsKICAgIGlmIChudW1Bc1N0cmluZy5sZW5ndGggPT09IDEpIHsKICAgICAgbnVtID0gcGFyc2VJbnQobnVtQXNTdHJpbmcsIDEwKTsKICAgIH0gZWxzZSB7CiAgICAgIG51bSA9IHBhcnNlRmxvYXQobnVtQXNTdHJpbmdbMF0gKyAnLicgKyBudW1Bc1N0cmluZ1sxXSk7CiAgICB9CiAgICBpZiAobmVnKSB7CiAgICAgIG51bSA9IG51bSAtIDEwOwogICAgfQogICAgaWYgKG1hZ25pdHVkZSAhPT0gMCkgewogICAgICAvLyBwYXJzZUZsb2F0IGlzIG1vcmUgcmVsaWFibGUgdGhhbiBwb3cgZHVlIHRvIHJvdW5kaW5nIGVycm9ycwogICAgICAvLyBlLmcuIE51bWJlci5NQVhfVkFMVUUgd291bGQgcmV0dXJuIEluZmluaXR5IGlmIHdlIGRpZAogICAgICAvLyBudW0gKiBNYXRoLnBvdygxMCwgbWFnbml0dWRlKTsKICAgICAgbnVtID0gcGFyc2VGbG9hdChudW0gKyAnZScgKyBtYWduaXR1ZGUpOwogICAgfQogIH0KICByZXR1cm4ge251bTogbnVtLCBsZW5ndGggOiBpIC0gb3JpZ2luYWxJZHh9Owp9CgovLyBtb3ZlIHVwIHRoZSBzdGFjayB3aGlsZSBwYXJzaW5nCi8vIHRoaXMgZnVuY3Rpb24gbW92ZWQgb3V0c2lkZSBvZiBwYXJzZUluZGV4YWJsZVN0cmluZyBmb3IgcGVyZm9ybWFuY2UKZnVuY3Rpb24gcG9wKHN0YWNrLCBtZXRhU3RhY2spIHsKICB2YXIgb2JqID0gc3RhY2sucG9wKCk7CgogIGlmIChtZXRhU3RhY2subGVuZ3RoKSB7CiAgICB2YXIgbGFzdE1ldGFFbGVtZW50ID0gbWV0YVN0YWNrW21ldGFTdGFjay5sZW5ndGggLSAxXTsKICAgIGlmIChvYmogPT09IGxhc3RNZXRhRWxlbWVudC5lbGVtZW50KSB7CiAgICAgIC8vIHBvcHBpbmcgYSBtZXRhLWVsZW1lbnQsIGUuZy4gYW4gb2JqZWN0IHdob3NlIHZhbHVlIGlzIGFub3RoZXIgb2JqZWN0CiAgICAgIG1ldGFTdGFjay5wb3AoKTsKICAgICAgbGFzdE1ldGFFbGVtZW50ID0gbWV0YVN0YWNrW21ldGFTdGFjay5sZW5ndGggLSAxXTsKICAgIH0KICAgIHZhciBlbGVtZW50ID0gbGFzdE1ldGFFbGVtZW50LmVsZW1lbnQ7CiAgICB2YXIgbGFzdEVsZW1lbnRJbmRleCA9IGxhc3RNZXRhRWxlbWVudC5pbmRleDsKICAgIGlmIChBcnJheS5pc0FycmF5KGVsZW1lbnQpKSB7CiAgICAgIGVsZW1lbnQucHVzaChvYmopOwogICAgfSBlbHNlIGlmIChsYXN0RWxlbWVudEluZGV4ID09PSBzdGFjay5sZW5ndGggLSAyKSB7IC8vIG9iaiB3aXRoIGtleSt2YWx1ZQogICAgICB2YXIga2V5ID0gc3RhY2sucG9wKCk7CiAgICAgIGVsZW1lbnRba2V5XSA9IG9iajsKICAgIH0gZWxzZSB7CiAgICAgIHN0YWNrLnB1c2gob2JqKTsgLy8gb2JqIHdpdGgga2V5IG9ubHkKICAgIH0KICB9Cn0KCmV4cG9ydHMucGFyc2VJbmRleGFibGVTdHJpbmcgPSBmdW5jdGlvbiAoc3RyKSB7CiAgdmFyIHN0YWNrID0gW107CiAgdmFyIG1ldGFTdGFjayA9IFtdOyAvLyBzdGFjayBmb3IgYXJyYXlzIGFuZCBvYmplY3RzCiAgdmFyIGkgPSAwOwoKICB3aGlsZSAodHJ1ZSkgewogICAgdmFyIGNvbGxhdGlvbkluZGV4ID0gc3RyW2krK107CiAgICBpZiAoY29sbGF0aW9uSW5kZXggPT09ICdcdTAwMDAnKSB7CiAgICAgIGlmIChzdGFjay5sZW5ndGggPT09IDEpIHsKICAgICAgICByZXR1cm4gc3RhY2sucG9wKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcG9wKHN0YWNrLCBtZXRhU3RhY2spOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICB9CiAgICBzd2l0Y2ggKGNvbGxhdGlvbkluZGV4KSB7CiAgICAgIGNhc2UgJzEnOgogICAgICAgIHN0YWNrLnB1c2gobnVsbCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJzInOgogICAgICAgIHN0YWNrLnB1c2goc3RyW2ldID09PSAnMScpOwogICAgICAgIGkrKzsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnMyc6CiAgICAgICAgdmFyIHBhcnNlZE51bSA9IHBhcnNlTnVtYmVyKHN0ciwgaSk7CiAgICAgICAgc3RhY2sucHVzaChwYXJzZWROdW0ubnVtKTsKICAgICAgICBpICs9IHBhcnNlZE51bS5sZW5ndGg7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJzQnOgogICAgICAgIHZhciBwYXJzZWRTdHIgPSAnJzsKICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgdmFyIGNoID0gc3RyW2ldOwogICAgICAgICAgaWYgKGNoID09PSAnXHUwMDAwJykgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHBhcnNlZFN0ciArPSBjaDsKICAgICAgICAgIGkrKzsKICAgICAgICB9CiAgICAgICAgLy8gcGVyZm9ybSB0aGUgcmV2ZXJzZSBvZiB0aGUgb3JkZXItcHJlc2VydmluZyByZXBsYWNlbWVudAogICAgICAgIC8vIGFsZ29yaXRobSAoc2VlIGFib3ZlKQogICAgICAgIHBhcnNlZFN0ciA9IHBhcnNlZFN0ci5yZXBsYWNlKC9cdTAwMDFcdTAwMDEvZywgJ1x1MDAwMCcpCiAgICAgICAgICAucmVwbGFjZSgvXHUwMDAxXHUwMDAyL2csICdcdTAwMDEnKQogICAgICAgICAgLnJlcGxhY2UoL1x1MDAwMlx1MDAwMi9nLCAnXHUwMDAyJyk7CiAgICAgICAgc3RhY2sucHVzaChwYXJzZWRTdHIpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICc1JzoKICAgICAgICB2YXIgYXJyYXlFbGVtZW50ID0geyBlbGVtZW50OiBbXSwgaW5kZXg6IHN0YWNrLmxlbmd0aCB9OwogICAgICAgIHN0YWNrLnB1c2goYXJyYXlFbGVtZW50LmVsZW1lbnQpOwogICAgICAgIG1ldGFTdGFjay5wdXNoKGFycmF5RWxlbWVudCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJzYnOgogICAgICAgIHZhciBvYmpFbGVtZW50ID0geyBlbGVtZW50OiB7fSwgaW5kZXg6IHN0YWNrLmxlbmd0aCB9OwogICAgICAgIHN0YWNrLnB1c2gob2JqRWxlbWVudC5lbGVtZW50KTsKICAgICAgICBtZXRhU3RhY2sucHVzaChvYmpFbGVtZW50KTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAnYmFkIGNvbGxhdGlvbkluZGV4IG9yIHVuZXhwZWN0ZWRseSByZWFjaGVkIGVuZCBvZiBpbnB1dDogJyArIGNvbGxhdGlvbkluZGV4KTsKICAgIH0KICB9Cn07CgpmdW5jdGlvbiBhcnJheUNvbGxhdGUoYSwgYikgewogIHZhciBsZW4gPSBNYXRoLm1pbihhLmxlbmd0aCwgYi5sZW5ndGgpOwogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgIHZhciBzb3J0ID0gZXhwb3J0cy5jb2xsYXRlKGFbaV0sIGJbaV0pOwogICAgaWYgKHNvcnQgIT09IDApIHsKICAgICAgcmV0dXJuIHNvcnQ7CiAgICB9CiAgfQogIHJldHVybiAoYS5sZW5ndGggPT09IGIubGVuZ3RoKSA/IDAgOgogICAgKGEubGVuZ3RoID4gYi5sZW5ndGgpID8gMSA6IC0xOwp9CmZ1bmN0aW9uIHN0cmluZ0NvbGxhdGUoYSwgYikgewogIC8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2RhbGVoYXJ2ZXkvcG91Y2hkYi9pc3N1ZXMvNDAKICAvLyBUaGlzIGlzIGluY29tcGF0aWJsZSB3aXRoIHRoZSBDb3VjaERCIGltcGxlbWVudGF0aW9uLCBidXQgaXRzIHRoZQogIC8vIGJlc3Qgd2UgY2FuIGRvIGZvciBub3cKICByZXR1cm4gKGEgPT09IGIpID8gMCA6ICgoYSA+IGIpID8gMSA6IC0xKTsKfQpmdW5jdGlvbiBvYmplY3RDb2xsYXRlKGEsIGIpIHsKICB2YXIgYWsgPSBPYmplY3Qua2V5cyhhKSwgYmsgPSBPYmplY3Qua2V5cyhiKTsKICB2YXIgbGVuID0gTWF0aC5taW4oYWsubGVuZ3RoLCBiay5sZW5ndGgpOwogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgIC8vIEZpcnN0IHNvcnQgdGhlIGtleXMKICAgIHZhciBzb3J0ID0gZXhwb3J0cy5jb2xsYXRlKGFrW2ldLCBia1tpXSk7CiAgICBpZiAoc29ydCAhPT0gMCkgewogICAgICByZXR1cm4gc29ydDsKICAgIH0KICAgIC8vIGlmIHRoZSBrZXlzIGFyZSBlcXVhbCBzb3J0IHRoZSB2YWx1ZXMKICAgIHNvcnQgPSBleHBvcnRzLmNvbGxhdGUoYVtha1tpXV0sIGJbYmtbaV1dKTsKICAgIGlmIChzb3J0ICE9PSAwKSB7CiAgICAgIHJldHVybiBzb3J0OwogICAgfQoKICB9CiAgcmV0dXJuIChhay5sZW5ndGggPT09IGJrLmxlbmd0aCkgPyAwIDoKICAgIChhay5sZW5ndGggPiBiay5sZW5ndGgpID8gMSA6IC0xOwp9Ci8vIFRoZSBjb2xsYXRpb24gaXMgZGVmaW5lZCBieSBlcmxhbmdzIG9yZGVyZWQgdGVybXMKLy8gdGhlIGF0b21zIG51bGwsIHRydWUsIGZhbHNlIGNvbWUgZmlyc3QsIHRoZW4gbnVtYmVycywgc3RyaW5ncywKLy8gYXJyYXlzLCB0aGVuIG9iamVjdHMKLy8gbnVsbC91bmRlZmluZWQvTmFOL0luZmluaXR5Ly1JbmZpbml0eSBhcmUgYWxsIGNvbnNpZGVyZWQgbnVsbApmdW5jdGlvbiBjb2xsYXRpb25JbmRleCh4KSB7CiAgdmFyIGlkID0gWydib29sZWFuJywgJ251bWJlcicsICdzdHJpbmcnLCAnb2JqZWN0J107CiAgdmFyIGlkeCA9IGlkLmluZGV4T2YodHlwZW9mIHgpOwogIC8vZmFsc2UgaWYgLTEgb3RoZXJ3aXNlIHRydWUsIGJ1dCBmYXN0ISEhITEKICBpZiAofmlkeCkgewogICAgaWYgKHggPT09IG51bGwpIHsKICAgICAgcmV0dXJuIDE7CiAgICB9CiAgICBpZiAoQXJyYXkuaXNBcnJheSh4KSkgewogICAgICByZXR1cm4gNTsKICAgIH0KICAgIHJldHVybiBpZHggPCAzID8gKGlkeCArIDIpIDogKGlkeCArIDMpOwogIH0KICBpZiAoQXJyYXkuaXNBcnJheSh4KSkgewogICAgcmV0dXJuIDU7CiAgfQp9CgovLyBjb252ZXJzaW9uOgovLyB4IHl5eSB6ei4uLnp6Ci8vIHggPSAwIGZvciBuZWdhdGl2ZSwgMSBmb3IgMCwgMiBmb3IgcG9zaXRpdmUKLy8geSA9IGV4cG9uZW50IChmb3IgbmVnYXRpdmUgbnVtYmVycyBuZWdhdGVkKSBtb3ZlZCBzbyB0aGF0IGl0J3MgPj0gMAovLyB6ID0gbWFudGlzc2UKZnVuY3Rpb24gbnVtVG9JbmRleGFibGVTdHJpbmcobnVtKSB7CgogIGlmIChudW0gPT09IDApIHsKICAgIHJldHVybiAnMSc7CiAgfQoKICAvLyBjb252ZXJ0IG51bWJlciB0byBleHBvbmVudGlhbCBmb3JtYXQgZm9yIGVhc2llciBhbmQKICAvLyBtb3JlIHN1Y2NpbmN0IHN0cmluZyBzb3J0aW5nCiAgdmFyIGV4cEZvcm1hdCA9IG51bS50b0V4cG9uZW50aWFsKCkuc3BsaXQoL2VcKz8vKTsKICB2YXIgbWFnbml0dWRlID0gcGFyc2VJbnQoZXhwRm9ybWF0WzFdLCAxMCk7CgogIHZhciBuZWcgPSBudW0gPCAwOwoKICB2YXIgcmVzdWx0ID0gbmVnID8gJzAnIDogJzInOwoKICAvLyBmaXJzdCBzb3J0IGJ5IG1hZ25pdHVkZQogIC8vIGl0J3MgZWFzaWVyIGlmIGFsbCBtYWduaXR1ZGVzIGFyZSBwb3NpdGl2ZQogIHZhciBtYWdGb3JDb21wYXJpc29uID0gKChuZWcgPyAtbWFnbml0dWRlIDogbWFnbml0dWRlKSAtIE1JTl9NQUdOSVRVREUpOwogIHZhciBtYWdTdHJpbmcgPSB1dGlscy5wYWRMZWZ0KChtYWdGb3JDb21wYXJpc29uKS50b1N0cmluZygpLCAnMCcsIE1BR05JVFVERV9ESUdJVFMpOwoKICByZXN1bHQgKz0gU0VQICsgbWFnU3RyaW5nOwoKICAvLyB0aGVuIHNvcnQgYnkgdGhlIGZhY3RvcgogIHZhciBmYWN0b3IgPSBNYXRoLmFicyhwYXJzZUZsb2F0KGV4cEZvcm1hdFswXSkpOyAvLyBbMS4uMTApCiAgaWYgKG5lZykgeyAvLyBmb3IgbmVnYXRpdmUgcmV2ZXJzZSBvcmRlcmluZwogICAgZmFjdG9yID0gMTAgLSBmYWN0b3I7CiAgfQoKICB2YXIgZmFjdG9yU3RyID0gZmFjdG9yLnRvRml4ZWQoMjApOwoKICAvLyBzdHJpcCB6ZXJvcyBmcm9tIHRoZSBlbmQKICBmYWN0b3JTdHIgPSBmYWN0b3JTdHIucmVwbGFjZSgvXC4/MCskLywgJycpOwoKICByZXN1bHQgKz0gU0VQICsgZmFjdG9yU3RyOwoKICByZXR1cm4gcmVzdWx0Owp9Cgp9LHsiLi91dGlscyI6MTA3fV0sMTA3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKZnVuY3Rpb24gcGFkKHN0ciwgcGFkV2l0aCwgdXBUb0xlbmd0aCkgewogIHZhciBwYWRkaW5nID0gJyc7CiAgdmFyIHRhcmdldExlbmd0aCA9IHVwVG9MZW5ndGggLSBzdHIubGVuZ3RoOwogIHdoaWxlIChwYWRkaW5nLmxlbmd0aCA8IHRhcmdldExlbmd0aCkgewogICAgcGFkZGluZyArPSBwYWRXaXRoOwogIH0KICByZXR1cm4gcGFkZGluZzsKfQoKZXhwb3J0cy5wYWRMZWZ0ID0gZnVuY3Rpb24gKHN0ciwgcGFkV2l0aCwgdXBUb0xlbmd0aCkgewogIHZhciBwYWRkaW5nID0gcGFkKHN0ciwgcGFkV2l0aCwgdXBUb0xlbmd0aCk7CiAgcmV0dXJuIHBhZGRpbmcgKyBzdHI7Cn07CgpleHBvcnRzLnBhZFJpZ2h0ID0gZnVuY3Rpb24gKHN0ciwgcGFkV2l0aCwgdXBUb0xlbmd0aCkgewogIHZhciBwYWRkaW5nID0gcGFkKHN0ciwgcGFkV2l0aCwgdXBUb0xlbmd0aCk7CiAgcmV0dXJuIHN0ciArIHBhZGRpbmc7Cn07CgpleHBvcnRzLnN0cmluZ0xleENvbXBhcmUgPSBmdW5jdGlvbiAoYSwgYikgewoKICB2YXIgYUxlbiA9IGEubGVuZ3RoOwogIHZhciBiTGVuID0gYi5sZW5ndGg7CgogIHZhciBpOwogIGZvciAoaSA9IDA7IGkgPCBhTGVuOyBpKyspIHsKICAgIGlmIChpID09PSBiTGVuKSB7CiAgICAgIC8vIGIgaXMgc2hvcnRlciBzdWJzdHJpbmcgb2YgYQogICAgICByZXR1cm4gMTsKICAgIH0KICAgIHZhciBhQ2hhciA9IGEuY2hhckF0KGkpOwogICAgdmFyIGJDaGFyID0gYi5jaGFyQXQoaSk7CiAgICBpZiAoYUNoYXIgIT09IGJDaGFyKSB7CiAgICAgIHJldHVybiBhQ2hhciA8IGJDaGFyID8gLTEgOiAxOwogICAgfQogIH0KCiAgaWYgKGFMZW4gPCBiTGVuKSB7CiAgICAvLyBhIGlzIHNob3J0ZXIgc3Vic3RyaW5nIG9mIGIKICAgIHJldHVybiAtMTsKICB9CgogIHJldHVybiAwOwp9OwoKLyoKICogcmV0dXJucyB0aGUgZGVjaW1hbCBmb3JtIGZvciB0aGUgZ2l2ZW4gaW50ZWdlciwgaS5lLiB3cml0ZXMKICogb3V0IGFsbCB0aGUgZGlnaXRzIChpbiBiYXNlLTEwKSBpbnN0ZWFkIG9mIHVzaW5nIHNjaWVudGlmaWMgbm90YXRpb24KICovCmV4cG9ydHMuaW50VG9EZWNpbWFsRm9ybSA9IGZ1bmN0aW9uIChpbnQpIHsKCiAgdmFyIGlzTmVnID0gaW50IDwgMDsKICB2YXIgcmVzdWx0ID0gJyc7CgogIGRvIHsKICAgIHZhciByZW1haW5kZXIgPSBpc05lZyA/IC1NYXRoLmNlaWwoaW50ICUgMTApIDogTWF0aC5mbG9vcihpbnQgJSAxMCk7CgogICAgcmVzdWx0ID0gcmVtYWluZGVyICsgcmVzdWx0OwogICAgaW50ID0gaXNOZWcgPyBNYXRoLmNlaWwoaW50IC8gMTApIDogTWF0aC5mbG9vcihpbnQgLyAxMCk7CiAgfSB3aGlsZSAoaW50KTsKCgogIGlmIChpc05lZyAmJiByZXN1bHQgIT09ICcwJykgewogICAgcmVzdWx0ID0gJy0nICsgcmVzdWx0OwogIH0KCiAgcmV0dXJuIHJlc3VsdDsKfTsKfSx7fV0sMTA4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwpleHBvcnRzLk1hcCA9IExhenlNYXA7IC8vIFRPRE86IHVzZSBFUzYgbWFwCmV4cG9ydHMuU2V0ID0gTGF6eVNldDsgLy8gVE9ETzogdXNlIEVTNiBzZXQKLy8gYmFzZWQgb24gaHR0cHM6Ly9naXRodWIuY29tL21vbnRhZ2Vqcy9jb2xsZWN0aW9ucwpmdW5jdGlvbiBMYXp5TWFwKCkgewogIHRoaXMuc3RvcmUgPSB7fTsKfQpMYXp5TWFwLnByb3RvdHlwZS5tYW5nbGUgPSBmdW5jdGlvbiAoa2V5KSB7CiAgaWYgKHR5cGVvZiBrZXkgIT09ICJzdHJpbmciKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJrZXkgbXVzdCBiZSBhIHN0cmluZyBidXQgR290ICIgKyBrZXkpOwogIH0KICByZXR1cm4gJyQnICsga2V5Owp9OwpMYXp5TWFwLnByb3RvdHlwZS51bm1hbmdsZSA9IGZ1bmN0aW9uIChrZXkpIHsKICByZXR1cm4ga2V5LnN1YnN0cmluZygxKTsKfTsKTGF6eU1hcC5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKGtleSkgewogIHZhciBtYW5nbGVkID0gdGhpcy5tYW5nbGUoa2V5KTsKICBpZiAobWFuZ2xlZCBpbiB0aGlzLnN0b3JlKSB7CiAgICByZXR1cm4gdGhpcy5zdG9yZVttYW5nbGVkXTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKTGF6eU1hcC5wcm90b3R5cGUuc2V0ID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICB2YXIgbWFuZ2xlZCA9IHRoaXMubWFuZ2xlKGtleSk7CiAgdGhpcy5zdG9yZVttYW5nbGVkXSA9IHZhbHVlOwogIHJldHVybiB0cnVlOwp9OwpMYXp5TWFwLnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbiAoa2V5KSB7CiAgdmFyIG1hbmdsZWQgPSB0aGlzLm1hbmdsZShrZXkpOwogIHJldHVybiBtYW5nbGVkIGluIHRoaXMuc3RvcmU7Cn07CkxhenlNYXAucHJvdG90eXBlLmRlbGV0ZSA9IGZ1bmN0aW9uIChrZXkpIHsKICB2YXIgbWFuZ2xlZCA9IHRoaXMubWFuZ2xlKGtleSk7CiAgaWYgKG1hbmdsZWQgaW4gdGhpcy5zdG9yZSkgewogICAgZGVsZXRlIHRoaXMuc3RvcmVbbWFuZ2xlZF07CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9OwpMYXp5TWFwLnByb3RvdHlwZS5mb3JFYWNoID0gZnVuY3Rpb24gKGNiKSB7CiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh0aGlzLnN0b3JlKTsKICBmb3IgKHZhciBpID0gMCwgbGVuID0ga2V5cy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgdmFyIGtleSA9IGtleXNbaV07CiAgICB2YXIgdmFsdWUgPSB0aGlzLnN0b3JlW2tleV07CiAgICBrZXkgPSB0aGlzLnVubWFuZ2xlKGtleSk7CiAgICBjYih2YWx1ZSwga2V5KTsKICB9Cn07CgpmdW5jdGlvbiBMYXp5U2V0KGFycmF5KSB7CiAgdGhpcy5zdG9yZSA9IG5ldyBMYXp5TWFwKCk7CgogIC8vIGluaXQgd2l0aCBhbiBhcnJheQogIGlmIChhcnJheSAmJiBBcnJheS5pc0FycmF5KGFycmF5KSkgewogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGFycmF5Lmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHRoaXMuYWRkKGFycmF5W2ldKTsKICAgIH0KICB9Cn0KTGF6eVNldC5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gKGtleSkgewogIHJldHVybiB0aGlzLnN0b3JlLnNldChrZXksIHRydWUpOwp9OwpMYXp5U2V0LnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbiAoa2V5KSB7CiAgcmV0dXJuIHRoaXMuc3RvcmUuaGFzKGtleSk7Cn07CkxhenlTZXQucHJvdG90eXBlLmRlbGV0ZSA9IGZ1bmN0aW9uIChrZXkpIHsKICByZXR1cm4gdGhpcy5zdG9yZS5kZWxldGUoa2V5KTsKfTsKCn0se31dLDEwOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qanNoaW50IGJpdHdpc2U6ZmFsc2UqLwovKmdsb2JhbCB1bmVzY2FwZSovCgooZnVuY3Rpb24gKGZhY3RvcnkpIHsKICAgIGlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKICAgICAgICAvLyBOb2RlL0NvbW1vbkpTCiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgICAgIC8vIEFNRAogICAgICAgIGRlZmluZShmYWN0b3J5KTsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQnJvd3NlciBnbG9iYWxzICh3aXRoIHN1cHBvcnQgZm9yIHdlYiB3b3JrZXJzKQogICAgICAgIHZhciBnbG9iOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGdsb2IgPSB3aW5kb3c7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBnbG9iID0gc2VsZjsKICAgICAgICB9CgogICAgICAgIGdsb2IuU3BhcmtNRDUgPSBmYWN0b3J5KCk7CiAgICB9Cn0oZnVuY3Rpb24gKHVuZGVmaW5lZCkgewoKICAgICd1c2Ugc3RyaWN0JzsKCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoKICAgICAqIEZhc3Rlc3QgbWQ1IGltcGxlbWVudGF0aW9uIGFyb3VuZCAoSktNIG1kNSkKICAgICAqIENyZWRpdHM6IEpvc2VwaCBNeWVycwogICAgICoKICAgICAqIEBzZWUgaHR0cDovL3d3dy5teWVyc2RhaWx5Lm9yZy9qb3NlcGgvamF2YXNjcmlwdC9tZDUtdGV4dC5odG1sCiAgICAgKiBAc2VlIGh0dHA6Ly9qc3BlcmYuY29tL21kNS1zaG9vdG91dC83CiAgICAgKi8KCiAgICAvKiB0aGlzIGZ1bmN0aW9uIGlzIG11Y2ggZmFzdGVyLAogICAgICBzbyBpZiBwb3NzaWJsZSB3ZSB1c2UgaXQuIFNvbWUgSUVzCiAgICAgIGFyZSB0aGUgb25seSBvbmVzIEkga25vdyBvZiB0aGF0CiAgICAgIG5lZWQgdGhlIGlkaW90aWMgc2Vjb25kIGZ1bmN0aW9uLAogICAgICBnZW5lcmF0ZWQgYnkgYW4gaWYgY2xhdXNlLiAgKi8KICAgIHZhciBhZGQzMiA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgcmV0dXJuIChhICsgYikgJiAweEZGRkZGRkZGOwogICAgfSwKCiAgICBjbW4gPSBmdW5jdGlvbiAocSwgYSwgYiwgeCwgcywgdCkgewogICAgICAgIGEgPSBhZGQzMihhZGQzMihhLCBxKSwgYWRkMzIoeCwgdCkpOwogICAgICAgIHJldHVybiBhZGQzMigoYSA8PCBzKSB8IChhID4+PiAoMzIgLSBzKSksIGIpOwogICAgfSwKCiAgICBmZiA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgICAgcmV0dXJuIGNtbigoYiAmIGMpIHwgKCh+YikgJiBkKSwgYSwgYiwgeCwgcywgdCk7CiAgICB9LAoKICAgIGdnID0gZnVuY3Rpb24gKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgICAgICByZXR1cm4gY21uKChiICYgZCkgfCAoYyAmICh+ZCkpLCBhLCBiLCB4LCBzLCB0KTsKICAgIH0sCgogICAgaGggPSBmdW5jdGlvbiAoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICAgIHJldHVybiBjbW4oYiBeIGMgXiBkLCBhLCBiLCB4LCBzLCB0KTsKICAgIH0sCgogICAgaWkgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICAgIHJldHVybiBjbW4oYyBeIChiIHwgKH5kKSksIGEsIGIsIHgsIHMsIHQpOwogICAgfSwKCiAgICBtZDVjeWNsZSA9IGZ1bmN0aW9uICh4LCBrKSB7CiAgICAgICAgdmFyIGEgPSB4WzBdLAogICAgICAgICAgICBiID0geFsxXSwKICAgICAgICAgICAgYyA9IHhbMl0sCiAgICAgICAgICAgIGQgPSB4WzNdOwoKICAgICAgICBhID0gZmYoYSwgYiwgYywgZCwga1swXSwgNywgLTY4MDg3NjkzNik7CiAgICAgICAgZCA9IGZmKGQsIGEsIGIsIGMsIGtbMV0sIDEyLCAtMzg5NTY0NTg2KTsKICAgICAgICBjID0gZmYoYywgZCwgYSwgYiwga1syXSwgMTcsIDYwNjEwNTgxOSk7CiAgICAgICAgYiA9IGZmKGIsIGMsIGQsIGEsIGtbM10sIDIyLCAtMTA0NDUyNTMzMCk7CiAgICAgICAgYSA9IGZmKGEsIGIsIGMsIGQsIGtbNF0sIDcsIC0xNzY0MTg4OTcpOwogICAgICAgIGQgPSBmZihkLCBhLCBiLCBjLCBrWzVdLCAxMiwgMTIwMDA4MDQyNik7CiAgICAgICAgYyA9IGZmKGMsIGQsIGEsIGIsIGtbNl0sIDE3LCAtMTQ3MzIzMTM0MSk7CiAgICAgICAgYiA9IGZmKGIsIGMsIGQsIGEsIGtbN10sIDIyLCAtNDU3MDU5ODMpOwogICAgICAgIGEgPSBmZihhLCBiLCBjLCBkLCBrWzhdLCA3LCAxNzcwMDM1NDE2KTsKICAgICAgICBkID0gZmYoZCwgYSwgYiwgYywga1s5XSwgMTIsIC0xOTU4NDE0NDE3KTsKICAgICAgICBjID0gZmYoYywgZCwgYSwgYiwga1sxMF0sIDE3LCAtNDIwNjMpOwogICAgICAgIGIgPSBmZihiLCBjLCBkLCBhLCBrWzExXSwgMjIsIC0xOTkwNDA0MTYyKTsKICAgICAgICBhID0gZmYoYSwgYiwgYywgZCwga1sxMl0sIDcsIDE4MDQ2MDM2ODIpOwogICAgICAgIGQgPSBmZihkLCBhLCBiLCBjLCBrWzEzXSwgMTIsIC00MDM0MTEwMSk7CiAgICAgICAgYyA9IGZmKGMsIGQsIGEsIGIsIGtbMTRdLCAxNywgLTE1MDIwMDIyOTApOwogICAgICAgIGIgPSBmZihiLCBjLCBkLCBhLCBrWzE1XSwgMjIsIDEyMzY1MzUzMjkpOwoKICAgICAgICBhID0gZ2coYSwgYiwgYywgZCwga1sxXSwgNSwgLTE2NTc5NjUxMCk7CiAgICAgICAgZCA9IGdnKGQsIGEsIGIsIGMsIGtbNl0sIDksIC0xMDY5NTAxNjMyKTsKICAgICAgICBjID0gZ2coYywgZCwgYSwgYiwga1sxMV0sIDE0LCA2NDM3MTc3MTMpOwogICAgICAgIGIgPSBnZyhiLCBjLCBkLCBhLCBrWzBdLCAyMCwgLTM3Mzg5NzMwMik7CiAgICAgICAgYSA9IGdnKGEsIGIsIGMsIGQsIGtbNV0sIDUsIC03MDE1NTg2OTEpOwogICAgICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBrWzEwXSwgOSwgMzgwMTYwODMpOwogICAgICAgIGMgPSBnZyhjLCBkLCBhLCBiLCBrWzE1XSwgMTQsIC02NjA0NzgzMzUpOwogICAgICAgIGIgPSBnZyhiLCBjLCBkLCBhLCBrWzRdLCAyMCwgLTQwNTUzNzg0OCk7CiAgICAgICAgYSA9IGdnKGEsIGIsIGMsIGQsIGtbOV0sIDUsIDU2ODQ0NjQzOCk7CiAgICAgICAgZCA9IGdnKGQsIGEsIGIsIGMsIGtbMTRdLCA5LCAtMTAxOTgwMzY5MCk7CiAgICAgICAgYyA9IGdnKGMsIGQsIGEsIGIsIGtbM10sIDE0LCAtMTg3MzYzOTYxKTsKICAgICAgICBiID0gZ2coYiwgYywgZCwgYSwga1s4XSwgMjAsIDExNjM1MzE1MDEpOwogICAgICAgIGEgPSBnZyhhLCBiLCBjLCBkLCBrWzEzXSwgNSwgLTE0NDQ2ODE0NjcpOwogICAgICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBrWzJdLCA5LCAtNTE0MDM3ODQpOwogICAgICAgIGMgPSBnZyhjLCBkLCBhLCBiLCBrWzddLCAxNCwgMTczNTMyODQ3Myk7CiAgICAgICAgYiA9IGdnKGIsIGMsIGQsIGEsIGtbMTJdLCAyMCwgLTE5MjY2MDc3MzQpOwoKICAgICAgICBhID0gaGgoYSwgYiwgYywgZCwga1s1XSwgNCwgLTM3ODU1OCk7CiAgICAgICAgZCA9IGhoKGQsIGEsIGIsIGMsIGtbOF0sIDExLCAtMjAyMjU3NDQ2Myk7CiAgICAgICAgYyA9IGhoKGMsIGQsIGEsIGIsIGtbMTFdLCAxNiwgMTgzOTAzMDU2Mik7CiAgICAgICAgYiA9IGhoKGIsIGMsIGQsIGEsIGtbMTRdLCAyMywgLTM1MzA5NTU2KTsKICAgICAgICBhID0gaGgoYSwgYiwgYywgZCwga1sxXSwgNCwgLTE1MzA5OTIwNjApOwogICAgICAgIGQgPSBoaChkLCBhLCBiLCBjLCBrWzRdLCAxMSwgMTI3Mjg5MzM1Myk7CiAgICAgICAgYyA9IGhoKGMsIGQsIGEsIGIsIGtbN10sIDE2LCAtMTU1NDk3NjMyKTsKICAgICAgICBiID0gaGgoYiwgYywgZCwgYSwga1sxMF0sIDIzLCAtMTA5NDczMDY0MCk7CiAgICAgICAgYSA9IGhoKGEsIGIsIGMsIGQsIGtbMTNdLCA0LCA2ODEyNzkxNzQpOwogICAgICAgIGQgPSBoaChkLCBhLCBiLCBjLCBrWzBdLCAxMSwgLTM1ODUzNzIyMik7CiAgICAgICAgYyA9IGhoKGMsIGQsIGEsIGIsIGtbM10sIDE2LCAtNzIyNTIxOTc5KTsKICAgICAgICBiID0gaGgoYiwgYywgZCwgYSwga1s2XSwgMjMsIDc2MDI5MTg5KTsKICAgICAgICBhID0gaGgoYSwgYiwgYywgZCwga1s5XSwgNCwgLTY0MDM2NDQ4Nyk7CiAgICAgICAgZCA9IGhoKGQsIGEsIGIsIGMsIGtbMTJdLCAxMSwgLTQyMTgxNTgzNSk7CiAgICAgICAgYyA9IGhoKGMsIGQsIGEsIGIsIGtbMTVdLCAxNiwgNTMwNzQyNTIwKTsKICAgICAgICBiID0gaGgoYiwgYywgZCwgYSwga1syXSwgMjMsIC05OTUzMzg2NTEpOwoKICAgICAgICBhID0gaWkoYSwgYiwgYywgZCwga1swXSwgNiwgLTE5ODYzMDg0NCk7CiAgICAgICAgZCA9IGlpKGQsIGEsIGIsIGMsIGtbN10sIDEwLCAxMTI2ODkxNDE1KTsKICAgICAgICBjID0gaWkoYywgZCwgYSwgYiwga1sxNF0sIDE1LCAtMTQxNjM1NDkwNSk7CiAgICAgICAgYiA9IGlpKGIsIGMsIGQsIGEsIGtbNV0sIDIxLCAtNTc0MzQwNTUpOwogICAgICAgIGEgPSBpaShhLCBiLCBjLCBkLCBrWzEyXSwgNiwgMTcwMDQ4NTU3MSk7CiAgICAgICAgZCA9IGlpKGQsIGEsIGIsIGMsIGtbM10sIDEwLCAtMTg5NDk4NjYwNik7CiAgICAgICAgYyA9IGlpKGMsIGQsIGEsIGIsIGtbMTBdLCAxNSwgLTEwNTE1MjMpOwogICAgICAgIGIgPSBpaShiLCBjLCBkLCBhLCBrWzFdLCAyMSwgLTIwNTQ5MjI3OTkpOwogICAgICAgIGEgPSBpaShhLCBiLCBjLCBkLCBrWzhdLCA2LCAxODczMzEzMzU5KTsKICAgICAgICBkID0gaWkoZCwgYSwgYiwgYywga1sxNV0sIDEwLCAtMzA2MTE3NDQpOwogICAgICAgIGMgPSBpaShjLCBkLCBhLCBiLCBrWzZdLCAxNSwgLTE1NjAxOTgzODApOwogICAgICAgIGIgPSBpaShiLCBjLCBkLCBhLCBrWzEzXSwgMjEsIDEzMDkxNTE2NDkpOwogICAgICAgIGEgPSBpaShhLCBiLCBjLCBkLCBrWzRdLCA2LCAtMTQ1NTIzMDcwKTsKICAgICAgICBkID0gaWkoZCwgYSwgYiwgYywga1sxMV0sIDEwLCAtMTEyMDIxMDM3OSk7CiAgICAgICAgYyA9IGlpKGMsIGQsIGEsIGIsIGtbMl0sIDE1LCA3MTg3ODcyNTkpOwogICAgICAgIGIgPSBpaShiLCBjLCBkLCBhLCBrWzldLCAyMSwgLTM0MzQ4NTU1MSk7CgogICAgICAgIHhbMF0gPSBhZGQzMihhLCB4WzBdKTsKICAgICAgICB4WzFdID0gYWRkMzIoYiwgeFsxXSk7CiAgICAgICAgeFsyXSA9IGFkZDMyKGMsIHhbMl0pOwogICAgICAgIHhbM10gPSBhZGQzMihkLCB4WzNdKTsKICAgIH0sCgogICAgLyogdGhlcmUgbmVlZHMgdG8gYmUgc3VwcG9ydCBmb3IgVW5pY29kZSBoZXJlLAogICAgICAgKiB1bmxlc3Mgd2UgcHJldGVuZCB0aGF0IHdlIGNhbiByZWRlZmluZSB0aGUgTUQtNQogICAgICAgKiBhbGdvcml0aG0gZm9yIG11bHRpLWJ5dGUgY2hhcmFjdGVycyAocGVyaGFwcwogICAgICAgKiBieSBhZGRpbmcgZXZlcnkgZm91ciAxNi1iaXQgY2hhcmFjdGVycyBhbmQKICAgICAgICogc2hvcnRlbmluZyB0aGUgc3VtIHRvIDMyIGJpdHMpLiBPdGhlcndpc2UKICAgICAgICogSSBzdWdnZXN0IHBlcmZvcm1pbmcgTUQtNSBhcyBpZiBldmVyeSBjaGFyYWN0ZXIKICAgICAgICogd2FzIHR3byBieXRlcy0tZS5nLiwgMDA0MCAwMDI1ID0gQCUtLWJ1dCB0aGVuCiAgICAgICAqIGhvdyB3aWxsIGFuIG9yZGluYXJ5IE1ELTUgc3VtIGJlIG1hdGNoZWQ/CiAgICAgICAqIFRoZXJlIGlzIG5vIHdheSB0byBzdGFuZGFyZGl6ZSB0ZXh0IHRvIHNvbWV0aGluZwogICAgICAgKiBsaWtlIFVURi04IGJlZm9yZSB0cmFuc2Zvcm1hdGlvbjsgc3BlZWQgY29zdCBpcwogICAgICAgKiB1dHRlcmx5IHByb2hpYml0aXZlLiBUaGUgSmF2YVNjcmlwdCBzdGFuZGFyZAogICAgICAgKiBpdHNlbGYgbmVlZHMgdG8gbG9vayBhdCB0aGlzOiBpdCBzaG91bGQgc3RhcnQKICAgICAgICogcHJvdmlkaW5nIGFjY2VzcyB0byBzdHJpbmdzIGFzIHByZWZvcm1lZCBVVEYtOAogICAgICAgKiA4LWJpdCB1bnNpZ25lZCB2YWx1ZSBhcnJheXMuCiAgICAgICAqLwogICAgbWQ1YmxrID0gZnVuY3Rpb24gKHMpIHsKICAgICAgICB2YXIgbWQ1YmxrcyA9IFtdLAogICAgICAgICAgICBpOyAvKiBBbmR5IEtpbmcgc2FpZCBkbyBpdCB0aGlzIHdheS4gKi8KCiAgICAgICAgZm9yIChpID0gMDsgaSA8IDY0OyBpICs9IDQpIHsKICAgICAgICAgICAgbWQ1Ymxrc1tpID4+IDJdID0gcy5jaGFyQ29kZUF0KGkpICsgKHMuY2hhckNvZGVBdChpICsgMSkgPDwgOCkgKyAocy5jaGFyQ29kZUF0KGkgKyAyKSA8PCAxNikgKyAocy5jaGFyQ29kZUF0KGkgKyAzKSA8PCAyNCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZDVibGtzOwogICAgfSwKCiAgICBtZDVibGtfYXJyYXkgPSBmdW5jdGlvbiAoYSkgewogICAgICAgIHZhciBtZDVibGtzID0gW10sCiAgICAgICAgICAgIGk7IC8qIEFuZHkgS2luZyBzYWlkIGRvIGl0IHRoaXMgd2F5LiAqLwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgNjQ7IGkgKz0gNCkgewogICAgICAgICAgICBtZDVibGtzW2kgPj4gMl0gPSBhW2ldICsgKGFbaSArIDFdIDw8IDgpICsgKGFbaSArIDJdIDw8IDE2KSArIChhW2kgKyAzXSA8PCAyNCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZDVibGtzOwogICAgfSwKCiAgICBtZDUxID0gZnVuY3Rpb24gKHMpIHsKICAgICAgICB2YXIgbiA9IHMubGVuZ3RoLAogICAgICAgICAgICBzdGF0ZSA9IFsxNzMyNTg0MTkzLCAtMjcxNzMzODc5LCAtMTczMjU4NDE5NCwgMjcxNzMzODc4XSwKICAgICAgICAgICAgaSwKICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICB0YWlsLAogICAgICAgICAgICB0bXAsCiAgICAgICAgICAgIGxvLAogICAgICAgICAgICBoaTsKCiAgICAgICAgZm9yIChpID0gNjQ7IGkgPD0gbjsgaSArPSA2NCkgewogICAgICAgICAgICBtZDVjeWNsZShzdGF0ZSwgbWQ1YmxrKHMuc3Vic3RyaW5nKGkgLSA2NCwgaSkpKTsKICAgICAgICB9CiAgICAgICAgcyA9IHMuc3Vic3RyaW5nKGkgLSA2NCk7CiAgICAgICAgbGVuZ3RoID0gcy5sZW5ndGg7CiAgICAgICAgdGFpbCA9IFswLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgdGFpbFtpID4+IDJdIHw9IHMuY2hhckNvZGVBdChpKSA8PCAoKGkgJSA0KSA8PCAzKTsKICAgICAgICB9CiAgICAgICAgdGFpbFtpID4+IDJdIHw9IDB4ODAgPDwgKChpICUgNCkgPDwgMyk7CiAgICAgICAgaWYgKGkgPiA1NSkgewogICAgICAgICAgICBtZDVjeWNsZShzdGF0ZSwgdGFpbCk7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCAxNjsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICB0YWlsW2ldID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQmV3YXJlIHRoYXQgdGhlIGZpbmFsIGxlbmd0aCBtaWdodCBub3QgZml0IGluIDMyIGJpdHMgc28gd2UgdGFrZSBjYXJlIG9mIHRoYXQKICAgICAgICB0bXAgPSBuICogODsKICAgICAgICB0bXAgPSB0bXAudG9TdHJpbmcoMTYpLm1hdGNoKC8oLio/KSguezAsOH0pJC8pOwogICAgICAgIGxvID0gcGFyc2VJbnQodG1wWzJdLCAxNik7CiAgICAgICAgaGkgPSBwYXJzZUludCh0bXBbMV0sIDE2KSB8fCAwOwoKICAgICAgICB0YWlsWzE0XSA9IGxvOwogICAgICAgIHRhaWxbMTVdID0gaGk7CgogICAgICAgIG1kNWN5Y2xlKHN0YXRlLCB0YWlsKTsKICAgICAgICByZXR1cm4gc3RhdGU7CiAgICB9LAoKICAgIG1kNTFfYXJyYXkgPSBmdW5jdGlvbiAoYSkgewogICAgICAgIHZhciBuID0gYS5sZW5ndGgsCiAgICAgICAgICAgIHN0YXRlID0gWzE3MzI1ODQxOTMsIC0yNzE3MzM4NzksIC0xNzMyNTg0MTk0LCAyNzE3MzM4NzhdLAogICAgICAgICAgICBpLAogICAgICAgICAgICBsZW5ndGgsCiAgICAgICAgICAgIHRhaWwsCiAgICAgICAgICAgIHRtcCwKICAgICAgICAgICAgbG8sCiAgICAgICAgICAgIGhpOwoKICAgICAgICBmb3IgKGkgPSA2NDsgaSA8PSBuOyBpICs9IDY0KSB7CiAgICAgICAgICAgIG1kNWN5Y2xlKHN0YXRlLCBtZDVibGtfYXJyYXkoYS5zdWJhcnJheShpIC0gNjQsIGkpKSk7CiAgICAgICAgfQoKICAgICAgICAvLyBOb3Qgc3VyZSBpZiBpdCBpcyBhIGJ1ZywgaG93ZXZlciBJRTEwIHdpbGwgYWx3YXlzIHByb2R1Y2UgYSBzdWIgYXJyYXkgb2YgbGVuZ3RoIDEKICAgICAgICAvLyBjb250YWluaW5nIHRoZSBsYXN0IGVsZW1lbnQgb2YgdGhlIHBhcmVudCBhcnJheSBpZiB0aGUgc3ViIGFycmF5IHNwZWNpZmllZCBzdGFydHMKICAgICAgICAvLyBiZXlvbmQgdGhlIGxlbmd0aCBvZiB0aGUgcGFyZW50IGFycmF5IC0gd2VpcmQuCiAgICAgICAgLy8gaHR0cHM6Ly9jb25uZWN0Lm1pY3Jvc29mdC5jb20vSUUvZmVlZGJhY2svZGV0YWlscy83NzE0NTIvdHlwZWQtYXJyYXktc3ViYXJyYXktaXNzdWUKICAgICAgICBhID0gKGkgLSA2NCkgPCBuID8gYS5zdWJhcnJheShpIC0gNjQpIDogbmV3IFVpbnQ4QXJyYXkoMCk7CgogICAgICAgIGxlbmd0aCA9IGEubGVuZ3RoOwogICAgICAgIHRhaWwgPSBbMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMF07CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgIHRhaWxbaSA+PiAyXSB8PSBhW2ldIDw8ICgoaSAlIDQpIDw8IDMpOwogICAgICAgIH0KCiAgICAgICAgdGFpbFtpID4+IDJdIHw9IDB4ODAgPDwgKChpICUgNCkgPDwgMyk7CiAgICAgICAgaWYgKGkgPiA1NSkgewogICAgICAgICAgICBtZDVjeWNsZShzdGF0ZSwgdGFpbCk7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCAxNjsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICB0YWlsW2ldID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQmV3YXJlIHRoYXQgdGhlIGZpbmFsIGxlbmd0aCBtaWdodCBub3QgZml0IGluIDMyIGJpdHMgc28gd2UgdGFrZSBjYXJlIG9mIHRoYXQKICAgICAgICB0bXAgPSBuICogODsKICAgICAgICB0bXAgPSB0bXAudG9TdHJpbmcoMTYpLm1hdGNoKC8oLio/KSguezAsOH0pJC8pOwogICAgICAgIGxvID0gcGFyc2VJbnQodG1wWzJdLCAxNik7CiAgICAgICAgaGkgPSBwYXJzZUludCh0bXBbMV0sIDE2KSB8fCAwOwoKICAgICAgICB0YWlsWzE0XSA9IGxvOwogICAgICAgIHRhaWxbMTVdID0gaGk7CgogICAgICAgIG1kNWN5Y2xlKHN0YXRlLCB0YWlsKTsKCiAgICAgICAgcmV0dXJuIHN0YXRlOwogICAgfSwKCiAgICBoZXhfY2hyID0gWycwJywgJzEnLCAnMicsICczJywgJzQnLCAnNScsICc2JywgJzcnLCAnOCcsICc5JywgJ2EnLCAnYicsICdjJywgJ2QnLCAnZScsICdmJ10sCgogICAgcmhleCA9IGZ1bmN0aW9uIChuKSB7CiAgICAgICAgdmFyIHMgPSAnJywKICAgICAgICAgICAgajsKICAgICAgICBmb3IgKGogPSAwOyBqIDwgNDsgaiArPSAxKSB7CiAgICAgICAgICAgIHMgKz0gaGV4X2NoclsobiA+PiAoaiAqIDggKyA0KSkgJiAweDBGXSArIGhleF9jaHJbKG4gPj4gKGogKiA4KSkgJiAweDBGXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHM7CiAgICB9LAoKICAgIGhleCA9IGZ1bmN0aW9uICh4KSB7CiAgICAgICAgdmFyIGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHgubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgeFtpXSA9IHJoZXgoeFtpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB4LmpvaW4oJycpOwogICAgfSwKCiAgICBtZDUgPSBmdW5jdGlvbiAocykgewogICAgICAgIHJldHVybiBoZXgobWQ1MShzKSk7CiAgICB9LAoKCgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qKgogICAgICogU3BhcmtNRDUgT09QIGltcGxlbWVudGF0aW9uLgogICAgICoKICAgICAqIFVzZSB0aGlzIGNsYXNzIHRvIHBlcmZvcm0gYW4gaW5jcmVtZW50YWwgbWQ1LCBvdGhlcndpc2UgdXNlIHRoZQogICAgICogc3RhdGljIG1ldGhvZHMgaW5zdGVhZC4KICAgICAqLwogICAgU3BhcmtNRDUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gY2FsbCByZXNldCB0byBpbml0IHRoZSBpbnN0YW5jZQogICAgICAgIHRoaXMucmVzZXQoKTsKICAgIH07CgoKICAgIC8vIEluIHNvbWUgY2FzZXMgdGhlIGZhc3QgYWRkMzIgZnVuY3Rpb24gY2Fubm90IGJlIHVzZWQuLgogICAgaWYgKG1kNSgnaGVsbG8nKSAhPT0gJzVkNDE0MDJhYmM0YjJhNzZiOTcxOWQ5MTEwMTdjNTkyJykgewogICAgICAgIGFkZDMyID0gZnVuY3Rpb24gKHgsIHkpIHsKICAgICAgICAgICAgdmFyIGxzdyA9ICh4ICYgMHhGRkZGKSArICh5ICYgMHhGRkZGKSwKICAgICAgICAgICAgICAgIG1zdyA9ICh4ID4+IDE2KSArICh5ID4+IDE2KSArIChsc3cgPj4gMTYpOwogICAgICAgICAgICByZXR1cm4gKG1zdyA8PCAxNikgfCAobHN3ICYgMHhGRkZGKTsKICAgICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIEFwcGVuZHMgYSBzdHJpbmcuCiAgICAgKiBBIGNvbnZlcnNpb24gd2lsbCBiZSBhcHBsaWVkIGlmIGFuIHV0Zjggc3RyaW5nIGlzIGRldGVjdGVkLgogICAgICoKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN0cmluZyB0byBiZSBhcHBlbmRlZAogICAgICoKICAgICAqIEByZXR1cm4ge1NwYXJrTUQ1fSBUaGUgaW5zdGFuY2UgaXRzZWxmCiAgICAgKi8KICAgIFNwYXJrTUQ1LnByb3RvdHlwZS5hcHBlbmQgPSBmdW5jdGlvbiAoc3RyKSB7CiAgICAgICAgLy8gY29udmVydHMgdGhlIHN0cmluZyB0byB1dGY4IGJ5dGVzIGlmIG5lY2Vzc2FyeQogICAgICAgIGlmICgvW1x1MDA4MC1cdUZGRkZdLy50ZXN0KHN0cikpIHsKICAgICAgICAgICAgc3RyID0gdW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KHN0cikpOwogICAgICAgIH0KCiAgICAgICAgLy8gdGhlbiBhcHBlbmQgYXMgYmluYXJ5CiAgICAgICAgdGhpcy5hcHBlbmRCaW5hcnkoc3RyKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIC8qKgogICAgICogQXBwZW5kcyBhIGJpbmFyeSBzdHJpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IGNvbnRlbnRzIFRoZSBiaW5hcnkgc3RyaW5nIHRvIGJlIGFwcGVuZGVkCiAgICAgKgogICAgICogQHJldHVybiB7U3BhcmtNRDV9IFRoZSBpbnN0YW5jZSBpdHNlbGYKICAgICAqLwogICAgU3BhcmtNRDUucHJvdG90eXBlLmFwcGVuZEJpbmFyeSA9IGZ1bmN0aW9uIChjb250ZW50cykgewogICAgICAgIHRoaXMuX2J1ZmYgKz0gY29udGVudHM7CiAgICAgICAgdGhpcy5fbGVuZ3RoICs9IGNvbnRlbnRzLmxlbmd0aDsKCiAgICAgICAgdmFyIGxlbmd0aCA9IHRoaXMuX2J1ZmYubGVuZ3RoLAogICAgICAgICAgICBpOwoKICAgICAgICBmb3IgKGkgPSA2NDsgaSA8PSBsZW5ndGg7IGkgKz0gNjQpIHsKICAgICAgICAgICAgbWQ1Y3ljbGUodGhpcy5fc3RhdGUsIG1kNWJsayh0aGlzLl9idWZmLnN1YnN0cmluZyhpIC0gNjQsIGkpKSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9idWZmID0gdGhpcy5fYnVmZi5zdWJzdHIoaSAtIDY0KTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIC8qKgogICAgICogRmluaXNoZXMgdGhlIGluY3JlbWVudGFsIGNvbXB1dGF0aW9uLCByZXNldGluZyB0aGUgaW50ZXJuYWwgc3RhdGUgYW5kCiAgICAgKiByZXR1cm5pbmcgdGhlIHJlc3VsdC4KICAgICAqIFVzZSB0aGUgcmF3IHBhcmFtZXRlciB0byBvYnRhaW4gdGhlIHJhdyByZXN1bHQgaW5zdGVhZCBvZiB0aGUgaGV4IG9uZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IHJhdyBUcnVlIHRvIGdldCB0aGUgcmF3IHJlc3VsdCwgZmFsc2UgdG8gZ2V0IHRoZSBoZXggcmVzdWx0CiAgICAgKgogICAgICogQHJldHVybiB7U3RyaW5nfEFycmF5fSBUaGUgcmVzdWx0CiAgICAgKi8KICAgIFNwYXJrTUQ1LnByb3RvdHlwZS5lbmQgPSBmdW5jdGlvbiAocmF3KSB7CiAgICAgICAgdmFyIGJ1ZmYgPSB0aGlzLl9idWZmLAogICAgICAgICAgICBsZW5ndGggPSBidWZmLmxlbmd0aCwKICAgICAgICAgICAgaSwKICAgICAgICAgICAgdGFpbCA9IFswLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwXSwKICAgICAgICAgICAgcmV0OwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgdGFpbFtpID4+IDJdIHw9IGJ1ZmYuY2hhckNvZGVBdChpKSA8PCAoKGkgJSA0KSA8PCAzKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2ZpbmlzaCh0YWlsLCBsZW5ndGgpOwogICAgICAgIHJldCA9ICEhcmF3ID8gdGhpcy5fc3RhdGUgOiBoZXgodGhpcy5fc3RhdGUpOwoKICAgICAgICB0aGlzLnJlc2V0KCk7CgogICAgICAgIHJldHVybiByZXQ7CiAgICB9OwoKICAgIC8qKgogICAgICogRmluaXNoIHRoZSBmaW5hbCBjYWxjdWxhdGlvbiBiYXNlZCBvbiB0aGUgdGFpbC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSAgdGFpbCAgIFRoZSB0YWlsICh3aWxsIGJlIG1vZGlmaWVkKQogICAgICogQHBhcmFtIHtOdW1iZXJ9IGxlbmd0aCBUaGUgbGVuZ3RoIG9mIHRoZSByZW1haW5pbmcgYnVmZmVyCiAgICAgKi8KICAgIFNwYXJrTUQ1LnByb3RvdHlwZS5fZmluaXNoID0gZnVuY3Rpb24gKHRhaWwsIGxlbmd0aCkgewogICAgICAgIHZhciBpID0gbGVuZ3RoLAogICAgICAgICAgICB0bXAsCiAgICAgICAgICAgIGxvLAogICAgICAgICAgICBoaTsKCiAgICAgICAgdGFpbFtpID4+IDJdIHw9IDB4ODAgPDwgKChpICUgNCkgPDwgMyk7CiAgICAgICAgaWYgKGkgPiA1NSkgewogICAgICAgICAgICBtZDVjeWNsZSh0aGlzLl9zdGF0ZSwgdGFpbCk7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCAxNjsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICB0YWlsW2ldID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRG8gdGhlIGZpbmFsIGNvbXB1dGF0aW9uIGJhc2VkIG9uIHRoZSB0YWlsIGFuZCBsZW5ndGgKICAgICAgICAvLyBCZXdhcmUgdGhhdCB0aGUgZmluYWwgbGVuZ3RoIG1heSBub3QgZml0IGluIDMyIGJpdHMgc28gd2UgdGFrZSBjYXJlIG9mIHRoYXQKICAgICAgICB0bXAgPSB0aGlzLl9sZW5ndGggKiA4OwogICAgICAgIHRtcCA9IHRtcC50b1N0cmluZygxNikubWF0Y2goLyguKj8pKC57MCw4fSkkLyk7CiAgICAgICAgbG8gPSBwYXJzZUludCh0bXBbMl0sIDE2KTsKICAgICAgICBoaSA9IHBhcnNlSW50KHRtcFsxXSwgMTYpIHx8IDA7CgogICAgICAgIHRhaWxbMTRdID0gbG87CiAgICAgICAgdGFpbFsxNV0gPSBoaTsKICAgICAgICBtZDVjeWNsZSh0aGlzLl9zdGF0ZSwgdGFpbCk7CiAgICB9OwoKICAgIC8qKgogICAgICogUmVzZXRzIHRoZSBpbnRlcm5hbCBzdGF0ZSBvZiB0aGUgY29tcHV0YXRpb24uCiAgICAgKgogICAgICogQHJldHVybiB7U3BhcmtNRDV9IFRoZSBpbnN0YW5jZSBpdHNlbGYKICAgICAqLwogICAgU3BhcmtNRDUucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuX2J1ZmYgPSAiIjsKICAgICAgICB0aGlzLl9sZW5ndGggPSAwOwogICAgICAgIHRoaXMuX3N0YXRlID0gWzE3MzI1ODQxOTMsIC0yNzE3MzM4NzksIC0xNzMyNTg0MTk0LCAyNzE3MzM4NzhdOwoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgLyoqCiAgICAgKiBSZWxlYXNlcyBtZW1vcnkgdXNlZCBieSB0aGUgaW5jcmVtZW50YWwgYnVmZmVyIGFuZCBvdGhlciBhZGl0aW9uYWwKICAgICAqIHJlc291cmNlcy4gSWYgeW91IHBsYW4gdG8gdXNlIHRoZSBpbnN0YW5jZSBhZ2FpbiwgdXNlIHJlc2V0IGluc3RlYWQuCiAgICAgKi8KICAgIFNwYXJrTUQ1LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgICAgIGRlbGV0ZSB0aGlzLl9zdGF0ZTsKICAgICAgICBkZWxldGUgdGhpcy5fYnVmZjsKICAgICAgICBkZWxldGUgdGhpcy5fbGVuZ3RoOwogICAgfTsKCgogICAgLyoqCiAgICAgKiBQZXJmb3JtcyB0aGUgbWQ1IGhhc2ggb24gYSBzdHJpbmcuCiAgICAgKiBBIGNvbnZlcnNpb24gd2lsbCBiZSBhcHBsaWVkIGlmIHV0Zjggc3RyaW5nIGlzIGRldGVjdGVkLgogICAgICoKICAgICAqIEBwYXJhbSB7U3RyaW5nfSAgc3RyIFRoZSBzdHJpbmcKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gcmF3IFRydWUgdG8gZ2V0IHRoZSByYXcgcmVzdWx0LCBmYWxzZSB0byBnZXQgdGhlIGhleCByZXN1bHQKICAgICAqCiAgICAgKiBAcmV0dXJuIHtTdHJpbmd8QXJyYXl9IFRoZSByZXN1bHQKICAgICAqLwogICAgU3BhcmtNRDUuaGFzaCA9IGZ1bmN0aW9uIChzdHIsIHJhdykgewogICAgICAgIC8vIGNvbnZlcnRzIHRoZSBzdHJpbmcgdG8gdXRmOCBieXRlcyBpZiBuZWNlc3NhcnkKICAgICAgICBpZiAoL1tcdTAwODAtXHVGRkZGXS8udGVzdChzdHIpKSB7CiAgICAgICAgICAgIHN0ciA9IHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChzdHIpKTsKICAgICAgICB9CgogICAgICAgIHZhciBoYXNoID0gbWQ1MShzdHIpOwoKICAgICAgICByZXR1cm4gISFyYXcgPyBoYXNoIDogaGV4KGhhc2gpOwogICAgfTsKCiAgICAvKioKICAgICAqIFBlcmZvcm1zIHRoZSBtZDUgaGFzaCBvbiBhIGJpbmFyeSBzdHJpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9ICBjb250ZW50IFRoZSBiaW5hcnkgc3RyaW5nCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IHJhdyAgICAgVHJ1ZSB0byBnZXQgdGhlIHJhdyByZXN1bHQsIGZhbHNlIHRvIGdldCB0aGUgaGV4IHJlc3VsdAogICAgICoKICAgICAqIEByZXR1cm4ge1N0cmluZ3xBcnJheX0gVGhlIHJlc3VsdAogICAgICovCiAgICBTcGFya01ENS5oYXNoQmluYXJ5ID0gZnVuY3Rpb24gKGNvbnRlbnQsIHJhdykgewogICAgICAgIHZhciBoYXNoID0gbWQ1MShjb250ZW50KTsKCiAgICAgICAgcmV0dXJuICEhcmF3ID8gaGFzaCA6IGhleChoYXNoKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBTcGFya01ENSBPT1AgaW1wbGVtZW50YXRpb24gZm9yIGFycmF5IGJ1ZmZlcnMuCiAgICAgKgogICAgICogVXNlIHRoaXMgY2xhc3MgdG8gcGVyZm9ybSBhbiBpbmNyZW1lbnRhbCBtZDUgT05MWSBmb3IgYXJyYXkgYnVmZmVycy4KICAgICAqLwogICAgU3BhcmtNRDUuQXJyYXlCdWZmZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gY2FsbCByZXNldCB0byBpbml0IHRoZSBpbnN0YW5jZQogICAgICAgIHRoaXMucmVzZXQoKTsKICAgIH07CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qKgogICAgICogQXBwZW5kcyBhbiBhcnJheSBidWZmZXIuCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheUJ1ZmZlcn0gYXJyIFRoZSBhcnJheSB0byBiZSBhcHBlbmRlZAogICAgICoKICAgICAqIEByZXR1cm4ge1NwYXJrTUQ1LkFycmF5QnVmZmVyfSBUaGUgaW5zdGFuY2UgaXRzZWxmCiAgICAgKi8KICAgIFNwYXJrTUQ1LkFycmF5QnVmZmVyLnByb3RvdHlwZS5hcHBlbmQgPSBmdW5jdGlvbiAoYXJyKSB7CiAgICAgICAgLy8gVE9ETzogd2UgY291bGQgYXZvaWQgdGhlIGNvbmNhdGVuYXRpb24gaGVyZSBidXQgdGhlIGFsZ29yaXRobSB3b3VsZCBiZSBtb3JlIGNvbXBsZXgKICAgICAgICAvLyAgICAgICBpZiB5b3UgZmluZCB5b3Vyc2VsZiBuZWVkaW5nIGV4dHJhIHBlcmZvcm1hbmNlLCBwbGVhc2UgbWFrZSBhIFBSLgogICAgICAgIHZhciBidWZmID0gdGhpcy5fY29uY2F0QXJyYXlCdWZmZXIodGhpcy5fYnVmZiwgYXJyKSwKICAgICAgICAgICAgbGVuZ3RoID0gYnVmZi5sZW5ndGgsCiAgICAgICAgICAgIGk7CgogICAgICAgIHRoaXMuX2xlbmd0aCArPSBhcnIuYnl0ZUxlbmd0aDsKCiAgICAgICAgZm9yIChpID0gNjQ7IGkgPD0gbGVuZ3RoOyBpICs9IDY0KSB7CiAgICAgICAgICAgIG1kNWN5Y2xlKHRoaXMuX3N0YXRlLCBtZDVibGtfYXJyYXkoYnVmZi5zdWJhcnJheShpIC0gNjQsIGkpKSk7CiAgICAgICAgfQoKICAgICAgICAvLyBBdm9pZHMgSUUxMCB3ZWlyZG5lc3MgKGRvY3VtZW50ZWQgYWJvdmUpCiAgICAgICAgdGhpcy5fYnVmZiA9IChpIC0gNjQpIDwgbGVuZ3RoID8gYnVmZi5zdWJhcnJheShpIC0gNjQpIDogbmV3IFVpbnQ4QXJyYXkoMCk7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICAvKioKICAgICAqIEZpbmlzaGVzIHRoZSBpbmNyZW1lbnRhbCBjb21wdXRhdGlvbiwgcmVzZXRpbmcgdGhlIGludGVybmFsIHN0YXRlIGFuZAogICAgICogcmV0dXJuaW5nIHRoZSByZXN1bHQuCiAgICAgKiBVc2UgdGhlIHJhdyBwYXJhbWV0ZXIgdG8gb2J0YWluIHRoZSByYXcgcmVzdWx0IGluc3RlYWQgb2YgdGhlIGhleCBvbmUuCiAgICAgKgogICAgICogQHBhcmFtIHtCb29sZWFufSByYXcgVHJ1ZSB0byBnZXQgdGhlIHJhdyByZXN1bHQsIGZhbHNlIHRvIGdldCB0aGUgaGV4IHJlc3VsdAogICAgICoKICAgICAqIEByZXR1cm4ge1N0cmluZ3xBcnJheX0gVGhlIHJlc3VsdAogICAgICovCiAgICBTcGFya01ENS5BcnJheUJ1ZmZlci5wcm90b3R5cGUuZW5kID0gZnVuY3Rpb24gKHJhdykgewogICAgICAgIHZhciBidWZmID0gdGhpcy5fYnVmZiwKICAgICAgICAgICAgbGVuZ3RoID0gYnVmZi5sZW5ndGgsCiAgICAgICAgICAgIHRhaWwgPSBbMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMF0sCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIHJldDsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgIHRhaWxbaSA+PiAyXSB8PSBidWZmW2ldIDw8ICgoaSAlIDQpIDw8IDMpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fZmluaXNoKHRhaWwsIGxlbmd0aCk7CiAgICAgICAgcmV0ID0gISFyYXcgPyB0aGlzLl9zdGF0ZSA6IGhleCh0aGlzLl9zdGF0ZSk7CgogICAgICAgIHRoaXMucmVzZXQoKTsKCiAgICAgICAgcmV0dXJuIHJldDsKICAgIH07CgogICAgU3BhcmtNRDUuQXJyYXlCdWZmZXIucHJvdG90eXBlLl9maW5pc2ggPSBTcGFya01ENS5wcm90b3R5cGUuX2ZpbmlzaDsKCiAgICAvKioKICAgICAqIFJlc2V0cyB0aGUgaW50ZXJuYWwgc3RhdGUgb2YgdGhlIGNvbXB1dGF0aW9uLgogICAgICoKICAgICAqIEByZXR1cm4ge1NwYXJrTUQ1LkFycmF5QnVmZmVyfSBUaGUgaW5zdGFuY2UgaXRzZWxmCiAgICAgKi8KICAgIFNwYXJrTUQ1LkFycmF5QnVmZmVyLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLl9idWZmID0gbmV3IFVpbnQ4QXJyYXkoMCk7CiAgICAgICAgdGhpcy5fbGVuZ3RoID0gMDsKICAgICAgICB0aGlzLl9zdGF0ZSA9IFsxNzMyNTg0MTkzLCAtMjcxNzMzODc5LCAtMTczMjU4NDE5NCwgMjcxNzMzODc4XTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIC8qKgogICAgICogUmVsZWFzZXMgbWVtb3J5IHVzZWQgYnkgdGhlIGluY3JlbWVudGFsIGJ1ZmZlciBhbmQgb3RoZXIgYWRpdGlvbmFsCiAgICAgKiByZXNvdXJjZXMuIElmIHlvdSBwbGFuIHRvIHVzZSB0aGUgaW5zdGFuY2UgYWdhaW4sIHVzZSByZXNldCBpbnN0ZWFkLgogICAgICovCiAgICBTcGFya01ENS5BcnJheUJ1ZmZlci5wcm90b3R5cGUuZGVzdHJveSA9IFNwYXJrTUQ1LnByb3RvdHlwZS5kZXN0cm95OwoKICAgIC8qKgogICAgICogQ29uY2F0cyB0d28gYXJyYXkgYnVmZmVycywgcmV0dXJuaW5nIGEgbmV3IG9uZS4KICAgICAqCiAgICAgKiBAcGFyYW0gIHtBcnJheUJ1ZmZlcn0gZmlyc3QgIFRoZSBmaXJzdCBhcnJheSBidWZmZXIKICAgICAqIEBwYXJhbSAge0FycmF5QnVmZmVyfSBzZWNvbmQgVGhlIHNlY29uZCBhcnJheSBidWZmZXIKICAgICAqCiAgICAgKiBAcmV0dXJuIHtBcnJheUJ1ZmZlcn0gVGhlIG5ldyBhcnJheSBidWZmZXIKICAgICAqLwogICAgU3BhcmtNRDUuQXJyYXlCdWZmZXIucHJvdG90eXBlLl9jb25jYXRBcnJheUJ1ZmZlciA9IGZ1bmN0aW9uIChmaXJzdCwgc2Vjb25kKSB7CiAgICAgICAgdmFyIGZpcnN0TGVuZ3RoID0gZmlyc3QubGVuZ3RoLAogICAgICAgICAgICByZXN1bHQgPSBuZXcgVWludDhBcnJheShmaXJzdExlbmd0aCArIHNlY29uZC5ieXRlTGVuZ3RoKTsKCiAgICAgICAgcmVzdWx0LnNldChmaXJzdCk7CiAgICAgICAgcmVzdWx0LnNldChuZXcgVWludDhBcnJheShzZWNvbmQpLCBmaXJzdExlbmd0aCk7CgogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwoKICAgIC8qKgogICAgICogUGVyZm9ybXMgdGhlIG1kNSBoYXNoIG9uIGFuIGFycmF5IGJ1ZmZlci4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5QnVmZmVyfSBhcnIgVGhlIGFycmF5IGJ1ZmZlcgogICAgICogQHBhcmFtIHtCb29sZWFufSAgICAgcmF3IFRydWUgdG8gZ2V0IHRoZSByYXcgcmVzdWx0LCBmYWxzZSB0byBnZXQgdGhlIGhleCByZXN1bHQKICAgICAqCiAgICAgKiBAcmV0dXJuIHtTdHJpbmd8QXJyYXl9IFRoZSByZXN1bHQKICAgICAqLwogICAgU3BhcmtNRDUuQXJyYXlCdWZmZXIuaGFzaCA9IGZ1bmN0aW9uIChhcnIsIHJhdykgewogICAgICAgIHZhciBoYXNoID0gbWQ1MV9hcnJheShuZXcgVWludDhBcnJheShhcnIpKTsKCiAgICAgICAgcmV0dXJuICEhcmF3ID8gaGFzaCA6IGhleChoYXNoKTsKICAgIH07CgogICAgcmV0dXJuIFNwYXJrTUQ1Owp9KSk7Cgp9LHt9XSwxMTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovKioKICogU3RyaW5naWZ5L3BhcnNlIGZ1bmN0aW9ucyB0aGF0IGRvbid0IG9wZXJhdGUKICogcmVjdXJzaXZlbHksIHNvIHRoZXkgYXZvaWQgY2FsbCBzdGFjayBleGNlZWRlZAogKiBlcnJvcnMuCiAqLwpleHBvcnRzLnN0cmluZ2lmeSA9IGZ1bmN0aW9uIHN0cmluZ2lmeShpbnB1dCkgewogIHZhciBxdWV1ZSA9IFtdOwogIHF1ZXVlLnB1c2goe29iajogaW5wdXR9KTsKCiAgdmFyIHJlcyA9ICcnOwogIHZhciBuZXh0LCBvYmosIHByZWZpeCwgdmFsLCBpLCBhcnJheVByZWZpeCwga2V5cywgaywga2V5LCB2YWx1ZSwgb2JqUHJlZml4OwogIHdoaWxlICgobmV4dCA9IHF1ZXVlLnBvcCgpKSkgewogICAgb2JqID0gbmV4dC5vYmo7CiAgICBwcmVmaXggPSBuZXh0LnByZWZpeCB8fCAnJzsKICAgIHZhbCA9IG5leHQudmFsIHx8ICcnOwogICAgcmVzICs9IHByZWZpeDsKICAgIGlmICh2YWwpIHsKICAgICAgcmVzICs9IHZhbDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcpIHsKICAgICAgcmVzICs9IHR5cGVvZiBvYmogPT09ICd1bmRlZmluZWQnID8gbnVsbCA6IEpTT04uc3RyaW5naWZ5KG9iaik7CiAgICB9IGVsc2UgaWYgKG9iaiA9PT0gbnVsbCkgewogICAgICByZXMgKz0gJ251bGwnOwogICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKICAgICAgcXVldWUucHVzaCh7dmFsOiAnXSd9KTsKICAgICAgZm9yIChpID0gb2JqLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgYXJyYXlQcmVmaXggPSBpID09PSAwID8gJycgOiAnLCc7CiAgICAgICAgcXVldWUucHVzaCh7b2JqOiBvYmpbaV0sIHByZWZpeDogYXJyYXlQcmVmaXh9KTsKICAgICAgfQogICAgICBxdWV1ZS5wdXNoKHt2YWw6ICdbJ30pOwogICAgfSBlbHNlIHsgLy8gb2JqZWN0CiAgICAgIGtleXMgPSBbXTsKICAgICAgZm9yIChrIGluIG9iaikgewogICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoaykpIHsKICAgICAgICAgIGtleXMucHVzaChrKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcXVldWUucHVzaCh7dmFsOiAnfSd9KTsKICAgICAgZm9yIChpID0ga2V5cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGtleSA9IGtleXNbaV07CiAgICAgICAgdmFsdWUgPSBvYmpba2V5XTsKICAgICAgICBvYmpQcmVmaXggPSAoaSA+IDAgPyAnLCcgOiAnJyk7CiAgICAgICAgb2JqUHJlZml4ICs9IEpTT04uc3RyaW5naWZ5KGtleSkgKyAnOic7CiAgICAgICAgcXVldWUucHVzaCh7b2JqOiB2YWx1ZSwgcHJlZml4OiBvYmpQcmVmaXh9KTsKICAgICAgfQogICAgICBxdWV1ZS5wdXNoKHt2YWw6ICd7J30pOwogICAgfQogIH0KICByZXR1cm4gcmVzOwp9OwoKLy8gQ29udmVuaWVuY2UgZnVuY3Rpb24gZm9yIHRoZSBwYXJzZSBmdW5jdGlvbi4KLy8gVGhpcyBwb3AgZnVuY3Rpb24gaXMgYmFzaWNhbGx5IGNvcGllZCBmcm9tCi8vIHBvdWNoQ29sbGF0ZS5wYXJzZUluZGV4YWJsZVN0cmluZwpmdW5jdGlvbiBwb3Aob2JqLCBzdGFjaywgbWV0YVN0YWNrKSB7CiAgdmFyIGxhc3RNZXRhRWxlbWVudCA9IG1ldGFTdGFja1ttZXRhU3RhY2subGVuZ3RoIC0gMV07CiAgaWYgKG9iaiA9PT0gbGFzdE1ldGFFbGVtZW50LmVsZW1lbnQpIHsKICAgIC8vIHBvcHBpbmcgYSBtZXRhLWVsZW1lbnQsIGUuZy4gYW4gb2JqZWN0IHdob3NlIHZhbHVlIGlzIGFub3RoZXIgb2JqZWN0CiAgICBtZXRhU3RhY2sucG9wKCk7CiAgICBsYXN0TWV0YUVsZW1lbnQgPSBtZXRhU3RhY2tbbWV0YVN0YWNrLmxlbmd0aCAtIDFdOwogIH0KICB2YXIgZWxlbWVudCA9IGxhc3RNZXRhRWxlbWVudC5lbGVtZW50OwogIHZhciBsYXN0RWxlbWVudEluZGV4ID0gbGFzdE1ldGFFbGVtZW50LmluZGV4OwogIGlmIChBcnJheS5pc0FycmF5KGVsZW1lbnQpKSB7CiAgICBlbGVtZW50LnB1c2gob2JqKTsKICB9IGVsc2UgaWYgKGxhc3RFbGVtZW50SW5kZXggPT09IHN0YWNrLmxlbmd0aCAtIDIpIHsgLy8gb2JqIHdpdGgga2V5K3ZhbHVlCiAgICB2YXIga2V5ID0gc3RhY2sucG9wKCk7CiAgICBlbGVtZW50W2tleV0gPSBvYmo7CiAgfSBlbHNlIHsKICAgIHN0YWNrLnB1c2gob2JqKTsgLy8gb2JqIHdpdGgga2V5IG9ubHkKICB9Cn0KCmV4cG9ydHMucGFyc2UgPSBmdW5jdGlvbiAoc3RyKSB7CiAgdmFyIHN0YWNrID0gW107CiAgdmFyIG1ldGFTdGFjayA9IFtdOyAvLyBzdGFjayBmb3IgYXJyYXlzIGFuZCBvYmplY3RzCiAgdmFyIGkgPSAwOwogIHZhciBjb2xsYXRpb25JbmRleCxwYXJzZWROdW0sbnVtQ2hhcjsKICB2YXIgcGFyc2VkU3RyaW5nLGxhc3RDaCxudW1Db25zZWN1dGl2ZVNsYXNoZXMsY2g7CiAgdmFyIGFycmF5RWxlbWVudCwgb2JqRWxlbWVudDsKICB3aGlsZSAodHJ1ZSkgewogICAgY29sbGF0aW9uSW5kZXggPSBzdHJbaSsrXTsKICAgIGlmIChjb2xsYXRpb25JbmRleCA9PT0gJ30nIHx8CiAgICAgICAgY29sbGF0aW9uSW5kZXggPT09ICddJyB8fAogICAgICAgIHR5cGVvZiBjb2xsYXRpb25JbmRleCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgaWYgKHN0YWNrLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHJldHVybiBzdGFjay5wb3AoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBwb3Aoc3RhY2sucG9wKCksIHN0YWNrLCBtZXRhU3RhY2spOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICB9CiAgICBzd2l0Y2ggKGNvbGxhdGlvbkluZGV4KSB7CiAgICAgIGNhc2UgJyAnOgogICAgICBjYXNlICdcdCc6CiAgICAgIGNhc2UgJ1xuJzoKICAgICAgY2FzZSAnOic6CiAgICAgIGNhc2UgJywnOgogICAgICAgIGJyZWFrOwogICAgICBjYXNlICduJzoKICAgICAgICBpICs9IDM7IC8vICd1bGwnCiAgICAgICAgcG9wKG51bGwsIHN0YWNrLCBtZXRhU3RhY2spOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICd0JzoKICAgICAgICBpICs9IDM7IC8vICdydWUnCiAgICAgICAgcG9wKHRydWUsIHN0YWNrLCBtZXRhU3RhY2spOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdmJzoKICAgICAgICBpICs9IDQ7IC8vICdhbHNlJwogICAgICAgIHBvcChmYWxzZSwgc3RhY2ssIG1ldGFTdGFjayk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJzAnOgogICAgICBjYXNlICcxJzoKICAgICAgY2FzZSAnMic6CiAgICAgIGNhc2UgJzMnOgogICAgICBjYXNlICc0JzoKICAgICAgY2FzZSAnNSc6CiAgICAgIGNhc2UgJzYnOgogICAgICBjYXNlICc3JzoKICAgICAgY2FzZSAnOCc6CiAgICAgIGNhc2UgJzknOgogICAgICBjYXNlICctJzoKICAgICAgICBwYXJzZWROdW0gPSAnJzsKICAgICAgICBpLS07CiAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgIG51bUNoYXIgPSBzdHJbaSsrXTsKICAgICAgICAgIGlmICgvW1xkXC5cLWVcK10vLnRlc3QobnVtQ2hhcikpIHsKICAgICAgICAgICAgcGFyc2VkTnVtICs9IG51bUNoYXI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpLS07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBwb3AocGFyc2VGbG9hdChwYXJzZWROdW0pLCBzdGFjaywgbWV0YVN0YWNrKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnIic6CiAgICAgICAgcGFyc2VkU3RyaW5nID0gJyc7CiAgICAgICAgbGFzdENoID0gdm9pZCAwOwogICAgICAgIG51bUNvbnNlY3V0aXZlU2xhc2hlcyA9IDA7CiAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgIGNoID0gc3RyW2krK107CiAgICAgICAgICBpZiAoY2ggIT09ICciJyB8fCAobGFzdENoID09PSAnXFwnICYmCiAgICAgICAgICAgICAgbnVtQ29uc2VjdXRpdmVTbGFzaGVzICUgMiA9PT0gMSkpIHsKICAgICAgICAgICAgcGFyc2VkU3RyaW5nICs9IGNoOwogICAgICAgICAgICBsYXN0Q2ggPSBjaDsKICAgICAgICAgICAgaWYgKGxhc3RDaCA9PT0gJ1xcJykgewogICAgICAgICAgICAgIG51bUNvbnNlY3V0aXZlU2xhc2hlcysrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG51bUNvbnNlY3V0aXZlU2xhc2hlcyA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBwb3AoSlNPTi5wYXJzZSgnIicgKyBwYXJzZWRTdHJpbmcgKyAnIicpLCBzdGFjaywgbWV0YVN0YWNrKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnWyc6CiAgICAgICAgYXJyYXlFbGVtZW50ID0geyBlbGVtZW50OiBbXSwgaW5kZXg6IHN0YWNrLmxlbmd0aCB9OwogICAgICAgIHN0YWNrLnB1c2goYXJyYXlFbGVtZW50LmVsZW1lbnQpOwogICAgICAgIG1ldGFTdGFjay5wdXNoKGFycmF5RWxlbWVudCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3snOgogICAgICAgIG9iakVsZW1lbnQgPSB7IGVsZW1lbnQ6IHt9LCBpbmRleDogc3RhY2subGVuZ3RoIH07CiAgICAgICAgc3RhY2sucHVzaChvYmpFbGVtZW50LmVsZW1lbnQpOwogICAgICAgIG1ldGFTdGFjay5wdXNoKG9iakVsZW1lbnQpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICd1bmV4cGVjdGVkbHkgcmVhY2hlZCBlbmQgb2YgaW5wdXQ6ICcgKyBjb2xsYXRpb25JbmRleCk7CiAgICB9CiAgfQp9OwoKfSx7fV19LHt9LFsyXSk7Cg==';
},{}],10:[function(_dereq_,module,exports){
// shim for using process in browser

var process = module.exports = {};
var queue = [];
var draining = false;

function drainQueue() {
    if (draining) {
        return;
    }
    draining = true;
    var currentQueue;
    var len = queue.length;
    while(len) {
        currentQueue = queue;
        queue = [];
        var i = -1;
        while (++i < len) {
            currentQueue[i]();
        }
        len = queue.length;
    }
    draining = false;
}
process.nextTick = function (fun) {
    queue.push(fun);
    if (!draining) {
        setTimeout(drainQueue, 0);
    }
};

process.title = 'browser';
process.browser = true;
process.env = {};
process.argv = [];
process.version = ''; // empty string to avoid regexp issues
process.versions = {};

function noop() {}

process.on = noop;
process.addListener = noop;
process.once = noop;
process.off = noop;
process.removeListener = noop;
process.removeAllListeners = noop;
process.emit = noop;

process.binding = function (name) {
    throw new Error('process.binding is not supported');
};

// TODO(shtylman)
process.cwd = function () { return '/' };
process.chdir = function (dir) {
    throw new Error('process.chdir is not supported');
};
process.umask = function() { return 0; };

},{}],11:[function(_dereq_,module,exports){

/**
 * This is the web browser implementation of `debug()`.
 *
 * Expose `debug()` as the module.
 */

exports = module.exports = _dereq_(12);
exports.log = log;
exports.formatArgs = formatArgs;
exports.save = save;
exports.load = load;
exports.useColors = useColors;
exports.storage = 'undefined' != typeof chrome
               && 'undefined' != typeof chrome.storage
                  ? chrome.storage.local
                  : localstorage();

/**
 * Colors.
 */

exports.colors = [
  'lightseagreen',
  'forestgreen',
  'goldenrod',
  'dodgerblue',
  'darkorchid',
  'crimson'
];

/**
 * Currently only WebKit-based Web Inspectors, Firefox >= v31,
 * and the Firebug extension (any Firefox version) are known
 * to support "%c" CSS customizations.
 *
 * TODO: add a `localStorage` variable to explicitly enable/disable colors
 */

function useColors() {
  // is webkit? http://stackoverflow.com/a/16459606/376773
  return ('WebkitAppearance' in document.documentElement.style) ||
    // is firebug? http://stackoverflow.com/a/398120/376773
    (window.console && (console.firebug || (console.exception && console.table))) ||
    // is firefox >= v31?
    // https://developer.mozilla.org/en-US/docs/Tools/Web_Console#Styling_messages
    (navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/) && parseInt(RegExp.$1, 10) >= 31);
}

/**
 * Map %j to `JSON.stringify()`, since no Web Inspectors do that by default.
 */

exports.formatters.j = function(v) {
  return JSON.stringify(v);
};


/**
 * Colorize log arguments if enabled.
 *
 * @api public
 */

function formatArgs() {
  var args = arguments;
  var useColors = this.useColors;

  args[0] = (useColors ? '%c' : '')
    + this.namespace
    + (useColors ? ' %c' : ' ')
    + args[0]
    + (useColors ? '%c ' : ' ')
    + '+' + exports.humanize(this.diff);

  if (!useColors) return args;

  var c = 'color: ' + this.color;
  args = [args[0], c, 'color: inherit'].concat(Array.prototype.slice.call(args, 1));

  // the final "%c" is somewhat tricky, because there could be other
  // arguments passed either before or after the %c, so we need to
  // figure out the correct index to insert the CSS into
  var index = 0;
  var lastC = 0;
  args[0].replace(/%[a-z%]/g, function(match) {
    if ('%%' === match) return;
    index++;
    if ('%c' === match) {
      // we only are interested in the *last* %c
      // (the user may have provided their own)
      lastC = index;
    }
  });

  args.splice(lastC, 0, c);
  return args;
}

/**
 * Invokes `console.log()` when available.
 * No-op when `console.log` is not a "function".
 *
 * @api public
 */

function log() {
  // this hackery is required for IE8/9, where
  // the `console.log` function doesn't have 'apply'
  return 'object' === typeof console
    && console.log
    && Function.prototype.apply.call(console.log, console, arguments);
}

/**
 * Save `namespaces`.
 *
 * @param {String} namespaces
 * @api private
 */

function save(namespaces) {
  try {
    if (null == namespaces) {
      exports.storage.removeItem('debug');
    } else {
      exports.storage.debug = namespaces;
    }
  } catch(e) {}
}

/**
 * Load `namespaces`.
 *
 * @return {String} returns the previously persisted debug modes
 * @api private
 */

function load() {
  var r;
  try {
    r = exports.storage.debug;
  } catch(e) {}
  return r;
}

/**
 * Enable namespaces listed in `localStorage.debug` initially.
 */

exports.enable(load());

/**
 * Localstorage attempts to return the localstorage.
 *
 * This is necessary because safari throws
 * when a user disables cookies/localstorage
 * and you attempt to access it.
 *
 * @return {LocalStorage}
 * @api private
 */

function localstorage(){
  try {
    return window.localStorage;
  } catch (e) {}
}

},{"12":12}],12:[function(_dereq_,module,exports){

/**
 * This is the common logic for both the Node.js and web browser
 * implementations of `debug()`.
 *
 * Expose `debug()` as the module.
 */

exports = module.exports = debug;
exports.coerce = coerce;
exports.disable = disable;
exports.enable = enable;
exports.enabled = enabled;
exports.humanize = _dereq_(13);

/**
 * The currently active debug mode names, and names to skip.
 */

exports.names = [];
exports.skips = [];

/**
 * Map of special "%n" handling functions, for the debug "format" argument.
 *
 * Valid key names are a single, lowercased letter, i.e. "n".
 */

exports.formatters = {};

/**
 * Previously assigned color.
 */

var prevColor = 0;

/**
 * Previous log timestamp.
 */

var prevTime;

/**
 * Select a color.
 *
 * @return {Number}
 * @api private
 */

function selectColor() {
  return exports.colors[prevColor++ % exports.colors.length];
}

/**
 * Create a debugger with the given `namespace`.
 *
 * @param {String} namespace
 * @return {Function}
 * @api public
 */

function debug(namespace) {

  // define the `disabled` version
  function disabled() {
  }
  disabled.enabled = false;

  // define the `enabled` version
  function enabled() {

    var self = enabled;

    // set `diff` timestamp
    var curr = +new Date();
    var ms = curr - (prevTime || curr);
    self.diff = ms;
    self.prev = prevTime;
    self.curr = curr;
    prevTime = curr;

    // add the `color` if not set
    if (null == self.useColors) self.useColors = exports.useColors();
    if (null == self.color && self.useColors) self.color = selectColor();

    var args = Array.prototype.slice.call(arguments);

    args[0] = exports.coerce(args[0]);

    if ('string' !== typeof args[0]) {
      // anything else let's inspect with %o
      args = ['%o'].concat(args);
    }

    // apply any `formatters` transformations
    var index = 0;
    args[0] = args[0].replace(/%([a-z%])/g, function(match, format) {
      // if we encounter an escaped % then don't increase the array index
      if (match === '%%') return match;
      index++;
      var formatter = exports.formatters[format];
      if ('function' === typeof formatter) {
        var val = args[index];
        match = formatter.call(self, val);

        // now we need to remove `args[index]` since it's inlined in the `format`
        args.splice(index, 1);
        index--;
      }
      return match;
    });

    if ('function' === typeof exports.formatArgs) {
      args = exports.formatArgs.apply(self, args);
    }
    var logFn = enabled.log || exports.log || console.log.bind(console);
    logFn.apply(self, args);
  }
  enabled.enabled = true;

  var fn = exports.enabled(namespace) ? enabled : disabled;

  fn.namespace = namespace;

  return fn;
}

/**
 * Enables a debug mode by namespaces. This can include modes
 * separated by a colon and wildcards.
 *
 * @param {String} namespaces
 * @api public
 */

function enable(namespaces) {
  exports.save(namespaces);

  var split = (namespaces || '').split(/[\s,]+/);
  var len = split.length;

  for (var i = 0; i < len; i++) {
    if (!split[i]) continue; // ignore empty strings
    namespaces = split[i].replace(/\*/g, '.*?');
    if (namespaces[0] === '-') {
      exports.skips.push(new RegExp('^' + namespaces.substr(1) + '$'));
    } else {
      exports.names.push(new RegExp('^' + namespaces + '$'));
    }
  }
}

/**
 * Disable debug output.
 *
 * @api public
 */

function disable() {
  exports.enable('');
}

/**
 * Returns true if the given mode name is enabled, false otherwise.
 *
 * @param {String} name
 * @return {Boolean}
 * @api public
 */

function enabled(name) {
  var i, len;
  for (i = 0, len = exports.skips.length; i < len; i++) {
    if (exports.skips[i].test(name)) {
      return false;
    }
  }
  for (i = 0, len = exports.names.length; i < len; i++) {
    if (exports.names[i].test(name)) {
      return true;
    }
  }
  return false;
}

/**
 * Coerce `val`.
 *
 * @param {Mixed} val
 * @return {Mixed}
 * @api private
 */

function coerce(val) {
  if (val instanceof Error) return val.stack || val.message;
  return val;
}

},{"13":13}],13:[function(_dereq_,module,exports){
/**
 * Helpers.
 */

var s = 1000;
var m = s * 60;
var h = m * 60;
var d = h * 24;
var y = d * 365.25;

/**
 * Parse or format the given `val`.
 *
 * Options:
 *
 *  - `long` verbose formatting [false]
 *
 * @param {String|Number} val
 * @param {Object} options
 * @return {String|Number}
 * @api public
 */

module.exports = function(val, options){
  options = options || {};
  if ('string' == typeof val) return parse(val);
  return options["long"]
    ? long(val)
    : short(val);
};

/**
 * Parse the given `str` and return milliseconds.
 *
 * @param {String} str
 * @return {Number}
 * @api private
 */

function parse(str) {
  str = '' + str;
  if (str.length > 10000) return;
  var match = /^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(str);
  if (!match) return;
  var n = parseFloat(match[1]);
  var type = (match[2] || 'ms').toLowerCase();
  switch (type) {
    case 'years':
    case 'year':
    case 'yrs':
    case 'yr':
    case 'y':
      return n * y;
    case 'days':
    case 'day':
    case 'd':
      return n * d;
    case 'hours':
    case 'hour':
    case 'hrs':
    case 'hr':
    case 'h':
      return n * h;
    case 'minutes':
    case 'minute':
    case 'mins':
    case 'min':
    case 'm':
      return n * m;
    case 'seconds':
    case 'second':
    case 'secs':
    case 'sec':
    case 's':
      return n * s;
    case 'milliseconds':
    case 'millisecond':
    case 'msecs':
    case 'msec':
    case 'ms':
      return n;
  }
}

/**
 * Short format for `ms`.
 *
 * @param {Number} ms
 * @return {String}
 * @api private
 */

function short(ms) {
  if (ms >= d) return Math.round(ms / d) + 'd';
  if (ms >= h) return Math.round(ms / h) + 'h';
  if (ms >= m) return Math.round(ms / m) + 'm';
  if (ms >= s) return Math.round(ms / s) + 's';
  return ms + 'ms';
}

/**
 * Long format for `ms`.
 *
 * @param {Number} ms
 * @return {String}
 * @api private
 */

function long(ms) {
  return plural(ms, d, 'day')
    || plural(ms, h, 'hour')
    || plural(ms, m, 'minute')
    || plural(ms, s, 'second')
    || ms + ' ms';
}

/**
 * Pluralization helper.
 */

function plural(ms, n, name) {
  if (ms < n) return;
  if (ms < n * 1.5) return Math.floor(ms / n) + ' ' + name;
  return Math.ceil(ms / n) + ' ' + name + 's';
}

},{}],14:[function(_dereq_,module,exports){
if (typeof Object.create === 'function') {
  // implementation from standard node.js 'util' module
  module.exports = function inherits(ctor, superCtor) {
    ctor.super_ = superCtor
    ctor.prototype = Object.create(superCtor.prototype, {
      constructor: {
        value: ctor,
        enumerable: false,
        writable: true,
        configurable: true
      }
    });
  };
} else {
  // old school shim for old browsers
  module.exports = function inherits(ctor, superCtor) {
    ctor.super_ = superCtor
    var TempCtor = function () {}
    TempCtor.prototype = superCtor.prototype
    ctor.prototype = new TempCtor()
    ctor.prototype.constructor = ctor
  }
}

},{}],15:[function(_dereq_,module,exports){
(function (global){
"use strict";

//Abstracts constructing a Blob object, so it also works in older
//browsers that don't support the native Blob constructor. (i.e.
//old QtWebKit versions, at least).
function createBlob(parts, properties) {
  parts = parts || [];
  properties = properties || {};
  try {
    return new Blob(parts, properties);
  } catch (e) {
    if (e.name !== "TypeError") {
      throw e;
    }
    var BlobBuilder = global.BlobBuilder ||
                      global.MSBlobBuilder ||
                      global.MozBlobBuilder ||
                      global.WebKitBlobBuilder;
    var builder = new BlobBuilder();
    for (var i = 0; i < parts.length; i += 1) {
      builder.append(parts[i]);
    }
    return builder.getBlob(properties.type);
  }
}

//Can't find original post, but this is close
//http://stackoverflow.com/questions/6965107/ (continues on next line)
//converting-between-strings-and-arraybuffers
function arrayBufferToBinaryString(buffer) {
  var binary = "";
  var bytes = new Uint8Array(buffer);
  var length = bytes.byteLength;
  for (var i = 0; i < length; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return binary;
}

// This used to be called "fixBinary", which wasn't a very evocative name
// From http://stackoverflow.com/questions/14967647/ (continues on next line)
// encode-decode-image-with-base64-breaks-image (2013-04-21)
function binaryStringToArrayBuffer(bin) {
  var length = bin.length;
  var buf = new ArrayBuffer(length);
  var arr = new Uint8Array(buf);
  for (var i = 0; i < length; i++) {
    arr[i] = bin.charCodeAt(i);
  }
  return buf;
}

// shim for browsers that don't support it
function readAsBinaryString(blob, callback) {
  var reader = new FileReader();
  var hasBinaryString = typeof reader.readAsBinaryString === 'function';
  reader.onloadend = function (e) {
    var result = e.target.result || '';
    if (hasBinaryString) {
      return callback(result);
    }
    callback(arrayBufferToBinaryString(result));
  };
  if (hasBinaryString) {
    reader.readAsBinaryString(blob);
  } else {
    reader.readAsArrayBuffer(blob);
  }
}

// simplified API. universal browser support is assumed
function readAsArrayBuffer(blob, callback) {
  var reader = new FileReader();
  reader.onloadend = function (e) {
    var result = e.target.result || new ArrayBuffer(0);
    callback(result);
  };
  reader.readAsArrayBuffer(blob);
}

module.exports = {
  createBlob: createBlob,
  readAsArrayBuffer: readAsArrayBuffer,
  readAsBinaryString: readAsBinaryString,
  binaryStringToArrayBuffer: binaryStringToArrayBuffer,
  arrayBufferToBinaryString: arrayBufferToBinaryString
};


}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],16:[function(_dereq_,module,exports){
'use strict';

// allow external plugins to require('pouchdb/extras/promise')
module.exports = _dereq_(17);
},{"17":17}],17:[function(_dereq_,module,exports){
'use strict';
/* istanbul ignore next */
module.exports = typeof Promise === 'function' ? Promise : _dereq_(18);

},{"18":18}],18:[function(_dereq_,module,exports){
'use strict';
var immediate = _dereq_(19);

/* istanbul ignore next */
function INTERNAL() {}

var handlers = {};

var REJECTED = ['REJECTED'];
var FULFILLED = ['FULFILLED'];
var PENDING = ['PENDING'];
var UNHANDLED;

module.exports = exports = Promise;

function Promise(resolver) {
  if (typeof resolver !== 'function') {
    throw new TypeError('resolver must be a function');
  }
  this.state = PENDING;
  this.queue = [];
  this.outcome = void 0;
  if (resolver !== INTERNAL) {
    safelyResolveThenable(this, resolver);
  }
}

Promise.prototype["catch"] = function (onRejected) {
  return this.then(null, onRejected);
};
Promise.prototype.then = function (onFulfilled, onRejected) {
  if (typeof onFulfilled !== 'function' && this.state === FULFILLED ||
    typeof onRejected !== 'function' && this.state === REJECTED) {
    return this;
  }
  var promise = new this.constructor(INTERNAL);
  if (this.state !== PENDING) {
    var resolver = this.state === FULFILLED ? onFulfilled : onRejected;
    unwrap(promise, resolver, this.outcome);
  } else {
    this.queue.push(new QueueItem(promise, onFulfilled, onRejected));
  }

  return promise;
};
function QueueItem(promise, onFulfilled, onRejected) {
  this.promise = promise;
  if (typeof onFulfilled === 'function') {
    this.onFulfilled = onFulfilled;
    this.callFulfilled = this.otherCallFulfilled;
  }
  if (typeof onRejected === 'function') {
    this.onRejected = onRejected;
    this.callRejected = this.otherCallRejected;
  }
}
QueueItem.prototype.callFulfilled = function (value) {
  handlers.resolve(this.promise, value);
};
QueueItem.prototype.otherCallFulfilled = function (value) {
  unwrap(this.promise, this.onFulfilled, value);
};
QueueItem.prototype.callRejected = function (value) {
  handlers.reject(this.promise, value);
};
QueueItem.prototype.otherCallRejected = function (value) {
  unwrap(this.promise, this.onRejected, value);
};

function unwrap(promise, func, value) {
  immediate(function () {
    var returnValue;
    try {
      returnValue = func(value);
    } catch (e) {
      return handlers.reject(promise, e);
    }
    if (returnValue === promise) {
      handlers.reject(promise, new TypeError('Cannot resolve promise with itself'));
    } else {
      handlers.resolve(promise, returnValue);
    }
  });
}

handlers.resolve = function (self, value) {
  var result = tryCatch(getThen, value);
  if (result.status === 'error') {
    return handlers.reject(self, result.value);
  }
  var thenable = result.value;

  if (thenable) {
    safelyResolveThenable(self, thenable);
  } else {
    self.state = FULFILLED;
    self.outcome = value;
    var i = -1;
    var len = self.queue.length;
    while (++i < len) {
      self.queue[i].callFulfilled(value);
    }
  }
  return self;
};
handlers.reject = function (self, error) {
  self.state = REJECTED;
  self.outcome = error;
  var i = -1;
  var len = self.queue.length;
  while (++i < len) {
    self.queue[i].callRejected(error);
  }
  return self;
};

function getThen(obj) {
  // Make sure we only access the accessor once as required by the spec
  var then = obj && obj.then;
  if (obj && typeof obj === 'object' && typeof then === 'function') {
    return function appyThen() {
      then.apply(obj, arguments);
    };
  }
}

function safelyResolveThenable(self, thenable) {
  // Either fulfill, reject or reject with error
  var called = false;
  function onError(value) {
    if (called) {
      return;
    }
    called = true;
    handlers.reject(self, value);
  }

  function onSuccess(value) {
    if (called) {
      return;
    }
    called = true;
    handlers.resolve(self, value);
  }

  function tryToUnwrap() {
    thenable(onSuccess, onError);
  }

  var result = tryCatch(tryToUnwrap);
  if (result.status === 'error') {
    onError(result.value);
  }
}

function tryCatch(func, value) {
  var out = {};
  try {
    out.value = func(value);
    out.status = 'success';
  } catch (e) {
    out.status = 'error';
    out.value = e;
  }
  return out;
}

exports.resolve = resolve;
function resolve(value) {
  if (value instanceof this) {
    return value;
  }
  return handlers.resolve(new this(INTERNAL), value);
}

exports.reject = reject;
function reject(reason) {
  var promise = new this(INTERNAL);
  return handlers.reject(promise, reason);
}

exports.all = all;
function all(iterable) {
  var self = this;
  if (Object.prototype.toString.call(iterable) !== '[object Array]') {
    return this.reject(new TypeError('must be an array'));
  }

  var len = iterable.length;
  var called = false;
  if (!len) {
    return this.resolve([]);
  }

  var values = new Array(len);
  var resolved = 0;
  var i = -1;
  var promise = new this(INTERNAL);

  while (++i < len) {
    allResolver(iterable[i], i);
  }
  return promise;
  function allResolver(value, i) {
    self.resolve(value).then(resolveFromAll, function (error) {
      if (!called) {
        called = true;
        handlers.reject(promise, error);
      }
    });
    function resolveFromAll(outValue) {
      values[i] = outValue;
      if (++resolved === len && !called) {
        called = true;
        handlers.resolve(promise, values);
      }
    }
  }
}

exports.race = race;
function race(iterable) {
  var self = this;
  if (Object.prototype.toString.call(iterable) !== '[object Array]') {
    return this.reject(new TypeError('must be an array'));
  }

  var len = iterable.length;
  var called = false;
  if (!len) {
    return this.resolve([]);
  }

  var i = -1;
  var promise = new this(INTERNAL);

  while (++i < len) {
    resolver(iterable[i]);
  }
  return promise;
  function resolver(value) {
    self.resolve(value).then(function (response) {
      if (!called) {
        called = true;
        handlers.resolve(promise, response);
      }
    }, function (error) {
      if (!called) {
        called = true;
        handlers.reject(promise, error);
      }
    });
  }
}

},{"19":19}],19:[function(_dereq_,module,exports){
(function (global){
'use strict';
var Mutation = global.MutationObserver || global.WebKitMutationObserver;

var scheduleDrain;

{
  if (Mutation) {
    var called = 0;
    var observer = new Mutation(nextTick);
    var element = global.document.createTextNode('');
    observer.observe(element, {
      characterData: true
    });
    scheduleDrain = function () {
      element.data = (called = ++called % 2);
    };
  } else if (!global.setImmediate && typeof global.MessageChannel !== 'undefined') {
    var channel = new global.MessageChannel();
    channel.port1.onmessage = nextTick;
    scheduleDrain = function () {
      channel.port2.postMessage(0);
    };
  } else if ('document' in global && 'onreadystatechange' in global.document.createElement('script')) {
    scheduleDrain = function () {

      // Create a <script> element; its readystatechange event will be fired asynchronously once it is inserted
      // into the document. Do so, thus queuing up the task. Remember to clean up once it's been called.
      var scriptEl = global.document.createElement('script');
      scriptEl.onreadystatechange = function () {
        nextTick();

        scriptEl.onreadystatechange = null;
        scriptEl.parentNode.removeChild(scriptEl);
        scriptEl = null;
      };
      global.document.documentElement.appendChild(scriptEl);
    };
  } else {
    scheduleDrain = function () {
      setTimeout(nextTick, 0);
    };
  }
}

var draining;
var queue = [];
//named nextTick for less confusing stack traces
function nextTick() {
  draining = true;
  var i, oldQueue;
  var len = queue.length;
  while (len) {
    oldQueue = queue;
    queue = [];
    i = -1;
    while (++i < len) {
      oldQueue[i]();
    }
    len = queue.length;
  }
  draining = false;
}

module.exports = immediate;
function immediate(task) {
  if (queue.push(task) === 1 && !draining) {
    scheduleDrain();
  }
}

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}]},{},[1]);
